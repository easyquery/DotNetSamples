/*!
 * Razor AdHoc Reporting Demo v1.0.0
 * Copyright 2024 Korzh.com
 * Licensed under MIT
 */
!function(){"use strict";var t,e;!function(t){t[t.Unknown=0]="Unknown",t[t.String=1]="String",t[t.Byte=2]="Byte",t[t.Word=3]="Word",t[t.Int32=4]="Int32",t[t.Int64=5]="Int64",t[t.Bool=6]="Bool",t[t.Float=7]="Float",t[t.Currency=8]="Currency",t[t.BCD=9]="BCD",t[t.Date=10]="Date",t[t.Time=11]="Time",t[t.DateTime=12]="DateTime",t[t.Autoinc=13]="Autoinc",t[t.Memo=14]="Memo",t[t.Blob=15]="Blob",t[t.FixedChar=16]="FixedChar",t[t.Guid=17]="Guid",t[t.Geometry=18]="Geometry",t[t.Geography=19]="Geography"}(t||(t={})),function(t){t[t.Data=0]="Data",t[t.Virtual=1]="Virtual",t[t.Lookup=2]="Lookup"}(e||(e={}));const s={Unknown:"Unknown",Edit:"EDIT",DateTime:"DATETIME",List:"LIST",CustomList:"CUSTOMLIST",File:"FILE"};var i,n,o,r,a,l,d,h;!function(t){t.Trace="TRACE",t.Options="OPTIONS",t.Get="GET",t.Put="PUT",t.Post="POST",t.Delete="DELETE"}(i||(i={}));class HttpRequest{constructor(t,e){this.xhr=t,this.method=e.method,this.url=e.url,this.headers=e.headers,this.queryParams=e.queryParams,this.data=e.data}setHeader(t,e){this.headers[t]=e}setQueryParam(t,e){this.queryParams[t]=e}getXMLHttpRequest(){return this.xhr}getResponseHeaders(){if(this.xhr.readyState==this.xhr.HEADERS_RECEIVED){const t=this.xhr.getAllResponseHeaders().trim().split(/[\r\n]+/),e={};for(const s of t){const t=s.split(": "),i=t.shift(),n=t.join(": ");e[i]=n}return e}return{}}open(){if(this.xhr.readyState!==this.xhr.UNSENT)return;let t=this.url;this.queryParams&&Object.keys(this.queryParams).length>0&&(t+=encodeURI("?"+Object.keys(this.queryParams).map((t=>t+"="+this.queryParams[t])).join("&"))),this.xhr.open(this.method,t,!0),this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");for(const t in this.headers)this.xhr.setRequestHeader(t,this.headers[t])}abort(){this.xhr.abort()}}!function(e){e.getAllDataTypes=function getAllDataTypes(){return Object.values(t).filter((t=>"number"==typeof t))},e.getDateDataTypes=function getDateDataTypes(){return[t.Time,t.Date,t.DateTime]},e.getStringDataTypes=function getStringDataTypes(){return[t.String,t.Memo,t.FixedChar]};const s=[t.Byte,t.Word,t.Int32,t.Int64,t.Float,t.Currency,t.Autoinc];e.getNumericDataTypes=function getNumericDataTypes(){return s};const i=[t.Byte,t.Word,t.Int32,t.Int64,t.Autoinc];function assignDeepCore(t,e,s){e||(e={});for(let i of s)if(i&&i.hasOwnProperty)for(let s in i)if(i.hasOwnProperty(s)){let n=i[s];null===n||"object"!=typeof n||s.endsWith("Ref")||n instanceof HTMLElement?e[s]=n:t.has(n)?e[s]=t.get(n):Array.isArray(n)?(e[s]=createArrayFrom(n),t.set(n,e[s])):(void 0!==e[s]&&null!=e[s]||(e[s]=Object.create(Object.getPrototypeOf(n))),t.set(n,e[s]),assignDeepCore(t,e[s],[n]))}return e}function createArrayFrom(t){let e=[];for(let s of t)e.push(s);return e}e.assign=function assign(t,...e){t||(t={});for(let s=0;s<e.length;s++){let i=e[s];if(i&&i.hasOwnProperty)for(let e in i)i.hasOwnProperty(e)&&(t[e]=i[e])}return t},e.assignDeep=function assignDeep(t,...e){return assignDeepCore(new WeakMap,t,e)},e.getIfDefined=function getIfDefined(t,e){return void 0!==t?t:e},e.IsDefinedAndNotNull=function IsDefinedAndNotNull(t){return null!=t},e.copyArrayTo=function copyArrayTo(t,e){const s=t.length,i=e.length;for(let n=0;n<s&&n<i;n++)e[n]=t[n]},e.createArrayFrom=createArrayFrom,e.findItemById=function findItemById(t,e){for(var s=t.length,i=0;i<s;i++)if(t[i].id===e)return t[i];return null},e.findItemIndexById=function findItemIndexById(t,e){for(var s=t.length,i=0;i<s;i++)if(t[i].id===e)return i;return-1},e.indexOfArrayItem=function indexOfArrayItem(t,e){if(t.indexOf)return t.indexOf(e);{let s=t.length;for(let i=0;i<s;i++)if(e==t[i])return i;return-1}},e.moveArrayItem=function moveArrayItem(t,e,s){if(e>=t.length)throw"Index out of bounds: "+e;s>=t.length&&(s=t.length-1);let i=t.splice(e,1)[0];t.splice(s,0,i)},e.removeArrayItem=function removeArrayItem(t,e){let s=t.indexOf(e);if(-1!=s)return t.splice(s,1)[0]},e.insertArrayItem=function insertArrayItem(t,e,s){t.splice(e,0,s)},e.fillArray=function fillArray(t,e,s=0,i){let n=t.length>>>0;var o=s|0,r=o<0?Math.max(n+o,0):Math.min(o,n),a=void 0===i?n:i|0;let l=a<0?Math.max(n+a,0):Math.min(a,n);for(;r<l;)t[r]=e,r++;return t},e.shiftToFitWindow=function shiftToFitWindow(t,e){let s=document.getElementsByTagName("body")[0],i=window.innerWidth||document.documentElement.clientWidth||s.clientWidth;var n=t+e;let o=0;return n>i&&(o=i-n-10,t+o<0&&(o=10-t)),o},e.isObject=function isObject(t){return null!==t&&("function"==typeof t||"object"==typeof t)},e.isNumericType=function isNumericType(t){return s.indexOf(t)>=0},e.isIntType=function isIntType(t){return i.indexOf(t)>=0},e.isNumeric=function isNumeric(t){return!isNaN(parseFloat(t))&&isFinite(t)},e.areCompatibleDataTypes=function areCompatibleDataTypes(e,s){return void 0===e||void 0===s||e==t.Unknown||s==t.Unknown||e==s||e==t.Date&&s==t.DateTime||e==t.DateTime&&s==t.Date},e.isPropSet=function isPropSet(t,e){return t[e]||t[e.toLowerCase()]||t[e.toUpperCase()]};const n="0123456789abcdefghijklmnopqrstuvwxyz";function squeeze(t,e){const s=t.length;if(s>e){let i=s/e,n="";n+=t[0];let o,r=i;for(let e=1;e<s;e++)o=t[e],e+1>r&&(n+=o,r+=i);return n}return t}function getRandomInt(t,e){return Math.floor(Math.random()*(e-t))+t}function safeParseInt(t){const e=parseInt(t);if(isNaN(e))throw`"${t}" is not a valid number`;return e}e.generateId=function generateId(t){t||(t="easy");let e=t.length>4?function squeezeMoniker(t,e){let s=t.split("-"),i=1,n=e;s.length<e&&(i=e/s.length,n=s.length);let o="";for(let t=0;t<n;t++)o+=squeeze(s[t],i);return o}(t,4):t;e&&e.length>0&&(e+="-");var s=n[getRandomInt(0,n.length)]+n[getRandomInt(0,n.length)]+n[getRandomInt(0,n.length)],i=getRandomInt(0,1e4);return e+s+function intToNumBase(t,e=36){var s="",i=t;do{s=n[i%e]+s,i=Math.floor(i/=e)}while(i>0);return s}(function getNowTicks(){return 621355968e9+1e4*(new Date).getTime()}()-0x8d60e562e627800-i)},e.strToDateTime=function strToDateTime(t,e){if(!t||0==t.length)return new Date;const s=t.replace(/[^a-zA-Z0-9_]/g,"-"),i=e.replace(/[^a-zA-Z0-9_]/g,"-").split("-"),n=s.split("-"),o=i.indexOf("MM"),r=i.indexOf("dd"),a=i.indexOf("yyyy"),l=i.indexOf("HH"),d=i.indexOf("mm"),h=i.indexOf("ss"),u=new Date;try{const t=a>-1&&a<n.length?safeParseInt(n[a]):u.getFullYear(),e=o>-1&&o<n.length?safeParseInt(n[o])-1:u.getMonth()-1;if(e>11)throw"";const s=r>-1&&r<n.length?safeParseInt(n[r]):u.getDate();if(s>function getDaysInMonth(t,e){return new Date(e,t+1,0).getDate()}(e,t))throw"";const i=l>-1&&l<n.length?safeParseInt(n[l]):0;if(i>23)throw"";const c=d>-1&&d<n.length?safeParseInt(n[d]):0;if(c>59)throw"";const g=h>-1&&h<n.length?safeParseInt(n[h]):0;if(g>59)throw"";return new Date(t,e,s,i,c,g)}catch(e){throw`${t} is not a valid date.`}},e.strToTime=function strToTime(t){const e=t.split(":");try{const t=e.length>0?safeParseInt(e[0]):0;if(t>23)throw"";const s=e.length>1?safeParseInt(e[1]):0;if(s>59)throw"";const i=e.length>1?safeParseInt(e[1]):0;if(i>59)throw"";return new Date(0,0,0,t,s,i)}catch(e){throw`${t} is not a valid time.`}}}(n||(n={}));class HttpActionResult{constructor(t,e){this.request=t,this.promise=e}getPromise(){return this.promise}getRequest(){return this.request}then(t,e){return this.promise.then(t,e)}catch(t){return this.promise.catch(t)}finally(t){return this.promise.finally(t)}}class HttpResponseError extends Error{constructor(t,e){super(e),Object.setPrototypeOf(this,HttpResponseError.prototype),this.status=t}}class HttpClient{get responseBody(){return this._responseBody}constructor(){this.defaultHeaders={},this.customPayload=void 0}get(t,e){return this.send(i.Get,t,null,e)}post(t,e,s){return this.send(i.Post,t,e,s)}put(t,e,s){return this.send(i.Put,t,e,s)}delete(t,e,s){return this.send(i.Delete,t,e,s)}send(t,e,s,i){const o=(i=i||{}).dataType||"json",r=i.contentType||"form-data"!==o?"application/json":null;s&&"form-data"!=o&&this.customPayload&&(s.data=n.assignDeep(s.data||{},this.customPayload));const a=new("onload"in new XMLHttpRequest?XMLHttpRequest:window.XDomainRequest),l={method:t,url:e,headers:Object.assign(Object.assign({},this.defaultHeaders),i.headers||{}),queryParams:i.queryParams||{},data:s};r&&(l.headers["Content-Type"]=r);const d=new HttpRequest(a,l);this.beforeEachRequest&&(console.warn("HttpClient: 'beforeEachRequest' is deprecated and will be removed in future updates.\n            Use 'onRequest' instead"),this.beforeEachRequest(d)),this.onRequest&&this.onRequest(d);const h=d.data&&"string"!=typeof d.data&&"json"==o?JSON.stringify(d.data):d.data;return d.open(),new HttpActionResult(d,new Promise(((t,s)=>{i.responseType&&(a.responseType=i.responseType),a.onerror=t=>{s(new HttpResponseError(a.status,a.responseText))},a.onreadystatechange=()=>{if(4!=a.readyState)return;const i=a.getResponseHeader("Content-Type")||"",n=a.status;if(0===n)s(new HttpResponseError(n,"Network error or the request was aborted"));else if(n>=200&&n<400){const e="arraybuffer"===a.responseType||"blob"===a.responseType?a.response:0==i.indexOf("application/json")?JSON.parse(a.responseText):a.responseText;this._responseBody=e,this.onResponse&&this.onResponse(a),t(e)}else{("arraybuffer"===a.responseType||"blob"===a.responseType?HttpClient.decodeArrayBuffer(a.response):Promise.resolve(a.responseText)).then((t=>{const o=0==i.indexOf("application/json")?JSON.parse(t):t;this._responseBody=o;const r=o.message||(404==n?`No such endpoint: ${e}`:o);s(new HttpResponseError(n,r))}))}},a.send(h)})))}static decodeArrayBuffer(t){var e=new FileReader;return new Promise((s=>{e.onloadend=function(){e.readyState==FileReader.DONE&&s(e.result)},e.readAsText(new Blob([t]))}))}}!function(e){let s,i={shortDateFormat:"MM/dd/yyyy",longDateFormat:"dd MMM, yyyy",editDateFormat:"MM/dd/yyyy",shortTimeFormat:"HH:mm",editTimeFormat:"HH:mm",longTimeFormat:"HH:mm:ss",shortMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longMonthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],shortWeekDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],longWeekDayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],decimalSeparator:".",currency:"USD"},o={localeId:"en-US",englishName:"English",displayName:"English",texts:{ButtonOK:"OK",ButtonCancel:"Cancel",Yes:"Yes",No:"No",True:"True",False:"False"},settings:i},r={"en-US":o};const a=[];function mapInfo(t){for(const e of a)e(t)}function getCurrentLocale(){return s.localeId}function setCurrentLocale(t){const e=r[t];e?n.assignDeep(s,e):(s.englishName=t,s.displayName=t,s.texts=n.assignDeep({},o.texts)),s.localeId=t}function getLocaleSettings(){return s.settings}function updateLocaleSettings(t){s.settings||(s.settings=n.assignDeep({},i)),s.settings=n.assignDeep(s.settings,t)}function updateLocaleInfo(t,e){mapInfo(e);let i=s;t&&(e.localeId||(e.localeId=t),i=r[t],i||(i=n.assignDeep({},o),r[t]=i)),n.assignDeep(i,e)}function loadBrowserLocaleSettings(){!function determineSettingsByLocale(t){const e=new Date(2020,5,7,19,34,56,88),i=e.toLocaleDateString(t,{year:"numeric",month:"numeric",day:"numeric"}),n=e.toLocaleTimeString(t,{hour:"numeric",minute:"numeric",second:"numeric"});let o=i.replace("07","dd").replace("7","d").replace("06","MM").replace("6","M").replace("2020","yyyy").replace("20","yy"),r=n.replace("19","HH").replace("07","hh").replace("7","h").replace("34","mm").replace("56","ss").replace("PM","tt");s.settings||(s.settings={}),updateLocaleSettings({shortDateFormat:o,shortTimeFormat:r})}("object"==typeof navigator?navigator.language:void 0)}e.addMapper=function addMapper(t){a.push(t)},e.getLocales=function getLocales(){let t=[];for(let e in r)t.push({locale:e,englishName:r[e].englishName,displayName:r[e].displayName});return t.sort(((t,e)=>t.englishName>e.englishName?1:t.englishName===e.englishName?0:-1))},e.getCurrentLocale=getCurrentLocale,e.setLocale=function setLocale(t){console.warn("This method is deprecated. Use setCurrentLocale instead"),setCurrentLocale(t)},e.setCurrentLocale=setCurrentLocale,e.getText=function getText(...t){let e=s.texts,i="";if(t&&t.length){const s=t.length;for(let n=0;n<s&&(i=e[t[n]],"object"==typeof i);n++)e=i}return i},e.getLocaleSettings=getLocaleSettings,e.getOneLocaleSetting=function getOneLocaleSetting(t){return s.settings[t]},e.getShortMonthName=function getShortMonthName(t){const e=getLocaleSettings();if(t>0&&t<13)return e.shortMonthNames[t-1];throw"Wrong month number: "+t},e.getLongMonthName=function getLongMonthName(t){const e=getLocaleSettings();if(t>0&&t<13)return e.longMonthNames[t-1];throw"Wrong month number: "+t},e.getShortWeekDayName=function getShortWeekDayName(t){const e=getLocaleSettings();if(t>0&&t<8)return e.shortWeekDayNames.length>=t?e.shortWeekDayNames[t-1]:t.toString();throw"Wrong month number: "+t},e.getLongWeekDayName=function getLongWeekDayName(t){const e=getLocaleSettings();if(t>0&&t<8)return e.longWeekDayNames.length>=t?e.longWeekDayNames[t-1]:t.toString();throw"Wrong month number: "+t},e.updateLocaleSettings=updateLocaleSettings,e.updateLocaleTexts=function updateLocaleTexts(t){"object"==typeof t?(mapInfo({localeId:s.localeId,texts:t}),n.assignDeep(s.texts,t)):console.error("Wrong parameter type in updateLocaleTexts function call.The first parameter (localeId) is not necessary. Use updateLocaleTexts(texts) instead")},e.updateDefaultTexts=function updateDefaultTexts(t){for(let e in r){let s=r[e];s.texts=n.assignDeep({},t,s.texts)}s.texts=n.assignDeep({},t,s.texts)},e.updateLocaleInfo=updateLocaleInfo,e.addLocale=function addLocale(t,e){updateLocaleInfo(t,e)},e.resetLocales=function resetLocales(){s||(s=n.assignDeep({},o),loadBrowserLocaleSettings())};const l=/\[([^\]]+)]|y{2,4}|M{1,4}|d{1,2}|H{1,2}|h{1,2}|m{2}|s{2}|t{2}/g;function dateTimeToStr(t,s){const i=t.getFullYear().toString(),n=t.getMonth()+1,o=t.getDate(),r=t.getHours(),a=t.getMinutes(),d=t.getSeconds(),h=r%12||12,u=r>11,c={yyyy:i,yy:i.substring(i.length-2),MMMM:e.getLongMonthName(n),MMM:e.getShortMonthName(n),MM:n<10?"0"+n:n.toString(),M:n.toString(),dd:o<10?"0"+o:o.toString(),d:o.toString(),HH:r<10?"0"+r:r.toString(),H:r.toString(),hh:h<10?"0"+h:h.toString(),h:h.toString(),tt:u?"PM":"AM",mm:a<10?"0"+a:a.toString(),ss:d<10?"0"+d:d.toString()};return s.replace(l,((t,e)=>e||c[t]))}function buildShortDateTimeFormat(e){const s=getLocaleSettings();let i;switch(e){case t.Date:i=s.shortDateFormat;break;case t.Time:i=s.shortTimeFormat;break;default:i=s.shortDateFormat+" "+s.shortTimeFormat}return i}function buildLongDateTimeFormat(e){const s=getLocaleSettings();let i;switch(e){case t.Date:i=s.longDateFormat;break;case t.Time:i=s.longTimeFormat;break;default:i=s.longDateFormat+" "+s.longTimeFormat}return i}e.dateTimeToStr=dateTimeToStr,e.dateTimeToStrEx=function dateTimeToStrEx(e,s,i){return i?"d"==i?i=buildShortDateTimeFormat(t.Date):"D"==i?i=buildLongDateTimeFormat(t.Date):"f"==i?i=buildShortDateTimeFormat(t.DateTime):"F"==i?i=buildLongDateTimeFormat(t.DateTime):"u"==i&&(i=function buildUniversalDateTimeFormat(e){const s=getLocaleSettings();let i;const n="yyyy-MM-dd";switch(e){case t.Date:i=n;break;case t.Time:i=s.shortTimeFormat;break;default:i=n+" "+s.shortTimeFormat}return i}(s)):i=buildShortDateTimeFormat(s),dateTimeToStr(e,i)},e.numberToStr=function numberToStr(t,s,i){if(s&&s.length>0){const i=s.charAt(0).toUpperCase();if("S"===i)return function formatWithSequence(t,s){if(!d[s]){const t=s.split("|").filter((t=>t.length>0)).map((t=>t.split("=")));if(d[s]={},t.length>0)if(t[0].length>1)for(const e of t)d[s][Number.parseInt(e[1])]=e[0];else t.forEach(((t,e)=>{d[s][e]=t[0]}))}const i=d[s];if(void 0!==i[t]){const s=i[t];return e.getText(s)||s}return t.toString()}(t,s.slice(1));if(["D","F","C"].indexOf(i)>=0){const e=getCurrentLocale();return t.toLocaleString(e,function getNumberFormatOptions(t){const e=getLocaleSettings(),s=t[0].toUpperCase(),i=t.length>1?Number.parseInt(t.slice(1)):"D"==s?1:2;switch(s){case"D":return{style:"decimal",useGrouping:!1,minimumIntegerDigits:i};case"C":return{style:"currency",currency:e.currency,minimumFractionDigits:i};default:return{style:"decimal",minimumFractionDigits:i,maximumFractionDigits:i}}}(s))}return function convertWithMask(t,e){let s=t.toString(),i="",n=s.length-1;for(let t=e.length-1;t>=0;t--){const o=e.charAt(t);"#"===o||"0"===o?n>=0?(i+=s.charAt(n),n--):"0"===o&&(i+=0):i+=o}return i.split("").reverse().join("")}(Math.trunc(t),s)}const n=getLocaleSettings();return i=i||n.decimalSeparator,t.toString().replace(".",i)},e.booleanToStr=function booleanToStr(t,s){if(s&&s.length>0){if("S"===s.charAt(0).toUpperCase()){const i=s.slice(1).split("|");if(i.length>1){const s=i[t?1:0];return e.getText(s)||s}}}return`${t}`};const d={}}(o||(o={}));class MetaEntity{constructor(t){this.isEditable=!0,this.name="",this.caption="",this.description="",this.parent=t,this.attributes=new Array,this.subEntities=new Array}loadFromData(t,e){if(e){if(this.id=e.id,this.name=e.name,this.captionPlural=e.namePlur,this.caption=e.name,this.description=e.desc,void 0!==e.ied&&(this.isEditable=e.ied),this.subEntities=new Array,e.ents)for(let s=0;s<e.ents.length;s++){let i=t.createEntity(this);i.loadFromData(t,e.ents[s]),this.subEntities.push(i)}if(this.attributes=new Array,e.attrs)for(let s=0;s<e.attrs.length;s++){let i=t.createEntityAttr(this);i.loadFromData(t,e.attrs[s]),this.attributes.push(i)}}}scan(t,e){let s={stop:!1},internalProcessEntity=i=>{if(e&&e(i,s),i.attributes){let e=i.attributes.length;for(let n=0;n<e&&!s.stop;n++){let e=i.attributes[n];if(t&&t(e,s),s.stop)return}}if(i.subEntities){let t=i.subEntities.length;for(let e=0;e<t&&!s.stop;e++)internalProcessEntity(i.subEntities[e])}};internalProcessEntity(this)}getFirstPrimaryAttr(){return this.getPrimaryAttrs()[0]}getPrimaryAttrs(){return this.attributes.filter((t=>t.isPrimaryKey))}}class MetaEntityAttr{constructor(s){this.id="",this.caption="{Unrecognized attribute}",this.dataType=t.String,this.size=0,this.isPrimaryKey=!1,this.isForeignKey=!1,this.isNullable=!0,this.showOnView=!0,this.isEditable=!0,this.showOnCreate=!0,this.showOnEdit=!0,this.showInLookup=!1,this.lookupAttr="",this.expr="",this.entity=s,this.kind=e.Data}loadFromData(t,e){if(e){this.id=e.id,this.description=e.desc,this.caption=e.cptn,this.dataType=e.dtype,this.isPrimaryKey=e.ipk,this.isForeignKey=e.ifk,this.size=e.size,this.lookupAttr=e.lattr,this.lookupEntity=e.lent,this.dataAttr=e.dattr,this.lookupDataAttr=e.ldattr;const s=n.getDateDataTypes().indexOf(this.dataType);this.defaultValue=e.defVal&&s?new Date(e.defVal):e.defVal,this.isNullable=n.getIfDefined(e.nul,this.isNullable),this.isEditable=n.getIfDefined(e.ied,this.isEditable),this.showOnView=n.getIfDefined(e.ivis||e.sov,this.showOnView),this.showOnCreate=n.getIfDefined(e.soc,this.showOnCreate),this.showOnEdit=n.getIfDefined(e.soe,this.showOnEdit),this.showInLookup=n.getIfDefined(e.sil,this.showInLookup),this.kind=e.kind,this.displayFormat=e.dfmt,e.udata&&(this.userData=e.udata),e.edtr&&(this.defaultEditor=t.getEditorById(e.edtr)||t.createValueEditor())}}}class ValueEditor{constructor(){this.id="",this.tag=s.Unknown,this.resType=t.Unknown,this.defValue=""}loadFromData(t){t&&(this.id=t.id,this.tag=t.tag,this.defValue=t.defval,this.resType=t.rtype,this.accept=t.accept,this.multiline=t.multiline,t.subType&&(this.resType=t.subType),t.name&&(this.name=t.name),t.values&&(this.values=t.values))}getValueText(t){let e="";if(!this.values)return e;if(Array.isArray(t))for(let s of this.values)t.indexOf(s.id)>=0&&(e+=s.text+",");else for(let s of this.values)s.id===t&&(e+=s.text+",");return e&&(e=e.substring(0,e.length-1)),e}}class MetaData{constructor(){this.mainEntity=null,this.id="__none",this.name="Empty model",this.rootEntity=this.createEntity(),this.displayFormats=new Map}getMainEntity(){return this.mainEntity}createEntity(t){return new MetaEntity(t)}createEntityAttr(t){return new MetaEntityAttr(t)}createValueEditor(){return new ValueEditor}loadFromJSON(t){let e=JSON.parse(t);this.loadFromData(e)}loadFromData(e){if(this.id=e.id,this.name=e.name,this.version=e.vers,this.editors=new Array,e.editors)for(let t=0;t<e.editors.length;t++){let s=this.createValueEditor();s.loadFromData(e.editors[t]),this.editors.push(s)}if(this.rootEntity.loadFromData(this,e.entroot),this.displayFormats=new Map,e.displayFormats)for(const s in e.displayFormats){const i=t[s],n=e.displayFormats[s]||new Array;this.displayFormats.set(i,n)}}getDisplayFormats(){return this.displayFormats}getDisplayFormatsForType(t){return this.displayFormats.has(t)?this.displayFormats.get(t):[]}getDefaultFormat(t){return this.displayFormats.has(t)?this.displayFormats.get(t).filter((t=>t.isdef))[0]:null}setData(t){"string"==typeof t?this.loadFromJSON(t):this.loadFromData(t)}isEmpty(){return 0===this.rootEntity.subEntities.length&&0===this.rootEntity.attributes.length}getId(){return this.id}getName(){return this.name}getRootEntity(){return this.rootEntity}getEditorById(t){for(let e of this.editors)if(e.id===t)return e;return null}getAttributeById(t){let e=this.getEntityAttrById(this.getRootEntity(),t);return e||null}checkAttrProperty(t,e){let s=this.getAttributeById(t);if(s){if(void 0===s[e])throw"No such property: "+e;return!!s[e]||!!s.lookupAttr&&(t=s.lookupAttr,s=this.getAttributeById(t),s&&s[e])}return!1}getEntityAttrById(t,e){let s,i;if(t.attributes){let i=t.attributes.length;for(s=0;s<i;s++)if(t.attributes[s].id==e)return t.attributes[s]}if(t.subEntities){let n=t.subEntities.length;for(s=0;s<n;s++)if(i=this.getEntityAttrById(t.subEntities[s],e),i)return i}return null}listByEntityWithFilter(t,e){let s,i=new Array,r=null;if(t.subEntities){let a=t.subEntities.length;for(let l=0;l<a;l++)if(r=t.subEntities[l],!e||e(r,null)){s=o.getText("Entities",r.name),s||(s=r.caption);let t=n.assign(this.createEntity(),{id:r.name,text:s,items:[],isEntity:!0});t.items=this.listByEntityWithFilter(r,e),t.items.length>0&&i.push(t)}}let a=null;if(t.attributes){let r=t.attributes.length;for(let l=0;l<r;l++)if(a=t.attributes[l],!e||e(t,a)){s=o.getText("Attributes",a.id),s||(s=a.caption);let t=n.assign(this.createEntity(),{id:a.id,text:s,dataType:a.dataType});i.push(t)}}return i}listByEntity(t,e,s){e=e||{};let i,r=[],a=[],l=null;if(t.subEntities){let a=t.subEntities.length;for(let d=0;d<a;d++)if(l=t.subEntities[d],!s||s(l,null)){i=o.getText("Entities",l.name)||l.caption;let t=n.assign(this.createEntity(),{id:l.name,text:i,items:[],isEntity:!0,description:l.description}),a=n.assign({},e);a.includeRootData=!1,t.items=this.listByEntity(l,a,s),t.items.length>0&&r.push(t)}}let d=null;if(t.attributes){let e=t.attributes.length;for(let r=0;r<e;r++)d=t.attributes[r],s&&!s(t,d)||(i=o.getText("Attributes",d.id)||d.caption,a.push(n.assign(this.createEntityAttr(t),{id:d.id,text:i,dataType:d.dataType,lookupAttr:d.lookupAttr,description:d.description})))}let h,sortCheck=(t,e)=>t.text.toLowerCase()==e.text.toLowerCase()?0:t.text.toLowerCase()>e.text.toLowerCase()?1:-1;return e.sortEntities&&(r.sort(sortCheck),a.sort(sortCheck)),h=e.attrPlacement&&0!=e.attrPlacement?a.concat(r):r.concat(a),2==e.attrPlacement&&h.sort(sortCheck),e.includeRootData?(i=o.getText("Entities",t.name),i||(i=t.caption),{id:t.name,text:i,items:h}):h}clear(){this.rootEntity=this.createEntity(),this.editors=[],this.version=""}addDefaultValueEditors(){let e;e=this.addOrUpdateValueEditor("_DTE",s.Edit,t.String),e.defValue="",this.addOrUpdateValueEditor("_DPDE",s.DateTime,t.DateTime),this.addOrUpdateValueEditor("_DPTE",s.DateTime,t.DateTime)}addOrUpdateValueEditor(t,e,s){let i=n.findItemById(this.editors,t);return i||(i=this.createValueEditor(),i.id=t,this.editors.push(i)),i.tag=e,i.resType=s,i}getEntitiesTree(t,e){return this.listByEntity(this.getRootEntity(),t,e)}getEntitiesTreeWithFilter(t){return this.listByEntityWithFilter(this.getRootEntity(),t)}getFullEntityPathByAttr(t,e){return e=e||" ",this.getEntityPathByAttr(this.getRootEntity(),t,e,!0)}getEntityPathByAttr(t,e,s,i){if(!t)return"";s=s||" ";let n="";if(t.caption&&!i){let e=o.getText("Entities",t.caption);n=e||t.caption}if(t.attributes){let s=t.attributes.length;for(let i=0;i<s;i++)if(t.attributes[i].id==e)return n}if(t.subEntities){let i=t.subEntities.length;for(let o=0;o<i;o++){let i=t.subEntities[o],r=this.getEntityPathByAttr(i,e,s,!1);if(""!==r)return""!==n&&(r=n+s+r),r}}return""}getAttributeText(t,e){let s=o.getText("Attributes",t.id);if(s||(s=t.caption),!e)return s;let i="",n=this.getFullEntityPathByAttr(t.id," ");return n?(i=e.replace(new RegExp("{attr}","g"),s),i=i.replace(new RegExp("{entity}","g"),n)):i=s,i.trim()}runThroughEntities(t,e){this.getRootEntity().scan(t,e)}getFirstAttributeByFilter(t){let e=null;return this.runThroughEntities((function(s,i){t(s)&&(i.stop=!0,e=s)}),null),e}}class AggregationSettings{constructor(t){this.colStore=t,this.aggregates=[],this.groups=[],this.useGrandTotals=!1,this.useRecordCount=!1,this._caseSensitiveGroups=!1,this.COUNT_FIELD_NAME="GRPRECCNT"}get caseSensitiveGroups(){return this._caseSensitiveGroups}set caseSensitiveGroups(t){this._caseSensitiveGroups=t,this.updateCompareProc()}updateCompareProc(){this.compareValues=this._caseSensitiveGroups?this.strictCompare:this.caseInsensitiveCompare}addGroup(t){const e=t.columns||this.colStore.getColumnIds(t.from,t.to);if(!this.colStore.validateColumns(e))throw"Invalid columns: "+e;if(this.hasColumnsInUse(e))throw"Can't add same columns to different groups/aggregates";return this.groups.push(Object.assign({columns:e},t)),this}addAggregateColumn(t,e){const s="string"==typeof t?t:this.colStore.getColumnIds(t,t)[0];if(this.hasColumnsInUse([s])||!this.colStore.validateAggregate(s,e))throw"Invalid aggregation function for the column: "+s;return this.aggregates.push({colId:s,funcId:e}),this}addGrandTotals(){return this.useGrandTotals=!0,this}addCounts(){return this.useRecordCount=!0,this}getGroups(){let t=[];return this.groups.map((e=>(t=t.concat(e.columns),Object.assign(Object.assign({},e),{columns:Array.from(t),aggregates:Array.from(this.aggregates)}))))}getInternalGroups(){return this.groups}lastGroup(){const t=this.getGroups();return t[t.length-1]}getAggregates(){return this.aggregates}hasAggregates(){return this.aggregates.length>0}hasGroups(){return this.groups.length>0}hasGrandTotals(){return this.useGrandTotals}hasRecordCount(){return this.useRecordCount}isEmpty(){return!(this.hasAggregates()||this.hasGroups()||this.hasGrandTotals()||this.hasRecordCount())}isValid(){return this.hasGroups()&&(this.hasAggregates()||this.hasRecordCount())||this.hasAggregates&&this.hasGrandTotals()}drop(){console.warn('"drop()" method is obsolete. Use "clear()" instead'),this.clear()}clear(){return this.groups=[],this.aggregates=[],this.useGrandTotals=!1,this.useRecordCount=!1,this.caseSensitiveGroups=!1,this}hasColumnsInUse(t){for(const e of this.groups){if(e.columns.filter((e=>t.indexOf(e)>=0)).length>0)return!0}for(const e of this.aggregates)if(t.indexOf(e.colId)>=0)return!0;return!1}needAggrCalculation(){return(this.hasAggregates()||this.hasRecordCount())&&(this.hasGrandTotals()||this.hasGroups())}saveToData(){return{groups:Array.from(this.groups),ugt:this.useGrandTotals,urc:this.useRecordCount,csg:this.caseSensitiveGroups,aggregates:Array.from(this.aggregates)}}loadFromData(t){t&&(void 0!==t.ugt&&(this.useGrandTotals=t.ugt),void 0!==t.urc&&(this.useRecordCount=t.urc),void 0!==t.csg&&(this.caseSensitiveGroups=t.csg),t.groups&&(this.groups=Array.from(t.groups)),t.aggregates&&(this.aggregates=Array.from(t.aggregates)))}buildGroupKey(t,e){const s=!this.caseSensitiveGroups;let i={};if(t)for(const n of t.columns){let t=e.getValue(n);s&&"string"==typeof t&&(t=t.toLowerCase()),i[n]=t}return i}strictCompare(t,e){return t instanceof Date?t.getTime()===e.getTime():t===e}caseInsensitiveCompare(t,e){if(t instanceof Date)return t.getTime()===e.getTime();return("string"==typeof t?t.toLowerCase():t)===("string"==typeof e?e.toLowerCase():e)}}!function(t){t[t.None=0]="None",t[t.Left=1]="Left",t[t.Center=2]="Center",t[t.Right=3]="Right"}(r||(r={}));class DataColumn{constructor(e){if(!e)throw Error("Options are required");if(!e.id)throw Error("Field Id is required");if(!e.label)throw Error("Label is required");this.id=e.id,this.type=n.getIfDefined(e.type,t.String),this.label=e.label,this.originAttrId=e.originAttrId,this.isAggr=e.isAggr||!1,this.displayFormat=e.dfmt,this.groupFooterColumnTemplate=e.gfct,this.style=e.style||{},this.description=e.description,this.calculatedWidth=0}}class DataColumnList{constructor(){this.items=[],this.mapper={},this._dateColumnIdx=[]}get count(){return this.items.length}add(e){let s;s=e instanceof DataColumn?e:new DataColumn(e);const i=this.items.length;return this.items.push(s),this.mapper[s.id]=i,[t.Date,t.DateTime,t.Time].indexOf(s.type)>=0&&this._dateColumnIdx.push(i),i}updateDateColumnIdx(){this._dateColumnIdx=this.getItems().filter((e=>[t.Date,t.DateTime,t.Time].indexOf(e.type)>=0)).map(((t,e)=>e))}put(t,e){t>=0&&t<this.count&&(this.items[t]=e,this.updateDateColumnIdx())}move(t,e){let s=this.items.indexOf(t);s>=0&&s!=e&&(n.moveArrayItem(this.items,s,e),this.updateDateColumnIdx())}get(t){return t>=0&&t<this.count?this.items[t]:null}getIndex(t){return this.mapper[t]}getItems(){return this.items}getDateColumnIndexes(){return this._dateColumnIdx}removeAt(t){const e=this.get(t);this.items.splice(t,1);const s=this._dateColumnIdx.indexOf(t);s>=0&&this._dateColumnIdx.splice(s,1),delete this.mapper[e.id]}clear(){this.items=[],this._dateColumnIdx=[],this.mapper={}}}class DataRow{constructor(t,e){this.columns=t,this.values=e}toArray(){return Array.from(this.values)}size(){return this.values.length}getValue(t){let e;if("string"==typeof t){if(e=this.columns.getIndex(t),void 0===e)throw new RangeError(`No column with id '${t}'`)}else e=t;if(e>=this.values.length)throw new RangeError("Out of range: "+e);return this.values[e]}setValue(t,e){let s;if("string"==typeof t){if(s=this.columns.getIndex(t),void 0===s)throw new RangeError(`No column with id '${t}'`)}else s=t;if(s>=this.values.length)throw new RangeError("Out of range: "+s);this.values[s]=e}}class EasyDataTable{constructor(t){if(this._chunkSize=1e3,this._elasticChunks=!1,this.cachedRows=[],this.total=0,this.loader=null,this.needTotal=!0,this.isInMemory=!1,t=t||{},this._chunkSize=t.chunkSize||this._chunkSize,this._elasticChunks=t.elasticChunks||this._elasticChunks,this.loader=t.loader,void 0!==t.inMemory&&(this.isInMemory=t.inMemory),this.isInMemory&&(this.needTotal=!1),this._columns=new DataColumnList,this.onUpdate=t.onUpdate,t.columns)for(const e of t.columns)this._columns.add(e);if(t.rows)for(const e of t.rows){const t=this.createRow(e);this.addRow(t)}this.needTotal=!this._elasticChunks}get columns(){return this._columns}get chunkSize(){return this._chunkSize}set chunkSize(t){this._chunkSize=t,this.total=0,this.needTotal=!this.elasticChunks,this.cachedRows=[]}get elasticChunks(){return this._elasticChunks}set elasticChunks(t){this._elasticChunks=t,this.total=0,this.needTotal=!this.elasticChunks,this.cachedRows=[]}getRows(t){let e=0,s=this._chunkSize;t&&("page"in t?(e=t.pageSize*(t.page-1),s=t.pageSize):(e=t.offset,s=t.limit));let i=e+s;if(!this.needTotal&&!this.elasticChunks){if(e>=this.total)return Promise.resolve([]);i>this.total&&(i=this.total)}if(this.isInMemory&&i>this.cachedRows.length&&(i=this.cachedRows.length),i<=this.cachedRows.length)return Promise.resolve(this.cachedRows.slice(e,i));if(!this.loader)throw`Loader is not defined. Can't get the rows from ${e} to ${i}`;const n=this.needTotal;this.needTotal&&(this.needTotal=!1);let o=this.cachedRows.length,r=i-o;r<this._chunkSize&&(r=this._chunkSize);return this.loader.loadChunk({offset:o,limit:r,needTotal:n}).then((t=>{if(n&&(this.total=t.total),Array.prototype.push.apply(this.cachedRows,t.table.getCachedRows()),i>this.cachedRows.length&&(i=this.cachedRows.length),this.elasticChunks){t.table.getCachedCount()<r&&(this.total=this.cachedRows.length)}return this.fireUpdated(),this.cachedRows.slice(e,i)}))}getRow(t){return this.getRows({offset:t,limit:1}).then((t=>t.length>0?t[0]:null))}getTotal(){return this.total}setTotal(t){this.total=t,this.needTotal=!1}getCachedCount(){return this.cachedRows.length}clear(){this.columns.clear(),this.cachedRows=[],this.total=0,this.needTotal=!this._elasticChunks,this.fireUpdated()}createRow(t){const e=this._columns.getDateColumnIndexes(),s=new Array(this._columns.count),i=t instanceof DataRow?e=>t.getValue(e):e=>t[e];return t&&this.columns.getItems().forEach((t=>{const n=i(t.id),o=this.columns.getIndex(t.id);s[o]=e.indexOf(o)>=0?this.mapDate(n,t.type):n})),new DataRow(this._columns,s)}mapDate(e,s){if(e){let i=new Date(e);return isNaN(i.getTime())&&s==t.Time&&(i=n.strToTime(e)),i}return null}addRow(t){let e;if(Array.isArray(t)){let s=t;const i=this._columns.getDateColumnIndexes();if(i.length>0)for(const t of i)s[t]&&(s[t]=this.mapDate(s[t],this._columns.get(t).type));e=new DataRow(this._columns,s)}else e=this.createRow(t);this.cachedRows.push(e);const s=this.getCachedCount();return s>this.total&&(this.total=s),e}getCachedRows(){return this.cachedRows}totalIsKnown(){if(this.elasticChunks){return this.getCachedCount()===this.total}return!this.needTotal}fireUpdated(){this.onUpdate&&this.onUpdate(this)}}class EasyGuid{static newGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=16*Math.random()|0;return("x"==t?e:3&e|8).toString(16)}))}}class EventEmitter{constructor(t){this.silentMode=0,this.events=new Array,this.source=t}subscribe(t,e){let s=this.getEventRecByType(t);const i={id:EasyGuid.newGuid(),callback:e};return s?s.eventCallbacks.push(i):(s={type:t,eventCallbacks:new Array(i)},this.events.push(s)),i.id}unsubscribe(t,e){let s=this.getEventRecByType(t);if(s){let t=-1;for(t=0;t<s.eventCallbacks.length&&s.eventCallbacks[t].id!==e;t++);t>=0&&s.eventCallbacks.splice(t,1)}}fire(t,e,s=0,i=!1){if(this.silentMode&&!i)return;let n=this.getEventRecByType(t);if(n){const i={type:t,source:this.source,data:e};let emitAllFunc=()=>{for(let t of n.eventCallbacks)t.callback(i)};s>0?setTimeout(emitAllFunc,s):emitAllFunc()}}enterSilentMode(){this.silentMode++}exitSilentMode(){this.silentMode&&this.silentMode--}isSilent(){return this.silentMode>0}getEventRecByType(t){for(let e of this.events)if(e.type==t)return e;return null}}!function(t){t.renderLiquidTemplate=function renderLiquidTemplate(t,e){let s=t;if(e)for(let t in e){const i=new RegExp("{{"+t+"}}","g");s=s.replace(i,e[t])}return s}}(a||(a={})),o.resetLocales(),"function"!=typeof Object.values&&(Object.values=function(t){return Object.keys(t).map((e=>t[e]))}),"function"!=typeof Math.trunc&&(Math.trunc=function(t){return isNaN(t)?NaN:t>0?Math.floor(t):Math.ceil(t)});class FormatParser{constructor(t){this.start(t)}start(t){this.formatStr=t,this.pos=0,this.exprNum=0,this.tokenText=""}skipSpaces(){for(;this.pos<this.formatStr.length&&" "===this.formatStr.charAt(this.pos);)this.pos++}next(){if(this.skipSpaces(),this.pos>=this.formatStr.length)return!1;var t=0;if("{"===this.formatStr.charAt(this.pos)){if((t=this.formatStr.indexOf("}",this.pos))<0)return!1;this.tokenText=this.formatStr.substring(this.pos,t+1),0===this.tokenText.indexOf("{expr")&&(this.token="expression",this.exprNum=parseInt(this.tokenText.substring(5,this.tokenText.length))),this.pos=t+1}else if("["===this.formatStr.charAt(this.pos)&&this.pos<this.formatStr.length-1&&"["===this.formatStr.charAt(this.pos+1))this.pos+=2,t=this.formatStr.indexOf("]]",this.pos),this.token="operator",this.tokenText=this.formatStr.substring(this.pos,t),this.pos=t+2;else{this.token="text";var e=this.formatStr.indexOf("{",this.pos);e<0&&(e=this.formatStr.length);var s=this.formatStr.indexOf("[[",this.pos);s<0&&(s=this.formatStr.length),t=Math.min(e,s),this.tokenText=this.formatStr.substring(this.pos,t).trim(),this.pos=t}return!0}getToken(){return{type:this.token,text:this.tokenText,index:this.exprNum-1}}parse(){let t=[];for(;this.next();)t.push(this.getToken());return t}}!function(t){t[t.None=0]="None",t[t.Any=1]="Any",t[t.NotAll=2]="NotAll",t[t.All=3]="All"}(l||(l={})),function(e){e.combinePath=function combinePath(t,e){let s=t;return null!=s&&s.length>0?("/"!=s.charAt(s.length-1)&&(s+="/"),s+=e):s=e,s},e.strToLinkType=function strToLinkType(t){return"All"==t?l.All:"NotAll"==t?l.NotAll:"Any"==t?l.Any:l.None},e.linkTypeToStr=function linkTypeToStr(t){return t===l.All?"All":t===l.NotAll?"NotAll":t==l.Any?"Any":"None"},e.parseOperatorFormat=function parseOperatorFormat(t){let e=o.getText("Operators",t.id,"format");return e||(e=o.getText("Operators",t.id,"displayFormat")),e||(e=t.displayFormat),new FormatParser(e).parse()},e.convertValue=function convertValue(e,s,i){switch(i){case t.String:return e;case t.Autoinc,t.Byte,t.Int32,t.Int64,t.Word:let s=parseInt(e);return isNaN(s)?"":s.toString();case t.Currency,t.Float:let i=parseFloat(e);return isNaN(i)?"":i.toString();default:return""}}}(d||(d={}));class AggrFunction{constructor(){this.id="",this.caption="",this.sqlExpr="",this.displayFormat="",this.appliedTypes=[]}loadFromData(t){t&&(this.id=t.id,this.caption=t.cptn,this.displayFormat=t.fmt,this.sqlExpr=t.expr,this.appliedTypes=t.dtypes||this.appliedTypes)}getAppliedTypesOrDefault(){return this.appliedTypes.length>0?this.appliedTypes:"SUM"===this.id||"AVG"===this.id?[t.Autoinc,t.Byte,t.Currency,t.Float,t.Int32,t.Int64,t.Word]:"MIN"===this.id||"MAX"===this.id?[t.Autoinc,t.BCD,t.Byte,t.Currency,t.Date,t.DateTime,t.Time,t.Float,t.Int32,t.Int64,t.Word]:n.getAllDataTypes()}}class EqValueEditor extends ValueEditor{constructor(){super()}loadFromData(t){super.loadFromData(t),t&&(t.sql&&(this.statement=t.sql),t.extraParams&&(this.extraParams=t.extraParams))}}!function(t){t[t.Scalar=0]="Scalar",t[t.Const=1]="Const",t[t.Attribute=2]="Attribute",t[t.List=4]="List",t[t.Query=5]="Query",t[t.ParentColumn=6]="ParentColumn"}(h||(h={}));class Operator{constructor(){this.id="",this.expr="",this.constValueFormat="{const}",this.caption="{Unrecognized operator}",this.displayFormat="{expr1} [[{unrecognized operator}]] {expr2}",this.isRange=!1,this.caseIns=!1,this.paramCount=2,this.defaultOperand=new Operand,this.appliedTypes=[],this.operands=new Array}loadFromData(t,e){if(e&&(this.id=e.id,this.caption=e.cptn,this.caseIns=e.caseIns,this.isRange=e.isRange,this.displayFormat=e.fmt,this.paramCount=e.pcnt,this.expr=e.expr,this.appliedTypes=e.dtypes||this.appliedTypes,e.defOperand&&this.defaultOperand.loadFromData(t,e.defOperand),e.editor&&(this.defaultOperand.editor=t.getEditorById(e.editor)||new EqValueEditor),e.operands))for(let s=0;s<e.operands.length;s++){let i=new Operand;i.loadFromData(t,e.operands[s]),e.editor&&(i.editor=t.getEditorById(e.editor)||new EqValueEditor),this.operands.push(i)}}}class Operand{constructor(){this.kind=h.Scalar,this.dataType=t.Unknown,this.editor=new EqValueEditor,this.defValue=""}loadFromData(t,e){this.kind=e.kind,this.dataType=e.dtype,this.defValue=e.val,this.defText=e.txt,e.editor&&(this.editor=t.getEditorById(e.editor)||new EqValueEditor)}copyFrom(t){n.assign(this,t)}}class Entity extends MetaEntity{constructor(t){super(t),this.useInConditions=!1,this.useInResult=!1,this.useInSorting=!1}loadFromData(t,e){super.loadFromData(t,e),e&&(this.useInConditions=e.uic,this.useInResult=e.uir,this.useInSorting=e.uis)}scan(t,e){super.scan(((e,s)=>t&&t(e,s)),((t,s)=>e&&e(t,s)))}}class EntityAttr extends MetaEntityAttr{constructor(t){super(t),this.params=[],this.useInConditions=!0,this.useInResult=!0,this.useInSorting=!0,this.defaultOperator="",this.operators=new Array,this.lookupAttr="",this.expr=""}loadFromData(t,e){super.loadFromData(t,e),e&&(this.useInConditions=e.uic,this.useInResult=e.uir,this.useInSorting=e.uis,this.expr=e.sql,this.defaultOperator=e.defOperator,this.operators=e.ops,e.udata&&(this.userData=e.udata))}}const u=Object.assign(Object.assign({},s),{SqlList:"SQLLIST",SubQuery:"SUBQUERY",BindToParentColumn:"BINDTOPARENTCOLUMN"});class DataModel extends MetaData{constructor(){super(),this.mainEntity=null,this.nullAttribute=new EntityAttr(null),this.nullOperator=new Operator,this.operators=new Array,this.rootEntity=new Entity,this.aggrFunctions=new Array,this.dateMacros=["Today","Yesterday","Tomorrow","FirstDayOfMonth","LastDayOfMonth","FirstDayOfWeek","FirstDayOfYear","FirstDayOfNextWeek","FirstDayOfPrevMonth","FirstDayOfNextMonth","FirstDayOfNextYear","FirstDayOfPrevYear","FirstDayOfPrevWeek"],this.timeMacros=["Now","HourStart","Midnight","Noon"],this.links=[]}getMainEntity(){return this.mainEntity}loadFromJSON(t){let e=JSON.parse(t);this.loadFromData(e)}loadFromData(t){if(super.loadFromData(t),this.operators=new Array,t.operators)for(let e=0;e<t.operators.length;e++){let s=new Operator;s.loadFromData(this,t.operators[e]),this.operators.push(s)}if(this.rootEntity.loadFromData(this,t.entroot),this.aggrFunctions=new Array,t.aggrfuncs)for(let e=0;e<t.aggrfuncs.length;e++){let s=new AggrFunction;s.loadFromData(t.aggrfuncs[e]),this.aggrFunctions.push(s)}}getObject(){return this}setData(t){"string"==typeof t?this.loadFromJSON(t):this.loadFromData(t)}createEntity(t){return new Entity(t)}createEntityAttr(t){return new EntityAttr(t)}createValueEditor(){return new EqValueEditor}getRootEntity(){return this.rootEntity}getEditorById(t){return super.getEditorById(t)}getAttributeById(t){let e=this.getEntityAttrById(this.getRootEntity(),t);return e||null}getAttributeByIdSafe(t){const e=this.getAttributeById(t);return e||this.nullAttribute}checkAttrProperty(t,e){let s=this.getAttributeById(t);if(s){if(void 0===s[e])throw"No such property: "+e;return!!s[e]||!!s.lookupAttr&&(t=s.lookupAttr,s=this.getAttributeById(t),s&&s[e])}return!1}getEntityAttrById(t,e){return super.getEntityAttrById(t,e)}_listByEntityWithFilter(t,e){let s,i=new Array,r=null;if(t.subEntities){let a=t.subEntities.length;for(let l=0;l<a;l++)if(r=t.subEntities[l],!e||e(r,null)){s=o.getText("Entities",r.name),s||(s=r.caption);let t=n.assign(new Entity,{id:r.name,text:s,items:[],isEntity:!0});t.items=this._listByEntityWithFilter(r,e),t.items.length>0&&i.push(t)}}let a=null;if(t.attributes){let r=t.attributes.length;for(let l=0;l<r;l++)if(a=t.attributes[l],!e||e(t,a)){s=o.getText("Attributes",a.id),s||(s=a.caption);let t=n.assign(new Entity,{id:a.id,text:s,dataType:a.dataType});i.push(t)}}return i}_listByEntity(t,e,s){e=e||{};let i,r=[],a=[],l=null;if(t.subEntities){let a=t.subEntities.length;for(let d=0;d<a;d++)if(l=t.subEntities[d],(!s||s(l,null))&&(!1!==e.addUIC&&!1!==l.useInConditions||!1!==e.addUIR&&!1!==l.useInResult||!1!==e.addUIS&&!1!==l.useInSorting)){i=o.getText("Entities",l.name)||l.caption;let t=n.assign(new Entity,{id:l.name,text:i,items:[],isEntity:!0,description:l.description}),a=n.assign({},e);a.includeRootData=!1,t.items=this._listByEntity(l,a,s),t.items.length>0&&r.push(t)}}let d=null;if(t.attributes){let r=t.attributes.length;for(let l=0;l<r;l++)d=t.attributes[l],s&&!s(t,d)||(!1!==e.addUIC&&!1!==d.useInConditions||!1!==e.addUIR&&!1!==d.useInResult||!1!==e.addUIS&&!1!==d.useInSorting)&&(i=o.getText("Attributes",d.id)||d.caption,a.push(n.assign(new EntityAttr(t),{id:d.id,text:i,dataType:d.dataType,lookupAttr:d.lookupAttr,description:d.description})))}let h,sortCheck=(t,e)=>t.text.toLowerCase()==e.text.toLowerCase()?0:t.text.toLowerCase()>e.text.toLowerCase()?1:-1;return e.sortEntities&&(r.sort(sortCheck),a.sort(sortCheck)),h=e.attrPlacement&&0!=e.attrPlacement?a.concat(r):r.concat(a),2==e.attrPlacement&&h.sort(sortCheck),e.includeRootData?(i=o.getText("Entities",t.name),i||(i=t.caption),{id:t.name,text:i,items:h}):h}clear(){super.clear(),this.operators=[],this.aggrFunctions=[]}addOrUpdateOperator(t){let e=n.findItemById(this.operators,t.id);return e||(e=new Operator,e.id=t.id,this.operators.push(e)),e.caption=t.caption,e.expr=t.expr||"",e.displayFormat=t.format,e.defaultOperand=new Operand,e.defaultOperand.kind=t.kind||h.Scalar,t.appliedTypes&&(e.appliedTypes=t.appliedTypes),t.paramCount>0&&(e.paramCount=t.paramCount),this.runThroughEntities(((t,s)=>{t.operators.indexOf(e.id)<0&&e.appliedTypes.indexOf(t.dataType)>=0&&t.operators.push(e.id)})),e}removeOperator(t,e=!1){let s=n.findItemById(this.operators,t);s&&(e||n.removeArrayItem(this.operators,s),this.runThroughEntities(((t,e)=>{n.removeArrayItem(t.operators,s.id)})))}getOperatorIdsByDataType(e){switch(e){case t.String:case t.Memo:return"StartsWith,EndsWith,Contains,Equal,InList,NotStartsWith,NotEndsWith,NotContains,NotEqual,NotInList,IsNull,IsNotNull".split(",");case t.Guid:return"Equal,NotEqual".split(",");case t.Date:case t.DateTime:return"DateWithinToday,DateWithinThisWeek,DateWithinPrevWeek,DateWithinThisMonth,DateWithinPrevMonth,DateWithinThisYear,DateWithinPrevYear,DateBeforePrecise,DateAfterPrecise,DatePeriodPrecise,IsNull,IsNotNull".split(",");case t.Time:return"TimeBeforePrecise,TimeAfterPrecise,TimePeriodPrecise,IsNull,IsNotNull".split(",");case t.Byte:case t.Word:case t.Int32:case t.Int64:case t.Float:case t.Currency:case t.BCD:case t.Autoinc:case t.Unknown:return"Equal,Between,LessThan,LessOrEqual,GreaterThan,GreaterOrEqual,InList,NotEqual,NotBetween,NotInList,IsNull,IsNotNull".split(",");case t.Bool:return"IsTrue,NotTrue".split(",");default:const s=[];for(let t of this.operators)t.appliedTypes.indexOf(e)>=0&&s.push(t.id);return s}}findAggrFunctionById(t){for(const e of this.aggrFunctions)if(e.id===t)return e;return null}findLink(t,e){for(let s of this.links)if(s.entityFrom==t&&s.entityTo==e)return s;return null}getLinksByEntity(t){const e=[];for(let s of this.links)s.entityFrom!=t&&s.entityTo!=t||e.push(s);return e}getEntitiesTree(t,e){return this._listByEntity(this.getRootEntity(),t,e)}getEntitiesTreeWithFilter(t){return this._listByEntityWithFilter(this.getRootEntity(),t)}getFullEntityPathByAttr(t,e){return e=e||" ",this.getEntityPathByAttr(this.getRootEntity(),t,e,!0)}getEntityPathByAttr(t,e,s,i){return super.getEntityPathByAttr(t,e,s,i)}getAttributeText(t,e){return super.getAttributeText(t,e)}getFirstUICAttr(){return this.getFirstUICAttrInEntity(this.getRootEntity())}getFirstUICAttrInEntity(t){if(!1!==t.useInConditions){if(t.attributes){let e=t.attributes.length;for(let s=0;s<e;s++)if(t.attributes[s].useInConditions)return t.attributes[s]}if(t.subEntities){let e=t.subEntities.length;for(let s=0;s<e;s++){let e=this.getFirstUICAttrInEntity(t.subEntities[s]);if(e)return e}}}return null}runThroughEntities(t,e){this.getRootEntity().scan(t,e)}getFirstAttributeByFilter(t){let e=null;return this.runThroughEntities((function(s,i){t(s)&&(i.stop=!0,e=s)}),null),e}findOperatorById(t){if(this.operators.length>0){let e=this.operators.length;for(let s=0;s<e;s++)if(this.operators[s].id==t)return this.operators[s]}return null}getOperatorById(t){let e=this.findOperatorById(t);return e||this.nullOperator}getDefaultOperatorIdForAttr(t){return t.defaultOperator?t.defaultOperator:t.operators.length>0?t.operators[0]:this.nullOperator.id}getAggrFunctionCaption(t){let e=o.getText("AggregateFunctions",t),s=e?e.caption:o.getText("Aggr"+t.replace(" ","")+"_Caption");if(s)return s;let i=n.findItemById(this.aggrFunctions,t);return i&&i.caption?i.caption:t}getAggrFunctionFormat(t){let e=o.getText("AggregateFunctions",t),s=e?e.displayFormat:o.getText("Aggr"+t.replace(" ","")+"_Format");if(s)return s;let i=n.findItemById(this.aggrFunctions,t);return i&&i.displayFormat?i.displayFormat:""}getDefaultOperatorForAttr(t){let e=this.getDefaultOperatorIdForAttr(t);return this.getOperatorById(e)}getOperand(e,s,i){let o=new Operand;s&&s.defaultOperand?(o.copyFrom(s.defaultOperand),o.defValue||(o.defValue=""),o.defText||(o.defText="")):(o.kind=h.Scalar,o.dataType=e.dataType,o.defValue="",o.defText="",o.editor=null);let r=o;return r.dataType===t.Unknown&&e&&(r.dataType=e.dataType),s&&i>=0&&s.operands&&s.operands[i-1]&&(r=n.assign(r,s.operands[i-1])),r.editor||(o.editor?r.editor=o.editor:o.kind===h.Query?r.editor.tag=u.SubQuery:e&&e.defaultEditor?r.editor=e.defaultEditor:r.dataType===t.Date||r.dataType===t.DateTime||r.dataType===t.Time?r.editor.tag=u.DateTime:r.editor.tag=u.Edit),r}getAggrFunctions(){return this.aggrFunctions}isDateMacro(t,e){const s=t.match(/\${{?(.*?)}?}/);if(null!=s){const t=s[1];if(n.indexOfArrayItem(this.dateMacros,t)>=0)return e&&e(t),!0}return!1}isTimeMacro(t,e){const s=t.match(/\${{?(.*?)}?}/);if(null!=s){const t=s[1];if(n.indexOfArrayItem(this.timeMacros,t)>=0)return e&&e(t),!0}return!1}getDateMacroValue(t){let e=new Date;return this.isDateMacro(t,(t=>{switch(t){case"Today":break;case"Yesterday":e.setDate(e.getDate()-1);break;case"Tomorrow":e.setDate(e.getDate()+1);break;case"FirstDayOfMonth":e.setDate(1);break;case"LastDayOfMonth":e.setMonth(e.getMonth()+1,0);break;case"FirstDayOfPrevWeek":s=0==(s=e.getDay())?1:8-s,e.setDate(e.getDate()-s);break;case"FirstDayOfWeek":s=0==(s=e.getDay())?6:s-1,e.setDate(e.getDate()-s);break;case"FirstDayOfYear":e.setMonth(0,1);break;case"FirstDayOfNextWeek":var s;s=0==(s=e.getDay())?1:8-s,e.setDate(e.getDate()+s);break;case"FirstDayOfNextMonth":e.setMonth(e.getMonth()+1,1);break;case"FirstDayOfPrevMonth":e.setMonth(e.getMonth()-1,1);break;case"FirstDayOfPrevYear":e.setFullYear(e.getFullYear()-1,0,1);break;case"FirstDayOfNextYear":e.setFullYear(e.getFullYear()+1,0,1)}}))?e:null}getDateOrMacroValue(t){let e=this.getDateMacroValue(t);return e||t}getTimeMacroValue(t){let e=new Date;return this.isDateMacro(t,(t=>{switch(t){case"Now":break;case"HourStart":e.setMinutes(0,0,0);break;case"Midnight":e.setHours(0,0,0,0);break;case"Noon":e.setHours(12,0,0,0)}}))?e:null}getTimeOrMacroValue(t){var e=this.getTimeMacroValue(t);return e||t}getAllDateMacros(){return this.dateMacros}getAllTimeMacros(){return this.timeMacros}}var c,g,p,m,f,y,C;!function(t){t[t.Unknown=0]="Unknown",t[t.Constant=1]="Constant",t[t.EntityAttribute=2]="EntityAttribute",t[t.ParentEntityAttribute=3]="ParentEntityAttribute",t[t.AggregateFunction=4]="AggregateFunction",t[t.ParentColumn=5]="ParentColumn",t[t.Query=11]="Query",t[t.CustomSql=21]="CustomSql"}(c||(c={}));class Expression{constructor(e){this.parent=e,this.tag=c.Constant,this.kind=h.Scalar,this.dataType=t.Unknown,this._value="",this.distinct=!1,this._isDefaultValue=!1,this.getText=()=>this.text||this._value,this.args=new Array}getParent(){return this.parent}getModel(){return this.parent.getQuery().getModel()}loadFromData(t,e){if(e)if(this.tag=e.tag,e.val?(this._value=e.val,this.text=e.txt):e.id&&(this.kind=h.Attribute,this._value=e.id,this.text=e.txt),void 0!==e.dtype&&(this.dataType=e.dtype),this.tag==c.EntityAttribute||this.tag==c.ParentEntityAttribute)this.kind=h.Attribute;else{if(void 0!==e.kind&&(this.kind=e.kind),e.query&&(this.subQuery=this.parent.getQuery().createSubQuery(),this.subQuery.loadFromDataOrJson(e.query)),void 0!==e.distinct&&(this.distinct=e.distinct),e.func&&(this.func=e.func,e.args))for(let s=0;s<e.args.length;s++){const i=new Expression(this.parent);i.loadFromData(t,e.args[s]),this.args.push(i)}e.sql&&(this.sql=e.sql,this.baseAttrId=e.baseAttrId)}}saveToData(){let t={tag:this.tag};if(t.dtype=this.dataType,this.tag==c.EntityAttribute||this.tag==c.ParentEntityAttribute)this._value&&(t.id=this._value,t.val=this._value),this.text&&(t.txt=this.text);else{if(this.subQuery&&(t.query=this.subQuery.toJSONData()),void 0!==this.kind&&(t.kind=this.kind),this._value&&(t.val=this._value),this.text&&(t.txt=this.text),this.distinct&&(t.distinct=this.distinct),this.func){t.func=this.func,t.args=[];for(let e=0;e<this.args.length;e++)t.args.push(this.args[e].saveToData())}this.sql&&(t.sql=this.sql,t.baseAttrId=this.baseAttrId)}return t}getIndex(){return this.parent.getExpressionIndex(this)}get value(){return this._value}setValue(t,e=!1){this.setContent(t,void 0,e)}setContent(t,e,s=!1){let i=this.value;if(this.kind==h.Attribute&&t){const e=this.getModel().getAttributeById(t);if(!e)throw"No such entity attribute:"+t;this.dataType=e.dataType}this._value=t,void 0!==e?this.text=e:void 0!==this.text&&(this.text=t),this._isDefaultValue=!1,s||this.parent.expressionChanged(this,i)}isEmpty(){return!(this.text||this._value)}hasText(){return this.text&&this.text.length>0}tryCopyValueFrom(t){if(this.kind==t.kind){if(this.dataType==t.dataType)this.setContent(t.value.length?t.value:this._value,t.text&&t.text.length?t.text:this.text,!0);else{const e=d.convertValue(t.value,t.dataType,this.dataType);this.setContent(e.length?e:this._value,t.text&&t.text.length?t.text:this.text,!0)}this.subQuery=t.subQuery,this.sql=t.sql,this.baseAttrId=t.baseAttrId}else this._isDefaultValue||(this.setContent("","",!0),this.subQuery=null,this.sql=null,this.baseAttrId=null)}}!function(t){t[t.Conditions=1]="Conditions",t[t.Columns=2]="Columns",t[t.SortingColumns=4]="SortingColumns",t[t.Properties=32]="Properties",t[t.ExtraData=64]="ExtraData",t[t.Facets=128]="Facets",t[t.Aggregation=256]="Aggregation",t[t.All=511]="All"}(g||(g={})),function(t){t[t.Add=1]="Add",t[t.Modify=2]="Modify",t[t.Delete=4]="Delete",t[t.Activate=8]="Activate",t[t.All=127]="All"}(p||(p={})),function(t){t[t.None=0]="None",t[t.Ascending=1]="Ascending",t[t.Descending=2]="Descending"}(m||(m={}));class QueryColumn{get id(){return this._id}get sorting(){return this.query?this.query.getColumnSorting(this):this._sorting}set sorting(t){this.query?this.query.setColumnSorting(this,t):this._sorting=t}get sortIndex(){return this.query?this.query.getColumnSortIndex(this):this._sortIndex}set sortIndex(t){this.query?this.query.setColumnSortIndex(this,t):this._sortIndex=t}constructor(t,e=!1){this.query=t,this.justsorted=e,this.enabled=!0,this.params=[],this._isHidden=!1,this.query=t,this._id=n.generateId("col"),this.caption="",this._sorting=m.None,this._sortIndex=-1,this.expr=new Expression(this),this.blockId="",this.justsorted=e}getModel(){return this.query.getModel()}getQuery(){return this.query}isReadOnly(){return!1}isJustSorted(){return this.justsorted}setReadOnly(t){}isHidden(){return this._isHidden}setHidden(t){this._isHidden=t}getDataType(){if(this.expr.dataType===t.Unknown){let e=null;if(this.expr.func){if("COUNT"==this.expr.func||"CNTDST"==this.expr.func)return t.Int64;e=this.expr.args[0].value}else e=this.expr.value;const s=this.query.getModel().getAttributeById(e);if(s)return s.dataType}return this.expr.dataType}loadFromData(t,e){e&&(e.id&&(this._id=e.id),this.caption=e.cptn,void 0!==e.srt&&(this._sorting=e.srt,this._sortIndex=void 0!==e.srtidx?e.srtidx:-1),!1===e.enabled&&(this.enabled=e.enabled),this.expr.loadFromData(t,e.expr),this.blockId=e.blockId,this.displayFormat=e.dfmt,this.groupFooterColumnTemlate=e.gfct,e.hidden&&this.setHidden(!0))}saveToData(){let t={};return t.id=this._id,void 0!==this.caption&&(t.cptn=this.caption),this.sorting!=m.None&&(t.srt=this.sorting,t.srtidx=this.sortIndex),t.expr=this.expr.saveToData(),this.blockId&&(t.blockId=this.blockId),!1===this.enabled&&(t.enabled=this.enabled),t.dfmt=this.displayFormat,t.gfct=this.groupFooterColumnTemlate,this.isHidden()&&(t.hidden=!0),t}fireChangedEvent(){this.query.fireChangedEvent({part:this.justsorted?g.SortingColumns:g.Columns,action:p.Modify,changee:this})}getExpressionIndex(t){return 0}expressionChanged(t,e){}}!function(t){t[t.Unknown=0]="Unknown",t[t.Simple=1]="Simple",t[t.Group=51]="Group"}(f||(f={})),function(t){t[t.EntityAttr=2]="EntityAttr",t[t.Operator=4]="Operator",t[t.Value=8]="Value",t[t.All=14]="All"}(y||(y={}));class Condition{get id(){return this._id}get enabled(){return this._enabled&&(!this.getParent()||this.getParent().enabled)}set enabled(t){this._enabled=t&&(!this.getParent()||this.getParent().enabled),this.conditions&&this.conditions.forEach((e=>{e.enabled=t}))}constructor(t,e){this.query=t,this.linkType=l.All,this.parent=null,this._id=n.generateId("cond"),this.justAdded=!1,this.tag=e||f.Unknown,this.enabled=!0,this.operatorId="",this.blockId="",this.expressions=new Array,this.conditions=new Array}getQuery(){return this.query}getModel(){return this.query.getModel()}getParent(){return this.parent}setParent(t){this.parent=t}getConditions(){return this.conditions}isEmpty(){return 0===this.conditions.length}isGroup(){return this.tag==f.Group||null==this.parent}getLevel(){const t=this.getParent();return t?t.getLevel()+1:0}isReadOnly(){return!1}setReadOnly(t){}isParameterized(){return!1}setParameterized(t){}isInJoin(){return!1}setInJoin(t){}clearConditions(){this.conditions=[]}addCondition(t){return t.setParent(this),this.conditions.push(t)}removeConditionAt(t){this.conditions.splice(t,1)}loadFromData(t,e){if(e){if(this.tag=e.tag,this.tag||(this.tag=!this.parent||this.conditions.length>0?f.Group:f.Simple),void 0!==e.enabled&&(this.enabled=e.enabled),void 0!==e.disabled&&(this.enabled=!e.disabled),this.tag==f.Simple&&(this.operatorId=e.op,e.exprs))for(let s=0;s<e.exprs.length;s++){let i=new Expression(this);i.loadFromData(t,e.exprs[s]),this.expressions.push(i)}this.linkType=e.linking}}saveToData(){let t={};if(t.tag=this.tag,this.enabled||(t.enabled=this.enabled),this.tag==f.Simple){t.op=this.operatorId,t.exprs=[];for(let e=0;e<this.expressions.length;e++)t.exprs.push(this.expressions[e].saveToData())}return this.tag==f.Group&&(t.linking=this.linkType),t}fireChangedEvent(t=y.All){this.query.fireChangedEvent({part:g.Conditions,action:p.Modify,changee:this,condPart:t})}getExpressionIndex(t){return this.expressions.indexOf(t,0)}expressionChanged(t,e){0==t.getIndex()&&t.tag==c.EntityAttribute&&this.tuneOperatorForAttr(t.value)}getOperatorId(){return this.operatorId}setOperatorId(t,e=!1){const s=this.operatorId;if(this.operatorId=t,!e){const e=this.getModel(),i=e.getOperatorById(t),n=this.expressions[0].value,o=e.getAttributeById(n);this.tuneValueExpressions(o,i,o.id,s)}}tuneOperatorForAttr(t){const e=this.getModel(),s=this.expressions[0].value,i=e.getAttributeById(s);if(null!=i){let e=this.getModel().getDefaultOperatorForAttr(i),s=this.operatorId;this.operatorId=e.id,this.tuneValueExpressions(i,e,t,s)}}tuneValueExpressions(e,i,n,o){const r=this.getModel();if(!i)return;let a=this.expressions.length;n&&r.getAttributeById(n);let l=null;if(o&&(l=r.getOperatorById(o)),l&&l.paramCount==i.paramCount){let n=1;for(;n<i.paramCount;){let o=r.getOperand(e,l,n),c=r.getOperand(e,i,n);c.dataType==t.Unknown&&(c.dataType=e.dataType);const g=c.editor&&c.editor.tag!==s.Unknown?c.editor:e.defaultEditor&&e.defaultEditor.tag!==s.Unknown?e.defaultEditor:new EqValueEditor;if(n>=a){var d=this.createValueExpr(c);this.expressions.push(d)}else{var h=this.expressions[n],u=this.createValueExpr(c);this.areCompitableEditors(o.editor,g)&&u.tryCopyValueFrom(h),this.expressions[n]=u}n++}a>n&&this.expressions.splice(n,a-n)}else{this.expressions.splice(1,this.expressions.length-1);for(let s=1;s<i.paramCount;s++){let n=r.getOperand(e,i,s);n.dataType==t.Unknown&&(n.dataType=e.dataType);d=this.createValueExpr(n);this.expressions.push(d)}}}areCompitableEditors(t,e){return e.tag==t.tag&&e.resType==t.resType}addExpressionByOperand(t,e=null){let s=this.createValueExpr(t,e);return this.expressions.push(s),s}createValueExpr(t,e=null){let s=null==e,i=e||t.defValue,n=e||t.defText,o=new Expression(this);if(t.kind===h.Query)o.tag=c.Query,o.dataType=t.dataType,o.kind=t.kind,o.setContent(i,n,!0);else if(t.kind===h.Attribute){if(!s){let e=this.getModel().getFirstAttributeByFilter((e=>1==e.useInConditions&&(!t.dataType||e.dataType==t.dataType)));i=e?e.id:null}o.tag=c.EntityAttribute,o.kind=t.kind,o.dataType=t.dataType,o.setContent(i,n,!0)}else s&&(i=t.defValue&&""!=t.defValue?t.defValue:t.editor&&t.editor.defValue?t.editor.defValue:"",t.editor&&(n=t.editor.getValueText(i))),o.tag=c.Constant,o.dataType=t.dataType,o.kind=t.kind,o.setContent(i,n,!0),o._isDefaultValue=s;return o}}class Tree{constructor(t=null){this.childs=[],this.value=null,this.parent=null,t&&(Array.isArray(t)?(this.value=t[0],t.length>1&&this.addChild(new Tree(t.slice(1)))):t instanceof Tree?(this.value=t.value,this.childs=t.childs):this.value=t)}contains(t){if(this.value===t)return!0;for(let e of this.childs)if(e.contains(t))return!0;return!1}findNode(t){if(this.value===t)return this;for(let e of this.childs){let s=e.findNode(t);if(s)return s}return null}addChild(t){t.parent=this,this.childs.push(t)}setParents(){for(let t of this.childs)t.parent=this,t.setParents()}}class InvalidQueryError extends Error{constructor(t){super(t),"function"==typeof Error.captureStackTrace&&Error.captureStackTrace.apply(this,[InvalidQueryError]),this.name="InvalidQueryError"}}class Query{isModified(){return this._isModified}resetModified(){this._isModified=!1}get enableAggregation(){return this._enableAggregation}set enableAggregation(t){const e=this._enableAggregation;this._enableAggregation=t,!e&&t&&(this.processQueryForAggregation(),this.columns.filter((t=>t.enabled&&t.expr.tag==c.AggregateFunction))),this._enableAggregation||this.aggrSettings.clear()}constructor(t,e,s){this.extraData={},this.innerData={},this.isNewbie=!0,this._isModified=!1,this._enableAggregation=!1,this.parentQuery=null,this.drillDowns=[],this.syncSortOrderWithColumnsOrder=!0,s&&(this.context=s.context,this.context&&(this.syncSortOrderWithColumnsOrder=this.context.options.syncSortOrderWithColumnsOrder)),this.eventEmitter=new EventEmitter(this),this.root=new Condition(this,f.Group),this.extraConditions=new Condition(this,f.Group),this.columns=new Array,this.sortedColumns=new Array,this.id||this.regenerateId(),this.setDefaultName(),this.description="",this.model=t||new DataModel,e&&this.loadFromData(e),this.attributeExprTag=s&&s.attrTag||c.EntityAttribute,this.clientListRequestHandler=s?s.clientListRequestHandler:new Array,this.serverListRequestHandler=s?s.serverListRequestHandler:new Array,this.timezoneOffset=(new Date).getTimezoneOffset(),this.aggrSettings=new AggregationSettings(this),s&&(this.parentQuery=s.parent),this.addChangedCallback((t=>{t.data&&(t.data.part&g.Columns)>0&&!t.data.aggregation&&this._enableAggregation&&this.updateAggregationSettings()&&this.fireChangedEvent({part:g.Aggregation})}))}updateAggregationSettings(){let t=!1;const e=this.getAggregationSettings();for(let s=e.groups.length-1;s>=0;s--){const i=e.groups[s];for(let e=i.columns.length-1;e>=0;e--){const s=i.columns[e];this.columns.find((t=>t.id===s))||(i.columns.splice(e,1),t=!0)}0==i.columns.length&&e.groups.splice(s,1)}const s=e.getAggregates();for(let e=s.length-1;e>=0;e--){const i=s[e];this.columns.find((t=>t.id===i.colId))||(s.splice(e,1),t=!0)}return t}createSubQuery(){return new Query(this.model,null,{parent:this,context:this.context})}useAggregation(t,e=!1){if(this.aggrSettings.clear(),t(this.aggrSettings),this.enableAggregation)this.processQueryForAggregation(e);else if(!e)return void console.warn("Aggregation is turned off. Turn it on with query.enableAggregation = true")}useDefaultAggregation(){this._enableAggregation=!0,this.useAggregation((e=>{const s=this.columns.filter((t=>t.enabled&&t.expr.tag==c.AggregateFunction));if(s.length){const t=this.columns.filter((t=>t.enabled&&t.expr.tag==c.EntityAttribute)),i=[];for(const t of s)i.push({id:t.id,func:t.expr.func}),this.changeColumnType(t,c.EntityAttribute);for(const t of i)e.addAggregateColumn(t.id,t.func);for(const s of t)e.addGroup({columns:[s.id],name:s.caption});e.addGrandTotals(),this.fireChangedEvent({part:g.Columns,wasModified:!1})}else{const s=this.getColumns().filter((e=>e.enabled&&e.expr.tag==c.EntityAttribute&&this.model.getAttributeById(e.expr.value).dataType===t.Currency))[0],i=this.getColumns().filter((e=>e.enabled&&e.expr.tag==c.EntityAttribute&&this.model.getAttributeById(e.expr.value).dataType===t.String))[0];if(!s&&!e.hasAggregates()||!i)return;e.addGrandTotals().addAggregateColumn(s.id,"SUM").addGroup({columns:[i.id],name:"Default"})}}))}processQueryForAggregation(t=!1){const e=this.getAggregationSettings().getGroups();if(e.length>0){const s=e[e.length-1].columns;let i=[],n=[];for(const t of this.getColumns())s.indexOf(t.id)>=0?i.push(t):this.getColumnSorting(t)!=m.None&&n.push(t);let o=0;i.forEach((t=>{this.getColumnSorting(t)==m.None&&this.setColumnSorting(t,m.Ascending),this.setColumnSortIndex(t,o++)})),n.forEach((t=>{this.setColumnSortIndex(t,o++)})),t||this.fireChangedEvent({part:g.Columns,aggregation:!0,wasModified:!1})}}getAggregationSettings(){return this.aggrSettings}getColumnIds(t,e){return e=e||t,this.columns.slice(t,e-t+1).map((t=>t.id))}validateColumns(t){const e=this.columns.filter((t=>t.enabled)).map((t=>t.id));let s=-1;for(const i of t){const t=e.indexOf(i);if(t<0)return!1;if(s>t)return!1;s=t}return!0}validateAggregate(t,e){const s=this.columns.filter((e=>e.enabled&&e.id===t))[0],i=this.model.findAggrFunctionById(e);return!(!i||!s||i.appliedTypes.indexOf(s.expr.dataType)<0)}isEx(){return!1}reset(t=!0){t&&this.clear(),this.regenerateId(),this.setDefaultName(),this._isModified=!1,this.isNewbie=!0}hasEnabledAggrColumns(){return this.columns.filter((t=>t.enabled&&t.expr.tag===c.AggregateFunction)).length>0}setDefaultName(){return this.setName(o.getText("NewQueryName")),this.getName()}validate(t){t=t||{};const e="EntityAttribute isn't declared in the model: ";if(!this.model)throw new InvalidQueryError("Model is not declared");if(this.columns)for(let t of this.columns)if(t.expr.tag==c.EntityAttribute||t.expr.tag===c.ParentEntityAttribute){if(!this.model.getAttributeById(t.expr.value))throw new InvalidQueryError(e+t.expr.value)}else if(t.expr.tag===c.AggregateFunction){if(!this.model.getAttributeById(t.expr.args[0].value))throw new InvalidQueryError(e+t.expr.args[0].value)}else if(t.expr.tag===c.Unknown)throw new InvalidQueryError("The expression has wrond tag: "+t.expr.tag);this.root&&this.root.getConditions()&&this.validateConditionGroup(this.root,t)}getAggregatedColumns(){return this.getColumns().filter((t=>t.enabled&&t.expr.tag===c.AggregateFunction))}tryValidate(t){try{return this.validate(t),!0}catch(t){if(t instanceof InvalidQueryError)return!1;throw t}}validateConditionGroup(t,e){if(t.isGroup())for(let s of t.getConditions())s.enabled&&this.validateConditionGroup(s,e);else if(t.expressions[0].tag===c.EntityAttribute){const s=t.expressions[0].value;if(!this.model.getAttributeById(s))throw new InvalidQueryError("EntityAttribute isn't declared in the model: "+s);if(!e.checkExpressions)return;for(let e=1;e<t.expressions.length;e++){const s=t.expressions[e];if(s.tag===c.Constant&&n.isNumericType(s.dataType)){if(!s.value)continue;let e=[];e=s.kind===h.List?s.value.split(/\s*,\s*/):[s.value];for(let i of e){const e=+i;if(isNaN(e))throw new InvalidQueryError("Expression constant is NaN in condition:"+t.id);if(n.isIntType(s.dataType)&&e!=parseInt(i,10))throw new InvalidQueryError("Expression constant is wrong interger in condition: "+t.id)}}}}}loadFromDataOrJson(t,e){t&&("string"==typeof t?this.loadFromJson(t,e):this.loadFromData(t,e))}loadFromJson(t,e){let s=JSON.parse(t);this.loadFromData(s,e)}loadFromData(t,e){e=n.assign({changeStatus:!0,validate:!0},e||{});let s=!1;if(this.clear(),this.clearDrillDowns(),t){if(this.id=t.id,this.root.loadFromData(this.model,t.root),t.root&&t.root.conds)for(let e=0;e<t.root.conds.length;e++){const s=t.root.conds[e];if(s.conds&&!this.isEx()){console.error("Community version doesn't support working with groups.");continue}const i=this.createCondition();i.loadFromData(this.model,s),this.root.addCondition(i)}if(this.name=t.name,t.desc&&(this.description=t.desc),this.sortedColumns=[],t.justsortcols)for(let e=0;e<t.justsortcols.length;e++){let s=this.createColumn(!0);s.loadFromData(this.model,t.justsortcols[e]),this.addColumnToSorted(s)}if(t.cols)for(let e=0;e<t.cols.length;e++){let s=this.createColumn();s.loadFromData(this.model,t.cols[e]),this.columns.push(s),s._sorting!=m.None&&this.addColumnToSorted(s)}if(this.sortedColumns.sort(((t,e)=>t._sortIndex-e._sortIndex)),this.fixupSortingIndices(),t.extraData&&(this.extraData=t.extraData),this.innerData=t.innerData||this.innerData,this.innerData&&this.innerData.aggr&&(this._enableAggregation=this.innerData.aggr.enabled||!1,this.useAggregation((t=>{t.loadFromData(this.innerData.aggr)}),!0)),t.dds&&t.dds.length)for(let e of t.dds){this.addDrillDown().loadFromData(e)}}this._enableAggregation&&this.updateAggregationSettings(),s=!0,e.changeStatus&&(this.isNewbie=!1,this._isModified=!1),e.validate&&this.validate()}addDrillDown(){const t=this.context.createQuery();return t.parentQuery=this,this.drillDowns.push(t),t}getDrillDowns(){return this.drillDowns}getParentQuery(){return this.parentQuery}findColumnById(t){for(let e of this.columns)if(e.id===t)return e;return null}getModel(){return this.model}setModel(t){this.model=t}loadModelData(t){this.model.setData(t)}toJSON(){return JSON.stringify(this.toJSONData())}toJSONData(){this.fixupSortingIndices();let t={modelId:this.model?this.model.getId():null,modelName:this.model?this.model.getName():null};t.id=this.id,t.name=this.name,this.description&&(t.desc=this.description),t.cols=[];for(let e=0;e<this.columns.length;e++)t.cols.push(this.columns[e].saveToData());t.justsortcols=[],this.sortedColumns.forEach((e=>{e.isJustSorted()&&t.justsortcols.push(e.saveToData())})),this.extraData&&(t.extraData=this.extraData),this.innerData&&(t.innerData=this.innerData,t.innerData.aggr=this.aggrSettings.saveToData(),t.innerData.aggr.enabled=this._enableAggregation);const rootCondToData=t=>{const e=t.saveToData();e.conds=[];const s=t.getConditions();for(let t=0;t<s.length;t++)!s[t].isGroup()||this.isEx()?e.conds.push(s[t].saveToData()):console.error("Community version doesn't support working with groups.");return e};if(t.root=rootCondToData(this.root),t.extraConds=rootCondToData(this.extraConditions),this.drillDowns.length>0){t.dds=[];for(let e of this.drillDowns)t.dds.push(e.toJSONData())}return t.timezoneOffset=this.timezoneOffset,t.locale=o.getCurrentLocale(),t}isEmptyConditions(){return this.root.isEmpty()}isEmptyColumns(){return!this.columns||0===this.columns.length}isEmpty(){return this.isEmptyColumns()&&this.isEmptyConditions()}clear(){this._enableAggregation=!1,this.aggrSettings.clear(),this.clearColumns(),this.clearConditions(),this.clearExtraConditions(),this.innerData={},this.extraData={}}clearColumns(){this.columns=[],this.sortedColumns=[]}clearConditions(){this.root.clearConditions(),this.root.linkType=l.All,this.root.enabled=!0}clearExtraConditions(){this.extraConditions.clearConditions()}clearDrillDowns(){this.drillDowns=[]}getId(){return this.id}setId(t){this.id=t}regenerateId(){this.id=n.generateId("quer")}getName(){return this.name}setName(t){this.name=t}getDescription(){return this.description?this.description:""}setDescription(t){this.description=t}getColumns(){return this.columns}getUsedInTotalsColumns(){if(0===this.getAggregatedColumns().length)return[];const t=this.getColumns().filter((t=>t.enabled&&t.expr.tag===c.EntityAttribute));return t.length&&t.pop(),t}addColumnToSorted(t){const e=JSON.stringify(t.expr.saveToData());let s=!0;this.sortedColumns.forEach((t=>{JSON.stringify(t.expr.saveToData())===e&&(s=!1)})),s&&this.sortedColumns.push(t)}getJustSortedColumns(){return this.sortedColumns.filter((t=>t.isJustSorted()))}getSortedColumns(){return this.sortedColumns}getColumnSortIndex(t){return this.sortedColumns.indexOf(t)}setColumnSortIndex(t,e){if(e<0)return;let s=this.getColumnSortIndex(t);s<0&&(this.addColumnToSorted(t),s=this.sortedColumns.length-1),n.moveArrayItem(this.sortedColumns,s,e),this.fixupSortingIndices()}getColumnSorting(t){return this.getColumnSortIndex(t)>=0?t._sorting!=m.None?t._sorting:m.Ascending:m.None}setColumnSorting(t,e){const s=this.getColumnSortIndex(t);t._sorting=e,s>=0?e==m.None&&(n.removeArrayItem(this.sortedColumns,t),this.fixupSortingIndices()):e!=m.None&&(this.addColumnToSorted(t),this.fixupSortingIndices()),this.adjustColumnsSorting()}fixupSortingIndices(){this.sortedColumns.forEach(((t,e)=>{t._sortIndex=e}))}adjustColumnsSorting(){if(!this.syncSortOrderWithColumnsOrder)return;if(this.getJustSortedColumns().length>0)return;let t=0;this.columns.forEach((e=>{if(e.sorting!=m.None){const s=this.getColumnSortIndex(e);s>=0&&(n.moveArrayItem(this.sortedColumns,s,t),t++)}})),this.fixupSortingIndices()}createColumn(t=!1){return new QueryColumn(this,t)}getColumnById(t){return n.findItemById(this.columns,t)}addColumn(e,s=!1){let i;const o=e.justsorted||e.column&&e.column.isJustSorted();if(e.column)i=e.column;else{let s;if(i=this.createColumn(e.justsorted),e.attribute)s=e.attribute;else if(e.attributeId){if(s=this.model.getAttributeById(e.attributeId),!s)throw new Error(`Incorrect attribute id (${e.attributeId}): addColumn`)}else if(void 0===e.constValue&&!e.customSql)throw new Error("Not enought data for addColumn operation. One of the following options must be defined: attribute, attributeId, constValue or customSlq");if(s){let t=o?s.useInSorting:s.useInResult;if(!t&&(s.lookupAttr&&(s=this.model.getAttributeById(s.lookupAttr),t=o?s.useInSorting:s.useInResult),!t))throw new Error("Can't use this attribute for a column")}if(e.aggrFuncId&&e.customSql&&console.warn("Column cannot be created using aggrFuncId and customSql at the same time. cusomSql will be used."),void 0!==e.constValue)i.expr.tag=c.Constant,i.expr.setValue(e.constValue),i.expr.kind=h.Scalar,i.expr.dataType=e.constType||t.String;else if(e.customSql)i.caption="Custom SQL Column",i.expr.tag=c.CustomSql,i.expr.sql=e.customSql,i.expr.kind=h.Query,i.expr.dataType=t.Unknown,i.expr.baseAttrId=e.attributeId,this.context.options.allowCustomExpressions||(i.enabled=!1);else if(e.aggrFuncId){const t=e.aggrFuncId;i.expr.tag=c.AggregateFunction,i.expr.func=e.aggrFuncId,i.expr.kind=h.Scalar,i.expr.dataType="COUNT"==t||"CNTDST"==t?4:s.dataType,i.expr.distinct=!1;const n=new Expression(i);n.setValue(s.id,!0),n.tag=c.EntityAttribute,n.kind=h.Attribute,n.dataType=s.dataType,i.expr.args.push(n)}else i.expr.setValue(s.id,!0),i.expr.tag=c.EntityAttribute,i.expr.kind=h.Attribute,i.expr.dataType=s.dataType,i.params.concat(s.params);i.caption=e.caption||this.context.getDefaultColumnCaption(i),i._sorting=e.sorting||m.None,i._sortIndex=e.sortIndex||-1,i.enabled=n.getIfDefined(e.enabled,!0),i.setReadOnly(n.getIfDefined(e.readonly,!1))}return o||(e.index&&e.index>=0&&e.index<this.columns.length?this.columns.splice(e.index,0,i):this.columns.push(i)),this.setColumnSorting(i,i._sorting),s||this.fireColumnsChangedEvent(p.Add,i,o),i}addColumnObj(t,e,s){let i=this.columns;void 0===t.length?("number"==typeof e?i.splice(e,0,t):i.push(t),t.sorting!=m.None&&this.addColumnToSorted(t),this.fixupSortingIndices()):("number"==typeof e?i.push.apply(i,[e,0].concat(t)):i.push.apply(i,[].concat(t)),t.forEach((t=>{t.sorting!=m.None&&this.addColumnToSorted(t)})),this.fixupSortingIndices())}changeColumnType(e,s,i){if(!e.isJustSorted()){if(i=i||{},s===c.AggregateFunction){if(!i.funcId)throw Error('"funcId" argument is not defined');if(e.expr.tag==c.AggregateFunction)return void(e.expr.func=i.funcId);const t=new Expression(e);t.tag=c.AggregateFunction,t.func=i.funcId,t.distinct=!1,t.dataType="COUNT"==i.funcId||"CNTDST"==i.funcId?4:e.expr.dataType;const s=new Expression(e);s.loadFromData(this.model,e.expr.saveToData()),t.args.push(s),e.expr=t}else if(s===c.CustomSql){const s=e.expr.tag==c.AggregateFunction?e.expr.args[0].value:e.expr.value;let i="";this.model&&(i=this.model.getAttributeById(s).expr);const n=new Expression(e);n.tag=c.CustomSql,n.dataType=t.String,n.sql=i,n.baseAttrId=s,e.expr=n}else if(s===c.EntityAttribute){if(e.expr.tag===c.EntityAttribute||e.expr.tag===c.ParentEntityAttribute)return;const t=e.expr.tag==c.AggregateFunction?e.expr.args[0].value:e.expr.baseAttrId,s=t?this.model.getAttributeById(t):this.model.getFirstUICAttr(),i=new Expression(e);i.tag=c.EntityAttribute,i.dataType=s.dataType,i.setValue(s.id,!0),e.expr=i}e.caption=this.context.getDefaultColumnCaption(e)}}moveColumn(t,e){const s=this.getColumns();n.moveArrayItem(s,t,e),this.adjustColumnsSorting()}removeColumn(t){n.removeArrayItem(this.columns,t),n.removeArrayItem(this.sortedColumns,t)}addConditionGroup(t,e=!0){return console.error("Community version doesn't support working with groups."),null}addExtraConditionGroup(t,e=!0){return console.error("Community version doesn't support working with groups."),null}createCondition(t=f.Simple){return new Condition(this,t)}addSimpleCondition(t){let e=t.parent||this.getRootCondition(),s=this.getModel();if(!s)return null;if(!t.attribute&&!t.attributeId)throw new Error("Either `attribute` or `attributeId` parameter must have a value");if(!t.attribute&&(t.attribute=s.getAttributeById(t.attributeId),!t.attribute))throw new Error("Could not find this attribute: "+t.attributeId);!t.operator&&t.operatorId&&(t.operator=s.getOperatorById(t.operatorId)),t.operator||(t.operator=s.getDefaultOperatorForAttr(t.attribute));let i=this.createSimpleConditionObject(t.attribute,t.operator,t.value);return e.addCondition(i),i.enabled=n.getIfDefined(t.enabled,!0),i.setReadOnly(n.getIfDefined(t.readonly,!1)),i}addSimpleExtraCondition(t){return t.parent=t.parent||this.extraConditions,this.addSimpleCondition(t)}createSimpleConditionObject(t,e,s){if(!t||!t.useInConditions){throw"Can't add a condition with such attribute: "+(t?t.caption:"NULL")}let i=this.createCondition(f.Simple);i.setOperatorId(e.id,!0);let o=new Expression(i);o.setValue(t.id,!0),o.tag=this.attributeExprTag,o.kind=h.Attribute,o.dataType=t.dataType,i.expressions.push(o);let r=this.getModel();const a=e.paramCount;let l=n.fillArray(new Array(a-1),null);null!=s&&(Array.isArray(s)?n.copyArrayTo(s,l):a>0&&(l[0]=s));for(var d=l.length,u=0;u<d;u++){let s=r.getOperand(t,e,u+1);i.addExpressionByOperand(s,l[u])}return i}removeColumns(t,e){let s=t.filter((t=>t.isJustSorted())),i=t.filter((t=>!t.isJustSorted()));function removeFromArray(t,e){let s=e.length;for(let i=0;i<s;i++){let s=t.indexOf(e[i]);s>=0&&t.splice(s,1)}}i.length>0&&(removeFromArray(this.getColumns(),i),removeFromArray(this.sortedColumns,i)),s.length>0&&removeFromArray(this.sortedColumns,s),this.fixupSortingIndices()}fireProcessEvent(t){this.eventEmitter.fire("query.process",t)}fireChangedEvent(t,e,s){t=t||{part:g.All},void 0===e&&void 0===s||(t.postpone=e||0,t.wasModified=s,console.warn("Method with 'postpone' and 'wasModified' args is deprecated. Pass params in data object")),this._isModified=void 0===t.wasModified||t.wasModified;const i=t||{part:g.All};this.eventEmitter.fire("query.change",i,t.postpone||0)}fireColumnsChangedEvent(t,e,s=!1){this.fireChangedEvent({part:s?g.SortingColumns:g.Columns,action:t,changee:e})}fireConditionsChangedEvent(t,e){this.fireChangedEvent({part:g.Conditions,action:t,changee:e})}runThroughConditions(t){let processGroup=function(e){for(let s=0;s<e.getConditions().length;s++){let i=e.getConditions()[s];i.isGroup()?processGroup(i):t&&t(i)}};processGroup(this.getRootCondition())}getOneValueForAttr(t){let e=null;return this.runThroughConditions((function(s){if(s.enabled){const i=s.expressions[0],n=s.getOperatorId();i.value!=t||!s.expressions[1]||"Equal"!=n&&"InList"!=n&&"StartsWith"!=n||(e=s.expressions[1].value)}})),e}getRootCondition(){return this.root}addProcessCallback(t){return this.eventEmitter.subscribe("query.process",t)}removeProcessCallback(t){this.eventEmitter.unsubscribe("query.process",t)}addChangedCallback(t){return this.eventEmitter.subscribe("query.change",t)}removeChangedCallback(t){this.eventEmitter.unsubscribe("query.change",t)}getConditionsText(){const t=this.getModel();if(!t)return"";const getConditionGroupText=e=>{let s,i,n="",r="Conj"+d.linkTypeToStr(e.linkType),a=o.getText(r);for(i=0;i<e.getConditions().length;i++){s="";let r=e.getConditions()[i];if(r.enabled||void 0===r.enabled)if(r.isGroup())s=getConditionGroupText(r),s&&(s="("+s+")");else{let e=r.getOperatorId(),i=t.getOperatorById(e),n=d.parseOperatorFormat(i),a=n.length;for(let e=0;e<a;e++){let i=n[e],a=i.text;if("expression"==i.type){let e=r.expressions[i.index];if(e.kind==h.Attribute||e.tag==c.EntityAttribute){let s=t.getAttributeById(e.value);null!=s&&(a=t.getAttributeText(s,"{entity} {attr}"))}if(e.kind==h.Query)a=": ("+e.subQuery.getConditionsText()+")";else if(a=e.getText(),this.model.isDateMacro(a)||this.model.isTimeMacro(a)){const t=a.substring(3,a.length-2);a=o.getText(t)||a}}e>0&&(s+=" "),s+=a}}s&&(i>0&&n&&(n+=" "+a+" "),n+=s)}return e.linkType!=l.None&&e.linkType!=l.NotAll||(n='not ( " + result + " )'),n};return getConditionGroupText(this.getRootCondition())}getConditionsTextAsHtml(){const e=this.getModel();if(!e)return'<div class="eqjs-query-text"></div>';const quoteExprText=e=>{if(e.kind==h.Query)return`&lt;${e.getText()}&gt;`;if(e.kind==h.List)return`[${e.getText()}]`;if(e.dataType==t.String||e.dataType==t.Memo||e.dataType==t.FixedChar)return`&quot;${e.getText()}&quot;`;{let t=e.getText();if(this.model.isDateMacro(t)||this.model.isTimeMacro(t)){const e=t.substring(3,t.length-2);t=o.getText(e)||t}return t}},getConditionGroupText=t=>{let s,i,n="",r="Conj"+d.linkTypeToStr(t.linkType),a=`<span class="eqjs-query-text-conj">${o.getText(r)}</span>`;for(i=0;i<t.getConditions().length;i++){s="";let o=t.getConditions()[i];if(o.enabled||void 0===o.enabled)if(o.isGroup())s=getConditionGroupText(o),s&&(s="("+s+")");else{let t=o.getOperatorId(),i=e.getOperatorById(t),n=d.parseOperatorFormat(i),r=n.length;for(let t=0;t<r;t++){let i=n[t],r=i.text;if("expression"==i.type){let t=o.expressions[i.index];if(t.kind==h.Attribute||t.tag==c.EntityAttribute){let s=e.getAttributeById(t.value);r=`<span class="eqjs-query-text-attr">${e.getAttributeText(s,"{entity} {attr}")}</span>`}else r=`<span class="eqjs-query-text-expr">${quoteExprText(t)}</span>`}else"operator"==i.type&&(r=`<span class="eqjs-query-text-op">${r}</span>`);t>0&&(s+=" "),s+=r}}s&&(i>0&&n&&(n+=" "+a+" "),n+=s)}return t.linkType!=l.None&&t.linkType!=l.NotAll||(n='<span class="eqjs-query-text-conj">not</span> ( '+n+" )"),n};return`<div class="eqjs-query-text">${getConditionGroupText(this.getRootCondition())}</div>`}getEntitiesInQuery(){if(this.model.id!==this.id)throw Error("Model mithmatch");const t=[],e=this.getColumns();for(let s of e)s.enabled&&this.addEntityByExpression(t,s.expr);const s=this.getRootCondition();return this.fillEntitiesByCondtionGroup(t,s),t}fillEntitiesByCondtionGroup(t,e){for(let s of e.getConditions())if(s.isGroup())this.fillEntitiesByCondtionGroup(t,s);else for(let e of s.expressions)if(this.addEntityByExpression(t,e),e.args)for(let s of e.args)this.addEntityByExpression(t,s)}addEntityByExpression(t,e){if(e.tag!==c.EntityAttribute)return;const s=e.baseAttrId||e.value;if(s){const e=this.model.getAttributeById(s);e&&e.entity&&n.indexOfArrayItem(t,e.entity)<0&&t.push(e.entity)}}buildQueryPath(){let t=this.model.getMainEntity()||this.model.rootEntity;const e=this.createTreeNodeFromEntity(t);return e.setParents(),e}createTreeNodeFromEntity(t){let e=new Tree(t);for(let s of t.subEntities)e.addChild(this.createTreeNodeFromEntity(s));return e}}class BrowserQueryStorage{constructor(t){this.context=t,console.warn("BrowserQueryStorage is used for managing queries")}init(t){let e="eq";t&&t.keyPrefix&&(e=t.keyPrefix),this.queryListKey=e+"-querylist",this.queryKeyPrefix=e}getQueryList(t){return new Promise(((t,e)=>{try{const e=localStorage.getItem(this.queryListKey);e&&t(JSON.parse(e)),t([])}catch(t){e(t)}}))}newQuery(t){return new Promise(((e,s)=>{const i=new Query(this.context.getModel(),null,{context:this.context});i.reset(),i.setDefaultName(),t&&(t.query&&i.loadFromData(t.query.toJSONData()),t.queryId&&i.setId(t.queryId),t.name&&i.setName(t.name),t.description&&i.setDescription(t.description)),this._saveQuery(i),e(i.toJSONData())}))}loadQuery(t){return new Promise(((e,s)=>{try{const s=localStorage.getItem(this.queryKeyPrefix+"-"+t.queryId);throw s&&e(JSON.parse(s)),new Error("Query is not found: "+t.queryId)}catch(t){s(t)}}))}saveQuery(t){return new Promise(((e,s)=>{try{t.modelId||this.context.getModel().getId();const s=t.query||this.context.getQuery();this._saveQuery(s),e(null)}catch(t){s(t)}}))}_saveQuery(t){let e=[];const s=localStorage.getItem(this.queryListKey);s&&(e=JSON.parse(s));let i=n.findItemById(e,t.getId());i||(i={id:t.getId(),name:t.getName(),text:t.getDescription()},e.push(i)),i.name=t.getName(),i.text=t.getDescription(),localStorage.setItem(this.queryListKey,JSON.stringify(e)),localStorage.setItem(this.queryKeyPrefix+"-"+t.getId(),t.toJSON())}removeQuery(t){return new Promise(((e,s)=>{try{t.modelId||this.context.getModel().getId();const s=t.queryId||this.context.getQuery().getId();let i=[];const n=localStorage.getItem(this.queryListKey);n&&(i=JSON.parse(n)),i=i.filter((t=>t.id!=s)),localStorage.setItem(this.queryListKey,JSON.stringify(i)),localStorage.removeItem(this.queryKeyPrefix+"-"+s),e()}catch(t){s(t)}}))}}class EqModelLoader{constructor(t){this.context=t,this.modelPromise=null}init(t){}getContext(){return this.context}createModelLoadingPromise(){this.modelPromise=new Promise(((t,e)=>{this.modelLoadingResolveFunc=t,this.modelLoadingRejectFunc=e}))}getModelPromise(){return this.modelPromise||Promise.reject(new Error("Model has been never loaded."))}startModelLoading(t){return this.createModelLoadingPromise(),this.sendLoadModelRequest(t),this.modelPromise}}class EqServerModelLoader extends EqModelLoader{constructor(t){super(t)}init(){}sendLoadModelRequest(t){const e=this.getContext(),s=e.getServices().getHttpClient(),i=e.resolveEndpoint("GetModel",{modelId:t.modelId});s.get(i).then((t=>{t.model||this.modelLoadingRejectFunc(new Error('Wrong response format for "GetModel" request')),this.modelLoadingResolveFunc(t.model)})).catch((t=>{this.modelLoadingRejectFunc(t)}))}}class EqServerDataFetcher{constructor(t){this.context=t}fetchData(t){const e=t.query||this.context.getQuery(),s=e.getId();let i={options:t.options};void 0!==t.queryId?i.queryId=t.queryId:i.query=e.toJSONData(),t.debug&&(i.debug=t.debug),t.chunk&&(i.chunk=t.chunk),t.data&&(i.data=t.data),void 0!==t.aux&&(i.aux=t.aux);const n=this.context.resolveEndpoint("FetchData",{modelId:e.getModel().getId(),queryId:s});return this.context.getServices().getHttpClient().post(n,i).then((t=>t))}}class EqServerQuerySynchronizer{constructor(t){this.context=t}syncQuery(t){const e=(t=t||{}).query||this.context.getQuery(),s=t.options||{};let i={query:e.toJSONData(),options:s};t.data&&(i.data=t.data);const n=this.context.resolveEndpoint("SyncQuery",{modelId:e.getModel().getId(),queryId:e.getId()});return this.context.getServices().getHttpClient().post(n,i).then((t=>t))}}class EqServerValueListResolver{constructor(t){this.context=t}loadValueList(t){const e=t.modelId||this.context.getModel().getId(),s=n.assign({modelId:e},t.params).editorId,i=this.context.getServices().getHttpClient(),o=this.context.resolveEndpoint("GetValueList",{modelId:e,listId:s});let r={};return t&&t.params&&t.params.queryParams&&(r=t.params.queryParams),i.get(o,{queryParams:r}).then((t=>{if(t&&t.values)return t.values;throw new Error('Wrong response format. No "values" property')}))}}class EqQueryFileLoader{constructor(t){this.context=t}getQueryFile(t){const e=t.query||this.context.getQuery(),s=this.context.resolveEndpoint("GetQueryFile",{modelId:e.getModel().getId(),format:t.format||"xml"}),i=this.context.getServices().getHttpClient().post(s,{query:e.toJSONData()}),n=i.getRequest();return i.then((e=>{const s=new Blob([e]),i=n.getXMLHttpRequest().getResponseHeader("Content-Disposition");let o=i?i.match(/filename="(.*)"/)[1]:"query.json";if(t.fileName&&(o=t.fileName+o.substring(o.lastIndexOf("."))),window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(s,o);else{const t=document.createElement("a");document.body.appendChild(t),t.style.display="none",t.href=window.URL.createObjectURL(s),t.download=o,t.click(),window.URL.revokeObjectURL(t.href),document.body.removeChild(t)}}))}uploadQueryFile(t){const e=(t=t||{}).query||this.context.getQuery(),s=this.context.resolveEndpoint("UploadQueryFile",{modelId:e.getModel().getId()});return this.context.getServices().getHttpClient().post(s,t.data,{dataType:"form-data"}).then((t=>t.query))}}class EqAggregatesContainer{constructor(t){this.context=t,this.levels={}}getAggregateData(t,e){return new Promise(((s,i)=>{const processFunc=t=>{const n=this.groupKeyToStr(e),o=t.get(n);o?s(o):i(`Can't find data for ${n}`)},n=this.getLevelDesc(t,!1);n&&(n.data?processFunc(n.data):n.receivedCallbacks.push(processFunc))}))}setAggregateData(t,e){const s=this.getLevelDesc(t,!0);if(s.data=e,s.receivedCallbacks)for(const t of s.receivedCallbacks)t(s.data);s.receivedCallbacks=[]}updateAggregateData(t,e,s){const i=this.getLevelDesc(t,!0),n=this.groupKeyToStr(e);i.data.set(n,s)}groupKeyToStr(t){return JSON.stringify(t)}getLevelDesc(t,e){let s=this.levels[t];return!s&&e&&(s={receivedCallbacks:[],data:new Map},this.levels[t]=s),s}clear(){this.levels={}}}class DefaultAggregatesCalculator{constructor(t){this.context=t,this.aggrs=null}getAggrContainer(){return this.aggrs}calculate(t){console.warn("Grand totals and sub totals aggregation calculation can be used in Enterprise version only"),(t=t||{}).maxLevel=t.maxLevel>=0?t.maxLevel:0,this.aggrs=new EqAggregatesContainer(this.context);const e=this.context.createQuery();e.loadFromData(this.context.getQuery().toJSONData());const s=this.context.getQuery().getAggregationSettings(),i=s.getAggregates().map((t=>t.colId)),n=e.getColumns().filter((t=>i.indexOf(t.id)<0));for(let t=0;t<n.length;t++)n[t].enabled=!1;s.hasGrandTotals()&&(this.aggrs.setAggregateData(0,new Map),t.resultObtained&&t.resultObtained({},0));const o=s.getGroups();for(let e=1;e<=o.length&&e<=t.maxLevel;e++)this.aggrs.setAggregateData(e,new Map),t.resultObtained&&t.resultObtained({},e);return Promise.resolve()}needRecalculation(){return!0}reset(){}}class EqServiceProvider{static getInstance(){return EqServiceProvider._instance||(EqServiceProvider._instance=new EqServiceProvider),EqServiceProvider._instance}constructor(){this.modelLoader=null,this.queryStorage=null,this.querySynchronizer=null,this.dataFetcher=null,this.valueListResolver=null,this.queryFileLoader=null,this.aggrCalculator=null,this.services={},this.httpClient=new HttpClient,this.httpClient.defaultHeaders["x-eqjs-version"]="7.3.0",this.modelResolver=t=>new DataModel,this.modelStorageResolver=null,this.queryResolver=t=>new Query(t.getModel(),null,{context:t}),this.modelLoaderResolver=t=>new EqServerModelLoader(t),this.queryStorageResolver=t=>new BrowserQueryStorage(t),this.querySynchronizerResolver=t=>new EqServerQuerySynchronizer(t),this.vlrResolver=t=>new EqServerValueListResolver(t),this.dataFetcherResolver=t=>new EqServerDataFetcher(t),this.queryFileLoaderResolver=t=>new EqQueryFileLoader(t),this.aggrCalculatoResolver=t=>new DefaultAggregatesCalculator(t)}reset(){this.modelStorage=null,this.modelLoader=null,this.queryStorage=null,this.querySynchronizer=null}getHttpClient(){return this.httpClient}createDataModel(t){if(!this.modelResolver)throw"Model resolver is not defined";return this.modelResolver(t)}createQuery(t){if(!this.queryResolver)throw"Query resolver is not defined";return this.queryResolver(t)}getModelLoader(t){if(!this.modelLoader){if(!this.modelLoaderResolver)throw"ModelLoaderResolver is not defined";this.modelLoader=this.modelLoaderResolver(t)}return this.modelLoader}getModelStorage(t){if(!this.modelStorage){if(!this.modelStorageResolver)throw"ModelStorageResolver is not defined";this.modelStorage=this.modelStorageResolver(t)}return this.modelStorage}getQueryStorage(t){if(!this.queryStorage){if(!this.queryStorageResolver)throw"QueryStorageResolver is not defined";this.queryStorage=this.queryStorageResolver(t)}return this.queryStorage}getQuerySynchronizer(t){if(!this.querySynchronizer){if(!this.querySynchronizerResolver)throw"QuerySynchronizerResolver is not defined";this.querySynchronizer=this.querySynchronizerResolver(t)}return this.querySynchronizer}getDataFetcher(t){if(!this.dataFetcher){if(!this.dataFetcherResolver)throw"DataFetcherResolver is not defined";this.dataFetcher=this.dataFetcherResolver(t)}return this.dataFetcher}getValueListResolver(t){if(!this.valueListResolver){if(!this.vlrResolver)throw"Resolver for ValueListResolver is not defined";this.valueListResolver=this.vlrResolver(t)}return this.valueListResolver}getQueryFileLoader(t){if(!this.queryFileLoader){if(!this.queryFileLoaderResolver)throw"Resolver for QueryFileLoader is not defined";this.queryFileLoader=this.queryFileLoaderResolver(t)}return this.queryFileLoader}getAggregatesCalculator(t){if(!this.aggrCalculator){if(!this.aggrCalculatoResolver)throw"Resolver for AggregatesCalculator is not defined";this.aggrCalculator=this.aggrCalculatoResolver(t)}return this.aggrCalculator}registerDataModelResolver(t){this.modelResolver=t}registerQueryResolver(t){this.queryResolver=t}registerModelLoaderResolver(t){this.modelLoaderResolver=t}registerModelStorageResolver(t){this.modelStorageResolver=t}registerQueryStorageResolver(t){this.queryStorageResolver=t}registerDataFetcherResolver(t){this.dataFetcherResolver=t}registerQuerySyncronizerResolver(t){this.querySynchronizerResolver=t}registerValueListResolver(t){this.vlrResolver=t}registerQueryFileLoaderResolver(t){this.queryFileLoaderResolver=t}registerAggregatesCalculator(t){this.aggrCalculatoResolver=t}registerService(t,e){this.services[t]=e}getService(t){const e=this.services[t];if(e)return e()}}!function(t){t[t.None=0]="None",t[t.Model=1]="Model",t[t.Query=2]="Query",t[t.Result=4]="Result",t[t.Statement=8]="Statement",t[t.QueryStatus=16]="QueryStatus",t[t.All=65535]="All"}(C||(C={}));var v,x,b={offset:0,limit:0,needTotal:!1};class EqServerExporter{constructor(t){this.context=t}setFormat(t,e){this.format=t,this.responseType=e}export(t){t=t||{};const e=this.context.getServices().getHttpClient(),s=this.format||"csv",i=t.query||this.context.getQuery(),n=i.getModel().getId();let o={settings:t.settings,chunk:b};void 0!==t.queryId?o.queryId=t.queryId:o.query=i.toJSONData(),t.data&&(o.data=t.data),t.options&&(o.options=t.options);const r=this.context.resolveEndpoint("ExportResult",{modelId:n,format:s}),a=e.post(r,o,{responseType:this.responseType}),l=a.getRequest();return a.then((t=>{const e=new Blob([t]),i=l.getXMLHttpRequest().getResponseHeader("Content-Disposition"),n=i?i.match(/filename="(.*)"/)[1]:"export-data."+s;if(window.navigator.msSaveOrOpenBlob)window.navigator.msSaveOrOpenBlob(e,n);else{var o=document.createElement("a");document.body.appendChild(o),o.style.display="none",o.href=window.URL.createObjectURL(e),o.download=n,o.click(),window.URL.revokeObjectURL(o.href),document.body.removeChild(o)}}))}}class EasyQueryDataLoader{constructor(t){this.context=t}loadChunk(t){return this.dataLoadPromise=new Promise(((e,s)=>{const i={chunk:t,success:s=>{const i=new EasyDataTable({loader:this.context.dataLoader,chunkSize:this.context.resultTable.chunkSize}),n=s.resultSet;for(const t of n.cols)i.columns.add(t);i.setTotal(s.meta.totalRecords);for(const t of n.rows)i.addRow(t);let o=0;s.meta&&s.meta.totalRecords&&(o=s.meta.totalRecords),e({table:i,total:o,hasNext:!t.needTotal||t.offset+t.limit<o})},error:t=>s(t)};this.context.debugMode&&(i.debug=`Data Chunk. Offset: ${t.offset}`),this.context.fetchDataChunk(i)})),this.dataLoadPromise}}!function(t){t[t.Error=0]="Error",t[t.Success=1]="Success"}(v||(v={})),function(t){t.LoadModel="LoadModel",t.LoadQuery="LoadQuery",t.LoadQueryList="LoadQueryList",t.NewQuery="NewQuery",t.SaveQuery="SaveQuery",t.RemoveQuery="RemoveQuery",t.SyncQuery="SyncQuery",t.FetchData="FetchData",t.GetValueList="GetValueList",t.ExportResult="ExportResult",t.GetQueryFile="GetQueryFile",t.UploadQueryFile="UploadQueryFile"}(x||(x={}));class EqContext{constructor(){this.options={syncSortOrderWithColumnsOrder:!0,attributeFormat:"{entity} {attr}",columnTitleFormat:null},this.servicesInitialized=!1,this.internalListCache={},this.loadModelOnStart=!0,this.loadQueryOnStart=!1,this.useStoredQueryOnFetch=!1,this.debugMode=!1,this._backendInfo={type:"EQN-ANC",subType:"asp-net-core-razor"},this.endpointVarsRegex=/\{.*?\}/g,this.elasticPaging=!1,this._predefinedListRequestHandlers={_DSDE:(t,e)=>(e(this.getModel().getAllDateMacros().map((t=>({id:"${{"+t+"}}",text:o.getText(t)})))),!0),_DSTE:(t,e)=>(e(this.getModel().getAllTimeMacros().map((t=>({id:"${{"+t+"}}",text:o.getText(t)})))),!0)},this._listRequestHandler=(t,e)=>{if(null==t||!t.listName)return;const s=this.getQuery(),i=n.assign({listName:t.listName},t.editorParams),o={},r=/@{{(.+?)}}/;for(const t in i){if(!i[t])continue;let e=i[t].match(r);if(e){let n=s.getOneValueForAttr(e[1]);n||(n=""),o[t]=i[t].replace(r,n)}}const a={listName:o.listName,editorId:t.editorId,queryParams:o};let l=this.getListFromCache(t);if(l&&l.length>0)return void e(l);let d=!1;const h=this._predefinedListRequestHandlers[t.editorId];h&&(d=h(t,e)),!d&&this.clientListRequestHandler&&(d=this.clientListRequestHandler(t,e)),d||this.loadValueList({params:a,success:s=>{s&&this.addListToCache(t,s),e(s)},error:t=>{e(null)}})},this.baseEndpoint="api/easyquery",this.eqServices=EqServiceProvider.getInstance(),this.widgets=new Array,this.eventEmitter=new EventEmitter(this),this.exporters=new Map,this.endpoints=new Map,this.dataLoader=new EasyQueryDataLoader(this),this.resultTable=new EasyDataTable({loader:this.dataLoader,onUpdate:this.onResultTableUpdate.bind(this)}),this.resultTable.id="ResultTable",this.errorHandlerId=this.addEventListener("error",((t,e)=>{e.result=v.Error;const s=e.action?e.action+" error":"Error";let i=e.text?e.text:"";e.sourceError&&e.sourceError.message!==i&&(i+="\n"+e.sourceError),console.error(s+": "+i)}))}getServices(){return this.eqServices}useEnterprise(t){console.warn("This method does nothing and should not be called in the Community version of the library")}registerExporter(t,e){this.exporters.set(t,e)}registerServerExporter(t,e){this.registerExporter(t,(s=>{const i=new EqServerExporter(s);return i.setFormat(t,e),i}))}getExporter(t){const e=this.exporters.get(t);return e?e(this):null}getExportFormats(){return Array.from(this.exporters.keys())}addDefaultExporters(){this.registerServerExporter("csv","arraybuffer"),this.registerServerExporter("excel-html","arraybuffer")}resolveEndpoint(t,e){e=e||{};let s=this.endpoints.get(t);if(!s)throw t+" endpoint is not defined";let i=s.match(this.endpointVarsRegex);if(i)for(let t of i){let i=t.substring(1,t.length-1),n=e[i];if(!n)if("modelId"==i)n=this.getModel().getId();else{if("queryId"!=i)throw`Parameter [${i}] is not defined`;n=this.getQuery().getId()}s=s.replace(t,n)}return s}setEndpoint(t,e){this.endpoints.set(t,e)}setEndpointIfNotExist(t,e){this.endpoints.has(t)||this.endpoints.set(t,e)}setDefaultEndpoints(t){this.setEndpointIfNotExist("GetModel",d.combinePath(t,"models/{modelId}")),this.setEndpointIfNotExist("GetQuery",d.combinePath(t,"models/{modelId}/queries/{queryId}")),this.setEndpointIfNotExist("SaveQuery",d.combinePath(t,"models/{modelId}/queries/{queryId}")),this.setEndpointIfNotExist("SyncQuery",d.combinePath(t,"models/{modelId}/queries/{queryId}/sync")),this.setEndpointIfNotExist("NewQuery",d.combinePath(t,"models/{modelId}/queries")),this.setEndpointIfNotExist("RemoveQuery",d.combinePath(t,"models/{modelId}/queries/{queryId}")),this.setEndpointIfNotExist("GetQueryList",d.combinePath(t,"models/{modelId}/queries")),this.setEndpointIfNotExist("FetchData",d.combinePath(t,"models/{modelId}/fetch")),this.setEndpointIfNotExist("GetValueList",d.combinePath(t,"models/{modelId}/valuelists/{listId}")),this.setEndpointIfNotExist("ExportResult",d.combinePath(t,"models/{modelId}/export/{format}")),this.setEndpointIfNotExist("GetQueryFile",d.combinePath(t,"models/{modelId}/getqueryfile/{format}")),this.setEndpointIfNotExist("UploadQueryFile",d.combinePath(t,"models/{modelId}/uploadqueryfile"))}initStart(){this.servicesInitialized=!0}init(t){if(this.servicesInitialized||this.initStart(),t=t||{},this.setOptions(t),void 0!==t.debugMode&&(this.debugMode=t.debugMode),void 0!==t.chunkSize&&(this.resultTable.chunkSize=t.chunkSize),void 0!==t.elasticPaging&&(this.elasticPaging=t.elasticPaging),t.listCache&&this.setExternalListCache(t.listCache),t.locale&&o.setCurrentLocale(t.locale),t.localeSettings&&o.updateLocaleSettings(t.localeSettings),t.endpoint&&(this.baseEndpoint=t.endpoint,console.warn("The `endpoint` option is deprecated.\nPlease use `context.useEndpoint(endpointURL)` function instead.")),this.setDefaultEndpoints(this.baseEndpoint),t.modelStorageResolver){this.getServices().registerModelStorageResolver(t.modelStorageResolver)}this.loadQueryOnStart=!1,t.loadQueryOnStart&&(this.loadQueryOnStart=t.loadQueryOnStart),this.loadModelOnStart=!0,void 0!==t.loadModelOnStart&&(this.loadModelOnStart=t.loadModelOnStart),t.handlers&&(t.handlers.onInit&&this.addEventListener("ready",t.handlers.onInit),t.handlers.afterLoadModel&&this.addEventListener("loadModel",t.handlers.afterLoadModel),t.handlers.afterLoadQuery&&this.addEventListener("loadQuery",t.handlers.afterLoadQuery),t.handlers.afterSyncQuery&&this.addEventListener("syncQuery",t.handlers.afterSyncQuery),t.handlers.afterFetchData&&this.addEventListener("fetchData",t.handlers.afterFetchData),t.handlers.afterExportResult&&this.addEventListener("exportResult",t.handlers.afterExportResult),t.handlers.onProcessStart&&this.addEventListener("processStart",t.handlers.onProcessStart),t.handlers.onProcessEnd&&this.addEventListener("processEnd",t.handlers.onProcessEnd),t.handlers.onError&&(this.removeEventListener("error",this.errorHandlerId),this.addEventListener("error",t.handlers.onError)),t.handlers.onListRequest&&(this.clientListRequestHandler=t.handlers.onListRequest),t.handlers.beforeLoadModel&&(this.beforeLoadModel=t.handlers.beforeLoadModel),t.handlers.beforeLoadQuery&&(this.beforeLoadQuery=t.handlers.beforeLoadQuery),t.handlers.beforeSyncQuery&&(this.beforeSyncQuery=t.handlers.beforeSyncQuery),t.handlers.beforeFetchData&&(this.beforeFetchData=t.handlers.beforeFetchData),t.handlers.beforeExportResult&&(this.beforeExportResult=t.handlers.beforeExportResult)),this.initialQuery=t.initialQuery,this.defaultQueryId=t.defaultQueryId||"",this.defaultModelId=t.defaultModelId||"__default";this.eqServices.getModelLoader(this).init(t);if(this.eqServices.getQueryStorage(this).init(t),!1!==t.useDefaultExporters&&this.addDefaultExporters(),t.serverExporters){this.exporters.clear();for(const e of t.serverExporters)this.registerServerExporter(e,"arraybuffer")}const e=this.getQuery();t.defaultQueryId&&e.setId(t.defaultQueryId),this.widgets.forEach((e=>{let s={};t.widgets&&t.widgets[e.getWidgetType()]&&(s=t.widgets[e.getWidgetType()]),e.init(this,s)})),this.loadModelOnStart?this.loadDefaultModel():this.fireEvent("ready")}setOptions(t){n.assign(this.options,t)}get backendInfo(){return this._backendInfo}useEndpoint(t){return this.baseEndpoint=t,this}useBackend(t){if(t.type&&(this._backendInfo.type=t.type),t.subType)this._backendInfo.subType=t.subType;else switch(this._backendInfo.type){case"EQN-ANC":this._backendInfo.subType="asp-net-core-razor";break;case"EQN-ASP":this._backendInfo.subType="asp-net-4-mvc";break;default:this._backendInfo.subType="other"}return this}addWidget(t){this.widgets.push(t)}getAllWidgetsByType(t){return this.widgets.filter((e=>e.getWidgetType()===t))}getWidgetByType(t){const e=this.getAllWidgetsByType(t);return e.length>0?e[0]:null}refreshWidgets(t=C.All){this.widgets.forEach((e=>{e.belongsToGroup(t)&&e.refresh()}))}addQueryChangedCallback(t){this.getQuery().addChangedCallback(t)}removeQueryChangedCallback(t){this.getQuery().removeChangedCallback(t)}createQuery(){return this.eqServices.createQuery(this)}getQuery(){if(!this.query){if(!this.servicesInitialized)throw new Error("Can't create query until the context is initialized");this.query=this.createQuery()}return this.query}getModel(){return this.dataModel||(this.dataModel=this.eqServices.createDataModel(this)),this.dataModel}loadModelFromData(t){this.getQuery().loadModelData(t),this.dataModel=this.getQuery().getModel()}setDefaultModelId(t){this.defaultModelId=t}startProcess(t,e){this.eventEmitter.fire("processStart",t),this.widgets.forEach((t=>{t.belongsToGroup(e)&&t.onProcessStart()}))}endProcess(t,e){this.eventEmitter.fire("processEnd",t),t.result===v.Error&&this.throwError(t),this.widgets.forEach((t=>{t.belongsToGroup(e)&&t.onProcessEnd()}))}throwError(t){t.result=v.Error,this.eventEmitter.fire("error",t)}loadDefaultModel(){this.loadModel({modelId:this.defaultModelId,silent:!0,success:()=>{this.refreshWidgets(C.Model);let t=this.getQuery();this.fireEvent("initialModelLoad"),this.initialQuery&&t.loadFromData(this.initialQuery,{changeStatus:!1}),this.loadQueryOnStart?this.loadQuery({queryId:this.defaultQueryId,modelId:this.defaultModelId,success:()=>{this.throwReady()},error:()=>{this.throwReady()}}):this.throwReady()}})}throwReady(){this.refreshWidgets(C.Query),this.fireEvent("ready")}clearQuery(){const t=this.getQuery();t.clear(),t.fireChangedEvent({part:g.All})}clearResult(){this.resultTable.clear(),this.resultStatement=null,this.resultContent=null}setExternalListCache(t){this.externalListCache=t}getListFromCache(t){const e=this.getListCacheKey(t);return this.externalListCache?this.externalListCache.get(e):this.internalListCache[e]}getListCacheKey(t){let e="SQL"==t.listName?"SQL_"+t.editorId:t.listName;return t.queryParams&&(e+="_"+Object.keys(t.queryParams).filter((t=>"listName"!=t)).map((e=>t.queryParams[e])).join("_")),e}addListToCache(t,e){const s=this.getListCacheKey(t);this.externalListCache?this.externalListCache.set(s,e):this.internalListCache[s]=e}resetListCache(){this.externalListCache?this.externalListCache.clear():this.internalListCache={}}getListRequestHandler(){return this._listRequestHandler}addLocale(t,e){o.addLocale(t,e)}addEventListener(t,e){return this.eventEmitter.subscribe(t,(t=>e(this,t.data)))}removeEventListener(t,e){this.eventEmitter.unsubscribe(t,e)}fireEvent(t,e){this.eventEmitter.fire(t,e)}getBaseEndpoint(){return this.baseEndpoint}loadValueList(t){t=t||{},this.startProcess({action:x.GetValueList,text:"Loading values"},C.Result);this.eqServices.getValueListResolver(this).loadValueList(t).then((e=>{this.endProcess({result:v.Success,action:x.GetValueList,text:"Values loaded"},C.Result),t.success&&t.success(e)})).catch((e=>{const s=`Can't load the value list for editor ${t&&t.params?t.params.editorId:"undefined"}.\n ${e.message}`;this.endProcess({result:v.Error,action:x.GetValueList,text:s,sourceError:e},C.Result),t.error&&t.error(s,"GetValueList")}))}loadModel(t){this.beforeLoadModel&&this.beforeLoadModel(this,t);const e=t.modelId||"__default",s=t.silent||!1;this.startProcess({action:x.LoadModel,text:"Loading model: "+e},C.Model);return this.eqServices.getModelLoader(this).startModelLoading(t).then((i=>(i?(this.loadModelFromData(i),this.dataModel.isEmpty()&&console.warn(`Empty model has been loaded. Model ID: ${this.dataModel.getId()}`)):console.warn("Model has not been changed."),this.fireEvent("loadModel"),this.endProcess({result:v.Success,action:x.LoadModel,text:"Model loaded: "+e},C.Model),s||(this.clearQuery(),this.clearResult(),this.refreshWidgets()),t.success&&t.success(this.getModel()),this.getModel()))).catch((s=>{const i=`Can't load model ${e}.\n ${s.message}`;return this.endProcess({result:v.Error,action:x.LoadModel,text:i,sourceError:s},C.Model),t.error&&t.error(i,"LoadModel"),this.getModel()}))}callWhenModelLoaded(t){this.eqServices.getModelLoader(this).getModelPromise().then((()=>{t()}))}loadQuery(t){t=t||{};const e=this.eqServices.getModelLoader(this);this.clearResult(),e.getModelPromise().then((()=>{const e=(t=t||{}).queryId,s=t.silent||!1;this.beforeLoadQuery&&this.beforeLoadQuery(this,t),this.startProcess({action:x.LoadQuery,text:"Query loading: "+e},C.Query);this.eqServices.getQueryStorage(this).loadQuery(t).then((i=>{i&&this.query.loadFromData(i,{validate:!1}),this.limitCustomSqlColumns(),this.fireEvent("loadQuery"),this.endProcess({result:v.Success,action:x.LoadQuery,text:"Query loaded: "+e},C.Query),this.query.resetModified(),s||(this.query.fireChangedEvent({part:g.Properties,wasModified:this.query.isModified()}),this.refreshWidgets()),t.success&&t.success(this.query)})).catch((e=>{const s=this.getQuery();e.message="Can't load query ["+s.getId()+"]\n"+(e.message||""),t.error&&t.error(e.message,x.LoadQuery),this.endProcess({result:v.Error,action:x.LoadQuery,text:e.message,sourceError:e},C.Query)}))})).catch((t=>{console.error(t)}))}loadQueryList(t){this.eqServices.getModelLoader(this).getModelPromise().then((()=>{this.startQueryListLoading(t)})).catch((t=>{const e=`Can't load the list of available queries.\n ${t.message}`;this.throwError({action:x.LoadQueryList,text:e,sourceError:t})}))}startQueryListLoading(t){t=t||{};this.eqServices.getQueryStorage(this).getQueryList(t).then((e=>{t.success&&t.success(e)})).catch((e=>{const s=`Can't load the list of available queries.\n ${e.message}`;t.error?t.error(s,"LoadQueryList"):this.throwError({action:x.LoadQueryList,text:s,sourceError:e})}))}newQuery(t){const e=void 0===(t=t||{}).clearQuery||t.clearQuery;this.query.reset(e),t.queryId&&this.query.setId(t.queryId),t.name&&this.query.setName(t.name),t.description&&this.query.setDescription(t.description);const s=t.silent||!1;let i=!0;void 0!==t.useStorage&&(i=t.useStorage);const onNewQuery=()=>{const t=this.getQuery();t.isNewbie=!0,s||t.fireChangedEvent({part:g.All,wasModified:t.isModified()})};if(i){this.startProcess({action:x.NewQuery,text:"New query creation..."},C.Query);this.eqServices.getQueryStorage(this).newQuery(t).then((e=>{e&&this.query.loadFromData(e),this.endProcess({result:v.Success,action:x.NewQuery,text:"A new query has been created"},C.Query),onNewQuery(),t.success&&t.success()})).catch((e=>{const s=`Can't create a new query.\n${e.message}`;this.endProcess({result:v.Error,action:x.NewQuery,text:s,sourceError:e},C.Query),t.error&&t.error(s,"NewQuery")}))}else onNewQuery();return this.query}saveQuery(t){t=t||{};const e=this.getQuery();this.startProcess({action:x.SaveQuery,text:"Query saving: "+e.getId()},C.Query);this.eqServices.getQueryStorage(this).saveQuery(t).then((s=>{this.endProcess({action:x.SaveQuery,result:v.Success,text:"Query saved: "+e.getId()},C.Query),s&&e.loadFromData(s),e.resetModified(),e.isNewbie=!1,t.success&&t.success()})).catch((s=>{const i=`Can't save query ${e.getId()}.\n ${s.message}`;this.endProcess({action:x.SaveQuery,result:v.Error,text:i,sourceError:s},C.Query),t.error&&t.error(i,x.SaveQuery)}))}removeQuery(t){t=t||{};const e=this.getQuery();this.startProcess({action:x.RemoveQuery,text:"Query deleting: "+e.getId()},C.Query);this.eqServices.getQueryStorage(this).removeQuery(t).then((()=>{e.reset(),this.endProcess({action:x.RemoveQuery,result:v.Success,text:"Query deleted: "+e.getId()},C.Query),t.success&&t.success()})).catch((s=>{const i=`Can't remove query ${e.getId()}.\n ${s.message}`;this.endProcess({action:x.RemoveQuery,result:v.Error,text:i,sourceError:s},C.Query),t.error&&t.error(i,"RemoveQuery")}))}syncQuery(t){t=t||{};const e=this.getQuery();this.beforeSyncQuery&&this.beforeSyncQuery(this,t),this.startProcess({action:x.SyncQuery,text:"Query syncing: "+e.getId()},C.Query);this.eqServices.getQuerySynchronizer(this).syncQuery(t).then((s=>{if(this.resultStatement=s&&s.statement?s.statement:"",this.fireEvent("syncQuery"),this.refreshWidgets(C.Statement),this.endProcess({result:v.Success,action:x.SyncQuery,text:"Query synced: "+e.getId()},C.Query),s){if(s.querySaved){const t=s.query;t&&(e.setId(t.id),e.setName(t.name),e.setDescription(t.desc),e.extraData=t.extraData),e.resetModified(),this.refreshWidgets(C.QueryStatus)}t.success&&t.success(s)}})).catch((s=>{const i=`Can't synchronize query ${e.getId()}.\n ${s.message}`;this.endProcess({result:v.Error,action:x.SyncQuery,text:i,sourceError:s},C.Query),t.error&&t.error(i,"SyncQuery")}))}fetchData(t){const e=void 0!==(t=t||{}).elasticPaging?t.elasticPaging:this.elasticPaging;this.resultTable.elasticChunks=e,t.chunk=t.chunk||{offset:0,limit:this.resultTable.chunkSize,needTotal:!e},this.debugMode&&(t.debug="Fetching the result set. Initial chunk"),this.query.tryValidate({checkExpressions:!0})&&(t.groupFetchSuccess&&(this.afterGroupFetch=t.groupFetchSuccess),this.resultTable.elasticChunks&&t.chunk.limit++,this.fetchDataChunk(Object.assign(Object.assign({},t),{success:e=>{e.statement&&(this.resultStatement=e.statement,this.refreshWidgets(C.Statement));if(this.getServices().getAggregatesCalculator(this).reset(),this.resultContent=e,e.resultSet){this.resultTable.clear(),this.resultTable.id=this.query.getId();const s=e.resultSet;for(const t of s.cols)this.resultTable.columns.add(t);e.meta&&void 0!==e.meta.totalRecords&&this.resultTable.setTotal(e.meta.totalRecords);const i=s.rows.length;this.resultTable.elasticChunks&&i===t.chunk.limit&&s.rows.splice(s.rows.length-1,1);for(const t of s.rows)this.resultTable.addRow(t);this.resultTable.elasticChunks&&(this.resultTable.total=i<t.chunk.limit?s.rows.length:0),this.resultTable.fireUpdated()}t.success&&t.success(e)}})))}getQueryFile(t){const e=this.getQuery();this.startProcess({action:x.GetQueryFile,text:"Getting query file: "+e.getId()},C.Query);this.getServices().getQueryFileLoader(this).getQueryFile(t).then((()=>{this.endProcess({result:v.Success,action:x.GetQueryFile,text:"Getting query file: "+e.getId()},C.Query),t.success&&t.success()})).catch((s=>{const i=`Can't get file for query ${e.getId()}.\n ${s.message}`;this.endProcess({result:v.Error,action:x.GetQueryFile,text:i,sourceError:s},C.Query),t.error&&t.error(i,"GetQueryFile")}))}uploadQueryFile(t){const e=this.getQuery();this.startProcess({action:x.UploadQueryFile,text:"Uploading query file: "+e.getId()},C.Query);this.getServices().getQueryFileLoader(this).uploadQueryFile(t).then((s=>{e.loadFromData(s),this.fireEvent("loadQuery"),this.refreshWidgets(),this.endProcess({result:v.Success,action:x.UploadQueryFile,text:"Uploading query file: "+e.getId()},C.Query),t.success&&t.success()})).catch((s=>{const i=`Can't upload a file for query ${e.getId()}.\n ${s.message}`;this.endProcess({result:v.Error,action:x.UploadQueryFile,text:i,sourceError:s},C.Query),t.error&&t.error(i,"UploadQueryFile")}))}fetchDataChunk(t){const e=this.getQuery().getId();let s=t||{};this.useStoredQueryOnFetch&&(s.queryId=this.query.getId()),this.beforeFetchData&&this.beforeFetchData(this,s),this.startProcess({action:x.FetchData,text:"Fetching data for the query: "+e},C.Result);this.eqServices.getDataFetcher(this).fetchData(s).then((t=>{t.statement&&(this.resultStatement=t.statement),this.resultContent=t,s.success&&s.success(t),this.fireEvent("fetchData"),this.endProcess({result:v.Success,action:x.FetchData,text:"Data fetching is finished for the query: "+e},C.Result)})).catch((t=>{const i=`Data fetching error for the query ${e}. \n${t.message}`;this.endProcess({result:v.Error,action:x.FetchData,text:i,sourceError:t},C.Result),s.error&&s.error(i,x.FetchData)}))}onResultTableUpdate(){const t=this.query.getAggregationSettings(),e=this.getServices().getAggregatesCalculator(this);t.needAggrCalculation()&&e.needRecalculation()&&e.calculate({maxLevel:t.getGroups().length+1,resultObtained:(t,e)=>{this.afterGroupFetch&&this.afterGroupFetch(t)},errorOccurred:t=>{const e=`Data fetching error on group level ${t.level} query. \n${t.message}`;this.throwError({action:x.FetchData,text:e,sourceError:t})}})}fetchDrillDownData(t){(t=t||{}).chunk=t.chunk||{offset:0,limit:this.resultTable.chunkSize,needTotal:!0};const e=t.query.getId();this.startProcess({action:x.FetchData,text:"DrillDown executing: "+e},C.Result);this.eqServices.getDataFetcher(this).fetchData(t).then((s=>{this.endProcess({result:v.Success,action:x.FetchData,text:"DrillDown execution error: "+e},C.Result),t.success&&t.success(s)})).catch((s=>{const i=`Drill-down data fetching error for query ${e}. \n${s.message}`;this.endProcess({result:v.Error,action:x.FetchData,text:i},C.Result),t.error?t.error(i,"DrillDown"):this.throwError({action:x.FetchData,text:i})}))}exportResult(t){(t=t||{}).chunk=t.chunk||b,this.beforeExportResult&&this.beforeExportResult(this,t);const e=t.format;if(e){const s=this.getExporter(e);if(s){const e=this.getQuery().getId();this.useStoredQueryOnFetch&&(t.queryId=e),this.startProcess({action:x.ExportResult,text:"Exporting result for query: "+e},C.Result);const i=o.getLocaleSettings();t.settings=i;const n=this.query.getAggregationSettings();n.hasAggregates()&&(n.hasGrandTotals()||n.hasGroups())&&(t.aggregates=n.saveToData()),s.export(t).then((s=>{this.fireEvent("exportResult"),this.endProcess({result:v.Success,action:x.ExportResult,text:`The result set for query [${e}] has been successfully exported`},C.Result),t.success&&t.success()})).catch((s=>{const i=`Error on exporting data for query  ${e}. \n${s.message}`;this.endProcess({result:v.Error,action:x.ExportResult,text:i,sourceError:s},C.Result),t.error&&t.error(i,"ExportResult")}))}else console.error("No exporter for this format: "+e)}}limitCustomSqlColumns(){this.options.allowCustomExpressions||this.query.getColumns().forEach((t=>{t.expr.tag===c.CustomSql&&(t.enabled=!1)}))}getAttributeTitle(t){const e=this.options.attributeFormat;return this.getModel().getAttributeText(t,e)}getColumnTitle(t){const e=this.options.columnTitleFormat||this.options.attributeFormat;return this.getModel().getAttributeText(t,e)}getDefaultColumnCaption(t){let e;const s=this.getModel();switch(t.expr.tag){case c.Constant:return"Contant Column";case c.CustomSql:return"SQL Column";case c.ParentColumn:return"Parent Column";case c.Query:return"Query Column";case c.EntityAttribute:case c.ParentEntityAttribute:return e=s.getAttributeById(t.expr.value),this.getColumnTitle(e);case c.AggregateFunction:return e=s.getAttributeById(t.expr.args[0].value),this.getColumnTitle(e)+" "+s.getAggrFunctionCaption(t.expr.func);default:return"Column"}}}let E;function registerEqContextResolver(t){E=t}var T,w;registerEqContextResolver((()=>new EqContext)),function(t){t.constLists=new class ConstLists{constructor(){this.SpecDateValues=[{id:"${Today}",key:"Today",isDefault:!0},{id:"${Yesterday}",key:"Yesterday"},{id:"${Tomorrow}",key:"Tomorrow"},{id:"${FirstDayOfMonth}",key:"FirstDayOfMonth"},{id:"${FirstDayOfYear}",key:"FirstDayOfYear"}],this.SpecTimeValues=[{id:"${Now}",key:"Now",isDefault:!0},{id:"${HourStart}",key:"HourStart"},{id:"${Midnight}",key:"Midnight"},{id:"${Noon}",key:"Noon"}],this.BooleanValues=[{id:"${false}",key:"False"},{id:"${true}",key:"True",isDefault:!0}]}},t.predicateLinkTypeList=[{id:"All",key:"LinkTypeAll"},{id:"Any",key:"LinkTypeAny"},{id:"None",key:"LinkTypeNone"},{id:"NotAll",key:"LinkTypeNotAll"}]}(T||(T={}));class Widget{constructor(t){this.slot=t,this._id=n.generateId(this.getWidgetType())}get id(){return this._id}init(t,e){this.context=t}getContext(){return this.context}refresh(){this.refreshCore()}refreshCore(){}onProcessStart(){this.onProcessStartCore()}onProcessStartCore(){}onProcessEnd(){this.onProcessEndCore()}onProcessEndCore(){}belongsToGroup(t){return!!(void 0===t||null==t||t&this.group)}destroy(){this.destroyCore()}destroyCore(){}}function addElement(t,e,s){let i=document.createElement(e),n=s||{};return n.cssClass&&(i.className=n.cssClass),t.appendChild(i),i}function addCssClass(t,e){t.className=t.className?t.className+" "+e:e}function hideElement(t){t.style.display="none"}function showElement(t,e){e||(e=""),t.style.display=e}function createBrowserEvent(t){var e;return"function"==typeof Event?e=new Event(t):(e=document.createEvent("Event")).initEvent(t,!0,!0),e}function getViewportSize(){return{width:Math.max(document.documentElement.clientWidth||0,window.innerWidth||0),height:Math.max(document.documentElement.clientHeight||0,window.innerHeight||0)}}function getScrollPos(){const t=document.body,e=document.documentElement;return{top:window.pageYOffset||e.scrollTop||t.scrollTop,left:window.pageXOffset||e.scrollLeft||t.scrollLeft}}function getElementAbsolutePos(t){let e={x:0,y:0};if(null!==t){const s=function offset(t){const e={top:0,right:0,bottom:0,left:0,width:0,height:0};let s;try{s=t.getBoundingClientRect()}catch(t){s=e}const i=document.body,n=document.documentElement,o=getScrollPos(),r=o.top,a=o.left,l=n.clientTop||i.clientTop||0,d=n.clientLeft||i.clientLeft||0,h=s.top+r-l,u=s.left+a-d;return{top:Math.round(h),left:Math.round(u)}}(t);e={x:s.left,y:s.top}}return e}function getWinSize(){return{width:window.innerWidth,height:window.innerHeight}}!function addEasyQueryCoreTexts(){o.updateDefaultTexts({NewQueryName:"[New query]",Today:"Today",Yesterday:"Yesterday",Tomorrow:"Tomorrow",FirstDayOfMonth:"First day of the month",LastDayOfMonth:"Last day of the month",FirstDayOfWeek:"First day of the week",FirstDayOfYear:"First day of the year",FirstDayOfNextWeek:"First day of the next week",FirstDayOfNextMonth:"First day of the next month",FirstDayOfNextYear:"First day of the next year",Now:"Now",HourStart:"This hour start",Midnight:"Midnight",Noon:"Noon",Entities:{},Attributes:{},Operators:{},AggregateFunctions:{}})}(),function(t){let e,s=null;function isIE(){{const t=navigator.userAgent;return t.includes("MSIE")||t.includes("Trident")}}t.isIE=isIE,t.isEdge=function isEdge(){const t=window.navigator.userAgent;return!isIE()&&t.includes("Edge/")},t.isFirefox=function isFirefox(){if(null===s){const t=navigator.userAgent;s=t.toLowerCase().includes("firefox")}return s};let i,n=!1,detectIsMobileMode=()=>{const t=isMobileMode();n=window.matchMedia("only screen and (max-width: 840px)").matches||window.matchMedia("only screen and (max-height: 420px)").matches;const s=isMobileMode();s!==t&&e&&e(s)};function isMobileMode(){return void 0!==i?i:n}detectIsMobileMode(),window.addEventListener("resize",(()=>detectIsMobileMode())),t.isMobileMode=isMobileMode,t.setIsMobileMode=function setIsMobileMode(t){const s=isMobileMode();i=t;const n=isMobileMode();n!==s&&e&&e(n)},t.onMobileModeChanged=function onMobileModeChanged(t){e=t}}(w||(w={}));const D="eqjs";class DomElementBuilder{constructor(t,e){this.element="string"==typeof t?document.createElement(t):t,e&&this.element.parentElement!==e&&e.appendChild(this.element)}addChild(t,e){const s=domel(t,this.element);return e&&e(s),this}addChildElement(t){return t&&this.element.appendChild(t),this}attr(t,e){return this.element.setAttribute(t,e),this}id(t){return this.attr("id",t)}focus(){return this.element.focus(),this}title(t){return this.attr("title",t)}data(t,e=null){return null===e?(this.element.removeAttribute("data-"+t),this):this.attr("data-"+t,e)}show(){return this.removeStyle("display")}hide(t=!0){return t?this.setStyle("display","none"):this}visible(t=!0){return t?this.setStyle("visibility","visible"):this.setStyle("visibility","hidden")}isVisible(){return!!(this.element.offsetWidth||this.element.offsetHeight||this.element.getClientRects().length)}addClass(t,...e){if(t){const s=[...t.trim().split(" "),...e];for(let t=0;t<s.length;t++)this.element.classList.add(s[t])}return this}removeClass(t,...e){if(t){const s=[...t.trim().split(" "),...e];for(let t=0;t<s.length;t++)this.element.classList.remove(s[t])}return this}toggleClass(t,e=void 0){return t&&this.element.classList.toggle(t,e),this}on(t,e){const s=t.split(" ");for(let t=0;t<s.length;t++)this.element.addEventListener(s[t],e);return this}off(t,e){const s=t.split(" ");for(let t=0;t<s.length;t++)this.element.removeEventListener(s[t],e);return this}setStyle(t,e){return this.element.style.setProperty(t,e),this}removeStyle(t){return this.element.style.removeProperty(t),this}text(t){return this.element.innerText=t,this}html(t){return this.element.innerHTML=t,this}clear(){const t=this.element;this.element=document.createElement(this.element.tagName),t.replaceWith(this.element)}addText(t){const e=document.createTextNode(t);return this.element.appendChild(e),this}addHtml(t){return this.element.innerHTML+=t,this}toDOM(){return this.element}appendTo(t){return t&&t.appendChild(this.element),this}}class DomTextAreaElementBuilder extends DomElementBuilder{constructor(t,e){super(t||"textarea",e)}name(t){return this.element.name=t,this}rows(t){return this.element.rows=t,this}cols(t){return this.element.cols=t,this}value(t){return this.element.value=t,this}}class DomInputElementBuilder extends DomElementBuilder{constructor(t,e){super(t||"input",e)}name(t){return this.element.name=t,this}type(t){return this.element.type=t,this}size(t){return this.element.size=t,this}value(t){return t instanceof Date?this.element.valueAsDate=t:"number"==typeof t?this.element.valueAsNumber=t:this.element.value=t,this}mask(t){return function mask(t,e){const s={9:"[0-9]",a:"[a-z]"},i=e.split(""),inputHandler=e=>{if("focus"===e.type&&""!==t.value)return;let n=[],o=t.selectionStart;i.forEach(((e,i)=>{if(s[e]){let o=new RegExp(s[e],"i").test(t.value.charAt(i));n.push(o?t.value.charAt(i):"_")}else n.push(e)})),t.value=n.join(""),t.selectionStart=t.selectionEnd=o};t.addEventListener("keydown",(e=>{if(8===e.keyCode||46===e.keyCode){e.preventDefault();let n=[],o=t.selectionStart;if(0==o)return;let r=o,a=!0;for(let e=i.length-1;e>=0;e--){const l=i[e];if(s[l]){let i=new RegExp(s[l],"i").test(t.value.charAt(e));i&&e!=o-1&&(a=!1),e===o-1&&r--,n.push(i&&e!=o-1?t.value.charAt(e):"_")}else e===r-1&&r--,o-1===e&&o--,n.push(l)}t.value=a?"":n.reverse().join(""),t.selectionStart=t.selectionEnd=r<0?0:r;const l=document.createEvent("Event");l.initEvent("input",!0,!0),t.dispatchEvent(l)}})),t.addEventListener("keypress",(e=>{const n=String.fromCharCode(e.charCode);if(n){e.preventDefault();let o=[],r=t.selectionStart,a=r;i.forEach(((e,i)=>{if(s[e]){const l=i!=r?t.value.charAt(i):n;let d=new RegExp(s[e],"i").test(l);o.push(d?l:"_"),d&&r===i&&a++}else o.push(e),a===i&&a++,r===i&&r++})),t.value=o.join(""),t.selectionStart=t.selectionEnd=a;const l=document.createEvent("Event");l.initEvent("input",!0,!0),t.dispatchEvent(l)}})),t.addEventListener("input",inputHandler),t.addEventListener("focus",inputHandler)}(this.element,t),this}}class DomSelectElementBuilder extends DomElementBuilder{constructor(t,e){super(t||"select",e)}addOption(t){const e=document.createElement("option");return"string"==typeof t?(e.value=t,e.innerHTML=t):(e.value=t.value,e.innerHTML=t.title||t.value,e.selected=t.selected||!1),this.element.appendChild(e),this}value(t){return this.element.value=t,this}}function domel(t,e){return"div"===t||t instanceof HTMLDivElement||"span"===t||t instanceof HTMLSpanElement||"a"===t||t instanceof HTMLAnchorElement||"button"===t||t instanceof HTMLButtonElement||"img"===t||t instanceof HTMLImageElement?new DomElementBuilder(t,e):"input"===t||t instanceof HTMLInputElement?new DomInputElementBuilder(t instanceof HTMLInputElement?t:null,e):"textarea"===t||t instanceof HTMLTextAreaElement?new DomTextAreaElementBuilder(t instanceof HTMLTextAreaElement?t:null,e):"select"===t||t instanceof HTMLSelectElement?new DomSelectElementBuilder(t instanceof HTMLSelectElement?t:null,e):new DomElementBuilder(t,e)}const S="undefined"!=typeof TouchEvent;var I;!function(t){t.None="none",t.Allow="allow",t.Forbid="forbid"}(I||(I={}));class EqDragEvent{constructor(t,e,s){this.dropEffect=I.Allow,this.pageX=0,this.pageY=0,this.item=t,this.dragImage=e,this.data=t.data,this.sourceEvent=s,s&&s instanceof MouseEvent&&(this.pageX=s.pageX,this.pageY=s.pageY),s&&S&&s instanceof TouchEvent&&s.touches[0]&&(this.pageX=s.touches[0].pageX,this.pageY=s.touches[0].pageY)}}class Position{constructor(t){t&&t instanceof MouseEvent&&(this.x=t.pageX,this.y=t.pageY),t&&S&&t instanceof TouchEvent&&t.touches[0]&&(this.x=t.touches[0].pageX,this.y=t.touches[0].pageY)}}const M=new class DragManager{constructor(){this.delta=5,this.draggableItem=null,this.dragImage=null,this.finishedSuccessfully=!1,this.mouseDownPosition=null,this.containerDescriptors=[],this.containerDescriptorIndex=-1,this.dropEffect=I.None,this.classPrefix="eqjs-drop",this.DRAG_DISABLED_ATTR="drag-disabled"}registerDraggableItem(t){const e=t.element;if(!e)throw Error("Element in draggle item is null or undefined");e.ondragstart=function(){return!1};const detectDragging=t=>{if(e.hasAttribute(this.DRAG_DISABLED_ATTR))return;t.preventDefault(),t instanceof MouseEvent&&t.stopPropagation();const s=new Position(t);(Math.abs(s.x-this.mouseDownPosition.x)>this.delta||Math.abs(s.y-this.mouseDownPosition.y)>this.delta)&&startDragging(t)},mouseMoveEventListener=t=>{this.mouseMoveDragListener(t)},startDragging=s=>{s.preventDefault(),s.stopPropagation(),e.removeEventListener("mousemove",detectDragging),e.removeEventListener("touchmove",detectDragging),this.finishedSuccessfully=!1,t.beforeDragStart&&t.beforeDragStart(),this.dragImage=domel("div").setStyle("position","absolute").setStyle("z-index","65530").toDOM(),document.body.appendChild(this.dragImage),this.dragImage.appendChild(e.cloneNode(!0)),t.renderer&&t.renderer(this.dragImage),this.dropEffect=I.None,this.updateCusror(this.dropEffect),this.updateImageClass(this.dropEffect),this.draggableItem={element:e,scope:t.scope,data:t.data},this.updateDragItemPosition(s);const i=new EqDragEvent(this.draggableItem,this.dragImage,s);i.dropEffect=this.dropEffect,t.onDragStart&&t.onDragStart(i),this.dropEffect!==i.dropEffect&&(this.dropEffect=i.dropEffect,this.updateImageClass(this.dropEffect)),document.addEventListener("mousemove",mouseMoveEventListener,!0),document.addEventListener("touchmove",mouseMoveEventListener,!0)},mouseDownListener=t=>{S&&t instanceof TouchEvent&&t.preventDefault(),this.mouseDownPosition=new Position(t),e.addEventListener("mousemove",detectDragging),e.addEventListener("touchmove",detectDragging),document.addEventListener("mouseup",mouseUpListener),document.addEventListener("touchend",mouseUpListener)};e.addEventListener("mousedown",mouseDownListener),e.addEventListener("touchstart",mouseDownListener);const mouseUpListener=t=>{this.mouseDownPosition=null,e.removeEventListener("mousemove",detectDragging),e.removeEventListener("touchmove",detectDragging),document.removeEventListener("mousemove",mouseMoveEventListener,!0),document.removeEventListener("touchmove",mouseMoveEventListener,!0),this.draggableItem&&endDraggind(t)},endDraggind=e=>{try{if(this.containerDescriptorIndex>=0){const t=this.containerDescriptors[this.containerDescriptorIndex],s={element:t.element,scopes:t.scopes,data:t.data},i=new EqDragEvent(this.draggableItem,this.dragImage,e);try{s.scopes.indexOf(this.draggableItem.scope)>=0&&this.dropEffect===I.Allow&&(this.finishedSuccessfully=!0,t.onDrop&&t.onDrop(s,i))}finally{t.onDragLeave&&t.onDragLeave(s,i)}}}finally{try{const s=new EqDragEvent(this.draggableItem,this.dragImage,e);s.data.finishedSuccessfully=this.finishedSuccessfully,t.onDragEnd&&t.onDragEnd(s)}finally{this.draggableItem=null,this.dragImage&&this.dragImage.parentElement&&this.dragImage.parentElement.removeChild(this.dragImage),this.dragImage=null,this.finishedSuccessfully=!1,document.removeEventListener("mouseup",mouseUpListener),document.removeEventListener("touchend",mouseUpListener)}}}}registerDropContainer(t){if(!t.element)throw Error("Element in drop container is null or undefined");this.containerDescriptors.push(t)}removeDropContainer(t){const e=this.containerDescriptors.filter((e=>e===t||e.element==t));if(e)for(const t of e)n.removeArrayItem(this.containerDescriptors,t)}mouseMoveDragListener(t){if(t instanceof MouseEvent&&t.preventDefault(),t.stopPropagation(),this.updateDragItemPosition(t),-1==this.containerDescriptorIndex){for(let e=0;e<this.containerDescriptors.length;e++){const s=this.containerDescriptors[e];if(this.detectDragEnterEvent(s.element,t)){this.containerDescriptorIndex=e;break}}this.containerDescriptorIndex>=0&&this.dragEnterEvent(t)}else{const e=this.containerDescriptors[this.containerDescriptorIndex];this.detectDragLeaveEvent(e.element,t)&&(this.dragLeaveEvent(t),this.containerDescriptorIndex=-1)}if(this.containerDescriptorIndex>=0){const e=this.containerDescriptors[this.containerDescriptorIndex],s={element:e.element,scopes:e.scopes,data:e.data};if(s.scopes.indexOf(this.draggableItem.scope)>=0){const i=new EqDragEvent(this.draggableItem,this.dragImage,t);i.dropEffect=this.dropEffect,e.onDragOver&&e.onDragOver(s,i)}}}updateCusror(t){switch(t){case I.Allow:this.setCursorStyle(this.dragImage,"grabbing");break;case I.Forbid:this.setCursorStyle(this.dragImage,"no-drop");break;default:this.setCursorStyle(this.dragImage,"grabbing")}}updateImageClass(t){switch(this.dragImage.classList.remove(`${this.classPrefix}-allow`),this.dragImage.classList.remove(`${this.classPrefix}-forbid`),this.dragImage.classList.remove(`${this.classPrefix}-none`),t){case I.Allow:this.dragImage.classList.add(`${this.classPrefix}-allow`);break;case I.None:this.dragImage.classList.add(`${this.classPrefix}-none`);break;case I.Forbid:this.dragImage.classList.add(`${this.classPrefix}-forbid`);break;default:this.dragImage.classList.add(`${this.classPrefix}-none`)}}setCursorStyle(t,e){if(t){t.style.cursor=e;for(let s=0;s<t.children.length;s++)this.setCursorStyle(t.children[s],e)}}updateDragItemPosition(t){if(this.dragImage){const e=new Position(t);this.dragImage.style.top=e.y-this.dragImage.offsetHeight/2+"px",this.dragImage.style.left=e.x-this.dragImage.offsetWidth/2+"px"}}dragEnterEvent(t){const e=this.containerDescriptors[this.containerDescriptorIndex],s={element:e.element,scopes:e.scopes,data:e.data};if(s.scopes.indexOf(this.draggableItem.scope)>=0){const i=new EqDragEvent(this.draggableItem,this.dragImage,t);i.dropEffect=I.Allow,e.onDragEnter&&e.onDragEnter(s,i),this.dropEffect=i.dropEffect,this.updateCusror(this.dropEffect),this.updateImageClass(this.dropEffect)}else this.dropEffect!==I.Forbid&&(this.dropEffect=I.None,this.updateCusror(this.dropEffect),this.updateImageClass(this.dropEffect))}dragLeaveEvent(t){const e=this.containerDescriptors[this.containerDescriptorIndex],s={element:e.element,scopes:e.scopes,data:e.data};if(s.scopes.indexOf(this.draggableItem.scope)>=0){const i=new EqDragEvent(this.draggableItem,this.dragImage,t);i.dropEffect=I.None,e.onDragLeave&&e.onDragLeave(s,i),this.dropEffect=i.dropEffect,this.updateCusror(this.dropEffect),this.updateImageClass(this.dropEffect)}}detectDragEnterEvent(t,e){const s=getElementAbsolutePos(t),i=new Position(e);return!(i.y<s.y||i.y>s.y+t.offsetHeight)&&!(i.x<s.x||i.x>s.x+t.offsetWidth)}detectDragLeaveEvent(t,e){const s=getElementAbsolutePos(t),i=new Position(e);return!(i.y>s.y&&i.y<s.y+t.offsetHeight&&i.x>s.x&&i.x<s.x+t.offsetWidth)}};var k;!function(t){t[t.Always=0]="Always",t[t.Once=1]="Once",t[t.Never=2]="Never"}(k||(k={}));var A;!function(t){t[t.NONE=1]="NONE",t[t.LEFT=2]="LEFT",t[t.CENTER=3]="CENTER",t[t.RIGHT=4]="RIGHT"}(A||(A={}));class GridColumn{constructor(t,e,s=!1){this._label=null,this._description=null,this.align=A.NONE,this.isVisible=!0,this.isRowNum=!1,this.dataColumn=t,this.grid=e;const i=e.options.columnWidths||{};t?(t.style.alignment&&(this.align=function MapAlignment(t){switch(t){case r.Left:return A.LEFT;case r.Center:return A.CENTER;case r.Right:return A.RIGHT;default:return A.NONE}}(t.style.alignment)),this.width=i&&i[this.type]?i[this.type].default:250,this._description=t.description):s&&(this.isRowNum=!0,this.width=i&&i.rowNumColumn?i.rowNumColumn.default:60,this._label="")}get label(){return this._label?this._label:this.isRowNum?"":this.dataColumn.label}set label(t){this._label=this.label}get description(){return this._description}get type(){return this.dataColumn?this.dataColumn.type:null}}class GridColumnList{constructor(t,e){this.items=[],this.grid=e,this.sync(t)}sync(t,e=!0){this.clear();const s=new GridColumn(null,this.grid,!0);if(this.add(s),e||(s.isVisible=!1),t)for(let e of t.getItems()){const t=new GridColumn(e,this.grid);this.grid.options.onSyncGridColumn&&this.grid.options.onSyncGridColumn(t),this.add(t)}}get count(){return this.items.length}add(t){const e=this.items.length;return this.items.push(t),e}put(t,e){t>=0&&t<this.items.length&&(this.items[t]=e)}move(t,e){let s=this.items.indexOf(t);s>=0&&s!=e&&n.moveArrayItem(this.items,s,e)}get(t){return t>=0&&t<this.items.length?this.items[t]:null}getItems(){return this.items}removeAt(t){this.get(t),this.items.splice(t,1)}clear(){this.items=[]}}const B="keg",P=/{0:(.*?)}/g;var L;!function(t){t[t.STRING=1]="STRING",t[t.NUMBER=2]="NUMBER",t[t.DATETIME=3]="DATETIME",t[t.BOOL=4]="BOOL"}(L||(L={}));const StringCellRendererDefault=(t,e,s,i)=>{const n=t?t.toString().replace(/\n/g," "):"";s.innerText=n,s.title=n,e.align==A.NONE&&s.classList.add(`${B}-cell-value-align-left`)},NumberCellRendererDefault=(t,e,s,i)=>{let n=(t||"").toString();"number"==typeof t&&(n=e.dataColumn&&e.dataColumn.displayFormat&&P.test(e.dataColumn.displayFormat)?e.dataColumn.displayFormat.replace(P,((e,s)=>o.numberToStr(t,s))):t.toLocaleString()),s.innerText=n,s.title=n,e.align==A.NONE&&s.classList.add(`${B}-cell-value-align-right`)},DateTimeCellRendererDefault=(e,s,i,n)=>{const r="[object Date]"===Object.prototype.toString.call(e);let a=(e||"").toString();if(r)if(s.dataColumn&&s.dataColumn.displayFormat&&P.test(s.dataColumn.displayFormat))a=s.dataColumn.displayFormat.replace(P,((t,i)=>o.dateTimeToStrEx(e,s.type,i)));else{const i=o.getCurrentLocale(),n={hour:"numeric",minute:"numeric",second:"numeric"};switch(s.type){case t.Date:a=e.toLocaleDateString(i);break;case t.Time:a=e.toLocaleTimeString(i,n);break;case t.DateTime:a=`${e.toLocaleDateString(i)} ${e.toLocaleTimeString(i,n)}`}}i.innerText=a,i.title=a,s.align==A.NONE&&i.classList.add(`${B}-cell-value-align-right`)},BoolCellRendererDefault=(t,e,s,i)=>{if(e.dataColumn&&e.dataColumn.displayFormat&&P.test(e.dataColumn.displayFormat)){const i=e.dataColumn.displayFormat.replace(P,((e,s)=>o.booleanToStr(t,s)));return StringCellRendererDefault(i,e,s)}s.classList.add(`${B}-cell-value-bool`),s.classList.add(`${B}-${t?"cell-value-true":"cell-value-false"}`)};class GridCellRendererStore{constructor(t){this.renderers={},this.defaultRenderers={},this.registerRenderer("StringDefault",StringCellRendererDefault),this.setDefaultRenderer(L.STRING,StringCellRendererDefault),this.registerRenderer("NumberDefault",NumberCellRendererDefault),this.setDefaultRenderer(L.NUMBER,NumberCellRendererDefault),this.registerRenderer("DateTimeDefault",DateTimeCellRendererDefault),this.setDefaultRenderer(L.DATETIME,DateTimeCellRendererDefault),this.registerRenderer("BoolDefault",BoolCellRendererDefault),this.setDefaultRenderer(L.BOOL,BoolCellRendererDefault)}getDefaultRenderer(t){const e=this.getCellType(t);return this.defaultRenderers[L[e]]}getDefaultRendererByType(t){return this.defaultRenderers[L[t]]}setDefaultRenderer(t,e){e&&(this.defaultRenderers[L[t]]=e)}getRenderer(t){return this.renderers[t]}registerRenderer(t,e){this.renderers[t]=e}getCellType(e){switch(e){case t.Autoinc:case t.Byte:case t.Word:case t.Currency:case t.Float:case t.Int32:case t.Int64:return L.NUMBER;case t.Date:case t.DateTime:case t.Time:return L.DATETIME;case t.Bool:return L.BOOL;default:return L.STRING}}}class EasyGrid{constructor(t){if(this.cssPrefix="keg",this.pagination={page:1,pageSize:30,total:0},this.paginationOptions={maxButtonCount:10,useBootstrap:!1},this.defaultDataGridOptions={slot:null,dataTable:null,fixHeightOnFirstRender:!1,syncGridColumns:!0,useRowNumeration:!0,allowDragDrop:!1,aggregates:{settings:null,calculatorRef:null},paging:{enabled:!0,pageSize:30,pageSizeItems:[20,30,50,100,200]},columnWidths:{autoResize:k.Always,stringColumns:{min:100,max:500,default:250},numberColumns:{min:60,default:120},boolColumns:{min:50,default:80},dateColumns:{min:80,default:200},otherColumns:{min:100,max:500,default:250},rowNumColumn:{min:40,default:60}},showPlusButton:!1,viewportRowsCount:null,showActiveRow:!0},this.rowsOnPagePromise=null,this.containerInitialHeight=0,this.firstRender=!0,this.prevRowTotals=null,this.landingIndex=-1,this.landingSlot=domel("div").addClass(`${this.cssPrefix}-col-landing-slot`).addChildElement(domel("div").toDOM()).toDOM(),this._activeRowIndex=-1,t&&t.paging&&(t.paging=n.assign(this.defaultDataGridOptions.paging,t.paging)),this.options=this.mergeOptions(t),this.processColumnWidthsOptions(),!this.options.slot)throw Error('"slot" parameter is required to initialize EasyDataGrid');if(!this.options.dataTable)throw Error('"dataTable" parameter is required to initialize EasyDataGrid');this.dataTable=t.dataTable,this.eventEmitter=new EventEmitter(this),this.cellRendererStore=new GridCellRendererStore(t),this.columns=new GridColumnList(this.dataTable.columns,this),this.setSlot(this.options.slot),this.init(this.options)}mergeOptions(t){const e=n.assignDeep({},this.defaultDataGridOptions.aggregates,t.aggregates),s=n.assignDeep({},this.defaultDataGridOptions.columnWidths,t.columnWidths),i=n.assignDeep({},this.defaultDataGridOptions.paging,t.paging),o=n.assign({},this.defaultDataGridOptions,t);return o.aggregates=e,o.columnWidths=s,o.paging=i,o}processColumnWidthsOptions(){const e=this.options.columnWidths;if(!e)return;n.getStringDataTypes().forEach((t=>{e[t]=Object.assign(Object.assign({},e.stringColumns),e[t])})),n.getNumericDataTypes().forEach((t=>{e[t]=Object.assign(Object.assign({},e.numberColumns),e[t])})),e[t.Bool]=Object.assign(Object.assign({},e.boolColumns),e[t.Bool]),n.getDateDataTypes().forEach((t=>{e[t]=Object.assign(Object.assign({},e.dateColumns),e[t])}));const s=[...n.getStringDataTypes(),...n.getNumericDataTypes(),...n.getDateDataTypes(),t.Bool];n.getAllDataTypes().forEach((t=>{t in s||(e[t]=Object.assign(Object.assign({},e.otherColumns),e[t]))})),e[t.Unknown]=e.otherColumns}setSlot(t){if("string"==typeof t){if(t.length)if("#"===t[0])this.slot=document.getElementById(t.substring(1));else{if("."!==t[0])throw Error("Unrecognized slot parameter (Must be id, class or HTMLElement): "+t);{const e=document.getElementsByClassName(t.substring(1));e.length&&(this.slot=e[0])}}}else this.slot=t}init(t){t.onInit&&this.addEventListener("init",t.onInit),t.onRowClick&&this.addEventListener("rowClick",t.onRowClick),t.onRowDbClick&&this.addEventListener("rowDbClick",t.onRowDbClick),t.onPlusButtonClick&&this.addEventListener("plusButtonClick",t.onPlusButtonClick),t.onColumnChanged&&this.addEventListener("columnChanged",t.onColumnChanged),t.onColumnDeleted&&this.addEventListener("columnDeleted",t.onColumnDeleted),t.onColumnMoved&&this.addEventListener("columnMoved",t.onColumnMoved),t.onPageChanged&&this.addEventListener("pageChanged",t.onPageChanged),t.onActiveRowChanged&&this.addEventListener("activeRowChanged",t.onActiveRowChanged),this.addEventListener("pageChanged",(t=>this.activeRowIndex=-1)),n.assign(this.paginationOptions,t.pagination),this.pagination.pageSize=this.options.paging.pageSize||this.pagination.pageSize,this.options.allowDragDrop&&M.registerDropContainer({element:this.slot,scopes:["gridColumnMove"],onDragEnter:(t,e)=>{this.slot.classList.add(`${D}-drophover`),this.showLandingSlot(e.pageX,e.pageY)},onDragOver:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragLeave:(t,e)=>{e.dropEffect=I.Forbid,this.slot.classList.remove(`${D}-drophover`),this.hideLandingSlot()},onDrop:(t,e)=>{this.dataTable.columns.move(e.data.column,this.landingIndex),this.refresh(),this.fireEvent({type:"columnMoved",columnId:e.data.column.id,newIndex:this.landingIndex})}}),this.refresh(),this.fireEvent("init")}fireEvent(t){"string"==typeof t?this.eventEmitter.fire(t):this.eventEmitter.fire(t.type,t)}setData(t){this.dataTable=t,this.clear(),this.refresh()}getData(){return this.dataTable}getColumns(){return this.columns}destroy(){this.slot.innerHTML=""}refresh(){this.clearDOM(),this.render()}clearDOM(){this.slot.innerHTML=""}clear(){this.pagination.page=1,this.clearDOM()}render(){if(!this.hasData()&&!this.options.showPlusButton)return;this.containerInitialHeight=this.slot.clientHeight,this.rootDiv=document.createElement("div"),this.rootDiv.style.width="100%",this.rootDiv.classList.add(`${this.cssPrefix}-root`),this.columns.sync(this.dataTable.columns,this.options.useRowNumeration),this.renderHeader(),this.rootDiv.appendChild(this.headerDiv),this.renderBody(),this.rootDiv.appendChild(this.bodyDiv),this.renderFooter(),this.rootDiv.appendChild(this.footerDiv);let t=document.createElement("div");t.classList.add(`${this.cssPrefix}-container`),t.appendChild(this.rootDiv),this.slot.appendChild(t);const e=this.options.columnWidths.autoResize!==k.Never;this.rowsOnPagePromise?this.rowsOnPagePromise.then((()=>this.updateHeight())).then((()=>{this.firstRender=!1,this.rowsOnPagePromise=null})):setTimeout((()=>{this.updateHeight().then((()=>{this.firstRender=!1,e&&this.resizeColumns()}))}),100)}updateHeight(){return new Promise((t=>{if(this.options.viewportRowsCount){const e=this.bodyCellContainerDiv.firstElementChild;let s=(e?e.offsetHeight:36)*this.options.viewportRowsCount;return domel(this.bodyViewportDiv).setStyle("height",`${s}px`),void setTimeout((()=>{const e=this.bodyViewportDiv.offsetHeight-this.bodyViewportDiv.clientHeight;s+=e,domel(this.bodyViewportDiv).setStyle("height",`${s}px`),t()}),100)}this.containerInitialHeight,t()})).then((()=>{this.options.fixHeightOnFirstRender&&this.firstRender&&(this.slot.style.height=`${this.slot.offsetHeight}px`)}))}getContainerWidth(){return this.columns.getItems().filter((t=>t.isVisible)).map((t=>t.width)).reduce(((t,e)=>t+e))}renderHeader(){this.headerDiv=domel("div").addClass(`${this.cssPrefix}-header`).toDOM(),this.headerViewportDiv=domel("div",this.headerDiv).addClass(`${this.cssPrefix}-header-viewport`).toDOM(),this.headerCellContainerDiv=domel("div",this.headerViewportDiv).addClass(`${this.cssPrefix}-header-cell-container`).toDOM(),this.headerRowDiv=domel("div",this.headerCellContainerDiv).addClass(`${this.cssPrefix}-header-row`).toDOM(),this.columns.getItems().forEach(((t,e)=>{if(!t.isVisible)return;let s=this.renderColumnHeader(t,e);this.headerRowDiv.appendChild(s),t.isRowNum&&domel(s).addChildElement(this.renderHeaderButtons())}));const t=this.getContainerWidth();domel(this.headerCellContainerDiv).setStyle("width",`${t}px`)}hasData(){return this.dataTable.columns.count>0}renderColumnHeader(t,e){let s=domel("div").addClass(`${this.cssPrefix}-header-cell`).data("col-idx",`${e}`).setStyle("width",`${t.width}px`);t.dataColumn&&s.data("col-id",`${t.dataColumn.id}`);let i=s.toDOM();return domel("div",i).addClass(`${this.cssPrefix}-header-cell-resize`),t.isRowNum||domel("div",i).addClass(`${this.cssPrefix}-header-cell-label`).text(t.label),t.description&&domel("div",i).addClass("question-mark").title(t.description),this.options.allowDragDrop&&M.registerDraggableItem({element:i,scope:"gridColumnMove",data:{column:t},renderer:e=>{e.innerHTML="";const s=document.createElement("div");s.innerText=t.label,e.classList.add(`${this.cssPrefix}-sortable-helper`),e.appendChild(s)},onDragStart:t=>{t.dropEffect=I.Allow}}),i}renderBody(){this.bodyDiv=domel("div").addClass(`${this.cssPrefix}-body`).toDOM(),this.bodyViewportDiv=domel("div",this.bodyDiv).addClass(`${this.cssPrefix}-body-viewport`).attr("tabIndex","0").toDOM(),this.bodyCellContainerDiv=domel("div",this.bodyViewportDiv).addClass(`${this.cssPrefix}-cell-container`).toDOM();const t=this.canShowAggregates();this.dataTable&&(this.showProgress(),this.rowsOnPagePromise=this.getRowsToRender().then((e=>{this.pagination.total=this.dataTable.getTotal(),this.hideProgress(),this.bodyCellContainerDiv.innerHTML="",this.prevRowTotals=null;let s=0;if(e.length){const i=t?this.options.aggregates.settings.getGroups():[];s=e.length<this.pagination.pageSize?e.length:this.pagination.pageSize,e.forEach(((e,n)=>{if(t&&this.updateTotalsState(i,e),n<s){const t=this.renderRow(e,n);this.bodyCellContainerDiv.appendChild(t)}}));const n=this.options.aggregates&&this.options.aggregates.showGrandTotalsOnEachPage;if(t&&(this.isLastPage()||n)){const t=new DataRow(this.dataTable.columns,new Array(this.dataTable.columns.count));this.updateTotalsState(i,t,!0)}}if(this.options.columnWidths.autoResize!==k.Never)this.resizeColumns();else{const t=this.getContainerWidth();domel(this.bodyCellContainerDiv).setStyle("width",`${t}px`)}return s})).catch((t=>(console.error(t),0)))),this.bodyViewportDiv.addEventListener("scroll",(t=>{domel(this.headerViewportDiv).setStyle("margin-left",`-${this.bodyViewportDiv.scrollLeft}px`)})),this.bodyViewportDiv.addEventListener("keydown",this.onViewportKeydown.bind(this))}isLastPage(){return this.dataTable.elasticChunks?this.dataTable.totalIsKnown()&&this.pagination.page*this.pagination.pageSize>=this.pagination.total:this.pagination.page*this.pagination.pageSize>=this.pagination.total}canShowAggregates(){if(!this.options||!this.options.aggregates||!this.options.aggregates.settings)return!1;const t=this.options.aggregates.settings;return(t.hasAggregates()||t.hasRecordCount())&&(t.hasGroups()||t.hasGrandTotals())}updateTotalsState(t,e,s=!1){const i=this.options.aggregates.settings;if(this.prevRowTotals&&i.hasGroups()){let s=-1;for(let n=1;n<=t.length;n++){const o=t[n-1];for(const t of o.columns)if(!i.compareValues(this.prevRowTotals.getValue(t),e.getValue(t))){s=n;break}if(-1!==s)break}if(-1!==s)for(let e=t.length;e>=s;e--){const t=new DataRow(this.dataTable.columns,this.prevRowTotals.toArray()),s=this.renderTotalsRow(e,t);this.bodyCellContainerDiv.appendChild(s)}}if(s&&i.hasGrandTotals()&&i.hasAggregates()){const t=this.renderTotalsRow(0,e);this.bodyCellContainerDiv.appendChild(t)}this.prevRowTotals=e}applyGroupColumnTemplate(t,e,s){let i=t.replace(/{{\s*GroupValue\s*}}/g,e?`${e}`:"-");return i=i.replace(/{{\s*GroupCount\s*}}/g,s?`${s}`:"-"),i}renderTotalsRow(t,e){const s=this.options.aggregates.settings,i=t>0?s.getGroups()[t-1]:{columns:[],aggregates:s.getAggregates()},n=domel("div").addClass(`${this.cssPrefix}-row`).addClass(`${this.cssPrefix}-row-totals`).addClass(`${this.cssPrefix}-totals-lv${t}`).data("totals-level",`${t}`).attr("tabindex","-1").toDOM();this.columns.getItems().forEach(((t,s)=>{if(!t.isVisible)return;let o="";const r=t.isRowNum?-1:this.dataTable.columns.getIndex(t.dataColumn.id);!t.isRowNum&&t.dataColumn&&i.columns.indexOf(t.dataColumn.id)>=0&&(o=e.getValue(r)),r==this.dataTable.columns.count-1&&(o=".  .  .  .  .  ."),n.appendChild(this.renderCell(t,s,o,n))}));const o=this.options.aggregates.calculatorRef.getAggrContainer(),r=s.getAggregates().map((t=>t.colId)),a=s.buildGroupKey(i,e);return o.getAggregateData(t,a).then((o=>{for(const t of r)e.setValue(t,o[t]);n.innerHTML="",this.columns.getItems().forEach(((a,l)=>{if(!a.isVisible)return;let d="";const h=a.isRowNum?-1:this.dataTable.columns.getIndex(a.dataColumn.id);if(!a.isRowNum){let u=!1;if(a.dataColumn){const s=i.columns.indexOf(a.dataColumn.id),n=r.indexOf(a.dataColumn.id);u=t>0?s==i.columns.length-1:0==h,(s>=0||n>=0)&&(d=e.getValue(h))}let c="";if(t>0&&(c=a.dataColumn.groupFooterColumnTemplate,!c&&s.hasRecordCount()&&u&&(c="{{GroupValue}} ({{GroupCount}})")),c){d=this.renderCell(a,l,d,n).firstChild.innerHTML,d=this.applyGroupColumnTemplate(c,d,o[s.COUNT_FIELD_NAME])}}const u=this.renderCell(a,l,d,n);n.appendChild(u)}))})).catch((t=>console.error(t))),n}onViewportKeydown(t){if(this.options.showActiveRow){const e=this.bodyCellContainerDiv.querySelectorAll(`.${this.cssPrefix}-row`).length;let s;switch(t.key){case"ArrowLeft":case"ArrowRight":break;case"ArrowUp":t.preventDefault(),s=this.activeRowIndex<0||this.activeRowIndex>=e?e-1:this.activeRowIndex-1,this.activeRowIndex=s>=0?s:0;break;case"ArrowDown":t.preventDefault(),s=this.activeRowIndex<0||this.activeRowIndex>=e?0:this.activeRowIndex+1,this.activeRowIndex=s<e?s:e-1}}}ensureRowVisibility(t){const e="number"==typeof t?this.getDataRow(t):t;if(e){let t=e.getBoundingClientRect();const s=this.bodyViewportDiv.getBoundingClientRect(),i=t.top-s.top,n=t.bottom-s.top,o=this.bodyViewportDiv.clientHeight,r=window.innerHeight||document.documentElement.clientHeight;if(i>0&&n<=o&&t.top>0&&t.bottom<r)return;i<0?this.bodyViewportDiv.scrollTop=this.bodyViewportDiv.scrollTop+i:n>o&&(this.bodyViewportDiv.scrollTop=this.bodyViewportDiv.scrollTop+n-o),t=e.getBoundingClientRect(),t.top<0?document.documentElement.scrollTop=document.documentElement.scrollTop+t.top:t.bottom>r&&(document.documentElement.scrollTop=document.documentElement.scrollTop+t.bottom-r)}}getRowsToRender(){return!1===this.options.paging.enabled?Promise.resolve(this.dataTable.getCachedRows()):this.dataTable.getRows({offset:(this.pagination.page-1)*this.pagination.pageSize,limit:this.pagination.pageSize+1}).catch((t=>(console.error(t),[])))}renderFooter(){this.footerDiv=domel("div").addClass(`${this.cssPrefix}-footer`).toDOM(),this.rowsOnPagePromise&&this.rowsOnPagePromise.then((t=>{this.footerDiv.innerHTML="",this.footerPaginateDiv=this.renderPageNavigator(),this.footerDiv.appendChild(this.footerPaginateDiv);const e=this.renderPageInfoBlock(t);this.footerDiv.appendChild(e)}))}renderPageInfoBlock(t){const e=domel("div").addClass(`${this.cssPrefix}-page-info`).toDOM();if(this.dataTable.getTotal()>0){const s=t?(this.pagination.page-1)*this.pagination.pageSize+1:0,i=t?s+t-1:0;let n=this.dataTable.getTotal().toString();if(this.dataTable.elasticChunks){this.dataTable.getCachedCount()!==this.dataTable.getTotal()&&(n="?")}e.innerHTML=o.getText("GridPageInfo").replace("{FirstPageRecordNum}",`<span>${s.toString()}</span>`).replace("{LastPageRecordNum}",`<span>${i.toString()}</span>`).replace("{Total}",`<span>${n}</span>`)}return e}showProgress(){}hideProgress(){}getLocalIndexByGlobal(t){return this.pagination?t%this.pagination.pageSize:t}getGlobalIndexByLocal(t){return this.pagination?(this.pagination.page-1)*this.pagination.pageSize+t:t}renderRow(t,e){let s=this.getGlobalIndexByLocal(e),i=domel("div").addClass(`${this.cssPrefix}-row`).addClass(`${this.cssPrefix}-row-${e%2==1?"odd":"even"}`).data("row-idx",`${s}`).attr("tabindex","-1").on("click",(s=>{this.activeRowIndex=e,this.fireEvent({type:"rowClick",row:t,rowIndex:e,sourceEvent:s})})).on("dblclick",(s=>{this.fireEvent({type:"rowDbClick",row:t,rowIndex:e,sourceEvent:s})}));0==e&&i.addClass(`${this.cssPrefix}-row-first`);let n=i.toDOM();return this.options.showActiveRow&&e==this.activeRowIndex&&i.addClass(`${this.cssPrefix}-row-active`),this.columns.getItems().forEach(((e,i)=>{if(!e.isVisible)return;const o=e.isRowNum?-1:this.dataTable.columns.getIndex(e.dataColumn.id);let r=e.isRowNum?s+1:t.getValue(o);n.appendChild(this.renderCell(e,i,r,n))})),n}renderCell(t,e,s,i){const n=domel("div").addClass(`${this.cssPrefix}-cell`).data("col-idx",`${e}`).attr("tabindex","-1").setStyle("width",`${t.width}px`);t.align==A.LEFT?n.addClass(`${this.cssPrefix}-cell-align-left`):t.align==A.RIGHT?n.addClass(`${this.cssPrefix}-cell-align-right`):t.align==A.CENTER&&n.addClass(`${this.cssPrefix}-cell-align-center`);const o=n.toDOM(),r=o.appendChild(domel("div").addClass(`${this.cssPrefix}-cell-value`).toDOM()),a=this.getCellRenderer(t);return a&&a(s,t,r,i),o}getCellRenderer(t){let e;return e=t.isRowNum?this.cellRendererStore.getDefaultRendererByType(L.NUMBER):this.cellRendererStore.getDefaultRenderer(t.type),this.options&&this.options.onGetCellRenderer&&(e=this.options.onGetCellRenderer(t,e)||e),e}setPage(t){this.pagination.page=t,this.fireEvent({type:"pageChanged",page:t}),this.refresh(),this.bodyViewportDiv.focus()}renderPageNavigator(){let t=document.createElement("div");t.className=`${this.cssPrefix}-pagination-wrapper`;const e=this.dataTable.getTotal(),s=this.dataTable.getTotal(),i=this.pagination.pageSize,n=Math.ceil(s/i),r=this.paginationOptions.useBootstrap?"":`${this.cssPrefix}-`;if(!this.options.paging||!this.options.paging.enabled||e<=i)return t;const buttonClickHandler=t=>{const e=t.target;if(e.hasAttribute("data-page")){const t=parseInt(e.getAttribute("data-page"));this.setPage(t)}},renderPaginationItem=(t,e,s,i,n,o)=>{const a=document.createElement("li");if(a.className=`${r}page-item`,!i){n&&(a.className+=" active");const s=document.createElement("a");return s.setAttribute("href","javascript:void(0)"),s.innerHTML=e||t.toString(),s.setAttribute("data-page",`${t}`),s.className=`${r}page-link`,s.addEventListener("click",buttonClickHandler),o&&s.setAttribute("title",o),a.appendChild(s),a}let l=document.createElement("span");if(l.setAttribute("aria-hidden","true"),l.className=`${r}page-link`,s)a.className+=" disabled";else{if(this.paginationOptions.useBootstrap)l=document.createElement("a"),l.setAttribute("href","javascript:void(0)"),l.setAttribute("data-page",`${t}`);else{let e=document.createElement("a");e.setAttribute("href","javascript:void(0)"),e.setAttribute("data-page",`${t}`),l=e}l.className=`${r}page-link`,l.addEventListener("click",buttonClickHandler)}return l.innerHTML=e,o&&l.setAttribute("title",o),a.appendChild(l),a},a=this.pagination.page||1;let l=document.createElement("ul");if(l.className=`${r}pagination`,l.style.userSelect="none",t.appendChild(l),this.dataTable.elasticChunks){let t=renderPaginationItem(a-1,"&laquo;",1==a,!0,!1);l.appendChild(t),t=renderPaginationItem(a+1,"&raquo;",this.isLastPage(),!0,!1),l.appendChild(t)}else{if(n>10&&l.appendChild(renderPaginationItem(a-10,"&laquo;",a<=10,!0,!1,"Jump left on 10 pages")),l.appendChild(renderPaginationItem(a-1,"&lsaquo;",1==a,!0,!1,"Prev Page")),l.appendChild(renderPaginationItem(1,"1",1==a,!1,1===a)),n<=10)for(let t=2;t<n;t++)l.appendChild(renderPaginationItem(t,`${t}`,a===t,!1,a===t));else if(a<8){for(let t=2;t<=8;t++)l.appendChild(renderPaginationItem(t,`${t}`,!1,!1,a===t));n>8&&l.appendChild(renderPaginationItem(-1,"...",!0,!0,!1))}else if(a<=n&&a>n-8+1){n>8&&l.appendChild(renderPaginationItem(-1,"...",!0,!0,!1));for(let t=n-8+1;t<n;t++)l.appendChild(renderPaginationItem(t,`${t}`,a===t,!1,a===t))}else{l.appendChild(renderPaginationItem(-1,"...",!0,!0,!1));for(let t=3;t>0;t--)l.appendChild(renderPaginationItem(a-t,""+(a-t),!1,!1,!1));l.appendChild(renderPaginationItem(a,`${a}`,!1,!1,!0));for(let t=1;t<=3;t++)l.appendChild(renderPaginationItem(a+t,`${a+t}`,!1,!1,!1));l.appendChild(renderPaginationItem(-1,"...",!0,!0,!1))}(n>1||a<n)&&l.appendChild(renderPaginationItem(n,`${n}`,a===n,!1,a===n)),l.appendChild(renderPaginationItem(a+1,"&rsaquo;",a==n,!0,!1,"Next Page")),n>10&&l.appendChild(renderPaginationItem(a+10,"&raquo;",a>=n-10,!0,!1,"Jump right on 10 pages"))}if(this.options.paging.allowPageSizeChange){const selectChangeHandler=t=>{const e=parseInt(t.target.value);this.pagination.pageSize=e,this.pagination.page=1,this.refresh()},e=document.createElement("div");e.className=`${this.cssPrefix}-page-sizes`;const s=document.createElement("div");s.className=`kfrm-select ${this.cssPrefix}-page-sizes-select`,e.appendChild(s);const i=document.createElement("select"),n=this.options.paging.pageSizeItems||[],r=new Set(n);r.add(this.options.paging.pageSize||20),Array.from(r).forEach((t=>{const e=document.createElement("option");e.value=t.toString(),e.text=t.toString(),i.appendChild(e)})),i.value=(this.pagination.pageSize||20).toString(),s.appendChild(i),i.addEventListener("change",selectChangeHandler);const a=document.createElement("div");a.className=`${this.cssPrefix}-page-sizes-label`,e.appendChild(a);const l=document.createElement("span");l.innerText=o.getText("GridItemsPerPage"),a.appendChild(l),t.appendChild(e)}return t}addEventListener(t,e){return this.eventEmitter.subscribe(t,(t=>e(t.data)))}removeEventListener(t,e){this.eventEmitter.unsubscribe(t,e)}renderHeaderButtons(){return this.options.showPlusButton?domel("div").addClass(`${this.cssPrefix}-header-btn-plus`).title(this.options.plusButtonTitle||"Add").addChild("a",(t=>t.attr("href","javascript:void(0)").on("click",(t=>{t.preventDefault(),this.fireEvent({type:"plusButtonClick",sourceEvent:t})})))).toDOM():domel("span").addText("#").toDOM()}showLandingSlot(t,e){const s=this.headerRowDiv.querySelectorAll(`[class*=${this.cssPrefix}-table-col]`),i=[];for(let t=1;t<s.length;t++){const e=s[t];"none"!==e.style.display&&i.push(e)}if(0===i.length)return this.landingIndex=0,void this.headerRowDiv.appendChild(this.landingSlot);const n=getElementAbsolutePos(this.landingSlot);if(t>=n.x&&t<=n.x+this.landingSlot.offsetWidth)return;let o=this.landingIndex;for(let e of i){const s=getElementAbsolutePos(e),i=e.offsetWidth;t>s.x&&t<s.x+i&&(o=parseInt(e.getAttribute("data-col-idx"))-1)}o!=this.landingIndex&&(this.landingIndex=o,this.landingIndex<i.length?this.headerRowDiv.insertBefore(this.landingSlot,i[this.landingIndex]):this.headerRowDiv.appendChild(this.landingSlot))}hideLandingSlot(){this.landingIndex=-1,setTimeout((()=>{this.landingSlot.parentElement&&this.landingSlot.parentElement.removeChild(this.landingSlot)}),10)}get activeRowIndex(){return this._activeRowIndex}set activeRowIndex(t){if(t!==this._activeRowIndex){const e=this._activeRowIndex;this._activeRowIndex=t,this.updateActiveRow(),this.fireEvent({type:"activeRowChanged",oldValue:e,newValue:this.activeRowIndex,rowIndex:this.getGlobalIndexByLocal(this.activeRowIndex)})}}updateActiveRow(){if(this.options.showActiveRow){this.bodyCellContainerDiv.querySelectorAll(`[class*=${this.cssPrefix}-row-active]`).forEach((t=>{t.classList.remove(`${this.cssPrefix}-row-active`)}));const t=this.getActiveRow();t&&(t.classList.add(`${this.cssPrefix}-row-active`),this.ensureRowVisibility(this.activeRowIndex))}}getActiveRow(){return this.getDataRow(this.activeRowIndex)}getDataRow(t){const e=Array.from(this.bodyCellContainerDiv.querySelectorAll(`.${this.cssPrefix}-row:not(.${this.cssPrefix}-row-totals)`));return t>=0&&t<e.length?e[t]:null}focus(){this.bodyViewportDiv.focus()}resizeColumns(){if(this.options.columnWidths.autoResize===k.Never)return;const t=this.bodyCellContainerDiv.style.width;this.bodyCellContainerDiv.style.visibility="hidden",this.bodyCellContainerDiv.style.width="1px",this.headerRowDiv.style.width="1px";let e=0;const s=this.columns.getItems(),i=this.headerCellContainerDiv.querySelectorAll(`.${this.cssPrefix}-header-cell`);let o=0;for(let t=0;t<this.columns.count;t++){const r=s[t];if(!r.isVisible)continue;const a=this.options.columnWidths.autoResize!==k.Always&&r.dataColumn?r.dataColumn.calculatedWidth:0,l=this.bodyCellContainerDiv.querySelectorAll(`.${this.cssPrefix}-cell[data-col-idx="${t}"] > .${this.cssPrefix}-cell-value`);let d=0;if(a>0)e+=a,r.width=a,l.forEach((t=>{t.parentElement.style.width=`${a}px`})),i[o].style.width=`${a}px`;else if(0==l.length&&(i[o].style.width=null,i[o].style.whiteSpace="nowrap"),d=i[o].offsetWidth,l.length>0){l.forEach((t=>{t.parentElement.style.width=null;const e=t.parentElement.offsetWidth;e>d&&(d=e)})),d+=3;const t=r.isRowNum?this.options.columnWidths.rowNumColumn.max||500:this.options.columnWidths[r.dataColumn.type].max||2e3,s=r.isRowNum?this.options.columnWidths.rowNumColumn.min||0:this.options.columnWidths[r.dataColumn.type].min||20;d>t&&(d=t),d<s&&(d=s),n.isNumericType(r.type)&&(d=Math.round(1.3*d)),e+=d,r.width=d,l.forEach((t=>{t.parentElement.style.width=`${d}px`})),i[o].style.width=`${d}px`,r.dataColumn&&(r.dataColumn.calculatedWidth=d)}else e+=d;o++}e>0?(this.bodyCellContainerDiv.style.width=`${e}px`,this.headerCellContainerDiv.style.width=`${e}px`):(this.bodyCellContainerDiv.style.width=t,this.headerCellContainerDiv.style.width=t),this.bodyCellContainerDiv.style.visibility=null,this.headerRowDiv.removeAttribute("style")}}class Calendar{get cssPrefix(){return"kdtp-cal"}constructor(t,e){this.slot=t,this.options=e||{},this.options.yearRange||(this.options.yearRange="c-10:c+10")}setDate(t){this.currentDate=new Date(t)}getDate(){return new Date(this.currentDate)}dateChanged(t){this.options.onDateChanged&&this.options.onDateChanged(this.currentDate,t)}}class DateTimePicker{get cssPrefix(){return"kdtp"}constructor(t){this.calendar=null,this.timePicker=null,this.options=t,this.render()}setDateTime(t){this.currentDateTime=new Date(t),this.calendar&&this.calendar.setDate(this.currentDateTime),this.timePicker&&this.timePicker.setTime(this.currentDateTime)}getDateTime(){return new Date(this.currentDateTime)}render(){this.options.showCalendar&&(this.calendar=this.createCalendar({yearRange:this.options.yearRange,showDateTimeInput:this.options.showDateTimeInput,timePickerIsUsed:this.options.showTimePicker,oneClickDateSelection:this.options.oneClickDateSelection,onDateChanged:(t,e)=>{this.currentDateTime=t,this.timePicker&&this.timePicker.setTime(this.currentDateTime),this.options.showTimePicker&&this.dateTimeChanged(),e&&this.apply(this.currentDateTime)}}),this.calendar&&this.calendar.render()),this.options.showTimePicker&&(this.timePicker=this.createTimePicker({onTimeChanged:t=>{this.currentDateTime.setHours(t.getHours()),this.currentDateTime.setMinutes(t.getMinutes()),this.calendar&&this.calendar.setDate(this.currentDateTime),this.dateTimeChanged()}}),this.timePicker&&this.timePicker.render()),this.setDateTime(new Date)}createCalendar(t){return null}createTimePicker(t){return null}show(t){this.options.beforeShow&&this.options.beforeShow();const e=getElementAbsolutePos(t||document.body);this.slot.style.top=e.y+t.clientHeight+"px",this.slot.style.left=e.x+"px"}apply(t){this.options.onApply&&this.options.onApply(t),this.destroy()}cancel(){this.options.onCancel&&this.options.onCancel(),this.destroy()}destroy(){this.slot&&this.slot.parentElement&&this.slot.parentElement.removeChild(this.slot)}dateTimeChanged(){this.options.onDateTimeChanged&&this.options.onDateTimeChanged(this.currentDateTime)}}class DefaultCalendar extends Calendar{constructor(t,e){super(t,e),this.daysOfWeek=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],this.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],this.calendarBody=null,this.isManualInputChanging=!1;for(let t=0;t<this.daysOfWeek.length;t++)this.daysOfWeek[t]=o.getShortWeekDayName(t+1);for(let t=0;t<this.months.length;t++)this.months[t]=o.getLongMonthName(t+1)}setDate(t){super.setDate(t),this.selectedMonth=this.currentDate.getMonth(),this.selectedYear=this.currentDate.getFullYear(),this.rerenderMonth()}render(){const t=domel("div",this.slot).addClass(`${this.cssPrefix}-header`);this.options.showDateTimeInput?t.addChildElement(this.renderManualDateInput()):t.addChild("span",(t=>this.headerTextElem=t.toDOM())),domel(this.slot).addChildElement(this.renderCalendarButtons()),this.calendarBody=domel("div",this.slot).addClass(`${this.cssPrefix}-body`).toDOM()}getInputDateFormat(){const t=o.getLocaleSettings();return this.options.timePickerIsUsed?`${t.editDateFormat} ${t.editTimeFormat}`:t.editDateFormat}renderManualDateInput(){const t=this.getInputDateFormat(),e=domel("input").attr("placeholder",t).addClass(`${this.cssPrefix}-header-input`);return e.mask(t.replace("yyyy","9999").replace("MM","99").replace("dd","99").replace("HH","99").replace("mm","99").replace("ss","99")).on("input",(s=>{e.removeClass("error");try{this.isManualInputChanging=!0;const e=n.strToDateTime(this.manualInputElem.value,t);this.currentDate=e,this.jump(this.currentDate.getFullYear(),this.currentDate.getMonth()),this.dateChanged(!1)}catch(t){e.addClass("error")}finally{this.isManualInputChanging=!1}})).on("keydown",(t=>{13===t.keyCode&&(t.preventDefault(),t.stopPropagation(),this.manualInputElem.className.indexOf("error")<0&&!this.isManualInputChanging&&this.dateChanged(!0))})).on("focus",(()=>{setTimeout((()=>{this.manualInputElem.selectionStart=0,this.manualInputElem.selectionEnd=0}),50)})),this.manualInputElem=e.toDOM(),this.manualInputElem}updateDisplayedDateValue(){if(this.manualInputElem){if(!this.isManualInputChanging){const t=this.getInputDateFormat();this.manualInputElem.value=o.dateTimeToStr(this.currentDate,t),this.manualInputElem.focus()}}else if(this.headerTextElem){const t=o.getCurrentLocale();this.headerTextElem.innerText=this.currentDate.toLocaleString("en"==t?void 0:t,{year:"numeric",month:"long",day:"numeric"})}}renderCalendarButtons(){return domel("nav").addClass(`${this.cssPrefix}-nav`).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-prev`).on("click",(()=>{this.prev()})).addChild("span",(t=>t.html("&lsaquo;"))))).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-selectors`).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-month`).addChild("select",(t=>{t.on("change",(()=>{this.jump(this.selectedYear,parseInt(this.selectMonthElem.value))}));for(let e=0;e<this.months.length;e++)t.addChild("option",(t=>t.attr("value",e.toString()).text(this.months[e])));this.selectMonthElem=t.toDOM()})))).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-year`).addChild("select",(t=>this.selectYearElem=t.on("change",(()=>{this.jump(parseInt(this.selectYearElem.value),this.selectedMonth)})).toDOM())))))).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-next`).on("click",(()=>{this.next()})).addChild("span",(t=>t.html("&rsaquo;"))))).toDOM()}prev(){this.selectedYear=0===this.selectedMonth?this.selectedYear-1:this.selectedYear,this.selectedMonth=0===this.selectedMonth?11:this.selectedMonth-1,this.rerenderMonth()}next(){this.selectedYear=11===this.selectedMonth?this.selectedYear+1:this.selectedYear,this.selectedMonth=(this.selectedMonth+1)%12,this.rerenderMonth()}rerenderSelectYear(){const t=/c-(\d*):c\+(\d*)/g.exec(this.options.yearRange);let e=0,s=1;null!==t&&(e=parseInt(t[1]),s=parseInt(t[2])),this.selectYearElem.innerHTML="";for(let t=0;t<=e+s;t++){let s=document.createElement("option"),i=this.selectedYear-e+t;s.value=i.toString(),s.innerText=i.toString(),this.selectYearElem.appendChild(s)}}jump(t,e){this.selectedYear=t,this.selectedMonth=e,this.rerenderMonth()}rerenderMonth(){this.updateDisplayedDateValue(),this.rerenderSelectYear();let t=new Date(this.selectedYear,this.selectedMonth).getDay(),e=new Date(this.selectedYear,this.selectedMonth+1,0).getDate();this.calendarBody.innerHTML="",this.selectYearElem.value=this.selectedYear.toString(),this.selectMonthElem.value=this.selectedMonth.toString(),this.daysOfWeek.forEach(((t,e)=>{domel("div",this.calendarBody).addClass(`${this.cssPrefix}-weekday`).addClass(0==e||6==e?`${this.cssPrefix}-weekend`:"").text(t)}));for(let e=0;e<t;e++)domel("div",this.calendarBody).addClass(`${this.cssPrefix}-day-empty`);const s=new Date;for(let i=1;i<=e;i++){const e=domel("div",this.calendarBody).addClass(`${this.cssPrefix}-day`).attr("data-date",i.toString()).text(i.toString()).on("click",(t=>{this.currentDate.setFullYear(this.selectedYear),this.currentDate.setMonth(this.selectedMonth),this.currentDate.setDate(parseInt(t.target.getAttribute("data-date"))),this.dateChanged(this.options.oneClickDateSelection)}));i===s.getDate()&&this.selectedYear===s.getFullYear()&&this.selectedMonth===s.getMonth()&&e.addClass(`${this.cssPrefix}-day-current`),i===this.currentDate.getDate()&&this.selectedYear===this.currentDate.getFullYear()&&this.selectedMonth===this.currentDate.getMonth()&&e.addClass(`${this.cssPrefix}-day-selected`);const n=(t+i-1)%7;0!=n&&6!=n||e.addClass(`${this.cssPrefix}-weekend`),"function"==typeof this.options.onDrawDay&&this.options.onDrawDay.apply(e.toDOM(),[e.toDOM(),new Date(this.selectedYear,this.selectedMonth,i)])}const i=(t+e)%7,n=0==i?0:7-i;for(let t=0;t<n;t++)domel("div",this.calendarBody).addClass(`${this.cssPrefix}-day-empty`)}dateChanged(t){super.dateChanged(t),this.rerenderMonth()}}class TimePicker{get cssPrefix(){return"kdtp-tp"}constructor(t,e){this.slot=t,this.options=e||{}}setTime(t){this.currentTime=new Date(t)}getTime(){return new Date(this.currentTime)}timeChanged(){this.options.onTimeChanged&&this.options.onTimeChanged(this.currentTime)}}class DefaultTimePicker extends TimePicker{setTime(t){super.setTime(t),this.updateDisplayedTime(),this.hoursInput.valueAsNumber=t.getHours(),this.minutesInput.valueAsNumber=t.getMinutes()}render(){domel("div",this.slot).addClass(`${this.cssPrefix}-time`).addChild("span",(t=>this.timeText=t.toDOM())).toDOM();const t=domel("div",this.slot).addClass(`${this.cssPrefix}-sliders`);return t.addChild("div",(t=>t.addClass(`${this.cssPrefix}-time-row`).title("Hours").addChild("input",(t=>this.hoursInput=t.addClass(`${this.cssPrefix}-input-hours`).type("range").attr("min","0").attr("max","23").attr("step","1").on("input",(t=>{this.currentTime.setHours(this.hoursInput.valueAsNumber),this.updateDisplayedTime(),this.timeChanged()})).toDOM())))),t.addChild("div",(t=>t.addClass(`${this.cssPrefix}-time-row`).title("Minutes").addChild("input",(t=>this.minutesInput=t.addClass(`${this.cssPrefix}-input-minutes`).type("range").attr("min","0").attr("max","59").attr("step","1").on("input",(t=>{this.currentTime.setMinutes(this.minutesInput.valueAsNumber),this.updateDisplayedTime(),this.timeChanged()})).toDOM())))),this.slot}updateDisplayedTime(){const t=o.getCurrentLocale(),e=this.currentTime.toLocaleString("en"==t?void 0:t,{hour:"numeric",minute:"numeric"});this.timeText.innerText=e}}class DefaultDateTimePicker extends DateTimePicker{render(){const t=domel("div",document.body).addClass(`${this.cssPrefix}`).attr("tabIndex","0").setStyle("position","absolute").setStyle("top","-1000px").setStyle("left","-1000px").on("keydown",(t=>(27===t.keyCode?this.cancel():13===t.keyCode&&this.apply(this.getDateTime()),!1)));this.options.zIndex&&t.setStyle("z-index",`${this.options.zIndex}`),this.slot=t.toDOM(),super.render(),this.renderButtons(),this.globalMouseDownHandler=t=>{let e=window.event||t;return e.srcElement||e.target,!this.slot.contains(e.target)&&(document.removeEventListener("mousedown",this.globalMouseDownHandler,!0),this.cancel()),!0}}renderButtons(){const t=domel("div",this.slot).addClass(`${this.cssPrefix}-buttons`).addChild("button",(t=>this.nowButton=t.addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-now`).text(o.getText("ButtonNow")).on("click",(()=>(this.setDateTime(new Date),this.dateTimeChanged(),!1))).toDOM()));!this.options.showTimePicker&&this.options.oneClickDateSelection||t.addChild("button",(t=>this.submitButton=t.addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-apply`).text(o.getText("ButtonApply")).on("click",(()=>(this.apply(this.getDateTime()),!1))).toDOM())),t.addChild("button",(t=>this.submitButton=t.addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-cancel`).text(o.getText("ButtonCancel")).on("click",(()=>(this.cancel(),!1))).toDOM()))}createCalendar(t){return this.calendarSlot=domel("div",this.slot).addClass(`${this.cssPrefix}-cal`).toDOM(),new DefaultCalendar(this.calendarSlot,t)}createTimePicker(t){return this.timePickerSlot=domel("div",this.slot).addClass(`${this.cssPrefix}-tp`).toDOM(),new DefaultTimePicker(this.timePickerSlot,t)}show(t){if(this.options.showDateTimeInput){this.options.beforeShow&&this.options.beforeShow();const e=getElementAbsolutePos(t||document.body),s=getElementAbsolutePos(t?t.parentElement||t:document.body);this.slot.style.top=s.y+"px",this.slot.style.left=e.x+"px"}else super.show(t),this.slot.focus();setTimeout((()=>{document.addEventListener("mousedown",this.globalMouseDownHandler,!0)}),1)}}var R;!function(t){t[t.Left=1]="Left",t[t.Center=2]="Center",t[t.Right=3]="Right"}(R||(R={}));const O="kdlg";class DefaultDialogService{openConfirm(t,e,s){const i={title:t,closable:!1,submitable:!0,cancelable:!0,body:`<div id="${O}-dialog-confirm">${e}</div>`};return s?(i.onSubmit=()=>{s(!0)},i.onCancel=()=>{s(!1)},void this.open(i)):new Promise((t=>{i.onSubmit=()=>{t(!0)},i.onCancel=()=>{t(!1)},this.open(i)}))}openPrompt(t,e,s,i){const n={title:t,submitable:!0,closable:!0,cancelable:!0,submitOnEnter:!0,body:`<div id="${O}-dialog-form" class="kfrm-form">\n            <div class="kfrm-fields label-above">\n                <label for="${O}-dialog-form-input" id="${O}-dialog-form-content">${e}</label>\n                <input type="text" name="${O}-dialog-form-input" id="${O}-dialog-form-input" />\n            </div>\n        </div>`,arrangeParents:!1,beforeOpen:()=>{const t=document.getElementById(`${O}-dialog-form-input`);s&&(t.value=s),t.focus()}},processInput=t=>{const e=document.getElementById(`${O}-dialog-form-input`),s=e.value;return s&&s.replace(/\s/g,"").length>0?(t(s),!0):(e.classList.add("eqjs-invalid"),!1)};return i?(n.onSubmit=()=>processInput(i),n.onCancel=()=>{i("")},void this.open(n)):new Promise((t=>{n.onSubmit=()=>processInput(t),n.onCancel=()=>{t("")},this.open(n)}))}open(t,e){const s=new DefaultDialog(t,e),i=t.onDestroy;return t.onDestroy=t=>{this.untrack(t),i&&i(t)},s.open(),this.track(s),s}createSet(t){return new DefaultDialogSet(t,this)}untrack(t){const e=DefaultDialogService.openDialogs.indexOf(t);e>=0&&DefaultDialogService.openDialogs.splice(e,1)}track(t){DefaultDialogService.openDialogs.push(t)}openProgress(t){const e=new DefaultProgressDialog(t),s=t.onDestroy;return t.onDestroy=t=>{this.untrack(t),s&&s(t)},e.open(),this.track(e),e}getAllDialogs(){return Array.from(DefaultDialogService.openDialogs)}closeAllDialogs(){for(const t of Array.from(DefaultDialogService.openDialogs))t.close()}}DefaultDialogService.openDialogs=[];class DefaultDialog{constructor(t,e){this.options=t,this.submitHandler=t=>(!this.options.onSubmit||!1!==this.options.onSubmit(this,t))&&(this.destroy(),!0),this.cancelHandler=()=>{this.options.onCancel&&this.options.onCancel(this),this.destroy()},this.keydownHandler=t=>13!=t.keyCode||!this.isActiveDialog()||(t.preventDefault(),t.stopPropagation(),!this.submitHandler())||(window.removeEventListener("keydown",this.keydownHandler,!1),!1),this.dialogId=n.generateId("dlg"),this.data=e,this.slot=domel("div",document.body).attr("tab-index","-1").data("dialog-id",this.dialogId).addClass(`${O}-modal`,"is-active").focus().addChild("div",(t=>t.addClass("kdlg-modal-background"))).addChild("div",(s=>this.windowElement=s.addClass(`${O}-modal-window`).addChild("header",(e=>{this.headerElement=e.addClass(`${O}-header`).addChild("p",(e=>e.addClass(`${O}-header-title`).addText(t.title))).toDOM(),!1!==t.closable&&e.addChild("button",(t=>t.addClass(`${O}-modal-close`).on("click",(()=>{this.cancelHandler()})).focus()))})).addChild("div",(t=>{t.addClass(`${O}-alert-container`),this.alertElement=t.toDOM()})).addChild("section",(s=>{if(this.bodyElement=s.addClass(`${O}-body`).toDOM(),"string"==typeof t.body){const i=a.renderLiquidTemplate(t.body,e);s.addHtml(i)}else s.addChildElement(t.body)})).addChild("footer",(e=>{let s=null;s=t.footerAlignment&&t.footerAlignment==R.Center?"align-center":"align-right",this.footerElement=e.addClass(`${O}-footer`).toDOM(),e.addClass(s),!1!==t.submitable&&(e.addChild("button",(e=>{e.id(this.dialogId+"-btn-submit").addClass("kfrm-button","is-info").addText(t.submitButtonText||o.getText("ButtonOK")),t.recaptchaSiteKey?(e.data("sitekey",t.recaptchaSiteKey),e.addClass("g-recaptcha"),e.on("click",(e=>{grecaptcha?grecaptcha.ready((()=>{grecaptcha.execute(t.recaptchaSiteKey,{action:"submit"}).then((t=>{this.submitHandler(t)}))})):this.submitHandler()}))):e.on("click",(t=>{this.submitHandler()})),e.focus()})),!1!==t.cancelable&&e.addChild("button",(e=>e.id(this.dialogId+"-btn-cancel").addClass("kfrm-button").addText(t.cancelButtonText||o.getText("ButtonCancel")).on("click",(t=>{this.cancelHandler()})))))})).toDOM())).toDOM()}getData(){return this.data}getRootElement(){return this.slot}getSubmitButtonElement(){return document.getElementById(this.dialogId+"-btn-submit")}getCancelButtonElement(){return document.getElementById(this.dialogId+"-btn-cancel")}open(){this.options.beforeOpen&&this.options.beforeOpen(this),domel(this.slot).show(),this.options.arrangeParents&&this.arrangeParents(!0);const t=this.slot.querySelector(`.${O}-modal-window`);this.options.height&&(t.style.height="string"==typeof this.options.height?this.options.height:`${this.options.height}px`),this.options.width&&(t.style.width="string"==typeof this.options.width?this.options.width:`${this.options.width}px`),this.options.submitOnEnter&&window.addEventListener("keydown",this.keydownHandler,!1),this.slot.querySelectorAll("input").forEach((t=>t.addEventListener("input",(()=>{this.clearAlert(),this.options.onInput&&this.options.onInput(this)})))),this.options.onShow&&this.options.onShow(this)}submit(){this.submitHandler()}cancel(){this.cancelHandler()}close(){this.destroy()}disableButtons(){this.slot.querySelectorAll("button").forEach((t=>t.disabled=!0))}enableButtons(){this.slot.querySelectorAll("button").forEach((t=>t.disabled=!1))}showAlert(t,e,s){let i=domel("div").addClass(`${O}-alert ${e||""}`).addChild("span",(t=>t.addClass(`${O}-alert-closebtn`).text("").on("click",(t=>{const e=t.target.parentElement;e.parentElement.removeChild(e)})))).addText(t).toDOM();!0===s&&this.clearAlert(),this.alertElement.appendChild(i)}clearAlert(){this.alertElement.innerHTML=""}destroy(){document.querySelectorAll(`[data-dialog-id="${this.dialogId}"]`).length<=0||(this.options.arrangeParents&&this.arrangeParents(!1),document.body.removeChild(this.slot),this.options.submitOnEnter&&window.removeEventListener("keydown",this.keydownHandler,!1),this.options.onDestroy&&this.options.onDestroy(this))}isActiveDialog(){const t=document.documentElement.querySelectorAll(".kdlg-modal");return t[t.length-1]===this.slot}arrangeParents(t){const e=document.documentElement.querySelectorAll(".kdlg-modal-window");for(let s=0;s<e.length-1;s++)if(t){const t=0==s?20:40*s+20;domel(e[s]).setStyle("margin-top",`${t}px`).setStyle("margin-left",`${t}px`)}else domel(e[s]).removeStyle("margin-top").removeStyle("margin-left")}}class DefaultProgressDialog extends DefaultDialog{constructor(t,e){let s,i;const n=domel("div").addChild("div",(e=>s=e.text(t.content||"").toDOM())).addChild("div",(e=>{e.addClass(`${O}-progress-line`).addChild("div",(e=>{i=e.addClass("fill").toDOM(),t.determinated?e.setStyle("width","0%"):e.addClass("indeterminate")}))})).toDOM();super({title:t.title,body:n,beforeOpen:t.beforeOpen,onSubmit:t.onSubmit,width:t.width,height:t.height,submitable:!1,cancelable:!1,closable:!1,onDestroy:t.onDestroy},e),this.contentElement=s,this.progressElement=i}updateContent(t){this.contentElement.innerText=t}updateProgress(t){t=this.in01(t),this.progressElement.style.width=100*t+"%",1===t&&setTimeout((()=>{this.submit()}),500)}in01(t){return t>1?1:t<0?0:t}}class DefaultDialogSet{constructor(t,e){this.options=t,this.dialogService=e,this.currentDialog=null,this.currentIndex=0,this.options=t,this.dialogService=e}getCurrent(){return this.currentDialog}openNext(t){return this.open(this.currentIndex+1,t)}openPrev(t){return this.open(this.currentIndex-1,t)}open(t,e){if(t<0?this.currentIndex=0:t>=this.options.length?this.currentIndex=this.options.length-1:this.currentIndex=t,this.currentDialog)try{this.currentDialog.close()}catch(t){}const s=this.options[this.currentIndex];return this.currentDialog=this.dialogService.open(s,e),this.currentDialog}close(){this.currentDialog&&(this.currentDialog.close(),this.currentDialog=null)}}var F,q;function safeFocus(t){setTimeout((e=>{t&&t.focus()}),100)}!function addEasyDataUITexts(){o.updateDefaultTexts({GridPageInfo:"{FirstPageRecordNum} - {LastPageRecordNum} of {Total} records",GridItemsPerPage:"items per page",ButtonOK:"OK",ButtonCancel:"Cancel",ButtonApply:"Apply",ButtonNow:"Now",LblTotal:"Total"})}(),function(t){t[t.THIS_WEEK=0]="THIS_WEEK",t[t.LAST_WEEK=1]="LAST_WEEK",t[t.THIS_MONTH=2]="THIS_MONTH",t[t.FIRST_MONTH=3]="FIRST_MONTH",t[t.LAST_MONTH=4]="LAST_MONTH",t[t.THIS_YEAR=5]="THIS_YEAR",t[t.QUARTER_1=6]="QUARTER_1",t[t.QUARTER_2=7]="QUARTER_2",t[t.QUARTER_3=8]="QUARTER_3",t[t.QUARTER_4=9]="QUARTER_4"}(F||(F={})),function(t){t.UNDEF="-1",t.TODAY="1",t.YESTERDAY="2",t.TOMORROW="3",t.WEEK_START="4",t.WEEK_END="5",t.MONTH_START="6",t.MONTH_END="7",t.YEAR_START="8",t.YEAR_END="9"}(q||(q={}));const N="eqjs",$="eqjs-mobile";function getMobileCssClass(){return w.isMobileMode()?$:null}class EntitiesPanel extends Widget{get cssPrefix(){return"eqjs-ep"}constructor(t){super(t),this.queryChangedCallbackId=null,this.group=C.Model|C.Query,this.panel=t}getWidgetType(){return"entitiesPanel"}init(t,e){super.init(t,e),this.setOptions(e),this.renderProgressBlock()}refreshCore(){this.render(),this.options.syncWithColumns&&this.refreshCheckedStateByColumns()}onProcessStartCore(){this.options.showIndicatorOnLoad&&(this.progressBlock.parentNode||this.panel.appendChild(this.progressBlock))}onProcessEndCore(){this.options.showIndicatorOnLoad&&this.progressBlock.parentNode&&this.panel.removeChild(this.progressBlock)}destroyCore(){this.slot.innerHTML=""}setOptions(t){if(this.options={showToolbar:!0,syncWithColumns:!1,showSelectAllButton:!1,showClearSelectionButton:!0,showAddColumnButton:!0,showAddConditionButton:!0,showCheckboxes:!0,showTooltips:!0,draggableAttributes:!0,showAttributes:{useInConditions:!0,useInResult:!0,useInSorting:!1},showFilterBox:!1,filterBoxMode:0,showIndicatorOnLoad:!0,attrPlacement:0,sortEntities:!1,autoClearSelection:!0,entityRenderedCallback:null,attributeRenderedCallback:null},t&&n.assignDeep(this.options,t),this.queryChangedCallbackId){this.context.getQuery().removeChangedCallback(this.queryChangedCallbackId)}if(this.options.syncWithColumns){const t=this.context.getQuery();this.queryChangedCallbackId=t.addChangedCallback((t=>{const e=t.data;!e||e.part!=g.Columns&&e.part!=g.All||this.refreshCheckedStateByColumns()}))}}render(){let t=this.context.getModel();if(this.clear(),this.panel.classList.add(`${this.cssPrefix}-panel`),this.panel.classList.add(getMobileCssClass()),this.rootEntityBlock=document.createElement("div"),null!=t&&!t.isEmpty()){let e=t.getEntitiesTree({addUIC:this.options.showAttributes.useInConditions&&!this.options.syncWithColumns,addUIR:this.options.showAttributes.useInResult,addUIS:this.options.showAttributes.useInSorting&&!this.options.syncWithColumns,attrPlacement:this.options.attrPlacement,sortEntities:this.options.sortEntities,includeRootData:!0});this.entityTreeBlock=this.renderEntity(e,this.rootEntityBlock,0),this.panel.appendChild(this.entityTreeBlock)}this.options.showFilterBox?this.createFilterBox():this.rootEntityBlock.style.top="0",this.options.showToolbar&&!this.options.syncWithColumns?this.createToolPanel():this.rootEntityBlock.style.bottom="0"}renderEntity(t,e,s){let i,n=document.createElement("div");n.classList.add(`${this.cssPrefix}-entity-node`),n.classList.add(getMobileCssClass());let r=document.createElement("div");r.classList.add(`${this.cssPrefix}-entity-children`),r.classList.add(getMobileCssClass());let a=document.createElement("label");a.classList.add(`${this.cssPrefix}-entity-node-label`);let l=document.createElement("input");l.type="checkbox",l.title=t.text;let d,h,u,g=document.createElement("a");g.href="javascript:void(0)",g.title=`${o.getText("EntityToggle")} ${t.text}`,g.classList.add(`${this.cssPrefix}-entity-node-button`);let m=s,isAttributeInTree=(t,e)=>e.querySelectorAll(`.${this.cssPrefix}-entity-attr[data-id="${t}"]`).length>0;if(e?(i=e,i.innerHTML=""):i=document.createElement("div"),i.classList.add(`${this.cssPrefix}-entity`),i.classList.add(getMobileCssClass()),t.id&&""!=t.id){a.innerText=t.text,n.appendChild(a),this.options.showCheckboxes&&a.insertBefore(l,a.firstChild),n.insertBefore(g,n.firstChild),this.options.showTooltips&&t.description&&a.setAttribute("title",t.description);for(let t=0;t<m;t++){let t=document.createElement("div");t.classList.add(`${this.cssPrefix}-entity-offset`),n.insertBefore(t,n.firstChild)}i.appendChild(n),r.hidden=!0,m++}let f=t.items?t.items.length:0;for(let e=0;e<f;e++){let s=t.items[e];if(s.isEntity)r.appendChild(this.renderEntity(s,null,m));else if(!s.lookupAttr||!isAttributeInTree(s.lookupAttr,r)){h=document.createElement("label"),h.innerText=s.text,h.classList.add(`${this.cssPrefix}-entity-attr-label`),this.options.showCheckboxes&&(u=document.createElement("input"),u.type="checkbox",u.title=s.text,h.insertBefore(u,h.firstChild),this.options.syncWithColumns&&u.addEventListener("change",(t=>{const e=this.context.getModel(),s=this.context.getQuery(),i=t.currentTarget,n=i.parentElement.parentElement.getAttribute("data-id");if(e.checkAttrProperty(n,"useInResult"))if(i.checked){const t=e.getAttributeById(n),i=s.addColumn({attribute:t},!0);s.fireColumnsChangedEvent(p.Add,i)}else{const t=s.getColumns().filter((t=>t.expr.tag===c.EntityAttribute&&t.expr.value===n));t.length>0&&(s.removeColumn(t[0]),s.fireColumnsChangedEvent(p.Delete,t[0]))}}))),this.options.showTooltips&&s.description&&h.setAttribute("title",s.description);for(let t=0;t<m+1;t++){let t=document.createElement("div");t.classList.add(`${this.cssPrefix}-entity-offset`),h.insertBefore(t,h.firstChild)}d=document.createElement("div"),d.classList.add(`${this.cssPrefix}-entity-attr`),0==n.innerHTML.length&&d.classList.add(`${this.cssPrefix}-entity-attr-root`),d.innerHTML="",d.appendChild(h),d.setAttribute("data-id",s.id),this.options.draggableAttributes&&!this.options.syncWithColumns&&M.registerDraggableItem({element:d,scope:"entityAttr",data:{attrId:s.id},renderer:t=>{t.innerHTML="";const e=document.createElement("span");e.innerText=s.text,t.appendChild(e)}}),this.options.attributeRenderedCallback&&this.options.attributeRenderedCallback(d),r.appendChild(d)}}if(r.innerHTML.length&&(i.appendChild(r),g.addEventListener("click",(t=>{r.hidden=!r.hidden;let e=t.target,s=`${this.cssPrefix}-entity-node-button-open`;e.classList.contains(s)?e.classList.remove(s):e.classList.add(s),t.preventDefault()}))),r){const t=r.querySelectorAll(`.${this.cssPrefix}-entity-attr > label > input`);for(let e=0;e<t.length;e++){t[e].addEventListener("click",(t=>{t.target.checked&&!l.checked?l.checked=!0:0===r.querySelectorAll("input:checked").length&&(l.checked=!1),t.stopPropagation()}))}}return l.addEventListener("click",(t=>{let e=t.target;const s=r.querySelectorAll("label input");for(let t=0;t<s.length;t++){s[t].checked=e.checked}if(this.options.syncWithColumns){const t=this.context.getQuery(),s=this.context.getModel(),i=[],n=Array.from(r.querySelectorAll(`.${this.cssPrefix}-entity-attr`));for(const t of n){const e=t.getAttribute("data-id");s.checkAttrProperty(e,"useInResult")&&i.push(e)}if(e.checked)for(const e of i)t.addColumn({attributeId:e},!0);else{const e=t.getColumns().filter((t=>t.expr.tag===c.EntityAttribute&&i.indexOf(t.expr.value)>=0));t.removeColumns(e,null)}t.fireColumnsChangedEvent()}t.stopPropagation()})),e!=this.rootEntityBlock&&this.options.entityRenderedCallback&&this.options.entityRenderedCallback(i),i}createFilterBox(){this.filterBoxBlock=document.createElement("div"),this.filterBoxBlock.classList.add(`${this.cssPrefix}-filter-box`),this.filterBoxBlock.classList.add(getMobileCssClass()),this.filterBoxInput=document.createElement("input"),this.filterBoxInput.classList.add(`${this.cssPrefix}-filter-box-input`),this.filterBoxInput.addEventListener("input",(t=>{const e=this.panel.querySelectorAll(`.${this.cssPrefix}-entity-attr`);for(let t=0;t<e.length;t++){const s=e[t];s.hidden=!this.checkFilterAttribute(s)}const s=this.panel.querySelectorAll(`:scope > .${this.cssPrefix}-entity`);for(let t=0;t<s.length;t++){const e=s[t];let i=e.querySelectorAll(`.${this.cssPrefix}-entity-attr`),n=0;for(let t=0;t<i.length;t++)"None"!==i[t].style.display&&n++;e.hidden=0===n}""===this.filterBoxInput.value?this.collapseAll():this.expandAll()})),this.filterBoxBlock.appendChild(this.filterBoxInput),this.panel.insertBefore(this.filterBoxBlock,this.panel.firstChild)}createToolPanel(){let t=`${this.cssPrefix}-tool-panel`,e=document.createElement("div");e.classList.add(t),e.classList.add(getMobileCssClass());let s=document.createElement("div");s.classList.add(`${t}-select-all`),s.title="Select all";let i=document.createElement("div");i.classList.add(`${t}-deselect-all`),i.title="Clear selection";let n=document.createElement("div");n.classList.add(`${t}-add-columns`),n.title="Add column";let r=document.createElement("div");r.classList.add(`${t}-add-cond`),r.title="Add condition";let a=document.createElement("div");a.classList.add(`${t}-left-side`);let l=document.createElement("div");l.classList.add(`${t}-right-side`);let d=this.context.getModel();this.options.showSelectAllButton&&(s.title=o.getText("ButtonSelectAll"),a.appendChild(s),s.addEventListener("click",(()=>{this.selectAll()}))),this.options.showClearSelectionButton&&(i.title=o.getText("ButtonDeselectAll"),a.appendChild(i),i.addEventListener("click",(()=>{this.deselectAll()}))),this.options.showAddColumnButton&&(n.title=o.getText("ButtonAddColumns"),l.appendChild(n),n.addEventListener("click",(()=>{const t=this.panel.querySelectorAll(`.${this.cssPrefix}-entity-attr`);let e,s=[];const i=this.context.getQuery();i.fireProcessEvent({source:self,status:"start"});for(let i=0;i<t.length;i++){const n=t[i];n.getElementsByTagName("input")[0].checked&&(e=n.getAttribute("data-id"),d.checkAttrProperty(e,"useInResult")&&s.push(e))}for(let t of s){const e=d.getAttributeById(t);i.addColumn({attribute:e},!0)}i.fireChangedEvent(),this.options.autoClearSelection&&this.deselectAll(),i.fireProcessEvent({source:self,status:"finish"})}))),this.options.showAddConditionButton&&(r.title=o.getText("ButtonAddConditions"),l.appendChild(r),r.addEventListener("click",(()=>{let t,e=this.panel.querySelectorAll(`.${this.cssPrefix}-entity-attr`),s=[],i=this.context.getQuery();i.fireProcessEvent({source:self,status:"start"});for(let i=0;i<e.length;i++){const n=e[i];n.getElementsByTagName("input")[0].checked&&(t=n.getAttribute("data-id"),d.checkAttrProperty(t,"useInConditions")&&s.push(t))}for(let t of s)i.addSimpleCondition({attributeId:t});i.fireChangedEvent(),this.options.autoClearSelection&&this.deselectAll(),i.fireProcessEvent({source:self,status:"finish"})}))),e.appendChild(a),e.appendChild(l),this.panel.appendChild(e)}checkFilterAttribute(t){if(t.querySelector("label input").checked)return!0;const e=t.querySelector("label").textContent;if(this.checkFilterText(e))return!0;const s=t.parentElement.parentElement.querySelector(`.${this.cssPrefix}-entity-node`).querySelector("label").textContent;return!!this.checkFilterText(s)}checkFilterText(t){let e=this.filterBoxInput.value;return""==e||(0==this.options.filterBoxMode&&t.toLowerCase().indexOf(e.toLowerCase())>=0||1==this.options.filterBoxMode&&0==t.toLowerCase().indexOf(e.toLowerCase()))}refreshCheckedStateByColumns(){this.deselectAll();const t=this.context.getQuery().getColumns().filter((t=>t.expr.tag===c.EntityAttribute));for(const e of t){const t=this.rootEntityBlock.querySelector(`.${this.cssPrefix}-entity-attr[data-id="${e.expr.value}"]`);let s=t.querySelector("label > input");s.checked=!0;let i=t.parentElement;for(;i&&i.classList.contains(`${this.cssPrefix}-entity-children`);){i.hidden=!1;const t=i.parentElement;if(!t||i===t.firstElementChild)break;s=t.firstElementChild.querySelector("label > input"),s.checked=!0,i=t.parentElement}}}expandAll(){for(let t=0;t<this.rootEntityBlock.childNodes.length;t++){const t=this.rootEntityBlock.childNodes[0].querySelectorAll(`.${this.cssPrefix}-entity-children`);for(let e=0;e<t.length;e++){t[e].hidden=!1}}const t=this.rootEntityBlock.querySelectorAll(`.${this.cssPrefix}-entity-node-button`);for(let e=0;e<t.length;e++){t[e].classList.add(`${this.cssPrefix}-entity-node-button-open`)}}collapseAll(){for(let t=0;t<this.rootEntityBlock.childNodes.length;t++){const t=this.rootEntityBlock.childNodes[0].querySelectorAll(`.${this.cssPrefix}-entity-children`);for(let e=0;e<t.length;e++){t[e].hidden=!0}}const t=this.rootEntityBlock.querySelectorAll(`.${this.cssPrefix}-entity-node-button`);for(let e=0;e<t.length;e++){t[e].classList.remove(`${this.cssPrefix}-entity-node-button-open`)}}selectAll(){const t=this.entityTreeBlock.querySelectorAll("input");for(let e=0;e<t.length;e++){t[e].checked=!0}}deselectAll(){const t=this.entityTreeBlock.querySelectorAll("input");for(let e=0;e<t.length;e++){t[e].checked=!1}}renderProgressBlock(){this.progressBlock=document.createElement("div"),this.progressBlock.classList.add(`${N}-progress-win8`),this.progressBlock.classList.add(getMobileCssClass()),this.progressBlock.innerHTML='<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>'}clear(){this.panel.innerHTML=""}}class MenuLevel{get applyItem(){return this._applyItem}get cssPrefix(){return"eqjs-menu"}constructor(t){this.isFilteringMode=!1,this.showSelected=!1,this.parentMenu=t.menu||null,this.parentLevel=t.parent||null,this.parentElement=t.container||document.body,this.levelIndex=t.levelIndex||0,this.levelDiv=null,this.domWriteItemsId=t.domWriteItemsId||!1,this.menuId=t.menuId||"",this.itemRenderedCallback=t.itemRenderedCallback||null,this._applyItem={id:null,text:null,itemDiv:null},this.items=t.items||[],this.activeItem=null,this.selectedItem=null,this.initialized=!1,this.showSelected=t.showSelected,this.updated=0,this.renderContent()}getItems(){return this.items}setItems(t){this.items=t}renderContent(){if(!this.items)return;const t=this.parentMenu.style.colors.bgON||"white",e=this.parentMenu.style.colors.fgON||"black";this.parentMenu.style.colors.bgOVER;const s=this.parentMenu.style.itemStyle.fontFamily||"",i=this.parentMenu.style.itemStyle.fontSize||"14px",n=this.parentMenu.options.multiselect,r=this.parentMenu.options.isSubQuery,a=domel("div").addClass(getMobileCssClass());this.parentMenu.options.useDefaultStyles&&a.setStyle("backgroundColor",t).setStyle("border","1px solid").setStyle("borderColor",t).setStyle("backgroundColor",this.parentMenu.style.colors.border).setStyle("margin","-2px 2px 2px -2px").setStyle("width","auto").setStyle("height","auto"),a.setStyle("z-index",this.parentMenu.zIndex).setStyle("position","absolute").setStyle("display","none");let l=a.toDOM();l.menuLevel=this;const d=this._applyItem;if(n&&0===this.levelIndex&&!0!==this.parentMenu.options.hideButtons){const t=document.createElement("div");t.classList.add(`${this.cssPrefix}-applyDiv`),t.menuItem=d,this.applyBtn=document.createElement("button"),this.parentMenu.options.useDefaultStyles&&(t.style.borderBottom="1px solid",t.style.padding="5px",t.style.marginBottom="5px",this.applyBtn.style.padding="0 5px",this.applyBtn.style.cursor="pointer");const e=document.createTextNode(this.parentMenu.options.buttons.submit);this.applyBtn.appendChild(e),t.appendChild(this.applyBtn);const s=document.createElement("button");s.classList.add(`${this.cssPrefix}-cancel`),this.parentMenu.options.useDefaultStyles&&(s.style.padding="0 5px",s.style.cursor="pointer",s.style.marginLeft="15px");const i=document.createTextNode(this.parentMenu.options.buttons.cancel);s.appendChild(i),t.appendChild(s),l.appendChild(t),d.itemDiv=t,this.applyBtn.addEventListener("click",(()=>{this.submit(this._applyItem)})),s.addEventListener("click",(()=>{this.parentMenu.hideMenu()}))}if(null==this.parentLevel&&(this.parentMenu.options.searchBoxAlwaysShown||this.items.length>=this.parentMenu.options.showSearchBoxAfter)){const n=domel("div").addClass(`${this.cssPrefix}-searchDiv`);this.parentMenu.options.useDefaultStyles&&(n.setStyle("border-bottom","1px solid #666").setStyle("background-color",t).setStyle("border-color",this.parentMenu.style.colors.border),""!=s&&n.setStyle("font-family",s),n.setStyle("font-size",i).setStyle("color",e).setStyle("cursor","pointer").setStyle("text-align","left").setStyle("padding","5px"));const o=domel("input").id("searchBox").name("searchBox").type("text").size(16).addClass(`${this.cssPrefix}-searchBox`).on("input",(t=>{this.deactivateItem(this.activeItem),this.renderItems(this.searchBox.value)})).on("keydown",(t=>{switch(t.keyCode){case 13:this.activeItem&&this.activeItem.itemDiv.click();break;case 38:this.moveActiveItemUp();break;case 40:this.moveActiveItemDown();break;case 39:this.searchBox.value||this.openSubLevel(this.activeItem)}}));this.parentMenu.options.useDefaultStyles&&o.setStyle("font-family","monospace").setStyle("font-size","8pt").setStyle("width","100%"),r&&o.addClass("eqjs-dialog"),this.searchBox=o.toDOM(),this.searchDiv=n.toDOM(),this.searchDiv.appendChild(this.searchBox),l.appendChild(this.searchDiv)}const h=document.createElement("div");h.tabIndex=1,domel(h).addClass(`${this.cssPrefix}-scrollDiv`).addClass(getMobileCssClass()),h.style.overflowX="hidden",h.style.overflowY="auto",h.style.position="relative",l.appendChild(h),this.levelDiv=l,this.scrollDiv=h,this.menuId&&(this.levelDiv.id=this.menuId),this.parentLevel&&(this.levelDiv.style.zIndex=this.parentLevel.levelDiv.style.zIndex),this.renderItems();h.addEventListener("keydown",(t=>{switch(t.which){case 13:this.parentMenu.options.multiselect?this.parentMenu.getRootLevel().applyBtn.click():this.activeItem&&this.activeItem.itemDiv.click();break;case 32:this.activeItem&&this.activeItem.itemDiv.click();break;case 37:this.parentLevel&&!this.isFilteringMode&&(this.deactivateItem(this.activeItem),this.parentLevel.focus());break;case 39:this.openSubLevel(this.activeItem);break;case 38:this.moveActiveItemUp();break;case 40:this.moveActiveItemDown();break;default:return}t.preventDefault()})),w.isMobileMode()&&(this.closeDiv=domel("div",l).addClass("eqjs-menu-close-btn").addText(o.getText("ButtonClose")).on("click",(()=>{this.parentMenu.hideMenu()})).toDOM())}moveActiveItemDown(){const t=this.isFilteringMode?this.filteredItems:this.items;if(this.activeItem){const e=t.indexOf(this.activeItem);e<t.length-1&&this.activateItem(t[e+1],!1)}else this.activateItem(t[0],!1)}moveActiveItemUp(){const t=this.isFilteringMode?this.filteredItems:this.items;if(this.activeItem){const e=t.indexOf(this.activeItem);e>0&&this.activateItem(t[e-1],!1)}else this.activateItem(t[t.length-1],!1)}openSubLevel(t){t&&t.items&&!this.isFilteringMode&&(this.showSubLevel(t),t.subLevel.activateItem(t.subLevel.items[0]))}focusScrollDiv(){this.scrollDiv.focus()}turnCheckboxes(t){for(let e=0;e<t.length;e++){const s=t[e];s.itemCheckbox&&(s.itemCheckbox.checked=this.isItemSelected(s)),s.items&&this.turnCheckboxes(s.items)}}isItemSelected(t){if(t.items){for(var e=0;e<t.items.length;e++)if(this.isItemSelected(t.items[e]))return!0;return!1}return t.selected}setItemSelected(t,e){if(t.items)for(let s=0;s<t.items.length;s++)this.setItemSelected(t.items[s],e);else t.selected=e}submitItems(t,e){for(let s=0;s<t.length;s++)t[s].items?this.submitItems(t[s].items,e):t[s].selected&&e.push(t[s])}allSubitemsAreFiltered(t,e){for(let s=0;s<t.length;s++)if(e(t[s]))return!1;return!0}isItemDiv(t){return!!t.menuItem}isLevelDiv(t){return!!t.menuLevel}getMenuItem(t){let e=t;for(;!this.isItemDiv(e);){if(this.isLevelDiv(e))throw"Can't get menu item";e=e.parentElement}return e.menuItem}renderItemsWithoutFilter(){this.isFilteringMode=!1;const t=this.scrollDiv,e=this.parentMenu.options.multiselect,s=this.parentMenu.options.activateOnMouseOver,i=this.parentMenu.style.colors.fgON||"black";this.parentMenu.style.colors.bgOVER;const n=this.parentMenu.style.itemStyle.fontSize||"14px",o=this.parentMenu.getItemFilterCallback();t.innerHTML="";for(let a=0;a<this.items.length;a++){const l=this.items[a];if(!l||!l.text)continue;if(o){if(!o(l))continue;if(l.items&&this.allSubitemsAreFiltered(l.items,o))continue}l.data=t=>this[t],void 0===l.selected&&(l.selected=!1),l.selected&&null==this.selectedItem&&(this.selectedItem=l);const d=document.createElement("div");if(domel(d).addClass(`${this.cssPrefix}-itemDiv`).addClass(getMobileCssClass()),l.selected&&this.showSelected&&!e&&d.classList.add(`${this.cssPrefix}-selected`),this.domWriteItemsId&&this.menuId&&(d.id="item-"+this.menuId+"-"+l.id),t.appendChild(d),d.menuItem=l,d.menuLevel=this,l.itemDiv=d,this.parentMenu.options.useDefaultStyles&&(d.style.fontSize=n,d.style.color=i,d.style.paddingLeft="15px",d.style.paddingRight="6px",d.style.cursor="pointer"),"---"==l.text)d.appendChild(document.createElement("hr"));else{if(e){var r=document.createElement("input");r.type="checkbox",r.id="cb"+l.id,r.checked=this.isItemSelected(l),r.defaultChecked=this.isItemSelected(l),d.appendChild(r),l.itemCheckbox=r,this.parentMenu.options.useDefaultStyles&&(r.style.margin="4px 10px 0 0",r.style.verticalAlign="top")}let t=l.text;this.parentMenu.options.showItemIds&&(t=l.id+":"+t);const i=document.createTextNode(t);if(d.appendChild(i),l.items&&l.items.length>0){d.classList.add(`${this.cssPrefix}-itemDiv-hasChildren`);const t=document.createElement("span");t.classList.add(`${this.cssPrefix}-itemDiv-arrow`),d.appendChild(t);const e=document.createTextNode(">");t.appendChild(e)}const itemClickHandler=t=>{const s=this.getMenuItem(t.target);if(e)if(s.items&&t.target!=s.itemCheckbox)this.activateItem(s);else{const t=this.isItemSelected(s);this.setItemSelected(s,!t),s.itemCheckbox.checked=!t,this.parentMenu.refreshCheckboxes()}else this.activateItem(s),this.submit(s);return!1};d.removeEventListener("click",itemClickHandler),d.addEventListener("click",itemClickHandler),d.addEventListener("mouseenter",(t=>{const e=this.getMenuItem(t.target);this.parentMenu.isCursorInside=!0,s&&this.activateItem(e)})),d.addEventListener("mouseleave",(t=>{const e=this.getMenuItem(t.target);this.parentMenu.isCursorInside=!1,setTimeout((()=>{this.parentMenu.isCursorInside||s&&e==this.activeItem&&!e.subLevel&&this.deactivateItem(e)}),200)}))}this.itemRenderedCallback&&this.itemRenderedCallback(this.menuId,d)}}renderItemsWithFilter(t){this.isFilteringMode=!0;this.scrollDiv.innerHTML="";const e=t.split(">"),s=e.map((t=>t.replace(/\*/g,""))),i=this.filterItems(this.items,e);this.filteredItems=[];for(let t=0;t<i.length;t++)this.renderItemWithFilter(i[t],s,0)}matchesFilter(t,e){return!t||!e||e.test(t)}filterItems(t,e){const s=[],i=e.length>0?e[0]:"",o=e.length>1?e.slice(1):e,r=i?new RegExp(i.replace(/\*/g,".+?"),"i"):null;for(let i=0;i<t.length;i++){const a=t[i];if(a.items){const t=n.assign({},a),i=this.matchesFilter(a.text,r);e.length<2?i&&e.length<2?t.items=n.createArrayFrom(a.items):t.items=this.filterItems(a.items,o):t.items=i?this.filterItems(a.items,o):[],t.items.length>0&&s.push(t)}else this.matchesFilter(a.text,r)&&s.push(a)}return s}renderItemWithFilter(t,e,s){const i=this.scrollDiv,n=s<e.length?e[s]:e[e.length-1],o=this.parentMenu.options.multiselect,r=this.parentMenu.options.activateOnMouseOver,a=this.parentMenu.style.colors.fgON||"black";this.parentMenu.style.colors.bgOVER;const l=this.parentMenu.style.itemStyle.fontSize||"14px",d=this.parentMenu.getItemFilterCallback();if(!t||!t.text)return;if(d){if(!d(t))return;if(t.items&&this.allSubitemsAreFiltered(t.items,d))return}t.data=function(t){return this[t]},void 0===t.selected&&(t.selected=!1),t.selected&&null==this.selectedItem&&(this.selectedItem=t);const h=document.createElement("div");if(domel(h).addClass(`${this.cssPrefix}-itemDiv`).addClass(getMobileCssClass()),h.style.marginLeft=10*s+"px",t.selected&&!o&&h.classList.add(`${this.cssPrefix}-selected`),this.domWriteItemsId&&this.menuId&&(h.id="item-"+this.menuId+"-"+t.id),i.appendChild(h),h.menuItem=t,h.menuLevel=this,t.itemDiv=h,this.parentMenu.options.useDefaultStyles&&(h.style.fontSize=l,h.style.color=a,h.style.paddingLeft="15px",h.style.paddingRight="6px",h.style.cursor="pointer"),"---"==t.text)h.appendChild(document.createElement("hr"));else{if(o){var u=document.createElement("input");u.type="checkbox",u.id="cb"+t.id,u.checked=this.isItemSelected(t),u.defaultChecked=this.isItemSelected(t),h.appendChild(u),t.itemCheckbox=u,this.parentMenu.options.useDefaultStyles&&(u.style.margin="4px 10px 0 0",u.style.verticalAlign="top")}const e=document.createElement("span");if(e.innerHTML=this.highlightText(t.text,n),h.appendChild(e),t.items&&t.items.length>0)h.classList.add(`${this.cssPrefix}-itemDiv-filter-hasChildren`);else{this.filteredItems.push(t);const itemClickHandler=e=>{if(o)if(t.items&&e.target!=t.itemCheckbox)this.activateItem(t);else{const e=this.isItemSelected(t);this.setItemSelected(t,!e),t.itemCheckbox.checked=!e,this.parentMenu.refreshCheckboxes()}else this.activateItem(t),this.submit(t);return!1};h.removeEventListener("click",itemClickHandler),h.addEventListener("click",itemClickHandler),h.addEventListener("mouseenter",(e=>{this.parentMenu.isCursorInside=!0,r&&this.activateItem(t)})),h.addEventListener("mouseleave",(e=>{this.parentMenu.isCursorInside=!1,setTimeout((()=>{this.parentMenu.isCursorInside||r&&t==this.activeItem&&!t.subLevel&&this.deactivateItem(t)}),200)}))}}if(t.items)for(let i=0;i<t.items.length;i++)this.renderItemWithFilter(t.items[i],e,s+1);this.itemRenderedCallback&&this.itemRenderedCallback(this.menuId,h)}highlightText(t,e){if(e&&e.length>0){const s=e.toLowerCase(),i=t.toLowerCase(),n="<span class='eqjs-menu-itemDiv-highlight'>",o="</span>";if(i.indexOf(s)>=0){let r=0;const a=t,l=[];for(;;){const t=i.indexOf(s,r);if(t>=0?(l.push(t),r=t+e.length):r++,r>=a.length-1)break}if(l.length>0){t="";for(let s=0;s<l.length;s++)0===s&&(t+=a.substring(0,l[s])),t+=n+a.substring(l[s],l[s]+e.length)+o,s<l.length-1?t+=a.substring(l[s]+e.length,l[s+1]):t+=a.substring(l[s]+e.length)}}}return t}renderItems(t){t||w.isMobileMode()?(t=t||"",this.renderItemsWithFilter(t.toLowerCase())):this.renderItemsWithoutFilter()}activateItem(t,e=!0){null!=this.activeItem&&this.deactivateItem(this.activeItem),this.activeItem=t;const s=t.itemDiv;if(s.classList.add("active"),this.parentMenu.options.useDefaultStyles){this.parentMenu.style.colors.bgON,this.parentMenu.style.colors.fgON;const t=this.parentMenu.style.colors.bgOVER,e=this.parentMenu.style.colors.fgOVER||"";this.parentMenu.style.itemClass;""!=(this.parentMenu.style.itemClassOver||"")?(s.style.backgroundColor="",s.style.color=""):(s.style.backgroundColor=t,s.style.color=e)}t.items&&!this.isFilteringMode&&e&&this.showSubLevel(t)}deactivateItem(t){if(!t)return;const e=t.itemDiv;if(e.classList.remove("active"),this.parentMenu.options.useDefaultStyles){const t=this.parentMenu.style.colors.bgON,s=this.parentMenu.style.colors.fgON;""!=(this.parentMenu.style.itemClass||"")?(e.style.backgroundColor="",e.style.color=""):(e.style.backgroundColor=t,e.style.color=s)}t.subLevel&&t.subLevel.hide(),this.activeItem=null}showSubLevel(t){if(!t.subLevel){let e="";this.menuId&&(e=this.menuId+"-"+t.id),t.subLevel=new MenuLevel({showSelected:this.showSelected,menu:this.parentMenu,parent:this,container:this.parentElement,items:t.items,levelIndex:this.levelIndex+1,domWriteItemsId:this.domWriteItemsId,menuId:e,itemRenderedCallback:this.itemRenderedCallback})}const e=getElementAbsolutePos(t.itemDiv),s=getScrollPos(),i=getWinSize(),n=e.x-s.left,o=i.width-n-t.itemDiv.offsetWidth;e.x+=t.itemDiv.offsetParent.offsetWidth,e.y+=1,t.subLevel.showAt(e.x,e.y,!0,!0),t.subLevel.levelDiv.style.width="",t.subLevel.levelDiv.style.right="",o>=t.subLevel.levelDiv.offsetWidth||o>=n?o<t.subLevel.levelDiv.offsetWidth&&(t.subLevel.levelDiv.style.right=-s.left+"px"):(n<t.subLevel.levelDiv.offsetWidth?t.subLevel.levelDiv.style.left=s.left+4+"px":t.subLevel.levelDiv.style.left="",t.subLevel.levelDiv.style.right=getViewportSize().width-e.x+t.itemDiv.offsetWidth-6+"px"),t.subLevel.levelDiv.style.visibility="visible",t.subLevel.focus()}adjustTopPos(t){const e=getWinSize(),s=t-getScrollPos().top+this.levelDiv.offsetHeight;let i=t;return s>e.height-5&&(i-=s-e.height+5,i<getScrollPos().top&&(i=getScrollPos().top+10)),i}showAt(t,e,s,i){if(!this.items)return;this.initLevelDiv(),this.turnCheckboxes(this.items),this.renderItems();const n=this.levelDiv.style;i&&(this.levelDiv.style.visibility="hidden"),n.display="block",n.left=t+"px",n.top=e+"px",this.scrollDiv.style.width="auto",this.scrollDiv.style.height="auto",s&&(e=this.adjustTopPos(e),n.top=e+"px");let o=this.parentMenu.minItemWidth;if(o>0&&this.scrollDiv.offsetWidth<o)for(let t=0;t<this.items.length;t++)this.items[t].itemDiv.style.width=o+"px";let r=this.parentMenu.maxItemWidth;if(r>0&&this.scrollDiv.offsetWidth>r)for(let t=0;t<this.items.length;t++)this.items[t].itemDiv.style.width=r+"px",this.items[t].itemDiv.style.overflowX="hidden";let a=getWinSize().height-(e-getScrollPos().top)-15;if(this.parentMenu.maxHeight>0&&a>this.parentMenu.maxHeight&&(a=this.parentMenu.maxHeight),null!=this._applyItem&&null!=this._applyItem.itemDiv&&(a-=this._applyItem.itemDiv.offsetHeight+5),null!=this.searchDiv&&(a-=this.searchDiv.offsetHeight),null!=this.closeDiv&&(a-=this.closeDiv.offsetHeight),this.levelDiv.offsetHeight>a){let t=a;t<50&&(t=50),this.scrollDiv.style.height=t+"px"}else this.scrollDiv.style.height="auto";this.activeItem=null}focus(){window.setTimeout((()=>{this.scrollDiv.focus(),null!=this.searchBox&&(this.parentMenu.options.searchBoxAutoFocus&&this.searchBox.focus(),this.searchBox.value="")}),100)}hide(){(null!==this.activeItem&&this.activeItem.subLevel&&this.activeItem.subLevel.hide(),this.levelDiv)&&(this.levelDiv.style.display="none",this.initialized&&(this.parentElement.removeChild(this.levelDiv),this.initialized=!1))}initLevelDiv(){this.initialized||(this.parentElement.appendChild(this.levelDiv),domel(this.levelDiv).addClass(`${this.cssPrefix}-levelDiv`).addClass(getMobileCssClass()),this.initialized=!0)}submit(t){if(null!=t&&!t.items){this.parentMenu.hideMenu();let e=[];t==this._applyItem&&this.submitItems(this.items,e),this.parentMenu.submitMenu(t,e)}}remove(){for(let t=0;t<this.items.length;t++){let e=this.items[t];e.subLevel&&e.subLevel.remove()}if(this.levelDiv){this.levelDiv.innerHTML="";const t=this.levelDiv.parentNode;null!=t&&t.removeChild(this.levelDiv)}this.levelDiv=null}update(t){this.remove(),this.items=t,this.activeItem=null,this.selectedItem=null,this._applyItem.itemDiv=null,this.initialized=!1,this.updated++,this.renderContent()}refreshCheckboxes(){for(var t=0;t<this.items.length;t++){var e=this.items[t];e.itemCheckbox&&(e.itemCheckbox.checked=this.isItemSelected(e)),e.subLevel&&e.subLevel.refreshCheckboxes()}}refreshItems(){for(let t=0;t<this.items.length;t++){const e=this.items[t];e.itemDiv&&(e.hidden?e.itemDiv.style.display="none":e.itemDiv.style.display="block"),e.subLevel&&e.subLevel.refreshItems()}}findItem(t){const e=t.toLowerCase();for(let t=0;t<this.items.length;t++){const s=this.items[t];if(0==s.text.toLowerCase().indexOf(e))return s}return null}}class PopupMenu{get cssPrefix(){return"eqjs-menu"}constructor(t){this.isCursorInside=!1,this.mouseIsOverBlock=!1,this.mouseIsOverLink=!1,this.toId=null,this.active=!1,this.ancorFocused=null,this.options={items:[],buttons:{submit:o.getText("ButtonApply"),cancel:o.getText("ButtonCancel")},itemFilterCallback:null,useDefaultStyles:!1,multiselect:!1,adjustHeight:!0,showSearchBoxAfter:30,activateOnMouseOver:!0,container:document.body,domWriteItemsId:!1,itemRenderedCallback:null,showItemIds:!1},t&&(n.assign(this.options,t),n.assign(this.options.buttons,t.buttons)),this.options.hideButtons&&(this.options.submitOnBlur=!0),this.menuId=PopupMenu.lastMenuID++,this.updateProps(),this.rootLevel=new MenuLevel({menu:this,items:this.options.items,levelIndex:0,container:this.options.container,domWriteItemsId:this.options.domWriteItemsId,menuId:this.options.id,itemRenderedCallback:this.options.itemRenderedCallback,showSelected:this.options.showSelected}),this.rootLevel.levelDiv.classList.add(`${this.cssPrefix}-rootLevel`),this.options.zIndex&&(this.rootLevel.levelDiv.style.zIndex=`${this.options.zIndex}`),this.menuKeyUpHandler=t=>{27==t.which&&(this.hideMenu(),t.stopImmediatePropagation())},this.globalMouseDownHandler=t=>{if(!this.active)return!0;let e=window.event||t,s=e.srcElement||e.target,i=!0;for(;s;){if(s.tagName&&"div"==s.tagName.toLowerCase()&&s.menuLevel&&s.menuLevel.parentMenu==this){i=!1;break}s=s.parentNode||s.parentElement}return i&&(this.options.submitOnBlur&&this.rootLevel.submit(this.rootLevel.applyItem),this.hideMenu()),!0},this.render()}getItems(){return this.rootLevel.getItems()}updateProps(){this.style={},this.style.colors={border:"#666666",shadow:"#888888",bgON:"white",fgON:"black",bgOVER:"#B6BDD2",fgOVER:"black"},this.style.itemStyle={fontSize:"14px"},this.minItemWidth=0,this.maxItemWidth=0,this.maxHeight=0,this.zIndex=`${this.options.zIndex}`,this.commandTemplate="",this.args=[],this.active=!1}render(){}clearItemsMenuProps(t){if(t)for(var e=0;e<t.length;e++)this.clearItemMenuProps(t[e])}clearItemMenuProps(t){t.subLevel&&t.subLevel.parentMenu==this||(t.subLevel&&(t.subLevel.remove(),t.subLevel=null),t.itemDiv&&(t.itemDiv=null),t.items&&this.clearItemsMenuProps(t.items))}setSelectedItems(t,e){const s=t?t.length:0;for(let i=0;i<s;i++){const s=t[i];s.items?this.setSelectedItems(s.items,e):s.selected=e.indexOf(s.id)>=0}}getRootLevel(){return this.rootLevel}getItemFilterCallback(){return this.itemFilterCallback}showMenu(t){this.ancorFocused=t.anchor==document.activeElement?t.anchor:null,this.clearItemsMenuProps(this.options.items),this.itemSelectedCallback=t.itemSelectedCallback||null,this.menuClosedCallback=t.menuClosedCallback||null,this.itemFilterCallback=t.itemFilterCallback||null,t.items&&(this.options.items=t.items,this.rootLevel.setItems(t.items)),t.onMenuItemSelected&&(this.options.onMenuItemSelected=t.onMenuItemSelected);let e=t.selectedIds||null;if(e?"string"==typeof e&&(e=e.split(",")):e=[],this.active=!0,this.setSelectedItems(this.options.items,e),w.isMobileMode())this.rootLevel.showAt(0,0,!0,!0),this.rootLevel.levelDiv.style.top="0px",this.rootLevel.levelDiv.style.bottom="0px",this.rootLevel.levelDiv.style.right="0px",this.rootLevel.levelDiv.style.position="fixed",this.rootLevel.levelDiv.style.fontSize="20px";else{const e=t.anchor||document.documentElement,s=getElementAbsolutePos(e),i=e.offsetHeight,n=e.offsetWidth,o={x:s.x,y:s.y+i+2},r=getScrollPos(),a=getWinSize(),l=o.x+n-r.left,d=a.width-l+n;o.x+=2,this.rootLevel.showAt(o.x,o.y,!0,!0),this.rootLevel.levelDiv.style.width="",this.rootLevel.levelDiv.style.right="",this.rootLevel.levelDiv.style.zIndex||(this.rootLevel.levelDiv.style.zIndex=`${Math.max(1e4,function findHighestZIndex(t){let e=0;for(;null!==t;){const s=document.defaultView.getComputedStyle(t,null).getPropertyValue("z-index");if("auto"!=s){const t=parseInt(s);t>e&&(e=t)}t=t.parentElement}return e}(e)+1)}`),d>=this.rootLevel.levelDiv.offsetWidth||d>=l?d<this.rootLevel.levelDiv.offsetWidth&&(this.rootLevel.levelDiv.style.right=-r.left+"px"):(l<this.rootLevel.levelDiv.offsetWidth?this.rootLevel.levelDiv.style.left=r.left+4+"px":this.rootLevel.levelDiv.style.left="",this.rootLevel.levelDiv.style.right=getViewportSize().width-o.x-n+"px"),this.rootLevel.levelDiv.style.fontSize="14px"}this.rootLevel.levelDiv.style.visibility="visible",this.rootLevel.focus(),document.addEventListener("keyup",this.menuKeyUpHandler),document.addEventListener("mousedown",this.globalMouseDownHandler,!0)}hideMenu(){document.removeEventListener("mousedown",this.globalMouseDownHandler,!0),document.removeEventListener("keyup",this.menuKeyUpHandler),this.rootLevel.hide(),this.ancorFocused&&this.ancorFocused.focus(),this.menuClosedCallback&&this.menuClosedCallback()}submitMenu(t,e){this.itemSelectedCallback&&this.itemSelectedCallback(t,e)}knockMenuStyle(t){t.removeAttribute("style");const e=t.querySelectorAll("ul").item(0);!1!==!(!e||!e.style)&&e.setAttribute("style","")}refreshItems(){this.rootLevel.refreshItems()}refreshCheckboxes(){this.rootLevel.refreshCheckboxes()}}PopupMenu.lastMenuID=0;class DisplayFormatParser{constructor(){this.formatStr="",this.pos=0,this.token="text",this.tokenText=""}start(t){this.formatStr=t,this.pos=0,this.tokenText=""}skipSpaces(){for(;this.pos<this.formatStr.length&&" "===this.formatStr.charAt(this.pos);)this.pos++}getToken(){return this.token}getTokenText(){return this.tokenText}next(){if(this.skipSpaces(),this.pos>=this.formatStr.length)return!1;let t=0;if("{"===this.formatStr.charAt(this.pos)){if(t=this.formatStr.indexOf("}",this.pos),t<0)return!1;this.tokenText=this.formatStr.substring(this.pos,t+1),0!==this.tokenText.indexOf("{expr")&&0!==this.tokenText.indexOf("{attr")||(this.token="expression"),this.pos=t+1}else if("["===this.formatStr.charAt(this.pos)&&this.pos<this.formatStr.length-1&&"["===this.formatStr.charAt(this.pos+1))this.pos+=2,t=this.formatStr.indexOf("]]",this.pos),this.token="function",this.tokenText=this.formatStr.substring(this.pos,t),this.pos=t+2;else{this.token="text";let e=this.formatStr.indexOf("{",this.pos);e<0&&(e=this.formatStr.length);let s=this.formatStr.indexOf("[[",this.pos);s<0&&(s=this.formatStr.length),t=Math.min(e,s),this.tokenText=this.formatStr.substring(this.pos,t).trim(),this.pos=t}return!0}}var Q,H,W,_,V,G,z;!function(t){t[t.Enable=0]="Enable",t[t.Delete=1]="Delete",t[t.Hidden=2]="Hidden",t[t.SortingNone=3]="SortingNone",t[t.SortingAsc=4]="SortingAsc",t[t.SortingDesc=5]="SortingDesc",t[t.MoveTop=6]="MoveTop",t[t.MoveUp=7]="MoveUp",t[t.MoveDown=8]="MoveDown",t[t.MoveBottom=9]="MoveBottom",t[t.Menu=10]="Menu",t[t.Type=11]="Type",t[t.Format=12]="Format"}(Q||(Q={}));class ColumnRendererCP{constructor(t,e,s){this.functionMenu=null,this.formatsMenu=null,this.buttonMenu=null,this.isMouseOverBlock=!1,this.keepShowingButtons=!1,this.panel=t,this.column=e,this.element=s}get cssPrefix(){return"eqjs-qc"}get columnEnabled(){return this.column.enabled}set columnEnabled(t){this.column.enabled=t}render(){this.getButtonsToShow().indexOf("sorting")>=0&&this.columnEnabled&&(this.sortingButton=this.renderSoringButton(this.column.sorting),this.column.sorting!==m.None&&(this.sortingButton.style.display="block"));const t=domel("div");t.data("id",this.column.id),this.element&&this.element.parentNode.replaceChild(t.toDOM(),this.element),this.element=t.toDOM(),this.panel.options.allowDragDrop&&!w.isMobileMode()&&M.registerDraggableItem({element:this.element,scope:"entityAttrSort",data:{column:this.column},beforeDragStart:()=>{this.hideButtons()},renderer:t=>{t.innerHTML="";const e=document.createElement("span");e.innerText=this.column.caption,t.classList.add("eqjs-sortable-helper"),t.appendChild(e)},onDragStart:t=>{this.element.style.display="none",t.dropEffect=I.Allow},onDragEnd:t=>{t.data.finishedSuccessfully||this.element.style.removeProperty("display")}}),this.isEditable()&&(this.createFunctionMenu(),this.createFormatsMenu()),this.createButtonMenu(),t.addClass(this.getClassesToAdd()).addClass(getMobileCssClass()).addChildElement(this.renderCheckbox()).addChild("div",(t=>t.addClass(`${N}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-colelement`,`${this.cssPrefix}-sortbutton-placeholder`).addChildElement(this.sortingButton))),t.addChildElement(this.renderExpressionBlock()),!1===this.panel.options.showColumnTitles||w.isMobileMode()||t.addChildElement(this.renderCaptionBlock());let e=0,s="";return t.addChild("div",(t=>{t.addClass(`${N}-column-buttonsBlock`,`${this.cssPrefix}-buttonsBlock`).addClass(getMobileCssClass()),this.getButtonsToShow().indexOf("enable")>=0&&!this.column.isReadOnly()&&(t.addChildElement(this.renderEnabledButton()),e++,s+="Enable"),this.getButtonsToShow().indexOf("type")>=0&&this.columnEnabled&&(t.addChildElement(this.renderColumnTypeButton()),e++,s+="Type"),this.getButtonsToShow().indexOf("format")>=0&&this.columnEnabled&&(t.addChildElement(this.renderColumnFormatButton()),e++,s+="Format"),this.getButtonsToShow().indexOf("delete")>=0&&!this.column.isReadOnly()&&(t.addChildElement(this.renderDeleteButton()),e++,s+="Delete"),this.getButtonsToShow().indexOf("menu")>=0&&!this.column.isReadOnly()&&(t.addChildElement(this.renderMenuButton()),e++,s+="Menu")})),t.addClass(`eqjs-buttons-in-block-${e}`),t.addClass(`eqjs-buttons-in-block-${s}`),w.isMobileMode()||t.on("mouseenter",this.onMouseEnter.bind(this)).on("mouseleave",this.onMouseLeave.bind(this)),(this.panel.options.accentActiveColumn||w.isMobileMode())&&t.on("click",this.onMouseClick.bind(this)),this.panel.options.alwaysShowButtons&&this.showButtons(),!1===this.panel.options.showCheckboxes&&t.addClass("eqjs-no-checkbox"),this.element}onMouseClick(t){return t.stopPropagation(),this.activate(),!1}activate(){this.panel.toggleColumnPicked(this.column),this.adjustButtonsVisibility(),w.isMobileMode()||this.element.dispatchEvent(createBrowserEvent("mouseenter"))}fireColumnChanged(){this.column.fireChangedEvent()}refresh(){this.render()}renderCaptionBlock(){const t=domel("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-captionelement`).addClass(getMobileCssClass());return this.isEditable()?t.addChild("a",(t=>t.attr("href","javascript:void(0)").title(this.column.caption).text(this.column.caption).on("click",(t=>{t.stopPropagation(),this.activate();const e=t.target,s=e.parentElement.querySelector("input");return s&&(e.style.display="none",s.style.removeProperty("display"),s.style.minWidth=`${e.clientWidth}`,s.focus(),this.element.setAttribute(M.DRAG_DISABLED_ATTR,"")),!1})))).addChild("input",(t=>t.hide().value(this.column.caption).on("blur keydown",(t=>{let e=!1,s=!0;if(t instanceof KeyboardEvent?13===t.keyCode?e=!0:27===t.keyCode&&(e=!0,s=!1):t instanceof FocusEvent&&(e=!0),e){const e=t.target,i=e.parentElement.querySelector("a");i&&(i.style.removeProperty("display"),e.style.display="none"),s&&this.column.caption!==e.value?(this.column.caption=e.value,this.fireColumnChanged()):(e.value=this.column.caption,safeFocus(i)),this.element.removeAttribute(M.DRAG_DISABLED_ATTR)}return!0})))):t.addChild("span",(t=>{t.text(this.column.caption).title(this.column.caption)})),t.toDOM()}renderSoringButton(t){const e=`${N}-column-sortbutton`;let s;switch(t){case m.Ascending:s=`${e}-asc`;break;case m.Descending:s=`${e}-desc`;break;default:s=`${e}-none`}return!this.isEditable()||w.isMobileMode()?t===m.Ascending||t===m.Descending?domel("div").addClass(e,`${N}-button`,s).title(o.getText("ButtonSorting")).toDOM():null:domel("div").addClass(e,`${N}-button`,s).data("btnplaceholder","").title(o.getText("ButtonSorting")).attr("tabIndex","0").on("click",(t=>{t.stopPropagation(),this.activate(),this.keepShowingButtons=!0;(this.getUIS()&&this.panel.sortMenu||this.panel.moveMenu).showMenu({anchor:this.sortingButton,selectedIds:this.getButtonMenuSelectedItems(),itemSelectedCallback:(t,e)=>{let s;switch(t.id){case"IsHidden":s=Q.Hidden;break;case"MoveTop":s=Q.MoveTop;break;case"MoveDown":s=Q.MoveDown;break;case"MoveUp":s=Q.MoveUp;break;case"MoveBottom":s=Q.MoveBottom;break;case"None":s=Q.SortingNone;break;case"Ascending":s=Q.SortingAsc;break;case"Descending":s=Q.SortingDesc}this.buttonMenuHandler(s,null)},menuClosedCallback:()=>{this.keepShowingButtons=!1,this.isMouseOverBlock||this.leaveButtonBlock()}})})).on("keypress",(t=>{13==t.keyCode&&t.target.click()})).toDOM()}renderCheckbox(){return this.panel.options.showCheckboxes&&!this.column.isReadOnly()?domel("div").title(o.getText("CmdToggleEnable")).attr("tabIndex","0").addClass(`${this.cssPrefix}-colelement ${this.cssPrefix}-column-checkbox`).addClass(""+(this.columnEnabled?"enabled":"")).on("click",(()=>(this.columnEnabled=!this.columnEnabled,this.column.fireChangedEvent(),!1))).on("keypress",(t=>{[13,32].includes(t.keyCode)&&t.target.click()})).toDOM():null}renderDeleteButton(){return domel("div").addClass(`${N}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-deletebutton-placeholder`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${N}-button`,`${N}-column-button`,`${N}-column-button-delete`).title(o.getText("CmdDelete")).attr("tabIndex","0").on("click",(t=>this.buttonMenuHandler(Q.Delete,t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})))).toDOM()}renderMenuButton(){return domel("div").addClass(`${N}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-menubutton-placeholder`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${N}-button`,`${N}-column-button`,`${N}-column-button-menu`).title(o.getText("ButtonMenu")).attr("tabIndex","0").on("click",(t=>this.buttonMenuHandler(Q.Menu,t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})))).toDOM()}getClassesToAdd(){let t="";return t+=this.columnEnabled?"":` ${this.cssPrefix}-disabled`,this.columnEnabled&&(t+=this.column.isReadOnly()?` ${this.cssPrefix}-readonly`:""),t+=this.column.isHidden()?` ${this.cssPrefix}-hidden`:"",t}renderColumnTypeButton(){return this.isEditable()&&!1!==this.panel.options.allowAggrColumns?domel("div").addClass(`${N}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-typebutton-placeholder`,`${this.cssPrefix}-button-active`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${N}-button`,`${N}-column-button`,`${N}-column-button-type`).title(o.getText("ButtonToAggr")).attr("tabIndex","0").on("click",(t=>{t.stopPropagation(),this.activate(),this.keepShowingButtons=!0,this.changeTypeHandler(t)})).on("keypress",(t=>{13==t.keyCode&&t.target.click()})))).toDOM():null}renderColumnFormatButton(){const t=this.getFormatsMenuItems();return this.isEditable()&&!1!==this.panel.options.allowDisplayFormatChange&&t.length>1?domel("div").addClass(`${N}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-formatbutton-placeholder`,`${this.cssPrefix}-button-active`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${N}-button`,`${N}-column-button`,`${N}-column-button-format`).title(o.getText("ButtonFormat")).attr("tabIndex","0").on("click",(t=>{t.stopPropagation(),this.keepShowingButtons=!0,this.changeFormatHandler(t)})).on("keypress",(t=>{13==t.keyCode&&t.target.click()})))).toDOM():null}renderEnabledButton(){return domel("div").addClass(`${N}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-enablebutton-placeholder`,`${this.cssPrefix}-button-active`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${N}-button`,`${N}-column-button`,`${N}-column-button-enable`).title(o.getText("CmdToggleEnable")).addClass(this.columnEnabled?"enabled":"").attr("tabIndex","0").on("click",(t=>this.buttonMenuHandler(Q.Enable,t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})))).toDOM()}isEditable(){return this.columnEnabled&&!this.column.isReadOnly()}changeFormatHandler(t){const e=this.panel.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());let s="{0:__default}";e.filter((t=>t.format==this.column.displayFormat)).length>0&&(s=this.column.displayFormat),this.formatsMenu.showMenu({anchor:t.target,selectedIds:s,itemSelectedCallback:(t,e)=>(t.id!=s&&("{0:__default}"==t.id?this.column.displayFormat="":this.column.displayFormat=t.id,this.column.fireChangedEvent()),!1),menuClosedCallback:()=>{this.keepShowingButtons=!1,this.isMouseOverBlock||this.element.dispatchEvent(createBrowserEvent("mouseleave"))}})}getUIS(){return this.panel.getContext().getModel().checkAttrProperty(this.column.expr.value,"useInSorting")}onMouseEnter(t){return this.isMouseOverBlock=!0,this.enterButtonBlock(),t.stopPropagation(),!1}onMouseLeave(t){return this.isMouseOverBlock=!1,this.leaveButtonBlock(),t.stopPropagation(),!1}isColumnActive(){return this.element.classList.contains("active")}hideButtons(){domel(this.element).data("show-buttons",null)}showButtons(){domel(this.element).data("show-buttons","")}adjustButtonsVisibility(){(this.panel.options.alwaysShowButtons||(this.panel.options.accentActiveColumn||w.isMobileMode())&&this.isColumnActive())&&this.showButtons()}enterButtonBlock(){this.showButtons()}leaveButtonBlock(){this.keepShowingButtons||!0===this.panel.options.alwaysShowButtons||this.isColumnActive()&&1==this.panel.options.accentActiveColumn||this.hideButtons()}createFunctionMenu(){const t=[],e=this.panel.getContext().getModel().getAggrFunctions();let s=!0,i=null;const n=this.column.getDataType();let r;for(const o of e){if(!o)continue;const e=o.getAppliedTypesOrDefault().indexOf(n)>=0;this.column.expr.func!==o.id||e||(s=!1),e&&(r=this.panel.getContext().getModel().getAggrFunctionCaption(o.id),i={id:o.id,text:r},t.push(i))}s||(this.column.expr.func=t[0].id);this.panel.areCustomExpressionsAllowed()&&(i={id:"CustomSqlDivider",text:"---"},t.push(i),r=o.getText("CustomExpression"),i={id:"CUSTOMSQL",text:r},t.push(i));let a=this.column.id;a&&(a+="-FunctionsMenu");const l={items:t,id:a,searchBoxAlwaysShown:!1,domWriteItemsId:!0};this.functionMenu=new PopupMenu(l)}createFormatsMenu(){if(0==this.panel.options.allowDisplayFormatChange)return;let t=this.column.id;t&&(t+="-FormatsMenu");const e={items:this.getFormatsMenuItems(),id:t,searchBoxAlwaysShown:!1,showSelected:!0,domWriteItemsId:!0};this.formatsMenu=new PopupMenu(e)}getFormatsMenuItems(){const t=this.panel.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());return[{id:"{0:__default}",text:"Default"}].concat(t.map((t=>({id:t.format,text:o.getText("DisplayFormats",t.name)||t.name}))))}getButtonsToShow(){return this.panel.options.buttons&&Array.isArray(this.panel.options.buttons)?this.panel.options.buttons:["enable","delete","type","sorting","format"]}buttonMenuHandler(t,e){switch(t){case Q.Delete:const s=this.column.getQuery();s.removeColumn(this.column),s.fireColumnsChangedEvent(p.Delete,this.column);break;case Q.Enable:this.activate(),this.columnEnabled=!this.columnEnabled,this.fireColumnChanged();break;case Q.Hidden:this.column.setHidden(!this.column.isHidden()),this.fireColumnChanged();break;case Q.MoveTop:this.panel.moveColumn(this.column,"MoveTop");break;case Q.MoveBottom:this.panel.moveColumn(this.column,"MoveBottom");break;case Q.MoveUp:this.panel.moveColumn(this.column,"MoveUp");break;case Q.MoveDown:this.panel.moveColumn(this.column,"MoveDown");break;case Q.SortingAsc:this.column.sorting=m.Ascending,this.column.fireChangedEvent();break;case Q.SortingDesc:this.column.sorting=m.Descending,this.column.fireChangedEvent();break;case Q.SortingNone:this.column.sorting=m.None,this.column.fireChangedEvent();break;case Q.Menu:const i=this.buttonMenu;this.keepShowingButtons=!0,this.activate(),i.showMenu({anchor:e?e.target:null,selectedIds:this.getButtonMenuSelectedItems(),itemSelectedCallback:t=>{let s=t.id;switch(t.id){case"enable":s=Q.Enable;break;case"delete":s=Q.Delete;break;case"hidden":s=Q.Hidden;break;case"MoveTop":s=Q.MoveTop;break;case"MoveBottom":s=Q.MoveBottom;break;case"MoveUp":s=Q.MoveUp;break;case"MoveDown":s=Q.MoveDown;break;case"None":s=Q.SortingNone;break;case"Ascending":s=Q.SortingAsc;break;case"Descending":s=Q.SortingDesc}this.buttonMenuHandler(s,e)},itemFilterCallback:t=>this.columnEnabled||"__group"===t.id||"enable"===t.id||"delete"===t.id,menuClosedCallback:()=>{this.keepShowingButtons=!1,this.isMouseOverBlock||this.leaveButtonBlock()}});break;default:this.processFormatsButtonMenuItems(t,e)||this.processExtraButtonMenuItems(t,e)}return e&&e.stopPropagation(),!1}createButtonMenu(){if(!this.buttonMenu){let t=this.column.id;t&&(t+="-ButtonMenu");const e=[];e.push({id:"enable",text:o.getText("MenuEnable")}),this.panel.options.allowHiddenColumns&&e.push({id:"hidden",text:o.getText("CmdHiddenColumn")}),e.push({id:"delete",text:o.getText("CmdDelete")});let s=[];s.push({id:"__group",text:o.getText("CmdGroupAppearance"),items:e});const i=this.panel.options.allowSorting?[...this.panel.getSortMenuList(),...this.panel.getMoveMenuList()]:this.panel.getMoveMenuList();s.push({id:"__group",text:o.getText("CmdGroupSort"),items:i});const n=this.getExtraButtonMenuItems();n&&Array.isArray(n)&&(s=[...s,...n]);const r=this.getFormatsMenuItems();r.length>1&&s.push({id:"__group",text:o.getText("CmdGroupFormat"),items:r});const a={items:s,id:t,searchBoxAlwaysShown:!1,domWriteItemsId:!0,showSelected:!0};this.buttonMenu=new PopupMenu(a)}}processFormatsButtonMenuItems(t,e){const s=this.panel.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());if("{0:__default}"==t)this.column.displayFormat="";else{if(!(s.filter((e=>e.format==t)).length>0))return!1;this.column.displayFormat=t}return this.column.fireChangedEvent(),!0}getButtonMenuSelectedItems(){let t=[];switch(this.columnEnabled&&t.push("enable"),this.column.isHidden()&&t.push("hidden"),this.column.sorting){case m.None:t.push("None");break;case m.Ascending:t.push("Ascending");break;case m.Descending:t.push("Descending")}let e="{0:__default}";return this.panel.getContext().getModel().getDisplayFormatsForType(this.column.getDataType()).filter((t=>t.format==this.column.displayFormat)).length>0&&(e=this.column.displayFormat),t.push(e),t}}class AttrColumnRendererCP extends ColumnRendererCP{getClassesToAdd(){return`${super.getClassesToAdd()} ${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`}renderExpressionBlock(){return domel("div").addClass(`${this.cssPrefix}-expr-block`).addClass(getMobileCssClass()).addChild("div",(t=>t.addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-attrelement`).addClass(getMobileCssClass()).addChildElement(this.renderBaseExpression()))).toDOM()}getAttribute(){return this.panel.getContext().getModel().getAttributeByIdSafe(this.column.expr.value)}renderBaseExpression(){const t=this.getAttribute(),e=this.panel.getContext().getAttributeTitle(t);return this.isEditable()?domel("a").attr("href","javascript:void(0)").title(e).text(e).on("click",(t=>(t.stopPropagation(),this.activate(),this.panel.showEntitiesMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:this.baseExpressionItemSelectedCallback.bind(this),itemFilterCallback:t=>"__AddAll__"!==t.id}),!1))).toDOM():domel("span").text(e).title(e).toDOM()}baseExpressionItemSelectedCallback(t,e){const s=t.id,i=this.panel.getContext();var n=i.getModel().getAttributeById(s);return this.updateBaseAttr(n),this.column.caption=i.getDefaultColumnCaption(this.column),this.fireColumnChanged(),!1}updateBaseAttr(t){this.column.expr.setValue(t.id,!0),this.column.expr.baseAttrId=t.id,this.column.expr.dataType=t.dataType}getUIS(){const t=this.column.expr.args[0];if(t){return this.panel.getContext().getModel().checkAttrProperty(t.value,"useInSorting")}return!0}changeTypeHandler(t){this.keepShowingButtons=!0,this.functionMenu.showMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>(this.processExtraButtonMenuItems(t.id,null),!1),menuClosedCallback:()=>{this.keepShowingButtons=!1,this.isMouseOverBlock||this.element.dispatchEvent(createBrowserEvent("mouseleave"))}})}changeTypeToCustomSql(){this.column.getQuery().changeColumnType(this.column,c.CustomSql);const t=this.element.parentElement;setTimeout((()=>{const e=t.querySelector(`div[data-id='${this.column.id}']  div[class*='${this.cssPrefix}-expr-block']  div[class*='${this.cssPrefix}-colelement']  a`);e&&e.click()}),500),this.fireColumnChanged()}changeTypeToAggr(t){this.column.getQuery().changeColumnType(this.column,c.AggregateFunction,{funcId:t}),this.fireColumnChanged()}processExtraButtonMenuItems(t,e){return"CUSTOMSQL"===t?this.changeTypeToCustomSql():this.changeTypeToAggr(t),!0}getExtraButtonMenuItems(){const t=[],e=this.panel.getContext().getModel().getAggrFunctions();let s=!0,i=!0;var n=null;const r=this.getAttribute();let a;for(const o of e)s=o.getAppliedTypesOrDefault().indexOf(r.dataType)>=0,this.column.expr.func!==o.id||s||(i=!1),s&&(a=this.panel.getContext().getModel().getAggrFunctionCaption(o.id),n={id:o.id,text:a},t.push(n));for(let t=0;t<e.length;t++)e[t];i||(this.column.expr.func=t[0].id);return this.panel.areCustomExpressionsAllowed()&&(n={id:"CustomSqlDivider",text:"---"},t.push(n),a=o.getText("CustomExpression"),n={id:"CUSTOMSQL",text:a},t.push(n)),[{id:"__group",text:o.getText("ColTypeGroup"),items:t}]}}class AggrFuncColumnRendererCP extends AttrColumnRendererCP{constructor(){super(...arguments),this.displayFormatParser=new DisplayFormatParser}getClassesToAdd(){return`${super.getClassesToAdd()} ${this.cssPrefix}-row ${this.cssPrefix}-row-column-aggr`}getAttribute(){return this.panel.getContext().getModel().getAttributeByIdSafe(this.column.expr.args[0].value)}renderExpressionBlock(){const t=this.panel.getContext().getModel(),e=domel("div").addClass(`${this.cssPrefix}-expr-block`,`${this.cssPrefix}-expr-block-aggr`).addClass(getMobileCssClass()),s=t.getAggrFunctionFormat(this.column.expr.func);if(!s||""===s)return;const i=this.parseDisplayFormat(s);if(0===i.length)return;let n=null;const o=i.length;for(let t=0;t<o;t++)if(n=i[t],1===n.type)if(this.isEditable()){const t=domel("a").attr("href","javascript:void(0)").text(n.text).on("click",(e=>{e.stopPropagation(),this.activate(),this.functionMenu.showMenu({anchor:t.toDOM(),selectedIds:null,itemSelectedCallback:(t,e)=>{"CUSTOMSQL"===t.id?this.changeTypeToCustomSql():(this.column.expr.func=t.id,this.column.caption="",this.fireColumnChanged())}})}));e.addChild("div",(e=>e.addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-aggrfuncelement`).addClass(getMobileCssClass()).addChildElement(t.toDOM())))}else e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-aggrfuncelement`).addClass(getMobileCssClass()).addChild("span",(t=>t.text(n.text).title(n.text)))));else 2===n.type?e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-attrelement`).addClass(getMobileCssClass()).addChildElement(this.renderBaseExpression()))):3===n.type&&e.addChild("span",(t=>t.addClass(`${this.cssPrefix}-colelement`).addClass(getMobileCssClass()).text(n.text).title(n.text)));return e.toDOM()}renderColumnTypeButton(){const t=super.renderColumnTypeButton();return t&&(t.firstElementChild.classList.add("aggregated"),t.firstElementChild.setAttribute("title",o.getText("ButtonToSimple"))),t}changeTypeToSimple(){this.column.getQuery().changeColumnType(this.column,c.EntityAttribute),this.fireColumnChanged()}parseDisplayFormat(t){if(!t)return[];let e=[];const s=this.displayFormatParser;for(s.start(t);s.next();){const t=s.getToken(),i=s.getTokenText();"function"===t?e.push({type:1,text:i}):"expression"===t?e.push({type:2}):"text"===t&&e.push({type:3,text:i})}return e}updateBaseAttr(t){this.column.expr.args[0].setValue(t.id,!0),this.column.expr.baseAttrId=t.id}changeTypeHandler(t){this.changeTypeToSimple()}processExtraButtonMenuItems(t,e){return this.changeTypeToSimple(),!0}getExtraButtonMenuItems(){return[{id:"__group",text:o.getText("ColTypeGroup"),items:[{id:"type",text:o.getText("ColTypeSimple")}]}]}}class EditableColumnRendererCP extends AttrColumnRendererCP{constructor(){super(...arguments),this.dataTypeMenu=null}renderEnabledButton(){const t=super.renderEnabledButton();return t.children[0].title=o.getText("CmdToggleEnableCustom"),t}getClassesToAdd(){return`${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`+super.getClassesToAdd()}renderExpressionBlock(){const e=domel("div").addClass(`${this.cssPrefix}-expr-block`).addClass(getMobileCssClass()).toDOM();let s=domel("div",e).addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-attrelement`).addClass(getMobileCssClass());return this.isEditable()?s.addChild("a",(t=>t.attr("href","javascript:void(0)").title(this.column.caption).text(this.column.caption).on("touchstart click",(t=>{t.stopPropagation();const e=t.target,s=e.parentElement.querySelector("input");s&&(e.style.display="none",s.style.removeProperty("display"),s.style.width="100%",s.focus(),this.element.setAttribute(M.DRAG_DISABLED_ATTR,""))})))).addChild("input",(t=>t.hide().value(this.getColumnValue()).on("blur keydown",(t=>{let e=!1,s=!0;if(t instanceof KeyboardEvent?13===t.keyCode?e=!0:27===t.keyCode&&(e=!0,s=!1):t instanceof FocusEvent&&(e=!0),e){const e=t.target,i=e.parentElement.querySelector("a");i&&(i.style.removeProperty("display"),e.style.display="none");const n=this.getColumnValue();s&&n!==e.value?(this.setColumnValue(e.value),this.fireColumnChanged()):e.value=n,this.element.removeAttribute(M.DRAG_DISABLED_ATTR)}})))):s.addChild("span",(t=>{t.text(this.column.caption).title(this.column.caption)})),s=domel("div",e).addClass(`${this.cssPrefix}-colelement`).addChild("span",(t=>{t.text(":").title(":")})),s=domel("div",e).addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-attrelement`).addClass(getMobileCssClass()),this.isEditable()?(this.createDataTypeMenu(),s.addChild("a",(e=>e.attr("href","javascript:void(0)").title(t[this.column.expr.dataType]).text(t[this.column.expr.dataType]).on("touchstart click",(t=>{t.stopPropagation(),this.dataTypeMenu.showMenu({anchor:e.toDOM(),selectedIds:null,itemSelectedCallback:(t,e)=>{this.column.expr.dataType=t.id,this.fireColumnChanged()}})}))))):(this.column.expr.dataType,s.addChild("span",(e=>{e.text(t[this.column.expr.dataType]).title(t[this.column.expr.dataType])}))),e}changeTypeToSimple(){this.column.getQuery().changeColumnType(this.column,c.EntityAttribute),this.fireColumnChanged()}getColumnValue(){return""}setColumnValue(t){}getUIS(){return!0}changeTypeHandler(t){this.changeTypeToSimple()}processExtraButtonMenuItems(t,e){return this.changeTypeToSimple(),!0}createFunctionMenu(){}getExtraButtonMenuItems(){return[{id:"__group",text:o.getText("ColTypeGroup"),items:[{id:"type",text:o.getText("ColTypeSimple")}]}]}createDataTypeMenu(){const e=[];for(let s in t)if(!isNaN(Number(s))){const i={id:s,text:t[s]};e.push(i)}let s=this.column.id;s&&(s+="-DataTypeMenu");const i={items:e,id:s,searchBoxAlwaysShown:!1,domWriteItemsId:!0};this.dataTypeMenu=new PopupMenu(i)}}class CustomSqlColumnRendererCP extends EditableColumnRendererCP{get columnEnabled(){return!!this.panel.areCustomExpressionsAllowed()&&this.column.enabled}set columnEnabled(t){this.panel.areCustomExpressionsAllowed()?this.column.enabled=t:this.column.enabled=!1}renderColumnTypeButton(){const t=super.renderColumnTypeButton();return t&&(t.firstElementChild.classList.add("aggregated"),t.firstElementChild.setAttribute("title",o.getText("ButtonToSimple"))),t}getColumnValue(){return this.column.expr.sql}setColumnValue(t){this.column.expr.sql=t}getDefaultValue(){return this.column.expr.sql}}class ConstColumnRendererCP extends EditableColumnRendererCP{renderColumnTypeButton(){const t=super.renderColumnTypeButton();return t&&(t.firstElementChild.classList.add("aggregated"),t.firstElementChild.setAttribute("title",o.getText("ButtonToSimple"))),t}getColumnValue(){return this.column.expr.value}setColumnValue(t){this.column.expr.setValue(t)}getDefaultValue(){return this.column.expr.value}}class ColumnsPanel extends Widget{get cssPrefix(){return"eqjs-qc"}constructor(t){super(t),this.options={isSubQuery:!1,activeColumn:null,showAddRow:!0,showHeader:!0,showColumnTitles:!0,allowAggrColumns:!0,allowDuplicates:!0,allowCustomExpressions:!1,allowSorting:!0,attrElementFormat:"{entity} {attr}",titleElementFormat:null,buttons:null,alwaysShowButtons:!1,accentActiveColumn:!0,allowDragDrop:!0,menuOptions:{showSearchBoxAfter:30,searchBoxAutoFocus:!0,activateOnMouseOver:!0,adjustHeight:!0,itemRenderedCallback:null},attrPlacement:0,sortEntities:!1,columnRenderedCallback:null,customExpressionText:0,allowHiddenColumns:!1,showAddAllForEntity:!1,showIndicatorOnLoad:!0},this.landingSlot=domel("div").addClass(`${this.cssPrefix}-col-landing-slot`).addChildElement(domel("div").toDOM()).toDOM(),this.landingIndex=-1,this.slot.classList.add(`${this.cssPrefix}-panel`),this.group=C.Query}getWidgetType(){return"columnsPanel"}init(t,e){super.init(t,e),this.setOptions(e),this.renderProgressBlock();const s=t.getModel();this.detachQueryObserver(),this.attachQueryObserver(),M.removeDropContainer(this.slot),this.options.allowDragDrop&&M.registerDropContainer({element:this.slot,scopes:["entityAttr","entityAttrSort"],onDragEnter:(t,e)=>{if(this.slot.classList.add(`${N}-drophover`),"entityAttrSort"===e.item.scope)this.showLandingSlot(e.pageX,e.pageY);else{const t=e.data.attrId;s.checkAttrProperty(t,"useInResult")||(e.dropEffect=I.Forbid),e.dragImage.classList.add("eqjs-sortable-helper")}},onDragOver:(t,e)=>{const i=e.data.attrId;("entityAttrSort"===e.item.scope||s.checkAttrProperty(i,"useInResult"))&&this.showLandingSlot(e.pageX,e.pageY)},onDragLeave:(t,e)=>{"entityAttrSort"===e.item.scope?e.dropEffect=I.Forbid:(e.dragImage.classList.remove("eqjs-sortable-helper"),e.dragImage.style.removeProperty("width")),this.slot.classList.remove(`${N}-drophover`),this.hideLandingSlot()},onDrop:(t,e)=>{if("entityAttrSort"==e.item.scope){const t=this.getQuery().getColumns().indexOf(e.data.column);this.moveColumnCore(t,this.landingIndex)}else{const t=e.data.attrId;this.addNewColumn(t,this.landingIndex)}}})}renderBaseElements(){let t=0;if(this.options.showHeader){const e=domel("div",this.slot).hide().addClass(`${this.cssPrefix}-header`).addClass(getMobileCssClass());this.options.alwaysShowButtons||e.addClass("eqjs-no-buttons"),this.options.showCheckboxes?e.addChild("div",(t=>t.setStyle("margin-left","30px"))):e.addClass("eqjs-no-checkbox"),e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-header-expression`).text(o.getText("HeaderExpression")))),!1!==this.options.showColumnTitles&&e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-header-title`).text(o.getText("HeaderTitle")))),this.headerElement=e.toDOM(),t+=this.headerElement.offsetHeight}this.columnsBlock=domel("div",this.slot).addClass(`${this.cssPrefix}-columns`).addClass(getMobileCssClass()).toDOM(),this.options.showAddRow&&(this.addRowElement=domel("div",this.slot).addClass(`${N}-addrow`,`${this.cssPrefix}-addrow`,`${N}-addrow-empty`).addClass(getMobileCssClass()).addChild("a",(t=>t.attr("href","javascript:void(0)").text(o.getText("CmdClickToAddColumn")).on("click",(t=>{t.preventDefault(),this.showEntitiesMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>{if("__AddAll__"===t.id&&t.extra&&Array.isArray(t.extra.ids))t.extra.ids.forEach((t=>this.addNewColumn(t)));else{const e=t.id;this.addNewColumn(e)}return!1}})})))).toDOM(),t+=this.addRowElement.offsetHeight),this.columnsBlock.style.maxHeight=this.slot.offsetHeight-t-25+"px"}destroyCore(){M.removeDropContainer(this.slot),this.detachQueryObserver(),this.slot.innerHTML=""}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((e=>{const s=e.data;if(!s||s.part!=g.Columns&&s.part!=g.Aggregation&&s.part!=g.All)return;const i=document.activeElement,n=this.slot.contains(i)||i==document.body;switch(s.action){case p.Modify:{const t=s.changee,modifyColumn=t=>{const e=this.columnsBlock.querySelector(`div[data-id='${t.id}']`);if(e){const s=this.getColumnRenderer(t,e);if(s){const t=s.render();if(n){const e=t.querySelector("a")||t.querySelector(".eqjs-column-button");e&&e.focus()}}}};Array.isArray(t)?t.forEach((t=>modifyColumn(t))):modifyColumn(t),this.agjustHeaderVisibility();break}case p.Add:{const e=s.changee,addColumn=e=>{const s=t.getColumns().indexOf(e),i=this.addColumnElement(e,s);if(n){const t=i.querySelector("a");if(t)try{t.focus()}catch(t){}}};Array.isArray(e)?e.forEach((t=>addColumn(t))):addColumn(e),this.agjustHeaderVisibility();break}case p.Delete:{const t=s.changee,deleteColumn=t=>{const e=this.columnsBlock.querySelector(`div[data-id='${t.id}']`);if(e){const t=e.nextSibling,s=e.previousSibling;if(this.columnsBlock.removeChild(e),n){const e=t||s||this.addRowElement,i=e.querySelector("a")||e.querySelector(".eqjs-column-button");i&&i.focus()}}};this.agjustHeaderVisibility(),Array.isArray(t)?t.forEach((t=>deleteColumn(t))):deleteColumn(t);break}default:this.refresh()}}))}detachQueryObserver(){if(this.queryEventCallbackId){this.getQuery().removeChangedCallback(this.queryEventCallbackId)}}getQuery(){return this.getContext().getQuery()}showLandingSlot(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`),i=[];for(let t=0;t<s.length;t++){const e=s[t];"none"!==e.style.display&&i.push(e)}if(0===i.length)return this.landingIndex=0,void this.columnsBlock.appendChild(this.landingSlot);const n=getElementAbsolutePos(this.landingSlot);if(e>=n.y&&e<=n.y+this.landingSlot.offsetHeight)return;const o=i[0],r=o.offsetHeight,a=getElementAbsolutePos(o);let l=e>a.y+r/2?Math.round((e-a.y+r/2)/r):0;l>i.length&&(l=i.length),l!=this.landingIndex&&(this.landingIndex=l,this.landingIndex<i.length?this.columnsBlock.insertBefore(this.landingSlot,i[this.landingIndex]):this.columnsBlock.appendChild(this.landingSlot),this.landingSlot.scrollIntoView({block:"center",behavior:"smooth"}))}hideLandingSlot(){this.landingIndex=-1,setTimeout((()=>{this.landingSlot.parentElement&&this.landingSlot.parentElement.removeChild(this.landingSlot)}),10)}setOptions(t){n.assignDeep(this.options,t),this.context.options.allowCustomExpressions=t.allowCustomExpressions,t.attrElementFormat&&(this.context.options.attributeFormat=t.attrElementFormat),t.titleElementFormat&&(this.context.options.columnTitleFormat=t.titleElementFormat),w.isMobileMode()&&(this.options.buttons=["menu","sorting"],this.options.showHeader=!1)}onProcessStartCore(){this.options.showIndicatorOnLoad&&(this.progressBlock.parentNode||this.slot.appendChild(this.progressBlock))}onProcessEndCore(){this.options.showIndicatorOnLoad&&this.progressBlock.parentNode&&this.slot.removeChild(this.progressBlock)}refreshCore(){this.clear(),this.render()}clear(){this.slot.innerHTML=""}render(){try{this.renderBaseElements(),this.createEntitiesMenu(),this.createColumnMenus(),this.agjustHeaderVisibility(),domel(this.slot).removeClass($).addClass(getMobileCssClass());const t=this.context.getQuery().getColumns();for(let e of t)this.columnsBlock.appendChild(this.renderColumn(e))}catch(t){let e=t;this.context.throwError({action:"ColumnsPanel rendering",text:e.message,sourceError:e})}}agjustHeaderVisibility(){if(this.headerElement){const t=this.context.getQuery().getColumns();this.headerElement.style.display=t.length?"":"none"}}renderColumn(t){const e=this.getColumnRenderer(t);return e?e.render():null}toggleColumnPicked(t){let e,s;t&&(e=this.columnsBlock.querySelector(`div[data-id=${t.id}]`),e&&(s=e.classList.contains("active")));const i=this.columnsBlock.querySelectorAll(`.${this.cssPrefix}-row`);for(let t=0;t<i.length;t++){const e=i[t];domel(e).removeClass("active"),this.options.alwaysShowButtons||domel(e).data("show-buttons",null)}e&&!s&&domel(e).addClass("active").data("show-buttons","")}addNewColumn(t,e){this.getContext().getModel();const s=this.getQuery();if(Array.isArray(t)){let i=null,n=[];for(let o=0;o<t.length;o++)i=s.addColumn({attributeId:t[o],index:e},!0),i&&n.push(i);return s.fireChangedEvent({part:g.Columns,action:p.Add,changee:n,source:this}),n}return s.addColumn({attributeId:t,index:e})}addColumnElement(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`),i=this.renderColumn(t);return s.length>0&&e<s.length?this.columnsBlock.insertBefore(i,s[e]):(this.columnsBlock.appendChild(i),this.scrollToBottom()),this.options.columnRenderedCallback&&this.options.columnRenderedCallback(i),i}scrollToBottom(){this.columnsBlock.scrollTop=this.columnsBlock.scrollHeight-this.columnsBlock.clientHeight}checkColumnsArray(t){let e=t.length;const s=[];for(let i=0;i<e;i++)this.checkColumn(t[i])&&s.push(t[i]);return s}checkColumn(t){if(!this.options.allowDuplicates){const e=this.getQuery().getColumns();for(let s=0;s<e.length;s++)if((t.expr.tag===c.EntityAttribute&&e[s].expr.tag===c.EntityAttribute||t.expr.tag===c.ParentEntityAttribute&&e[s].expr.tag===c.ParentEntityAttribute)&&t.expr.value===e[s].expr.value)return null}return t}getColumnsBlock(){return this.columnsBlock}getColumnRenderer(t,e){switch(t.expr.tag){case c.Constant:return new ConstColumnRendererCP(this,t,e);case c.AggregateFunction:return new AggrFuncColumnRendererCP(this,t,e);case c.CustomSql:return new CustomSqlColumnRendererCP(this,t,e);default:return new AttrColumnRendererCP(this,t,e)}}areCustomExpressionsAllowed(){return this.getQuery().isEx()&&this.getContext().options.allowCustomExpressions}addAllColumnsToEntitiesList(t){const e=t.filter((t=>!t.isEntity)).map((t=>t.id));e.length>0&&t.unshift({id:"__AddAll__",text:o.getText("AddAllForEntityText"),extra:{ids:e}}),t.forEach((t=>{t.items&&this.addAllColumnsToEntitiesList(t.items)}))}createEntitiesMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;e&&(e+="-EntitiesMenu");const s=t.getEntitiesTree({addUIC:!1,addUIR:!0,addUIS:!1,attrPlacement:this.options.attrPlacement,sortEntities:this.options.sortEntities});this.options.showAddAllForEntity&&this.addAllColumnsToEntitiesList(s);const i={id:e,items:s,adjustHeight:this.options.adjustEntitiesMenuHeight,domWriteItemsId:this.options.domWriteItemsId};n.assign(i,this.options.menuOptions),this.entitiesMenu=new PopupMenu(i)}getSortMenuList(){return[{id:"None",text:o.getText("CmdNotSorted")},{id:"Ascending",text:o.getText("CmdAscending")},{id:"Descending",text:o.getText("CmdDescending")},{id:"---",text:"---"}]}getMoveMenuList(){return[{id:"MoveTop",text:o.getText("CmdMoveToFirst")},{id:"MoveUp",text:o.getText("CmdMoveToPrev")},{id:"MoveDown",text:o.getText("CmdMoveToNext")},{id:"MoveBottom",text:o.getText("CmdMoveToLast")}]}createSortMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;e&&(e+="-SortMenu");const s={id:e,items:this.getSortMenuList().concat(this.moveMenu.getItems()),domWriteItemsId:this.options.domWriteItemsId,showSelected:!0};n.assign(s,this.options.menuOptions),s.searchBoxAlwaysShown=!1,this.sortMenu=new PopupMenu(s)}createMoveMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;e&&(e+="-MoveMenu");const s=n.createArrayFrom(this.getMoveMenuList());this.options.allowHiddenColumns&&(s.push({id:"---",text:"---"}),s.push({id:"IsHidden",text:o.getText("CmdHiddenColumn")}));const i={items:s,id:e,domWriteItemsId:this.options.domWriteItemsId,showSelected:!0};n.assign(i,this.options.menuOptions),this.moveMenu=new PopupMenu(i),i.searchBoxAlwaysShown=!1}showEntitiesMenu(t){this.entitiesMenu.showMenu(t)}moveColumn(t,e){const s=this.getQuery().getColumns(),i=s.indexOf(t);if(i>=0)switch(e){case"MoveTop":if(0==i)return;this.moveColumnCore(i,0);break;case"MoveUp":if(0==i)return;this.moveColumnCore(i,i-1);break;case"MoveDown":if(i==s.length-1)return;this.moveColumnCore(i,i+1);break;case"MoveBottom":if(i==s.length-1)return;this.moveColumnCore(i,s.length-1)}}moveColumnCore(t,e){const s=this.getQuery();if(!s)return;const i=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`),n=i[t];0==e?this.columnsBlock.insertBefore(n,this.columnsBlock[0]):e>0&&e<i.length-1?t<e?this.columnsBlock.insertBefore(n,i[e+1]):this.columnsBlock.insertBefore(n,i[e]):this.columnsBlock.appendChild(n),s.moveColumn(t,e),s.fireColumnsChangedEvent()}createColumnMenus(){this.createMoveMenu(),this.options.allowSorting&&this.createSortMenu()}renderProgressBlock(){this.progressBlock=document.createElement("div"),this.progressBlock.classList.add(`${N}-progress-win8`),this.progressBlock.classList.add(getMobileCssClass()),this.progressBlock.innerHTML='<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>'}}class ColumnRendererCB{constructor(t,e,s){this.functionMenu=null,this.formatsMenu=null,this.isMouseOverBlock=!1,this.keepShowingButtons=!1,this.tapedTwice=!1,this.bar=t,this.column=e,this.element=s}get cssPrefix(){return"eqjs-cb"}render(){const t=domel("div");return t.data("id",this.column.id),this.element&&this.element.parentNode.replaceChild(t.toDOM(),this.element),this.element=t.toDOM(),this.bar.options.allowDragDrop&&M.registerDraggableItem({element:this.element,scope:"entityAttrSort",beforeDragStart:()=>this.element.dispatchEvent(createBrowserEvent("mouseleave")),onDragStart:t=>{this.hideButtons(),this.element.style.display="none",t.dropEffect=I.Allow},onDragEnd:t=>{this.element.removeAttribute("style")},data:{column:this.column}}),this.column.isReadOnly()||(this.createFunctionMenu(),this.createFormatsMenu()),t.addClass(this.getClassesToAdd()).addClass(getMobileCssClass()).addChildElement(this.renderCaptionBlock()).addChildElement(this.renderSortingImage()),w.isMobileMode()||t.addChildElement(this.renderButtonsBlock()),t.on("mouseenter",this.onMouseEnter.bind(this)).on("mouseleave",this.onMouseLeave.bind(this)),(this.bar.options.accentActiveColumn||w.isMobileMode())&&t.on("touchstart click",this.onMouseClick.bind(this)),this.element}fireColumnChanged(){this.column.fireChangedEvent()}refresh(){this.render()}isEditable(){return this.column.enabled&&!this.column.isReadOnly()}renderButtonsBlock(){return domel("div",this.element).addClass(`${N}-column-buttonsBlock`,`${this.cssPrefix}-buttonsBlock`).addChildElement(this.renderSortingButton()).addChildElement(this.renderColumnTypeButton()).addChildElement(this.renderColumnFormatButton()).addChildElement(this.renderDeleteButton()).toDOM()}renderCaptionBlock(){const t=this.column.caption;if(!this.isEditable())return domel("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-captionelement`).addClass(getMobileCssClass()).addChild("div",(e=>e.title(t).text(t).attr("tabIndex","0"))).toDOM();const tapHandler=t=>{this.tapedTwice||(this.tapedTwice=!0,setTimeout((()=>{this.tapedTwice=!1}),300))};let e=!1;return domel(this.element).on("touchstart dblclick",(t=>{if(t instanceof TouchEvent&&!this.tapedTwice)return tapHandler(),!0;t.stopPropagation(),e=this.element.querySelector("a")==document.activeElement;const s=this.element.querySelector(`.${this.cssPrefix}-captionelement input`),i=this.element.querySelector(`.${this.cssPrefix}-captionelement a`);return s&&(s.style.width=`${this.element.clientWidth}px`,i.style.display="none",s.style.removeProperty("display"),s.focus(),this.element.setAttribute(M.DRAG_DISABLED_ATTR,"")),!1})),domel("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-captionelement`).addClass(getMobileCssClass()).addChild("a",(e=>e.attr("href","javascript:void(0)").title(this.column.caption).text(t).on("keydown",(t=>{const e=t;if((e.ctrlKey||e.metaKey)&&(13==e.keyCode||10==e.keyCode)&&this.isColumnActive()){const t=document.createEvent("MouseEvents");return t.initEvent("dblclick",!0,!0),this.element.dispatchEvent(t),e.stopPropagation(),!1}return!0})))).addChild("input",(t=>t.hide().value(this.column.caption).on("blur keydown",(t=>{let s=!1,i=!0;if(t instanceof KeyboardEvent?13===t.keyCode?s=!0:27===t.keyCode&&(s=!0,i=!1):t instanceof FocusEvent&&(s=!0),s){const s=t.target,n=s.parentElement.querySelector("a");n&&(n.style.removeProperty("display"),s.style.display="none"),i&&this.column.caption!==s.value?(this.column.caption=s.value,this.fireColumnChanged()):s.value=this.column.caption,this.element.removeAttribute(M.DRAG_DISABLED_ATTR),e&&this.element.querySelector("a").focus()}})))).toDOM()}renderSortingImage(){const t=`${N}-column-sortbutton`;let e=t;switch(this.column.sorting){case m.Ascending:e=`${t}-asc`;break;case m.Descending:e=`${t}-desc`}return this.column.sorting==m.None?null:domel("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-sortimage-placeholder`).addClass(getMobileCssClass()).addChild("div",(t=>t.addClass(`${this.cssPrefix}-img-sorting`,e).title(o.getText("ButtonSorting")))).toDOM()}buttonSortingClickHandler(t,e){t.stopPropagation(),this.keepShowingButtons=!0;return(this.getUIS()&&this.bar.sortMenu||this.bar.moveMenu).showMenu({anchor:e,selectedIds:null,itemSelectedCallback:(t,e)=>{if("None"==t.id||"Ascending"==t.id||"Descending"==t.id){const e=this.bar.getQuery();this.column.sorting="None"==(s=t.id)?m.None:"Ascending"==s?m.Ascending:"Descending"==s?m.Descending:void 0,this.column._sortIndex=e.getColumnSortIndex(this.column),this.fireColumnChanged()}else this.bar.moveColumn(this.column,t.id);var s},menuClosedCallback:()=>{this.keepShowingButtons=!1,this.isMouseOverBlock||this.leaveButtonBlock()}}),!1}renderSortingButton(){if(!this.isEditable())return null;const t=domel("div").addClass(`${N}-column-button`,`${N}-column-sortbutton`,`${N}-column-sortbutton-none`).title(o.getText("ButtonSorting")).attr("tabIndex","0").on("touchstart click",(e=>this.buttonSortingClickHandler(e,t.toDOM()))).on("keypress",(t=>{13==t.keyCode&&t.target.click()}));return t.toDOM()}buttonDeleteClickHandler(t){t.stopPropagation();const e=this.bar.getQuery();return e.removeColumn(this.column),e.fireColumnsChangedEvent(p.Delete,this.column),!1}renderDeleteButton(){return this.column.isReadOnly()?null:domel("div").addClass(`${N}-column-button`,`${N}-column-button-delete`).title(o.getText("CmdDelete")).attr("tabIndex","0").on("touchstart click",(t=>this.buttonDeleteClickHandler(t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})).toDOM()}getClassesToAdd(){let t="";return t+=this.column.enabled?"":` ${this.cssPrefix}-disabled`,this.column.enabled&&(t+=this.column.isReadOnly()?` ${this.cssPrefix}-readonly`:""),t}buttonTypeClickHandler(t){return t.stopPropagation(),this.keepShowingButtons=!0,this.changeColumnTypeHandler(t),!1}buttonFormatClickHandler(t){return t.stopPropagation(),this.keepShowingButtons=!0,this.changeFormatHandler(t),!1}formatButtonIsShown(){return!1!==this.bar.options.allowDisplayFormatChange&&this.bar.getContext().getModel().getDisplayFormatsForType(this.column.getDataType()).length>0}changeFormatHandler(t){const e=this.bar.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());let s="{0:__default}";e.filter((t=>t.format==this.column.displayFormat)).length>0&&(s=this.column.displayFormat),this.formatsMenu.showMenu({anchor:t.target,selectedIds:s,itemSelectedCallback:(t,e)=>(t.id!=s&&("{0:__default}"==t.id?this.column.displayFormat="":this.column.displayFormat=t.id,this.column.fireChangedEvent()),!1),menuClosedCallback:()=>{this.keepShowingButtons=!1,this.isMouseOverBlock||this.element.dispatchEvent(createBrowserEvent("mouseleave"))}})}renderColumnTypeButton(){return this.isEditable()&&!1!==this.bar.options.allowAggrColumns?domel("div").addClass(`${N}-column-button`,`${N}-column-button-type`).title(o.getText("ButtonToAggr")).attr("tabIndex","0").on("touchstart click",(t=>this.buttonTypeClickHandler(t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})).toDOM():null}renderColumnFormatButton(){return this.isEditable()&&this.formatButtonIsShown()?domel("div").addClass(`${N}-column-button`,`${N}-column-button-format`).title(o.getText("ButtonFormat")).attr("tabIndex","0").on("touchstart click",(t=>this.buttonFormatClickHandler(t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})).toDOM():null}getUIS(){return this.bar.getContext().getModel().checkAttrProperty(this.column.expr.value,"useInSorting")}onMouseClick(t){this.bar.toggleColumnPicked(this.column),this.adjustButtonsVisibility()}onMouseEnter(t){if(!w.isMobileMode())return this.isMouseOverBlock=!0,this.enterButtonBlock(),t.stopPropagation(),!1}onMouseLeave(t){if(!w.isMobileMode())return this.isMouseOverBlock=!1,this.leaveButtonBlock(),t.stopPropagation(),!1}isColumnActive(){return this.element.classList.contains("active")}hideButtons(){w.isMobileMode()?this.onHideButtonsMobile&&this.onHideButtonsMobile():domel(this.element).data("show-buttons",null)}showButtons(){w.isMobileMode()?this.onShowButtonsMobile&&this.onShowButtonsMobile():domel(this.element).data("show-buttons","")}adjustButtonsVisibility(){this.bar.options.alwaysShowButtons||(this.bar.options.accentActiveColumn||w.isMobileMode())&&this.isColumnActive()?this.showButtons():this.hideButtons()}enterButtonBlock(){this.showButtons()}leaveButtonBlock(){1==this.bar.options.alwaysShowButtons||this.isColumnActive()&&1==this.bar.options.accentActiveColumn||this.hideButtons()}createFunctionMenu(){const t=[],e=this.bar.getContext().getModel().getAggrFunctions();let s=!0,i=null;const n=this.column.getDataType();let r;for(const o of e){if(!o)continue;const e=o.getAppliedTypesOrDefault().indexOf(n)>=0;this.column.expr.func!==o.id||e||(s=!1),e&&(r=this.bar.getContext().getModel().getAggrFunctionCaption(o.id),i={id:o.id,text:r},t.push(i))}s||(this.column.expr.func=t[0].id);this.bar.areCustomExpressionsAllowed()&&(i={id:"CustomSqlDivider",text:"---"},t.push(i),r=o.getText("CustomExpression"),i={id:"CUSTOMSQL",text:r},t.push(i));let a=this.element.id;a&&(a+="-FunctionsMenu");const l={items:t,id:a,searchBoxAlwaysShown:!1,domWriteItemsId:!0};this.functionMenu=new PopupMenu(l)}createFormatsMenu(){if(0==this.bar.options.allowDisplayFormatChange)return;let t=this.column.id;t&&(t+="-FormatsMenu");const e={items:this.getFormatsMenuItems(),id:t,searchBoxAlwaysShown:!1,showSelected:!0,domWriteItemsId:!0};this.formatsMenu=new PopupMenu(e)}getFormatsMenuItems(){const t=this.bar.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());return[{id:"{0:__default}",text:"Default"}].concat(t.map((t=>({id:t.format,text:o.getText("DisplayFormats",t.name)||t.name}))))}}class AttrColumnRendererCB extends ColumnRendererCB{getClassesToAdd(){return`${super.getClassesToAdd()} ${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`}baseExpressionItemSelectedCallback(t,e){const s=t.id,i=this.bar.getContext();var n=i.getModel().getAttributeById(s);return this.updateBaseAttr(n),this.column.caption=i.getDefaultColumnCaption(this.column),this.fireColumnChanged(),!1}updateBaseAttr(t){this.column.expr.setValue(t.id,!0),this.column.expr.baseAttrId=t.id,this.column.expr.dataType=t.dataType}getUIS(){const t=this.column.expr.args[0];if(t){return this.bar.getContext().getModel().checkAttrProperty(t.value,"useInSorting")}return!0}changeTypeToCustomSql(){this.column.getQuery().changeColumnType(this.column,c.CustomSql),this.fireColumnChanged()}changeTypeToAggr(t){this.column.getQuery().changeColumnType(this.column,c.AggregateFunction,{funcId:t}),this.fireColumnChanged()}changeColumnTypeHandler(t){this.functionMenu.showMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>("CUSTOMSQL"==t.id?this.changeTypeToCustomSql():this.changeTypeToAggr(t.id),!1),menuClosedCallback:()=>{this.keepShowingButtons=!1,this.isMouseOverBlock||this.element.dispatchEvent(createBrowserEvent("mouseleave"))}})}}class AggrFuncColumnRendererCB extends AttrColumnRendererCB{getClassesToAdd(){return`${super.getClassesToAdd()} ${this.cssPrefix}-row ${this.cssPrefix}-row-column-aggr`}renderColumnTypeButton(){const t=super.renderColumnTypeButton();return t&&(t.classList.add("aggregated"),t.title=o.getText("ButtonToSimple")),t}updateBaseAttr(t){this.column.expr.args[0].setValue(t.id,!0),this.column.expr.baseAttrId=t.id}changeTypeToSimple(){this.column.getQuery().changeColumnType(this.column,c.EntityAttribute),this.fireColumnChanged()}changeColumnTypeHandler(t){this.changeTypeToSimple()}}class EditableColumnRendererCB extends ColumnRendererCB{getClassesToAdd(){return`${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`+super.getClassesToAdd()}renderColumnTypeButton(){const t=super.renderColumnTypeButton();return t&&(t.classList.add("aggregated"),t.title=o.getText("ButtonToSimple")),t}changeTypeToSimple(){this.column.getQuery().changeColumnType(this.column,c.EntityAttribute),this.fireColumnChanged()}getColumnValue(){return""}setColumnValue(t){}getUIS(){return!0}changeColumnTypeHandler(t){this.changeTypeToSimple()}}class CustomSqlColumnRendererCB extends EditableColumnRendererCB{get columnEnabled(){return!!this.bar.areCustomExpressionsAllowed()&&this.column.enabled}set columnEnabled(t){this.bar.areCustomExpressionsAllowed()?this.column.enabled=t:this.column.enabled=!1}getColumnValue(){return this.column.expr.sql}setColumnValue(t){this.column.expr.sql=t}getDefaultValue(){return this.column.expr.sql}}class ConstColumnRendererCB extends EditableColumnRendererCB{getColumnValue(){return this.column.expr.value}setColumnValue(t){this.column.expr.setValue(t)}getDefaultValue(){return this.column.expr.value}}class ColumnsBar extends Widget{get cssPrefix(){return"eqjs-cb"}constructor(t,e){super(t),this.options={isSubQuery:!1,activeColumn:null,showAddRow:!0,showHeader:!0,showColumnTitles:!0,allowAggrColumns:!0,allowDuplicates:!0,allowCustomExpressions:!1,allowSorting:!0,alwaysShowButtons:!1,accentActiveColumn:!0,allowDragDrop:!0,menuOptions:{showSearchBoxAfter:30,searchBoxAutoFocus:!0,activateOnMouseOver:!0,adjustHeight:!0,itemRenderedCallback:null},attrPlacement:0,sortEntities:!1,columnRenderedCallback:null,customExpressionText:0,showAddAllForEntity:!1},this.landingSlot=domel("div").addClass(`${N}-highlight`).toDOM(),this.landingIndex=-1,this.sortMenuList=[{id:"None",text:o.getText("CmdNotSorted")},{id:"Ascending",text:o.getText("CmdAscending")},{id:"Descending",text:o.getText("CmdDescending")},{id:"---",text:"---"}],this.moveMenuList=[{id:"MoveTop",text:o.getText("CmdMoveToFirst")},{id:"MoveUp",text:o.getText("CmdMoveToPrev")},{id:"MoveDown",text:o.getText("CmdMoveToNext")},{id:"MoveBottom",text:o.getText("CmdMoveToLast")}],domel(this.slot).addClass(`${this.cssPrefix}-panel`).addClass(getMobileCssClass()),this.group=C.Query,this.customQuery=e}getWidgetType(){return"columnsBar"}init(t,e){super.init(t,e),this.setOptions(e),e.attrElementFormat&&(this.context.options.attributeFormat=e.attrElementFormat),e.titleElementFormat&&(this.context.options.columnTitleFormat=e.titleElementFormat),this.detachQueryObserver(),this.attachQueryObserver(),M.removeDropContainer(this.slot),this.options.allowDragDrop&&M.registerDropContainer({element:this.slot,scopes:["entityAttrSort"],onDragEnter:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragOver:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragLeave:(t,e)=>{e.dropEffect=I.Forbid,this.hideLandingSlot()},onDrop:(t,e)=>{if(this.landingIndex>=0){const t=this.getQuery().getColumns().indexOf(e.data.column);this.moveColumnCore(t,this.landingIndex)}else e.item.element.removeAttribute("style")}})}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((e=>{const s=e.data;if(!s||s.part!=g.Columns&&s.part!=g.Aggregation&&s.part!=g.All)return;const i=document.activeElement,n=this.slot.contains(i)||i==document.body;switch(s.action){case p.Modify:{const t=s.changee,modifyColumn=t=>{const e=this.columnsBlock.querySelector(`div[data-id='${t.id}']`);if(e){const s=this.renderColumn(t,e);if(n){const t=s.querySelector("a");t&&t.focus()}}};Array.isArray(t)?t.forEach((t=>modifyColumn(t))):modifyColumn(t);break}case p.Add:{const e=s.changee,addColumn=e=>{const s=t.getColumns().indexOf(e);this.addColumnElement(e,s)};Array.isArray(e)?e.forEach((t=>addColumn(t))):addColumn(e);break}case p.Delete:{const t=s.changee,deleteColumn=t=>{const e=this.columnsBlock.querySelector(`div[data-id='${t.id}']`);if(e){const t=e.nextSibling,s=e.previousSibling;if(this.columnsBlock.removeChild(e),n){const e=(t||s||this.addRowButton).querySelector("a");e&&e.focus()}}};Array.isArray(t)?t.forEach((t=>deleteColumn(t))):deleteColumn(t);break}default:this.refresh()}}))}getQuery(){return this.customQuery?this.customQuery:this.getContext().getQuery()}destroyCore(){M.removeDropContainer(this.slot),this.detachQueryObserver(),this.slot.innerHTML=""}detachQueryObserver(){if(this.queryEventCallbackId){this.getQuery().removeChangedCallback(this.queryEventCallbackId)}}setOptions(t){this.options=n.assignDeep(this.options,t),this.getContext().options.allowCustomExpressions=t.allowCustomExpressions}showLandingSlot(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`),i=[];for(let t=0;t<s.length;t++)"none"!==s[t].style.display&&i.push(s[t]);if(0===i.length)return void(this.landingIndex=0);const n=getElementAbsolutePos(this.landingSlot);if(t>=n.x&&t<=n.x+this.landingSlot.offsetWidth&&e>=n.y&&e<=n.y+this.landingSlot.offsetHeight)return;let o=this.landingIndex;for(let s=0;s<i.length;s++){const r=i[s],a=getElementAbsolutePos(r),l=r.offsetWidth,d=r.offsetHeight,h=.2*l,u=2;if(t>=a.x+h&&t<=a.x+l-h&&e>=a.y+u&&e<=a.y+d-u){o=t>n.x?s+1:s;break}}(o!=this.landingIndex||this.landingSlot.parentElement)&&(this.landingIndex=o,this.landingIndex<=0&&this.columnsBlock.insertBefore(this.landingSlot,i[0]),this.landingIndex<i.length?this.columnsBlock.insertBefore(this.landingSlot,i[this.landingIndex]):this.columnsBlock.appendChild(this.landingSlot))}hideLandingSlot(){this.landingIndex=-1,this.landingSlot.parentElement&&this.landingSlot.parentElement.removeChild(this.landingSlot)}onProcessStartCore(){}onProcessEndCore(){}refreshCore(){this.clear(),this.render()}clear(){this.slot.innerHTML=""}renderAddRowButton(){domel(this.addRowButton).addClass(`${N}-addrow`,`${this.cssPrefix}-addrow`,`${N}-addrow-empty`).addClass(getMobileCssClass()).title(o.getText("CmdClickToAddColumn")).addChild("a",(t=>t.attr("href","javascript:void(0)").on("click",(t=>{t.preventDefault(),this.showEntitiesMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>{if("__AddAll__"===t.id&&t.extra&&Array.isArray(t.extra.ids))t.extra.ids.forEach((t=>this.addNewColumn(t)));else{const e=t.id;this.addNewColumn(e)}return!1}})})))),w.isMobileMode()&&domel(this.columnsBlock).addChildElement(this.addRowButton)}render(){this.createEntitiesMenu(),this.options.allowSorting&&this.createSortMenu(),this.createMoveMenu(),this.columnsBlock=domel("div").addClass(`${this.cssPrefix}-columns`).addClass(getMobileCssClass()).toDOM(),this.options.showAddRow&&(this.addRowButton=domel("div").toDOM(),w.isMobileMode()?domel(this.columnsBlock).addChildElement(this.addRowButton):domel(this.slot).addChildElement(this.addRowButton),this.renderAddRowButton()),domel(this.slot).addChildElement(this.columnsBlock).addChildElement(this.renderColumnButtonsBlockMobile());this.getQuery().getColumns().forEach(((t,e)=>{const s=this.renderColumn(t);this.columnsBlock.appendChild(s)}))}renderColumnButtonsBlockMobile(){return this.columnButtonsBlockMobileArrow=domel("i").toDOM(),this.columnButtonsBlockMobile=domel("div").addClass(`${this.cssPrefix}-column-buttonsBlock`).addClass(getMobileCssClass()).addChildElement(this.columnButtonsBlockMobileArrow).hide().toDOM(),this.buttonsBlockSortingButton=domel("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button`,`${this.cssPrefix}-column-sortbutton-none`).toDOM(),domel(this.buttonsBlockSortingButton).on("touchstart click",(t=>(t.stopPropagation(),this.currentColumnRenderer.buttonSortingClickHandler.call(this.currentColumnRenderer,t,this.buttonsBlockSortingButton),this.toggleColumnPicked(null),this.hideColumnButtonsMobile(),!1))),this.buttonsBlockTypeButton=domel("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button`,`${this.cssPrefix}-column-button-type`).on("touchstart click",(t=>(t.stopPropagation(),this.currentColumnRenderer.buttonTypeClickHandler.call(this.currentColumnRenderer,t),this.toggleColumnPicked(null),this.hideColumnButtonsMobile(),!1))).toDOM(),this.buttonsBlockFormatButton=domel("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button`,`${this.cssPrefix}-column-button-format`).on("touchstart click",(t=>(t.stopPropagation(),this.currentColumnRenderer.buttonFormatClickHandler.call(this.currentColumnRenderer,t),this.toggleColumnPicked(null),this.hideColumnButtonsMobile(),!1))).toDOM(),this.buttonsBlockDeleteButton=domel("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button`,`${this.cssPrefix}-column-button-delete`).on("touchstart click",(t=>(t.stopPropagation(),this.currentColumnRenderer.buttonDeleteClickHandler.call(this.currentColumnRenderer,t),this.toggleColumnPicked(null),this.hideColumnButtonsMobile(),!1))).toDOM(),domel("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button-close-block`).on("touchstart click",(()=>{this.toggleColumnPicked(null),this.hideColumnButtonsMobile()})),this.columnButtonsBlockMobile}showColumnButtonsMobile(t,e,s){this.currentActiveColumn=t,this.currentColumnRenderer=e;const i=s.getBoundingClientRect(),n=s.offsetTop,o=s.offsetLeft;domel(this.columnButtonsBlockMobileArrow).setStyle("left",(o+i.width/2).toString()+"px"),i.top>100?domel(this.columnButtonsBlockMobile).removeClass("show-below").setStyle("top",(n-i.height).toString()+"px"):domel(this.columnButtonsBlockMobile).addClass("show-below").setStyle("top",(n+i.height).toString()+"px"),t.enabled&&!t.isReadOnly()?(domel(this.buttonsBlockSortingButton).show(),domel(this.buttonsBlockTypeButton).show(),e.formatButtonIsShown()?domel(this.buttonsBlockFormatButton).show():domel(this.buttonsBlockFormatButton).hide()):(domel(this.buttonsBlockSortingButton).hide(),domel(this.buttonsBlockTypeButton).hide()),t.isReadOnly()?domel(this.columnButtonsBlockMobile).hide():domel(this.columnButtonsBlockMobile).show()}hideColumnButtonsMobile(){domel(this.columnButtonsBlockMobile).hide()}renderColumn(t,e){const s=this.getColumnRenderer(t,e);if(s){const e=s.render();return s.onShowButtonsMobile=()=>{this.showColumnButtonsMobile(t,s,e)},s.onHideButtonsMobile=()=>{this.hideColumnButtonsMobile()},e}return null}getColumnRenderer(t,e){switch(t.expr.tag){case c.Constant:return new ConstColumnRendererCB(this,t,e);case c.AggregateFunction:return new AggrFuncColumnRendererCB(this,t,e);case c.CustomSql:return new CustomSqlColumnRendererCB(this,t,e);default:return new AttrColumnRendererCB(this,t,e)}}addNewColumn(t,e){this.getContext().getModel();const s=this.getQuery();if(Array.isArray(t)){let i=null,n=[];for(let o=0;o<t.length;o++)i=s.addColumn({attributeId:t[o],index:e},!0),i&&n.push(i);return n}return s.addColumn({attributeId:t,index:e})}toggleColumnPicked(t){let e,s;t&&(e=this.columnsBlock.querySelector(`div[data-id=${t.id}]`),e&&(s=e.classList.contains("active")));const i=this.columnsBlock.querySelectorAll(`.${this.cssPrefix}-row`);for(let t=0;t<i.length;t++){domel(i[t]).removeClass("active").data("show-buttons",null)}e&&!s&&domel(e).addClass("active").data("show-buttons","")}addColumnElement(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`),i=this.renderColumn(t);s.length>0&&e<s.length-1?this.columnsBlock.insertBefore(i,s[e]):this.columnsBlock.appendChild(i),this.options.columnRenderedCallback&&this.options.columnRenderedCallback(i)}checkColumnsArray(t){let e=t.length;const s=[];for(let i=0;i<e;i++)this.checkColumn(t[i])&&s.push(t[i]);return s}checkColumn(t){if(!this.options.allowDuplicates){const e=this.getQuery().getColumns(),s=JSON.stringify(t.expr);for(let t=0;t<e.length;t++){if(JSON.stringify(e[t].expr)===s)return null}}return t}getColumnsBlock(){return this.columnsBlock}showEntitiesMenu(t){this.entitiesMenu&&this.entitiesMenu.showMenu(t)}addAllColumnsToEntitiesList(t){const e=t.filter((t=>!t.isEntity)).map((t=>t.id));e.length>0&&t.unshift({id:"__AddAll__",text:o.getText("AddAllForEntityText"),extra:{ids:e}}),t.forEach((t=>{t.items&&this.addAllColumnsToEntitiesList(t.items)}))}createEntitiesMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;e&&(e+="-EntitiesMenu");const s=t.getEntitiesTree({addUIC:!1,addUIR:!0,addUIS:!1,attrPlacement:this.options.attrPlacement,sortEntities:this.options.sortEntities});this.options.showAddAllForEntity&&this.addAllColumnsToEntitiesList(s);const i={items:s,adjustHeight:this.options.adjustEntitiesMenuHeight,id:e,domWriteItemsId:this.options.domWriteItemsId};n.assign(i,this.options.menuOptions),this.entitiesMenu=new PopupMenu(i)}createSortMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;e&&(e+="-SortMenu");const s={items:this.sortMenuList.concat(this.moveMenuList),id:e,domWriteItemsId:this.options.domWriteItemsId};n.assign(s,this.options.menuOptions),s.searchBoxAlwaysShown=!1,this.sortMenu=new PopupMenu(s)}createMoveMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;e&&(e+="-MoveMenu");const s={items:this.moveMenuList,id:e,domWriteItemsId:this.options.domWriteItemsId};n.assign(s,this.options.menuOptions),this.moveMenu=new PopupMenu(s),s.searchBoxAlwaysShown=!1}moveColumn(t,e){const s=this.getQuery().getColumns(),i=s.indexOf(t);if(i>=0)switch(e){case"MoveTop":if(0==i)return;this.moveColumnCore(i,0);break;case"MoveUp":if(0==i)return;this.moveColumnCore(i,i-1);break;case"MoveDown":if(i==s.length-1)return;this.moveColumnCore(i,i+1);break;case"MoveBottom":if(i==s.length-1)return;this.moveColumnCore(i,s.length-1)}}moveColumnCore(t,e){const s=this.getQuery();if(!s)return;const i=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`),n=i[t];e<=0?this.columnsBlock.insertBefore(n,this.columnsBlock[0]):e<i.length?this.columnsBlock.insertBefore(n,i[e]):this.columnsBlock.appendChild(n),s.moveColumn(t,e),s.fireColumnsChangedEvent(p.All)}areCustomExpressionsAllowed(){return this.getQuery().isEx()&&this.getContext().options.allowCustomExpressions}}ColumnsBar.globalCounter=0;class ColumnRendererSB{constructor(t,e,s){this.functionMenu=null,this.isMouseOverBlock=!1,this.keepShowingButtons=!1,this.bar=t,this.column=e,this.element=s}get cssPrefix(){return"eqjs-sb"}render(){const t=domel("div");return t.data("id",this.column.id),this.element&&this.element.parentNode.replaceChild(t.toDOM(),this.element),this.element=t.toDOM(),this.bar.options.allowDragDrop&&M.registerDraggableItem({element:this.element,scope:"entityAttrSortSB",beforeDragStart:()=>this.element.dispatchEvent(createBrowserEvent("mouseleave")),onDragStart:t=>{this.element.style.display="none",t.dropEffect=I.Allow},onDragEnd:t=>{this.element.removeAttribute("style")},data:{column:this.column}}),t.addClass(this.getClassesToAdd()).addClass(getMobileCssClass()).addChildElement(this.renderCaptionBlock()),this.isEditable()&&t.addChildElement(this.renderSortingButton()),this.element}fireColumnChanged(){this.column.fireChangedEvent()}refresh(){this.render()}getAttribute(){return this.bar.getContext().getModel().getAttributeById(this.column.expr.value)}isEditable(){return this.column.enabled&&!this.column.isReadOnly()}renderCaptionBlock(){let t=this.column.caption;return this.isEditable()||(t+=function getArrow(t){switch(t){case m.Ascending:return" ";case m.Descending:return" ";default:return""}}(this.column.sorting)),domel("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-captionelement`).addClass(getMobileCssClass()).addChild("div",(e=>e.title(this.column.caption).text(t))).toDOM()}renderSortingButton(){const t=`${N}-column-sortbutton`;let e=t;switch(this.column.sorting){case m.None:e=`${t}-none`;break;case m.Ascending:e=`${t}-asc`;break;case m.Descending:e=`${t}-desc`}const s=domel("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-sortimage-placeholder`).addClass(getMobileCssClass()).addChild("div",(t=>t.addClass(`${this.cssPrefix}-img-sorting`,e).title(o.getText("ButtonSorting")))).on("touchstart click",(t=>this.buttonSortingClickHandler(t,s.toDOM())));return s.toDOM()}buttonSortingClickHandler(t,e){t.stopPropagation(),this.keepShowingButtons=!0;return this.bar.sortMenu.showMenu({anchor:e,selectedIds:null,itemSelectedCallback:(t,e)=>{if("None"==t.id||"Ascending"==t.id||"Descending"==t.id){const e=this.bar.getContext().getQuery();this.column.isJustSorted()&&"None"==t.id?(e.removeColumn(this.column),e.fireColumnsChangedEvent(p.Delete,this.column,!0)):(this.column.sorting="None"==(s=t.id)?m.None:"Ascending"==s?m.Ascending:"Descending"==s?m.Descending:void 0,this.column._sortIndex=e.getColumnSortIndex(this.column),this.fireColumnChanged())}else this.bar.moveColumn(this.column,t.id);var s},menuClosedCallback:()=>{this.keepShowingButtons=!1}}),!1}getClassesToAdd(){return`${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`}getUIS(){return this.bar.getContext().getModel().checkAttrProperty(this.column.expr.value,"useInSorting")}}class SortingBar extends Widget{get cssPrefix(){return"eqjs-sb"}constructor(t){super(t),this.options={showAddRow:!0,allowDragDrop:!0,menuOptions:{showSearchBoxAfter:30,searchBoxAutoFocus:!0,activateOnMouseOver:!0,adjustHeight:!0,itemRenderedCallback:null}},this.sortMenuList=[{id:"None",text:o.getText("CmdNotSorted")},{id:"Ascending",text:o.getText("CmdAscending")},{id:"Descending",text:o.getText("CmdDescending")},{id:"---",text:"---"},{id:"MoveTop",text:o.getText("CmdMoveToFirst")},{id:"MoveUp",text:o.getText("CmdMoveToPrev")},{id:"MoveDown",text:o.getText("CmdMoveToNext")},{id:"MoveBottom",text:o.getText("CmdMoveToLast")}],this.landingSlot=domel("div").addClass(`${N}-highlight`).toDOM(),this.landingIndex=-1,domel(this.slot).addClass(`${this.cssPrefix}-panel`).addClass(getMobileCssClass()),this.group=C.Query}getWidgetType(){return"sortingBar"}init(t,e){super.init(t,e),this.setOptions(e),e.attrElementFormat&&(this.context.options.attributeFormat=e.attrElementFormat),e.titleElementFormat&&(this.context.options.columnTitleFormat=e.titleElementFormat),this.destroyCore(),this.attachQueryObserver(),M.removeDropContainer(this.slot),this.options.allowDragDrop&&M.registerDropContainer({element:this.slot,scopes:["entityAttrSortSB"],onDragEnter:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragOver:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragLeave:(t,e)=>{e.dropEffect=I.Forbid,this.hideLandingSlot()},onDrop:(t,e)=>{if(this.landingIndex>=0){const t=this.getQuery();t.setColumnSortIndex(e.data.column,this.landingIndex),t.fireColumnsChangedEvent(p.All)}else e.item.element.removeAttribute("style")}})}setOptions(t){n.assignDeep(this.options,t)}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{const e=t.data;!e||e.part!=g.SortingColumns&&e.part!=g.Columns&&e.part!=g.All||this.refresh()}))}detachQueryObserver(){if(this.queryEventCallbackId){this.getQuery().removeChangedCallback(this.queryEventCallbackId)}}getQuery(){return this.getContext().getQuery()}getModel(){return this.getContext().getModel()}destroyCore(){this.detachQueryObserver(),this.clear()}refreshCore(){this.clear(),this.render()}renderAddRowButton(){domel(this.addRowButton).addClass(`${N}-addrow`,`${this.cssPrefix}-addrow`,`${N}-addrow-empty`).addClass(getMobileCssClass()).title(o.getText("CmdClickToAddColumn")).addChild("a",(t=>t.attr("href","javascript:void(0)").on("click",(t=>{t.preventDefault(),this.showEntitiesMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t.id;return this.addNewColumn(s),!1}})})))),w.isMobileMode()&&domel(this.columnsBlock).addChildElement(this.addRowButton)}showEntitiesMenu(t){this.entitiesMenu.showMenu(t)}createEntitiesMenu(){const t=this.getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;e&&(e+="-EntitiesMenu");const s={items:t.getEntitiesTree({addUIC:!1,addUIR:!1,addUIS:!0}),adjustHeight:this.options.adjustEntitiesMenuHeight,id:e,domWriteItemsId:this.options.domWriteItemsId};this.entitiesMenu=new PopupMenu(s)}createSortMenu(){const t=this.getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;e&&(e+="-SortMenu");const s={items:this.sortMenuList,id:e,searchBoxAlwaysShown:!1};this.sortMenu=new PopupMenu(s)}render(){this.createEntitiesMenu(),this.createSortMenu(),this.columnsBlock=domel("div").addClass(`${this.cssPrefix}-columns`).addClass(getMobileCssClass()).toDOM(),this.options.showAddRow&&(this.addRowButton=domel("div").toDOM(),w.isMobileMode()?domel(this.columnsBlock).addChildElement(this.addRowButton):domel(this.slot).addChildElement(this.addRowButton),this.renderAddRowButton()),domel(this.slot).addChildElement(this.columnsBlock);this.getQuery().getSortedColumns().forEach(((t,e)=>{const s=this.renderColumn(t);this.columnsBlock.appendChild(s)}))}addNewColumn(t){this.getModel();const e=this.getQuery(),s=e.addColumn({attributeId:t,justsorted:!0,sorting:m.Ascending},!0);return e.fireChangedEvent({part:g.SortingColumns,action:p.Add,changee:s,source:this}),s}renderColumn(t,e){const s=new ColumnRendererSB(this,t,e);if(s){return s.render()}return null}clear(){this.slot.innerHTML=""}moveColumn(t,e){const s=this.getQuery(),i=s.getSortedColumns(),n=s.getColumnSortIndex(t);if(n>=0)switch(e){case"MoveTop":s.setColumnSortIndex(t,0),s.fireChangedEvent({part:g.SortingColumns,action:p.Modify,source:this});break;case"MoveUp":s.setColumnSortIndex(t,n>0?n-1:0),s.fireChangedEvent({part:g.SortingColumns,action:p.Modify,source:this});break;case"MoveDown":s.setColumnSortIndex(t,n<i.length-1?n+1:i.length-1),s.fireChangedEvent({part:g.SortingColumns,action:p.Modify,source:this});break;case"MoveBottom":s.setColumnSortIndex(t,i.length-1),s.fireChangedEvent({part:g.SortingColumns,action:p.Modify,source:this})}}showLandingSlot(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`),i=[];for(let t=0;t<s.length;t++)"none"!==s[t].style.display&&i.push(s[t]);if(0===i.length)return void(this.landingIndex=0);const n=getElementAbsolutePos(this.landingSlot);if(t>=n.x&&t<=n.x+this.landingSlot.offsetWidth&&e>=n.y&&e<=n.y+this.landingSlot.offsetHeight)return;let o=this.landingIndex;for(let s=0;s<i.length;s++){const r=i[s],a=getElementAbsolutePos(r),l=r.offsetWidth,d=r.offsetHeight,h=.2*l,u=2;if(t>=a.x+h&&t<=a.x+l-h&&e>=a.y+u&&e<=a.y+d-u){o=t>n.x?s+1:s;break}}(o!=this.landingIndex||this.landingSlot.parentElement)&&(this.landingIndex=o,this.landingIndex<=0&&this.columnsBlock.insertBefore(this.landingSlot,i[0]),this.landingIndex<i.length?this.columnsBlock.insertBefore(this.landingSlot,i[this.landingIndex]):this.columnsBlock.appendChild(this.landingSlot))}hideLandingSlot(){this.landingIndex=-1,this.landingSlot.parentElement&&this.landingSlot.parentElement.removeChild(this.landingSlot)}}!function(t){t[t.None=0]="None",t[t.Value=1]="Value",t[t.Attribute=2]="Attribute",t[t.Operator=4]="Operator",t[t.Addition=8]="Addition",t[t.Removal=16]="Removal",t[t.All=255]="All",t[t.NoAddition=-9]="NoAddition",t[t.NoRemoval=-17]="NoRemoval",t[t.FixedConditionList=5]="FixedConditionList"}(H||(H={}));class TextRenderer{get cssPrefix(){return"eqjs-qp"}constructor(t,e,s){this.panel=t,this.text=e,this.element=s||domel("div").toDOM()}refresh(){this.render()}render(){return domel(this.element).html("").addClass(this.getClassesToAdd()).addClass(getMobileCssClass()).addChild("span",(t=>t.text(this.text).title(this.text))).toDOM(),this.element}getClassesToAdd(){return`${this.cssPrefix}-condelement`}}!function(t){t[t.AddCondition=0]="AddCondition",t[t.AddGroup=1]="AddGroup",t[t.Enable=2]="Enable",t[t.Delete=4]="Delete",t[t.Menu=5]="Menu",t[t.Parameterized=6]="Parameterized",t[t.InJoin=7]="InJoin"}(W||(W={}));class ConditionRenderer{constructor(t,e,s){this.panel=t,this.condition=e,this.element=s||domel("div").toDOM()}get cssPrefix(){return"eqjs-qp"}refresh(){this.render()}clear(){this.element&&(this.element.className="",this.element.removeAttribute("data-id"),this.element.removeAttribute("style"),domel(this.element).html(""))}render(t){return this.clear(),this.coreRender(t),this.panel.options.onConditionRendered&&this.panel.options.onConditionRendered(this.condition,this.element),this.element}isEditable(){return this.condition.enabled&&!this.condition.isReadOnly()}}class SimpleConditionRenderer extends ConditionRenderer{getClassesToAdd(){let t=`${this.cssPrefix}-row ${this.cssPrefix}-row-condition`;if(t+=this.condition.isInJoin()?` ${this.cssPrefix}-condition-injoin`:"",t+=this.condition.isParameterized()?` ${this.cssPrefix}-condition-parameterized`:"",!w.isMobileMode()){const e=this.condition.getLevel();e>0&&(t+=` ${this.cssPrefix}-level-${e}`)}return t+=this.condition.enabled?"":` ${this.cssPrefix}-disabled`,this.condition.enabled&&(t+=this.condition.isReadOnly()?` ${this.cssPrefix}-readonly`:""),t}coreRender(t){const e=this.panel.getContext().getModel(),s=e.getOperatorById(this.condition.getOperatorId()),i=d.parseOperatorFormat(s);let n=null;const o=i.length,r=domel("div");this.element&&this.element.parentNode&&this.element.parentNode.replaceChild(r.toDOM(),this.element),this.element=r.toDOM(),r.addClass(this.getClassesToAdd()).addClass(getMobileCssClass()).data("id",this.condition.id).data("condrow","").addChildElement(this.renderCheckbox()).addChildElement(this.renderConjunction());let a=t;const l=s==e.nullOperator?Math.min(o,this.condition.expressions.length+1):o;for(let t=0;t<l;t++)if(n=i[t],"operator"===n.type){const t=this.panel.getOperatorRenderer(this.condition,n.text);t&&r.addChildElement(t.render())}else if("expression"===n.type){const t=a&&n.index>0,e=this.panel.getExpressionRenderer(this.condition.expressions[n.index]);if(e){const s=e.render(t);r.addChildElement(s),setTimeout((()=>{e.adjustWidth()}),100)}a=a&&!t}else"text"===n.type&&r.addChildElement(new TextRenderer(this.panel,n.text).render());(this.panel.options.accentActiveCondition||w.isMobileMode())&&r.on("click",(t=>(t.stopPropagation(),this.panel.toggleConditionPicked(this.condition),this.adjustButtonsVisibility(),w.isMobileMode()||this.element.dispatchEvent(createBrowserEvent("mouseenter")),!1))),r.addChildElement(this.renderButtonsBlock()),w.isMobileMode()||r.on("mouseenter",(t=>(this.isMouseOverBlock=!0,this.enterButtonBlock(),t.stopPropagation(),!1))).on("mouseleave",(t=>(this.isMouseOverBlock=!1,!this.keepShowingButtons&&domel(this.buttonsBlock).isVisible()&&this.leaveButtonBlock(),t.stopPropagation(),!1)))}setConditionParameterized(t){this.condition.setParameterized(t),this.condition.fireChangedEvent()}setConditionInJoin(t){this.condition.setInJoin(t),this.condition.fireChangedEvent()}getConditionMenu(){return this.panel.getConditionMenu()}renderConjunction(){const t=this.condition.getParent();if(!t)return null;const e=0==n.findItemIndexById(t.getConditions(),this.condition.id);if(this.panel.options.showConjunctions&&!e){const t=d.linkTypeToStr(this.condition.getParent().linkType),e=o.getText("Conj"+t);return domel("span").text(e).title(e).addClass(`${this.cssPrefix}-condelement ${this.cssPrefix}-condition-conjuction`).toDOM()}return null}renderCheckbox(){return this.panel.options.showCheckboxes&&!this.condition.isReadOnly()?domel("div").title(o.getText("CmdToggleEnable")).attr("tabIndex","0").addClass(`${this.cssPrefix}-condelement ${this.cssPrefix}-condition-checkbox`).addClass(""+(this.condition.enabled?"enabled":"")).on("click",(()=>(this.condition.enabled=!this.condition.enabled,this.condition.fireChangedEvent(),!1))).on("keypress",(t=>{[13,32].includes(t.keyCode)&&t.target.click()})).toDOM():null}isConditionActive(){return this.element.classList.contains("active")}hideButtons(){domel(this.element).data("show-buttons",null)}showButtons(){domel(this.element).data("show-buttons","")}adjustButtonsVisibility(){(this.panel.options.alwaysShowButtonsInConditions||this.panel.options.accentActiveCondition&&this.isConditionActive())&&this.showButtons()}enterButtonBlock(){this.showButtons()}leaveButtonBlock(){this.panel.options.alwaysShowButtonsInConditions||this.isConditionActive()&&this.panel.options.accentActiveCondition||this.hideButtons()}conditionMenuHandler(t,e){switch(t){case W.AddCondition:if(!this.condition.isGroup())return;const t=this.panel.getEntitiesMenu();t&&t.showMenu({anchor:e.target,itemSelectedCallback:t=>{const e=this.panel.getQuery(),s={parent:this.condition,attributeId:t.id},i=e.addSimpleCondition(s);return i&&e.fireConditionsChangedEvent(p.Add,i),!1}});break;case W.AddGroup:if(!this.condition.isGroup())return;const s=this.panel.getQuery(),i={parent:this.condition},n=this.panel.getQuery().addConditionGroup(i);n&&s.fireConditionsChangedEvent(p.Add,n);break;case W.Enable:this.condition.enabled=!this.condition.enabled,this.condition.fireChangedEvent();break;case W.Delete:const o=this.condition.getParent();if(!o)return;const r=o.getConditions(),a=r.indexOf(this.condition);a>=0&&(r.splice(a,1),this.condition.getQuery().fireConditionsChangedEvent(p.Delete,this.condition));break;case W.Menu:const l=this.getConditionMenu();this.keepShowingButtons=!0,l.showMenu({anchor:e.target,selectedIds:this.getConditionMenuSelectedItems(),itemSelectedCallback:t=>{let s;switch(t.id){case"enable":s=W.Enable;break;case"delete":s=W.Delete;break;case"param":s=W.Parameterized;break;case"inJoin":s=W.InJoin;break;case"addCondition":s=W.AddCondition;break;case"addGroup":s=W.AddGroup}this.conditionMenuHandler(s,e)},itemFilterCallback:t=>{let e=this.condition.enabled||"enable"===t.id||"delete"===t.id;if("enable"===t.id){const t=this.condition.getParent();e=e&&t&&t.enabled}else"delete"===t.id?e=e&&(this.panel.options.editableParts&H.Removal)===H.Removal:"addGroup"!==t.id&&"addCondition"!==t.id||(e=e&&(this.panel.options.editableParts&H.Addition)===H.Addition);return e},menuClosedCallback:()=>{this.keepShowingButtons=!1,this.isMouseOverBlock||this.leaveButtonBlock()}});break;case W.Parameterized:this.condition.setParameterized(!this.condition.isParameterized()),this.condition.fireChangedEvent();break;case W.InJoin:this.condition.setInJoin(!this.condition.isInJoin()),this.condition.fireChangedEvent()}return e.stopPropagation(),!1}getConditionMenuSelectedItems(){let t=[];return this.condition.enabled&&t.push("enable"),this.condition.isParameterized()&&t.push("param"),this.condition.isInJoin()&&t.push("inJoin"),t}renderButtonsBlock(){const onButtonMouseEnter=t=>{domel(t.target).addClass(`${this.cssPrefix}-condition-button-active`)},onButtonMouseLeave=t=>{domel(t.target).removeClass(`${this.cssPrefix}-condition-button-active`)},t=domel("div").addClass(`${this.cssPrefix}-condition-buttonsBlock`).addClass(getMobileCssClass());if(this.buttonsBlock=t.toDOM(),this.condition.isReadOnly())return this.buttonsBlock;const e=this.getButtonsToShow();e.indexOf("addCondition")>=0&&this.condition.enabled&&(this.panel.options.editableParts&H.Addition)==H.Addition&&t.addChild("div",(t=>{t.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(t=>{t.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-addCondition`).attr("tabIndex","0").data("button","").title(o.getText("CmdAddCondition")).on("click",(t=>this.conditionMenuHandler(W.AddCondition,t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})).on("mouseenter",onButtonMouseEnter).on("mouseleave",onButtonMouseLeave)}))}));return(e.indexOf("addGroup")>=0||e.indexOf("addPredicate")>=0)&&this.condition.enabled&&(this.panel.options.editableParts&H.Addition)==H.Addition&&t.addChild("div",(t=>{t.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(t=>{t.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-addPredicate`).attr("tabIndex","0").data("button","").title(o.getText("CmdAddCondGroup")).on("click",(t=>this.conditionMenuHandler(W.AddGroup,t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})).on("mouseenter",onButtonMouseEnter).on("mouseleave",onButtonMouseLeave)}))})),this.getButtonsToShow().indexOf("enable")>=0&&this.condition.getParent()&&this.condition.getParent().enabled&&t.addChild("div",(t=>{t.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(t=>{t.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-enable`).attr("tabIndex","0").data("button","").title(o.getText("CmdToggleEnable")).addClass(this.condition.enabled?"enabled":"").on("click",(t=>this.conditionMenuHandler(W.Enable,t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})).on("mouseenter",onButtonMouseEnter).on("mouseleave",onButtonMouseLeave)}))})),this.getButtonsToShow().indexOf("delete")>=0&&this.condition.getParent()&&(this.panel.options.editableParts&H.Removal)==H.Removal&&t.addChild("div",(t=>{t.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(t=>{t.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-delete`).attr("tabIndex","0").data("button","").title(o.getText("CmdDelete")).on("click",(t=>this.conditionMenuHandler(W.Delete,t))).on("keypress",(t=>{13==t.keyCode&&t.target.click()})).on("mouseenter",onButtonMouseEnter).on("mouseleave",onButtonMouseLeave)}))})),this.getButtonsToShow().indexOf("menu")>=0&&t.addChild("div",(t=>{t.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(t=>{t.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-menu`).attr("tabIndex","0").data("button","").title(o.getText("ButtonMenu")).on("click",(t=>this.conditionMenuHandler(W.Menu,t))),w.isMobileMode()||t.on("keypress",(t=>{13==t.keyCode&&t.target.click()})).on("mouseenter",onButtonMouseEnter).on("mouseleave",onButtonMouseLeave)}))})),this.adjustButtonsVisibility(),this.buttonsBlock}getButtonsToShow(){return this.panel.options.buttons&&this.panel.options.buttons.condition&&Array.isArray(this.panel.options.buttons.condition)?this.panel.options.buttons.condition:["enable","delete"]}}class DomDropDownElementBuilder extends DomElementBuilder{constructor(t){super("a",t),this.attr("href","javascript:void(0)"),this.on("click",(t=>(t.preventDefault(),this.appear(),!1)))}onGetMenu(t){return this._onGetMenu=t,this}onItemSelected(t){return this._onItemSelected=t,this}appear(){const t=this._onGetMenu?this._onGetMenu():null;t&&t.showMenu({anchor:this.element,itemSelectedCallback:t=>(this._onItemSelected&&this._onItemSelected(t.id),!1)})}}class ConditionGroupRenderer extends ConditionRenderer{constructor(t,e,s){super(t,e,s),this.isRoot=!e.getParent()}getClassesToAdd(){let t=`${this.cssPrefix}-group`;return this.isRoot&&(t+=` ${this.cssPrefix}-group-root`),t}coreRender(t){domel(this.element).addClass(this.getClassesToAdd()).addClass(getMobileCssClass()).addChildElement(this.renderGroupRow()).addChildElement(this.renderConditions(t)).data("id",this.condition.id).data("group","")}renderGroupRow(){return this.isRoot&&!this.panel.options.showRootRow?null:new ConditionGroupRowRenderer(this.panel,this.condition).render()}renderConditions(t){const e=domel("div");return e.addClass(`${this.cssPrefix}-conditions`).addClass(`${getMobileCssClass()}`).data("conditions",""),this.isRoot&&e.addClass(`${this.cssPrefix}-conditions-root`),this.condition.getConditions().forEach(((s,i,n)=>{const o=this.panel.getConditionRenderer(s);o&&e.addChildElement(o.render(t&&i==n.length-1))})),e.toDOM()}}class ConditionGroupRowRenderer extends SimpleConditionRenderer{constructor(t,e,s){super(t,e,s),this.isRoot=!this.condition.getParent()}getButtonsToShow(){return this.panel.options.buttons&&this.panel.options.buttons.group&&Array.isArray(this.panel.options.buttons.group)?this.panel.options.buttons.group:["addCondition","addGroup","enable","delete"]}getClassesToAdd(){let t;if(this.isRoot)t=`${this.cssPrefix}-row ${this.cssPrefix}-row-group ${this.cssPrefix}-row-group-root`;else{t=`${this.cssPrefix}-row ${this.cssPrefix}-row-group`;const e=this.condition.getLevel();e>0&&(t+=` ${this.cssPrefix}-level-${e}`),t+=this.condition.enabled?"":` ${this.cssPrefix}-disabled`,this.condition.enabled&&(t+=this.condition.isReadOnly()?` ${this.cssPrefix}-readonly`:"")}return t}coreRender(t){const e=domel(this.element).addClass(this.getClassesToAdd()).addClass(getMobileCssClass()).data("group-row","").addChildElement(this.renderCheckbox()).addChildElement(this.renderConjunction()),s=this.condition.getLevel();s>0&&e.addClass(`${this.cssPrefix}-level-${s}`),this.buildGroupElements(e,this.getGroupTitle()),this.panel.options.accentActiveCondition&&e.on("click",(t=>{this.panel.toggleConditionPicked(this.condition),this.adjustButtonsVisibility(),w.isMobileMode()||e.toDOM().dispatchEvent(createBrowserEvent("mouseenter"))})),e.addChildElement(this.renderButtonsBlock()),w.isMobileMode()||e.on("mouseenter",(t=>(this.isMouseOverBlock=!0,this.enterButtonBlock(),t.stopPropagation(),!1))).on("mouseleave",(t=>(this.isMouseOverBlock=!1,!this.keepShowingButtons&&domel(this.buttonsBlock).isVisible()&&this.leaveButtonBlock(),t.stopPropagation(),!1)))}getGroupTitle(){let t;return this.isRoot&&!w.isMobileMode()?(t=o.getText("RootConditionGroupTitle"),t||(t=o.getText("RootPredicateTitle"))):(t=o.getText("ConditionGroupTitle"),t||(t=o.getText("PredicateTitle"))),t}buildGroupElements(t,e){const s=e.indexOf("{lt}");if(s<0)t.addText(o.getText("ErrIncorrectGroupTitleFormat")),t.addClass(`${this.cssPrefix}-error`);else{s>0&&t.addChild("span",(t=>{t.addClass(`${this.cssPrefix}-grelement`).addText(e.substring(0,s))}));const i=d.linkTypeToStr(this.condition.linkType);let r=n.findItemById(T.predicateLinkTypeList,i);r||(r=T.predicateLinkTypeList[0]),this.isEditable()?function dropdown(t){return new DomDropDownElementBuilder(t)}(t.toDOM()).onGetMenu((()=>this.getLinkTypeMenu())).onItemSelected((t=>{this.condition.linkType=d.strToLinkType(t),this.condition.fireChangedEvent()})).addText(o.getText(r.key)).title(o.getText(r.key)).addClass(`${this.cssPrefix}-grelement`):t.addChild("span",(t=>{t.text(o.getText(r.key)).title(o.getText(r.key)).addClass(`${this.cssPrefix}-grelement`)})),t.addChild("span",(t=>{t.addClass(`${this.cssPrefix}-grelement`).addText(e.substring(s+4))}))}}getConditionMenu(){return this.panel.getConditionGroupMenu(null==this.condition.getParent())}getLinkTypeMenu(){return this.panel.getLinkTypeMenu()}renderConjunction(){return this.isRoot?null:super.renderConjunction()}renderCheckbox(){return this.isRoot?null:super.renderCheckbox()}leaveButtonBlock(){this.panel.options.alwaysShowButtonsInGroups||this.isConditionActive()&&this.panel.options.accentActiveCondition||this.hideButtons()}adjustButtonsVisibility(){(this.panel.options.alwaysShowButtonsInGroups||this.panel.options.accentActiveCondition&&this.isConditionActive())&&this.showButtons()}}class BaseElementRenderer{constructor(t){this.element=t||domel("div").toDOM()}refresh(){this.render()}render(t=!1){return this.labelElement=this.renderLabelElement(),domel(this.element).html("").addClass(this.getClassesToAdd()).addClass(getMobileCssClass()).addChildElement(this.labelElement),this.isEditable()&&(this.renderEditor(),t&&setTimeout((()=>this.showEditor()),50)),this.element}isEditable(){return!0}renderLabelElement(){const t=this.getLabelText();return this.isEditable()?domel("a").attr("href","javascript:void(0)").title(t).text(t).on("click",(t=>(t.preventDefault(),this.showEditor(),!1))).toDOM():domel("span").title(t).text(t).toDOM()}getClassesToAdd(){return""}getLabelText(){return this.getEmptyText()}getEmptyText(){return"<empty>"}}class ExpressionRenderer extends BaseElementRenderer{get cssPrefix(){return"eqjs-qp"}constructor(t,e,s,i){super(i),this.panel=t,this.expression=e,this.valueEditor=s}render(t=!1){return super.render(t),this.panel.options.onExpressionRendered&&this.panel.options.onExpressionRendered(this.expression,this.element),this.element}getContext(){return this.panel.getContext()}isReadOnly(){const t=this.expression.getParent();return!t.enabled||t.isReadOnly()}isEditable(){return!this.isReadOnly()}getClassesToAdd(){return`${this.cssPrefix}-condelement ${this.cssPrefix}-valueelement`}getLabelText(){return this.expression.isEmpty()?this.getEmptyText():this.expression.value}getEmptyText(){return this.panel.options.emptyTextValue||o.getText("MsgEmptyScalarValue")}setValue(t,e){this.expression.setValue(t),e||this.expression.getParent().fireChangedEvent(y.Value)}getValue(){return this.expression.value}validateInput(t){return{success:!0,value:t}}showValidationError(t,e){this.getContext().throwError({action:"ui.validation",text:t})}isEmptyValue(){let t=this.getValue();return null==t||!t}adjustWidth(){}}class InputExpressionRenderer extends ExpressionRenderer{renderEditor(){this.inputBuilder=domel("input").hide().addClass(`${this.cssPrefix}-ve-editbox`).type("text").on("blur",(t=>{if(this.inputBuilder.isVisible()&&!this.dontProcessBlur){const e=this.validateInput(this.inputElement.value);return e.success?(this.setValue(this.inputElement.value),this.closeEditor()):(this.dontProcessBlur=!0,this.inputElement.focus(),setTimeout((()=>{this.dontProcessBlur=!1}),200),this.showValidationError(e.message,t.target)),t.stopPropagation(),!1}})).on("keydown",(t=>{if(27===t.keyCode)return this.closeEditor(),t.stopPropagation(),!1;if(13===t.keyCode&&this.inputBuilder.isVisible()){this.dontProcessBlur=!0;const e=this.validateInput(this.inputElement.value);return e.success?(this.setValue(this.inputElement.value),this.closeEditor(),this.dontProcessBlur=!1):(this.inputElement.focus(),this.showValidationError(e.message,t.target),setTimeout((()=>{this.dontProcessBlur=!1}),200)),t.stopPropagation(),!1}})),this.inputElement=this.inputBuilder.toDOM(),domel(this.element).addChildElement(this.inputElement)}showEditor(){const t=200;if(!w.isMobileMode()){let e=this.element.offsetLeft,s=this.element.offsetWidth>t?this.element.offsetWidth:t,i=this.element.parentElement.clientWidth-e-55;this.inputBuilder.removeStyle("left").removeStyle("right"),i<t?this.inputBuilder.setStyle("right","55px").setStyle("width","200px"):i<s?this.inputBuilder.setStyle("left",`${e}px`).setStyle("width",`${i}px`):this.inputBuilder.setStyle("left",`${e}px`).setStyle("width",`${s}px`)}domel(this.labelElement).hide(),this.inputBuilder.value(this.getValue()).show(),this.inputElement.focus()}closeEditor(){this.inputBuilder.hide(),domel(this.labelElement).show(),this.labelElement.focus()}validateInput(t){this.inputBuilder.removeClass("eqjs-invalid");const e={success:!0,value:t};return this.expression.kind==h.List?this.validateListInput(t,e):this.validateScalarInput(t,e),e}validateListInput(t,e){let s=t.split(/\s*,\s*/);for(let t of s)if(this.validateScalarInput(t,e),!e.success)return}validateScalarInput(t,e){if(t&&n.isNumericType(this.expression.dataType)){let s=+t;isNaN(s)&&(e.success=!1,e.message='"'+t+'" '+o.getText("ErrNotNumber")),n.isIntType(this.expression.dataType)&&s!=parseInt(t,10)&&(e.success=!1,e.message='"'+t+'" '+o.getText("ErrIncorrectInteger"))}}showValidationError(t,e){super.showValidationError(t,e),this.inputBuilder.addClass("eqjs-invalid")}isEditable(){return super.isEditable()&&(this.panel.options.editableParts&H.Value)===H.Value}}class ListExpressionRenderer extends ExpressionRenderer{constructor(){super(...arguments),this.menuItemsList=[],this.showWhenReady=!1}isEditable(){return!this.isReadOnly()&&(this.panel.options.editableParts&H.Value)===H.Value}setValue(t,e=!1){const s=this.adjustNewValue(t);if(t!==this.expression.value){const i=this.getValueText(t);this.expression.setContent(s,i),e||this.expression.getParent().fireChangedEvent(y.Value)}return!0}getValueText(t){let e="";if(Array.isArray(t))for(let s of this.menuItemsList)t.indexOf(s.id)>=0&&(e+=s.text+",");else for(let s of this.menuItemsList)s.id===t&&(e+=s.text+",");return e&&(e=e.substring(0,e.length-1)),e}getEmptyText(){return this.panel.options.emptyTextList||o.getText("MsgEmptyListValue")}getListName(){return this.valueEditor.name}renderEditor(){this.fillMenuItemsList((()=>{this.renderMenuBlock()}))}getLabelText(){return this.expression.isEmpty()?this.getEmptyText():this.expression.getText()}showLoader(){}hideLoader(){}showEditor(){this.menu?this.menu.showMenu({anchor:this.labelElement,selectedIds:this.getValuesAsArray(),itemSelectedCallback:(t,e)=>{if(this.menu.options.multiselect){if(e){let t=[],s=e.length;for(let i=0;i<s;i++)t.push(e[i].id);this.setValue(t)}}else this.setValue(t.id);return!1}}):(this.showWhenReady=!0,this.showLoader())}closeEditor(){this.menu.hideMenu()}renderMenuBlock(){let t=!1;this.expression&&(t=this.expression.kind===h.List);const e=this.panel,s={items:this.menuItemsList,multiselect:t,container:e?e.options.menuContainer:null,showSelected:!0,showItemIds:!!e&&e.options.showIdsForListItems};e&&n.assignDeep(s,e.options.menuOptions);let i=this.element.id;i&&(s.id=i+"-EditorMenu"),e&&(s.domWriteItemsId=e.options.domWriteItemsId),s.buttons={submit:o.getText("ButtonApply"),cancel:o.getText("ButtonCancel")},this.menu=new PopupMenu(s)}getValuesAsArray(){if(this.expression.kind!==h.List)return[this.expression.value];if(this.expression.value){const t=this.expression.value.match(/"[^"\\]*(?:\\.[^"\\]*)*"|[^,]+/g);return t?t.map((t=>'"'==t.charAt(0)&&'"'==t.charAt(t.length-1)?(t=t.substring(1,t.length-1)).replace(/\"/g,'"'):t)):[]}return[]}adjustNewValue(t){return Array.isArray(t)?t.map((t=>t.indexOf(",")>=0?'"'+(t=t.replace(/"/g,'"'))+'"':t)).join(","):t}fillMenuItemsList(t){this.menuItemsList=this.valueEditor.values,t&&t()}takeDefaultValue(){if(!this.menuItemsList)return;let t=this.menuItemsList.length,e=this.valueEditor.defValue;for(let s=0;s<t;s++){let t=this.menuItemsList[s];if(t.isDefault||e==t.id){this.setValue(t.id,!0);break}}}}class CustomListExpressionRenderer extends ListExpressionRenderer{constructor(){super(...arguments),this.isLoading=!1,this.onClickTemp=null}renderEditor(){this.isLoading||(this.isLoading=!0,this.fillMenuItemsList((()=>{if(this.isLoading=!1,this.isEmptyValue()&&this.takeDefaultValue(),!this.expression.isEmpty()&&this.expression._isDefaultValue){const t=this.getValueText(this.expression.value);this.expression.setContent(this.expression.value,t),this.expression.getParent().fireChangedEvent()}this.renderMenuBlock(),this.showWhenReady&&(this.showWhenReady=!1,this.hideLoader(),this.showEditor())})))}showLoader(){this.labelElement.style.display="none",this.loaderElement||(this.loaderElement=domel("div",this.element).addClass(`${this.cssPrefix}-ve-loader`).toDOM()),this.loaderElement.style.display="block"}hideLoader(){this.loaderElement.style.display="none",this.labelElement.removeAttribute("style")}fillMenuItemsList(t){const e=this.getListName(),s=this.panel.getContext().getListRequestHandler();T.constLists[e]?(this.menuItemsList=T.constLists[e],t&&t()):s&&s({listName:e,editorId:this.valueEditor.id,editorParams:this.valueEditor.extraParams,value:this.getValue()},(e=>{this.menuItemsList=e,t&&t()}))}}class SqlListExpressionRenderer extends CustomListExpressionRenderer{fillMenuItemsList(t){const e=this.panel.getContext();this.valueEditor;const s=e.getListRequestHandler();if(s){s({listName:"SQL",editorId:this.valueEditor.id,editorParams:this.valueEditor.extraParams,value:this.getValue()},(e=>{this.menuItemsList=e,t&&t()}))}}}class AttributeExpressionRenderer extends ListExpressionRenderer{constructor(t,e,s,i){super(t,e,null,i),this.menu=s}renderEditor(){}getLabelText(){const t=this.panel.getContext().getModel(),e=this.expression.value,s=e?t.getAttributeByIdSafe(e):null,i=this.panel.options.attrElementFormat;return s?t.getAttributeText(s,i):this.getEmptyText()}setValue(t,e=!1){e=e&&t!==this.expression.value;const s=super.setValue(t,!0);return e||this.expression.getParent().fireChangedEvent(y.EntityAttr|y.Operator),s}isEditable(){return!this.isReadOnly()&&(this.panel.options.editableParts&H.Attribute)===H.Attribute}getEmptyText(){return this.panel.options.emptyTextAttribute||o.getText("MsgEmptyAttrValue")}getClassesToAdd(){return`${this.cssPrefix}-condelement ${this.cssPrefix}-attrelement`}adjustWidth(){if(w.isMobileMode())return;this.element.clientWidth>this.element.parentElement.clientWidth/2&&domel(this.element).addClass(`${this.cssPrefix}-attrelement-wide`)}}class DropDownRenderer extends BaseElementRenderer{constructor(t){super(t)}showEditor(){const t=this.getMenu();t&&t.showMenu({anchor:this.labelElement,itemSelectedCallback:t=>(this.itemSelected(t.id),!1)})}closeEditor(){const t=this.getMenu();t&&t.hideMenu()}}class AddRowRenderer extends DropDownRenderer{constructor(t,e,s){super(s),this.panel=t,this.menu=e}get cssPrefix(){return"eqjs-qp"}getLabelText(){return o.getText("CmdClickToAddCondition")}getClassesToAdd(){return`${N}-addrow ${this.cssPrefix}-addrow`}isEditable(){return super.isEditable()&&(this.panel.options.editableParts&H.Addition)===H.Addition}renderLabelElement(){const t=this.getLabelText();return this.isEditable()?this.labelElement=domel("a").attr("href","javascript:void(0)").title(t).text(t).on("click",(t=>(t.preventDefault(),this.showEditor(),!1))).toDOM():this.labelElement=domel("div").toDOM(),this.labelElement}renderEditor(){}itemSelected(t){const e=this.panel.getQuery(),s={parent:e.getRootCondition(),attributeId:t},i=e.addSimpleCondition(s);i&&e.fireConditionsChangedEvent(p.Add,i)}getMenu(){return this.menu}}class OperatorRenderer extends DropDownRenderer{get cssPrefix(){return"eqjs-qp"}constructor(t,e,s,i){super(i),this.panel=t,this.condition=e,this.displayedText=s}renderEditor(){const t=this.panel.getContext().getModel(),e=this.panel.getQuery(),s=[],i=(this.condition&&this.condition.expressions&&this.condition.expressions[0]?this.condition.expressions[0].value:null)?t.getAttributeById(this.condition.expressions[0].value):null;i&&i.operators&&i.operators.forEach((i=>{const n=t.getOperatorById(i),r=(t=>t.defaultOperand.kind==h.Query)(n);!e.isEx()&&r||!n||this.panel.options.isSubQuery&&r||s.push({id:i,text:o.getText("Operators",i,"caption")||n.caption})}));const r={items:s,adjustHeight:this.panel.options.adjustEntitiesMenuHeight,id:n.generateId("opmn"),domWriteItemsId:this.panel.options.domWriteItemsId};n.assign(r,this.panel.options.menuOptions),this.menu=new PopupMenu(r)}getLabelText(){return this.displayedText}getEmptyText(){return this.panel.options.emptyTextOperator||o.getText("MsgEmptyOperator")}getClassesToAdd(){return`${this.cssPrefix}-condelement ${this.cssPrefix}-operelement`}isEditable(){return this.condition.enabled&&!this.condition.isReadOnly()&&(this.panel.options.editableParts&H.Operator)===H.Operator}itemSelected(t){this.condition.setOperatorId(t),this.condition.fireChangedEvent(y.Operator)}getMenu(){return this.menu}}class DateTimeExpressionRenderer extends ExpressionRenderer{constructor(){super(...arguments),this.dtp=null,this.internalDateFormat="yyyy-MM-dd",this.internalTimeFormat="HH:mm"}renderEditor(){}showEditor(){if(this.dtp)return;const e={yearRange:this.panel.options.yearRange,showCalendar:this.expression.dataType!==t.Time,showTimePicker:this.expression.dataType!==t.Date,oneClickDateSelection:this.panel.options.oneClickDateSelection,showDateTimeInput:this.panel.options.showDateTimeInput,onApply:t=>{const e=this.convertToInternalFormat(t);this.setValue(e),this.dtp=null,setTimeout((()=>this.labelElement.focus()),100)},onCancel:()=>{this.labelElement.innerText=this.getLabelText(),this.dtp=null,setTimeout((()=>this.labelElement.focus()),100)},onDateTimeChanged:t=>{const e=o.dateTimeToStrEx(t,this.expression.dataType);this.labelElement.innerText=e}};this.dtp=this.panel.options.dateTimePickerResolver?this.panel.options.dateTimePickerResolver(e):new DefaultDateTimePicker(e);const s=this.expression.getModel(),i=this.expression.value;let n=new Date;n=this.expression.dataType!=t.Time&&s.isDateMacro(i)?s.getDateMacroValue(i):this.expression.dataType==t.Time&&s.isTimeMacro(i)?s.getTimeMacroValue(i):this.convertFromInternalFormat(i,new Date),this.dtp.setDateTime(n),this.dtp.show(this.element)}closeEditor(){this.dtp.cancel(),this.dtp=null}getLabelText(){if(!this.expression.value)return this.getEmptyText();const t=this.expression.value,e=this.expression.getModel();if(!e)throw new Error("DataModel is not defined for "+this.expression.value);if(e.isDateMacro(t)||e.isTimeMacro(t)){let e=t.substring(3,t.length-2),s=o.getText(e);return s||"${{Today}}"}return o.dateTimeToStrEx(this.convertFromInternalFormat(t),this.expression.dataType)}isEditable(){return super.isEditable()&&(this.panel.options.editableParts&H.Value)===H.Value}convertFromInternalFormat(t,e){try{return n.strToDateTime(t,this.internalDateFormat+" "+this.internalTimeFormat)}catch(t){return e||new Date}}convertToInternalFormat(t){return o.dateTimeToStr(t,this.internalDateFormat+" "+this.internalTimeFormat)}}class SubQueryExpressionRenderer extends ExpressionRenderer{renderEditor(){this.dialogBlockBody=domel("div").addClass("kfrm-form").toDOM(),this.createEntitiesMenu(),this.renderColumnBlock(),this.renderQueryPanelBlock()}isEditable(){return super.isEditable()&&(this.panel.options.editableParts&H.Value)===H.Value}setValue(t,e){t instanceof Query&&(this.expression.subQuery=t,e||this.expression.getParent().fireChangedEvent(y.Value))}createEntitiesMenu(){const t=this.getContext().getModel(),e=this.expression.dataType;if(this.colEntitiesList=t.getEntitiesTreeWithFilter(((t,s)=>s?s.useInConditions&&s.dataType===e:t.attributes&&t.useInConditions)),!t||t.isEmpty())return null;let s=this.element.getAttribute("data-id");s&&(s+="-SubColumnMenu");const i={items:this.colEntitiesList,adjustHeight:this.panel.options.adjustEntitiesMenuHeight,id:s,isSubQuery:!0,domWriteItemsId:this.panel.options.domWriteItemsId};n.assign(i,this.panel.options.menuOptions),this.colEntitiesMenu=new PopupMenu(i)}renderColumnBlock(){this.columnBlock=domel("div",this.dialogBlockBody).addClass("kfrm-field").addChild("label",(t=>t.addText(o.getText("SubQueryColumnTitle")))).addChild("a",(t=>this.columnElement=t.attr("href","javascript:void(0)").on("click",(t=>{this.colEntitiesMenu.showMenu({anchor:this.columnElement,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t.id;return this.setResultAttributeId(s),!1}})})).toDOM())).toDOM()}getEmptyText(){return this.panel.options.emptyTextValue||o.getText("MsgSubQueryValue")}renderQueryPanelBlock(){const t=domel("div",this.dialogBlockBody).addClass("kfrm-field").addChild("label",(t=>t.addText(o.getText("SubQueryQueryPanelCaption")))).toDOM();this.subQueryPanelBlock=domel("div",t).toDOM();let e=this.element.getAttribute("data-id");e&&(this.subQueryPanelBlock.id=e+"-SubQueryPanel")}setResultAttributeId(t){let e=this.getContext().getModel().getAttributeById(t);if(e&&this.subQuery){let s,i=this.subQuery.getColumns();if(i.length>0)s=i[0],s.expr.setValue(t),s.expr.dataType=e.dataType,s.fireChangedEvent();else{s=this.subQuery.createColumn(),s.sorting=m.None,s.sortIndex=-1;let n=new Expression(s);n.setValue(t),n.tag=c.EntityAttribute,n.kind=h.Attribute,n.dataType=e.dataType,s.expr=n,i.push(s),this.subQuery.fireColumnsChangedEvent(p.Add,s)}this.columnElement.innerText=this.getAttributeText(e)}}getAttributeText(t){if(!t)return o.getText("SubQueryEmptyColumn");let e=o.getText("Attributes",t.id);e||(e=t.caption);let s=this.panel.options.attrElementFormat;if(!s)return e;let i=s.replace(new RegExp("{attr}","g"),e),n=this.getContext().getModel().getFullEntityPathByAttr(t.id,".");return i.replace(new RegExp("{entity}","g"),n)}showEditor(){const t=this.panel,e=this.getContext();this.subQueryPanelBlock.innerHTML="",this.subQuery=e.createQuery(),this.expression.subQuery&&this.subQuery.loadFromData(this.expression.subQuery.toJSONData());let s=n.assign({},t.options);s.isSubQuery=!0,s.showAddRow=!0,s.menuContainer=document.body,s.menuOptions.isSubQuery=!0,s.entitiesListFilter=(e,s)=>{if(t.options.entitiesListFilter){let i=s||{};i.isSubQuery=!0,t.options.entitiesListFilter(e,i)}};let i=this.panel.clonePanel(this.subQueryPanelBlock,this.subQuery);i.init(this.panel.getContext(),s);let r=null,a=this.subQuery.getColumns();if(0==a.length){let t=this.expression.getParent();if(t.expressions.length>0){let e=t.expressions[0];r=e.tag==c.EntityAttribute||e.kind==h.Attribute?e.value:null}}else r=a[0].expr.value;r?this.setResultAttributeId(r):this.columnElement.innerText=o.getText("SubQueryEmptyColumn"),i.refresh();const l=this.subQueryPanelBlock.querySelector(".eqjs-qp-conditions-root");l&&(l.style.minHeight="100px");this.panel.getContext().getServices().getService("DialogService").open({title:o.getText("SubQueryDialogTitle"),body:this.dialogBlockBody,width:this.panel.options.subQueryDialogWidth,closable:!0,cancelable:!0,onSubmit:()=>{const t=this.subQuery;return!!t.tryValidate({checkExpressions:!0})&&(this.setValue(t),!0)}})}closeEditor(){}}class BindToParentColumnExpressionRenderer extends CustomListExpressionRenderer{constructor(t,e,s,i){super(t,e,s,i),this.expression.tag=c.ParentColumn}fillMenuItemsList(t){const e=this.panel.getQuery().getParentQuery(),s=this.expression.getParent().expressions[0].dataType;this.menuItemsList=e.getColumns().filter((t=>t.expr.dataType==s)).map((t=>({id:t.id,text:t.caption}))),t&&t()}}class QueryPanel extends Widget{get cssPrefix(){return"eqjs-qp"}constructor(t,e){super(t),this.options={editableParts:H.All,isSubQuery:!1,activeCondition:null,entitiesPopupHandler:null,entitiesListFilter:null,menuContainer:document.body,showRootRow:!0,showAddRow:!0,showCheckboxes:!1,allowParameterization:!1,allowInJoinConditions:!1,showPoweredBy:!1,buttons:{condition:null,group:null},alwaysShowButtonsInGroups:!1,alwaysShowButtonsInConditions:!1,showConjunctions:!0,accentActiveCondition:!0,activateRootOnStart:!0,yearRange:"c-10:c+10",oneClickDateSelection:!0,showDateTimeInput:!1,attrElementFormat:"{entity} {attr}",menuOptions:{showSearchBoxAfter:30,searchBoxAutoFocus:!0,activateOnMouseOver:!0,itemRenderedCallback:null},allowDragDrop:!0,attrPlacement:0,sortEntities:!1,subQueryDialogWidth:600,subQueryDialogHeight:300,dialogZIndex:1e5,numberListSeparators:[",",";"],autoEditNewCondition:!1,onConditionRendered:null,onGetConditionRenderer:null,onGetExpressionRenderer:null,onGetOperatorRenderer:null,onOperatorRendered:null,onGetAddRowRenderer:null,defaultQuery:null,showIndicatorOnLoad:!0},this.customQuery=null,this.landingSlot=domel("div").addClass(`${this.cssPrefix}-cond-landing-slot`).addChildElement(domel("div").toDOM()).toDOM(),this.slot.classList.contains(`${this.cssPrefix}-panel`)||this.slot.classList.add(`${this.cssPrefix}-panel`),this.group=C.Query,e&&(this.customQuery=e)}getWidgetType(){return"queryPanel"}init(t,e){if(super.init(t,e),this.setOptions(e),this.renderProgressBlock(),this.detachQueryObserver(),this.attachQueryObserver(),M.removeDropContainer(this.slot),this.options.allowDragDrop){const t=this.getContext().getModel();M.registerDropContainer({element:this.slot,scopes:["entityAttr"],onDragEnter:(e,s)=>{this.slot.classList.add(`${N}-drophover`),s.dragImage.classList.add("eqjs-sortable-helper"),this.showLandingSlot();const i=s.data.attrId;t.checkAttrProperty(i,"useInConditions")||(s.dropEffect=I.Forbid)},onDragOver:(t,e)=>{},onDragLeave:(t,e)=>{e.dragImage.classList.remove("eqjs-sortable-helper"),e.dragImage.style.removeProperty("width"),this.slot.classList.remove(`${N}-drophover`),this.hideLangindSlot()},onDrop:(t,e)=>{const s=this.getQuery(),i={parent:s.getRootCondition(),attributeId:e.data.attrId},n=s.addSimpleCondition(i);n&&s.fireConditionsChangedEvent(p.Add,n)}})}}destroyCore(){M.removeDropContainer(this.slot),this.detachQueryObserver(),this.slot.innerHTML=""}getEntitiesMenu(){return this.entitiesMenu}getConditionMenu(){return this.conditionMenu}getLinkTypeMenu(){return this.linkTypeMenu}getConditionGroupMenu(t=!1){return t?this.rootGroupMenu:this.groupMenu}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{const e=t.data;if(!e||e.part!=g.Conditions&&e.part!=g.All)return;const s=document.activeElement,i=this.slot.contains(s)||s==document.body;switch(e.action){case p.Modify:{const t=e.changee,modifyCondition=(t,s)=>{const n=this.slot.querySelector(`div[data-id=${t.id}]`);if(n){s=s&&(e.condPart&y.Operator)===y.Operator&&t.expressions.length>1&&(t.expressions[1]._isDefaultValue||""==t.expressions[1].value||null==t.expressions[1].value);const o=n.classList.contains("active"),r=this.getConditionRenderer(t,n);if(r){const e=r.render(s);if(o&&this.toggleConditionPicked(t),i&&!s){const t=e.querySelector("a")||e.querySelector(".eqjs-qp-condition-button");t&&safeFocus(t)}}}};let s=this.options.autoEditNewCondition&&!w.isMobileMode();Array.isArray(t)?(t.forEach((t=>modifyCondition(t,s))),s=!1):modifyCondition(t,s);break}case p.Add:{const t=e.changee,addCondition=t=>{const e=this.getConditionRenderer(t);if(e){const s=t.getParent(),n=this.slot.querySelector(`div[data-id=${s.id}]`);if(n){const t=n.lastChild;if(t){const s=e.render(this.options.autoEditNewCondition&&!w.isMobileMode());t.appendChild(s),s.scrollIntoView(!1),!i||this.options.autoEditNewCondition&&!w.isMobileMode()||s.querySelector("a").focus()}}}};Array.isArray(t)?t.forEach((t=>addCondition(t))):addCondition(t);break}case p.Delete:{const t=e.changee,deleteCondition=t=>{const e=this.slot.querySelector(`div[data-id=${t.id}]`);if(e){const s=this.slot.querySelector(`div[data-id=${t.getParent().id}] > .eqjs-qp-row-group`),n=e.nextSibling,o=e.previousSibling;if(e.parentElement.removeChild(e),i){const t=n||o||s,e=t.querySelector("a")||t.querySelector(".eqjs-qp-condition-button");e&&e.focus()}}};Array.isArray(t)?t.forEach((t=>deleteCondition(t))):deleteCondition(t);break}default:this.refresh()}}))}detachQueryObserver(){if(this.queryEventCallbackId){this.getQuery().removeChangedCallback(this.queryEventCallbackId)}}getQuery(){return this.customQuery?this.customQuery:this.context.getQuery()}refreshCore(){this.clear(),this.render()}setOptions(t){n.assignDeep(this.options,t),this.options.dateFormatValue&&o.updateLocaleSettings({editDateFormat:this.options.dateFormatValue}),this.options.dateFormatDisplay&&o.updateLocaleSettings({shortDateFormat:this.options.dateFormatDisplay}),void 0===this.options.editableParts&&(this.options.editableParts=H.All),w.isMobileMode()&&(this.options.buttons=this.options.buttons||{},this.options.buttons.condition=["menu"],this.options.buttons.group=["menu"])}clear(){this.slot.innerHTML=""}render(){try{this.entitiesMenu=this.createEntitiesMenu(),this.createConditionMenus(),this.createLinkTypeMenu(),this.rootContainer=domel("div",this.slot).toDOM(),domel(this.slot).removeClass($).addClass(getMobileCssClass());const t=this.getQuery().getRootCondition(),e=this.getConditionRenderer(t,this.rootContainer);if(e&&e.render(),this.options.showAddRow){this.addRowElement=domel("div",this.slot).toDOM();const t=this.getAddRowRenderer(this.addRowElement);t&&t.render()}}catch(t){const e=t;this.context.throwError({action:"QueryPanel rendering",text:e.message,sourceError:e})}}getConditionRenderer(t,e){let s;if(this.options.onGetConditionRenderer&&(s=this.options.onGetConditionRenderer(t,e),s))return s;switch(t.tag){case f.Simple:return new SimpleConditionRenderer(this,t,e);case f.Group:return new ConditionGroupRenderer(this,t,e)}return null}getExpressionRenderer(e,s){if(!e)throw"Expression is not defined in the condition";const i=this.getContext().getModel(),n=e.getParent(),o=i.getOperatorById(n.getOperatorId()),r=i.getAttributeByIdSafe(n.expressions[0].value),a=i.getOperand(r,o,e.getIndex());let l,d;l=a&&a.editor&&a.editor.tag!==u.Unknown?a.editor:r&&r.defaultEditor?r.defaultEditor:new EqValueEditor,d=l.tag;let c=e.dataType;if(c==t.Unknown&&(c=r.dataType),e.kind===h.Attribute){if(0===e.getIndex())return new AttributeExpressionRenderer(this,e,this.entitiesMenu,s);{let t=this.createEntitiesMenu(((t,e)=>!e||e.useInConditions&&e.dataType===c));return new AttributeExpressionRenderer(this,e,t,s)}}if(e.kind===h.Query?d=u.SubQuery:e.kind===h.Scalar?d!=u.Unknown||e.dataType!==t.Date&&e.dataType!==t.DateTime&&e.dataType!==t.Time||(d=u.DateTime):e.kind==h.ParentColumn&&(d=u.BindToParentColumn),this.options.onGetExpressionRenderer){let t=this.options.onGetExpressionRenderer(this,e,l,s);if(t)return t}switch(d){case u.List:return new ListExpressionRenderer(this,e,l,s);case u.SqlList:return new SqlListExpressionRenderer(this,e,l,s);case u.CustomList:return new CustomListExpressionRenderer(this,e,l,s);case u.DateTime:return new DateTimeExpressionRenderer(this,e,l,s);case u.SubQuery:return new SubQueryExpressionRenderer(this,e,l,s);case u.BindToParentColumn:return new BindToParentColumnExpressionRenderer(this,e,l,s);default:return new InputExpressionRenderer(this,e,l,s)}}getOperatorRenderer(t,e,s){let i;return this.options.onGetOperatorRenderer&&(i=this.options.onGetOperatorRenderer(t,e,s)),i||new OperatorRenderer(this,t,e,s)}getAddRowRenderer(t){let e;return this.options.onGetAddRowRenderer&&(e=this.options.onGetAddRowRenderer(t)),e||new AddRowRenderer(this,this.entitiesMenu,t)}createEntitiesMenu(t){const e=this.getContext().getModel();if(!e||e.isEmpty())return null;let s=this.slot.id||"eq-querypanel";s+="-EntitiesMenu";const i={items:e.getEntitiesTree({addUIC:!0,addUIR:!1,addUIS:!1,attrPlacement:this.options.attrPlacement,sortEntities:this.options.sortEntities},t),adjustHeight:this.options.adjustEntitiesMenuHeight,id:s,domWriteItemsId:this.options.domWriteItemsId};return n.assign(i,this.options.menuOptions),new PopupMenu(i)}showEntitiesMenu(t){this.entitiesMenu.showMenu(t)}createConditionMenus(){{const t=this.getQuery();let e=this.slot.id||"eq-querypanel";e+="-ConditionMenu";const s=[{id:"enable",text:o.getText("MenuEnable")},{id:"delete",text:o.getText("CmdDelete")}];t.isEx()&&((this.options.allowParameterization||this.options.allowInJoinConditions)&&s.push({id:"delimiter",text:"---"}),this.options.allowParameterization&&s.push({id:"param",text:o.getText("MenuParameterization")}),this.options.allowInJoinConditions&&s.push({id:"inJoin",text:o.getText("MenuJoinCond")}));const i={items:s,adjustHeight:this.options.adjustEntitiesMenuHeight,id:e,domWriteItemsId:this.options.domWriteItemsId,showSearchBoxAfter:100,showSelected:!0};n.assign(i,this.options.menuOptions),this.conditionMenu=new PopupMenu(i)}{let t=this.slot.id||"eq-querypanel";t+="-GroupMenu";const e={items:[{id:"enable",text:o.getText("MenuEnable")},{id:"delete",text:o.getText("CmdDelete")},{id:"delimiter",text:"---"},{id:"addCondition",text:o.getText("CmdAddCondition")},{id:"addGroup",text:o.getText("CmdAddCondGroup")}],adjustHeight:this.options.adjustEntitiesMenuHeight,id:t,domWriteItemsId:this.options.domWriteItemsId,showSearchBoxAfter:100,showSelected:!0};n.assign(e,this.options.menuOptions),this.groupMenu=new PopupMenu(e)}{let t=this.slot.id||"eq-querypanel";t+="-RootGroupMenu";const e={items:[{id:"addCondition",text:o.getText("CmdAddCondition")},{id:"addGroup",text:o.getText("CmdAddCondGroup")}],adjustHeight:this.options.adjustEntitiesMenuHeight,id:t,domWriteItemsId:this.options.domWriteItemsId,showSearchBoxAfter:100,showSelected:!0};n.assign(e,this.options.menuOptions),this.rootGroupMenu=new PopupMenu(e)}}createLinkTypeMenu(){let t=this.slot.id;t&&(t+="-LinkTypeMenu");const e={items:T.predicateLinkTypeList.map((t=>({id:t.id,text:o.getText(t.key)}))),adjustHeight:this.options.adjustEntitiesMenuHeight,id:t,domWriteItemsId:this.options.domWriteItemsId};n.assign(e,this.options.menuOptions),this.linkTypeMenu=new PopupMenu(e)}toggleConditionPicked(t,e=void 0){let s,i;t&&(s=this.slot.querySelector(`div[data-id=${t.id}][data-condrow], div[data-id=${t.id}] > div[data-group-row]`),s&&(i=s.classList.contains("active")));const n=this.slot.querySelectorAll(`.${this.cssPrefix}-row`);for(let t=0;t<n.length;t++){const e=n[t];e.hasAttribute("data-group-row")?this.options.alwaysShowButtonsInGroups||domel(e).data("show-buttons",null):this.options.alwaysShowButtonsInConditions||domel(e).data("show-buttons",null),domel(e).removeClass("active")}s&&!i&&domel(s).addClass("active").data("show-buttons","")}showLandingSlot(){const t=this.slot.querySelector(".eqjs-qp-conditions-root");t&&(t.appendChild(this.landingSlot),this.landingSlot.scrollIntoView({block:"center",behavior:"smooth"}))}hideLangindSlot(){this.landingSlot.parentElement&&this.landingSlot.parentElement.removeChild(this.landingSlot)}onProcessStartCore(){this.options.showIndicatorOnLoad&&(this.progressBlock.parentNode||this.slot.appendChild(this.progressBlock))}onProcessEndCore(){this.options.showIndicatorOnLoad&&this.progressBlock.parentNode&&this.slot.removeChild(this.progressBlock)}renderProgressBlock(){this.progressBlock=document.createElement("div"),this.progressBlock.classList.add(`${N}-progress-win8`),this.progressBlock.classList.add(getMobileCssClass()),this.progressBlock.innerHTML='<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>'}clonePanel(t,e){return new QueryPanel(t,e)}}class FilterBar extends Widget{constructor(t){super(t),this.options={applyOnClose:!0,showApplyButton:!0,showClearButton:!0,queryPanel:{showAddRow:!0,showCheckboxes:!0,alwaysShowButtonsInGroups:!0}},this.headerClickListener=this.headerClickHandler.bind(this),this.group=C.Query}getWidgetType(){return"filterBar"}get cssPrefix(){return"eqjs-fb"}init(t,e){super.init(t,e),this.setOptions(e),this.destroyCore(),this.qpElement=domel("div").addClass(`${this.cssPrefix}-querypanel`).toDOM(),this.queryPanel=new QueryPanel(this.qpElement),this.queryPanel.init(t,this.options.queryPanel||{}),this.attachQueryObserver()}setOptions(t){this.options=n.assignDeep(this.options,t)}applyBtnClick(t){this.applyFilter()}clearBtnClick(t){this.clearFilter()}showQueryPanel(t){!function slideDown(t,e,s){t.style.removeProperty("display");let i=window.getComputedStyle(t).display;"none"===i&&(i="block"),t.style.display=i;let n=t.offsetHeight;t.style.overflow="hidden",t.style.height="0px",t.style.paddingTop="0px",t.style.paddingBottom="0px",t.style.marginTop="0px",t.style.marginBottom="0px",t.offsetHeight,t.style.boxSizing="border-box",t.style.transitionProperty="height, margin, padding",t.style.transitionDuration=e+"ms",t.style.height=n+"px",t.style.removeProperty("padding-top"),t.style.removeProperty("padding-bottom"),t.style.removeProperty("margin-top"),t.style.removeProperty("margin-bottom"),window.setTimeout((()=>{t.style.removeProperty("height"),t.style.removeProperty("overflow"),t.style.removeProperty("transition-duration"),t.style.removeProperty("transition-property"),t.style.removeProperty("box-sizing"),s&&s()}),e)}(this.qpBlock,200,(()=>{this.updateHeader(),t&&t()}))}hideQueryPanel(){!function slideUp(t,e,s){t.style.transitionProperty="height, margin, padding",t.style.transitionDuration=e+"ms",t.style.boxSizing="border-box",t.style.height=t.offsetHeight+"px",t.offsetHeight,t.style.overflow="hidden",t.style.height="0px",t.style.paddingTop="0px",t.style.paddingBottom="0px",t.style.marginTop="0px",t.style.marginBottom="0px",window.setTimeout((()=>{t.style.display="none",t.style.removeProperty("height"),t.style.removeProperty("padding-top"),t.style.removeProperty("padding-bottom"),t.style.removeProperty("margin-top"),t.style.removeProperty("margin-bottom"),t.style.removeProperty("overflow"),t.style.removeProperty("transition-duration"),t.style.removeProperty("transition-property"),t.style.removeProperty("box-sizing"),s&&s()}),e)}(this.qpBlock,200,(()=>{this.updateHeader(),this.options.applyOnClose&&this.applyFilter()}))}headerClickHandler(t){t.preventDefault(),domel(this.qpBlock).isVisible()?this.hideQueryPanel():this.showQueryPanel()}updateHeader(){if(!this.headerTextElement)return;let t="";const e=this.getContext().getQuery();e&&(t=e.getConditionsText()),""==t&&(t=o.getText("StrNoFilterDefined")),domel(this.headerTextElement).text(t).attr("title",t),!e||e.isEmptyConditions()?(domel(this.headerTextElement).hide(),domel(this.headerLinkElement).show(),domel(this.qpBlock).isVisible()||(domel(this.headerArrowBlock).hide(),this.headerElement.style.cursor="",this.headerElement.removeEventListener("click",this.headerClickListener))):(this.headerElement.style.cursor="pointer",this.headerElement.removeEventListener("click",this.headerClickListener),this.headerElement.addEventListener("click",this.headerClickListener),domel(this.headerTextElement).show(),domel(this.headerLinkElement).hide(),domel(this.headerArrowBlock).show()),domel(this.qpBlock).isVisible()?this.headerArrowElement.classList.add(`${this.cssPrefix}-header-arrowUp`):this.headerArrowElement.classList.remove(`${this.cssPrefix}-header-arrowUp`),this.textResize()}render(){domel(this.slot).addClass(`${this.cssPrefix}-container`).addClass(getMobileCssClass()).addChild("div",(t=>this.headerElement=t.addClass(`${this.cssPrefix}-header`).addChild("div",(t=>this.headerIconElement=t.addClass(`${this.cssPrefix}-header-icon`).toDOM())).addChild("div",(t=>this.headerTextBlock=t.addClass(`${this.cssPrefix}-header-textblock`).addChild("div",(t=>this.headerTextElement=t.addClass(`${this.cssPrefix}-header-text`).toDOM())).addChild("div",(t=>this.headerLinkElement=t.addClass(`${this.cssPrefix}-header-text ${this.cssPrefix}-header-link`).text(o.getText("StrNoFilterClickToAdd")).hide().on("click",(()=>{this.queryPanel.showEntitiesMenu({anchor:this.headerLinkElement,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t.id;this.showQueryPanel((()=>{const t=this.getContext().getQuery(),e={parent:t.getRootCondition(),attributeId:s},i=t.addSimpleCondition(e);i&&t.fireConditionsChangedEvent(p.Add,i)}))}})})).toDOM())).toDOM())).addChild("div",(t=>this.headerArrowBlock=t.addClass(`${this.cssPrefix}-header-arrowblock`).addChild("div",(t=>this.headerArrowElement=t.addClass(`${this.cssPrefix}-header-arrow`).toDOM())).toDOM())).toDOM())).addChild("div",(t=>this.qpBlock=t.addClass(`${this.cssPrefix}-querypanelblock`).addClass(getMobileCssClass()).hide().addChildElement(this.qpElement).toDOM())),(this.options.showApplyButton||this.options.showClearButton)&&(this.buttonsBlock=domel("div",this.qpBlock).addClass(`${this.cssPrefix}-buttonsblock`).addClass(getMobileCssClass()).toDOM()),this.options.showApplyButton&&domel("a",this.buttonsBlock).attr("href","javascript:void(0)").addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-apply`).text(o.getText("ButtonApply")).on("click",this.applyBtnClick.bind(this)),this.options.showClearButton&&domel("a",this.buttonsBlock).attr("href","javascript:void(0)").addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-clear`).text(o.getText("CmdClear")).on("click",this.clearBtnClick.bind(this)),window.addEventListener("resize",(()=>{this.textResize()})),this.updateHeader(),this.queryPanel.refresh(),setTimeout((()=>this.textResize()),500)}refreshCore(){this.clear(),this.render()}clear(){this.slot.innerHTML=""}applyFilter(){this.options.applyFilterCallback&&this.options.applyFilterCallback()}clearFilter(){const t=this.getContext().getQuery();t&&(t.clearConditions(),t.fireConditionsChangedEvent(p.All))}textResize(){this.headerTextBlock.style.width=this.slot.clientWidth-this.headerIconElement.offsetWidth-(domel(this.headerArrowBlock).isVisible()?this.headerArrowBlock.offsetWidth:0)+"px"}destroyCore(){this.queryPanel&&this.queryPanel.destroy(),this.detachQueryObserver(),this.slot.innerHTML=""}attachQueryObserver(){const t=this.getContext().getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{this.updateHeader()}))}detachQueryObserver(){const t=this.getContext().getQuery();t&&t.removeChangedCallback(this.queryEventCallbackId)}}class Grid extends Widget{constructor(t){super(t),this.options={useCustomLocaleSettings:!1},this.slot=t,this.group=C.Result}getWidgetType(){return"grid"}init(t,e){super.init(t,e),e&&n.assignDeep(this.options,e)}refreshCore(){this.clear(),this.context.resultTable&&this.render()}render(){this.options.beforeTableRendering&&this.options.beforeTableRendering(this.context.resultTable),this.applyDisplayFormats()}applyDisplayFormats(){}clear(){this.slot.innerHTML=""}}class EasyGridWidget extends Grid{constructor(t){super(t),this.hasCustomTotalsSettings=!1,
//!!!! DO NOT forget to add types for options
this.options={autoRefresh:!0},this.group=C.Result}getWidgetType(){return"easyGrid"}init(t,e){super.init(t,e);const s=Object.assign(Object.assign({},e),{slot:this.slot,dataTable:t.resultTable});this.options=n.assign(this.options,e),s.onPlusButtonClick=t=>this.addColumnClickHandler(t),s.onColumnMoved=t=>this.columnMovedHandler(t),s.aggregates?this.hasCustomTotalsSettings=!0:s.aggregates={settings:t.getQuery().getAggregationSettings(),calculatorRef:null},s.aggregates.calculatorRef=this.context.getServices().getAggregatesCalculator(this.context),this.destroy(),this.grid=new EasyGrid(s),this.options.autoRefresh&&this.attachQueryObserver()}refreshCore(){this.clear(),this.updateTotalsSettings(),this.render()}render(){this.createEntitiesMenu(),this.grid.refresh()}attachQueryObserver(){}destroyCore(){this.detachQueryObserver(),this.grid&&this.grid.destroy(),this.slot.innerHTML=""}detachQueryObserver(){if(this.queryEventCallbackId){this.getContext().getQuery().removeChangedCallback(this.queryEventCallbackId)}}updateTotalsSettings(){const t=this.getContext();if(!this.hasCustomTotalsSettings){const e=t.getQuery().getAggregationSettings();this.grid.options.aggregates.settings=e}}createEntitiesMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return;let e=this.slot.id;e&&(e+="-EntitiesMenu");const s={items:t.getEntitiesTree({addUIC:!1,addUIR:!0,addUIS:!1}),id:e};n.assign(s,this.options.menuOptions),this.entitiesMenu=new PopupMenu(s)}getModel(){return this.context.getModel()}getQuery(){return this.context.getQuery()}clear(){this.grid&&this.grid.clear()}addColumnClickHandler(t){this.entitiesMenu.showMenu({anchor:t.sourceEvent.target,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t.id;return this.addNewColumn(s),!1}})}columnMovedHandler(t){const e=this.getQuery(),s=n.findItemIndexById(e.getColumns(),t.columnId);s>=0&&(e.moveColumn(s,t.newIndex),e.fireChangedEvent({part:g.Columns,action:p.All,source:this}))}addNewColumn(t){this.getContext().getModel();const e=this.getContext().getQuery(),s=e.addColumn({attributeId:t},!0);return e.fireChangedEvent({part:g.Columns,action:p.Add,changee:s,source:this}),s}}class StatementPanel extends Widget{constructor(t){super(t),this.panel=t,this.group=C.Statement,"TEXTAREA"!==this.panel.tagName&&(this.panel.innerHTML='<div class="eqv-sql-panel-result"></div>',this.panel=this.panel.querySelector("div"))}getWidgetType(){return"statementPanel"}refreshCore(){this.clear(),this.render()}render(){this.panel.textContent=this.context.resultStatement?this.context.resultStatement:"";var t=this.panel.innerHTML.replace(/\r\n/g,"<br />").replace(/  /g,"&nbsp;&nbsp;");this.panel.innerHTML=t}destroyCore(){this.clear()}clear(){this.panel.innerHTML=""}}class ProcessWidget extends Widget{constructor(t){super(t),this.element=t,this.element.style.display="none",this.group=C.All}getWidgetType(){return"processIndicator"}onProcessStartCore(){this.element.style.display=""}onProcessEndCore(){this.element.style.display="none"}}function __awaiter(t,e,s,i){return new(s||(s=Promise))((function(n,o){function fulfilled(t){try{step(i.next(t))}catch(t){o(t)}}function rejected(t){try{step(i.throw(t))}catch(t){o(t)}}function step(t){t.done?n(t.value):function adopt(t){return t instanceof s?t:new s((function(e){e(t)}))}(t.value).then(fulfilled,rejected)}step((i=i.apply(t,e||[])).next())}))}!function(t){t.DataGrid="DATA_GRID",t.Chart="CHART",t.PivotTable="PIVOT_TABLE"}(_||(_={})),"function"==typeof SuppressedError&&SuppressedError;class ResultFacet{constructor(t,e){this.container=t,this.title=o.getText("Facets","DefaultFacetTitle"),this.cssPrefix="eqjs-facet",this.dialogTitle=o.getText("Facets","DefaultDlgTitle"),this.options={},this.canDisplayFlag=!0,this.downloadAllClickHandler=()=>{const t=this.getContext().resultTable;if(t.elasticChunks){const t=this.getDialogService().openProgress({title:o.getText("Facets","LoadDataDlgTitle"),onSubmit:()=>this.refresh(),determinated:!1});this.loadElasticChunk().then((e=>{t.submit()})).catch((e=>{t.submit(),this.getContext().throwError(e)}))}else{const e=t.getCachedRows().length,s=t.getTotal()-t.getCachedCount(),i=this.getDialogService().openProgress({title:o.getText("Facets","LoadDataDlgTitle"),content:o.getText("Facets","LoadDataDlgContent").replace("{loadedRecs}","0").replace("{totalRecs}",`${s}`),onSubmit:()=>this.refresh(),determinated:!0});let n=0;setTimeout((()=>{t.getRows({offset:e,limit:s}).then((t=>{n+=t.length;const e=n/s;i.updateContent(o.getText("Facets","LoadDataDlgContent").replace("{loadedRecs}",`${n}`).replace("{totalRecs}",`${s}`)),i.updateProgress(e)})).catch((t=>{i.submit(),this.getContext().throwError(t)}))}),10)}},n.assignDeep(this.options,e)}init(t){this.slot=t,this.contentDiv=domel("div",this.slot).addClass(`${this.cssPrefix}-content`).toDOM(),this.displayMessageDiv=domel("div",this.slot).hide().toDOM()}showSettingsDialog(){return new Promise((t=>{const e=this.getDialogService(),s=this.renderDialogContent(),i=e.open({title:this.dialogTitle,body:s,cancelable:!0,closable:!1,onSubmit:()=>{const e=this.submitSettingsDialog();return e&&t(!0),e},onCancel:()=>{t(!1)}});this.afterDialogOpened(i)}))}afterDialogOpened(t){}renderDialogContent(){let t,e=domel("div").addClass("kfrm-form").addChild("div",(e=>t=e.addClass(""+(w.isIE()?"kfrm-fields-ie col-ie-1-4 label-align-right":"kfrm-fields col-a-1 label-align-right")).toDOM()));return this.renderFormFields(e.toDOM(),t),e.toDOM()}renderFormFields(t,e){let s=e;w.isIE()&&(s=domel("div",e).addClass("kfrm-field-ie").toDOM()),domel(s).addChild("label",(t=>t.attr("for","tab_name").addText(o.getText("Facets","TabNameLabel")))).addChild("input",(t=>t.id("facetTabName").name("tab_name").type("text").attr("value",this.title)))}submitSettingsDialog(){const t=document.querySelector("#facetTabName");return 0!=t.value.length&&(this.title=t.value,!0)}getDialogService(){return this.getContext().getServices().getService("DialogService")}canDisplay(){const t=this.getContext().resultTable;return t.getCachedCount()==t.getTotal()}showErrorMessage(t){this.displayMessageDiv.innerHTML=t,this.displayMessageDiv.classList.add(`${this.cssPrefix}-error-message`),domel(this.displayMessageDiv).show()}showUnableDisplayMessage(t){const e=this.getContext().resultTable;this.displayMessageDiv.innerHTML=t||o.getText("Facets","ErrNotEnoughData").replace("{totalRecs}",`${e.getTotal()}`).replace("{cachedRecs}",`${e.getCachedCount()}`).replace(/\[(.*)\]/g,`<a href='javascript:void(0)' class="${this.cssPrefix}-download-all-link">$1</a>`);const s=this.displayMessageDiv.querySelector(`a.${this.cssPrefix}-download-all-link`);s&&s.addEventListener("click",this.downloadAllClickHandler),domel(this.contentDiv).hide(),domel(this.displayMessageDiv).show()}hideUnableDisplayMessage(){domel(this.displayMessageDiv).hide(),domel(this.contentDiv).show()}getContext(){return this.container.getContext()}getQuery(){return this.getContext().getQuery()}saveToData(){return{title:this.title,type:this.getType()}}loadFromData(t){t&&(this.title=t.title)}refresh(){this.hideUnableDisplayMessage(),this.canDisplay()?this.refreshCore():this.showUnableDisplayMessage()}loadElasticChunk(){return __awaiter(this,void 0,void 0,(function*(){const t=this.getContext().resultTable,e=t.getCachedRows().length;return t.getRows({offset:e,limit:t.chunkSize}).then((e=>t.totalIsKnown()?Promise.resolve():this.loadElasticChunk()))}))}onResize(){}}!function(t){t[t.Column=3]="Column",t[t.Histogram=4]="Histogram",t[t.Bar=5]="Bar",t[t.Combo=6]="Combo",t[t.Area=7]="Area",t[t.Line=9]="Line",t[t.Pie=10]="Pie",t[t.Polar=11]="Polar",t[t.Doughnut=12]="Doughnut",t[t.Radar=13]="Radar",t[t.SteppedLine=14]="SteppedLine"}(V||(V={}));class ChartWidget extends Widget{get cssPrefix(){return"eqjs-chart"}constructor(t){super(t),this.chartType=V.Pie,this.supportedChartTypes=[],this.dataTable=null,this.potentialLabelColumns=[],this.potentialDataColumns=[],this.labelColumn=-1,this.dataColumns=[],this.options={chartType:V.Pie,showOnPaging:!1,hideSettings:!1,legend:{show:!1,position:"right"}},this.element=t,this.group=C.Result}init(t,e){super.init(t,e),this.dataTable=t.resultTable,this.setOptions(e)}hasData(){let t=null!=this.dataTable;return t&&(t=this.dataTable.getCachedCount()>0),t}hasColumnsForChart(){return this.potentialLabelColumns.length>0&&this.potentialDataColumns.length>0}refreshCore(){this.prepareChartData(),this.render()}setOptions(t){if(n.assignDeep(this.options,t),this.supportedChartTypes=this.getSupportedChartTypes(),0==this.supportedChartTypes.length)throw Error("Chart widget should support at least one chart type");t.chartType&&this.supportedChartTypes.indexOf(t.chartType)>=0?this.chartType=t.chartType:this.chartType=this.supportedChartTypes[0]}getOptions(){return this.options}getChartTypeName(t){switch(t){case V.Area:return o.getText("ChartType","Area");case V.Bar:return o.getText("ChartType","Bar");case V.Column:return o.getText("ChartType","Column");case V.Combo:return o.getText("ChartType","Combo");case V.Doughnut:return o.getText("ChartType","Doughnut");case V.Polar:return o.getText("ChartType","Polar");case V.Radar:return o.getText("ChartType","Radar");case V.Histogram:return o.getText("ChartType","Histogram");case V.Line:return o.getText("ChartType","Line");case V.SteppedLine:return o.getText("ChartType","SteppedLine");default:return o.getText("ChartType","Pie")}}updateSettings(t,e=!0){void 0!==t.showLegend&&(this.options.legend=this.options.legend||{},this.options.legend.show=t.showLegend),this.chartType=t.type,this.labelColumn=t.labelColumn,this.dataColumns[0]=t.dataColumn,e&&this.updateChartColumns()}prepareChartData(){if(this.dataTable){this.potentialLabelColumns=[],this.potentialDataColumns=[];let t=this.dataTable.columns.count;for(let e=0;e<t;e++){const t=this.dataTable.columns.get(e);let s=t.type,i=t.label;this.potentialLabelColumns.push({idx:e,label:i}),n.isNumericType(s)&&this.potentialDataColumns.push({idx:e,label:i})}if(-1!=this.labelColumn?this.potentialLabelColumns.filter((t=>t.idx==this.labelColumn)).length||(this.labelColumn=-1):this.labelColumn=this.potentialLabelColumns.length>0?this.potentialLabelColumns[0].idx:-1,this.dataColumns.length){const t=this.potentialDataColumns.map((t=>t.idx));this.dataColumns=this.dataColumns.filter((e=>t.indexOf(e)>=0)),this.dataColumns.length||(this.dataColumns=this.potentialDataColumns.length>0?[].concat(this.potentialDataColumns[0].idx):[])}else this.dataColumns=this.potentialDataColumns.length>0?[].concat(this.potentialDataColumns[0].idx):[];this.initChart()}}getSupportedChartTypes(){return(this.options.supportedChartTypes?this.options.supportedChartTypes:Object.keys(V).map((t=>V[t]))).filter((t=>this.hasChartTypes.indexOf(t)>=0))}getCurrentChartType(){return this.chartType}render(){if(this.clear(),this.hasData()&&this.hasColumnsForChart()&&this.context.resultTable.getTotal()==this.context.resultTable.getCachedCount()){let t=document.createElement("div");addCssClass(t,`${this.cssPrefix}-header`);let e=document.createElement("div");if(addCssClass(e,`${this.cssPrefix}-main`),this.canDraw()){let s=document.createElement("select");for(let t of this.supportedChartTypes){let e=document.createElement("option");e.value=t.toString(),e.text=this.getChartTypeName(t),s.appendChild(e)}s.value=this.chartType.toString(),t.appendChild(s),s.addEventListener("change",(t=>{let e=t.target.value;this.chartType=parseInt(e),this.refresh()})),this.settingsDiv=document.createElement("div"),addCssClass(this.settingsDiv,`${this.cssPrefix}-settings`),hideElement(this.settingsDiv),e.appendChild(this.settingsDiv),this.chartDiv=document.createElement("div"),addCssClass(this.chartDiv,`${this.cssPrefix}-content`),hideElement(this.chartDiv),e.appendChild(this.chartDiv),this.initSettingsDiv();let i=document.createElement("div");addCssClass(i,`${this.cssPrefix}-settings-icon`),i.title="Settings",t.appendChild(i),i.addEventListener("click",(t=>{this.toggleSettings()})),this.drawChart(100)}else this.addContentDiv(e,"Unable to render  the chart. None of the supported chart libraries (ChartJS, Google Charts, etc) is found.");this.options.hideSettings||this.element.appendChild(t),this.element.appendChild(e),this.element.style.display=""}else this.element.style.display="none"}addContentDiv(t,e){let s=document.createElement("div");addCssClass(s,`${this.cssPrefix}-no-data`),s.innerText=e,t.appendChild(s)}clear(){this.element.innerHTML=""}drawChart(t){showElement(this.chartDiv),t>0?setTimeout((()=>this.drawCore()),t):this.drawCore()}initSettingsDiv(){let t=document.createElement("div");t.textContent="SETTINGS",addCssClass(t,`${this.cssPrefix}-settings-header`),this.settingsDiv.appendChild(t);let e=document.createElement("div");addCssClass(e,`${this.cssPrefix}-settings-single`),this.settingsDiv.appendChild(e);let s=document.createElement("span");showElement(s),s.textContent="Label column",e.appendChild(s);let i=document.createElement("select");showElement(i),e.appendChild(i);for(let t of this.potentialLabelColumns){let e=document.createElement("option");e.value=t.idx.toString(),e.text=t.label,i.appendChild(e)}this.labelColumn>=0&&(i.value=this.labelColumn.toString()),i.addEventListener("change",(t=>{this.labelColumn=parseInt(t.target.value),this.updateChartColumns(),this.toggleSettings((()=>{this.drawChart(100)}))}));let n=document.createElement("div");addCssClass(n,`${this.cssPrefix}-settings-single`),this.settingsDiv.appendChild(n);let o=document.createElement("span");showElement(o),o.textContent="Data column",n.appendChild(o);let r=document.createElement("select");showElement(r),n.appendChild(r);for(let t of this.potentialDataColumns){let e=document.createElement("option");e.value=t.idx.toString(),e.text=t.label,r.appendChild(e)}this.dataColumns.length>0&&this.dataColumns[0]>=0&&(r.value=this.dataColumns[0].toString()),r.addEventListener("change",(t=>{this.dataColumns[0]=parseInt(t.target.value),this.updateChartColumns(),this.toggleSettings((()=>{this.drawChart(100)}))}))}getPotentialLabelColumns(){return this.potentialLabelColumns}getPotentialDataColumns(){return this.potentialDataColumns}getLabelColumnIndex(){return this.labelColumn}getDataColumnIndex(){return this.dataColumns[0]}toggleSettings(t){let e,s;!function isVisible(t){return"none"!=t.style.display&&0!=t.offsetWidth&&0!=t.offsetHeight}(this.chartDiv)?(e=this.settingsDiv,s=this.chartDiv):(e=this.chartDiv,s=this.settingsDiv),function toggleVisibility(t,e,s){s||(s={}),s.display||(s.display=""),s.duration||(s.duration=200),hideElement(t),showElement(e,s.display),s.complete&&s.complete()}(e,s,{complete:t})}}class ChartJsWidget extends ChartWidget{constructor(t){super(t),this.colors=["#4dc9f6","#f67019","#f53794","#537bc4","#acc236","#166a8f","#00a950","#58595b","#8549ba"],this.chartLabels=[],this.chartColumns=[],this.hasChartTypes=[V.Column,V.Bar,V.Area,V.Line,V.SteppedLine,V.Doughnut,V.Polar,V.Radar,V.Pie],this.options.legend={show:!1,position:"bottom"}}getWidgetType(){return"chartChartJs"}static hasChartJs(){return"undefined"!=typeof Chart}canDraw(){return ChartJsWidget.hasChartJs()}initChart(){ChartJsWidget.hasChartJs()&&this.labelColumn>=0&&this.dataColumns&&this.dataColumns.length>0&&this.updateChartColumns()}drawCore(){if(ChartJsWidget.hasChartJs()&&this.dataTable&&this.dataTable.getCachedCount()>0){let t=this.generateConfig(),e=this.getChartCanvas(this.chartDiv).getContext("2d");new Chart(e,t)}}updateChartColumns(){if(this.dataTable){this.chartLabels=[],this.chartColumns=[];const t=this.dataTable.getCachedRows();for(let e=0;e<t.length;e++)this.chartLabels.push(t[e].getValue(this.labelColumn)),this.chartColumns.push(t[e].getValue(this.dataColumns[0]))}}getChartCanvas(t){let e,s=t.getElementsByTagName("canvas");return e=s&&s.length>0?s[0]:addElement(t,"canvas"),e}generateConfig(){let t,e=[],s=this.dataTable.columns.get(this.dataColumns[0]).label,i=!0;if(this.chartType==V.Pie||this.chartType==V.Doughnut||this.chartType==V.Polar||this.chartType==V.Bar||this.chartType==V.Column)for(let t=0;t<this.chartLabels.length;t++)e.push(this.colors[t%this.colors.length]);else e=[this.colors[3]];this.chartType!=V.Line&&this.chartType!=V.SteppedLine||(i=!1,t=this.colors[3]),this.options.legend=this.options.legend||{};const n={data:this.chartColumns,backgroundColor:e,borderColor:t,label:s,fill:i};this.chartType==V.SteppedLine&&(n.stepped=this.chartType===V.SteppedLine,n.steppedLine=this.chartType===V.SteppedLine);const o=this.options.legend.show&&(this.chartType==V.Pie||this.chartType==V.Radar||this.chartType==V.Polar||this.chartType==V.Doughnut);return{type:this.getChartType(),data:{datasets:[n],labels:this.chartLabels},options:{legend:{display:o,position:this.options.legend.position||"bottom"},title:{display:!0,text:s}}}}getChartType(){switch(this.chartType){case V.Column:return"bar";case V.Bar:return"horizontalBar";case V.Area:case V.SteppedLine:case V.Line:return"line";case V.Doughnut:return"doughnut";case V.Polar:return"polarArea";case V.Radar:return"radar";case V.Pie:default:return"pie"}}}class GoogleChartWidget extends ChartWidget{constructor(t){super(t),this.hasChartTypes=[V.Column,V.Bar,V.Histogram,V.Combo,V.Area,V.Line,V.SteppedLine,V.Pie,V.Doughnut],this.options.legend={show:!0,position:"right"}}getWidgetType(){return"chartGoogle"}canDraw(){return GoogleChartWidget.hasGoogleCharts()}static hasGoogleCharts(){return"undefined"!=typeof google&&void 0!==google.charts}initChart(){GoogleChartWidget.hasGoogleCharts()&&this.labelColumn>=0&&this.dataColumns&&this.dataColumns.length>0&&(this.googleDataView=new google.visualization.DataView(this.convertToGoogleFormat()),this.updateChartColumns())}convertToGoogleType(e){switch(e){case t.Date:return"date";case t.DateTime:return"datetime";case t.Time:return"timeofday";case t.Byte:case t.Word:case t.Int32:case t.Int64:case t.Currency:case t.Float:return"number";default:return"string"}}convertToGoogleValue(e,s){return s===t.Bool?e?e.toString():null:e}convertToGoogleFormat(){const t=new google.visualization.DataTable,e=this.dataTable.columns;for(let s=0;s<e.count;s++){const i=e.get(s);t.addColumn(this.convertToGoogleType(i.type),i.label,i.id)}const s=this.dataTable.getCachedRows();t.addRows(s.length);for(let i=0;i<s.length;i++){const n=s[i];for(let s=0;s<e.count;s++)t.setCell(i,s,this.convertToGoogleValue(n.getValue(s),e.get(s).type))}return t}drawCore(){if(null!=this.googleDataView){this.options.legend=this.options.legend||{};let t={width:"100%",height:"100%",chartArea:{width:this.getChartAreaWidth}};this.chartType==V.Doughnut&&(t.pieHole=.4),this.options.legend.show?t.legend={position:this.options.legend.position}:t.legend="none",this.createChart(this.chartDiv).draw(this.googleDataView,t)}}getChartAreaWidth(t){return t==V.Pie?"100%":"50%"}updateChartColumns(){this.googleDataView&&this.googleDataView.setColumns([].concat(this.labelColumn).concat(this.dataColumns))}createChart(t){switch(this.chartType){case V.Column:return new google.visualization.ColumnChart(t);case V.Histogram:return new google.visualization.Histogram(t);case V.Bar:return new google.visualization.BarChart(t);case V.Combo:return new google.visualization.ComboChart(t);case V.Area:return new google.visualization.AreaChart(t);case V.Line:return new google.visualization.LineChart(t);case V.SteppedLine:return new google.visualization.SteppedAreaChart(t);case V.Pie:case V.Doughnut:default:return new google.visualization.PieChart(t)}}}class ChartFacet extends ResultFacet{constructor(){super(...arguments),this.title=o.getText("Facets","Chart","FacetTitle"),this.dialogTitle=o.getText("Facets","Chart","DlgTitle")}init(t){super.init(t),GoogleChartWidget.hasGoogleCharts()?this.chart=new GoogleChartWidget(this.contentDiv):this.chart=new ChartJsWidget(this.contentDiv);const e=this.container.options?this.container.options.supportedChartTypes:null;this.chart.init(this.getContext(),{legend:{show:!1},showOnPaging:!0,hideSettings:!0,supportedChartTypes:e}),domel(this.slot).hide()}destroy(){this.chart&&this.chart.destroy()}getType(){return _.Chart}renderFormFields(t,e){super.renderFormFields(t,e);const s=w.isIE(),i=s?"kfrm-fields-ie is-horizontal":"kfrm-fields is-horizontal";let n=document.createElement("select");n.id="chart_type_selector",n.name="chart_type_selector";for(let t of this.chart.getSupportedChartTypes()){let e=document.createElement("option");e.value=t.toString(),e.text=this.chart.getChartTypeName(t),n.appendChild(e)}n.value=this.chart.getCurrentChartType().toString(),this.settings||(this.chart.prepareChartData(),this.settings={type:this.chart.getCurrentChartType().toString(),labelColumn:`${this.chart.getLabelColumnIndex()>=0?this.chart.getLabelColumnIndex():""}`,dataColumn:`${this.chart.getDataColumnIndex()>=0?this.chart.getDataColumnIndex():""}`,showLegend:!1});const r=document.createElement("select");r.name="label_column_selector",r.id="label_column_selector";for(const t of this.chart.getPotentialLabelColumns()){const e=document.createElement("option");e.value=t.idx.toString(),e.text=t.label,r.appendChild(e)}r.value=this.settings.labelColumn;const a=document.createElement("select");a.id="data_column_selector",a.name="data_column_selector";for(const t of this.chart.getPotentialDataColumns()){const e=document.createElement("option");e.value=t.idx.toString(),e.text=t.label,a.appendChild(e)}a.value=this.settings.dataColumn.toString();let l=e;const getCurrent=()=>s?domel("div",e).addClass("kfrm-field-ie").toDOM():e;s?domel(t).addChildElement(getCurrent()):domel(e).addChild("div").addChild("div"),l=getCurrent(),domel(l).addChild("label",(t=>t.attr("for","chart_type_selector").text(o.getText("Facets","Chart","ChartTypeSelectorLabel")))).addChild("div",(t=>t.addClass("kfrm-select").addChildElement(n))),l=getCurrent(),domel(l).addChild("label",(t=>t.attr("for","label_column_selector").text(o.getText("Facets","Chart","LabelColumnSelectorLabel")))).addChild("div",(t=>t.addClass("kfrm-select").addChildElement(r))),l=getCurrent(),domel(l).addChild("label",(t=>t.attr("for","data_column_selector").text(o.getText("Facets","Chart","DataColumnSelectorLabel")))).addChild("div",(t=>t.addClass("kfrm-select").addChildElement(a))),l=getCurrent(),domel(l).addChild("div").addChild("div",(t=>t.addClass(i).addChild("label",(t=>t.addClass("checkbox").addChild("input",(t=>{t.id("show_legend").type("checkbox"),this.settings.showLegend&&t.attr("checked","")})).addText(" "+o.getText("Facets","Chart","ShowLegendLabel"))))))}afterDialogOpened(t){this.getContext().resultTable.columns.getItems().filter((t=>n.isNumericType(t.type))).length<=0&&(t.showAlert("The dataset should contain at least one numeric column to build a chart","error"),t.getSubmitButtonElement().disabled=!0)}submitSettingsDialog(){const t=super.submitSettingsDialog(),e=document.getElementById("chart_type_selector"),s=parseInt(e.value),i=document.getElementById("label_column_selector"),n=parseInt(i.value),o=document.getElementById("data_column_selector"),r=parseInt(o.value),a=document.getElementById("show_legend").checked;return t&&(this.settings={type:s,labelColumn:n,dataColumn:r,showLegend:a},this.canDisplay()&&this.refresh()),t}getSettings(){return this.settings}saveToData(){const t=super.saveToData();return this.settings&&(t.chartType=this.settings.type,t.labelCol=this.settings.labelColumn,t.dataCol=this.settings.dataColumn,t.showLeg=this.settings.showLegend),t}loadFromData(t){super.loadFromData(t),t&&(this.settings={type:t.chartType,dataColumn:t.dataCol,labelColumn:t.labelCol,showLegend:t.showLeg})}refreshCore(){this.chart&&(this.settings&&this.chart.updateSettings(this.settings),this.chart.prepareChartData(),this.chart.refresh())}onResize(){this.refresh()}}!function(t){t.Sum="SUM",t.Average="AVG",t.Min="MIN",t.Max="MAX",t.Count="COUNT"}(G||(G={})),function(t){t[t.ColumnField=0]="ColumnField",t[t.RowField=1]="RowField",t[t.CellData=2]="CellData"}(z||(z={}));const j=/{0:(.*?)}/g;class PivotTableFacet extends ResultFacet{constructor(){super(...arguments),this.title=o.getText("Facets","Pivot","FacetTitle"),this.dialogTitle=o.getText("Facets","Pivot","DlgTitle"),this.pivotTable=new EasyDataTable,this.settings={}}init(t){super.init(t),this.options.maxRowCount=this.options.maxRowCount||500,this.options.viewportRowsCount=this.options.viewportRowsCount||50,this.grid=new EasyGrid({slot:this.contentDiv,dataTable:this.pivotTable,paging:{enabled:!1,pageSize:this.options.maxRowCount},viewportRowsCount:this.options.viewportRowsCount,useRowNumeration:!1,showPlusButton:!1,allowDragDrop:!1,onGetCellRenderer:(t,e)=>{if(t.dataColumn){if("total"==t.dataColumn.id)return(t,s,i,n)=>{e(t,s,i,n),i.classList.add("pivot-cell-total")};if(this.settings.totalsRow){if(0===this.pivotTable.columns.getIndex(t.dataColumn.id))return(t,s,i,n)=>{Number.parseInt(n.getAttribute("data-row-idx"))===this.pivotTable.getCachedCount()-1&&(t=o.getText("Facets","Pivot","TotalGridLabel")),e(t,s,i,n)}}}}})}getType(){return _.PivotTable}destroy(){this.grid&&this.grid.destroy()}createAggrFuncSelectBuilder(t){const e=this.getContext().getModel(),s=domel("select"),i=Object.keys(G).map((t=>G[t]));for(const t of i)s.addChild("option",(s=>{s.attr("value",t).text(e.getAggrFunctionCaption(t))}));const n=s.toDOM().querySelectorAll("option");return null!=t?n.forEach((e=>{e.value==t&&(e.selected=!0)})):n[0].selected=!0,s}createColumnsSelectBuilder(t,e,s){const i=this.getContextDataTable(),o=domel("select");let r=null,a=0;for(let e=0;e<i.columns.count;e++){const s=i.columns.get(e),l=s.label,d=s.type,h=s.id;t&&t.indexOf(d)<0||(null===r&&n.isNumericType(d)&&(r=a),o.addChild("option",(t=>{t.attr("value",h).text(l)})),a++)}const l=Array.from(o.toDOM().querySelectorAll("option"));if(l.length>0)if(null!=e){for(const t of l)if(t.value==e){o.toDOM().value=t.value;break}}else switch(s){case z.ColumnField:o.toDOM().value=l[0].value;break;case z.RowField:o.toDOM().value=l.length>1?l[1].value:l[0].value;break;case z.CellData:o.toDOM().value=null===r?l[0].value:l[r].value}return o}renderFormFields(e,s){super.renderFormFields(e,s);const i=this.settings||{totalsRow:!0,totalsCol:!0},n=[t.String,t.Date,t.DateTime,t.Int32,t.Int64,t.Word,t.Byte],r=[t.String,t.Float,t.Int32,t.Int64,t.Word,t.Byte,t.Currency],a=w.isIE();let l=s;const d=a?"kfrm-fields-ie is-horizontal":"kfrm-fields is-horizontal",getCurrent=()=>a?domel("div",s).addClass("kfrm-field-ie").toDOM():s;a?domel(s).addChildElement(getCurrent()):domel(s).addChild("div").addChild("div"),l=getCurrent(),domel(l).addChild("label",(t=>t.attr("for","column_field").text(o.getText("Facets","Pivot","ColumnFieldSelectorLabel")))).addChild("div",(t=>t.addClass(d).addChild("div",(t=>t.addClass("kfrm-select").attr("name","column_field").addChildElement(this.createColumnsSelectBuilder(n,i.colName,z.ColumnField).id("pivotTableColFieldSelector").toDOM()))).addChild("button",(t=>t.addClass("kfrm-button").addClass("eqjs-facets-button-swap").attr("title",o.getText("Facets","Pivot","SwapBtnTitle")).on("click",(()=>{const t=document.getElementById("pivotTableColFieldSelector"),e=document.getElementById("pivotTableRowFieldSelector"),s=t.value;t.value=e.value,e.value=s})))))),l=getCurrent(),domel(l).addChild("label",(t=>t.attr("for","row_field").text(o.getText("Facets","Pivot","RowFieldSelectorLabel")))).addChild("div",(t=>t.addClass("kfrm-select").attr("name","row_field").addChildElement(this.createColumnsSelectBuilder(n,i.rowName,z.RowField).id("pivotTableRowFieldSelector").toDOM()))),l=getCurrent(),domel(l).addChild("label",(t=>t.attr("for","data_function").text(o.getText("Facets","Pivot","CellDataSelectorLabel")))).addChild("div",(t=>t.addClass(d).addChild("div",(t=>t.addClass("kfrm-select").attr("name","data_function").addChildElement(this.createAggrFuncSelectBuilder(i.aggrFunc).id("pivotTableAggrFuncSelector").toDOM()))).addChild("label",(t=>t.addText("of  "))).addChild("div",(t=>t.addClass("kfrm-select").attr("name","data_column").addChildElement(this.createColumnsSelectBuilder(r,i.fieldName,z.CellData).on("change",(t=>{const e=t.target.value;this.validateSelectedField(e)})).id("pivotTableCellFieldSelector").toDOM()))))),l=getCurrent(),domel(l).addChild("div").addChild("div",(t=>t.addClass(d).addChild("label",(t=>t.addClass("checkbox").addChild("input",(t=>{t.id("pivotTableHasTotalsRow").type("checkbox"),i.totalsRow&&t.attr("checked","")})).addText(" "+o.getText("Facets","Pivot","TotalsRowLabel")))).addChild("label",(t=>t.addClass("checkbox").addChild("input",(t=>{t.id("pivotTableHasTotalsCol").type("checkbox"),i.totalsCol&&t.attr("checked","")})).addText(" "+o.getText("Facets","Pivot","TotalsColLabel"))))))}afterDialogOpened(t){const e=document.getElementById("pivotTableCellFieldSelector").value;e&&this.validateSelectedField(e),this.getQuery().getColumns().length<=2&&(t.showAlert("The dataset should contain at least three columns to build a pivot table","error"),t.getSubmitButtonElement().disabled=!0)}validateSelectedField(e){const s=this.getContextDataTable(),i=s.columns.getIndex(e),n=s.columns.get(i),o=document.getElementById("pivotTableAggrFuncSelector");n.type==t.String?(o.disabled=!0,o.value=G.Count):o.disabled=!1}submitSettingsDialog(){const t=super.submitSettingsDialog();return t&&(this.settings={colName:document.getElementById("pivotTableColFieldSelector").value,rowName:document.getElementById("pivotTableRowFieldSelector").value,aggrFunc:document.getElementById("pivotTableAggrFuncSelector").value,fieldName:document.getElementById("pivotTableCellFieldSelector").value,totalsRow:document.getElementById("pivotTableHasTotalsRow").checked,totalsCol:document.getElementById("pivotTableHasTotalsCol").checked}),t}saveToData(){const t=super.saveToData();return this.settings&&n.assign(t,this.settings),t}loadFromData(t){super.loadFromData(t),t&&(this.settings=n.assign(this.settings,t),"AVERAGE"==this.settings.aggrFunc&&(this.settings.aggrFunc=G.Average))}refreshCore(){if(this.updatePivotData(),this.grid){const t=this.pivotTable.getTotal();t>this.grid.options.paging.pageSize&&(this.contentDiv.classList.remove("pivot-grid-with-totals"),this.showErrorMessage(o.getText("Facets","ErrTooMuchData"))),this.options.viewportRowsCount>t?this.grid.options.viewportRowsCount=t:this.grid.options.viewportRowsCount=this.options.viewportRowsCount,this.grid.refresh()}}getContextDataTable(){return this.getContext().resultTable}updatePivotData(){this.pivotTable.clear();const e=this.getContextDataTable();if(!e||0==e.getTotal())return;if(!this.settings)return;const s=this.settings.colName,i=this.settings.rowName,r=this.settings.fieldName,a=e.columns.getIndex(s),l=e.columns.getIndex(i),d=e.columns.getIndex(r);if(null==a||null==l||null==d)return void this.showUnableDisplayMessage(o.getText("Facets","ErrQueryChanged"));const h=e.columns.get(d),u=e.columns.get(a),c=e.columns.get(l),g=c.label,p=c.type,m=u.label,f=[],y=[],C=e.getCachedRows();for(let t=0;t<C.length;t++){const e=C[t].getValue(a);f.indexOf(e)<0&&f.push(e);const s=C[t].getValue(l);y.indexOf(s)<0&&y.push(s)}this.pivotTable.columns.add({id:g+"\\"+m,label:g+"\\"+m,description:"",type:p,dfmt:c.displayFormat,style:c.style});const v=[];let x=null;n.isNumericType(u.type)?x=this.formatNumber:n.getDateDataTypes().indexOf(u.type)>=0&&(x=this.formatDate);for(let e=0;e<f.length;e++){const s=f[e];if(s){const e=x?x(u,s):s;this.pivotTable.columns.add({id:s,label:e,description:"",dfmt:h.displayFormat,type:this.settings.aggrFunc!==G.Count?h.type:t.Int64,style:h.style})}else v.push(e)}let b=[];for(let t=0;t<y.length;t++)b.push([]),b[t].push(y[t]);for(let t=0;t<y.length;t++)for(let e=0;e<f.length;e++)v.indexOf(e)>=0||b[t].push(this.calcAggrFunc(this.settings.aggrFunc,{colName:this.settings.colName,rowName:this.settings.rowName,fieldName:this.settings.fieldName,rowValue:y[t],colValue:f[e]}));if(this.settings.totalsCol){this.pivotTable.columns.add({id:"total",label:o.getText("Facets","Pivot","TotalGridLabel"),description:"",dfmt:h.displayFormat,type:this.settings.aggrFunc!==G.Count?h.type:t.Int64});for(let t=0;t<b.length;t++){const e=b[t];let s=0;this.settings.aggrFunc!=G.Min&&this.settings.aggrFunc!=G.Max||(s=e[1]);for(let t=1;t<e.length;t++){const i=e[t];null!==i&&(this.settings.aggrFunc===G.Min?i<s&&(s=i):this.settings.aggrFunc===G.Max?i>s&&(s=i):s+=i)}this.settings.aggrFunc===G.Average&&(s/=e.length-1),e.push(s)}}for(const t of b)this.pivotTable.addRow(t);if(this.settings.totalsRow){let t=[];t.push(null);for(let e=1;e<this.pivotTable.columns.count;e++){const s=this.pivotTable.getCachedRows();let i=0;this.settings.aggrFunc!=G.Min&&this.settings.aggrFunc!=G.Max||(i=s[0].getValue(e));for(let t=0;t<s.length;t++){const n=s[t].getValue(e);null!==n&&(this.settings.aggrFunc===G.Min?n<i&&(i=n):this.settings.aggrFunc===G.Max?n>i&&(i=n):i+=n)}this.settings.aggrFunc===G.Average&&(i/=s.length),t.push(i)}this.pivotTable.addRow(t),this.contentDiv.classList.add("pivot-grid-with-totals")}else this.contentDiv.classList.remove("pivot-grid-with-totals")}calcAggrFunc(t,e){switch(t){case G.Sum:return this.sum(e);case G.Average:return this.average(e);case G.Min:return this.min(e);case G.Max:return this.max(e);case G.Count:return this.count(e);default:return 0}}getSettings(){return this.settings}formatDate(e,s){const i="[object Date]"===Object.prototype.toString.call(s);let n=(s||"").toString();if(i)if(e&&e.displayFormat&&j.test(e.displayFormat))n=e.displayFormat.replace(j,((t,i)=>o.dateTimeToStrEx(s,e.type,i)));else{const i=o.getCurrentLocale(),r={hour:"numeric",minute:"numeric",second:"numeric"};switch(e.type){case t.Date:n=s.toLocaleDateString(i);break;case t.Time:n=s.toLocaleTimeString(i,r);break;case t.DateTime:n=`${s.toLocaleDateString(i)} ${s.toLocaleTimeString(i,r)}`}}return n}formatNumber(t,e){let s=(e||"").toString();return"number"==typeof e&&(s=t&&t.displayFormat&&j.test(t.displayFormat)?t.displayFormat.replace(j,((t,s)=>o.numberToStr(e,s))):e.toLocaleString()),s}sum(t){let e=0;const s=this.getContextDataTable().getCachedRows();for(let i=0;i<s.length;i++){const n=s[i].getValue(t.rowName),o=s[i].getValue(t.colName);if(n!==t.rowValue||o!==t.colValue)continue;e+=s[i].getValue(t.fieldName)}return e}average(t){let e=0,s=0;const i=this.getContextDataTable().getCachedRows();for(let n=0;n<i.length;n++){const o=i[n].getValue(t.rowName),r=i[n].getValue(t.colName);if(o!==t.rowValue||r!==t.colValue)continue;e+=i[n].getValue(t.fieldName),s++}return 0!=s&&(e/=s),e}min(t){let e=Number.MAX_SAFE_INTEGER;const s=this.getContextDataTable().getCachedRows();for(let i=0;i<s.length;i++){const n=s[i].getValue(t.rowName),o=s[i].getValue(t.colName);if(n!==t.rowValue||o!==t.colValue)continue;const r=s[i].getValue(t.fieldName);r<e&&(e=r)}return e==Number.MAX_SAFE_INTEGER?null:e}max(t){let e=Number.MIN_SAFE_INTEGER;const s=this.getContextDataTable().getCachedRows();for(let i=0;i<s.length;i++){const n=s[i].getValue(t.rowName),o=s[i].getValue(t.colName);if(n!==t.rowValue||o!==t.colValue)continue;const r=s[i].getValue(t.fieldName);r>e&&(e=r)}return e==Number.MIN_SAFE_INTEGER?null:e}count(t){let e=0;const s=this.getContextDataTable().getCachedRows();for(let i=0;i<s.length;i++){const n=s[i].getValue(t.rowName),o=s[i].getValue(t.colName);n===t.rowValue&&o===t.colValue&&e++}return e}}class DataTableFacet extends ResultFacet{constructor(){super(...arguments),this.grid=null,this.title=o.getText("Facets","DataTable","FacetTitle"),this.dialogTitle=o.getText("Facets","DataTable","DlgTitle")}init(t){super.init(t),this.reinitGrid()}getSettings(){return this.settings}reinitGrid(){this.grid&&this.grid.destroy();const t=this.container.options||{};t.gridResolver&&(this.grid=t.gridResolver(this.contentDiv,this.getType())),null==this.grid&&(this.grid=new EasyGridWidget(this.contentDiv)),t.grid=t.grid||{},t.grid.autoRefresh=!1,t.grid.addColumns=!1;const e=this.getContext();t.grid.totals=this.settings,this.grid.init(e,t.grid)}getType(){return _.DataGrid}canDisplay(){return!0}refreshCore(){this.grid&&this.grid.refresh()}destroy(){this.grid&&this.grid.destroy()}}class FacetContainer extends Widget{constructor(t){super(t),this.facets=[],this.options={},this.group=C.Result}destroyCore(){for(const t of this.facets)t.destroy();this.clear()}createFacetTab(t){const e=this.options[t];switch(t){case _.Chart:return new ChartFacet(this,e);case _.PivotTable:return new PivotTableFacet(this,e);default:return new DataTableFacet(this,e)}}getQuery(){return this.getContext().getQuery()}}class ExportDialog{constructor(t){this.context=t,this.promise=null}show(t=null){if(!this.promise){const e=this.context.getExportFormats();if(0==e.length)throw Error("No exporter has been registered.");t=t||e[0],this.promise=new Promise(((e,s)=>{const i=this.context.getServices().getService("DialogService"),n=domel("div").addClass("kdlg-form-section").addChild("div",(e=>e.addClass("kfrm-form").addChild("div",(e=>e.addClass("kfrm-fields col-a-1 label-align-right").addChild("label",(t=>t.addClass("kdlg-form-label","kflex-20").attr("for","export_format").addText(o.getText("ExportDlgFmtLabel")))).addChild("div",(e=>e.addClass("kfrm-select").addChild("select",(e=>{e.attr("name","export_format").id("exportFormat");for(const s of this.context.getExportFormats())e.addOption({value:s,title:o.getText(s)||s,selected:t==s})})))))))).toDOM();i.open({title:o.getText("ExportDlgTitle"),body:n,onSubmit:()=>{const t=n.querySelector("#exportFormat").value;return this.context.exportResult({format:t,success:e,error:s}),!0}})}))}return this.promise.finally((()=>this.promise=null))}}class ResultFacetsPanel extends FacetContainer{constructor(t){super(t),this.activeFacetIndex=-1,this.firstRender=!0,this.options={showExportButton:!0,showRefreshButton:!0,showMaximizeButton:!0,maximize2Window:!1,showProcessIndicator:!0,facetTypes:[_.DataGrid,_.Chart,_.PivotTable]},this.menuItems=[{id:_.DataGrid,text:o.getText("Facets","AddMenuItems","DataTable")},{id:_.Chart,text:o.getText("Facets","AddMenuItems","Chart")},{id:_.PivotTable,text:o.getText("Facets","AddMenuItems","Pivot")}],this.menuItemsFilter=t=>!(this.options.facetTypes.indexOf(t.id)<0)&&(t.id!==_.DataGrid||0===this.facets.filter((t=>t.getType()==_.DataGrid)).length),this.slot.classList.contains(`${this.cssPrefix}-panel`)||this.slot.classList.add(`${this.cssPrefix}-panel`),this.renderProcessBlock()}get cssPrefix(){return"eqjs-facets"}getWidgetType(){return"facetsPanel"}init(t,e){super.init(t,e),this.setOptions(e),this.destroyCore(),this.attachQueryObserver(),this.loadFacets()}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId&&t.removeChangedCallback(this.queryEventCallbackId),this.queryEventCallbackId=t.addChangedCallback((t=>{const e=t.data;e.part==g.All&&e.source!=this&&(this.reloadFacets(),this.refreshCore(!0))}))}refreshCore(t=!1){(this.firstRender||t)&&(this.clear(),this.createAddMenu(),this.render()),this.validateAddFacetButton(),this.renderActiveFacet(),this.updateTotalRecords()}createAddMenu(){this.addMenu=new PopupMenu({items:this.menuItems,id:"FacetType-List"})}updateTotalRecords(){const t=this.getContext().resultTable.getTotal();this.recordsDiv.innerHTML=o.getText("Facets","TotalRecordsLabel")+" "+t,0==t?domel(this.exportDiv).hide():domel(this.exportDiv).show()}renderProcessBlock(){this._processBlock=domel("div").addClass(`${this.cssPrefix}-spinner`).addChild("div",(t=>t.addClass(`${N}-progress-win8`,getMobileCssClass()).addHtml('<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>'))).toDOM()}onProcessStartCore(){this.options.showProcessIndicator&&!this._processBlock.parentNode&&this.bodyDiv&&(this.bodyDiv.childNodes.forEach((t=>{domel(t).hide()})),this.bodyDiv.appendChild(this._processBlock))}onProcessEndCore(){if(this.options.showProcessIndicator&&this._processBlock.parentNode)try{this._processBlock.parentNode.removeChild(this._processBlock)}catch(t){}finally{this.renderActiveFacet(!1)}}render(){this.firstRender=!1,this.headerDiv=domel("div",this.slot).addClass(`${this.cssPrefix}-header`).toDOM(),this.tabsDiv=domel("div",this.headerDiv).addClass(`${this.cssPrefix}-tabs`).toDOM(),this.tabsUl=domel("ul",this.tabsDiv).addClass(`${this.cssPrefix}-nav-tabs`).toDOM(),this.bodyDiv=domel("div",this.slot).addClass(`${this.cssPrefix}-body`).toDOM();for(const t of this.facets)this.renderFacet(t);domel(this.tabsDiv).addChild("div",(t=>this.addFacetButton=t.addClass(`${this.cssPrefix}-add-button`).title(o.getText("Facets","NewFacetTitle")).addChild("a",(t=>t.attr("href","javascript:void(0)"))).on("click",(t=>this.addClickHandler(t))).toDOM()));const t=domel("div",this.headerDiv).addClass(`${this.cssPrefix}-manage`).toDOM();if(this.recordsDiv=domel("div",t).addClass(`${this.cssPrefix}-total-recs`).toDOM(),this.options.showRefreshButton||this.options.showExportButton||this.options.showMaximizeButton){const e=domel("div",t).addClass(`${this.cssPrefix}-total-buttons`).toDOM();this.options.showExportButton&&(this.exportDiv=domel("button",e).on("click",(()=>this.exportHandler())).addClass(`${this.cssPrefix}-button`).addClass(`${this.cssPrefix}-button-export`).title(o.getText("Facets","ExportBtnTitle")).toDOM()),this.options.showRefreshButton&&domel("button",e).on("click",(()=>this.refreshHandler())).addClass(`${this.cssPrefix}-button`).addClass(`${this.cssPrefix}-button-refresh`).title(o.getText("Facets","RefreshBtnTitle")),this.options.showMaximizeButton&&(this.maximizeButton=domel("button",e).on("click",(()=>this.options.maximize2Window?this.maximizeHandler(!0):this.maximizeHandler())).addClass(`${this.cssPrefix}-button`).addClass(`${this.cssPrefix}-button-maximize`).title(o.getText("Facets","MaximizeBtnTitle")).toDOM())}}refreshHandler(){const t=this.getContext();t.fetchData({success:()=>{t.refreshWidgets(C.Result)}})}exportHandler(){const t=this.getContext();new ExportDialog(t).show()}maximizeHandler(t){let e=domel(this.slot);if(t)e.toggleClass(`${N}-maximized-2window`),this.slot.classList.contains(`${N}-maximized-2window`)?(this.maximizeButton.title=o.getText("Facets","RestoreBtnTitle"),this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-maximize`,!1),this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-restore`,!0)):(this.maximizeButton.title=o.getText("Facets","MaximizeBtnTitle"),this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-restore`,!1),this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-maximize`,!0));else{const t=!this.slot.hasAttribute("data-is-maximized");t?(this.slot.setAttribute("data-is-maximized",""),this.maximizeButton.title=o.getText("Facets","RestoreBtnTitle"),this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-maximize`,!1),this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-restore`,!0)):(this.slot.removeAttribute("data-is-maximized"),this.maximizeButton.title=o.getText("Facets","MaximizeBtnTitle"),this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-restore`,!1),this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-maximize`,!0));document.querySelectorAll("[data-hide-on-max]").forEach((e=>{t?e.setAttribute("style","display: none;"):e.removeAttribute("style")}))}this.facets.forEach((t=>t.onResize()))}renderActiveFacet(t=!0){this.tabsUl.querySelectorAll("li").forEach(((t,e)=>{t.classList.contains("active")&&t.classList.remove("active"),this.activeFacetIndex===e&&t.classList.add("active")})),this.bodyDiv.querySelectorAll(`.${N}-facet`).forEach(((e,s)=>{domel(e).hide(),this.activeFacetIndex===s&&(domel(e).show(),t&&this.facets[s].refresh())}))}renderFacet(t){this.renderFacetTab(t);const e=this.renderFacetSlot(t);t.init(e)}renderFacetTab(t){return domel("li",this.tabsUl).addChild("span",(e=>e.addClass(`${N}-facet-settings`).on("click",(e=>{e.stopPropagation(),this.settingsClickHandler(t)})))).addChild("a",(e=>e.addText(t.title).attr("href","javascript:void(0)"))).addChild("span",(e=>e.addClass(`${N}-facet-close`).on("click",(e=>{e.stopPropagation(),this.closeClickHandler(t)})))).on("click",(e=>this.selectClickHandler(t))).toDOM()}renderFacetSlot(t){return domel("div",this.bodyDiv).addClass(`${N}-facet`).hide().toDOM()}refreshFacetTabs(){this.tabsUl.querySelectorAll("li").forEach((t=>{this.tabsUl.removeChild(t)}));for(const t of this.facets)this.renderFacetTab(t)}removeFacet(t){const e=this.facets.indexOf(t);if(e>=0){this.facets.splice(e,1);const t=this.tabsUl.childNodes[e];this.tabsUl.removeChild(t);const s=this.bodyDiv.childNodes[e];this.bodyDiv.removeChild(s),this.facets.length>0?this.activeFacetIndex=e<this.facets.length?e:this.facets.length-1:this.activeFacetIndex=-1,this.renderActiveFacet(),this.validateAddFacetButton()}}addClickHandler(t){this.addMenu.showMenu({anchor:t.target,itemFilterCallback:this.menuItemsFilter,itemSelectedCallback:t=>{const e=this.createFacetTab(t.id),s=this.renderFacetSlot(e);e.init(s),e.showSettingsDialog().then((t=>{t?(this.facets.push(e),this.activeFacetIndex=this.facets.length-1,this.renderFacetTab(e),this.renderActiveFacet(),this.saveFacets()):this.bodyDiv.removeChild(s)})).catch((t=>console.error(t)))}})}selectClickHandler(t){const e=this.facets.indexOf(t);this.setActiveFacet(e)}settingsClickHandler(t){t.showSettingsDialog().then((t=>{t&&(this.refreshFacetTabs(),this.renderActiveFacet(),this.saveFacets())})).catch((t=>console.error(t)))}closeClickHandler(t){this.getDialogService().openConfirm(o.getText("Facets","RemoveFacetDlgTitle"),o.getText("Facets","RemoveFacetDlgContent").replace("{facetTitle}",t.title)).then((e=>{e&&(this.removeFacet(t),this.saveFacets())})).catch((t=>console.error(t)))}clear(){this.firstRender=!0,this.slot.innerHTML=""}createDefaultFacetIfNotExist(){if(0===this.facets.length){const t=this.createFacetTab(_.DataGrid);this.facets.push(t),this.activeFacetIndex=0}}validateAddFacetButton(){this.addFacetButton.hidden=0==this.addMenu.getItems().filter(this.menuItemsFilter).length}setActiveFacet(t){this.activeFacetIndex!=t&&(this.activeFacetIndex=t,this.renderActiveFacet(),this.saveFacets(!0))}setOptions(t){n.assignDeep(this.options,t)}getDialogService(){return this.getContext().getServices().getService("DialogService")}saveFacets(t=!1){const e=this.getQuery();e.innerData=e.innerData||{},e.innerData.facets={active:this.activeFacetIndex,items:this.facets.map((t=>t.saveToData()))},e.fireChangedEvent({part:g.Facets,action:t?p.Activate:p.All,source:this})}reloadFacets(){for(const t of this.facets)t.destroy();this.loadFacets()}loadFacets(){const t=this.getQuery();if(this.facets=[],t.innerData&&t.innerData.facets){const e=t.innerData.facets.items;for(const t of e){const e=this.createFacetTab(t.type);e.loadFromData(t),this.facets.push(e)}const s=t.innerData.facets.active;this.activeFacetIndex=s>=0?s:this.facets.length-1}else this.createDefaultFacetIfNotExist()}}class ExportWidget extends Widget{getWidgetType(){return"exportWidget"}constructor(t){super(t),this.options={defFormat:"csv",enableExport:!0},this.clickHandler=t=>{this.slot.hasAttribute("disabled")||new ExportDialog(this.context).show(this.options.defFormat)},this.group=C.All}init(t,e){super.init(t,e),this.options=n.assignDeep(this.options,e),this.slot.addEventListener("click",this.clickHandler)}refreshCore(){this.options.enableExport&&this.context.resultTable&&this.context.resultTable.getCachedCount()>0?this.slot.removeAttribute("disabled"):this.slot.setAttribute("disabled","")}destroyCore(){this.slot.removeAttribute("disabled"),this.slot.removeEventListener("click",this.clickHandler)}}class AggrSettingsRenderer{get cssPrefix(){return"eqjs-as"}constructor(t){if(this.selectState={columns:[]},this.funcMap={},!t||!t.slot)throw new Error("slot is required");if(!t||!t.query)throw new Error("query is required");this.slot=t.slot,this.query=t.query,this.onChanged=t.onChanged,this.dropSelectState(),this.dropState()}render(){this.createFunctionMenu(),this.setInitialState(),this.changed()}setInitialState(){const t=this.query.getAggregationSettings(),e=t.getInternalGroups(),s=t.getAggregates();for(const t of e)this.state.groups.push({columns:t.columns});for(const t of s)this.state.aggregates.push({colId:t.colId,funcId:t.funcId});this.state.grandTotals=t.hasGrandTotals(),this.state.recordCount=t.hasRecordCount()}getAvailableColumns(){return this.query.getColumns().filter((t=>t.enabled))}renderCore(){this.slot.innerHTML="";const t=this.getAvailableColumns(),e=domel(this.slot);let s=null,i=null,n=null;const r=this.state.aggregates;let a=-1;for(const l of t){if(s&&s.columns.indexOf(l.id)>=0){this.renderColumn(i,l,!0);continue}if(s=this.getGroupForColumn(l.id),null!=s){a++;const t=domel("div",this.slot).addClass(`${this.cssPrefix}-group`).data("gindex",`${a}`);i=domel("div",t.toDOM()).addClass(`${this.cssPrefix}-columns`),this.renderColumn(i,l,!0);continue}const t=r.filter((t=>t.colId==l.id))[0];if(t){const e=domel("div",this.slot).addClass(`${this.cssPrefix}-aggr`);this.renderColumn(e,l,!0,t.funcId),e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-buttons`).addChild("button",(t=>t.addClass(`${this.cssPrefix}-unaggr-btn`).title(o.getText("AggrSettings","UnaggrBtn")).on("click",this.removeAggrBtnClickHandler.bind(this))))))}else if(this.selectState.columns.indexOf(l.id)>=0){if(null==n){const t=domel("div",this.slot).addClass(`${this.cssPrefix}-selected`);n=domel("div",t.toDOM()).addClass(`${this.cssPrefix}-columns`)}this.renderColumn(n,l,!1)}else this.renderColumn(e,l,!1)}if(n){const t=domel("div",n.toDOM().parentElement).addClass(`${this.cssPrefix}-buttons`);t.addChild("button",(t=>t.addClass(`${this.cssPrefix}-group-btn`).title(o.getText("AggrSettings","GroupBtn")).on("click",this.groupBtnClickHandler.bind(this)))),1==this.selectState.columns.length&&t.addChild("button",(t=>t.addClass(`${this.cssPrefix}-aggr-btn`).title(o.getText("AggrSettings","AggrBtn")).on("click",this.aggrBtnClickHandler.bind(this))))}domel(this.slot).addChild("div",(t=>t.addClass(`${this.cssPrefix}-counts`).addChild("label",(t=>t.addClass("eqjs-ctrl-switch").addChild("input",(t=>{t.attr("type","checkbox"),this.state.recordCount&&t.attr("checked",""),t.on("change",this.countsCheckboxChangeHandler.bind(this))})).addChild("span",(t=>t.addClass("slider round"))).addChild("span",(t=>t.addClass("switch-text").addText(o.getText("AggrSettings","GroupCountsLabel")))))))).addChild("div",(t=>t.addClass(`${this.cssPrefix}-grandtotals`).addChild("label",(t=>t.addClass("eqjs-ctrl-switch").addChild("input",(t=>{t.attr("type","checkbox"),this.state.grandTotals&&t.attr("checked",""),t.on("change",this.grandCheckboxChangeHandler.bind(this))})).addChild("span",(t=>t.addClass("slider round"))).addChild("span",(t=>t.addClass("switch-text").addText(o.getText("AggrSettings","GrandTotalsLabel"))))))));this.slot.querySelectorAll(`.${this.cssPrefix}-group`).forEach((t=>{domel(t).addChild("div",(t=>t.addClass(`${this.cssPrefix}-buttons`).addChild("button",(t=>t.addClass(`${this.cssPrefix}-ungroup-btn`).title(o.getText("AggrSettings","UngroupBtn")).on("click",this.removeGroupBtnClickHandler.bind(this))))))})),this.validateCheckboxes()}validateCheckboxes(){if(0===this.selectState.columns.length)return;let t,e,s=null;for(let i=0;i<this.slot.childNodes.length;i++){const n=this.slot.childNodes[i];n.classList.contains(`${this.cssPrefix}-selected`)?t&&t.classList.contains(`${this.cssPrefix}-column`)&&(e=t):n.classList.contains(`${this.cssPrefix}-column`)&&t&&t.classList.contains(`${this.cssPrefix}-selected`)&&(s=n),t=n}for(let t=0;t<this.slot.childNodes.length;t++){const i=this.slot.childNodes[t];i.classList.contains(`${this.cssPrefix}-column`)&&i!=e&&i!=s&&i.firstElementChild.firstElementChild.setAttribute("disabled","")}const i=`.${this.cssPrefix}-selected>.${this.cssPrefix}-columns>.${this.cssPrefix}-column`,n=this.slot.querySelectorAll(i);for(let t=1;t<n.length-1;t++){n[t].firstElementChild.firstElementChild.setAttribute("disabled","")}}isValid(){const t=this.selectState.columns.length,e=this.state.aggregates.length>0,s=this.state.groups.length>0,i=this.state.grandTotals,n=this.state.recordCount;return!t&&(s?e||n:!!e&&(s||i))}getValidationMessage(){const t=this.selectState.columns.length,e=this.state.aggregates.length>0,s=this.state.groups.length>0,i=this.state.grandTotals,n=this.state.recordCount;return t?`${o.getText("AggrSettings","SelectedError")} `:!s||e||n?!e||s||i?`${o.getText("AggrSettings","NoGroupsOrAggrError")} `:`${o.getText("AggrSettings","NoGroupsOrGrandError")} `:`${o.getText("AggrSettings","NoAggrOrCountError")} `}getSettings(){const t=new AggregationSettings(this.query);for(const e of this.state.groups)t.addGroup({columns:e.columns});for(const e of this.state.aggregates)t.addAggregateColumn(e.colId,e.funcId);return this.state.grandTotals&&t.addGrandTotals(),this.state.recordCount&&t.addCounts(),t}renderColumn(t,e,s,i=null){t.addChild("div",(t=>{t.data("colid",e.id);const n=i?`${e.caption} (${this.funcMap[i].caption})`:e.caption;s?t.addClass(`${this.cssPrefix}-column-used`).addText(n):t.addClass(`${this.cssPrefix}-column`).addChild("label",(t=>t.addClass("checkbox").addChild("input",(t=>{t.attr("type","checkbox"),this.selectState.columns.indexOf(e.id)>=0&&t.attr("checked",""),t.on("change",this.colCheckboxChangeHandler.bind(this))})).addText(n)))}))}getGroupForColumn(t){const e=this.getGroupIndexForColumn(t);return e>=0?this.state.groups[e]:null}getGroupIndexForColumn(t){for(var e=0;e<this.state.groups.length;e++){if(this.state.groups[e].columns.indexOf(t)>=0)return e}return-1}grandCheckboxChangeHandler(t){this.state.grandTotals=!this.state.grandTotals,this.onChanged&&this.onChanged()}countsCheckboxChangeHandler(t){this.state.recordCount=!this.state.recordCount,this.onChanged&&this.onChanged()}colCheckboxChangeHandler(t){const e=t.target.parentElement.parentElement.getAttribute("data-colid"),s=this.selectState.columns.indexOf(e);if(s>=0)this.selectState.columns.splice(s,1);else{this.selectState.columns.push(e);const t=this.getAvailableColumns();this.selectState.columns=this.selectState.columns.sort(((e,s)=>t.findIndex((t=>t.id==e))-t.findIndex((t=>t.id==s))))}this.changed()}groupBtnClickHandler(){this.state.groups.push({columns:this.selectState.columns});const t=this.getAvailableColumns();this.state.groups=this.state.groups.sort(((e,s)=>t.findIndex((t=>t.id==e.columns[0]))-t.findIndex((t=>t.id==s.columns[0])))),this.dropSelectState(),this.changed()}removeGroupBtnClickHandler(t){const e=t.target,s=Number.parseInt(e.parentElement.parentElement.getAttribute("data-gindex"));this.state.groups.splice(s,1),this.changed()}removeAggrBtnClickHandler(t){const e=t.target.parentElement.parentElement.querySelector(`.${this.cssPrefix}-column-used`).getAttribute("data-colid"),s=this.state.aggregates.findIndex((t=>t.colId==e));s>=0&&(this.state.aggregates.splice(s,1),this.changed())}aggrBtnClickHandler(t){this.query.getModel();const e=this.selectState.columns[0],s=this.getAvailableColumns().filter((t=>t.id==e))[0];this.functionMenu.showMenu({anchor:t.target,itemFilterCallback:t=>this.funcMap[t.id].appliedTypes.indexOf(s.expr.dataType)>=0,itemSelectedCallback:t=>{this.state.aggregates.push({colId:e,funcId:t.id}),this.dropSelectState(),this.changed()}})}clear(){this.dropSelectState(),this.dropState(),this.changed()}dropSelectState(){this.selectState={columns:[]}}dropState(){this.state={groups:[],aggregates:[],recordCount:!0,grandTotals:!1}}changed(){this.onChanged&&this.onChanged(),this.renderCore()}createFunctionMenu(){const t=this.query.getModel(),e=this.query.getModel().getAggrFunctions(),s=[];for(const i of e){if(!i||"MIN"==i.id||"MAX"==i.id||"CNTDST"==i.id)continue;this.funcMap[i.id]=i;const e=t.getAggrFunctionCaption(i.id),n={id:i.id,text:e};s.push(n)}let i=this.slot.id;i&&(i+="-FunctionsMenu");const n={items:s,id:i,searchBoxAlwaysShown:!1,domWriteItemsId:!0};this.functionMenu=new PopupMenu(n)}}class AggrSettingsDialog{constructor(t){this.context=t,this.promise=null}show(t){const e=t||this.context.getQuery();return this.query=this.context.createQuery(),this.query.loadFromData(e.toJSONData()),this.promise||(this.promise=new Promise(((t,s)=>{const i=this.context.getServices().getService("DialogService");this.body=this.renderBody();var n=i.open({title:o.getText("AggrSettings","AggrDialogTitle"),body:this.body,onSubmit:()=>!(this.query.enableAggregation&&!this.renderer.isValid())&&(e.enableAggregation=this.query.enableAggregation,e.enableAggregation&&e.useAggregation((t=>{const e=this.renderer.getSettings();t.loadFromData(e.saveToData())})),e.fireChangedEvent({part:g.Aggregation,wasModified:!1}),t(),!0),onCancel:()=>{t()}});this.renderer=new AggrSettingsRenderer({slot:this.body.querySelector("#AggrSettingsComponent"),query:this.query,onChanged:()=>{n.clearAlert();const t=this.renderer.isValid();if(!t){const t=this.renderer.getValidationMessage();n.showAlert(t,"warning")}n.getRootElement().querySelector(".kfrm-button.is-info").disabled=!t&&this.query.enableAggregation}}),this.query.enableAggregation&&this.renderer.render()}))),this.promise.catch((t=>console.error(t))).finally((()=>this.promise=null))}renderBody(){return domel("div").addChild("div",(t=>t.addClass("eqjs-as-enableaggr").addChild("label",(t=>t.addClass("eqjs-ctrl-switch").addChild("input",(t=>{t.attr("type","checkbox"),this.query.enableAggregation&&t.attr("checked",""),t.on("change",this.enableAggrCheckBoxChangeHandler.bind(this))})).addChild("span",(t=>t.addClass("slider round"))).addChild("span",(t=>t.addClass("switch-text").addText(o.getText("AggrSettings","EnableAggrLabel")))))))).addChild("div",(t=>t.id("AggrSettingsComponent"))).toDOM()}enableAggrCheckBoxChangeHandler(t){if(this.query.enableAggregation=!this.query.enableAggregation,this.body.querySelector("#AggrSettingsComponent").innerHTML="",this.query.enableAggregation)this.renderer.render();else{const t=this.body?this.body.closest(".kdlg-modal").querySelector("footer .kfrm-button.is-info"):null;t&&(t.disabled=!1)}}}class AggregationBar extends Widget{constructor(t,e){super(t),this.linkClickCallback=()=>{new AggrSettingsDialog(this.context).show(this.getQuery())},this.queryEventCallbackId=null,this.customQuery=e,this.group=C.Query|C.QueryStatus}init(t,e){super.init(t,e),this.destroyCore(),this.attachQueryObserver()}get cssPrefix(){return"eqjs-aggrb"}getWidgetType(){return"aggregationBar"}refreshCore(){this.render()}getLinkText(){const t=this.getQuery();if(t.enableAggregation){const e=t.getAggregationSettings(),s=e.getInternalGroups(),i=e.getAggregates();let n=[];const r=t.getColumns();for(const t of s){const e=t.columns.map((t=>{const e=r.find((e=>e.id==t));return e?e.caption:""}));n.push(`[${e.join(", ")}]`)}const a=n.join(", ");let l=[];const d=t.getModel().getAggrFunctions();for(const t of i){const e=r.find((e=>e.id==t.colId)),s=d.find((e=>e.id==t.funcId));e&&s&&l.push(`${e.caption} (${s.caption})`)}const h=l.join(", ");return`${a||o.getText("AggrSettings","NoGroupsLabel")} ::: ${h?`<${h}>`:o.getText("AggrSettings","NoAggrsLabel")}`}return o.getText("AggrSettings","EmptySettingsLabel")}render(){this.slot.classList.add(`${this.cssPrefix}-panel`);const t=getMobileCssClass();t&&this.slot.classList.add(t),this.dialogLink||(this.dialogLink=document.createElement("a"),this.dialogLink.setAttribute("href","javascript:void(0)"),this.slot.appendChild(this.dialogLink)),this.dialogLink.textContent=this.getLinkText(),this.dialogLink.removeEventListener("click",this.linkClickCallback),this.dialogLink.addEventListener("click",this.linkClickCallback)}clear(){this.slot.innerHTML="",this.dialogLink=null}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{this.refreshCore()}))}detachQueryObserver(){if(this.queryEventCallbackId){this.getQuery().removeChangedCallback(this.queryEventCallbackId)}}destroyCore(){this.clear(),this.detachQueryObserver()}getQuery(){return this.customQuery||this.context.getQuery()}}class LocaleWidget extends Widget{constructor(t){super(t),this.changeLocale=()=>{const t=this.selectEl.value;o.setCurrentLocale(t),this.context.refreshWidgets(C.All)},this.group=C.None}init(t,e){super.init(t,e),this.clear(),this.render()}getWidgetType(){return"changeLocale"}render(){const t=o.getLocales();if(t.length>1){this.selectEl=document.createElement("select");for(let e of t){let t=document.createElement("option");t.value=e.locale,t.innerHTML=this.displayLocaleName(e),this.selectEl.appendChild(t)}this.selectEl.value=o.getCurrentLocale(),this.selectEl.classList.add("eqv-select"),this.selectEl.addEventListener("change",this.changeLocale),this.slot.appendChild(this.selectEl)}}displayLocaleName(t){return t.englishName&&t.displayName?`${t.englishName} - ${t.displayName}`:t.englishName?t.englishName:t.displayName?t.displayName:t.locale}clear(){this.slot.innerHTML=""}destroyCore(){this.clear()}}class QueryNameWidget extends Widget{constructor(t){super(t),this.queryEventCallbackId=null,this.group=C.Query|C.QueryStatus,this.nameTemplate="{name}"}init(t,e){super.init(t,e),e&&e.nameTemplate&&(this.nameTemplate=e.nameTemplate),this.destroyCore(),this.attachQueryObserver()}get cssPrefix(){return"eqjs-query-name"}getWidgetType(){return"queryName"}refreshCore(){this.render()}render(){this.slot.classList.add(`${this.cssPrefix}`);const t=getMobileCssClass();t&&this.slot.classList.add(t),this.nameSlot||(this.nameSlot=document.createElement("div"),this.nameSlot.classList.add(`${this.cssPrefix}-text`),this.nameSlot.classList.add(`${this.cssPrefix}-theme`),this.slot.appendChild(this.nameSlot)),this.asteriskSlot||(this.asteriskSlot=document.createElement("span"),this.asteriskSlot.innerHTML="*",this.asteriskSlot.classList.add(`${this.cssPrefix}-asterisk`),this.slot.appendChild(this.asteriskSlot)),this.tooltipSlot||(this.tooltipSlot=document.createElement("span"),this.tooltipSlot.classList.add(`${this.cssPrefix}-tooltip`),this.tooltipSlot.classList.add(`${this.cssPrefix}-theme`),this.slot.appendChild(this.tooltipSlot));const e=this.context.getQuery(),s=e.getName(),i=e.getDescription()||"",n=this.nameTemplate.replace("{name}",s).replace("{description}",i);this.nameSlot.textContent=n,this.tooltipSlot.textContent=n,this.asteriskSlot.style.visibility=e.isModified()?"visible":"hidden"}clear(){this.slot.innerHTML="",this.nameSlot=null,this.tooltipSlot=null,this.asteriskSlot=null}attachQueryObserver(){const t=this.context.getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{this.refreshCore()}))}detachQueryObserver(){if(this.queryEventCallbackId){this.context.getQuery().removeChangedCallback(this.queryEventCallbackId)}}destroyCore(){this.clear(),this.detachQueryObserver()}}class View{constructor(){this.domRoots=[document],this.defaultViewOptions={enableExport:!0,disableConfirmationOnQueryChange:!1,queryFileExtensions:"text/xml,application/json",result:{clearResultOnQueryChange:!0,showChart:!0,showProcessIndicator:!0},widgets:{resultGrid:{addColumns:!1}},handlers:{}},this.viewOptions={},this.resultOptions={},this.enableExport=!1,this.services=EqServiceProvider.getInstance(),this.resetContext(),this.renderSpinner()}resetContext(){this.context=function createEqContext(){if(!E)throw Error("No context resolver");return E()}()}getDialogService(){return this.services.getService("DialogService")}init(t){try{this.context.initStart(),t&&t.shadowRoots&&(this.domRoots=this.domRoots.concat(t.shadowRoots)),this.viewOptions=this.initOptions(t),this.resultOptions=n.assignDeep(this.defaultViewOptions.result,this.viewOptions.result),this.initWidgets(this.viewOptions),this.context.init(this.viewOptions),this.initDone()}catch(t){this.context.throwError({action:"Init",sourceError:t})}}initOptions(t){return(t=n.assignDeep(this.defaultViewOptions,t)).widgets.easyGrid||(t.widgets.easyGrid=t.widgets.resultGrid||{}),t.columnTitleFormat&&(this.context.options.columnTitleFormat=t.columnTitleFormat),t.widgets.easyGrid.paging=n.assignDeep({},t.result.paging,t.widgets.easyGrid.paging),this.enableExport=t.enableExport||!1,t.widgets.exportWidget||(t.widgets.exportWidget={}),t.widgets.exportWidget.enableExport=this.enableExport,t}initWidgets(t){let e="QueryPanel",s="ColumnsPanel",i="EntitiesPanel",n="ResultPanel",o="ColumnsBar",r="FilterBar",a="ProcessBar",l="StatementPanel",d="ChangeLocale",h="QueryNameLabel",u="ResultFacetsPanel",c="ResultCount",g="ExportButton",p="AggregationBar";t.slots&&(h=t.slots.queryNameLabel||h,e=t.slots.queryPanel||e,s=t.slots.columnsPanel||s,o=t.slots.columnsBar||o,i=t.slots.entitiesPanel||i,n=t.slots.resultPanel||n,l=t.slots.statementPanel||l,a=t.slots.processBar||a,d=t.slots.changeLocale||d,u=t.slots.facetsPanel||u,c=t.slots.resultCountSpan||c,r=t.slots.filterBar||r,g=t.slots.exportButtons||g,p=t.slots.aggregationBar||p);const m=this.resolveElement(i);m&&!this.entitiesPanelWidget&&(this.entitiesPanelWidget=this.createEntitiesPanelWidget(m),this.context.addWidget(this.entitiesPanelWidget));const f=this.resolveElement(s);f&&!this.columnsPanelWidget&&(this.columnsPanelWidget=this.createColumnsPanelWidget(f),this.context.addWidget(this.columnsPanelWidget));const y=this.resolveElement(o);y&&!this.columnsBarWidget&&(this.columnsBarWidget=this.createColumnsBarWidget(y),this.context.addWidget(this.columnsBarWidget));const C=this.resolveElement(e);if(C&&!this.queryPanelWidget&&(this.queryPanelWidget=this.createQueryPanelWidget(C),this.context.addWidget(this.queryPanelWidget)),this.resultPanelSlot=this.resolveElement(n),this.resultPanelSlot){if(!this.resultGridWidget){let t=addElement(this.resultPanelSlot,"div",{cssClass:"eqv-result-grid"});this.resultGridWidget=this.createResultGridWidget(t),this.context.addWidget(this.resultGridWidget)}if(this.resultOptions.showChart&&!this.chartWidget){let t=addElement(this.resultPanelSlot,"div",{cssClass:"eqv-chart-panel"});t.style.display="none",this.chartWidget=this.createChartWidget(t),this.context.addWidget(this.chartWidget)}}const v=this.resolveElement(h);v&&!this.queryNameWidget&&(this.queryNameWidget=this.createQueryNameWidget(v),this.context.addWidget(this.queryNameWidget));const x=this.resolveElement(r);x&&!this.filterBarWidget&&(this.filterBarWidget=this.createFilterBarWidget(x),this.context.addWidget(this.filterBarWidget));const b=this.resolveElement("SortingBar");b&&!this.sortingBarWidget&&(this.sortingBarWidget=this.createSortingBarWidget(b),this.context.addWidget(this.sortingBarWidget));const E=this.resolveElement(a);E&&!this.processWidget&&(this.processWidget=this.createProcessWidget(E),this.context.addWidget(this.processWidget));const T=this.resolveElement(l);T&&!this.statementPanelWidget&&(this.statementPanelWidget=this.createStatementPanelWidget(T),this.context.addWidget(this.statementPanelWidget));const w=this.resolveElement(d);if(w){const t=this.createLocaleWidget(w);this.context.addWidget(t)}const D=this.resolveElement(u);D&&!this.resultFacetPanelWidget&&(this.resultFacetPanelWidget=this.createResultFacetsPanel(D),this.context.addWidget(this.resultFacetPanelWidget));const S=this.resolveElement(g);S&&!this.exportWidget&&(this.exportWidget=this.createExportWidget(S),this.context.addWidget(this.exportWidget)),this.resultCountSlot=this.resolveElement(c);const I=this.resolveElement(p);I&&!this.aggregationBarWidget&&(this.aggregationBarWidget=this.createAggregationBarWidget(I),this.context.addWidget(this.aggregationBarWidget))}initDone(){}resolveElement(t){if("string"==typeof t){for(const e of this.domRoots){const s=e.getElementById(t);if(s)return s}return null}return t}resolveElementsByClassName(t){let e=[];for(const s of this.domRoots){const i=s.querySelectorAll("."+t);for(let t=0;t<i.length;t++)e.push(i[t])}return e}displayRecordsCount(t){this.resultCountSlot&&void 0!==t&&(this.resultCountSlot.style.display="inline",this.resultCountSlot.innerHTML=o.getText("MsgResultCount").replace("{0}",t.toString()))}getContext(){return this.context}setDialogService(t){this.context.getServices().registerService("DialogService",(()=>t))}executeQuery(t){console.warn("`executeQuery` is deprecated. Use `fetchData` instead"),this.fetchData(t)}fetchData(t){t=t||{refresh:!0},this.context.clearResult(),this.context.getQuery().isEmpty()&&!this.resultOptions.fetchEmptyQueries||(this.showResultSpinner(),this.context.fetchData({elasticPaging:t.elasticPaging,success:e=>{this.hideResultSpinner(),this.toggleExportButtons(),this.displayRecordsCount(this.context.resultTable.getTotal()),!0===t.refresh&&this.context.refreshWidgets(C.Result),t.callback&&t.callback(),t.success&&t.success(e)},error:()=>{this.hideResultSpinner()}}))}toggleExportButtons(){this.enableExport&&this.context.resultTable&&this.context.resultTable.getCachedCount()>0?this.enableExportButtons():this.disableExportButtons()}enableExportButtons(){}disableExportButtons(){}renderSpinner(){this._spinnerDiv=domel("div").addClass("eqjs-result-spinner").addChild("div",(t=>t.addClass(`${N}-progress-win8`,getMobileCssClass()).addHtml('<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>'))).toDOM()}showResultSpinner(){if(this.resultOptions.showProcessIndicator&&this.resultPanelSlot&&!this._spinnerDiv.parentNode){for(let t=0;t<this.resultPanelSlot.children.length;t++){domel(this.resultPanelSlot.children[t]).hide()}this.resultPanelSlot.appendChild(this._spinnerDiv)}}hideResultSpinner(){if(this.resultOptions.showProcessIndicator&&this.resultPanelSlot&&this._spinnerDiv.parentNode){this._spinnerDiv.parentNode.removeChild(this._spinnerDiv);for(let t=0;t<this.resultPanelSlot.children.length;t++){domel(this.resultPanelSlot.children[t]).show()}}}createChartWidget(t){return this.resultOptions.chartWidgetResolver?this.resultOptions.chartWidgetResolver(t):new ChartJsWidget(t)}createResultGridWidget(t){return this.resultOptions.resultGridResolver?this.resultOptions.resultGridResolver(t):new EasyGridWidget(t)}createEntitiesPanelWidget(t){return new EntitiesPanel(t)}createColumnsPanelWidget(t){return new ColumnsPanel(t)}createQueryPanelWidget(t){return new QueryPanel(t)}createLocaleWidget(t){return new LocaleWidget(t)}createProcessWidget(t){return new ProcessWidget(t)}createColumnsBarWidget(t){return new ColumnsBar(t)}createFilterBarWidget(t){return new FilterBar(t)}createSortingBarWidget(t){return new SortingBar(t)}createQueryNameWidget(t){return new QueryNameWidget(t)}createStatementPanelWidget(t){return new StatementPanel(t)}createResultFacetsPanel(t){return new ResultFacetsPanel(t)}createExportWidget(t){return new ExportWidget(t)}createAggregationBarWidget(t){return new AggregationBar(t)}detach(){this.entitiesPanelWidget&&(this.entitiesPanelWidget.destroy(),this.entitiesPanelWidget=null),this.columnsPanelWidget&&(this.columnsPanelWidget.destroy(),this.columnsPanelWidget=null),this.queryPanelWidget&&(this.queryPanelWidget.destroy(),this.queryPanelWidget=null),this.columnsBarWidget&&(this.columnsBarWidget.destroy(),this.columnsBarWidget=null),this.resultGridWidget&&(this.resultGridWidget.destroy(),this.resultGridWidget=null),this.chartWidget&&(this.chartWidget.destroy(),this.chartWidget=null),this.queryNameWidget&&(this.queryNameWidget.destroy(),this.queryNameWidget=null),this.processWidget&&(this.processWidget.destroy(),this.processWidget=null),this.localeWidget&&(this.localeWidget.destroy(),this.localeWidget=null),this.statementPanelWidget&&(this.statementPanelWidget.destroy(),this.statementPanelWidget=null),this.filterBarWidget&&(this.filterBarWidget.destroy(),this.filterBarWidget=null),this.sortingBarWidget&&(this.sortingBarWidget.destroy(),this.sortingBarWidget=null),this.statementWidget&&(this.statementWidget.destroy(),this.statementWidget=null),this.exportWidget&&(this.exportWidget.destroy(),this.exportWidget=null),this.resultFacetPanelWidget&&(this.resultFacetPanelWidget.destroy(),this.resultFacetPanelWidget=null),this.resultCountSlot&&(this.resultCountSlot.innerHTML="",this.resultCountSlot=null),this.resultPanelSlot&&(this.resultPanelSlot.innerHTML="",this.resultPanelSlot=null),this.domRoots=[document],this.resetContext()}refreshWidgets(t){this.context.refreshWidgets(t)}}class ReportView extends View{constructor(){super(),this.reports=[],this.reportCache=[],this.exportButtons=[],this.exportClass="eqjs-export",this.disabledClass="eqjs-disabled",this.enableExport=!1,this.useReportCache=!0,this.syncReportOnChange=!0,this._reportSaveTemplate='<div id="kdlg-dialog-form" class="kfrm-form">\n            <div class="kfrm-fields label-above">\n                <label for="kdlg-dialog-form-input" id="kdlg-dialog-form-name-label"></label>\n                <input type="text" name="kdlg-dialog-form-input" id="kdlg-dialog-form-input" />\n                <label for="kdlg-dialog-form-textarea" id="kdlg-dialog-form-desc-label"></label>\n                <textarea type="text" name="kdlg-dialog-form-textarea" id="kdlg-dialog-form-textarea"></textarea>\n            </div>\n        </div>',this.context.useStoredQueryOnFetch=!0,this.exportButtonClickHandler=(t,e)=>{if(!t.classList.contains(this.disabledClass)){const e=t.getAttribute("data-format");this.context.exportResult({format:e})}},this.clearReportButtonClickHandler=this.clearReportButtonClick.bind(this),this.newReportButtonClickHandler=this.newReportButtonClick.bind(this),this.loadReportButtonClickHandler=this.loadReportButtonClick.bind(this),this.saveReportButtonClickHandler=this.saveReportButtonClick.bind(this),this.removeReportButtonClickHandler=this.removeReportButtonClick.bind(this),this.reloadReportDataButtonClickHandler=this.reloadReportDataButtonClick.bind(this),w.onMobileModeChanged((t=>{document.location.reload()}))}initOptions(t){return void 0!==(t=super.initOptions(t)).syncQueryOnChange&&(this.syncReportOnChange=t.syncQueryOnChange),void 0!==t.syncReportOnChange&&(this.syncReportOnChange=t.syncReportOnChange),t.syncQueryOnChange=this.syncReportOnChange,void 0!==t.useReportCache&&(this.useReportCache=t.useReportCache),this.defaultReportId=t.defaultReportId,t}initDone(){super.initDone();this.context.getQuery().addChangedCallback((t=>{const e=t.data;e&&("query.switched"==e.changeType?(this.context.clearResult(),this.context.refreshWidgets(C.Result),this.context.refreshWidgets(C.Query)):(this.disableExportButtons(),this.resultCountSlot&&(this.resultCountSlot.style.display="none")));let s=!e||"query.switched"==e.changeType||e.part==g.ExtraData||e.part==g.Facets,i=!1;if(this.syncReportOnChange){e&&"query.switched"!=e.changeType&&!e.noSync&&(i=!0,this.syncReport({success:()=>{!s&&this.viewOptions.fetchDataOnChange&&this.fetchData()}}))}!s&&this.resultOptions.clearResultOnQueryChange&&(this.context.clearResult(),this.context.refreshWidgets(C.Result)),s||i||!this.viewOptions.fetchDataOnChange||this.fetchData()})),window.setTimeout((()=>{this.context.loadQueryList({success:t=>{if(Array.isArray(t)){this.reports=t;this.reports.filter((t=>t.id==this.defaultReportId)).length>0?this.renderReportList({reportId:this.defaultReportId}):this.renderReportList()}}})}),100)}initWidgets(t){super.initWidgets(t);let e="ClearReportButton",s="NewReportButton",i="LoadReportButton",n="SaveReportButton",o="RemoveReportButton",r="ReloadReportDataButton",a="ResultCount",l="ResultExportButtons",d=this.exportClass;t.slots&&(a=t.slots.resultCountSpan||a,l=t.slots.exportButtons||l,e=t.slots.clearReportButton||e,s=t.slots.newReportButton||s,i=t.slots.loadReportButton||i,n=t.slots.saveReportButton||n,o=t.slots.removeReportButton||o,r=t.slots.reloadReportDataButton||r,d=t.slots.exportClass||d),this.exportButtons=this.domRoots.reduce(((t,e)=>t.concat(Array.from(e.querySelectorAll(`.${d}`)))),[]),this.enableExport=t.enableExport,this.enableExport?this.exportButtons.forEach((t=>{t.addEventListener("click",this.exportButtonClickHandler)})):this.hideExportButtons(),this.exportButtonsContainer=this.resolveElement(l),this.clearReportButton||(this.clearReportButton=this.resolveElement(e),this.clearReportButton&&this.clearReportButton.addEventListener("click",this.clearReportButtonClickHandler)),this.newReportButton||(this.newReportButton=this.resolveElement(s),this.newReportButton&&this.newReportButton.addEventListener("click",this.newReportButtonClickHandler)),this.loadReportButton||(this.loadReportButton=this.resolveElement(i),this.loadReportButton&&this.loadReportButton.addEventListener("click",this.loadReportButtonClickHandler)),this.saveReportButton||(this.saveReportButton=this.resolveElement(n),this.saveReportButton&&this.saveReportButton.addEventListener("click",this.saveReportButtonClickHandler)),this.removeReportButton||(this.removeReportButton=this.resolveElement(o),this.removeReportButton&&this.removeReportButton.addEventListener("click",this.removeReportButtonClickHandler)),this.reloadReportDataButton||(this.reloadReportDataButton=this.resolveElement(r),this.reloadReportDataButton||(this.reloadReportDataButton=this.resolveElement("UpdateReportButton")),this.reloadReportDataButton&&this.reloadReportDataButton.addEventListener("click",this.reloadReportDataButtonClickHandler)),this.reportListSlot=document.getElementById("ReportList"),this.resultCountSlot=this.resolveElement(a)}newReport(){const t=this.getDialogService().open({title:o.getText("NewReportDlgTitle"),body:this._reportSaveTemplate,submitable:!0,closable:!0,cancelable:!0,submitOnEnter:!0,arrangeParents:!1,beforeOpen:()=>{const t=document.getElementById("kdlg-dialog-form-input");t.value=o.getText("NewReportDefName");document.getElementById("kdlg-dialog-form-name-label").innerHTML=o.getText("SaveReportDlgLabel");document.getElementById("kdlg-dialog-form-desc-label").innerHTML=o.getText("ReportDescLabel"),t.focus()},onSubmit:()=>{const e=document.getElementById("kdlg-dialog-form-input").value;if(e&&e.replace(/\s/g,"").length>0){t.clearAlert(),t.disableButtons();const s=t.getRootElement().querySelector("header"),i=domel("div",s).addClass("eqjs-process-bar local").toDOM(),n=document.getElementById("kdlg-dialog-form-textarea").value;this.context.newQuery({name:e,description:n,success:()=>{t.close();const e=this.context.getQuery(),s=e.getId();this.insertIntoReportList({id:s,name:e.getName(),description:e.getDescription()}),this.renderReportList({reportId:s})},error:e=>{s.removeChild(i),t.enableButtons(),t.showAlert(e,"error")}})}return!1}})}loadReport(t){if(!t)throw"Empty report ID!";let e=this.findReportById(t);if(!e)return;const s=this.context.getQuery(),reportLoaded=()=>{this.renderReportProps(),this.context.resultTable.clear(),s.fireChangedEvent({part:g.All,noSync:!0,changeType:"query.switched"}),this.fetchData()};let i=this.useReportCache?this.getReportContentFromCache(e):null;i?(s.clear(),s.loadFromJson(i,{validate:!1}),reportLoaded()):this.context.loadQuery({queryId:t,silent:!0,success:()=>{this.saveReportContentInCache(e,s.toJSON()),reportLoaded()}}),this.setActiveReport(t)}saveCurrentReportAs(){const t=this.context.getQuery(),e=this.getDialogService().open({title:o.getText("SaveReportDlgTitle"),body:this._reportSaveTemplate,submitable:!0,closable:!0,cancelable:!0,submitOnEnter:!0,arrangeParents:!1,beforeOpen:()=>{const e=document.getElementById("kdlg-dialog-form-input");e.value=t.getName();document.getElementById("kdlg-dialog-form-name-label").innerHTML=o.getText("SaveReportDlgLabel");document.getElementById("kdlg-dialog-form-desc-label").innerHTML=o.getText("ReportDescLabel");document.getElementById("kdlg-dialog-form-textarea").innerText=t.getDescription(),e.focus()},onSubmit:()=>{const s=document.getElementById("kdlg-dialog-form-input").value;if(s&&s.replace(/\s/g,"").length>0){t.setId(n.generateId(s.replace(/\s/g,""))),e.clearAlert(),e.disableButtons();const i=e.getRootElement().querySelector("header"),o=domel("div",i).addClass("eqjs-process-bar local").toDOM(),r=document.getElementById("kdlg-dialog-form-textarea").value;t.setDescription(r),this.context.newQuery({clearQuery:!1,name:s,success:()=>{e.close(),this.context.refreshWidgets(C.Query);const s=this.context.getQuery().getId();this.fetchData(),this.insertIntoReportList({id:s,name:t.getName(),description:t.getDescription()}),this.renderReportList({reportId:s}),this.setActiveReport(s),this.renderReportProps()},error:t=>{i.removeChild(o),e.enableButtons(),e.showAlert(t,"error")}})}return!1}})}removeCurrentReport(){const t=this.context.getQuery();this.getDialogService().openConfirm(o.getText("RemoveReportDlgTitle"),o.getText("RemoveReportContent").replace("{reportName}",t.getName())).then((e=>{if(e){const e=t.getId();this.context.removeQuery({queryId:e,success:()=>{const t=this.removeFromReportList(e);this.renderReportList({reportIndex:t})}})}}))}syncReport(t){if(this.useReportCache){const t=this.context.getQuery(),e=this.findReportById(t.getId());e&&(e.lastUpdated=Date.now(),this.saveReportContentInCache(e,t.toJSON()))}this.context.syncQuery({success:e=>{e.query&&this.context.refreshWidgets(C.Query),e.statement&&this.context.refreshWidgets(C.Statement),t&&t.success&&t.success(e)}})}setActiveReport(t){let e=this.reportListSlot.querySelectorAll("li");for(let s=0;s<e.length;s++){const i=e[s];i.classList.remove("active");i.getAttribute("data-rid")===t&&i.classList.add("active")}}renderReportProps(){let t=this.context.getQuery();document.getElementById("ReportTitle").innerHTML=t.getName();const e=document.querySelector(".columns-bar");if(e){e.innerHTML="<strong>Columns:</strong>";let s=t.getColumns();for(let t of s)e.innerHTML+='<span class="label label-default">'+t.caption+"</span> "}}renderReportList(t){if(this.renderReportPanels(),!this.reportListSlot.matches("li")){this.reportListSlot.innerHTML="",t=t||{reportId:this.reports.length>0?this.reports[0].id:null};var e=document.createElement("ul");e.className="list-group list-group-flush",this.reportListSlot.appendChild(e);for(let t of this.reports)this.renderReportItemInList(t,e);if(t.reportId&&this.loadReport(t.reportId),void 0!==t.reportIndex){let e=t.reportIndex;e>=this.reports.length&&(e=this.reports.length-1),e<0&&this.reports.length>0&&(e=0),e>=0&&this.loadReport(this.reports[e].id)}}}detach(){this.exportButtonsContainer&&(this.showExportButtons(),this.exportButtons.forEach((t=>{t.removeEventListener("click",this.exportButtonClickHandler)})),this.exportButtons=[],this.exportButtonsContainer=null),this.clearReportButton&&(this.clearReportButton.removeEventListener("click",this.clearReportButtonClickHandler),this.clearReportButton=null),this.newReportButton&&(this.newReportButton.removeEventListener("click",this.newReportButtonClickHandler),this.newReportButton=null),this.loadReportButton&&(this.loadReportButton.removeEventListener("click",this.loadReportButtonClickHandler),this.loadReportButton=null),this.saveReportButton&&(this.saveReportButton.removeEventListener("click",this.saveReportButtonClickHandler),this.saveReportButton=null),this.removeReportButton&&(this.removeReportButton.removeEventListener("click",this.removeReportButtonClickHandler),this.removeReportButton=null),this.reloadReportDataButton&&(this.reloadReportDataButton.removeEventListener("click",this.reloadReportDataButtonClickHandler),this.removeReportButton=null),this.reportListSlot&&(this.reportListSlot.innerHTML="",this.reportListSlot=null),this.resultCountSlot&&(this.resultCountSlot.innerHTML="",this.resultCountSlot=null),super.detach()}renderReportItemInList(t,e){e||(e=this.reportListSlot.querySelector("ul"));let s=t.name||t.description||"",i=document.createElement("li");i.className="list-group-item",i.style.cursor="pointer",i.setAttribute("data-rid",t.id),i.innerText=s,t.description&&(i.title=t.description),i.addEventListener("click",(t=>{const e=t.target.getAttribute("data-rid");this.loadReport(e)})),e.appendChild(i)}renderReportPanels(){const t=document.getElementById("ReportsContainer"),e=document.getElementById("NoReportPanel");this.reports.length>0?(this.hideElement(e),this.showElement(t)):(this.hideElement(t),this.showElement(e))}hideElement(t){t&&(t.style.visibility="hidden")}showElement(t){t&&t.style.removeProperty("visibility")}insertIntoReportList(t){this.reports.push(t)}removeFromReportList(t){let e=this.indexOfReportById(t);return e>=0&&this.reports.splice(e,1),e}indexOfReportById(t){for(let e=0;e<this.reports.length;e++)if(this.reports[e].id===t)return e;return-1}clearReportButtonClick(){this.clearErrors(),this.context.clearQuery()}reloadReportDataButtonClick(){this.fetchData()}saveReportButtonClick(){this.saveCurrentReportAs()}loadReportButtonClick(){this.loadReport("LastQuery")}removeReportButtonClick(){this.removeCurrentReport()}newReportButtonClick(){this.newReport()}errorHandler(t){}clearErrors(){}disableExportButtons(){this.hideExportButtons()}enableExportButtons(){this.showExportButtons()}hideExportButtons(){this.exportButtonsContainer&&(this.exportButtonsContainer.style.display="none")}showExportButtons(){this.exportButtonsContainer&&(this.exportButtonsContainer.style.display="initial")}saveReportContentInCache(t,e){let s=this.findReportCacheItem(t.id);s||(s={id:t.id},this.reportCache.push(s)),s.lastUpdated=t.lastUpdated,s.content=e}getReportContentFromCache(t){let e=this.findReportCacheItem(t.id);return e&&e.lastUpdated===t.lastUpdated?e.content:null}findReportById(t){for(let e of this.reports)if(e.id===t)return e;return null}findReportCacheItem(t){for(let e of this.reportCache)if(e.id===t)return e;return null}}!function addOldEasyQueryUIMapper(){o.addMapper((t=>{if(t||t.texts)for(let e in t.texts)switch(e){case"PredicateTitle":t.texts.ConditionGroupTitle=t.texts[e];break;case"RootPredicateTitle":t.texts.RootConditionGroupTitle=t.texts[e];break;case"ErrIncorrectPredicateTitleFormat":t.texts.ErrIncorrectGroupTitleFormat=t.texts[e];break;case"ButtonAddPredicate":t.texts.ButtonAddGroup=t.texts[e];break;case"ButtonDelete":t.texts.CmdDelete=t.texts[e];break;case"ButtonClear":t.texts.CmdClear=t.texts[e];break;case"ButtonEnable":t.texts.CmdToggleEnable=t.texts[e];break;case"ButtonAddCondition":t.texts.CmdAddCondition=t.texts[e];break;case"ButtonAddGroup":t.texts.CmdAddCondGroup=t.texts[e]}}))}(),function addEasyQueryUITexts(){o.updateDefaultTexts({AltMenuAttribute:"Attribute",AltMenuConstantExpression:"Constant expression",ButtonApply:"Apply",ButtonCancel:"Cancel",ButtonClose:"Close",ButtonNext:"Next",ButtonPrev:"Prev",ButtonNow:"Now",ButtonOK:"OK",MenuEnable:"Enabled",MenuParameterization:"Parameterized",MenuJoinCond:"Use in JOIN",CmdClear:"Clear",CmdDelete:"Delete",CmdToggleEnable:"Toggle enable",CmdToggleEnableCustom:"Custom Expression columns are not supported",CmdAddCondition:"Add condition",CmdAddCondGroup:"Add group of conditions",ButtonSelectAll:"Select all",ButtonDeselectAll:"Clear selection",ButtonAddColumns:"Add column(s)",ButtonAddConditions:"Add condition(s)",CmdClickToAddCondition:"[Add new condition]",CmdDeleteRow:"Delete this row",ErrIncorrectGroupTitleFormat:"Incorrect condition group title format",ErrNotNumber:" is not a number",ErrIncorrectInteger:"Incorrect integer value",ErrIncorrectNumberList:"Incorrect list format",False:"False",LinkTypeAll:"all",LinkTypeAny:"any",LinkTypeNone:"none",LinkTypeNotAll:"not all",ConjAll:"and",ConjAny:"or",ConjNotAll:"and",ConjNone:"or",MsgApplySelection:"[Apply selection]",MsgAs:"as",MsgEmptyList:"(empty list)",MsgEmptyListValue:"[select value]",MsgEmptyScalarValue:"[enter value]",MsgSubQueryValue:"[edit sub-query]",MsgEmptyAttrValue:"[select attribute]",MsgEmptyOperator:"[Unrecognized operator]",MsgEmptyCustomSql:"[enter SQL expression]",MsgCustomSql:"[Custom SQL]",MsgNoResult:"No result",MsgResultCount:"{0} records found",MsgOf:"of",ConditionGroupTitle:"{lt} of the following apply",RootConditionGroupTitle:"Select records where {lt} of the following apply",StrAddConditions:"Add conditions",SubQueryDialogTitle:"Edit sub-query",SubQueryColumnTitle:"Column:",SubQueryEmptyColumn:"[select column]",SubQueryQueryPanelCaption:"Conditions",True:"True",ButtonSorting:"Sorting",ButtonToAggr:"Change to aggregate column",ButtonToSimple:"Change to simple column",ButtonFormat:"Display format",CmdAscending:"Ascending",CmdClickToAddColumn:"[Add new column]",CmdDeleteColumn:"Delete column",CmdDeleteSorting:"Delete sorting",CmdDescending:"Descending",CmdGroupAppearance:"Appearance",CmdGroupSort:"Sorting",CmdGroupFormat:"Display format",CmdNotSorted:"Not sorted",ColTypeAggrFunc:"Aggregate function",ColTypeCompound:"Calculated",ColTypeGroup:"Column type",ColTypeSimple:"Simple column",HeaderExpression:"Expression",HeaderSorting:"Sorting",HeaderTitle:"Title",SortHeaderColumn:"Column",SortHeaderSorting:"Sorting",StrAddColumns:"Add columns",CustomExpression:"Custom Expression",AddAllForEntityText:"[Add all attributes]",CmdMoveToStart:"Move to start",CmdMoveRight:"Move right",CmdMoveLeft:"Move left",CmdMoveToEnd:"Move to the end",CmdMoveUp:"Move up",CmdMoveDown:"Move down",ButtonMenu:"Show menu",CmdToSimple:"Not aggregated",CmdMoveToFirst:"Move to the first",CmdMoveToPrev:"Move to the previous",CmdMoveToNext:"Move to the next",CmdMoveToLast:"Move to the last",CmdHiddenColumn:"Hidden",RowButtonTitle:"Click to see the available options",EntityToggle:"Toggle entity",StrNoFilterDefined:"No filter defined",StrNoFilterClickToAdd:"No filter defined. Click to add a new condition",HintHours:"Hours",HintMinutes:"Minutes",RemoveQueryTitle:"Confirmation",RemoveQueryContent:"Remove query [{queryName}]?",NewQueryTitle:"New query",NewQueryContent:"New query name: ",NewQueryDefName:"New query",SaveQueryTitle:"Save query",SaveQueryContent:"Query name: ",SaveQueryDefName:"{queryName} copy",QueryChangedTitle:"Confirmation",QueryChangedContent:"The query was changed. Do you want to save it first?",QueryClearContent:"The query will cleared. Do you want to continue?",UpdateQuerySelector:"[click here to load the query]",FileNameLabel:"File name: ",SaveQueryToFileDlgTitle:"Save query to file",NewReportDefName:"New report",NewReportDlgTitle:"New report",SaveReportDlgTitle:"Save report",SaveReportDlgLabel:"Report name:",ReportDescLabel:"Description: ",RemoveReportDlgTitle:"Remove report",RemoveReportContent:"Are you sure you want to remove '{reportName}'?",Facets:{TotalRecordsLabel:"Total records:",AddMenuItems:{Chart:"Chart",Pivot:"Pivot table",DataTable:"Data table"},LoadDataDlgTitle:"Downloading data",LoadDataDlgContent:"Records loaded: {loadedRecs}/{totalRecs}",RefreshBtnTitle:"Refresh",ExportBtnTitle:"Export",MaximizeBtnTitle:"Maximize",RestoreBtnTitle:"Restore Down",RemoveFacetDlgTitle:"Remove facet",RemoveFacetDlgContent:"Are you sure, that you want to delete {facetTitle} tab?",DefaultDlgTitle:"Setup facet",DefaultFacetTitle:"",NewFacetTitle:"New Facet",TabNameLabel:"Tab name",ErrQueryChanged:"FAILED TO DISPLAY. QUERY WAS CHANGED",ErrNotEnoughData:"We can't display the graph because not all data for this query is loaded. \n        The total number of records: {totalRecs}, currently loaded: {cachedRecs}. \n        You can [download the result]. Please note: this may take some time and consume a lot of memory.",ErrTooMuchData:"Too much data. The grid is not able to display it",Chart:{FacetTitle:"Chart",DlgTitle:"Chart settings",DataColumnSelectorLabel:"Data column",LabelColumnSelectorLabel:"Label column",ChartTypeSelectorLabel:"Chart type",ShowLegendLabel:"Show legend (if available)"},Pivot:{FacetTitle:"Pivot table",DlgTitle:"Pivot settings",SwapBtnTitle:"Swap column and row fields",ColumnFieldSelectorLabel:"Column field",RowFieldSelectorLabel:"Row field",CellDataSelectorLabel:"Cell data",TotalsRowLabel:"Totals row",TotalsColLabel:"Totals column",TotalGridLabel:"Total"},DataTable:{FacetTitle:"Result table",DlgTitle:"Table facet settings"}},TotalsDlgLabel:"Totals",GrandTotalsLabel:"Grand totals",TotalsDlgTitle:"Select totals",ExportDlgTitle:"Export result",ExportDlgFmtLabel:"Format",csv:"CSV",excel:"Excel",pdf:"PDF","excel-html":"HTML (Excel-compatible)",AggrSettings:{GroupBtn:"Group selected column(s)",UngroupBtn:"Ungroup columns",AggrBtn:"Aggregate selected column",UnaggrBtn:"Remove column aggregation",GrandTotalsLabel:"Show grand totals",GroupCountsLabel:"Show record count for groups",AggrDialogTitle:"Aggregation/grouping",EnableAggrLabel:"Enable aggregation",SelectedError:"Complete the action with selected column(s)",NoGroupsOrAggrError:"Add at least one group or aggregation",NoGroupsOrGrandError:"Add at least one group, or enable grand totals",NoAggrOrCountError:"Add at least one aggregation, or enable records count",NoGroupsLabel:"No groups",NoAggrsLabel:"No aggregations",EmptySettingsLabel:"[ Click to setup ]"},ChartType:{Area:"Area chart",Bar:"Bar chart",Column:"Column chart",Combo:"Combo chart",Doughnut:"Doughnut chart",Polar:"Polar chart",Radar:"Radar chart",Histogram:"Histogram chart",Line:"Line chart",SteppedLine:"Stepped line chart",Pie:"Pie chart"}})}();EqServiceProvider.getInstance().registerService("DialogService",(()=>new DefaultDialogService)),Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector),window.NodeList&&!window.NodeList.prototype.forEach&&(window.NodeList.prototype.forEach=Array.prototype.forEach),Array.prototype.findIndex||(Array.prototype.findIndex=function(t){if(null==this)throw new TypeError("Array.prototype.findIndex called on null or undefined");if("function"!=typeof t)throw new TypeError("predicate must be a function");for(var e,s=Object(this),i=s.length>>>0,n=arguments[1],o=0;o<i;o++)if(e=s[o],t.call(n,e,o,s))return o;return-1});const U=[45,128,231];Math.trunc=Math.trunc||function(t){return isNaN(t)?NaN:t>0?Math.floor(t):Math.ceil(t)};const J={__kt:0,versionNum:"7.3",ck:function(t){if(t&&t.length)try{var e=function _bs(t){for(var e=function urlatob(t){var e=t;switch((e=(e=e.replace(/-/g,"+")).replace(/_/g,"/")).length%4){case 0:break;case 2:e+="==";break;case 3:e+="="}return window.atob(e)}(t),s=e.length,i=new Uint8Array(s),n=0;n<s;n++)i[n]=e.charCodeAt(n);return i}(t.slice(0,t.length-12)),s=t.slice(t.length-12);let r=!1;for(const t of U){var i=t36(t);if(s[0]===i[0]&&s[2]===i[1]){r=!0;break}}r||(J.__kt=-1);if(s[9]!=encChar(10,19))return void(J.__kt=-2);if(s[1]!=encChar(e[3]))return;if(J.__kt=s[3]!=encChar(e[5])?2:3,2===J.__kt){var n=`${function f36(t){for(var e=0,s=0;s<t.length;++s)e+=Y.indexOf(t[s])*Math.pow(Y.length,t.length-s-1);return e}(s.substring(4,6)+s.substring(10))}`,o=new Date(2e3+Number.parseInt(n.substring(0,2)),Number.parseInt(n.substring(2,4))-1,Number.parseInt(n.substring(4)),0,0,0,0);Date.now()>o.getTime()&&(J.__kt=1)}}catch(t){}else this.__kt=-3}};function encChar(t,e=20){return String.fromCharCode(65+t%e)}const Y="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function t36(t){for(var e="";t>0;)e=Y[t%Y.length]+e,t/=Y.length;return e}class ConditionEx extends Condition{constructor(){super(...arguments),this.readOnly=!1,this.parameterized=!1,this.inJoin=!1}isReadOnly(){return this.readOnly||this.getParent()&&this.getParent().isReadOnly()}setReadOnly(t){this.readOnly=t||this.getParent()&&this.getParent().isReadOnly(),this.conditions&&this.conditions.forEach((e=>{e.setReadOnly(t)}))}isParameterized(){return this.parameterized}setParameterized(t){this.parameterized=t}isInJoin(){return this.inJoin}setInJoin(t){this.inJoin=t}loadFromData(t,e){if(super.loadFromData(t,e),!(J.__kt<=1)&&(void 0!==e.readOnly&&this.setReadOnly(e.readOnly),void 0!==e.inJoin&&this.setInJoin(e.inJoin),void 0!==e.parameterized&&this.setParameterized(e.parameterized),e.conds))for(let s=0;s<e.conds.length;s++){let i=this.query.createCondition();i.loadFromData(t,e.conds[s]),this.conditions.push(i),i.setParent(this)}}saveToData(){let t=super.saveToData();if(J.__kt<=1)return t;if(this.isReadOnly()&&(t.readOnly=this.isReadOnly()),this.isParameterized()&&(t.parameterized=this.isParameterized()),this.isInJoin()&&(t.inJoin=this.isInJoin()),this.tag==f.Group){t.conds=[];for(let e=0;e<this.conditions.length;e++)t.conds.push(this.conditions[e].saveToData())}return t}}class QueryColumnEx extends QueryColumn{constructor(){super(...arguments),this.readOnly=!1}isReadOnly(){return this.readOnly}setReadOnly(t){this.readOnly=t}loadFromData(t,e){super.loadFromData(t,e),J.__kt<=2||e&&void 0!==e.readOnly&&(this.readOnly=e.readOnly)}saveToData(){let t=super.saveToData();return J.__kt<=2||this.isReadOnly()&&(t.readOnly=this.isReadOnly()),t}}class QueryEx extends Query{constructor(t,e){super(t,null,e)}isEx(){return J.__kt>1}createSubQuery(){return new QueryEx(this.model,{context:this.context})}createCondition(t=f.Simple){return J.__kt<=1?super.createCondition(t):new ConditionEx(this,t)}createColumn(t=!1){return J.__kt<=1?super.createColumn(t):new QueryColumnEx(this,t)}addConditionGroup(t,e=!0){if(J.__kt<=1)return super.addConditionGroup(t,e);let s=t.parent||this.getRootCondition(),i=t.linking||(s.linkType===l.All?l.Any:l.All),n=this.createCondition(f.Group);if(n.linkType=i,e){let t=this.getModel(),e=t.getFirstUICAttr();if(e){let s=t.getDefaultOperatorForAttr(e),i=this.createSimpleConditionObject(e,s,"");n.addCondition(i)}}return s.addCondition(n),n}addExtraConditionGroup(t,e=!0){return t.parent=t.parent||this.extraConditions,J.__kt<=1?super.addExtraConditionGroup(t,e):this.addConditionGroup(t)}buildQueryPath(){const t=this.getModel();if(J.__kt<=1)return this.buildQueryPath();if(t.getMainEntity())return this.buildQueryPath();const e=this.getEntitiesInQuery();if(0==e.length)throw Error("Cannon build path. Path is empty");let s=new Tree(e[0]);for(let t=1;t<e.length;t++){const i=e[t];if(s.contains(i))continue;let n=this.findPath(s.value,i);if(null==n)throw Error("Unable to build query. Cannot build path.");s=this.addPathToTree(s,n[0]===s.value?n.slice(1):n)}return s.setParents(),s}addPathToTree(t,e){if(0==e.length)return;let s=!1;for(let i of t.childs)if(i.value===e[0]){s=!0,e.length>1&&(i=this.addPathToTree(i,e.slice(1)));break}if(!s){if(this.getModel().findLink(t.value,e[0])){let s=new Tree(e[0]);t.addChild(s),e.length>1&&(s=this.addPathToTree(s,e.slice(1)))}else{if(t.parent)throw Error("Unable to build query. Cannot build path.");{let s=new Tree(t);(t=new Tree(e[0])).addChild(s),e.length>1&&(t=this.addPathToTree(t,e.slice(1)))}}}return t}findPath(t,e){let s=[],i=[],n=[],o=[],r=!1;for(s.push(t),i.push(s),o.push(t);!r;){n=[];for(let t of i)if(r=this.checkPath(t,e,n,o),r){t.push(e),s=t;break}if(i=[],!r){if(0==n.length)return null;for(let t of n)i.push(t)}}return s}checkPath(t,e,s,i){const n=t[t.length-1],o=this.getModel().getLinksByEntity(n);for(let r of o){let o=null;if(o=r.entityFrom==n?r.entityTo:r.entityFrom,o==e)return s=[],!0;if(t.indexOf(o)<0&&i.indexOf(o)<0){i.push(o);let e=new Array;e=e.concat(t),e.push(o),s.push(e)}}return!1}}class EqServerQueryStorage{constructor(t){this.context=t}init(){}newQuery(t){const e=(t=t||{}).query||this.context.getQuery(),s=this.context.getModel(),i=t.modelId||(s?s.getId():"");t.queryId&&e.setId(t.queryId),t.name&&e.setName(t.name),t.description&&e.setDescription(t.description);let n={query:e.toJSONData()};t.data&&(n.data=t.data);const o=this.context.resolveEndpoint("NewQuery",{modelId:i});return this.context.getServices().getHttpClient().post(o,n).then((t=>t.query))}getQueryList(t){const e=(t=t||{}).modelId||this.context.getModel().getId(),s=this.context.resolveEndpoint("GetQueryList",{modelId:e});return this.context.getServices().getHttpClient().get(s).then((t=>t.queries?t.queries:Promise.reject({message:"Wrong response format"})))}loadQuery(t){t=t||{};const e=this.context.getModel(),s=this.context.getQuery(),i=t.modelId||e.getId(),n=t.queryId||s.getId(),o=this.context.resolveEndpoint("GetQuery",{modelId:i,queryId:n});return this.context.getServices().getHttpClient().get(o).then((t=>t.query))}saveQuery(t){const e=(t=t||{}).query||this.context.getQuery(),s=t.queryId||e.getId();t.queryId&&e.setId(t.queryId);const i=t.modelId||e.getModel().getId();t.queryId&&e.setId(t.queryId);let n={query:e.toJSONData()};t.data&&(n.data=t.data);const o=this.context.resolveEndpoint("SaveQuery",{modelId:i,queryId:s});return this.context.getServices().getHttpClient().put(o,n).then((t=>t.query))}removeQuery(t){t=t||{};const e=this.context.getQuery(),s=t.modelId||e.getModel().getId(),i=t.queryId||e.getId();let n={modelId:s,queryId:i};t.data&&(n.data=t.data);const o=this.context.resolveEndpoint("RemoveQuery",{modelId:s,queryId:i});return this.context.getServices().getHttpClient().delete(o,n).getPromise()}}class DataModelEx extends DataModel{}class DataTableAggregatesCalculator{constructor(t){this.context=t,this.levelsTotals=[],this.prevRow=null,this.aggrContainer=new EqAggregatesContainer(t)}getAggrContainer(){return this.aggrContainer}initObjects(){this.aggrSettings=this.context.getQuery().getAggregationSettings(),this.groups=this.aggrSettings.getGroups(),this.aggregates=this.aggrSettings.getAggregates(),this.aggrColIds=this.aggrSettings.getAggregates().map((t=>t.colId)),this.aggrCols=this.context.resultTable.columns.getItems().filter((t=>this.aggrColIds.indexOf(t.id)>=0)),this.levelsTotals=[],this.prevRow=null}createColumnAggregatesObject(){return{sum:0,min:Number.MAX_VALUE,max:Number.MIN_VALUE}}calculate(t){this.initObjects(),this.aggrContainer.clear(),(t=t||{}).maxLevel=t.maxLevel>=0?t.maxLevel:0;var e=this.groups.length+1;for(let t=0;t<e;t++){let t={count:0,columns:{}};this.resetLevelTotals(t),this.levelsTotals.push(t)}const s=this.context.resultTable.getCachedRows();if(s.length>0){for(const t of s)this.processDataRow(t);for(let t=1;t<e;t++)this.flushLevelTotals(t);this.aggrSettings.hasGrandTotals()&&this.flushLevelTotals(0)}return Promise.resolve()}resetLevelTotals(t){for(const e of this.aggrCols)t.columns[e.id]=this.createColumnAggregatesObject();t.count=0}processDataRow(t){const e=this.checkLevelChange(t);if(e>=0)for(let t=e;t<this.levelsTotals.length;t++)this.flushLevelTotals(t);this.aggrSettings.hasGrandTotals()&&this.updateLevelTotals(0,t);let s=1;for(const e of this.groups)this.updateLevelTotals(s,t),s++;this.prevRow=t}checkLevelChange(t){if(null==this.prevRow)return-1;for(let s=0;s<this.groups.length;s++){var e=this.groups[s];for(const i of e.columns){const e=t.getValue(i),n=this.prevRow.getValue(i);if(!this.aggrSettings.compareValues(n,e))return s+1}}return-1}flushLevelTotals(t){let e=this.levelsTotals[t];const s=t>0?this.groups[t-1]:null;let i=this.aggrSettings.buildGroupKey(s,this.prevRow);var n={};for(const t of this.aggregates){const s=e.columns[t.colId];n[t.colId]=this.applyAggrFunc(t.funcId,s,e)}this.aggrSettings.hasRecordCount()&&(n[this.aggrSettings.COUNT_FIELD_NAME]=e.count),this.aggrContainer.updateAggregateData(t,i,n),this.resetLevelTotals(e)}applyAggrFunc(t,e,s){switch(t){case"SUM":return e.sum;case"AVG":return e.sum/s.count;case"COUNT":case"CNTDST":return s.count;case"MIN":return e.min;case"MAX":return e.max}}updateLevelTotals(t,e){const s=this.levelsTotals[t];s.count+=1;for(const t of this.aggregates){const i=e.getValue(t.colId),n=s.columns[t.colId];n.sum+=i,i<n.min&&(n.min=i),i>n.max&&(n.max=i)}}needRecalculation(){return!0}reset(){}}function strIsEmpty(t){return!t||""===t.trim()}const K="https://account.korzh.com/api/license",X=J.versionNum;class LCDialog{constructor(t){this.http=new HttpClient,this.context=t}show(){const t=new DefaultDialogService;this.dialogSet=t.createSet([{closable:!1,cancelable:!1,submitOnEnter:!0,title:"No license key for EasyQuery",body:this.buildStartPage(),submitButtonText:"Submit",onInput:this.validateForm.bind(this),onSubmit:this.startPageOnSubmit.bind(this)},{closable:!1,cancelable:!1,submitOnEnter:!0,title:"Please check your inbox",body:this.buildCodePage(),submitButtonText:"Get License Key",onInput:this.validateForm.bind(this),onSubmit:this.codePageOnSubmit.bind(this)},{closable:!1,cancelable:!1,submitable:!1,title:"Success",body:this.buildSuccessPage()},{closable:!1,cancelable:!1,submitable:!1,title:"Failure",body:this.buildFailurePage()}]);const e=this.dialogSet.open(0);setTimeout((()=>{this.validateForm(e);const t=document.getElementById("eqAuthEmail");t&&t.focus()}),200)}isValidForm(t){const e=t.querySelector("#eqAuthEmail");if(e)return!strIsEmpty(e.value)&&e.value.toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/);const s=t.querySelector("#eqAuthCode");return!s||!strIsEmpty(s.value)&&!isNaN(+s.value)&&s.value==s.value.trim()&&6===s.value.length}validateForm(t){t.getSubmitButtonElement().disabled=!this.isValidForm(t.getRootElement())}addInputField(t,e){t.addChild("label",(t=>t.attr("for",e.id).addHtml(`${e.label} ${e.required?'<sup style="color: red">*</sup>':""}: `))).addChild("input",(t=>{t.id(e.id),t.name(e.name||e.id),t.type(e.type||"text"),void 0!==e.value&&t.value(e.value),e.onInput&&t.on("input",e.onInput)}))}buildStartPage(){let t,e;const s=domel("div");return s.addChild("div",(t=>t.html('<div style="font-size:1.2em">The EasyQuery license key is either absent, invalid or was issued for a different version of the library.</div><div style="font-size:1.2em">Please fill out the form to obtain a valid trial license key.</div>'))),s.addClass("kfrm-form").addChild("div",(t=>{e=t,t.addClass("kfrm-fields label-above"),t.addClass("kfrm-break-20")})),this.addInputField(e,{id:"eqAuthEmail",name:"email",label:"Email",required:!0}),this.addInputField(e,{id:"eqAuthName",name:"contactName",label:"Name (optional)",required:!1}),s.addChild("div",(t=>t.html('<div style="margin-top:20px;font-size:0.9em">* By clicking Submit, you agree with Korzh.com <a href="https://korzh.com/terms-of-use">Terms of use</a> and <a href="https://korzh.com/privacy">Privacy policy</a>.</div><div style="font-size:0.9em">You also agree to receive email messages from Korzh.com. This consent may be revoked at any time.</div>'))),t=s.toDOM(),t}buildCodePage(){let t,e;const s=domel("div");return s.addChild("div",(t=>t.html('<div style="font-size:1.2em">We sent a confirmation code to <strong>{{email}}</strong>.</div><div style="font-size:1.2em">Please find it in the email and enter to the text box below</div>'))),s.addClass("kfrm-form").addChild("div",(t=>{e=t,t.addClass("kfrm-fields label-above"),t.addClass("kfrm-break-20")})),this.addInputField(e,{id:"eqAuthCode",name:"code",label:"Confirmation code",required:!0}),s.addChild("div",(t=>t.html('<div style="margin-top:20px;font-size:0.9em">NB: Don\'t forget to check your SPAM folder if the message does not arrive within the next 5 minutes, and mark it as "Not Spam" if it\'s found there.</div>'))),t=s.toDOM(),t.outerHTML}buildSuccessPage(){let t;const e=domel("div");return e.addChild("div",(t=>t.html('<div style="font-size:1.2em">You have successfully completed the registration.</div>{{message}}'))),t=e.toDOM(),t.outerHTML}buildFailurePage(){let t;const e=domel("div");return e.addChild("div",(t=>t.html("{{message}}"))),t=e.toDOM(),t.outerHTML}startPageOnSubmit(t){const e=document.getElementById("eqAuthEmail"),s=document.getElementById("eqAuthName");return this.authEmail=e.value,this.authName=s.value,t.disableButtons(),this.http.post(d.combinePath(K,"get-code"),{email:this.authEmail,name:this.authName,data:{ptag:this.context.backendInfo.type,apptype:this.context.backendInfo.subType}},{dataType:"json"}).then((t=>{if(0!==t.status)throw new Error(t.message);const e=this.dialogSet.openNext({email:this.authEmail});setTimeout((()=>{this.validateForm(e);const t=document.getElementById("eqAuthCode");t&&t.focus()}),200)})).catch((e=>{t.showAlert("Error: "+e.message,"error",!0),t.enableButtons()})),!1}codePageOnSubmit(t){const e=document.getElementById("eqAuthCode").value;return t.disableButtons(),this.http.post(d.combinePath(K,"get-key"),{token:e,email:this.authEmail,ptag:this.context.backendInfo.type,version:X},{dataType:"json"}).then((t=>{switch(t.status){case 0:const e=d.combinePath(this.context.getBaseEndpoint(),"lck");this.http.post(e,{version:X,key:t.key},{dataType:"json"}).then((t=>this.dialogSet.open(2,{message:'<div style="font-size:1.2em">Please restart your web application to get the key applied.</div>'})),(t=>this.dialogSet.open(2,{message:'<div style="font-size:1.2em">Please visit <a href="https://account.korzh.com">your account page on Korzh.com</a> to get the key and then add it to the <i>appsettings.json</i> file (in the <i>EasyQuery/LicenseKey</i> option).</div>'})));break;case 2:this.dialogSet.open(3,{message:'<div style="font-size:1.2em">Your trial license for EasyQuery has expired.</div><div style="font-size:1.2em">Please <a href="https://korzh.com/support">contact us</a> if you want to extend the trial period.</div>'});break;case 3:this.dialogSet.open(3,{message:'<div style="font-size:1.2em">The maintenance subscription for your EasyQuery license has expired.</div><div style="font-size:1.2em">You need to <a href="https://account.korzh.com">renew the subscription</a> to get a valid license.</div>'});break;default:throw new Error(t.message)}})).catch((e=>{e.message||(e.message="Invalid or expired code. Please re-submit your request."),t.showAlert("Error: "+e.message,"error",!0),t.enableButtons()})),!1}}class EnterpriseEqContext extends EqContext{useEnterprise(t){const func=t=>{if(J.ck(t),J.__kt>1){const t=this.getServices();t.registerDataModelResolver((t=>new DataModelEx)),t.registerQueryResolver((t=>new QueryEx(t.getModel(),{context:t}))),t.registerQueryStorageResolver((t=>new EqServerQueryStorage(t))),t.registerAggregatesCalculator((t=>new DataTableAggregatesCalculator(t))),2===J.__kt&&(console.warn("EasyQuery.JS is working in the TRIAL MODE!\nPlease order a license (https://korzh.com/easyquery) to get a proper product key."),this.createTrialWM(),setTimeout((()=>{this.showTrialWM(),setTimeout((()=>{this.hideTrialWM()}),6e3)}),3e3))}else!function showNoLicenseAlert(t){if(-3==J.__kt)new LCDialog(t).show();else{let t,e,s,i;1===J.__kt?(t="EasyQuery trial has expired",e='Your trial period for EasyQuery has expired. \n        You can <a href="https://korzh.com/support">submit a request to extend your trial</a> or <a href="https://korzh.com/easyquery#licensing">buy a license</a> to get rid of all limitations.',s="Buy a license",i="#licensing"):(t="Invalid key for EasyQuery!",e=`The EasyQuery product key is either invalid or was issued for a different version of the library.\n        The version you are using now is ${X},\n        so please <a href="https://account.korzh.com">login to your account</a> to get a proper key for version ${X}`,s="Get key",i="https://account.korzh.com");const n=(new DefaultDialogService).open({closable:!1,cancelable:!1,submitable:!1,title:t,body:e}).getRootElement().querySelector("footer");domel(n).removeClass("align-right").setStyle("justify-content","center").addChild("button",(t=>t.addClass("kfrm-button","is-info").addText(s).on("click",(t=>{window.location.href=i})))),1==J.__kt&&domel(n).addChild("button",(t=>t.addClass("kfrm-button").addText("Extend trial").on("click",(t=>{window.location.href="https://account.korzh.com"}))))}}(this)};if("string"==typeof t)func(t);else{if("function"!=typeof t)throw new Error("Wrong type of 'keyOrInitCallback' parameter. It must be a string with a license key or a callback function.");{const e=this.getServices().getHttpClient();let s=d.combinePath(this.getBaseEndpoint(),"lck2");e.get(s).then((e=>{func(e.key.split("").reverse().join("")),this.useBackend({type:e.backendType,subType:e.appType}),t()})).catch((i=>{401==i.status?func(""):(s=d.combinePath(this.getBaseEndpoint(),"lck"),e.get(s).then((e=>{func(e.split("").reverse().join("")),t()})).catch((t=>this.throwError({action:"LCK",sourceError:t}))))}))}}}createTrialWM(){let t=document.createElement("div");t.style.position="fixed",t.style.bottom="0",t.style.right="-400px",t.style.width="400px",t.style.height="100px",t.style.color="grey",t.style.textAlign="center",t.style.opacity="0.7",t.style.font="bold 1em Trebuchet MS, Tahoma, Verdana, Geneva, Arial, Helvetica, sans-serif",t.style.transition="right 3s ease-out";const e=document.createElement("div"),s=document.createElement("span");s.innerText="EasyQuery",s.style.color="#3A94D4",s.style.lineHeight="50px",e.appendChild(s);const i=document.createElement("span");i.innerText="by Korzh.com",i.style.marginLeft="10px",e.appendChild(i),t.appendChild(e);const n=document.createElement("div");n.innerText="FOR TRIAL USE ONLY",n.style.fontSize="1.2em",n.style.fontWeight="1000",t.appendChild(n),document.body.appendChild(t),this.trialDivElement=t}showTrialWM(){this.trialDivElement&&(this.trialDivElement.style.right="0")}hideTrialWM(){this.trialDivElement&&(this.trialDivElement.style.right="-400px",setTimeout((()=>{this.trialDivElement.parentNode.removeChild(this.trialDivElement)}),5e3))}}registerEqContextResolver((()=>new EnterpriseEqContext)),window.addEventListener("load",(function(){var t={calcTotals:!0,enableExport:!0,serverExporters:["pdf","excel","excel-html","csv"],syncReportOnChange:!0,handlers:{onError:function(t,e){console.error(e.sourceError)}},result:{showChart:!0,paging:{pageSize:30}},loadModelOnStart:!0,defaultModelId:"adhoc-reporting"},e=new ReportView;e.getContext().useEndpoint("/api/adhoc-reporting").useEnterprise((function(){e.init(t)})),document.ReportView=e}))}();
//# sourceMappingURL=adhoc-reporting.min.js.map
