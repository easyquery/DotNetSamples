var t;(function(t){t[t["Unknown"]=0]="Unknown";t[t["String"]=1]="String";t[t["Byte"]=2]="Byte";t[t["Word"]=3]="Word";t[t["Int32"]=4]="Int32";t[t["Int64"]=5]="Int64";t[t["Bool"]=6]="Bool";t[t["Float"]=7]="Float";t[t["Currency"]=8]="Currency";t[t["BCD"]=9]="BCD";t[t["Date"]=10]="Date";t[t["Time"]=11]="Time";t[t["DateTime"]=12]="DateTime";t[t["Autoinc"]=13]="Autoinc";t[t["Memo"]=14]="Memo";t[t["Blob"]=15]="Blob";t[t["FixedChar"]=16]="FixedChar";t[t["Guid"]=17]="Guid";t[t["Geometry"]=18]="Geometry";t[t["Geography"]=19]="Geography"})(t||(t={}));var e;(function(t){t[t["Data"]=0]="Data";t[t["Virtual"]=1]="Virtual";t[t["Lookup"]=2]="Lookup"})(e||(e={}));const s={Unknown:"Unknown",Edit:"EDIT",DateTime:"DATETIME",List:"LIST",CustomList:"CUSTOMLIST",File:"FILE"};var i;(function(t){t["Trace"]="TRACE";t["Options"]="OPTIONS";t["Get"]="GET";t["Put"]="PUT";t["Post"]="POST";t["Delete"]="DELETE"})(i||(i={}));class n{constructor(t,e){this.xhr=t;this.method=e.method;this.url=e.url;this.headers=e.headers;this.queryParams=e.queryParams;this.data=e.data}setHeader(t,e){this.headers[t]=e}setQueryParam(t,e){this.queryParams[t]=e}getXMLHttpRequest(){return this.xhr}getResponseHeaders(){if(this.xhr.readyState==this.xhr.HEADERS_RECEIVED){const t=this.xhr.getAllResponseHeaders();const e=t.trim().split(/[\r\n]+/);const s={};for(const t of e){const e=t.split(": ");const i=e.shift();const n=e.join(": ");s[i]=n}return s}return{}}open(){if(this.xhr.readyState!==this.xhr.UNSENT)return;let t=this.url;if(this.queryParams&&Object.keys(this.queryParams).length>0){t+=encodeURI("?"+Object.keys(this.queryParams).map((t=>t+"="+this.queryParams[t])).join("&"))}this.xhr.open(this.method,t,true);this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");for(const t in this.headers){this.xhr.setRequestHeader(t,this.headers[t])}}abort(){this.xhr.abort()}}var r;(function(e){function s(){return Object.values(t).filter((t=>typeof t==="number"))}e.getAllDataTypes=s;function i(){return[t.Time,t.Date,t.DateTime]}e.getDateDataTypes=i;function n(){return[t.String,t.Memo,t.FixedChar]}e.getStringDataTypes=n;const r=[t.Byte,t.Word,t.Int32,t.Int64,t.Float,t.Currency,t.Autoinc];function h(){return r}e.getNumericDataTypes=h;const o=[t.Byte,t.Word,t.Int32,t.Int64,t.Autoinc];function l(t,...e){if(!t){t={}}for(let s=0;s<e.length;s++){let i=e[s];if(i&&i.hasOwnProperty){for(let e in i){if(i.hasOwnProperty(e)){t[e]=i[e]}}}}return t}e.assign=l;function a(t,...e){return u(new WeakMap,t,e)}e.assignDeep=a;function u(t,e,s){if(!e){e={}}for(let i of s){if(i&&i.hasOwnProperty){for(let s in i){if(i.hasOwnProperty(s)){let n=i[s];if(n!==null&&typeof n==="object"&&!s.endsWith("Ref")&&!(n instanceof HTMLElement)){if(t.has(n)){e[s]=t.get(n)}else{if(Array.isArray(n)){e[s]=m(n);t.set(n,e[s])}else{if(typeof e[s]=="undefined"||e[s]==null){e[s]=Object.create(Object.getPrototypeOf(n))}t.set(n,e[s]);u(t,e[s],[n])}}}else{e[s]=n}}}}}return e}function c(t,e){return typeof t!=="undefined"?t:e}e.getIfDefined=c;function f(t){return typeof t!=="undefined"&&t!==null}e.IsDefinedAndNotNull=f;function d(t,e){const s=t.length;const i=e.length;for(let n=0;n<s&&n<i;n++){e[n]=t[n]}}e.copyArrayTo=d;function m(t){let e=[];for(let s of t){e.push(s)}return e}e.createArrayFrom=m;function p(t,e){var s=t.length;for(var i=0;i<s;i++){if(t[i].id===e)return t[i]}return null}e.findItemById=p;function g(t,e){var s=t.length;for(var i=0;i<s;i++){if(t[i].id===e)return i}return-1}e.findItemIndexById=g;function y(t,e){if(t.indexOf){return t.indexOf(e)}else{let s=t.length;for(let i=0;i<s;i++){if(e==t[i]){return i}}return-1}}e.indexOfArrayItem=y;function b(t,e,s){if(e>=t.length){throw"Index out of bounds: "+e}if(s>=t.length){s=t.length-1}let i=t.splice(e,1)[0];t.splice(s,0,i)}e.moveArrayItem=b;function v(t,e){let s=t.indexOf(e);if(s!=-1){return t.splice(s,1)[0]}}e.removeArrayItem=v;function w(t,e,s){t.splice(e,0,s)}e.insertArrayItem=w;function C(t,e,s=0,i){let n=t.length>>>0;var r=s>>0;var h=r<0?Math.max(n+r,0):Math.min(r,n);var o=i===undefined?n:i>>0;let l=o<0?Math.max(n+o,0):Math.min(o,n);while(h<l){t[h]=e;h++}return t}e.fillArray=C;function x(t,e){let s=document.getElementsByTagName("body")[0];let i=window.innerWidth||document.documentElement.clientWidth||s.clientWidth;var n=t+e;let r=0;if(n>i){r=i-n-10;if(t+r<0){r=10-t}}return r}e.shiftToFitWindow=x;function k(t){if(t===null){return false}return typeof t==="function"||typeof t==="object"}e.isObject=k;function $(t){const e=r.indexOf(t);return e>=0}e.isNumericType=$;function T(t){const e=o.indexOf(t);return e>=0}e.isIntType=T;function S(t){return!isNaN(parseFloat(t))&&isFinite(t)}e.isNumeric=S;function E(e,s){return typeof e=="undefined"||typeof s=="undefined"||e==t.Unknown||s==t.Unknown||e==s||e==t.Date&&s==t.DateTime||e==t.DateTime&&s==t.Date}e.areCompatibleDataTypes=E;function D(t,e){return t[e]||t[e.toLowerCase()]||t[e.toUpperCase()]}e.isPropSet=D;const A=4;const I="0123456789abcdefghijklmnopqrstuvwxyz";const M=0x8d60e562e627800;function B(t){if(!t){t="easy"}let e=t.length>A?N(t,A):t;if(e&&e.length>0){e+="-"}var s=I[R(0,I.length)]+I[R(0,I.length)]+I[R(0,I.length)];var i=R(0,1e4);let n=F(P()-M-i);return e+s+n}e.generateId=B;function F(t,e=36){var s="";var i=t;do{s=I[i%e]+s;i=Math.floor(i/=e)}while(i>0);return s}function N(t,e){let s=t.split("-");let i=1;let n=e;if(s.length<e){i=e/s.length;n=s.length}let r="";for(let t=0;t<n;t++){r+=L(s[t],i)}return r}function L(t,e){const s=t.length;if(s>e){let i=s/e;let n="";n+=t[0];let r=i;let h;for(let e=1;e<s;e++){h=t[e];if(e+1>r){n+=h;r+=i}}return n}else{return t}}function R(t,e){return Math.floor(Math.random()*(e-t))+t}function P(){return 621355968e9+(new Date).getTime()*1e4}function O(t){const e=parseInt(t);if(isNaN(e))throw`"${t}" is not a valid number`;return e}function Q(t,e){return new Date(e,t+1,0).getDate()}function q(t,e){if(!t||t.length==0)return new Date;const s=t.replace(/[^a-zA-Z0-9_]/g,"-");const i=e.replace(/[^a-zA-Z0-9_]/g,"-");const n=i.split("-");const r=s.split("-");const h=n.indexOf("MM");const o=n.indexOf("dd");const l=n.indexOf("yyyy");const a=n.indexOf("HH");const u=n.indexOf("mm");const c=n.indexOf("ss");const f=new Date;try{const t=l>-1&&l<r.length?O(r[l]):f.getFullYear();const e=h>-1&&h<r.length?O(r[h])-1:f.getMonth()-1;if(e>11)throw"";const s=o>-1&&o<r.length?O(r[o]):f.getDate();if(s>Q(e,t))throw"";const i=a>-1&&a<r.length?O(r[a]):0;if(i>23)throw"";const n=u>-1&&u<r.length?O(r[u]):0;if(n>59)throw"";const d=c>-1&&c<r.length?O(r[c]):0;if(d>59)throw"";return new Date(t,e,s,i,n,d)}catch(e){throw`${t} is not a valid date.`}}e.strToDateTime=q;function j(t){const e=t.split(":");try{const t=e.length>0?O(e[0]):0;if(t>23)throw"";const s=e.length>1?O(e[1]):0;if(s>59)throw"";const i=e.length>1?O(e[1]):0;if(i>59)throw"";return new Date(0,0,0,t,s,i)}catch(e){throw`${t} is not a valid time.`}}e.strToTime=j})(r||(r={}));class h{constructor(t,e){this.request=t;this.promise=e}getPromise(){return this.promise}getRequest(){return this.request}then(t,e){return this.promise.then(t,e)}catch(t){return this.promise.catch(t)}finally(t){return this.promise.finally(t)}}class o extends Error{constructor(t,e){super(e);Object.setPrototypeOf(this,o.prototype);this.status=t}}class l{get responseBody(){return this._responseBody}constructor(){this.defaultHeaders={};this.customPayload=undefined}get(t,e){return this.send(i.Get,t,null,e)}post(t,e,s){return this.send(i.Post,t,e,s)}put(t,e,s){return this.send(i.Put,t,e,s)}delete(t,e,s){return this.send(i.Delete,t,e,s)}send(t,e,s,i){i=i||{};const a=i.dataType||"json";const u=i.contentType||a!=="form-data"?"application/json":null;if(s&&a!="form-data"&&this.customPayload){s.data=r.assignDeep(s.data||{},this.customPayload)}const c="onload"in new XMLHttpRequest?XMLHttpRequest:window["XDomainRequest"];const f=new c;const d={method:t,url:e,headers:Object.assign(Object.assign({},this.defaultHeaders),i.headers||{}),queryParams:i.queryParams||{},data:s};if(u)d.headers["Content-Type"]=u;const m=new n(f,d);if(this.beforeEachRequest){console.warn(`HttpClient: 'beforeEachRequest' is deprecated and will be removed in future updates.\n            Use 'onRequest' instead`);this.beforeEachRequest(m)}if(this.onRequest){this.onRequest(m)}const p=m.data&&typeof m.data!=="string"&&a=="json"?JSON.stringify(m.data):m.data;m.open();return new h(m,new Promise(((t,s)=>{if(i.responseType)f.responseType=i.responseType;f.onerror=t=>{s(new o(f.status,f.responseText))};f.onreadystatechange=()=>{if(f.readyState!=4)return;const i=f.getResponseHeader("Content-Type")||"";const n=f.status;if(n===0){s(new o(n,"Network error or the request was aborted"))}else if(n>=200&&n<400){const e=f.responseType==="arraybuffer"||f.responseType==="blob"?f.response:i.indexOf("application/json")==0?JSON.parse(f.responseText):f.responseText;this._responseBody=e;if(this.onResponse){this.onResponse(f)}t(e)}else{const t=f.responseType==="arraybuffer"||f.responseType==="blob"?l.decodeArrayBuffer(f.response):Promise.resolve(f.responseText);t.then((t=>{const r=i.indexOf("application/json")==0?JSON.parse(t):t;this._responseBody=r;const h=r.message||(n==404?`No such endpoint: ${e}`:r);s(new o(n,h))}))}};f.send(p)})))}static decodeArrayBuffer(t){var e=new FileReader;return new Promise((s=>{e.onloadend=function(){if(e.readyState==FileReader.DONE){s(e.result)}};e.readAsText(new Blob([t]))}))}}var a;(function(e){let s={shortDateFormat:"MM/dd/yyyy",longDateFormat:"dd MMM, yyyy",editDateFormat:"MM/dd/yyyy",shortTimeFormat:"HH:mm",editTimeFormat:"HH:mm",longTimeFormat:"HH:mm:ss",shortMonthNames:["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],longMonthNames:["January","February","March","April","May","June","July","August","September","October","November","December"],shortWeekDayNames:["Sun","Mon","Tue","Wed","Thu","Fri","Sat"],longWeekDayNames:["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"],decimalSeparator:".",currency:"USD"};let i={localeId:"en-US",englishName:"English",displayName:"English",texts:{ButtonOK:"OK",ButtonCancel:"Cancel",Yes:"Yes",No:"No",True:"True",False:"False"},settings:s};let n={"en-US":i};let h;const o=[];function l(t){for(const e of o){e(t)}}function a(t){o.push(t)}e.addMapper=a;function u(){let t=[];for(let e in n){t.push({locale:e,englishName:n[e].englishName,displayName:n[e].displayName})}return t.sort(((t,e)=>{if(t.englishName>e.englishName){return 1}else if(t.englishName===e.englishName){return 0}return-1}))}e.getLocales=u;function c(){return h.localeId}e.getCurrentLocale=c;function f(t){console.warn("This method is deprecated. Use setCurrentLocale instead");d(t)}e.setLocale=f;function d(t){const e=n[t];if(e){r.assignDeep(h,e)}else{h.englishName=t;h.displayName=t;h.texts=r.assignDeep({},i.texts)}h.localeId=t}e.setCurrentLocale=d;function m(...t){let e=h.texts;let s="";if(t&&t.length){const i=t.length;for(let n=0;n<i;n++){s=e[t[n]];if(typeof s==="object"){e=s}else{break}}}return s}e.getText=m;function p(){return h.settings}e.getLocaleSettings=p;function g(t){return h.settings[t]}e.getOneLocaleSetting=g;function y(t){const e=p();if(t>0&&t<13){return e.shortMonthNames[t-1]}else{throw"Wrong month number: "+t}}e.getShortMonthName=y;function b(t){const e=p();if(t>0&&t<13){return e.longMonthNames[t-1]}else{throw"Wrong month number: "+t}}e.getLongMonthName=b;function v(t){const e=p();if(t>0&&t<8){return e.shortWeekDayNames.length>=t?e.shortWeekDayNames[t-1]:t.toString()}else{throw"Wrong month number: "+t}}e.getShortWeekDayName=v;function w(t){const e=p();if(t>0&&t<8){return e.longWeekDayNames.length>=t?e.longWeekDayNames[t-1]:t.toString()}else{throw"Wrong month number: "+t}}e.getLongWeekDayName=w;function C(t){if(!h.settings){h.settings=r.assignDeep({},s)}h.settings=r.assignDeep(h.settings,t)}e.updateLocaleSettings=C;function x(t){if(typeof t!=="object"){console.error("Wrong parameter type in updateLocaleTexts function call."+"The first parameter (localeId) is not necessary. Use updateLocaleTexts(texts) instead");return}l({localeId:h.localeId,texts:t});r.assignDeep(h.texts,t)}e.updateLocaleTexts=x;function k(t){for(let e in n){let s=n[e];s.texts=r.assignDeep({},t,s.texts)}h.texts=r.assignDeep({},t,h.texts)}e.updateDefaultTexts=k;function $(t,e){l(e);let s=h;if(t){if(!e.localeId){e.localeId=t}s=n[t];if(!s){s=r.assignDeep({},i);n[t]=s}}r.assignDeep(s,e)}e.updateLocaleInfo=$;function T(t,e){$(t,e)}e.addLocale=T;function S(t){const e=new Date(2020,5,7,19,34,56,88);const s={year:"numeric",month:"numeric",day:"numeric"};const i={hour:"numeric",minute:"numeric",second:"numeric"};const n=e.toLocaleDateString(t,s);const r=e.toLocaleTimeString(t,i);let o=n.replace("07","dd").replace("7","d").replace("06","MM").replace("6","M").replace("2020","yyyy").replace("20","yy");let l=r.replace("19","HH").replace("07","hh").replace("7","h").replace("34","mm").replace("56","ss").replace("PM","tt");if(!h.settings){h.settings={}}const a={shortDateFormat:o,shortTimeFormat:l};C(a)}function E(){const t=typeof navigator==="object"?navigator.language:undefined;S(t)}function D(){if(!h){h=r.assignDeep({},i);E()}}e.resetLocales=D;const A=/\[([^\]]+)]|y{2,4}|M{1,4}|d{1,2}|H{1,2}|h{1,2}|m{2}|s{2}|t{2}/g;function I(t,s){const i=t.getFullYear();const n=i.toString();const r=t.getMonth()+1;const h=t.getDate();const o=t.getHours();const l=t.getMinutes();const a=t.getSeconds();const u=o%12||12;const c=o>11;const f={yyyy:n,yy:n.substring(n.length-2),MMMM:e.getLongMonthName(r),MMM:e.getShortMonthName(r),MM:r<10?"0"+r:r.toString(),M:r.toString(),dd:h<10?"0"+h:h.toString(),d:h.toString(),HH:o<10?"0"+o:o.toString(),H:o.toString(),hh:u<10?"0"+u:u.toString(),h:u.toString(),tt:c?"PM":"AM",mm:l<10?"0"+l:l.toString(),ss:a<10?"0"+a:a.toString()};return s.replace(A,((t,e)=>e||f[t]))}e.dateTimeToStr=I;function M(e,s,i){if(i){if(i=="d"){i=B(t.Date)}else if(i=="D"){i=F(t.Date)}else if(i=="f"){i=B(t.DateTime)}else if(i=="F"){i=F(t.DateTime)}else if(i=="u"){i=N(s)}}else{i=B(s)}return I(e,i)}e.dateTimeToStrEx=M;function B(e){const s=p();let i;switch(e){case t.Date:i=s.shortDateFormat;break;case t.Time:i=s.shortTimeFormat;break;default:i=s.shortDateFormat+" "+s.shortTimeFormat;break}return i}function F(e){const s=p();let i;switch(e){case t.Date:i=s.longDateFormat;break;case t.Time:i=s.longTimeFormat;break;default:i=s.longDateFormat+" "+s.longTimeFormat;break}return i}function N(e){const s=p();let i;const n="yyyy-MM-dd";switch(e){case t.Date:i=n;break;case t.Time:i=s.shortTimeFormat;break;default:i=n+" "+s.shortTimeFormat;break}return i}function L(t,e,s){if(e&&e.length>0){const s=e.charAt(0).toUpperCase();if(s==="S"){return O(t,e.slice(1))}else if(["D","F","C"].indexOf(s)>=0){const s=c();return t.toLocaleString(s,q(e))}else{return Q(Math.trunc(t),e)}}const i=p();s=s||i.decimalSeparator;return t.toString().replace(".",s)}e.numberToStr=L;function R(t,s){if(s&&s.length>0){const i=s.charAt(0).toUpperCase();if(i==="S"){const i=s.slice(1).split("|");if(i.length>1){const s=i[t?1:0];return e.getText(s)||s}}}return`${t}`}e.booleanToStr=R;const P={};function O(t,s){if(!P[s]){const t=s.split("|").filter((t=>t.length>0)).map((t=>t.split("=")));P[s]={};if(t.length>0){if(t[0].length>1){for(const e of t){P[s][Number.parseInt(e[1])]=e[0]}}else{t.forEach(((t,e)=>{P[s][e]=t[0]}))}}}const i=P[s];if(i[t]!==undefined){const s=i[t];return e.getText(s)||s}return t.toString()}function Q(t,e){let s=t.toString();let i="";let n=s.length-1;for(let t=e.length-1;t>=0;t--){const r=e.charAt(t);if(r==="#"||r==="0"){if(n>=0){i+=s.charAt(n);n--}else{if(r==="0"){i+=0}}}else{i+=r}}return i.split("").reverse().join("")}function q(t){const e=p();const s=t[0].toUpperCase();const i=t.length>1?Number.parseInt(t.slice(1)):s=="D"?1:2;switch(s){case"D":return{style:"decimal",useGrouping:false,minimumIntegerDigits:i};case"C":return{style:"currency",currency:e.currency,minimumFractionDigits:i};default:return{style:"decimal",minimumFractionDigits:i,maximumFractionDigits:i}}}})(a||(a={}));class u{constructor(t){this.isEditable=true;this.name="";this.caption="";this.description="";this.parent=t;this.attributes=new Array;this.subEntities=new Array}loadFromData(t,e){if(e){this.id=e.id;this.name=e.name;this.captionPlural=e.namePlur;this.caption=e.name;this.description=e.desc;if(typeof e.ied!=="undefined")this.isEditable=e.ied;this.subEntities=new Array;if(e.ents){for(let s=0;s<e.ents.length;s++){let i=t.createEntity(this);i.loadFromData(t,e.ents[s]);this.subEntities.push(i)}}this.attributes=new Array;if(e.attrs){for(let s=0;s<e.attrs.length;s++){let i=t.createEntityAttr(this);i.loadFromData(t,e.attrs[s]);this.attributes.push(i)}}}}scan(t,e){let s={stop:false};let i=n=>{if(e)e(n,s);if(n.attributes){let e=n.attributes.length;for(let i=0;i<e&&!s.stop;i++){let e=n.attributes[i];if(t){t(e,s)}if(s.stop)return}}if(n.subEntities){let t=n.subEntities.length;for(let e=0;e<t&&!s.stop;e++){i(n.subEntities[e])}}};i(this)}getFirstPrimaryAttr(){return this.getPrimaryAttrs()[0]}getPrimaryAttrs(){return this.attributes.filter((t=>t.isPrimaryKey))}}class c{constructor(s){this.id="";this.caption="{Unrecognized attribute}";this.dataType=t.String;this.size=0;this.isPrimaryKey=false;this.isForeignKey=false;this.isNullable=true;this.showOnView=true;this.isEditable=true;this.showOnCreate=true;this.showOnEdit=true;this.showInLookup=false;this.lookupAttr="";this.expr="";this.entity=s;this.kind=e.Data}loadFromData(t,e){if(e){this.id=e.id;this.description=e.desc;this.caption=e.cptn;this.dataType=e.dtype;this.isPrimaryKey=e.ipk;this.isForeignKey=e.ifk;this.size=e.size;this.lookupAttr=e.lattr;this.lookupEntity=e.lent;this.dataAttr=e.dattr;this.lookupDataAttr=e.ldattr;const s=r.getDateDataTypes().indexOf(this.dataType);this.defaultValue=e.defVal&&s?new Date(e.defVal):e.defVal;this.isNullable=r.getIfDefined(e.nul,this.isNullable);this.isEditable=r.getIfDefined(e.ied,this.isEditable);this.showOnView=r.getIfDefined(e.ivis||e.sov,this.showOnView);this.showOnCreate=r.getIfDefined(e.soc,this.showOnCreate);this.showOnEdit=r.getIfDefined(e.soe,this.showOnEdit);this.showInLookup=r.getIfDefined(e.sil,this.showInLookup);this.kind=e.kind;this.displayFormat=e.dfmt;if(e.udata)this.userData=e.udata;if(e.edtr){this.defaultEditor=t.getEditorById(e.edtr)||t.createValueEditor()}}}}class f{constructor(){this.id="";this.tag=s.Unknown;this.resType=t.Unknown;this.defValue=""}loadFromData(t){if(t){this.id=t.id;this.tag=t.tag;this.defValue=t.defval;this.resType=t.rtype;this.accept=t.accept;this.multiline=t.multiline;if(t.subType){this.resType=t.subType}if(t.name){this.name=t.name}if(t.values){this.values=t.values}}}getValueText(t){let e="";if(!this.values)return e;if(Array.isArray(t)){for(let s of this.values){if(t.indexOf(s.id)>=0){e+=s.text+","}}}else{for(let s of this.values){if(s.id===t){e+=s.text+","}}}if(e){e=e.substring(0,e.length-1)}return e}}class d{constructor(){this.mainEntity=null;this.id="__none";this.name="Empty model";this.rootEntity=this.createEntity();this.displayFormats=new Map}getMainEntity(){return this.mainEntity}createEntity(t){return new u(t)}createEntityAttr(t){return new c(t)}createValueEditor(){return new f}loadFromJSON(t){let e=JSON.parse(t);this.loadFromData(e)}loadFromData(e){this.id=e.id;this.name=e.name;this.version=e.vers;this.editors=new Array;if(e.editors){for(let t=0;t<e.editors.length;t++){let s=this.createValueEditor();s.loadFromData(e.editors[t]);this.editors.push(s)}}this.rootEntity.loadFromData(this,e.entroot);this.displayFormats=new Map;if(e.displayFormats){for(const s in e.displayFormats){const i=t[s];const n=e.displayFormats[s]||new Array;this.displayFormats.set(i,n)}}}getDisplayFormats(){return this.displayFormats}getDisplayFormatsForType(t){if(this.displayFormats.has(t)){return this.displayFormats.get(t)}return[]}getDefaultFormat(t){if(this.displayFormats.has(t)){return this.displayFormats.get(t).filter((t=>t.isdef))[0]}return null}setData(t){if(typeof t==="string"){this.loadFromJSON(t)}else{this.loadFromData(t)}}isEmpty(){return this.rootEntity.subEntities.length===0&&this.rootEntity.attributes.length===0}getId(){return this.id}getName(){return this.name}getRootEntity(){return this.rootEntity}getEditorById(t){for(let e of this.editors){if(e.id===t){return e}}return null}getAttributeById(t){let e=this.getEntityAttrById(this.getRootEntity(),t);if(!e){return null}return e}checkAttrProperty(t,e){let s=this.getAttributeById(t);if(s){if(typeof s[e]==="undefined"){throw"No such property: "+e}if(s[e]){return true}else if(s.lookupAttr){t=s.lookupAttr;s=this.getAttributeById(t);return s&&s[e]}else{return false}}else return false}getEntityAttrById(t,e){let s;if(t.attributes){let i=t.attributes.length;for(s=0;s<i;s++){if(t.attributes[s].id==e){return t.attributes[s]}}}let i;if(t.subEntities){let n=t.subEntities.length;for(s=0;s<n;s++){i=this.getEntityAttrById(t.subEntities[s],e);if(i)return i}}return null}listByEntityWithFilter(t,e){let s=new Array;let i;let n=null;if(t.subEntities){let h=t.subEntities.length;for(let o=0;o<h;o++){n=t.subEntities[o];if(!e||e(n,null)){i=a.getText("Entities",n.name);if(!i){i=n.caption}let t=r.assign(this.createEntity(),{id:n.name,text:i,items:[],isEntity:true});t.items=this.listByEntityWithFilter(n,e);if(t.items.length>0)s.push(t)}}}let h=null;if(t.attributes){let n=t.attributes.length;for(let o=0;o<n;o++){h=t.attributes[o];if(!e||e(t,h)){i=a.getText("Attributes",h.id);if(!i)i=h.caption;let t=r.assign(this.createEntity(),{id:h.id,text:i,dataType:h.dataType});s.push(t)}}}return s}listByEntity(t,e,s){e=e||{};let i=[];let n=[];let h;let o=null;if(t.subEntities){let n=t.subEntities.length;for(let l=0;l<n;l++){o=t.subEntities[l];if(!s||s(o,null)){h=a.getText("Entities",o.name)||o.caption;let t=r.assign(this.createEntity(),{id:o.name,text:h,items:[],isEntity:true,description:o.description});let n=r.assign({},e);n.includeRootData=false;t.items=this.listByEntity(o,n,s);if(t.items.length>0){i.push(t)}}}}let l=null;if(t.attributes){let e=t.attributes.length;for(let i=0;i<e;i++){l=t.attributes[i];if(!s||s(t,l)){h=a.getText("Attributes",l.id)||l.caption;n.push(r.assign(this.createEntityAttr(t),{id:l.id,text:h,dataType:l.dataType,lookupAttr:l.lookupAttr,description:l.description}))}}}let u=(t,e)=>{if(t.text.toLowerCase()==e.text.toLowerCase()){return 0}if(t.text.toLowerCase()>e.text.toLowerCase()){return 1}return-1};if(e.sortEntities){i.sort(u);n.sort(u)}let c;if(!e.attrPlacement||e.attrPlacement==0){c=i.concat(n)}else{c=n.concat(i)}if(e.attrPlacement==2){c.sort(u)}if(e.includeRootData){h=a.getText("Entities",t.name);if(!h)h=t.caption;return{id:t.name,text:h,items:c}}else{return c}}clear(){this.rootEntity=this.createEntity();this.editors=[];this.version=""}addDefaultValueEditors(){let e;e=this.addOrUpdateValueEditor("_DTE",s.Edit,t.String);e.defValue="";this.addOrUpdateValueEditor("_DPDE",s.DateTime,t.DateTime);this.addOrUpdateValueEditor("_DPTE",s.DateTime,t.DateTime)}addOrUpdateValueEditor(t,e,s){let i=r.findItemById(this.editors,t);if(!i){i=this.createValueEditor();i.id=t;this.editors.push(i)}i.tag=e;i.resType=s;return i}getEntitiesTree(t,e){return this.listByEntity(this.getRootEntity(),t,e)}getEntitiesTreeWithFilter(t){return this.listByEntityWithFilter(this.getRootEntity(),t)}getFullEntityPathByAttr(t,e){e=e||" ";return this.getEntityPathByAttr(this.getRootEntity(),t,e,true)}getEntityPathByAttr(t,e,s,i){if(!t)return"";s=s||" ";let n="";if(t.caption&&!i){let e=a.getText("Entities",t.caption);n=e?e:t.caption}if(t.attributes){let s=t.attributes.length;for(let i=0;i<s;i++){if(t.attributes[i].id==e){return n}}}if(t.subEntities){let i=t.subEntities.length;for(let r=0;r<i;r++){let i=t.subEntities[r];let h=this.getEntityPathByAttr(i,e,s,false);if(h!==""){if(n!=="")h=n+s+h;return h}}}return""}getAttributeText(t,e){let s=a.getText("Attributes",t.id);if(!s){s=t.caption}if(!e){return s}let i="";let n=this.getFullEntityPathByAttr(t.id," ");if(n){i=e.replace(new RegExp("{attr}","g"),s);i=i.replace(new RegExp("{entity}","g"),n)}else{i=s}return i.trim()}runThroughEntities(t,e){this.getRootEntity().scan(t,e)}getFirstAttributeByFilter(t){let e=null;this.runThroughEntities((function(s,i){if(t(s)){i.stop=true;e=s}}),null);return e}}class m{constructor(t){this.colStore=t;this.aggregates=[];this.groups=[];this.useGrandTotals=false;this.useRecordCount=false;this._caseSensitiveGroups=false;this.COUNT_FIELD_NAME="GRPRECCNT"}get caseSensitiveGroups(){return this._caseSensitiveGroups}set caseSensitiveGroups(t){this._caseSensitiveGroups=t;this.updateCompareProc()}updateCompareProc(){this.compareValues=this._caseSensitiveGroups?this.strictCompare:this.caseInsensitiveCompare}addGroup(t){const e=t.columns||this.colStore.getColumnIds(t.from,t.to);if(!this.colStore.validateColumns(e))throw"Invalid columns: "+e;if(this.hasColumnsInUse(e))throw"Can't add same columns to different groups/aggregates";this.groups.push(Object.assign({columns:e},t));return this}addAggregateColumn(t,e){const s=typeof t=="string"?t:this.colStore.getColumnIds(t,t)[0];if(this.hasColumnsInUse([s])||!this.colStore.validateAggregate(s,e))throw"Invalid aggregation function for the column: "+s;this.aggregates.push({colId:s,funcId:e});return this}addGrandTotals(){this.useGrandTotals=true;return this}addCounts(){this.useRecordCount=true;return this}getGroups(){let t=[];const e=this.groups.map((e=>{t=t.concat(e.columns);return Object.assign(Object.assign({},e),{columns:Array.from(t),aggregates:Array.from(this.aggregates)})}));return e}getInternalGroups(){return this.groups}lastGroup(){const t=this.getGroups();return t[t.length-1]}getAggregates(){return this.aggregates}hasAggregates(){return this.aggregates.length>0}hasGroups(){return this.groups.length>0}hasGrandTotals(){return this.useGrandTotals}hasRecordCount(){return this.useRecordCount}isEmpty(){return!(this.hasAggregates()||this.hasGroups()||this.hasGrandTotals()||this.hasRecordCount())}isValid(){return this.hasGroups()&&(this.hasAggregates()||this.hasRecordCount())||this.hasAggregates&&this.hasGrandTotals()}drop(){console.warn('"drop()" method is obsolete. Use "clear()" instead');this.clear()}clear(){this.groups=[];this.aggregates=[];this.useGrandTotals=false;this.useRecordCount=false;this.caseSensitiveGroups=false;return this}hasColumnsInUse(t){for(const e of this.groups){const s=e.columns.filter((e=>t.indexOf(e)>=0));if(s.length>0)return true}for(const e of this.aggregates){if(t.indexOf(e.colId)>=0)return true}return false}needAggrCalculation(){return(this.hasAggregates()||this.hasRecordCount())&&(this.hasGrandTotals()||this.hasGroups())}saveToData(){return{groups:Array.from(this.groups),ugt:this.useGrandTotals,urc:this.useRecordCount,csg:this.caseSensitiveGroups,aggregates:Array.from(this.aggregates)}}loadFromData(t){if(t){if(typeof t.ugt!=="undefined")this.useGrandTotals=t.ugt;if(typeof t.urc!=="undefined")this.useRecordCount=t.urc;if(typeof t.csg!=="undefined")this.caseSensitiveGroups=t.csg;if(t.groups){this.groups=Array.from(t.groups)}if(t.aggregates){this.aggregates=Array.from(t.aggregates)}}}buildGroupKey(t,e){const s=!this.caseSensitiveGroups;let i={};if(t){for(const n of t.columns){let t=e.getValue(n);if(s&&typeof t==="string"){t=t.toLowerCase()}i[n]=t}}return i}strictCompare(t,e){if(t instanceof Date){return t.getTime()===e.getTime()}else return t===e}caseInsensitiveCompare(t,e){if(t instanceof Date){return t.getTime()===e.getTime()}else{const s=typeof t==="string"?t.toLowerCase():t;const i=typeof e==="string"?e.toLowerCase():e;return s===i}}}var p;(function(t){t[t["None"]=0]="None";t[t["Left"]=1]="Left";t[t["Center"]=2]="Center";t[t["Right"]=3]="Right"})(p||(p={}));class g{constructor(e){if(!e)throw Error("Options are required");if(!e.id)throw Error("Field Id is required");if(!e.label)throw Error("Label is required");this.id=e.id;this.type=r.getIfDefined(e.type,t.String);this.label=e.label;this.originAttrId=e.originAttrId;this.isAggr=e.isAggr||false;this.displayFormat=e.dfmt;this.groupFooterColumnTemplate=e.gfct;this.style=e.style||{};this.description=e.description;this.calculatedWidth=0}}class y{constructor(){this.items=[];this.mapper={};this._dateColumnIdx=[]}get count(){return this.items.length}add(e){let s;if(e instanceof g){s=e}else{s=new g(e)}const i=this.items.length;this.items.push(s);this.mapper[s.id]=i;if([t.Date,t.DateTime,t.Time].indexOf(s.type)>=0){this._dateColumnIdx.push(i)}return i}updateDateColumnIdx(){this._dateColumnIdx=this.getItems().filter((e=>[t.Date,t.DateTime,t.Time].indexOf(e.type)>=0)).map(((t,e)=>e))}put(t,e){if(t>=0&&t<this.count){this.items[t]=e;this.updateDateColumnIdx()}}move(t,e){let s=this.items.indexOf(t);if(s>=0&&s!=e){r.moveArrayItem(this.items,s,e);this.updateDateColumnIdx()}}get(t){if(t>=0&&t<this.count){return this.items[t]}else{return null}}getIndex(t){return this.mapper[t]}getItems(){return this.items}getDateColumnIndexes(){return this._dateColumnIdx}removeAt(t){const e=this.get(t);this.items.splice(t,1);const s=this._dateColumnIdx.indexOf(t);if(s>=0){this._dateColumnIdx.splice(s,1)}delete this.mapper[e.id]}clear(){this.items=[];this._dateColumnIdx=[];this.mapper={}}}class b{constructor(t,e){this.columns=t;this.values=e}toArray(){return Array.from(this.values)}size(){return this.values.length}getValue(t){let e;if(typeof t==="string"){e=this.columns.getIndex(t);if(e===undefined){throw new RangeError(`No column with id '${t}'`)}}else{e=t}if(e>=this.values.length)throw new RangeError("Out of range: "+e);return this.values[e]}setValue(t,e){let s;if(typeof t==="string"){s=this.columns.getIndex(t);if(s===undefined){throw new RangeError(`No column with id '${t}'`)}}else{s=t}if(s>=this.values.length)throw new RangeError("Out of range: "+s);this.values[s]=e}}class v{constructor(t){this._chunkSize=1e3;this._elasticChunks=false;this.cachedRows=[];this.total=0;this.loader=null;this.needTotal=true;this.isInMemory=false;t=t||{};this._chunkSize=t.chunkSize||this._chunkSize;this._elasticChunks=t.elasticChunks||this._elasticChunks;this.loader=t.loader;if(typeof t.inMemory!=="undefined"){this.isInMemory=t.inMemory}if(this.isInMemory){this.needTotal=false}this._columns=new y;this.onUpdate=t.onUpdate;if(t.columns){for(const e of t.columns){this._columns.add(e)}}if(t.rows){for(const e of t.rows){const t=this.createRow(e);this.addRow(t)}}this.needTotal=!this._elasticChunks}get columns(){return this._columns}get chunkSize(){return this._chunkSize}set chunkSize(t){this._chunkSize=t;this.total=0;this.needTotal=!this.elasticChunks;this.cachedRows=[]}get elasticChunks(){return this._elasticChunks}set elasticChunks(t){this._elasticChunks=t;this.total=0;this.needTotal=!this.elasticChunks;this.cachedRows=[]}getRows(t){let e=0,s=this._chunkSize;if(t){if("page"in t){e=t.pageSize*(t.page-1);s=t.pageSize}else{e=t.offset;s=t.limit}}let i=e+s;if(!this.needTotal&&!this.elasticChunks){if(e>=this.total){return Promise.resolve([])}if(i>this.total){i=this.total}}if(this.isInMemory&&i>this.cachedRows.length){i=this.cachedRows.length}let n=i<=this.cachedRows.length;if(n){return Promise.resolve(this.cachedRows.slice(e,i))}if(!this.loader){throw`Loader is not defined. Can't get the rows from ${e} to ${i}`}const r=this.needTotal;if(this.needTotal){this.needTotal=false}let h=this.cachedRows.length;let o=i-h;if(o<this._chunkSize){o=this._chunkSize}const l=this.loader.loadChunk({offset:h,limit:o,needTotal:r}).then((t=>{if(r){this.total=t.total}Array.prototype.push.apply(this.cachedRows,t.table.getCachedRows());if(i>this.cachedRows.length){i=this.cachedRows.length}if(this.elasticChunks){const e=t.table.getCachedCount();if(e<o){this.total=this.cachedRows.length}}this.fireUpdated();return this.cachedRows.slice(e,i)}));return l}getRow(t){return this.getRows({offset:t,limit:1}).then((t=>t.length>0?t[0]:null))}getTotal(){return this.total}setTotal(t){this.total=t;this.needTotal=false}getCachedCount(){return this.cachedRows.length}clear(){this.columns.clear();this.cachedRows=[];this.total=0;this.needTotal=!this._elasticChunks;this.fireUpdated()}createRow(t){const e=this._columns.getDateColumnIndexes();const s=new Array(this._columns.count);const i=t instanceof b?e=>t.getValue(e):e=>t[e];if(t){this.columns.getItems().forEach((t=>{const n=i(t.id);const r=this.columns.getIndex(t.id);s[r]=e.indexOf(r)>=0?this.mapDate(n,t.type):n}))}return new b(this._columns,s)}mapDate(e,s){if(e){let i=new Date(e);if(isNaN(i.getTime())&&s==t.Time){i=r.strToTime(e)}return i}return null}addRow(t){let e;if(Array.isArray(t)){let s=t;const i=this._columns.getDateColumnIndexes();if(i.length>0){for(const t of i){if(s[t]){s[t]=this.mapDate(s[t],this._columns.get(t).type)}}}e=new b(this._columns,s)}else{e=this.createRow(t)}this.cachedRows.push(e);const s=this.getCachedCount();if(s>this.total){this.total=s}return e}getCachedRows(){return this.cachedRows}totalIsKnown(){if(this.elasticChunks){const t=this.getCachedCount();return t===this.total}return!this.needTotal}fireUpdated(){if(this.onUpdate){this.onUpdate(this)}}}class w{static newGuid(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(function(t){var e=Math.random()*16|0,s=t=="x"?e:e&3|8;return s.toString(16)}))}}class C{constructor(t){this.silentMode=0;this.events=new Array;this.source=t}subscribe(t,e){let s=this.getEventRecByType(t);const i={id:w.newGuid(),callback:e};if(s){s.eventCallbacks.push(i)}else{s={type:t,eventCallbacks:new Array(i)};this.events.push(s)}return i.id}unsubscribe(t,e){let s=this.getEventRecByType(t);if(s){let t=-1;for(t=0;t<s.eventCallbacks.length;t++){if(s.eventCallbacks[t].id===e){break}}if(t>=0){s.eventCallbacks.splice(t,1)}}}fire(t,e,s=0,i=false){if(this.silentMode&&!i){return}let n=this.getEventRecByType(t);if(n){const i={type:t,source:this.source,data:e};let r=()=>{for(let t of n.eventCallbacks){t.callback(i)}};if(s>0){setTimeout(r,s)}else{r()}}}enterSilentMode(){this.silentMode++}exitSilentMode(){if(this.silentMode){this.silentMode--}}isSilent(){return this.silentMode>0}getEventRecByType(t){for(let e of this.events){if(e.type==t){return e}}return null}}var x;(function(t){function e(t,e){let s=t;if(e){for(let t in e){const i=new RegExp("{{"+t+"}}","g");s=s.replace(i,e[t])}}return s}t.renderLiquidTemplate=e})(x||(x={}));a.resetLocales();if(typeof Object.values!=="function"){Object.values=function(t){return Object.keys(t).map((e=>t[e]))}}if(typeof Math.trunc!=="function"){Math.trunc=function(t){if(isNaN(t)){return NaN}if(t>0){return Math.floor(t)}return Math.ceil(t)}}class k{constructor(t){this.start(t)}start(t){this.formatStr=t;this.pos=0;this.exprNum=0;this.tokenText=""}skipSpaces(){while(this.pos<this.formatStr.length&&this.formatStr.charAt(this.pos)===" ")this.pos++}next(){this.skipSpaces();if(this.pos>=this.formatStr.length)return false;var t=0;if(this.formatStr.charAt(this.pos)==="{"){t=this.formatStr.indexOf("}",this.pos);if(t<0)return false;this.tokenText=this.formatStr.substring(this.pos,t+1);if(this.tokenText.indexOf("{expr")===0){this.token="expression";this.exprNum=parseInt(this.tokenText.substring(5,this.tokenText.length))}this.pos=t+1}else if(this.formatStr.charAt(this.pos)==="["&&this.pos<this.formatStr.length-1&&this.formatStr.charAt(this.pos+1)==="["){this.pos+=2;t=this.formatStr.indexOf("]]",this.pos);this.token="operator";this.tokenText=this.formatStr.substring(this.pos,t);this.pos=t+2}else{this.token="text";var e=this.formatStr.indexOf("{",this.pos);if(e<0)e=this.formatStr.length;var s=this.formatStr.indexOf("[[",this.pos);if(s<0)s=this.formatStr.length;t=Math.min(e,s);this.tokenText=this.formatStr.substring(this.pos,t).trim();this.pos=t}return true}getToken(){return{type:this.token,text:this.tokenText,index:this.exprNum-1}}parse(){let t=[];while(this.next()){t.push(this.getToken())}return t}}var $;(function(t){t[t["None"]=0]="None";t[t["Any"]=1]="Any";t[t["NotAll"]=2]="NotAll";t[t["All"]=3]="All"})($||($={}));var T;(function(e){function s(t,e){let s=t;if(s!=null&&s.length>0){if(s.charAt(s.length-1)!="/")s+="/";s+=e}else{s=e}return s}e.combinePath=s;function i(t){if(t=="All"){return $.All}else if(t=="NotAll"){return $.NotAll}else if(t=="Any"){return $.Any}else{return $.None}}e.strToLinkType=i;function n(t){if(t===$.All){return"All"}else if(t===$.NotAll){return"NotAll"}else if(t==$.Any){return"Any"}else{return"None"}}e.linkTypeToStr=n;function r(t){let e=a.getText("Operators",t.id,"format");if(!e){e=a.getText("Operators",t.id,"displayFormat")}if(!e){e=t.displayFormat}const s=new k(e);return s.parse()}e.parseOperatorFormat=r;function h(e,s,i){switch(i){case t.String:return e;case t.Word:let s=parseInt(e);return isNaN(s)?"":s.toString();case t.Float:let i=parseFloat(e);return isNaN(i)?"":i.toString();default:return""}}e.convertValue=h})(T||(T={}));class S{constructor(){this.id="";this.caption="";this.sqlExpr="";this.displayFormat="";this.appliedTypes=[]}loadFromData(t){if(t){this.id=t.id;this.caption=t.cptn;this.displayFormat=t.fmt;this.sqlExpr=t.expr;this.appliedTypes=t.dtypes||this.appliedTypes}}getAppliedTypesOrDefault(){if(this.appliedTypes.length>0)return this.appliedTypes;if(this.id==="SUM"||this.id==="AVG"){return[t.Autoinc,t.Byte,t.Currency,t.Float,t.Int32,t.Int64,t.Word]}else if(this.id==="MIN"||this.id==="MAX"){return[t.Autoinc,t.BCD,t.Byte,t.Currency,t.Date,t.DateTime,t.Time,t.Float,t.Int32,t.Int64,t.Word]}return r.getAllDataTypes()}}class E extends f{constructor(){super()}loadFromData(t){super.loadFromData(t);if(t){if(t.sql){this.statement=t.sql}if(t.extraParams){this.extraParams=t.extraParams}}}}var D;(function(t){t[t["Scalar"]=0]="Scalar";t[t["Const"]=1]="Const";t[t["Attribute"]=2]="Attribute";t[t["List"]=4]="List";t[t["Query"]=5]="Query";t[t["ParentColumn"]=6]="ParentColumn"})(D||(D={}));class A{constructor(){this.id="";this.expr="";this.constValueFormat="{const}";this.caption="{Unrecognized operator}";this.displayFormat="{expr1} [[{unrecognized operator}]] {expr2}";this.isRange=false;this.caseIns=false;this.paramCount=2;this.defaultOperand=new I;this.appliedTypes=[];this.operands=new Array}loadFromData(t,e){if(e){this.id=e.id;this.caption=e.cptn;this.caseIns=e.caseIns;this.isRange=e.isRange;this.displayFormat=e.fmt;this.paramCount=e.pcnt;this.expr=e.expr;this.appliedTypes=e.dtypes||this.appliedTypes;if(e.defOperand){this.defaultOperand.loadFromData(t,e.defOperand)}if(e.editor){this.defaultOperand.editor=t.getEditorById(e.editor)||new E}if(e.operands){for(let s=0;s<e.operands.length;s++){let i=new I;i.loadFromData(t,e.operands[s]);if(e.editor){i.editor=t.getEditorById(e.editor)||new E}this.operands.push(i)}}}}}class I{constructor(){this.kind=D.Scalar;this.dataType=t.Unknown;this.editor=new E;this.defValue=""}loadFromData(t,e){this.kind=e.kind;this.dataType=e.dtype;this.defValue=e.val;this.defText=e.txt;if(e.editor){this.editor=t.getEditorById(e.editor)||new E}}copyFrom(t){r.assign(this,t)}}class M extends u{constructor(t){super(t);this.useInConditions=false;this.useInResult=false;this.useInSorting=false}loadFromData(t,e){super.loadFromData(t,e);if(e){this.useInConditions=e.uic;this.useInResult=e.uir;this.useInSorting=e.uis}}scan(t,e){super.scan(((e,s)=>t&&t(e,s)),((t,s)=>e&&e(t,s)))}}class B extends c{constructor(t){super(t);this.params=[];this.useInConditions=true;this.useInResult=true;this.useInSorting=true;this.defaultOperator="";this.operators=new Array;this.lookupAttr="";this.expr=""}loadFromData(t,e){super.loadFromData(t,e);if(e){this.useInConditions=e.uic;this.useInResult=e.uir;this.useInSorting=e.uis;this.expr=e.sql;this.defaultOperator=e.defOperator;this.operators=e.ops;if(e.udata)this.userData=e.udata}}}const F=Object.assign(Object.assign({},s),{SqlList:"SQLLIST",SubQuery:"SUBQUERY",BindToParentColumn:"BINDTOPARENTCOLUMN"});class N extends d{constructor(){super();this.mainEntity=null;this.nullAttribute=new B(null);this.nullOperator=new A;this.operators=new Array;this.rootEntity=new M;this.aggrFunctions=new Array;this.dateMacros=["Today","Yesterday","Tomorrow","FirstDayOfMonth","LastDayOfMonth","FirstDayOfWeek","FirstDayOfYear","FirstDayOfNextWeek","FirstDayOfPrevMonth","FirstDayOfNextMonth","FirstDayOfNextYear","FirstDayOfPrevYear","FirstDayOfPrevWeek"];this.timeMacros=["Now","HourStart","Midnight","Noon"];this.links=[]}getMainEntity(){return this.mainEntity}loadFromJSON(t){let e=JSON.parse(t);this.loadFromData(e)}loadFromData(t){super.loadFromData(t);this.operators=new Array;if(t.operators){for(let e=0;e<t.operators.length;e++){let s=new A;s.loadFromData(this,t.operators[e]);this.operators.push(s)}}this.rootEntity.loadFromData(this,t.entroot);this.aggrFunctions=new Array;if(t.aggrfuncs){for(let e=0;e<t.aggrfuncs.length;e++){let s=new S;s.loadFromData(t.aggrfuncs[e]);this.aggrFunctions.push(s)}}}getObject(){return this}setData(t){if(typeof t==="string"){this.loadFromJSON(t)}else{this.loadFromData(t)}}createEntity(t){return new M(t)}createEntityAttr(t){return new B(t)}createValueEditor(){return new E}getRootEntity(){return this.rootEntity}getEditorById(t){return super.getEditorById(t)}getAttributeById(t){let e=this.getEntityAttrById(this.getRootEntity(),t);if(!e){return null}return e}getAttributeByIdSafe(t){const e=this.getAttributeById(t);if(!e)return this.nullAttribute;return e}checkAttrProperty(t,e){let s=this.getAttributeById(t);if(s){if(typeof s[e]==="undefined"){throw"No such property: "+e}if(s[e]){return true}else if(s.lookupAttr){t=s.lookupAttr;s=this.getAttributeById(t);return s&&s[e]}else{return false}}else return false}getEntityAttrById(t,e){return super.getEntityAttrById(t,e)}_listByEntityWithFilter(t,e){let s=new Array;let i;let n=null;if(t.subEntities){let h=t.subEntities.length;for(let o=0;o<h;o++){n=t.subEntities[o];if(!e||e(n,null)){i=a.getText("Entities",n.name);if(!i){i=n.caption}let t=r.assign(new M,{id:n.name,text:i,items:[],isEntity:true});t.items=this._listByEntityWithFilter(n,e);if(t.items.length>0)s.push(t)}}}let h=null;if(t.attributes){let n=t.attributes.length;for(let o=0;o<n;o++){h=t.attributes[o];if(!e||e(t,h)){i=a.getText("Attributes",h.id);if(!i)i=h.caption;let t=r.assign(new M,{id:h.id,text:i,dataType:h.dataType});s.push(t)}}}return s}_listByEntity(t,e,s){e=e||{};let i=[];let n=[];let h;let o=null;if(t.subEntities){let n=t.subEntities.length;for(let l=0;l<n;l++){o=t.subEntities[l];if(!s||s(o,null)){if(e.addUIC!==false&&o.useInConditions!==false||e.addUIR!==false&&o.useInResult!==false||e.addUIS!==false&&o.useInSorting!==false){h=a.getText("Entities",o.name)||o.caption;let t=r.assign(new M,{id:o.name,text:h,items:[],isEntity:true,description:o.description});let n=r.assign({},e);n.includeRootData=false;t.items=this._listByEntity(o,n,s);if(t.items.length>0){i.push(t)}}}}}let l=null;if(t.attributes){let i=t.attributes.length;for(let o=0;o<i;o++){l=t.attributes[o];if(!s||s(t,l)){if(e.addUIC!==false&&l.useInConditions!==false||e.addUIR!==false&&l.useInResult!==false||e.addUIS!==false&&l.useInSorting!==false){h=a.getText("Attributes",l.id)||l.caption;n.push(r.assign(new B(t),{id:l.id,text:h,dataType:l.dataType,lookupAttr:l.lookupAttr,description:l.description}))}}}}let u=(t,e)=>{if(t.text.toLowerCase()==e.text.toLowerCase()){return 0}if(t.text.toLowerCase()>e.text.toLowerCase()){return 1}return-1};if(e.sortEntities){i.sort(u);n.sort(u)}let c;if(!e.attrPlacement||e.attrPlacement==0){c=i.concat(n)}else{c=n.concat(i)}if(e.attrPlacement==2){c.sort(u)}if(e.includeRootData){h=a.getText("Entities",t.name);if(!h)h=t.caption;return{id:t.name,text:h,items:c}}else{return c}}clear(){super.clear();this.operators=[];this.aggrFunctions=[]}addOrUpdateOperator(t){let e=r.findItemById(this.operators,t.id);if(!e){e=new A;e.id=t.id;this.operators.push(e)}e.caption=t.caption;e.expr=t.expr||"";e.displayFormat=t.format;e.defaultOperand=new I;e.defaultOperand.kind=t.kind||D.Scalar;if(t.appliedTypes)e.appliedTypes=t.appliedTypes;if(t.paramCount>0){e.paramCount=t.paramCount}this.runThroughEntities(((t,s)=>{if(t.operators.indexOf(e.id)<0&&e.appliedTypes.indexOf(t.dataType)>=0){t.operators.push(e.id)}}));return e}removeOperator(t,e=false){let s=r.findItemById(this.operators,t);if(s){if(!e)r.removeArrayItem(this.operators,s);this.runThroughEntities(((t,e)=>{r.removeArrayItem(t.operators,s.id)}))}}getOperatorIdsByDataType(e){switch(e){case t.String:case t.Memo:return"StartsWith,EndsWith,Contains,Equal,InList,NotStartsWith,NotEndsWith,NotContains,NotEqual,NotInList,IsNull,IsNotNull".split(",");case t.Guid:return"Equal,NotEqual".split(",");case t.Date:case t.DateTime:return"DateWithinToday,DateWithinThisWeek,DateWithinPrevWeek,DateWithinThisMonth,DateWithinPrevMonth,DateWithinThisYear,DateWithinPrevYear,DateBeforePrecise,DateAfterPrecise,DatePeriodPrecise,IsNull,IsNotNull".split(",");case t.Time:return"TimeBeforePrecise,TimeAfterPrecise,TimePeriodPrecise,IsNull,IsNotNull".split(",");case t.Byte:case t.Word:case t.Int32:case t.Int64:case t.Float:case t.Currency:case t.BCD:case t.Autoinc:case t.Unknown:return"Equal,Between,LessThan,LessOrEqual,GreaterThan,GreaterOrEqual,InList,NotEqual,NotBetween,NotInList,IsNull,IsNotNull".split(",");case t.Bool:return"IsTrue,NotTrue".split(",");default:const s=[];for(let t of this.operators)if(t.appliedTypes.indexOf(e)>=0)s.push(t.id);return s}}findAggrFunctionById(t){for(const e of this.aggrFunctions){if(e.id===t)return e}return null}findLink(t,e){for(let s of this.links){if(s.entityFrom==t&&s.entityTo==e)return s}return null}getLinksByEntity(t){const e=[];for(let s of this.links){if(s.entityFrom==t||s.entityTo==t){e.push(s)}}return e}getEntitiesTree(t,e){return this._listByEntity(this.getRootEntity(),t,e)}getEntitiesTreeWithFilter(t){return this._listByEntityWithFilter(this.getRootEntity(),t)}getFullEntityPathByAttr(t,e){e=e||" ";return this.getEntityPathByAttr(this.getRootEntity(),t,e,true)}getEntityPathByAttr(t,e,s,i){return super.getEntityPathByAttr(t,e,s,i)}getAttributeText(t,e){return super.getAttributeText(t,e)}getFirstUICAttr(){return this.getFirstUICAttrInEntity(this.getRootEntity())}getFirstUICAttrInEntity(t){if(t.useInConditions!==false){if(t.attributes){let e=t.attributes.length;for(let s=0;s<e;s++){if(t.attributes[s].useInConditions){return t.attributes[s]}}}if(t.subEntities){let e=t.subEntities.length;for(let s=0;s<e;s++){let e=this.getFirstUICAttrInEntity(t.subEntities[s]);if(e){return e}}}}return null}runThroughEntities(t,e){this.getRootEntity().scan(t,e)}getFirstAttributeByFilter(t){let e=null;this.runThroughEntities((function(s,i){if(t(s)){i.stop=true;e=s}}),null);return e}findOperatorById(t){if(this.operators.length>0){let e=this.operators.length;for(let s=0;s<e;s++){if(this.operators[s].id==t){return this.operators[s]}}}return null}getOperatorById(t){let e=this.findOperatorById(t);if(!e)return this.nullOperator;return e}getDefaultOperatorIdForAttr(t){if(t.defaultOperator){return t.defaultOperator}else if(t.operators.length>0){return t.operators[0]}else{return this.nullOperator.id}}getAggrFunctionCaption(t){let e=a.getText("AggregateFunctions",t);let s=e?e.caption:a.getText("Aggr"+t.replace(" ","")+"_Caption");if(s){return s}let i=r.findItemById(this.aggrFunctions,t);if(!i||!i.caption)return t;return i.caption}getAggrFunctionFormat(t){let e=a.getText("AggregateFunctions",t);let s=e?e.displayFormat:a.getText("Aggr"+t.replace(" ","")+"_Format");if(s){return s}let i=r.findItemById(this.aggrFunctions,t);if(!i||!i.displayFormat)return"";return i.displayFormat}getDefaultOperatorForAttr(t){let e=this.getDefaultOperatorIdForAttr(t);return this.getOperatorById(e)}getOperand(e,s,i){let n=new I;if(s&&s.defaultOperand){n.copyFrom(s.defaultOperand);if(!n.defValue){n.defValue=""}if(!n.defText){n.defText=""}}else{n.kind=D.Scalar;n.dataType=e.dataType;n.defValue="";n.defText="";n.editor=null}let h=n;if(h.dataType===t.Unknown&&e){h.dataType=e.dataType}if(s&&i>=0){if(s.operands&&s.operands[i-1]){h=r.assign(h,s.operands[i-1])}}if(!h.editor){if(n.editor){h.editor=n.editor}else if(n.kind===D.Query){h.editor.tag=F.SubQuery}else if(e&&e.defaultEditor){h.editor=e.defaultEditor}else if(h.dataType===t.Date||h.dataType===t.DateTime||h.dataType===t.Time){h.editor.tag=F.DateTime}else{h.editor.tag=F.Edit}}return h}getAggrFunctions(){return this.aggrFunctions}isDateMacro(t,e){const s=t.match(/\${{?(.*?)}?}/);if(s!=null){const t=s[1];if(r.indexOfArrayItem(this.dateMacros,t)>=0){if(e){e(t)}return true}}return false}isTimeMacro(t,e){const s=t.match(/\${{?(.*?)}?}/);if(s!=null){const t=s[1];if(r.indexOfArrayItem(this.timeMacros,t)>=0){if(e){e(t)}return true}}return false}getDateMacroValue(t){let e=new Date;const s=this.isDateMacro(t,(t=>{switch(t){case"Today":break;case"Yesterday":e.setDate(e.getDate()-1);break;case"Tomorrow":e.setDate(e.getDate()+1);break;case"FirstDayOfMonth":e.setDate(1);break;case"LastDayOfMonth":e.setMonth(e.getMonth()+1,0);break;case"FirstDayOfPrevWeek":var s=e.getDay();s=s==0?1:8-s;e.setDate(e.getDate()-s);break;case"FirstDayOfWeek":var s=e.getDay();s=s==0?6:s-1;e.setDate(e.getDate()-s);break;case"FirstDayOfYear":e.setMonth(0,1);break;case"FirstDayOfNextWeek":var s=e.getDay();s=s==0?1:8-s;e.setDate(e.getDate()+s);break;case"FirstDayOfNextMonth":e.setMonth(e.getMonth()+1,1);break;case"FirstDayOfPrevMonth":e.setMonth(e.getMonth()-1,1);break;case"FirstDayOfPrevYear":e.setFullYear(e.getFullYear()-1,0,1);break;case"FirstDayOfNextYear":e.setFullYear(e.getFullYear()+1,0,1);break}}));return s?e:null}getDateOrMacroValue(t){let e=this.getDateMacroValue(t);return e?e:t}getTimeMacroValue(t){let e=new Date;const s=this.isDateMacro(t,(t=>{switch(t){case"Now":break;case"HourStart":e.setMinutes(0,0,0);break;case"Midnight":e.setHours(0,0,0,0);break;case"Noon":e.setHours(12,0,0,0);break}}));return s?e:null}getTimeOrMacroValue(t){var e=this.getTimeMacroValue(t);return e?e:t}getAllDateMacros(){return this.dateMacros}getAllTimeMacros(){return this.timeMacros}}var L;(function(t){t[t["Unknown"]=0]="Unknown";t[t["Constant"]=1]="Constant";t[t["EntityAttribute"]=2]="EntityAttribute";t[t["ParentEntityAttribute"]=3]="ParentEntityAttribute";t[t["AggregateFunction"]=4]="AggregateFunction";t[t["ParentColumn"]=5]="ParentColumn";t[t["Query"]=11]="Query";t[t["CustomSql"]=21]="CustomSql"})(L||(L={}));class R{constructor(e){this.parent=e;this.tag=L.Constant;this.kind=D.Scalar;this.dataType=t.Unknown;this._value="";this.distinct=false;this._isDefaultValue=false;this.getText=()=>this.text||this._value;this.args=new Array}getParent(){return this.parent}getModel(){return this.parent.getQuery().getModel()}loadFromData(t,e){if(e){this.tag=e.tag;if(e.val){this._value=e.val;this.text=e.txt}else if(e.id){this.kind=D.Attribute;this._value=e.id;this.text=e.txt}if(typeof e.dtype!=="undefined"){this.dataType=e.dtype}if(this.tag==L.EntityAttribute||this.tag==L.ParentEntityAttribute){this.kind=D.Attribute}else{if(typeof e.kind!=="undefined"){this.kind=e.kind}if(e.query){this.subQuery=this.parent.getQuery().createSubQuery();this.subQuery.loadFromDataOrJson(e.query)}if(typeof e.distinct!=="undefined"){this.distinct=e.distinct}if(e.func){this.func=e.func;if(e.args){for(let s=0;s<e.args.length;s++){const i=new R(this.parent);i.loadFromData(t,e.args[s]);this.args.push(i)}}}if(e.sql){this.sql=e.sql;this.baseAttrId=e.baseAttrId}}}}saveToData(){let t={tag:this.tag};t.dtype=this.dataType;if(this.tag==L.EntityAttribute||this.tag==L.ParentEntityAttribute){if(this._value){t.id=this._value;t.val=this._value}if(this.text){t.txt=this.text}}else{if(this.subQuery){t.query=this.subQuery.toJSONData()}if(typeof this.kind!=="undefined"){t.kind=this.kind}if(this._value){t.val=this._value}if(this.text){t.txt=this.text}if(this.distinct){t.distinct=this.distinct}if(this.func){t.func=this.func;t.args=[];for(let e=0;e<this.args.length;e++){t.args.push(this.args[e].saveToData())}}if(this.sql){t.sql=this.sql;t.baseAttrId=this.baseAttrId}}return t}getIndex(){return this.parent.getExpressionIndex(this)}get value(){return this._value}setValue(t,e=false){this.setContent(t,undefined,e)}setContent(t,e,s=false){let i=this.value;if(this.kind==D.Attribute&&t){const e=this.getModel().getAttributeById(t);if(!e){throw"No such entity attribute:"+t}this.dataType=e.dataType}this._value=t;if(typeof e!=="undefined"){this.text=e}else if(typeof this.text!=="undefined"){this.text=t}this._isDefaultValue=false;if(!s){this.parent.expressionChanged(this,i)}}isEmpty(){return!(this.text||this._value)}hasText(){return this.text&&this.text.length>0}tryCopyValueFrom(t){if(this.kind==t.kind){if(this.dataType==t.dataType){this.setContent(t.value.length?t.value:this._value,t.text&&t.text.length?t.text:this.text,true)}else{const e=T.convertValue(t.value,t.dataType,this.dataType);this.setContent(e.length?e:this._value,t.text&&t.text.length?t.text:this.text,true)}this.subQuery=t.subQuery;this.sql=t.sql;this.baseAttrId=t.baseAttrId}else if(!this._isDefaultValue){this.setContent("","",true);this.subQuery=null;this.sql=null;this.baseAttrId=null}}}var P;(function(t){t[t["Conditions"]=1]="Conditions";t[t["Columns"]=2]="Columns";t[t["SortingColumns"]=4]="SortingColumns";t[t["Properties"]=32]="Properties";t[t["ExtraData"]=64]="ExtraData";t[t["Facets"]=128]="Facets";t[t["Aggregation"]=256]="Aggregation";t[t["All"]=511]="All"})(P||(P={}));var O;(function(t){t[t["Add"]=1]="Add";t[t["Modify"]=2]="Modify";t[t["Delete"]=4]="Delete";t[t["Activate"]=8]="Activate";t[t["All"]=127]="All"})(O||(O={}));var Q;(function(t){t[t["None"]=0]="None";t[t["Ascending"]=1]="Ascending";t[t["Descending"]=2]="Descending"})(Q||(Q={}));class q{get id(){return this._id}get sorting(){if(this.query){return this.query.getColumnSorting(this)}else{return this._sorting}}set sorting(t){if(this.query){this.query.setColumnSorting(this,t)}else{this._sorting=t}}get sortIndex(){if(this.query){return this.query.getColumnSortIndex(this)}else{return this._sortIndex}}set sortIndex(t){if(this.query){this.query.setColumnSortIndex(this,t)}else{this._sortIndex=t}}constructor(t,e=false){this.query=t;this.justsorted=e;this.enabled=true;this.params=[];this._isHidden=false;this.query=t;this._id=r.generateId("col");this.caption="";this._sorting=Q.None;this._sortIndex=-1;this.expr=new R(this);this.blockId="";this.justsorted=e}getModel(){return this.query.getModel()}getQuery(){return this.query}isReadOnly(){return false}isJustSorted(){return this.justsorted}setReadOnly(t){}isHidden(){return this._isHidden}setHidden(t){this._isHidden=t}getDataType(){if(this.expr.dataType===t.Unknown){let e=null;if(this.expr.func){if(this.expr.func=="COUNT"||this.expr.func=="CNTDST")return t.Int64;e=this.expr.args[0].value}else{e=this.expr.value}const s=this.query.getModel().getAttributeById(e);if(s)return s.dataType}return this.expr.dataType}loadFromData(t,e){if(e){if(e.id){this._id=e.id}this.caption=e.cptn;if(typeof e.srt!=="undefined"){this._sorting=e.srt;this._sortIndex=typeof e.srtidx!=="undefined"?e.srtidx:-1}if(e.enabled===false){this.enabled=e.enabled}this.expr.loadFromData(t,e.expr);this.blockId=e.blockId;this.displayFormat=e.dfmt;this.groupFooterColumnTemlate=e.gfct;if(e.hidden){this.setHidden(true)}}}saveToData(){let t={};t.id=this._id;if(typeof this.caption!=="undefined"){t.cptn=this.caption}if(this.sorting!=Q.None){t.srt=this.sorting;t.srtidx=this.sortIndex}t.expr=this.expr.saveToData();if(this.blockId){t.blockId=this.blockId}if(this.enabled===false){t.enabled=this.enabled}t.dfmt=this.displayFormat;t.gfct=this.groupFooterColumnTemlate;if(this.isHidden()){t.hidden=true}return t}fireChangedEvent(){this.query.fireChangedEvent({part:this.justsorted?P.SortingColumns:P.Columns,action:O.Modify,changee:this})}getExpressionIndex(t){return 0}expressionChanged(t,e){}}var j;(function(t){t[t["Unknown"]=0]="Unknown";t[t["Simple"]=1]="Simple";t[t["Group"]=51]="Group"})(j||(j={}));var _;(function(t){t[t["EntityAttr"]=2]="EntityAttr";t[t["Operator"]=4]="Operator";t[t["Value"]=8]="Value";t[t["All"]=14]="All"})(_||(_={}));class G{get id(){return this._id}get enabled(){return this._enabled&&(!this.getParent()||this.getParent().enabled)}set enabled(t){this._enabled=t&&(!this.getParent()||this.getParent().enabled);this.conditions&&this.conditions.forEach((e=>{e.enabled=t}))}constructor(t,e){this.query=t;this.linkType=$.All;this.parent=null;this._id=r.generateId("cond");this.justAdded=false;this.tag=e||j.Unknown;this.enabled=true;this.operatorId="";this.blockId="";this.expressions=new Array;this.conditions=new Array}getQuery(){return this.query}getModel(){return this.query.getModel()}getParent(){return this.parent}setParent(t){this.parent=t}getConditions(){return this.conditions}isEmpty(){return this.conditions.length===0}isGroup(){return this.tag==j.Group||this.parent==null}getLevel(){const t=this.getParent();return t?t.getLevel()+1:0}isReadOnly(){return false}setReadOnly(t){}isParameterized(){return false}setParameterized(t){}isInJoin(){return false}setInJoin(t){}clearConditions(){this.conditions=[]}addCondition(t){t.setParent(this);return this.conditions.push(t)}removeConditionAt(t){this.conditions.splice(t,1)}loadFromData(t,e){if(e){this.tag=e.tag;if(!this.tag){this.tag=!this.parent||this.conditions.length>0?j.Group:j.Simple}if(typeof e.enabled!=="undefined"){this.enabled=e.enabled}if(typeof e.disabled!=="undefined"){this.enabled=!e.disabled}if(this.tag==j.Simple){this.operatorId=e.op;if(e.exprs){for(let s=0;s<e.exprs.length;s++){let i=new R(this);i.loadFromData(t,e.exprs[s]);this.expressions.push(i)}}}this.linkType=e.linking}}saveToData(){let t={};t.tag=this.tag;if(!this.enabled){t.enabled=this.enabled}if(this.tag==j.Simple){t.op=this.operatorId;t.exprs=[];for(let e=0;e<this.expressions.length;e++){t.exprs.push(this.expressions[e].saveToData())}}if(this.tag==j.Group){t.linking=this.linkType}return t}fireChangedEvent(t=_.All){this.query.fireChangedEvent({part:P.Conditions,action:O.Modify,changee:this,condPart:t})}getExpressionIndex(t){return this.expressions.indexOf(t,0)}expressionChanged(t,e){if(t.getIndex()==0&&t.tag==L.EntityAttribute){this.tuneOperatorForAttr(t.value)}}getOperatorId(){return this.operatorId}setOperatorId(t,e=false){const s=this.operatorId;this.operatorId=t;if(!e){const e=this.getModel();const i=e.getOperatorById(t);const n=this.expressions[0].value;const r=e.getAttributeById(n);this.tuneValueExpressions(r,i,r.id,s)}}tuneOperatorForAttr(t){const e=this.getModel();const s=this.expressions[0].value;const i=e.getAttributeById(s);if(i!=null){let e=this.getModel().getDefaultOperatorForAttr(i);let s=this.operatorId;this.operatorId=e.id;this.tuneValueExpressions(i,e,t,s)}}tuneValueExpressions(e,i,n,r){const h=this.getModel();if(!i)return;let o=this.expressions.length;n?h.getAttributeById(n):null;let l=null;if(r){l=h.getOperatorById(r)}if(l&&l.paramCount==i.paramCount){let n=1;while(n<i.paramCount){let r=h.getOperand(e,l,n);let f=h.getOperand(e,i,n);if(f.dataType==t.Unknown){f.dataType=e.dataType}const d=f.editor&&f.editor.tag!==s.Unknown?f.editor:e.defaultEditor&&e.defaultEditor.tag!==s.Unknown?e.defaultEditor:new E;if(n>=o){var a=this.createValueExpr(f);this.expressions.push(a)}else{var u=this.expressions[n];var c=this.createValueExpr(f);if(this.areCompitableEditors(r.editor,d)){c.tryCopyValueFrom(u)}this.expressions[n]=c}n++}if(o>n){this.expressions.splice(n,o-n)}}else{this.expressions.splice(1,this.expressions.length-1);for(let s=1;s<i.paramCount;s++){let n=h.getOperand(e,i,s);if(n.dataType==t.Unknown){n.dataType=e.dataType}var a=this.createValueExpr(n);this.expressions.push(a)}}}areCompitableEditors(t,e){if(e.tag!=t.tag)return false;if(e.resType!=t.resType)return false;return true}addExpressionByOperand(t,e=null){let s=this.createValueExpr(t,e);this.expressions.push(s);return s}createValueExpr(t,e=null){let s=e===null||typeof e==="undefined";let i=e?e:t.defValue;let n=e?e:t.defText;let r=new R(this);if(t.kind===D.Query){r.tag=L.Query;r.dataType=t.dataType;r.kind=t.kind;r.setContent(i,n,true)}else if(t.kind===D.Attribute){if(!s){let e=this.getModel().getFirstAttributeByFilter((e=>e.useInConditions==true&&(!t.dataType||e.dataType==t.dataType)));i=e?e.id:null}r.tag=L.EntityAttribute;r.kind=t.kind;r.dataType=t.dataType;r.setContent(i,n,true)}else{if(s){if(t.defValue&&t.defValue!=""){i=t.defValue}else{if(t.editor&&t.editor.defValue){i=t.editor.defValue}else{i=""}}if(t.editor){n=t.editor.getValueText(i)}}r.tag=L.Constant;r.dataType=t.dataType;r.kind=t.kind;r.setContent(i,n,true);r._isDefaultValue=s}return r}}class H{constructor(t=null){this.childs=[];this.value=null;this.parent=null;if(t){if(Array.isArray(t)){this.value=t[0];if(t.length>1){this.addChild(new H(t.slice(1)))}}else if(t instanceof H){this.value=t.value;this.childs=t.childs}else{this.value=t}}}contains(t){if(this.value===t)return true;for(let e of this.childs){if(e.contains(t))return true}return false}findNode(t){if(this.value===t)return this;for(let e of this.childs){let s=e.findNode(t);if(s)return s}return null}addChild(t){t.parent=this;this.childs.push(t)}setParents(){for(let t of this.childs){t.parent=this;t.setParents()}}}class W extends Error{constructor(t){super(t);if(typeof Error["captureStackTrace"]==="function"){Error["captureStackTrace"].apply(this,[W])}this.name="InvalidQueryError"}}class U{isModified(){return this._isModified}resetModified(){this._isModified=false}get enableAggregation(){return this._enableAggregation}set enableAggregation(t){const e=this._enableAggregation;this._enableAggregation=t;if(!e&&t){this.processQueryForAggregation();this.columns.filter((t=>t.enabled&&t.expr.tag==L.AggregateFunction))}if(!this._enableAggregation){this.aggrSettings.clear()}}constructor(t,e,s){this.extraData={};this.innerData={};this.isNewbie=true;this._isModified=false;this._enableAggregation=false;this.parentQuery=null;this.drillDowns=[];this.syncSortOrderWithColumnsOrder=true;if(s){this.context=s.context;if(this.context){this.syncSortOrderWithColumnsOrder=this.context.options.syncSortOrderWithColumnsOrder}}this.eventEmitter=new C(this);this.root=new G(this,j.Group);this.extraConditions=new G(this,j.Group);this.columns=new Array;this.sortedColumns=new Array;if(!this.id){this.regenerateId()}this.setDefaultName();this.description="";this.model=t?t:new N;if(e){this.loadFromData(e)}this.attributeExprTag=s?s.attrTag||L.EntityAttribute:L.EntityAttribute;this.clientListRequestHandler=s?s.clientListRequestHandler:new Array;this.serverListRequestHandler=s?s.serverListRequestHandler:new Array;this.timezoneOffset=(new Date).getTimezoneOffset();this.aggrSettings=new m(this);if(s){this.parentQuery=s.parent}this.addChangedCallback((t=>{if(t.data&&(t.data.part&P.Columns)>0&&!t.data.aggregation){if(this._enableAggregation&&this.updateAggregationSettings()){this.fireChangedEvent({part:P.Aggregation})}}}))}updateAggregationSettings(){let t=false;const e=this.getAggregationSettings();for(let s=e.groups.length-1;s>=0;s--){const i=e.groups[s];for(let e=i.columns.length-1;e>=0;e--){const s=i.columns[e];if(!this.columns.find((t=>t.id===s))){i.columns.splice(e,1);t=true}}if(i.columns.length==0){e.groups.splice(s,1)}}const s=e.getAggregates();for(let e=s.length-1;e>=0;e--){const i=s[e];if(!this.columns.find((t=>t.id===i.colId))){s.splice(e,1);t=true}}return t}createSubQuery(){return new U(this.model,null,{parent:this,context:this.context})}useAggregation(t,e=false){this.aggrSettings.clear();t(this.aggrSettings);if(this.enableAggregation){this.processQueryForAggregation(e)}else if(!e){console.warn("Aggregation is turned off. Turn it on with query.enableAggregation = true");return}}useDefaultAggregation(){this._enableAggregation=true;this.useAggregation((e=>{const s=this.columns.filter((t=>t.enabled&&t.expr.tag==L.AggregateFunction));if(s.length){const t=this.columns.filter((t=>t.enabled&&t.expr.tag==L.EntityAttribute));const i=[];for(const t of s){i.push({id:t.id,func:t.expr.func});this.changeColumnType(t,L.EntityAttribute)}for(const t of i){e.addAggregateColumn(t.id,t.func)}for(const s of t){e.addGroup({columns:[s.id],name:s.caption})}e.addGrandTotals();this.fireChangedEvent({part:P.Columns,wasModified:false})}else{const s=this.getColumns().filter((e=>e.enabled&&e.expr.tag==L.EntityAttribute&&this.model.getAttributeById(e.expr.value).dataType===t.Currency))[0];const i=this.getColumns().filter((e=>e.enabled&&e.expr.tag==L.EntityAttribute&&this.model.getAttributeById(e.expr.value).dataType===t.String))[0];if(!s&&!e.hasAggregates()||!i)return;e.addGrandTotals().addAggregateColumn(s.id,"SUM").addGroup({columns:[i.id],name:"Default"})}}))}processQueryForAggregation(t=false){const e=this.getAggregationSettings();const s=e.getGroups();if(s.length>0){const e=s[s.length-1].columns;let i=[];let n=[];for(const t of this.getColumns()){if(e.indexOf(t.id)>=0){i.push(t)}else if(this.getColumnSorting(t)!=Q.None){n.push(t)}}let r=0;i.forEach((t=>{if(this.getColumnSorting(t)==Q.None){this.setColumnSorting(t,Q.Ascending)}this.setColumnSortIndex(t,r++)}));n.forEach((t=>{this.setColumnSortIndex(t,r++)}));if(!t){this.fireChangedEvent({part:P.Columns,aggregation:true,wasModified:false})}}}getAggregationSettings(){return this.aggrSettings}getColumnIds(t,e){e=e||t;return this.columns.slice(t,e-t+1).map((t=>t.id))}validateColumns(t){const e=this.columns.filter((t=>t.enabled)).map((t=>t.id));let s=-1;for(const i of t){const t=e.indexOf(i);if(t<0)return false;if(s>t)return false;s=t}return true}validateAggregate(t,e){const s=this.columns.filter((e=>e.enabled&&e.id===t))[0];const i=this.model.findAggrFunctionById(e);if(!i||!s||i.appliedTypes.indexOf(s.expr.dataType)<0)return false;return true}isEx(){return false}reset(t=true){if(t){this.clear()}this.regenerateId();this.setDefaultName();this._isModified=false;this.isNewbie=true}hasEnabledAggrColumns(){return this.columns.filter((t=>t.enabled&&t.expr.tag===L.AggregateFunction)).length>0}setDefaultName(){this.setName(a.getText("NewQueryName"));return this.getName()}validate(t){t=t||{};const e="EntityAttribute isn't declared in the model: ";const s="The expression has wrond tag: ";if(!this.model){throw new W("Model is not declared")}if(this.columns){for(let t of this.columns){if(t.expr.tag==L.EntityAttribute||t.expr.tag===L.ParentEntityAttribute){const s=this.model.getAttributeById(t.expr.value);if(!s){throw new W(e+t.expr.value)}}else if(t.expr.tag===L.AggregateFunction){const s=this.model.getAttributeById(t.expr.args[0].value);if(!s){throw new W(e+t.expr.args[0].value)}}else if(t.expr.tag===L.Unknown){throw new W(s+t.expr.tag)}}}if(this.root&&this.root.getConditions()){this.validateConditionGroup(this.root,t)}}getAggregatedColumns(){return this.getColumns().filter((t=>t.enabled&&t.expr.tag===L.AggregateFunction))}tryValidate(t){try{this.validate(t);return true}catch(t){if(t instanceof W){return false}else{throw t}}}validateConditionGroup(t,e){if(t.isGroup()){for(let s of t.getConditions()){if(!s.enabled)continue;this.validateConditionGroup(s,e)}}else if(t.expressions[0].tag===L.EntityAttribute){const s=t.expressions[0].value;const i=this.model.getAttributeById(s);if(!i){throw new W("EntityAttribute isn't declared in the model: "+s)}if(!e.checkExpressions)return;for(let e=1;e<t.expressions.length;e++){const s=t.expressions[e];if(s.tag!==L.Constant)continue;if(r.isNumericType(s.dataType)){if(!s.value)continue;let e=[];if(s.kind===D.List){e=s.value.split(/\s*,\s*/)}else{e=[s.value]}for(let i of e){const e=+i;if(isNaN(e)){throw new W("Expression constant is NaN in condition:"+t.id)}if(r.isIntType(s.dataType)&&e!=parseInt(i,10)){throw new W("Expression constant is wrong interger in condition: "+t.id)}}}}}}loadFromDataOrJson(t,e){if(t){if(typeof t==="string"){this.loadFromJson(t,e)}else{this.loadFromData(t,e)}}}loadFromJson(t,e){let s=JSON.parse(t);this.loadFromData(s,e)}loadFromData(t,e){e=r.assign({changeStatus:true,validate:true},e||{});let s=false;this.clear();this.clearDrillDowns();if(t){this.id=t.id;this.root.loadFromData(this.model,t.root);if(t.root&&t.root.conds){for(let e=0;e<t.root.conds.length;e++){const s=t.root.conds[e];if(s.conds&&!this.isEx()){console.error("Community version doesn't support working with groups.");continue}const i=this.createCondition();i.loadFromData(this.model,s);this.root.addCondition(i)}}this.name=t.name;if(t.desc){this.description=t.desc}this.sortedColumns=[];if(t.justsortcols){for(let e=0;e<t.justsortcols.length;e++){let s=this.createColumn(true);s.loadFromData(this.model,t.justsortcols[e]);this.addColumnToSorted(s)}}if(t.cols){for(let e=0;e<t.cols.length;e++){let s=this.createColumn();s.loadFromData(this.model,t.cols[e]);this.columns.push(s);if(s._sorting!=Q.None){this.addColumnToSorted(s)}}}this.sortedColumns.sort(((t,e)=>t._sortIndex-e._sortIndex));this.fixupSortingIndices();if(t.extraData){this.extraData=t.extraData}this.innerData=t.innerData||this.innerData;if(this.innerData&&this.innerData.aggr){this._enableAggregation=this.innerData.aggr.enabled||false;this.useAggregation((t=>{t.loadFromData(this.innerData.aggr)}),true)}if(t.dds&&t.dds.length){for(let e of t.dds){const t=this.addDrillDown();t.loadFromData(e)}}}if(this._enableAggregation){this.updateAggregationSettings()}s=true;if(s){if(e.changeStatus){this.isNewbie=false;this._isModified=false}}if(e.validate){this.validate()}}addDrillDown(){const t=this.context.createQuery();t.parentQuery=this;this.drillDowns.push(t);return t}getDrillDowns(){return this.drillDowns}getParentQuery(){return this.parentQuery}findColumnById(t){for(let e of this.columns){if(e.id===t)return e}return null}getModel(){return this.model}setModel(t){this.model=t}loadModelData(t){this.model.setData(t)}toJSON(){return JSON.stringify(this.toJSONData())}toJSONData(){this.fixupSortingIndices();let t={modelId:this.model?this.model.getId():null,modelName:this.model?this.model.getName():null};t.id=this.id;t.name=this.name;if(this.description){t.desc=this.description}t.cols=[];for(let e=0;e<this.columns.length;e++){t.cols.push(this.columns[e].saveToData())}t.justsortcols=[];this.sortedColumns.forEach((e=>{if(e.isJustSorted()){t.justsortcols.push(e.saveToData())}}));if(this.extraData){t.extraData=this.extraData}if(this.innerData){t.innerData=this.innerData;t.innerData.aggr=this.aggrSettings.saveToData();t.innerData.aggr.enabled=this._enableAggregation}const e=t=>{const e=t.saveToData();e.conds=[];const s=t.getConditions();for(let t=0;t<s.length;t++){if(s[t].isGroup()&&!this.isEx()){console.error("Community version doesn't support working with groups.");continue}e.conds.push(s[t].saveToData())}return e};t.root=e(this.root);t.extraConds=e(this.extraConditions);if(this.drillDowns.length>0){t.dds=[];for(let e of this.drillDowns){t.dds.push(e.toJSONData())}}t.timezoneOffset=this.timezoneOffset;t.locale=a.getCurrentLocale();return t}isEmptyConditions(){return this.root.isEmpty()}isEmptyColumns(){return!this.columns||this.columns.length===0}isEmpty(){return this.isEmptyColumns()&&this.isEmptyConditions()}clear(){this._enableAggregation=false;this.aggrSettings.clear();this.clearColumns();this.clearConditions();this.clearExtraConditions();this.innerData={};this.extraData={}}clearColumns(){this.columns=[];this.sortedColumns=[]}clearConditions(){this.root.clearConditions();this.root.linkType=$.All;this.root.enabled=true}clearExtraConditions(){this.extraConditions.clearConditions()}clearDrillDowns(){this.drillDowns=[]}getId(){return this.id}setId(t){this.id=t}regenerateId(){this.id=r.generateId("quer")}getName(){return this.name}setName(t){this.name=t}getDescription(){return this.description?this.description:""}setDescription(t){this.description=t}getColumns(){return this.columns}getUsedInTotalsColumns(){const t=this.getAggregatedColumns();if(t.length===0)return[];const e=this.getColumns().filter((t=>t.enabled&&t.expr.tag===L.EntityAttribute));if(e.length)e.pop();return e}addColumnToSorted(t){const e=JSON.stringify(t.expr.saveToData());let s=true;this.sortedColumns.forEach((t=>{const i=JSON.stringify(t.expr.saveToData());if(i===e){s=false}}));if(s){this.sortedColumns.push(t)}}getJustSortedColumns(){return this.sortedColumns.filter((t=>t.isJustSorted()))}getSortedColumns(){return this.sortedColumns}getColumnSortIndex(t){return this.sortedColumns.indexOf(t)}setColumnSortIndex(t,e){if(e<0)return;let s=this.getColumnSortIndex(t);if(s<0){this.addColumnToSorted(t);s=this.sortedColumns.length-1}r.moveArrayItem(this.sortedColumns,s,e);this.fixupSortingIndices()}getColumnSorting(t){const e=this.getColumnSortIndex(t);if(e>=0){return t._sorting!=Q.None?t._sorting:Q.Ascending}else{return Q.None}}setColumnSorting(t,e){const s=this.getColumnSortIndex(t);t._sorting=e;if(s>=0){if(e==Q.None){r.removeArrayItem(this.sortedColumns,t);this.fixupSortingIndices()}}else{if(e!=Q.None){this.addColumnToSorted(t);this.fixupSortingIndices()}}this.adjustColumnsSorting()}fixupSortingIndices(){this.sortedColumns.forEach(((t,e)=>{t._sortIndex=e}))}adjustColumnsSorting(){if(!this.syncSortOrderWithColumnsOrder){return}if(this.getJustSortedColumns().length>0){return}let t=0;this.columns.forEach((e=>{if(e.sorting!=Q.None){const s=this.getColumnSortIndex(e);if(s>=0){r.moveArrayItem(this.sortedColumns,s,t);t++}}}));this.fixupSortingIndices()}createColumn(t=false){return new q(this,t)}getColumnById(t){return r.findItemById(this.columns,t)}addColumn(e,s=false){let i;const n=e.justsorted||e.column&&e.column.isJustSorted();if(e.column){i=e.column}else{i=this.createColumn(e.justsorted);let s;if(e.attribute){s=e.attribute}else if(e.attributeId){s=this.model.getAttributeById(e.attributeId);if(!s){throw new Error(`Incorrect attribute id (${e.attributeId}): addColumn`)}}else if(typeof e.constValue==="undefined"&&!e.customSql){throw new Error("Not enought data for addColumn operation. One of the following options must be defined: attribute, attributeId, constValue or customSlq")}if(s){let t=n?s.useInSorting:s.useInResult;if(!t){if(s.lookupAttr){s=this.model.getAttributeById(s.lookupAttr);t=n?s.useInSorting:s.useInResult}if(!t){throw new Error(`Can't use this attribute for a column`)}}}if(e.aggrFuncId&&e.customSql){console.warn("Column cannot be created using aggrFuncId and customSql at the same time. "+"cusomSql will be used.")}if(typeof e.constValue!=="undefined"){i.expr.tag=L.Constant;i.expr.setValue(e.constValue);i.expr.kind=D.Scalar;i.expr.dataType=e.constType||t.String}else if(e.customSql){i.caption="Custom SQL Column";i.expr.tag=L.CustomSql;i.expr.sql=e.customSql;i.expr.kind=D.Query;i.expr.dataType=t.Unknown;i.expr.baseAttrId=e.attributeId;if(!this.context.options.allowCustomExpressions){i.enabled=false}}else if(e.aggrFuncId){const t=e.aggrFuncId;i.expr.tag=L.AggregateFunction;i.expr.func=e.aggrFuncId;i.expr.kind=D.Scalar;i.expr.dataType=t=="COUNT"||t=="CNTDST"?4:s.dataType;i.expr.distinct=false;const n=new R(i);n.setValue(s.id,true);n.tag=L.EntityAttribute;n.kind=D.Attribute;n.dataType=s.dataType;i.expr.args.push(n)}else{i.expr.setValue(s.id,true);i.expr.tag=L.EntityAttribute;i.expr.kind=D.Attribute;i.expr.dataType=s.dataType;i.params.concat(s.params)}i.caption=e.caption||this.context.getDefaultColumnCaption(i);i._sorting=e.sorting||Q.None;i._sortIndex=e.sortIndex||-1;i.enabled=r.getIfDefined(e.enabled,true);i.setReadOnly(r.getIfDefined(e.readonly,false))}if(!n){if(e.index&&e.index>=0&&e.index<this.columns.length){this.columns.splice(e.index,0,i)}else{this.columns.push(i)}}this.setColumnSorting(i,i._sorting);if(!s){this.fireColumnsChangedEvent(O.Add,i,n)}return i}addColumnObj(t,e,s){let i=this.columns;if(typeof t.length=="undefined"){if(typeof e=="number"){i.splice(e,0,t)}else{i.push(t)}if(t.sorting!=Q.None){this.addColumnToSorted(t)}this.fixupSortingIndices()}else{if(typeof e=="number"){i.push.apply(i,[e,0].concat(t))}else{i.push.apply(i,[].concat(t))}t.forEach((t=>{if(t.sorting!=Q.None){this.addColumnToSorted(t)}}));this.fixupSortingIndices()}}changeColumnType(e,s,i){if(e.isJustSorted())return;i=i||{};if(s===L.AggregateFunction){if(!i.funcId)throw Error('"funcId" argument is not defined');if(e.expr.tag==L.AggregateFunction){e.expr.func=i.funcId;return}const t=new R(e);t.tag=L.AggregateFunction;t.func=i.funcId;t.distinct=false;t.dataType=i.funcId=="COUNT"||i.funcId=="CNTDST"?4:e.expr.dataType;const s=new R(e);s.loadFromData(this.model,e.expr.saveToData());t.args.push(s);e.expr=t}else if(s===L.CustomSql){const s=e.expr.tag==L.AggregateFunction?e.expr.args[0].value:e.expr.value;let i="";if(this.model){i=this.model.getAttributeById(s).expr}const n=new R(e);n.tag=L.CustomSql;n.dataType=t.String;n.sql=i;n.baseAttrId=s;e.expr=n}else if(s===L.EntityAttribute){if(e.expr.tag===L.EntityAttribute||e.expr.tag===L.ParentEntityAttribute){return}const t=e.expr.tag==L.AggregateFunction?e.expr.args[0].value:e.expr.baseAttrId;const s=t?this.model.getAttributeById(t):this.model.getFirstUICAttr();const i=new R(e);i.tag=L.EntityAttribute;i.dataType=s.dataType;i.setValue(s.id,true);e.expr=i}e.caption=this.context.getDefaultColumnCaption(e)}moveColumn(t,e){const s=this.getColumns();r.moveArrayItem(s,t,e);this.adjustColumnsSorting()}removeColumn(t){r.removeArrayItem(this.columns,t);r.removeArrayItem(this.sortedColumns,t)}addConditionGroup(t,e=true){console.error("Community version doesn't support working with groups.");return null}addExtraConditionGroup(t,e=true){console.error("Community version doesn't support working with groups.");return null}createCondition(t=j.Simple){return new G(this,t)}addSimpleCondition(t){let e=t.parent||this.getRootCondition();let s=this.getModel();if(!s)return null;if(!t.attribute&&!t.attributeId){throw new Error("Either `attribute` or `attributeId` parameter must have a value")}if(!t.attribute){t.attribute=s.getAttributeById(t.attributeId);if(!t.attribute){throw new Error("Could not find this attribute: "+t.attributeId)}}if(!t.operator&&t.operatorId){t.operator=s.getOperatorById(t.operatorId)}if(!t.operator){t.operator=s.getDefaultOperatorForAttr(t.attribute)}let i=this.createSimpleConditionObject(t.attribute,t.operator,t.value);e.addCondition(i);i.enabled=r.getIfDefined(t.enabled,true);i.setReadOnly(r.getIfDefined(t.readonly,false));return i}addSimpleExtraCondition(t){t.parent=t.parent||this.extraConditions;return this.addSimpleCondition(t)}createSimpleConditionObject(t,e,s){if(!t||!t.useInConditions){let e=t?t.caption:"NULL";throw"Can't add a condition with such attribute: "+e}let i=this.createCondition(j.Simple);i.setOperatorId(e.id,true);let n=new R(i);n.setValue(t.id,true);n.tag=this.attributeExprTag;n.kind=D.Attribute;n.dataType=t.dataType;i.expressions.push(n);let h=this.getModel();const o=e.paramCount;let l=r.fillArray(new Array(o-1),null);if(s!==null&&typeof s!=="undefined"){if(Array.isArray(s)){r.copyArrayTo(s,l)}else if(o>0){l[0]=s}}var a=l.length;for(var u=0;u<a;u++){let s=h.getOperand(t,e,u+1);i.addExpressionByOperand(s,l[u])}return i}removeColumns(t,e){let s=t.filter((t=>t.isJustSorted()));let i=t.filter((t=>!t.isJustSorted()));function n(t,e){let s=e.length;for(let i=0;i<s;i++){let s=t.indexOf(e[i]);if(s>=0){t.splice(s,1)}}}if(i.length>0){n(this.getColumns(),i);n(this.sortedColumns,i)}if(s.length>0){n(this.sortedColumns,s)}this.fixupSortingIndices()}fireProcessEvent(t){this.eventEmitter.fire("query.process",t)}fireChangedEvent(t,e,s){t=t||{part:P.All};if(typeof e!="undefined"||typeof s!="undefined"){t.postpone=e||0;t.wasModified=s;console.warn("Method with 'postpone' and 'wasModified' args is deprecated. Pass params in data object")}this._isModified=typeof t.wasModified!="undefined"?t.wasModified:true;const i=t||{part:P.All};this.eventEmitter.fire("query.change",i,t.postpone||0)}fireColumnsChangedEvent(t,e,s=false){this.fireChangedEvent({part:s?P.SortingColumns:P.Columns,action:t,changee:e})}fireConditionsChangedEvent(t,e){this.fireChangedEvent({part:P.Conditions,action:t,changee:e})}runThroughConditions(t){let e=function(s){for(let i=0;i<s.getConditions().length;i++){let n=s.getConditions()[i];if(n.isGroup()){e(n)}else{if(t)t(n)}}};e(this.getRootCondition())}getOneValueForAttr(t){let e=null;this.runThroughConditions((function(s){if(s.enabled){const i=s.expressions[0];const n=s.getOperatorId();if(i.value==t&&s.expressions[1]&&(n=="Equal"||n=="InList"||n=="StartsWith")){e=s.expressions[1].value}}}));return e}getRootCondition(){return this.root}addProcessCallback(t){return this.eventEmitter.subscribe("query.process",t)}removeProcessCallback(t){this.eventEmitter.unsubscribe("query.process",t)}addChangedCallback(t){return this.eventEmitter.subscribe("query.change",t)}removeChangedCallback(t){this.eventEmitter.unsubscribe("query.change",t)}getConditionsText(){const t=this.getModel();if(!t)return"";const e=s=>{let i="",n="Conj"+T.linkTypeToStr(s.linkType),r=a.getText(n),h,o;for(o=0;o<s.getConditions().length;o++){h="";let n=s.getConditions()[o];if(n.enabled||typeof n.enabled==="undefined"){if(n.isGroup()){h=e(n);if(h){h="("+h+")"}}else{let e=n.getOperatorId();let s=t.getOperatorById(e);let i=T.parseOperatorFormat(s);let r=i.length;for(let e=0;e<r;e++){let s=i[e];let r=s.text;if(s.type=="expression"){let e=n.expressions[s.index];if(e.kind==D.Attribute||e.tag==L.EntityAttribute){let s=t.getAttributeById(e.value);if(s!=null){r=t.getAttributeText(s,"{entity} {attr}")}}if(e.kind==D.Query){r=": ("+e.subQuery.getConditionsText()+")"}else{r=e.getText();if(this.model.isDateMacro(r)||this.model.isTimeMacro(r)){const t=r.substring(3,r.length-2);const e=a.getText(t);r=e||r}}}if(e>0)h+=" ";h+=r}}}if(h){if(o>0&&i){i+=" "+r+" "}i+=h}}if(s.linkType==$.None||s.linkType==$.NotAll){i='not ( " + result + " )'}return i};return e(this.getRootCondition())}getConditionsTextAsHtml(){const e=this.getModel();if(!e)return'<div class="eqjs-query-text"></div>';const s=e=>{if(e.kind==D.Query){return`&lt;${e.getText()}&gt;`}else if(e.kind==D.List){return`[${e.getText()}]`}else if(e.dataType==t.String||e.dataType==t.Memo||e.dataType==t.FixedChar){return`&quot;${e.getText()}&quot;`}else{let t=e.getText();if(this.model.isDateMacro(t)||this.model.isTimeMacro(t)){const e=t.substring(3,t.length-2);const s=a.getText(e);t=s||t}return t}};const i=t=>{let n="",r="Conj"+T.linkTypeToStr(t.linkType),h=`<span class="eqjs-query-text-conj">${a.getText(r)}</span>`,o,l;for(l=0;l<t.getConditions().length;l++){o="";let r=t.getConditions()[l];if(r.enabled||typeof r.enabled==="undefined"){if(r.isGroup()){o=i(r);if(o){o="("+o+")"}}else{let t=r.getOperatorId();let i=e.getOperatorById(t);let n=T.parseOperatorFormat(i);let h=n.length;for(let t=0;t<h;t++){let i=n[t];let h=i.text;if(i.type=="expression"){let t=r.expressions[i.index];if(t.kind==D.Attribute||t.tag==L.EntityAttribute){let s=e.getAttributeById(t.value);h=`<span class="eqjs-query-text-attr">${e.getAttributeText(s,"{entity} {attr}")}</span>`}else{h=`<span class="eqjs-query-text-expr">${s(t)}</span>`}}else if(i.type=="operator"){h=`<span class="eqjs-query-text-op">${h}</span>`}if(t>0)o+=" ";o+=h}}}if(o){if(l>0&&n){n+=" "+h+" "}n+=o}}if(t.linkType==$.None||t.linkType==$.NotAll){n='<span class="eqjs-query-text-conj">not</span> ( '+n+" )"}return n};return`<div class="eqjs-query-text">${i(this.getRootCondition())}</div>`}getEntitiesInQuery(){if(this.model.id!==this.id)throw Error("Model mithmatch");const t=[];const e=this.getColumns();for(let s of e){if(!s.enabled)continue;this.addEntityByExpression(t,s.expr)}const s=this.getRootCondition();this.fillEntitiesByCondtionGroup(t,s);return t}fillEntitiesByCondtionGroup(t,e){for(let s of e.getConditions()){if(!s.isGroup()){for(let e of s.expressions){this.addEntityByExpression(t,e);if(e.args){for(let s of e.args){this.addEntityByExpression(t,s)}}}}else{this.fillEntitiesByCondtionGroup(t,s)}}}addEntityByExpression(t,e){if(e.tag!==L.EntityAttribute)return;const s=e.baseAttrId||e.value;if(s){const e=this.model.getAttributeById(s);if(e){if(e.entity&&r.indexOfArrayItem(t,e.entity)<0){t.push(e.entity)}}}}buildQueryPath(){let t=this.model.getMainEntity()||this.model.rootEntity;const e=this.createTreeNodeFromEntity(t);e.setParents();return e}createTreeNodeFromEntity(t){let e=new H(t);for(let s of t.subEntities){e.addChild(this.createTreeNodeFromEntity(s))}return e}}class z{constructor(t){this.context=t;console.warn("BrowserQueryStorage is used for managing queries")}init(t){let e="eq";if(t&&t.keyPrefix){e=t.keyPrefix}this.queryListKey=e+"-querylist";this.queryKeyPrefix=e}getQueryList(t){return new Promise(((t,e)=>{try{const e=localStorage.getItem(this.queryListKey);if(e){t(JSON.parse(e))}t([])}catch(t){e(t)}}))}newQuery(t){return new Promise(((e,s)=>{const i=this.context.createQuery();i.reset();i.setDefaultName();if(t){if(t.query){i.loadFromData(t.query.toJSONData())}if(t.queryId){i.setId(t.queryId)}if(t.name){i.setName(t.name)}if(t.description){i.setDescription(t.description)}}this._saveQuery(i);e(i.toJSONData())}))}loadQuery(t){return new Promise(((e,s)=>{try{const s=localStorage.getItem(this.queryKeyPrefix+"-"+t.queryId);if(s){e(JSON.parse(s))}throw new Error("Query is not found: "+t.queryId)}catch(t){s(t)}}))}saveQuery(t){return new Promise(((e,s)=>{try{t.modelId||this.context.getModel().getId();const s=t.query||this.context.getQuery();this._saveQuery(s);e(null)}catch(t){s(t)}}))}_saveQuery(t){let e=[];const s=localStorage.getItem(this.queryListKey);if(s){e=JSON.parse(s)}let i=r.findItemById(e,t.getId());if(!i){i={id:t.getId(),name:t.getName(),text:t.getDescription()};e.push(i)}i.name=t.getName();i.text=t.getDescription();localStorage.setItem(this.queryListKey,JSON.stringify(e));localStorage.setItem(this.queryKeyPrefix+"-"+t.getId(),t.toJSON())}removeQuery(t){return new Promise(((e,s)=>{try{t.modelId||this.context.getModel().getId();const s=t.queryId||this.context.getQuery().getId();let i=[];const n=localStorage.getItem(this.queryListKey);if(n){i=JSON.parse(n)}i=i.filter((t=>t.id!=s));localStorage.setItem(this.queryListKey,JSON.stringify(i));localStorage.removeItem(this.queryKeyPrefix+"-"+s);e()}catch(t){s(t)}}))}}class V{constructor(t){this.context=t;this.modelPromise=null}init(t){}getContext(){return this.context}createModelLoadingPromise(){this.modelPromise=new Promise(((t,e)=>{this.modelLoadingResolveFunc=t;this.modelLoadingRejectFunc=e}))}getModelPromise(){return this.modelPromise||Promise.reject(new Error("Model has been never loaded."))}startModelLoading(t){this.createModelLoadingPromise();this.sendLoadModelRequest(t);return this.modelPromise}}class J extends V{constructor(t){super(t)}init(){}sendLoadModelRequest(t){const e=this.getContext();const s=e.getServices().getHttpClient();const i=e.resolveEndpoint("GetModel",{modelId:t.modelId});s.get(i).then((t=>{if(!t.model){this.modelLoadingRejectFunc(new Error('Wrong response format for "GetModel" request'))}this.modelLoadingResolveFunc(t.model)})).catch((t=>{this.modelLoadingRejectFunc(t)}))}}class Y{constructor(t){this.context=t}fetchData(t){const e=t.query||this.context.getQuery();const s=e.getId();let i={options:t.options};if(typeof t.queryId!=="undefined"){i.queryId=t.queryId}else{i.query=e.toJSONData()}if(t.debug){i.debug=t.debug}if(t.chunk){i.chunk=t.chunk}if(t.data){i.data=t.data}if(typeof t.aux!="undefined"){i.aux=t.aux}const n=this.context.resolveEndpoint("FetchData",{modelId:e.getModel().getId(),queryId:s});const r=this.context.getServices().getHttpClient();return r.post(n,i).then((t=>t))}}class K{constructor(t){this.context=t}syncQuery(t){t=t||{};const e=t.query||this.context.getQuery();const s=t.options||{};let i={query:e.toJSONData(),options:s};if(t.data){i.data=t.data}const n=this.context.resolveEndpoint("SyncQuery",{modelId:e.getModel().getId(),queryId:e.getId()});const r=this.context.getServices().getHttpClient();return r.post(n,i).then((t=>t))}}class X{constructor(t){this.context=t}loadValueList(t){const e=t.modelId||this.context.getModel().getId();const s=r.assign({modelId:e},t.params);const i=s.editorId;const n=this.context.getServices().getHttpClient();const h=this.context.resolveEndpoint("GetValueList",{modelId:e,listId:i});let o={};if(t&&t.params&&t.params.queryParams){o=t.params.queryParams}return n.get(h,{queryParams:o}).then((t=>{if(t&&t.values){return t.values}else{throw new Error('Wrong response format. No "values" property')}}))}}class Z{constructor(t){this.context=t}getQueryFile(t){const e=t.query||this.context.getQuery();const s=this.context.resolveEndpoint("GetQueryFile",{modelId:e.getModel().getId(),format:t.format||"xml"});const i=this.context.getServices().getHttpClient();const n=i.post(s,{query:e.toJSONData()});const r=n.getRequest();return n.then((e=>{const s=new Blob([e]);const i=r.getXMLHttpRequest().getResponseHeader("Content-Disposition");let n=i?i.match(/filename="?([^"]*)"?$/)[1]:"query.json";if(t.fileName){n=t.fileName+n.substring(n.lastIndexOf("."))}if(window.navigator["msSaveOrOpenBlob"]){window.navigator["msSaveOrOpenBlob"](s,n)}else{const t=document.createElement("a");document.body.appendChild(t);t.style.display="none";t.href=window.URL.createObjectURL(s);t.download=n;t.click();window.URL.revokeObjectURL(t.href);document.body.removeChild(t)}}))}uploadQueryFile(t){t=t||{};const e=t.query||this.context.getQuery();const s=this.context.resolveEndpoint("UploadQueryFile",{modelId:e.getModel().getId()});const i=this.context.getServices().getHttpClient();return i.post(s,t.data,{dataType:"form-data"}).then((t=>t.query))}}class tt{constructor(t){this.context=t;this.levels={}}getAggregateData(t,e){return new Promise(((s,i)=>{const n=t=>{const n=this.groupKeyToStr(e);const r=t.get(n);if(r){s(r)}else{i(`Can't find data for ${n}`)}};const r=this.getLevelDesc(t,false);if(r){if(r.data){n(r.data)}else{r.receivedCallbacks.push(n)}}}))}setAggregateData(t,e){const s=this.getLevelDesc(t,true);s.data=e;if(s.receivedCallbacks){for(const t of s.receivedCallbacks){t(s.data)}}s.receivedCallbacks=[]}updateAggregateData(t,e,s){const i=this.getLevelDesc(t,true);const n=this.groupKeyToStr(e);i.data.set(n,s)}groupKeyToStr(t){return JSON.stringify(t)}getLevelDesc(t,e){let s=this.levels[t];if(!s&&e){s={receivedCallbacks:[],data:new Map};this.levels[t]=s}return s}clear(){this.levels={}}}class et{constructor(t){this.context=t;this.aggrs=null}getAggrContainer(){return this.aggrs}calculate(t){console.warn("Grand totals and sub totals aggregation calculation can be used in Enterprise version only");t=t||{};t.maxLevel=t.maxLevel>=0?t.maxLevel:0;this.aggrs=new tt(this.context);const e=this.context.createQuery();e.loadFromData(this.context.getQuery().toJSONData());const s=this.context.getQuery().getAggregationSettings();const i=s.getAggregates().map((t=>t.colId));const n=e.getColumns().filter((t=>i.indexOf(t.id)<0));for(let t=0;t<n.length;t++){n[t].enabled=false}if(s.hasGrandTotals()){this.aggrs.setAggregateData(0,new Map);if(t.resultObtained)t.resultObtained({},0)}const r=s.getGroups();for(let e=1;e<=r.length&&e<=t.maxLevel;e++){this.aggrs.setAggregateData(e,new Map);if(t.resultObtained)t.resultObtained({},e)}return Promise.resolve()}needRecalculation(){return true}reset(){}}class st{static getInstance(){if(!st._instance){st._instance=new st}return st._instance}constructor(){this.services={};this.httpClient=new l;this.httpClient.defaultHeaders["x-eqjs-version"]="7.4.0";this.modelResolver=t=>new N;this.modelStorageResolver=null;this.queryResolver=t=>new U(t.getModel(),null,{context:t});this.modelLoaderResolver=t=>new J(t);this.queryStorageResolver=t=>new z(t);this.querySynchronizerResolver=t=>new K(t);this.vllResolver=t=>new X(t);this.dataFetcherResolver=t=>new Y(t);this.queryFileLoaderResolver=t=>new Z(t);this.aggrCalculatoResolver=t=>new et(t)}reset(){}getHttpClient(){return this.httpClient}createDataModel(t){if(!this.modelResolver){throw"Model resolver is not defined"}return this.modelResolver(t)}createQuery(t){if(!this.queryResolver){throw"Query resolver is not defined"}return this.queryResolver(t)}registerDataModelResolver(t){this.modelResolver=t}getDataModelResolver(){return this.modelResolver}registerQueryResolver(t){this.queryResolver=t}getQueryResolver(){return this.queryResolver}registerModelLoaderResolver(t){this.modelLoaderResolver=t}getModelLoaderResolver(){if(!this.modelLoaderResolver){throw"ModelLoaderResolver is not defined"}return this.modelLoaderResolver}registerModelStorageResolver(t){this.modelStorageResolver=t}getModelStorageResolver(){if(!this.modelStorageResolver){throw"ModelStorageResolver is not defined"}return this.modelStorageResolver}registerQueryStorageResolver(t){this.queryStorageResolver=t}getQueryStorageResolver(){if(!this.queryStorageResolver){throw"QueryStorageResolver is not defined"}return this.queryStorageResolver}registerDataFetcherResolver(t){this.dataFetcherResolver=t}getDataFetcherResolver(){if(!this.dataFetcherResolver){throw"DataFetcherResolver is not defined"}return this.dataFetcherResolver}registerQuerySyncronizerResolver(t){this.querySynchronizerResolver=t}getQuerySynchronizerResolver(){if(!this.querySynchronizerResolver){throw"QuerySynchronizerResolver is not defined"}return this.querySynchronizerResolver}registerValueListLoaderResolver(t){this.vllResolver=t}getValueListLoaderResolver(){if(!this.vllResolver){throw"Resolver for ValueListLoader is not defined"}return this.vllResolver}registerQueryFileLoaderResolver(t){this.queryFileLoaderResolver=t}getQueryFileLoaderResolver(){if(!this.queryFileLoaderResolver){throw"Resolver for QueryFileLoader is not defined"}return this.queryFileLoaderResolver}registerAggregatesCalculator(t){this.aggrCalculatoResolver=t}getAggregatesCalculatorResolver(){if(!this.aggrCalculatoResolver){throw"Resolver for AggregatesCalculator is not defined"}return this.aggrCalculatoResolver}registerService(t,e){this.services[t]=e}getService(t){const e=this.services[t];if(e){return e()}}}var it;(function(t){t[t["None"]=0]="None";t[t["Model"]=1]="Model";t[t["Query"]=2]="Query";t[t["Result"]=4]="Result";t[t["Statement"]=8]="Statement";t[t["QueryStatus"]=16]="QueryStatus";t[t["All"]=65535]="All"})(it||(it={}));var nt={offset:0,limit:0,needTotal:false};class rt{constructor(t){this.context=t}setFormat(t,e){this.format=t;this.responseType=e}export(t){t=t||{};const e=this.context.getServices().getHttpClient();const s=this.format||"csv";const i=t.query||this.context.getQuery();const n=i.getModel().getId();let r={settings:t.settings,chunk:nt};if(typeof t.queryId!=="undefined"){r.queryId=t.queryId}else{r.query=i.toJSONData()}if(t.data){r.data=t.data}if(t.options){r.options=t.options}const h=this.context.resolveEndpoint("ExportResult",{modelId:n,format:s});const o=e.post(h,r,{responseType:this.responseType});const l=o.getRequest();return o.then((t=>{const e=new Blob([t]);const i=l.getXMLHttpRequest().getResponseHeader("Content-Disposition");const n=i?i.match(/filename="?([^"]*)"?$/)[1]:"export-data."+s;if(window.navigator["msSaveOrOpenBlob"]){window.navigator["msSaveOrOpenBlob"](e,n)}else{var r=document.createElement("a");document.body.appendChild(r);r.style.display="none";r.href=window.URL.createObjectURL(e);r.download=n;r.click();window.URL.revokeObjectURL(r.href);document.body.removeChild(r)}}))}}class ht{constructor(t){this.context=t}loadChunk(t){this.dataLoadPromise=new Promise(((e,s)=>{const i={chunk:t,success:s=>{const i=new v({loader:this.context.dataLoader,chunkSize:this.context.resultTable.chunkSize});const n=s.resultSet;for(const t of n.cols){i.columns.add(t)}i.setTotal(s.meta.totalRecords);for(const t of n.rows){i.addRow(t)}let r=0;if(s.meta&&s.meta.totalRecords){r=s.meta.totalRecords}e({table:i,total:r,hasNext:!t.needTotal||t.offset+t.limit<r})},error:t=>s(t)};if(this.context.debugMode){i.debug=`Data Chunk. Offset: ${t.offset}`}this.context.fetchDataChunk(i)}));return this.dataLoadPromise}}var ot;(function(t){t[t["Error"]=0]="Error";t[t["Success"]=1]="Success"})(ot||(ot={}));var lt;(function(t){t["LoadModel"]="LoadModel";t["LoadQuery"]="LoadQuery";t["LoadQueryList"]="LoadQueryList";t["NewQuery"]="NewQuery";t["SaveQuery"]="SaveQuery";t["RemoveQuery"]="RemoveQuery";t["SyncQuery"]="SyncQuery";t["FetchData"]="FetchData";t["GetValueList"]="GetValueList";t["ExportResult"]="ExportResult";t["GetQueryFile"]="GetQueryFile";t["UploadQueryFile"]="UploadQueryFile"})(lt||(lt={}));class at{constructor(){this.options={syncSortOrderWithColumnsOrder:true,attributeFormat:"{entity} {attr}",columnTitleFormat:null};this.servicesInitialized=false;this.modelLoader=null;this.queryStorage=null;this.querySynchronizer=null;this.dataFetcher=null;this.valueListLoader=null;this.queryFileLoader=null;this.aggrCalculator=null;this.internalListCache={};this.loadModelOnStart=true;this.loadQueryOnStart=false;this.useStoredQueryOnFetch=false;this.debugMode=false;this._backendInfo={type:"EQN-ANC",subType:"asp-net-core-razor"};this.endpointVarsRegex=/\{.*?\}/g;this.elasticPaging=false;this._predefinedListRequestHandlers={_DSDE:(t,e)=>{const s=this.getModel().getAllDateMacros().map((t=>({id:"${{"+t+"}}",text:a.getText(t)})));e(s);return true},_DSTE:(t,e)=>{const s=this.getModel().getAllTimeMacros().map((t=>({id:"${{"+t+"}}",text:a.getText(t)})));e(s);return true}};this._listRequestHandler=(t,e)=>{if(t==null||!t.listName)return;const s=this.getQuery();const i=r.assign({listName:t.listName},t.editorParams);const n={};const h=/@{{(.+?)}}/;for(const t in i){if(!i[t])continue;let e=i[t].match(h);if(e){let r=s.getOneValueForAttr(e[1]);if(!r){r=""}n[t]=i[t].replace(h,r)}}const o={listName:n.listName,editorId:t.editorId,queryParams:n};let l=this.getListFromCache(t);if(l&&l.length>0){e(l);return}let a=false;const u=this._predefinedListRequestHandlers[t.editorId];if(u){a=u(t,e)}if(!a&&this.clientListRequestHandler){a=this.clientListRequestHandler(t,e)}if(!a){this.loadValueList({params:o,success:s=>{if(s){this.addListToCache(t,s)}e(s)},error:t=>{e(null)}})}};this.baseEndpoint="api/easyquery";this.eqServices=st.getInstance();this.widgets=new Array;this.eventEmitter=new C(this);this.exporters=new Map;this.endpoints=new Map;this.dataLoader=new ht(this);this.resultTable=new v({loader:this.dataLoader,onUpdate:this.onResultTableUpdate.bind(this)});this.resultTable.id="ResultTable";this.errorHandlerId=this.addEventListener("error",((t,e)=>{e.result=ot.Error;const s=e.action?e.action+" error":"Error";let i=e.text?e.text:"";if(e.sourceError&&e.sourceError.message!==i){i+="\n"+e.sourceError}console.error(s+": "+i)}))}getServices(){return this.eqServices}getModelLoader(){if(!this.modelLoader){const t=this.eqServices.getModelLoaderResolver();this.modelLoader=t(this)}return this.modelLoader}getModelStorage(){if(!this.modelStorage){const t=this.eqServices.getModelStorageResolver();this.modelStorage=t(this)}return this.modelStorage}getQueryStorage(){if(!this.queryStorage){const t=this.eqServices.getQueryStorageResolver();this.queryStorage=t(this)}return this.queryStorage}getQuerySynchronizer(){if(!this.querySynchronizer){const t=this.eqServices.getQuerySynchronizerResolver();this.querySynchronizer=t(this)}return this.querySynchronizer}getDataFetcher(){if(!this.dataFetcher){const t=this.eqServices.getDataFetcherResolver();this.dataFetcher=t(this)}return this.dataFetcher}getValueListLoader(){if(!this.valueListLoader){const t=this.eqServices.getValueListLoaderResolver();this.valueListLoader=t(this)}return this.valueListLoader}getQueryFileLoader(){if(!this.queryFileLoader){const t=this.eqServices.getQueryFileLoaderResolver();this.queryFileLoader=t(this)}return this.queryFileLoader}getAggregatesCalculator(){if(!this.aggrCalculator){const t=this.eqServices.getAggregatesCalculatorResolver();this.aggrCalculator=t(this)}return this.aggrCalculator}useEnterprise(t){console.warn("This method does nothing and should not be called in the Community version of the library")}registerExporter(t,e){this.exporters.set(t,e)}registerServerExporter(t,e){this.registerExporter(t,(s=>{const i=new rt(s);i.setFormat(t,e);return i}))}getExporter(t){const e=this.exporters.get(t);if(e){return e(this)}return null}getExportFormats(){return Array.from(this.exporters.keys())}addDefaultExporters(){this.registerServerExporter("csv","arraybuffer");this.registerServerExporter("excel-html","arraybuffer")}resolveEndpoint(t,e){e=e||{};let s=this.endpoints.get(t);if(!s){throw t+" endpoint is not defined"}let i=s.match(this.endpointVarsRegex);if(i){for(let t of i){let i=t.substring(1,t.length-1);let n=e[i];if(!n){if(i=="modelId"){n=this.getModel().getId()}else if(i=="queryId"){n=this.getQuery().getId()}else{throw`Parameter [${i}] is not defined`}}s=s.replace(t,n)}}return s}setEndpoint(t,e){this.endpoints.set(t,e)}setEndpointIfNotExist(t,e){if(!this.endpoints.has(t))this.endpoints.set(t,e)}setDefaultEndpoints(t){this.setEndpointIfNotExist("GetModel",T.combinePath(t,"models/{modelId}"));this.setEndpointIfNotExist("GetQuery",T.combinePath(t,"models/{modelId}/queries/{queryId}"));this.setEndpointIfNotExist("SaveQuery",T.combinePath(t,"models/{modelId}/queries/{queryId}"));this.setEndpointIfNotExist("SyncQuery",T.combinePath(t,"models/{modelId}/queries/{queryId}/sync"));this.setEndpointIfNotExist("NewQuery",T.combinePath(t,"models/{modelId}/queries"));this.setEndpointIfNotExist("RemoveQuery",T.combinePath(t,"models/{modelId}/queries/{queryId}"));this.setEndpointIfNotExist("GetQueryList",T.combinePath(t,"models/{modelId}/queries"));this.setEndpointIfNotExist("FetchData",T.combinePath(t,"models/{modelId}/fetch"));this.setEndpointIfNotExist("GetValueList",T.combinePath(t,"models/{modelId}/valuelists/{listId}"));this.setEndpointIfNotExist("ExportResult",T.combinePath(t,"models/{modelId}/export/{format}"));this.setEndpointIfNotExist("GetQueryFile",T.combinePath(t,"models/{modelId}/getqueryfile/{format}"));this.setEndpointIfNotExist("UploadQueryFile",T.combinePath(t,"models/{modelId}/uploadqueryfile"))}initStart(){this.servicesInitialized=true}init(t){if(!this.servicesInitialized)this.initStart();t=t||{};this.setOptions(t);if(typeof t.debugMode!=="undefined"){this.debugMode=t.debugMode}if(typeof t.chunkSize!=="undefined"){this.resultTable.chunkSize=t.chunkSize}if(typeof t.elasticPaging!=="undefined"){this.elasticPaging=t.elasticPaging}if(t.listCache){this.setExternalListCache(t.listCache)}if(t.locale){a.setCurrentLocale(t.locale)}if(t.localeSettings){a.updateLocaleSettings(t.localeSettings)}if(t.endpoint){this.baseEndpoint=t.endpoint;console.warn("The `endpoint` option is deprecated.\n"+"Please use `context.useEndpoint(endpointURL)` function instead.")}this.setDefaultEndpoints(this.baseEndpoint);if(t.modelStorageResolver){const e=this.getServices();e.registerModelStorageResolver(t.modelStorageResolver)}this.loadQueryOnStart=false;if(t.loadQueryOnStart){this.loadQueryOnStart=t.loadQueryOnStart}this.loadModelOnStart=true;if(typeof t.loadModelOnStart!=="undefined"){this.loadModelOnStart=t.loadModelOnStart}if(t.handlers){if(t.handlers.onInit){this.addEventListener("ready",t.handlers.onInit)}if(t.handlers.afterLoadModel){this.addEventListener("loadModel",t.handlers.afterLoadModel)}if(t.handlers.afterLoadQuery){this.addEventListener("loadQuery",t.handlers.afterLoadQuery)}if(t.handlers.afterSyncQuery){this.addEventListener("syncQuery",t.handlers.afterSyncQuery)}if(t.handlers.afterFetchData){this.addEventListener("fetchData",t.handlers.afterFetchData)}if(t.handlers.afterExportResult){this.addEventListener("exportResult",t.handlers.afterExportResult)}if(t.handlers.onProcessStart){this.addEventListener("processStart",t.handlers.onProcessStart)}if(t.handlers.onProcessEnd){this.addEventListener("processEnd",t.handlers.onProcessEnd)}if(t.handlers.onError){this.removeEventListener("error",this.errorHandlerId);this.addEventListener("error",t.handlers.onError)}if(t.handlers.onListRequest){this.clientListRequestHandler=t.handlers.onListRequest}if(t.handlers.beforeLoadModel){this.beforeLoadModel=t.handlers.beforeLoadModel}if(t.handlers.beforeLoadQuery){this.beforeLoadQuery=t.handlers.beforeLoadQuery}if(t.handlers.beforeSyncQuery){this.beforeSyncQuery=t.handlers.beforeSyncQuery}if(t.handlers.beforeFetchData){this.beforeFetchData=t.handlers.beforeFetchData}if(t.handlers.beforeExportResult){this.beforeExportResult=t.handlers.beforeExportResult}}this.initialQuery=t.initialQuery;this.defaultQueryId=t.defaultQueryId||"";this.defaultModelId=t.defaultModelId||"__default";const e=this.getModelLoader();e.init(t);const s=this.getQueryStorage();s.init(t);if(t.useDefaultExporters!==false){this.addDefaultExporters()}if(t.serverExporters){this.exporters.clear();for(const e of t.serverExporters){this.registerServerExporter(e,"arraybuffer")}}const i=this.getQuery();if(t.defaultQueryId){i.setId(t.defaultQueryId)}this.widgets.forEach((e=>{let s={};if(t.widgets&&t.widgets[e.getWidgetType()]){s=t.widgets[e.getWidgetType()]}e.init(this,s)}));if(this.loadModelOnStart){this.loadDefaultModel()}else{this.fireEvent("ready")}}setOptions(t){r.assign(this.options,t)}get backendInfo(){return this._backendInfo}useEndpoint(t){this.baseEndpoint=t;return this}useBackend(t){if(t.type){this._backendInfo.type=t.type}if(t.subType){this._backendInfo.subType=t.subType}else{switch(this._backendInfo.type){case"EQN-ANC":this._backendInfo.subType="asp-net-core-razor";break;case"EQN-ASP":this._backendInfo.subType="asp-net-4-mvc";break;default:this._backendInfo.subType="other";break}}return this}addWidget(t){this.widgets.push(t)}getAllWidgetsByType(t){return this.widgets.filter((e=>e.getWidgetType()===t))}getWidgetByType(t){const e=this.getAllWidgetsByType(t);return e.length>0?e[0]:null}refreshWidgets(t=it.All){this.widgets.forEach((e=>{if(e.belongsToGroup(t)){e.refresh()}}))}addQueryChangedCallback(t){this.getQuery().addChangedCallback(t)}removeQueryChangedCallback(t){this.getQuery().removeChangedCallback(t)}createQuery(){return this.eqServices.createQuery(this)}getQuery(){if(!this.query){if(!this.servicesInitialized){throw new Error("Can't create query until the context is initialized")}this.query=this.createQuery()}return this.query}getModel(){if(!this.dataModel){this.dataModel=this.eqServices.createDataModel(this)}return this.dataModel}loadModelFromData(t){this.getQuery().loadModelData(t);this.dataModel=this.getQuery().getModel()}setDefaultModelId(t){this.defaultModelId=t}startProcess(t,e){this.eventEmitter.fire("processStart",t);this.widgets.forEach((t=>{if(t.belongsToGroup(e)){t.onProcessStart()}}))}endProcess(t,e){this.eventEmitter.fire("processEnd",t);if(t.result===ot.Error){this.throwError(t)}this.widgets.forEach((t=>{if(t.belongsToGroup(e)){t.onProcessEnd()}}))}throwError(t){t.result=ot.Error;this.eventEmitter.fire("error",t)}loadDefaultModel(){this.loadModel({modelId:this.defaultModelId,silent:true,success:()=>{this.refreshWidgets(it.Model);let t=this.getQuery();this.fireEvent("initialModelLoad");if(this.initialQuery){t.loadFromData(this.initialQuery,{changeStatus:false})}if(this.loadQueryOnStart){this.loadQuery({queryId:this.defaultQueryId,modelId:this.defaultModelId,success:()=>{this.throwReady()},error:()=>{this.throwReady()}})}else{this.throwReady()}}})}throwReady(){this.refreshWidgets(it.Query);this.fireEvent("ready")}clearQuery(){const t=this.getQuery();t.clear();t.fireChangedEvent({part:P.All})}clearResult(){this.resultTable.clear();this.resultStatement=null;this.resultContent=null}setExternalListCache(t){this.externalListCache=t}getListFromCache(t){const e=this.getListCacheKey(t);if(this.externalListCache){return this.externalListCache.get(e)}else{return this.internalListCache[e]}}getListCacheKey(t){let e=t.listName=="SQL"?"SQL_"+t.editorId:t.listName;if(t.queryParams){e+="_"+Object.keys(t.queryParams).filter((t=>t!="listName")).map((e=>t.queryParams[e])).join("_")}return e}addListToCache(t,e){const s=this.getListCacheKey(t);if(this.externalListCache){this.externalListCache.set(s,e)}else{this.internalListCache[s]=e}}resetListCache(){if(this.externalListCache){this.externalListCache.clear()}else{this.internalListCache={}}}getListRequestHandler(){return this._listRequestHandler}addLocale(t,e){a.addLocale(t,e)}addEventListener(t,e){return this.eventEmitter.subscribe(t,(t=>e(this,t.data)))}removeEventListener(t,e){this.eventEmitter.unsubscribe(t,e)}fireEvent(t,e){this.eventEmitter.fire(t,e)}getBaseEndpoint(){return this.baseEndpoint}loadValueList(t){t=t||{};this.startProcess({action:lt.GetValueList,text:"Loading values"},it.Result);const e=this.getValueListLoader();e.loadValueList(t).then((e=>{this.endProcess({result:ot.Success,action:lt.GetValueList,text:"Values loaded"},it.Result);if(t.success){t.success(e)}})).catch((e=>{const s=t&&t.params?t.params.editorId:"undefined";const i=`Can't load the value list for editor ${s}.\n ${e.message}`;this.endProcess({result:ot.Error,action:lt.GetValueList,text:i,sourceError:e},it.Result);if(t.error){t.error(i,"GetValueList")}}))}loadModel(t){if(this.beforeLoadModel){this.beforeLoadModel(this,t)}const e=t.modelId||"__default";const s=t.silent||false;this.startProcess({action:lt.LoadModel,text:"Loading model: "+e},it.Model);const i=this.getModelLoader();return i.startModelLoading(t).then((i=>{if(i){this.loadModelFromData(i);if(this.dataModel.isEmpty()){console.warn(`Empty model has been loaded. Model ID: ${this.dataModel.getId()}`)}}else{console.warn("Model has not been changed.")}this.fireEvent("loadModel");this.endProcess({result:ot.Success,action:lt.LoadModel,text:"Model loaded: "+e},it.Model);if(!s){this.clearQuery();this.clearResult();this.refreshWidgets()}if(t.success){t.success(this.getModel())}return this.getModel()})).catch((s=>{const i=`Can't load model ${e}.\n ${s.message}`;this.endProcess({result:ot.Error,action:lt.LoadModel,text:i,sourceError:s},it.Model);if(t.error){t.error(i,"LoadModel")}return this.getModel()}))}callWhenModelLoaded(t){const e=this.getModelLoader();e.getModelPromise().then((()=>{t()}))}loadQuery(t){t=t||{};const e=this.getModelLoader();this.clearResult();e.getModelPromise().then((()=>{t=t||{};const e=t.queryId;const s=t.silent||false;if(this.beforeLoadQuery){this.beforeLoadQuery(this,t)}this.startProcess({action:lt.LoadQuery,text:"Query loading: "+e},it.Query);const i=this.getQueryStorage();i.loadQuery(t).then((i=>{if(i){this.query.loadFromData(i,{validate:false})}this.limitCustomSqlColumns();this.fireEvent("loadQuery");this.endProcess({result:ot.Success,action:lt.LoadQuery,text:"Query loaded: "+e},it.Query);this.query.resetModified();if(!s){this.query.fireChangedEvent({part:P.Properties,wasModified:this.query.isModified()});this.refreshWidgets()}if(t.success){t.success(this.query)}})).catch((e=>{const s=this.getQuery();e.message="Can't load query ["+s.getId()+"]\n"+(e.message||"");if(t.error){t.error(e.message,lt.LoadQuery)}this.endProcess({result:ot.Error,action:lt.LoadQuery,text:e.message,sourceError:e},it.Query)}))})).catch((t=>{console.error(t)}))}loadQueryList(t){const e=this.getModelLoader();e.getModelPromise().then((()=>{this.startQueryListLoading(t)})).catch((t=>{const e=`Can't load the list of available queries.\n ${t.message}`;this.throwError({action:lt.LoadQueryList,text:e,sourceError:t})}))}startQueryListLoading(t){t=t||{};const e=this.getQueryStorage();const s=e.getQueryList(t);s.then((e=>{if(t.success){t.success(e)}})).catch((e=>{const s=`Can't load the list of available queries.\n ${e.message}`;if(t.error){t.error(s,"LoadQueryList")}else{this.throwError({action:lt.LoadQueryList,text:s,sourceError:e})}}))}newQuery(t){t=t||{};const e=typeof t.clearQuery!=="undefined"?t.clearQuery:true;this.query.reset(e);if(t.queryId){this.query.setId(t.queryId)}if(t.name){this.query.setName(t.name)}if(t.description){this.query.setDescription(t.description)}const s=t.silent||false;let i=true;if(typeof t.useStorage!=="undefined"){i=t.useStorage}const n=()=>{const t=this.getQuery();t.isNewbie=true;if(!s){t.fireChangedEvent({part:P.All,wasModified:t.isModified()})}};if(i){this.startProcess({action:lt.NewQuery,text:"New query creation..."},it.Query);const e=this.getQueryStorage();e.newQuery(t).then((e=>{if(e){this.query.loadFromData(e)}this.endProcess({result:ot.Success,action:lt.NewQuery,text:"A new query has been created"},it.Query);n();if(t.success){t.success()}})).catch((e=>{const s=`Can't create a new query.\n${e.message}`;this.endProcess({result:ot.Error,action:lt.NewQuery,text:s,sourceError:e},it.Query);if(t.error){t.error(s,"NewQuery")}}))}else{n()}return this.query}saveQuery(t){t=t||{};const e=this.getQuery();this.startProcess({action:lt.SaveQuery,text:"Query saving: "+e.getId()},it.Query);const s=this.getQueryStorage();s.saveQuery(t).then((s=>{this.endProcess({action:lt.SaveQuery,result:ot.Success,text:"Query saved: "+e.getId()},it.Query);if(s){e.loadFromData(s)}e.resetModified();e.isNewbie=false;if(t.success){t.success()}})).catch((s=>{const i=`Can't save query ${e.getId()}.\n ${s.message}`;this.endProcess({action:lt.SaveQuery,result:ot.Error,text:i,sourceError:s},it.Query);if(t.error){t.error(i,lt.SaveQuery)}}))}removeQuery(t){t=t||{};const e=this.getQuery();this.startProcess({action:lt.RemoveQuery,text:"Query deleting: "+e.getId()},it.Query);const s=this.getQueryStorage();s.removeQuery(t).then((()=>{e.reset();this.endProcess({action:lt.RemoveQuery,result:ot.Success,text:"Query deleted: "+e.getId()},it.Query);if(t.success){t.success()}})).catch((s=>{const i=`Can't remove query ${e.getId()}.\n ${s.message}`;this.endProcess({action:lt.RemoveQuery,result:ot.Error,text:i,sourceError:s},it.Query);if(t.error){t.error(i,"RemoveQuery")}}))}syncQuery(t){t=t||{};const e=this.getQuery();if(this.beforeSyncQuery){this.beforeSyncQuery(this,t)}this.startProcess({action:lt.SyncQuery,text:"Query syncing: "+e.getId()},it.Query);const s=this.getQuerySynchronizer();s.syncQuery(t).then((s=>{this.resultStatement=s&&s.statement?s.statement:"";this.fireEvent("syncQuery");this.refreshWidgets(it.Statement);this.endProcess({result:ot.Success,action:lt.SyncQuery,text:"Query synced: "+e.getId()},it.Query);if(s){if(s.querySaved){const t=s.query;if(t){e.setId(t.id);e.setName(t.name);e.setDescription(t.desc);e.extraData=t.extraData}e.resetModified();this.refreshWidgets(it.QueryStatus)}if(t.success){t.success(s)}}})).catch((s=>{const i=`Can't synchronize query ${e.getId()}.\n ${s.message}`;this.endProcess({result:ot.Error,action:lt.SyncQuery,text:i,sourceError:s},it.Query);if(t.error){t.error(i,"SyncQuery")}}))}fetchData(t){t=t||{};const e=typeof t.elasticPaging!=="undefined"?t.elasticPaging:this.elasticPaging;this.resultTable.elasticChunks=e;t.chunk=t.chunk||{offset:0,limit:this.resultTable.chunkSize,needTotal:!e};if(this.debugMode){t.debug="Fetching the result set. Initial chunk"}if(!this.query.tryValidate({checkExpressions:true})){return}if(t.groupFetchSuccess){this.afterGroupFetch=t.groupFetchSuccess}if(this.resultTable.elasticChunks){t.chunk.limit++}this.fetchDataChunk(Object.assign(Object.assign({},t),{success:e=>{if(e.statement){this.resultStatement=e.statement;this.refreshWidgets(it.Statement)}const s=this.getAggregatesCalculator();s.reset();this.resultContent=e;if(e.resultSet){this.resultTable.clear();this.resultTable.id=this.query.getId();const s=e.resultSet;for(const t of s.cols){this.resultTable.columns.add(t)}if(e.meta&&typeof e.meta.totalRecords!=="undefined"){this.resultTable.setTotal(e.meta.totalRecords)}const i=s.rows.length;if(this.resultTable.elasticChunks&&i===t.chunk.limit){s.rows.splice(s.rows.length-1,1)}for(const t of s.rows){this.resultTable.addRow(t)}if(this.resultTable.elasticChunks){this.resultTable["total"]=i<t.chunk.limit?s.rows.length:0}this.resultTable.fireUpdated()}if(t.success){t.success(e)}}}))}getQueryFile(t){const e=this.getQuery();this.startProcess({action:lt.GetQueryFile,text:"Getting query file: "+e.getId()},it.Query);const s=this.getQueryFileLoader();s.getQueryFile(t).then((()=>{this.endProcess({result:ot.Success,action:lt.GetQueryFile,text:"Getting query file: "+e.getId()},it.Query);if(t.success){t.success()}})).catch((s=>{const i=`Can't get file for query ${e.getId()}.\n ${s.message}`;this.endProcess({result:ot.Error,action:lt.GetQueryFile,text:i,sourceError:s},it.Query);if(t.error){t.error(i,"GetQueryFile")}}))}uploadQueryFile(t){const e=this.getQuery();this.startProcess({action:lt.UploadQueryFile,text:"Uploading query file: "+e.getId()},it.Query);const s=this.getQueryFileLoader();s.uploadQueryFile(t).then((s=>{e.loadFromData(s);this.fireEvent("loadQuery");this.refreshWidgets();this.endProcess({result:ot.Success,action:lt.UploadQueryFile,text:"Uploading query file: "+e.getId()},it.Query);if(t.success){t.success()}})).catch((s=>{const i=`Can't upload a file for query ${e.getId()}.\n ${s.message}`;this.endProcess({result:ot.Error,action:lt.UploadQueryFile,text:i,sourceError:s},it.Query);if(t.error){t.error(i,"UploadQueryFile")}}))}fetchDataChunk(t){const e=this.getQuery().getId();let s=t||{};s.data=s.data||{};if(this.useStoredQueryOnFetch){s.queryId=this.query.getId()}if(this.beforeFetchData){this.beforeFetchData(this,s)}this.startProcess({action:lt.FetchData,text:"Fetching data for the query: "+e},it.Result);const i=this.getDataFetcher();i.fetchData(s).then((t=>{if(t.statement){this.resultStatement=t.statement}this.resultContent=t;if(s.success){s.success(t)}this.fireEvent("fetchData");this.endProcess({result:ot.Success,action:lt.FetchData,text:"Data fetching is finished for the query: "+e},it.Result)})).catch((t=>{const i=`Data fetching error for the query ${e}. \n${t.message}`;this.endProcess({result:ot.Error,action:lt.FetchData,text:i,sourceError:t},it.Result);if(s.error){s.error(i,lt.FetchData)}}))}onResultTableUpdate(){const t=this.query.getAggregationSettings();const e=this.getAggregatesCalculator();if(t.needAggrCalculation()&&e.needRecalculation()){e.calculate({maxLevel:t.getGroups().length+1,resultObtained:(t,e)=>{if(this.afterGroupFetch){this.afterGroupFetch(t)}},errorOccurred:t=>{const e=`Data fetching error on group level ${t.level} query. \n${t.message}`;this.throwError({action:lt.FetchData,text:e,sourceError:t})}})}}fetchDrillDownData(t){t=t||{};t.chunk=t.chunk||{offset:0,limit:this.resultTable.chunkSize,needTotal:true};const e=t.query;const s=e.getId();this.startProcess({action:lt.FetchData,text:"DrillDown executing: "+s},it.Result);const i=this.getDataFetcher();i.fetchData(t).then((e=>{this.endProcess({result:ot.Success,action:lt.FetchData,text:"DrillDown execution error: "+s},it.Result);if(t.success){t.success(e)}})).catch((e=>{const i=`Drill-down data fetching error for query ${s}. \n${e.message}`;this.endProcess({result:ot.Error,action:lt.FetchData,text:i},it.Result);if(t.error){t.error(i,"DrillDown")}else{this.throwError({action:lt.FetchData,text:i})}}))}exportResult(t){let e=t||{};e.chunk=e.chunk||nt;e.data=e.data||{};if(this.beforeExportResult){this.beforeExportResult(this,e)}const s=e.format;if(s){const t=this.getExporter(s);if(t){const s=this.getQuery().getId();if(this.useStoredQueryOnFetch){e.queryId=s}this.startProcess({action:lt.ExportResult,text:"Exporting result for query: "+s},it.Result);const i=a.getLocaleSettings();e.settings=i;const n=this.query.getAggregationSettings();if(n.hasAggregates()&&(n.hasGrandTotals()||n.hasGroups())){e.aggregates=n.saveToData()}t.export(e).then((t=>{this.fireEvent("exportResult");this.endProcess({result:ot.Success,action:lt.ExportResult,text:`The result set for query [${s}] has been successfully exported`},it.Result);if(e.success){e.success()}})).catch((t=>{const i=`Error on exporting data for query  ${s}. \n${t.message}`;this.endProcess({result:ot.Error,action:lt.ExportResult,text:i,sourceError:t},it.Result);if(e.error){e.error(i,"ExportResult")}}))}else{console.error("No exporter for this format: "+s)}}}limitCustomSqlColumns(){if(!this.options.allowCustomExpressions){this.query.getColumns().forEach((t=>{if(t.expr.tag===L.CustomSql){t.enabled=false}}))}}getAttributeTitle(t){const e=this.options.attributeFormat;return this.getModel().getAttributeText(t,e)}getColumnTitle(t){const e=this.options.columnTitleFormat||this.options.attributeFormat;return this.getModel().getAttributeText(t,e)}getDefaultColumnCaption(t){let e;const s=this.getModel();switch(t.expr.tag){case L.Constant:return"Contant Column";case L.CustomSql:return"SQL Column";case L.ParentColumn:return"Parent Column";case L.Query:return"Query Column";case L.EntityAttribute:case L.ParentEntityAttribute:e=s.getAttributeById(t.expr.value);return this.getColumnTitle(e);case L.AggregateFunction:e=s.getAttributeById(t.expr.args[0].value);return this.getColumnTitle(e)+" "+s.getAggrFunctionCaption(t.expr.func);default:return"Column"}}}let ut;function ct(t){ut=t}function ft(){if(!ut){throw Error("No context resolver")}return ut()}ct((()=>new at));var dt;(function(t){class e{constructor(){this.SpecDateValues=[{id:"${Today}",key:"Today",isDefault:true},{id:"${Yesterday}",key:"Yesterday"},{id:"${Tomorrow}",key:"Tomorrow"},{id:"${FirstDayOfMonth}",key:"FirstDayOfMonth"},{id:"${FirstDayOfYear}",key:"FirstDayOfYear"}];this.SpecTimeValues=[{id:"${Now}",key:"Now",isDefault:true},{id:"${HourStart}",key:"HourStart"},{id:"${Midnight}",key:"Midnight"},{id:"${Noon}",key:"Noon"}];this.BooleanValues=[{id:"${false}",key:"False"},{id:"${true}",key:"True",isDefault:true}]}}t.constLists=new e;t.predicateLinkTypeList=[{id:"All",key:"LinkTypeAll"},{id:"Any",key:"LinkTypeAny"},{id:"None",key:"LinkTypeNone"},{id:"NotAll",key:"LinkTypeNotAll"}]})(dt||(dt={}));class mt{constructor(t){this.slot=t;this._id=r.generateId(this.getWidgetType())}get id(){return this._id}init(t,e){this.context=t}getContext(){return this.context}refresh(){this.refreshCore()}refreshCore(){}onProcessStart(){this.onProcessStartCore()}onProcessStartCore(){}onProcessEnd(){this.onProcessEndCore()}onProcessEndCore(){}belongsToGroup(t){if(typeof t!="undefined"&&t!=null){if((t&this.group)===0)return false}return true}destroy(){this.destroyCore()}destroyCore(){}}function pt(){a.updateDefaultTexts({NewQueryName:"[New query]",Today:"Today",Yesterday:"Yesterday",Tomorrow:"Tomorrow",FirstDayOfMonth:"First day of the month",LastDayOfMonth:"Last day of the month",FirstDayOfWeek:"First day of the week",FirstDayOfYear:"First day of the year",FirstDayOfNextWeek:"First day of the next week",FirstDayOfNextMonth:"First day of the next month",FirstDayOfNextYear:"First day of the next year",Now:"Now",HourStart:"This hour start",Midnight:"Midnight",Noon:"Noon",Entities:{},Attributes:{},Operators:{},AggregateFunctions:{}})}pt();var gt;(function(t){let e=null;let s;function i(){{const t=navigator.userAgent;return t.includes("MSIE")||t.includes("Trident")}}t.isIE=i;function n(){const t=window.navigator.userAgent;return!i()&&t.includes("Edge/")}t.isEdge=n;function r(){if(e===null){const t=navigator.userAgent;e=t.toLowerCase().includes("firefox")}return e}t.isFirefox=r;let h=false;let o=undefined;let l=()=>{const t=a();h=window.matchMedia("only screen and (max-width: 840px)").matches||window.matchMedia("only screen and (max-height: 420px)").matches;const e=a();if(e!==t&&s){s(e)}};l();window.addEventListener("resize",(()=>l()));function a(){if(o!==undefined){return o}else{return h}}t.isMobileMode=a;function u(t){const e=a();o=t;const i=a();if(i!==e&&s){s(i)}}t.setIsMobileMode=u;function c(t){s=t}t.onMobileModeChanged=c})(gt||(gt={}));function yt(t,e,s){let i=document.createElement(e);let n=s||{};if(n.cssClass){i.className=n.cssClass}t.appendChild(i);return i}function bt(t,e){t.className=t.className?t.className+" "+e:e}function vt(t){t.style.display="none"}function wt(t,e){if(!e){e=""}t.style.display=e}function Ct(t,e,s){if(!s){s={}}if(!s.display){s.display=""}if(!s.duration){s.duration=200}vt(t);wt(e,s.display);if(s.complete){s.complete()}}function xt(t){return t.style.display!="none"&&t.offsetWidth!=0&&t.offsetHeight!=0}function kt(t){var e;if(typeof Event==="function"){e=new Event(t)}else{e=document.createEvent("Event");e.initEvent(t,true,true)}return e}function $t(){const t=Math.max(document.documentElement.clientWidth||0,window.innerWidth||0);const e=Math.max(document.documentElement.clientHeight||0,window.innerHeight||0);return{width:t,height:e}}function Tt(){const t=document.body;const e=document.documentElement;return{top:window.pageYOffset||e.scrollTop||t.scrollTop,left:window.pageXOffset||e.scrollLeft||t.scrollLeft}}function St(t){let e={x:0,y:0};if(t!==null){const s=Et(t);e={x:s.left,y:s.top}}return e}function Et(t){const e={top:0,right:0,bottom:0,left:0,width:0,height:0};let s;try{s=t.getBoundingClientRect()}catch(t){s=e}const i=document.body;const n=document.documentElement;const r=Tt();const h=r.top;const o=r.left;const l=n.clientTop||i.clientTop||0;const a=n.clientLeft||i.clientLeft||0;const u=s.top+h-l;const c=s.left+o-a;return{top:Math.round(u),left:Math.round(c)}}function Dt(){return{width:window.innerWidth,height:window.innerHeight}}function At(t,e,s){t.style.removeProperty("display");let i=window.getComputedStyle(t).display;if(i==="none")i="block";t.style.display=i;let n=t.offsetHeight;t.style.overflow="hidden";t.style.height=0+"px";t.style.paddingTop=0+"px";t.style.paddingBottom=0+"px";t.style.marginTop=0+"px";t.style.marginBottom=0+"px";t.style.boxSizing="border-box";t.style.transitionProperty="height, margin, padding";t.style.transitionDuration=e+"ms";t.style.height=n+"px";t.style.removeProperty("padding-top");t.style.removeProperty("padding-bottom");t.style.removeProperty("margin-top");t.style.removeProperty("margin-bottom");window.setTimeout((()=>{t.style.removeProperty("height");t.style.removeProperty("overflow");t.style.removeProperty("transition-duration");t.style.removeProperty("transition-property");t.style.removeProperty("box-sizing");if(s){s()}}),e)}function It(t,e,s){t.style.transitionProperty="height, margin, padding";t.style.transitionDuration=e+"ms";t.style.boxSizing="border-box";t.style.height=t.offsetHeight+"px";t.style.overflow="hidden";t.style.height=0+"px";t.style.paddingTop=0+"px";t.style.paddingBottom=0+"px";t.style.marginTop=0+"px";t.style.marginBottom=0+"px";window.setTimeout((()=>{t.style.display="none";t.style.removeProperty("height");t.style.removeProperty("padding-top");t.style.removeProperty("padding-bottom");t.style.removeProperty("margin-top");t.style.removeProperty("margin-bottom");t.style.removeProperty("overflow");t.style.removeProperty("transition-duration");t.style.removeProperty("transition-property");t.style.removeProperty("box-sizing");if(s){s()}}),e)}const Mt="eqjs";function Bt(t,e){const s={9:"[0-9]",a:"[a-z]"};const i=e.split("");const n=e=>{if(e.keyCode===8||e.keyCode===46){e.preventDefault();let n=[];let r=t.selectionStart;if(r==0)return;let h=r;let o=true;for(let e=i.length-1;e>=0;e--){const l=i[e];if(s[l]){let i=new RegExp(s[l],"i").test(t.value.charAt(e));if(i&&e!=r-1){o=false}if(e===r-1)h--;n.push(i&&e!=r-1?t.value.charAt(e):"_")}else{if(e===h-1)h--;if(r-1===e)r--;n.push(l)}}t.value=!o?n.reverse().join(""):"";t.selectionStart=t.selectionEnd=h<0?0:h;const l=document.createEvent("Event");l.initEvent("input",true,true);t.dispatchEvent(l)}};const r=e=>{const n=String.fromCharCode(e.charCode);if(n){e.preventDefault();let r=[];let h=t.selectionStart;let o=h;i.forEach(((e,i)=>{if(s[e]){const l=i!=h?t.value.charAt(i):n;let a=new RegExp(s[e],"i").test(l);r.push(a?l:"_");if(a&&h===i)o++}else{r.push(e);if(o===i)o++;if(h===i)h++}}));t.value=r.join("");t.selectionStart=t.selectionEnd=o;const l=document.createEvent("Event");l.initEvent("input",true,true);t.dispatchEvent(l)}};const h=e=>{if(e.type==="focus"&&t.value!=="")return;let n=[];let r=t.selectionStart;i.forEach(((e,i)=>{if(s[e]){let r=new RegExp(s[e],"i").test(t.value.charAt(i));n.push(r?t.value.charAt(i):"_")}else{n.push(e)}}));t.value=n.join("");t.selectionStart=t.selectionEnd=r};t.addEventListener("keydown",n);t.addEventListener("keypress",r);t.addEventListener("input",h);t.addEventListener("focus",h)}class Ft{constructor(t,e){if(typeof t==="string"){this.element=document.createElement(t)}else{this.element=t}if(e&&this.element.parentElement!==e){e.appendChild(this.element)}}addChild(t,e){const s=Pt(t,this.element);if(e){e(s)}return this}addChildElement(t){if(t){this.element.appendChild(t)}return this}attr(t,e){this.element.setAttribute(t,e);return this}id(t){return this.attr("id",t)}focus(){this.element.focus();return this}title(t){return this.attr("title",t)}data(t,e=null){if(e===null){this.element.removeAttribute("data-"+t);return this}else{return this.attr("data-"+t,e)}}show(){return this.removeStyle("display")}hide(t=true){return t?this.setStyle("display","none"):this}visible(t=true){return t?this.setStyle("visibility","visible"):this.setStyle("visibility","hidden")}isVisible(){return!!(this.element.offsetWidth||this.element.offsetHeight||this.element.getClientRects().length)}addClass(t,...e){if(t){const s=[...t.trim().split(" "),...e];for(let t=0;t<s.length;t++)this.element.classList.add(s[t])}return this}removeClass(t,...e){if(t){const s=[...t.trim().split(" "),...e];for(let t=0;t<s.length;t++)this.element.classList.remove(s[t])}return this}toggleClass(t,e=undefined){if(t){this.element.classList.toggle(t,e)}return this}on(t,e){const s=t.split(" ");for(let t=0;t<s.length;t++){this.element.addEventListener(s[t],e)}return this}off(t,e){const s=t.split(" ");for(let t=0;t<s.length;t++){this.element.removeEventListener(s[t],e)}return this}setStyle(t,e){this.element.style.setProperty(t,e);return this}removeStyle(t){this.element.style.removeProperty(t);return this}text(t){this.element.innerText=t;return this}html(t){this.element.innerHTML=t;return this}clear(){const t=this.element;this.element=document.createElement(this.element.tagName);t.replaceWith(this.element)}addText(t){const e=document.createTextNode(t);this.element.appendChild(e);return this}addHtml(t){this.element.innerHTML+=t;return this}toDOM(){return this.element}appendTo(t){if(t){t.appendChild(this.element)}return this}}class Nt extends Ft{constructor(t,e){if(t){super(t,e)}else{super("textarea",e)}}name(t){this.element.name=t;return this}rows(t){this.element.rows=t;return this}cols(t){this.element.cols=t;return this}value(t){this.element.value=t;return this}}class Lt extends Ft{constructor(t,e){if(t){super(t,e)}else{super("input",e)}}name(t){this.element.name=t;return this}type(t){this.element.type=t;return this}size(t){this.element.size=t;return this}value(t){if(t instanceof Date){this.element.valueAsDate=t}else if(typeof t==="number"){this.element.valueAsNumber=t}else{this.element.value=t}return this}mask(t){Bt(this.element,t);return this}}class Rt extends Ft{constructor(t,e){if(t){super(t,e)}else{super("select",e)}}addOption(t){const e=document.createElement("option");if(typeof t==="string"){e.value=t;e.innerHTML=t}else{e.value=t.value;e.innerHTML=t.title||t.value;e.selected=t.selected||false}this.element.appendChild(e);return this}value(t){this.element.value=t;return this}}function Pt(t,e){if(t==="div"||t instanceof HTMLDivElement){return new Ft(t,e)}if(t==="span"||t instanceof HTMLSpanElement){return new Ft(t,e)}else if(t==="a"||t instanceof HTMLAnchorElement){return new Ft(t,e)}else if(t==="button"||t instanceof HTMLButtonElement){return new Ft(t,e)}else if(t==="img"||t instanceof HTMLImageElement){return new Ft(t,e)}else if(t==="input"||t instanceof HTMLInputElement){return new Lt(t instanceof HTMLInputElement?t:null,e)}else if(t==="textarea"||t instanceof HTMLTextAreaElement){return new Nt(t instanceof HTMLTextAreaElement?t:null,e)}else if(t==="select"||t instanceof HTMLSelectElement){return new Rt(t instanceof HTMLSelectElement?t:null,e)}return new Ft(t,e)}const Ot=typeof TouchEvent!=="undefined";var Qt;(function(t){t["None"]="none";t["Allow"]="allow";t["Forbid"]="forbid"})(Qt||(Qt={}));class qt{constructor(t,e,s){this.dropEffect=Qt.Allow;this.pageX=0;this.pageY=0;this.item=t;this.dragImage=e;this.data=t.data;this.sourceEvent=s;if(s&&s instanceof MouseEvent){this.pageX=s.pageX,this.pageY=s.pageY}if(s&&Ot&&s instanceof TouchEvent&&s.touches[0]){this.pageX=s.touches[0].pageX,this.pageY=s.touches[0].pageY}}}class jt{constructor(t){if(t&&t instanceof MouseEvent){this.x=t.pageX,this.y=t.pageY}if(t&&Ot&&t instanceof TouchEvent&&t.touches[0]){this.x=t.touches[0].pageX,this.y=t.touches[0].pageY}}}class _t{constructor(){this.delta=5;this.draggableItem=null;this.dragImage=null;this.finishedSuccessfully=false;this.mouseDownPosition=null;this.containerDescriptors=[];this.containerDescriptorIndex=-1;this.dropEffect=Qt.None;this.classPrefix="eqjs-drop";this.DRAG_DISABLED_ATTR="drag-disabled"}registerDraggableItem(t){const e=t.element;if(!e){throw Error("Element in draggle item is null or undefined")}e.ondragstart=function(){return false};const s=t=>{if(e.hasAttribute(this.DRAG_DISABLED_ATTR)){return}t.preventDefault();if(t instanceof MouseEvent){t.stopPropagation()}const s=new jt(t);if(Math.abs(s.x-this.mouseDownPosition.x)>this.delta||Math.abs(s.y-this.mouseDownPosition.y)>this.delta){n(t)}};const i=t=>{this.mouseMoveDragListener(t)};const n=n=>{n.preventDefault();n.stopPropagation();e.removeEventListener("mousemove",s);e.removeEventListener("touchmove",s);this.finishedSuccessfully=false;if(t.beforeDragStart)t.beforeDragStart();this.dragImage=Pt("div").setStyle("position","absolute").setStyle("z-index","65530").toDOM();document.body.appendChild(this.dragImage);this.dragImage.appendChild(e.cloneNode(true));if(t.renderer){t.renderer(this.dragImage)}this.dropEffect=Qt.None;this.updateCusror(this.dropEffect);this.updateImageClass(this.dropEffect);this.draggableItem={element:e,scope:t.scope,data:t.data};this.updateDragItemPosition(n);const r=new qt(this.draggableItem,this.dragImage,n);r.dropEffect=this.dropEffect;if(t.onDragStart){t.onDragStart(r)}if(this.dropEffect!==r.dropEffect){this.dropEffect=r.dropEffect;this.updateImageClass(this.dropEffect)}document.addEventListener("mousemove",i,true);document.addEventListener("touchmove",i,true)};const r=t=>{if(Ot&&t instanceof TouchEvent){t.preventDefault()}this.mouseDownPosition=new jt(t);e.addEventListener("mousemove",s);e.addEventListener("touchmove",s);document.addEventListener("mouseup",h);document.addEventListener("touchend",h)};e.addEventListener("mousedown",r);e.addEventListener("touchstart",r);const h=t=>{this.mouseDownPosition=null;e.removeEventListener("mousemove",s);e.removeEventListener("touchmove",s);document.removeEventListener("mousemove",i,true);document.removeEventListener("touchmove",i,true);if(this.draggableItem){o(t)}};const o=e=>{try{if(this.containerDescriptorIndex>=0){const t=this.containerDescriptors[this.containerDescriptorIndex];const s={element:t.element,scopes:t.scopes,data:t.data};const i=new qt(this.draggableItem,this.dragImage,e);try{if(s.scopes.indexOf(this.draggableItem.scope)>=0&&this.dropEffect===Qt.Allow){this.finishedSuccessfully=true;if(t.onDrop){t.onDrop(s,i)}}}finally{if(t.onDragLeave){t.onDragLeave(s,i)}}}}finally{try{const s=new qt(this.draggableItem,this.dragImage,e);s.data.finishedSuccessfully=this.finishedSuccessfully;if(t.onDragEnd){t.onDragEnd(s)}}finally{this.draggableItem=null;if(this.dragImage&&this.dragImage.parentElement){this.dragImage.parentElement.removeChild(this.dragImage)}this.dragImage=null;this.finishedSuccessfully=false;document.removeEventListener("mouseup",h);document.removeEventListener("touchend",h)}}}}registerDropContainer(t){const e=t.element;if(!e){throw Error("Element in drop container is null or undefined")}this.containerDescriptors.push(t)}removeDropContainer(t){const e=this.containerDescriptors.filter((e=>e===t||e.element==t));if(e){for(const t of e){r.removeArrayItem(this.containerDescriptors,t)}}}mouseMoveDragListener(t){if(t instanceof MouseEvent){t.preventDefault()}t.stopPropagation();this.updateDragItemPosition(t);if(this.containerDescriptorIndex==-1){for(let e=0;e<this.containerDescriptors.length;e++){const s=this.containerDescriptors[e];if(this.detectDragEnterEvent(s.element,t)){this.containerDescriptorIndex=e;break}}if(this.containerDescriptorIndex>=0){this.dragEnterEvent(t)}}else{const e=this.containerDescriptors[this.containerDescriptorIndex];if(this.detectDragLeaveEvent(e.element,t)){this.dragLeaveEvent(t);this.containerDescriptorIndex=-1}}if(this.containerDescriptorIndex>=0){const e=this.containerDescriptors[this.containerDescriptorIndex];const s={element:e.element,scopes:e.scopes,data:e.data};if(s.scopes.indexOf(this.draggableItem.scope)>=0){const i=new qt(this.draggableItem,this.dragImage,t);i.dropEffect=this.dropEffect;if(e.onDragOver){e.onDragOver(s,i)}}}}updateCusror(t){switch(t){case Qt.Allow:this.setCursorStyle(this.dragImage,"grabbing");break;case Qt.Forbid:this.setCursorStyle(this.dragImage,"no-drop");break;default:this.setCursorStyle(this.dragImage,"grabbing");break}}updateImageClass(t){this.dragImage.classList.remove(`${this.classPrefix}-allow`);this.dragImage.classList.remove(`${this.classPrefix}-forbid`);this.dragImage.classList.remove(`${this.classPrefix}-none`);switch(t){case Qt.Allow:this.dragImage.classList.add(`${this.classPrefix}-allow`);break;case Qt.None:this.dragImage.classList.add(`${this.classPrefix}-none`);break;case Qt.Forbid:this.dragImage.classList.add(`${this.classPrefix}-forbid`);break;default:this.dragImage.classList.add(`${this.classPrefix}-none`);break}}setCursorStyle(t,e){if(t){t.style.cursor=e;for(let s=0;s<t.children.length;s++){this.setCursorStyle(t.children[s],e)}}}updateDragItemPosition(t){if(this.dragImage){const e=new jt(t);this.dragImage.style.top=e.y-this.dragImage.offsetHeight/2+"px";this.dragImage.style.left=e.x-this.dragImage.offsetWidth/2+"px"}}dragEnterEvent(t){const e=this.containerDescriptors[this.containerDescriptorIndex];const s={element:e.element,scopes:e.scopes,data:e.data};if(s.scopes.indexOf(this.draggableItem.scope)>=0){const i=new qt(this.draggableItem,this.dragImage,t);i.dropEffect=Qt.Allow;if(e.onDragEnter){e.onDragEnter(s,i)}this.dropEffect=i.dropEffect;this.updateCusror(this.dropEffect);this.updateImageClass(this.dropEffect)}else{if(this.dropEffect!==Qt.Forbid){this.dropEffect=Qt.None;this.updateCusror(this.dropEffect);this.updateImageClass(this.dropEffect)}}}dragLeaveEvent(t){const e=this.containerDescriptors[this.containerDescriptorIndex];const s={element:e.element,scopes:e.scopes,data:e.data};if(s.scopes.indexOf(this.draggableItem.scope)>=0){const i=new qt(this.draggableItem,this.dragImage,t);i.dropEffect=Qt.None;if(e.onDragLeave){e.onDragLeave(s,i)}this.dropEffect=i.dropEffect;this.updateCusror(this.dropEffect);this.updateImageClass(this.dropEffect)}}detectDragEnterEvent(t,e){const s=St(t);const i=new jt(e);if(i.y<s.y||i.y>s.y+t.offsetHeight){return false}if(i.x<s.x||i.x>s.x+t.offsetWidth){return false}return true}detectDragLeaveEvent(t,e){const s=St(t);const i=new jt(e);if(i.y>s.y&&i.y<s.y+t.offsetHeight&&i.x>s.x&&i.x<s.x+t.offsetWidth){return false}return true}}const Gt=new _t;var Ht;(function(t){t[t["Always"]=0]="Always";t[t["Once"]=1]="Once";t[t["Never"]=2]="Never"})(Ht||(Ht={}));const Wt=250;const Ut=60;var zt;(function(t){t[t["NONE"]=1]="NONE";t[t["LEFT"]=2]="LEFT";t[t["CENTER"]=3]="CENTER";t[t["RIGHT"]=4]="RIGHT"})(zt||(zt={}));function Vt(t){switch(t){case p.Left:return zt.LEFT;case p.Center:return zt.CENTER;case p.Right:return zt.RIGHT;default:return zt.NONE}}class Jt{constructor(t,e,s=false){this._label=null;this._description=null;this.align=zt.NONE;this.isVisible=true;this.isRowNum=false;this.dataColumn=t;this.grid=e;const i=e.options.columnWidths||{};if(t){if(t.style.alignment){this.align=Vt(t.style.alignment)}this.width=i&&i[this.type]?i[this.type].default:Wt;this._description=t.description}else if(s){this.isRowNum=true;this.width=i&&i.rowNumColumn?i.rowNumColumn.default:Ut;this._label=""}}get label(){return this._label?this._label:this.isRowNum?"":this.dataColumn.label}set label(t){this._label=this.label}get description(){return this._description}get type(){return this.dataColumn?this.dataColumn.type:null}}class Yt{constructor(t,e){this.items=[];this.grid=e;this.sync(t)}sync(t,e=true){this.clear();const s=new Jt(null,this.grid,true);this.add(s);if(!e){s.isVisible=false}if(t){for(let e of t.getItems()){const t=new Jt(e,this.grid);if(this.grid.options.onSyncGridColumn){this.grid.options.onSyncGridColumn(t)}this.add(t)}}}get count(){return this.items.length}add(t){const e=this.items.length;this.items.push(t);return e}put(t,e){if(t>=0&&t<this.items.length){this.items[t]=e}}move(t,e){let s=this.items.indexOf(t);if(s>=0&&s!=e)r.moveArrayItem(this.items,s,e)}get(t){if(t>=0&&t<this.items.length){return this.items[t]}else{return null}}getItems(){return this.items}removeAt(t){this.get(t);this.items.splice(t,1)}clear(){this.items=[]}}const Kt="keg";const Xt=/{0:(.*?)}/g;var Zt;(function(t){t[t["STRING"]=1]="STRING";t[t["NUMBER"]=2]="NUMBER";t[t["DATETIME"]=3]="DATETIME";t[t["BOOL"]=4]="BOOL"})(Zt||(Zt={}));const te=(t,e,s,i)=>{const n=t?t.toString().replace(/\n/g," "):"";s.innerText=n;s.title=n;if(e.align==zt.NONE){s.classList.add(`${Kt}-cell-value-align-left`)}};const ee=(t,e,s,i)=>{let n=(t||"").toString();if(typeof t=="number"){if(e.dataColumn&&e.dataColumn.displayFormat&&Xt.test(e.dataColumn.displayFormat)){n=e.dataColumn.displayFormat.replace(Xt,((e,s)=>a.numberToStr(t,s)))}else{n=t.toLocaleString()}}s.innerText=n;s.title=n;if(e.align==zt.NONE){s.classList.add(`${Kt}-cell-value-align-right`)}};const se=(e,s,i,n)=>{const r=Object.prototype.toString.call(e)==="[object Date]";let h=(e||"").toString();if(r){if(s.dataColumn&&s.dataColumn.displayFormat&&Xt.test(s.dataColumn.displayFormat)){h=s.dataColumn.displayFormat.replace(Xt,((t,i)=>a.dateTimeToStrEx(e,s.type,i)))}else{const i=a.getCurrentLocale();const n={hour:"numeric",minute:"numeric",second:"numeric"};switch(s.type){case t.Date:h=e.toLocaleDateString(i);break;case t.Time:h=e.toLocaleTimeString(i,n);break;case t.DateTime:h=`${e.toLocaleDateString(i)} ${e.toLocaleTimeString(i,n)}`;break}}}i.innerText=h;i.title=h;if(s.align==zt.NONE){i.classList.add(`${Kt}-cell-value-align-right`)}};const ie=(t,e,s,i)=>{if(e.dataColumn&&e.dataColumn.displayFormat&&Xt.test(e.dataColumn.displayFormat)){const i=e.dataColumn.displayFormat.replace(Xt,((e,s)=>a.booleanToStr(t,s)));return te(i,e,s)}else{s.classList.add(`${Kt}-cell-value-bool`);s.classList.add(`${Kt}-${t?"cell-value-true":"cell-value-false"}`)}};class ne{constructor(t){this.renderers={};this.defaultRenderers={};this.registerRenderer("StringDefault",te);this.setDefaultRenderer(Zt.STRING,te);this.registerRenderer("NumberDefault",ee);this.setDefaultRenderer(Zt.NUMBER,ee);this.registerRenderer("DateTimeDefault",se);this.setDefaultRenderer(Zt.DATETIME,se);this.registerRenderer("BoolDefault",ie);this.setDefaultRenderer(Zt.BOOL,ie)}getDefaultRenderer(t){const e=this.getCellType(t);return this.defaultRenderers[Zt[e]]}getDefaultRendererByType(t){return this.defaultRenderers[Zt[t]]}setDefaultRenderer(t,e){if(e){this.defaultRenderers[Zt[t]]=e}}getRenderer(t){return this.renderers[t]}registerRenderer(t,e){this.renderers[t]=e}getCellType(e){switch(e){case t.Autoinc:case t.Byte:case t.Word:case t.Currency:case t.Float:case t.Int32:case t.Int64:return Zt.NUMBER;case t.Date:case t.DateTime:case t.Time:return Zt.DATETIME;case t.Bool:return Zt.BOOL;default:return Zt.STRING}}}const re=36;class he{constructor(t){this.cssPrefix="keg";this.pagination={page:1,pageSize:30,total:0};this.paginationOptions={maxButtonCount:10,useBootstrap:false};this.defaultDataGridOptions={slot:null,dataTable:null,fixHeightOnFirstRender:false,syncGridColumns:true,useRowNumeration:true,allowDragDrop:false,aggregates:{settings:null,calculatorRef:null},paging:{enabled:true,pageSize:30,pageSizeItems:[20,30,50,100,200]},columnWidths:{autoResize:Ht.Always,stringColumns:{min:100,max:500,default:250},numberColumns:{min:60,default:120},boolColumns:{min:50,default:80},dateColumns:{min:80,default:200},otherColumns:{min:100,max:500,default:250},rowNumColumn:{min:40,default:60}},showPlusButton:false,viewportRowsCount:null,showActiveRow:true};this.rowsOnPagePromise=null;this.containerInitialHeight=0;this.firstRender=true;this.prevRowTotals=null;this.landingIndex=-1;this.landingSlot=Pt("div").addClass(`${this.cssPrefix}-col-landing-slot`).addChildElement(Pt("div").toDOM()).toDOM();this._activeRowIndex=-1;if(t&&t.paging){t.paging=r.assign(this.defaultDataGridOptions.paging,t.paging)}this.options=this.mergeOptions(t);this.processColumnWidthsOptions();if(!this.options.slot)throw Error('"slot" parameter is required to initialize EasyDataGrid');if(!this.options.dataTable)throw Error('"dataTable" parameter is required to initialize EasyDataGrid');this.dataTable=t.dataTable;this.eventEmitter=new C(this);this.cellRendererStore=new ne(t);this.columns=new Yt(this.dataTable.columns,this);this.setSlot(this.options.slot);this.init(this.options)}mergeOptions(t){const e=r.assignDeep({},this.defaultDataGridOptions.aggregates,t.aggregates);const s=r.assignDeep({},this.defaultDataGridOptions.columnWidths,t.columnWidths);const i=r.assignDeep({},this.defaultDataGridOptions.paging,t.paging);const n=r.assign({},this.defaultDataGridOptions,t);n.aggregates=e;n.columnWidths=s;n.paging=i;return n}processColumnWidthsOptions(){const e=this.options.columnWidths;if(!e)return;r.getStringDataTypes().forEach((t=>{e[t]=Object.assign(Object.assign({},e.stringColumns),e[t])}));r.getNumericDataTypes().forEach((t=>{e[t]=Object.assign(Object.assign({},e.numberColumns),e[t])}));e[t.Bool]=Object.assign(Object.assign({},e.boolColumns),e[t.Bool]);r.getDateDataTypes().forEach((t=>{e[t]=Object.assign(Object.assign({},e.dateColumns),e[t])}));const s=[...r.getStringDataTypes(),...r.getNumericDataTypes(),...r.getDateDataTypes(),t.Bool];r.getAllDataTypes().forEach((t=>{if(!(t in s)){e[t]=Object.assign(Object.assign({},e.otherColumns),e[t])}}));e[t.Unknown]=e.otherColumns}setSlot(t){if(typeof t==="string"){if(t.length){if(t[0]==="#"){this.slot=document.getElementById(t.substring(1))}else if(t[0]==="."){const e=document.getElementsByClassName(t.substring(1));if(e.length)this.slot=e[0]}else{throw Error("Unrecognized slot parameter "+"(Must be id, class or HTMLElement): "+t)}}}else{this.slot=t}}init(t){if(t.onInit){this.addEventListener("init",t.onInit)}if(t.onRowClick){this.addEventListener("rowClick",t.onRowClick)}if(t.onRowDbClick){this.addEventListener("rowDbClick",t.onRowDbClick)}if(t.onPlusButtonClick){this.addEventListener("plusButtonClick",t.onPlusButtonClick)}if(t.onColumnChanged){this.addEventListener("columnChanged",t.onColumnChanged)}if(t.onColumnDeleted){this.addEventListener("columnDeleted",t.onColumnDeleted)}if(t.onColumnMoved){this.addEventListener("columnMoved",t.onColumnMoved)}if(t.onPageChanged){this.addEventListener("pageChanged",t.onPageChanged)}if(t.onActiveRowChanged){this.addEventListener("activeRowChanged",t.onActiveRowChanged)}this.addEventListener("pageChanged",(t=>this.activeRowIndex=-1));r.assign(this.paginationOptions,t.pagination);this.pagination.pageSize=this.options.paging.pageSize||this.pagination.pageSize;if(this.options.allowDragDrop){Gt.registerDropContainer({element:this.slot,scopes:["gridColumnMove"],onDragEnter:(t,e)=>{this.slot.classList.add(`${Mt}-drophover`);this.showLandingSlot(e.pageX,e.pageY)},onDragOver:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragLeave:(t,e)=>{e.dropEffect=Qt.Forbid;this.slot.classList.remove(`${Mt}-drophover`);this.hideLandingSlot()},onDrop:(t,e)=>{this.dataTable.columns.move(e.data.column,this.landingIndex);this.refresh();this.fireEvent({type:"columnMoved",columnId:e.data.column.id,newIndex:this.landingIndex})}})}this.refresh();this.fireEvent("init")}fireEvent(t){if(typeof t==="string"){this.eventEmitter.fire(t)}else{this.eventEmitter.fire(t.type,t)}}setData(t){this.dataTable=t;this.clear();this.refresh()}getData(){return this.dataTable}getColumns(){return this.columns}destroy(){this.slot.innerHTML=""}refresh(){this.clearDOM();this.render()}clearDOM(){this.slot.innerHTML=""}clear(){this.pagination.page=1;this.clearDOM()}render(){if(!this.hasData()&&!this.options.showPlusButton)return;this.containerInitialHeight=this.slot.clientHeight;this.rootDiv=document.createElement("div");this.rootDiv.style.width="100%";this.rootDiv.classList.add(`${this.cssPrefix}-root`);this.columns.sync(this.dataTable.columns,this.options.useRowNumeration);this.renderHeader();this.rootDiv.appendChild(this.headerDiv);this.renderBody();this.rootDiv.appendChild(this.bodyDiv);this.renderFooter();this.rootDiv.appendChild(this.footerDiv);let t=document.createElement("div");t.classList.add(`${this.cssPrefix}-container`);t.appendChild(this.rootDiv);this.slot.appendChild(t);const e=this.options.columnWidths.autoResize!==Ht.Never;if(this.rowsOnPagePromise){this.rowsOnPagePromise.then((()=>this.updateHeight())).then((()=>{this.firstRender=false;this.rowsOnPagePromise=null}))}else{setTimeout((()=>{this.updateHeight().then((()=>{this.firstRender=false;if(e){this.resizeColumns()}}))}),100)}}updateHeight(){return new Promise((t=>{if(this.options.viewportRowsCount){const e=this.bodyCellContainerDiv.firstElementChild;const s=e?e.offsetHeight:re;const i=this.options.viewportRowsCount;let n=s*i;Pt(this.bodyViewportDiv).setStyle("height",`${n}px`);setTimeout((()=>{const e=this.bodyViewportDiv.offsetHeight-this.bodyViewportDiv.clientHeight;n=n+e;Pt(this.bodyViewportDiv).setStyle("height",`${n}px`);t()}),100);return}t()})).then((()=>{if(this.options.fixHeightOnFirstRender&&this.firstRender){this.slot.style.height=`${this.slot.offsetHeight}px`}}))}getContainerWidth(){return this.columns.getItems().filter((t=>t.isVisible)).map((t=>t.width)).reduce(((t,e)=>t+e))}renderHeader(){this.headerDiv=Pt("div").addClass(`${this.cssPrefix}-header`).toDOM();this.headerViewportDiv=Pt("div",this.headerDiv).addClass(`${this.cssPrefix}-header-viewport`).toDOM();this.headerCellContainerDiv=Pt("div",this.headerViewportDiv).addClass(`${this.cssPrefix}-header-cell-container`).toDOM();this.headerRowDiv=Pt("div",this.headerCellContainerDiv).addClass(`${this.cssPrefix}-header-row`).toDOM();this.columns.getItems().forEach(((t,e)=>{if(!t.isVisible){return}let s=this.renderColumnHeader(t,e);this.headerRowDiv.appendChild(s);if(t.isRowNum){Pt(s).addChildElement(this.renderHeaderButtons())}}));const t=this.getContainerWidth();Pt(this.headerCellContainerDiv).setStyle("width",`${t}px`)}hasData(){return this.dataTable.columns.count>0}renderColumnHeader(t,e){let s=Pt("div").addClass(`${this.cssPrefix}-header-cell`).data("col-idx",`${e}`).setStyle("width",`${t.width}px`);if(t.dataColumn){s.data("col-id",`${t.dataColumn.id}`)}let i=s.toDOM();Pt("div",i).addClass(`${this.cssPrefix}-header-cell-resize`);if(!t.isRowNum){Pt("div",i).addClass(`${this.cssPrefix}-header-cell-label`).text(t.label)}if(t.description){Pt("div",i).addClass("question-mark").title(t.description)}if(this.options.allowDragDrop){Gt.registerDraggableItem({element:i,scope:"gridColumnMove",data:{column:t},renderer:e=>{e.innerHTML="";const s=document.createElement("div");s.innerText=t.label;e.classList.add(`${this.cssPrefix}-sortable-helper`);e.appendChild(s)},onDragStart:t=>{t.dropEffect=Qt.Allow}})}return i}renderBody(){this.bodyDiv=Pt("div").addClass(`${this.cssPrefix}-body`).toDOM();this.bodyViewportDiv=Pt("div",this.bodyDiv).addClass(`${this.cssPrefix}-body-viewport`).attr("tabIndex","0").toDOM();this.bodyCellContainerDiv=Pt("div",this.bodyViewportDiv).addClass(`${this.cssPrefix}-cell-container`).toDOM();const t=this.canShowAggregates();if(this.dataTable){this.showProgress();this.rowsOnPagePromise=this.getRowsToRender().then((e=>{this.pagination.total=this.dataTable.getTotal();this.hideProgress();this.bodyCellContainerDiv.innerHTML="";this.prevRowTotals=null;let s=0;if(e.length){const i=t?this.options.aggregates.settings.getGroups():[];s=e.length<this.pagination.pageSize?e.length:this.pagination.pageSize;e.forEach(((e,n)=>{if(t)this.updateTotalsState(i,e);if(n<s){const t=this.renderRow(e,n);this.bodyCellContainerDiv.appendChild(t)}}));const n=this.options.aggregates&&this.options.aggregates.showGrandTotalsOnEachPage;if(t&&(this.isLastPage()||n)){const t=new b(this.dataTable.columns,new Array(this.dataTable.columns.count));this.updateTotalsState(i,t,true)}}const i=this.options.columnWidths.autoResize!==Ht.Never;if(i){this.resizeColumns()}else{const t=this.getContainerWidth();Pt(this.bodyCellContainerDiv).setStyle("width",`${t}px`)}return s})).catch((t=>{console.error(t);return 0}))}this.bodyViewportDiv.addEventListener("scroll",(t=>{Pt(this.headerViewportDiv).setStyle("margin-left",`-${this.bodyViewportDiv.scrollLeft}px`)}));this.bodyViewportDiv.addEventListener("keydown",this.onViewportKeydown.bind(this))}isLastPage(){if(this.dataTable.elasticChunks){return this.dataTable.totalIsKnown()&&this.pagination.page*this.pagination.pageSize>=this.pagination.total}return this.pagination.page*this.pagination.pageSize>=this.pagination.total}canShowAggregates(){if(!this.options||!this.options.aggregates||!this.options.aggregates.settings)return false;const t=this.options.aggregates.settings;const e=(t.hasAggregates()||t.hasRecordCount())&&(t.hasGroups()||t.hasGrandTotals());return e}updateTotalsState(t,e,s=false){const i=this.options.aggregates.settings;if(this.prevRowTotals&&i.hasGroups()){let s=-1;for(let n=1;n<=t.length;n++){const r=t[n-1];for(const t of r.columns){if(!i.compareValues(this.prevRowTotals.getValue(t),e.getValue(t))){s=n;break}}if(s!==-1)break}if(s!==-1){for(let e=t.length;e>=s;e--){const t=new b(this.dataTable.columns,this.prevRowTotals.toArray());const s=this.renderTotalsRow(e,t);this.bodyCellContainerDiv.appendChild(s)}}}if(s&&i.hasGrandTotals()&&i.hasAggregates()){const t=this.renderTotalsRow(0,e);this.bodyCellContainerDiv.appendChild(t)}this.prevRowTotals=e}applyGroupColumnTemplate(t,e,s){let i=t.replace(/{{\s*GroupValue\s*}}/g,e?`${e}`:"-");i=i.replace(/{{\s*GroupCount\s*}}/g,s?`${s}`:"-");return i}renderTotalsRow(t,e){const s=this.options.aggregates.settings;const i=t>0?s.getGroups()[t-1]:{columns:[],aggregates:s.getAggregates()};const n=Pt("div").addClass(`${this.cssPrefix}-row`).addClass(`${this.cssPrefix}-row-totals`).addClass(`${this.cssPrefix}-totals-lv${t}`).data("totals-level",`${t}`).attr("tabindex","-1");const r=n.toDOM();this.columns.getItems().forEach(((t,s)=>{if(!t.isVisible){return}let n="";const h=!t.isRowNum?this.dataTable.columns.getIndex(t.dataColumn.id):-1;if(!t.isRowNum&&t.dataColumn){if(i.columns.indexOf(t.dataColumn.id)>=0){n=e.getValue(h)}}if(h==this.dataTable.columns.count-1){n=".  .  .  .  .  ."}r.appendChild(this.renderCell(t,s,n,r))}));const h=this.options.aggregates.calculatorRef.getAggrContainer();const o=s.getAggregates().map((t=>t.colId));const l=s.buildGroupKey(i,e);h.getAggregateData(t,l).then((n=>{for(const t of o){e.setValue(t,n[t])}r.innerHTML="";this.columns.getItems().forEach(((h,l)=>{if(!h.isVisible){return}let a="";const u=!h.isRowNum?this.dataTable.columns.getIndex(h.dataColumn.id):-1;if(!h.isRowNum){let c=false;if(h.dataColumn){const s=i.columns.indexOf(h.dataColumn.id);const n=o.indexOf(h.dataColumn.id);if(t>0){c=s==i.columns.length-1}else{c=u==0}if(s>=0||n>=0){a=e.getValue(u)}}let f="";if(t>0){f=h.dataColumn.groupFooterColumnTemplate;if(!f&&s.hasRecordCount()&&c){f="{{GroupValue}} ({{GroupCount}})"}}if(f){const t=this.renderCell(h,l,a,r);const e=t.firstChild;a=e.innerHTML;a=this.applyGroupColumnTemplate(f,a,n[s.COUNT_FIELD_NAME])}}const c=this.renderCell(h,l,a,r);r.appendChild(c)}))})).catch((t=>console.error(t)));return r}onViewportKeydown(t){if(this.options.showActiveRow){const e=this.bodyCellContainerDiv.querySelectorAll(`.${this.cssPrefix}-row`).length;let s;switch(t.key){case"ArrowLeft":break;case"ArrowRight":break;case"ArrowUp":t.preventDefault();s=this.activeRowIndex<0||this.activeRowIndex>=e?e-1:this.activeRowIndex-1;this.activeRowIndex=s>=0?s:0;break;case"ArrowDown":t.preventDefault();s=this.activeRowIndex<0||this.activeRowIndex>=e?0:this.activeRowIndex+1;this.activeRowIndex=s<e?s:e-1;break}}}ensureRowVisibility(t){const e=typeof t==="number"?this.getDataRow(t):t;if(e){let t=e.getBoundingClientRect();const s=this.bodyViewportDiv.getBoundingClientRect();const i=t.top-s.top;const n=t.bottom-s.top;const r=this.bodyViewportDiv.clientHeight;const h=window.innerHeight||document.documentElement.clientHeight;if(i>0&&n<=r&&t.top>0&&t.bottom<h){return}if(i<0){this.bodyViewportDiv.scrollTop=this.bodyViewportDiv.scrollTop+i}else if(n>r){this.bodyViewportDiv.scrollTop=this.bodyViewportDiv.scrollTop+n-r}t=e.getBoundingClientRect();if(t.top<0){document.documentElement.scrollTop=document.documentElement.scrollTop+t.top}else if(t.bottom>h){document.documentElement.scrollTop=document.documentElement.scrollTop+t.bottom-h}}}getRowsToRender(){if(this.options.paging.enabled===false){return Promise.resolve(this.dataTable.getCachedRows())}return this.dataTable.getRows({offset:(this.pagination.page-1)*this.pagination.pageSize,limit:this.pagination.pageSize+1}).catch((t=>{console.error(t);return[]}))}renderFooter(){this.footerDiv=Pt("div").addClass(`${this.cssPrefix}-footer`).toDOM();if(this.rowsOnPagePromise){this.rowsOnPagePromise.then((t=>{this.footerDiv.innerHTML="";this.footerPaginateDiv=this.renderPageNavigator();this.footerDiv.appendChild(this.footerPaginateDiv);const e=this.renderPageInfoBlock(t);this.footerDiv.appendChild(e)}))}}renderPageInfoBlock(t){const e=Pt("div").addClass(`${this.cssPrefix}-page-info`).toDOM();const s=this.dataTable.getTotal();if(s>0){const s=t?(this.pagination.page-1)*this.pagination.pageSize+1:0;const i=t?s+t-1:0;let n=this.dataTable.getTotal().toString();if(this.dataTable.elasticChunks){const t=this.dataTable.getCachedCount();const e=this.dataTable.getTotal();if(t!==e)n="?"}e.innerHTML=a.getText("GridPageInfo").replace("{FirstPageRecordNum}",`<span>${s.toString()}</span>`).replace("{LastPageRecordNum}",`<span>${i.toString()}</span>`).replace("{Total}",`<span>${n}</span>`)}return e}showProgress(){}hideProgress(){}getLocalIndexByGlobal(t){if(this.pagination){return t%this.pagination.pageSize}else{return t}}getGlobalIndexByLocal(t){if(this.pagination){return(this.pagination.page-1)*this.pagination.pageSize+t}else{return t}}renderRow(t,e){let s=this.getGlobalIndexByLocal(e);let i=Pt("div").addClass(`${this.cssPrefix}-row`).addClass(`${this.cssPrefix}-row-${e%2==1?"odd":"even"}`).data("row-idx",`${s}`).attr("tabindex","-1").on("click",(s=>{this.activeRowIndex=e;this.fireEvent({type:"rowClick",row:t,rowIndex:e,sourceEvent:s})})).on("dblclick",(s=>{this.fireEvent({type:"rowDbClick",row:t,rowIndex:e,sourceEvent:s})}));if(e==0){i.addClass(`${this.cssPrefix}-row-first`)}let n=i.toDOM();if(this.options.showActiveRow&&e==this.activeRowIndex){i.addClass(`${this.cssPrefix}-row-active`)}this.columns.getItems().forEach(((e,i)=>{if(!e.isVisible){return}const r=e.isRowNum?-1:this.dataTable.columns.getIndex(e.dataColumn.id);let h=e.isRowNum?s+1:t.getValue(r);n.appendChild(this.renderCell(e,i,h,n))}));return n}renderCell(t,e,s,i){const n=Pt("div").addClass(`${this.cssPrefix}-cell`).data("col-idx",`${e}`).attr("tabindex","-1").setStyle("width",`${t.width}px`);if(t.align==zt.LEFT){n.addClass(`${this.cssPrefix}-cell-align-left`)}else if(t.align==zt.RIGHT){n.addClass(`${this.cssPrefix}-cell-align-right`)}else if(t.align==zt.CENTER){n.addClass(`${this.cssPrefix}-cell-align-center`)}const r=n.toDOM();const h=r.appendChild(Pt("div").addClass(`${this.cssPrefix}-cell-value`).toDOM());const o=this.getCellRenderer(t);if(o){o(s,t,h,i)}return r}getCellRenderer(t){let e;if(t.isRowNum){e=this.cellRendererStore.getDefaultRendererByType(Zt.NUMBER)}else{e=this.cellRendererStore.getDefaultRenderer(t.type)}if(this.options&&this.options.onGetCellRenderer){e=this.options.onGetCellRenderer(t,e)||e}return e}setPage(t){this.pagination.page=t;this.fireEvent({type:"pageChanged",page:t});this.refresh();this.bodyViewportDiv.focus()}renderPageNavigator(){let t=document.createElement("div");t.className=`${this.cssPrefix}-pagination-wrapper`;const e=this.dataTable.getTotal();const s=this.dataTable.getTotal();const i=this.pagination.pageSize;const n=Math.ceil(s/i);const r=8,h=3;const o=this.paginationOptions.useBootstrap?"":`${this.cssPrefix}-`;if(!this.options.paging||!this.options.paging.enabled||e<=i){return t}const l=t=>{const e=t.target;if(e.hasAttribute("data-page")){const t=parseInt(e.getAttribute("data-page"));this.setPage(t)}};const u=(t,e,s,i,n,r)=>{const h=document.createElement("li");h.className=`${o}page-item`;if(!i){if(n){h.className+=" active"}const s=document.createElement("a");s.setAttribute("href","javascript:void(0)");s.innerHTML=e||t.toString();s.setAttribute("data-page",`${t}`);s.className=`${o}page-link`;s.addEventListener("click",l);if(r){s.setAttribute("title",r)}h.appendChild(s);return h}let a=document.createElement("span");a.setAttribute("aria-hidden","true");a.className=`${o}page-link`;if(s){h.className+=" disabled"}else{if(this.paginationOptions.useBootstrap){a=document.createElement("a");a.setAttribute("href","javascript:void(0)");a.setAttribute("data-page",`${t}`)}else{let e=document.createElement("a");e.setAttribute("href","javascript:void(0)");e.setAttribute("data-page",`${t}`);a=e}a.className=`${o}page-link`;a.addEventListener("click",l)}a.innerHTML=e;if(r){a.setAttribute("title",r)}h.appendChild(a);return h};const c=this.pagination.page||1;let f=document.createElement("ul");f.className=`${o}pagination`;f.style.userSelect="none";t.appendChild(f);if(this.dataTable.elasticChunks){let t=u(c-1,"&laquo;",c==1,true,false);f.appendChild(t);t=u(c+1,"&raquo;",this.isLastPage(),true,false);f.appendChild(t)}else{if(n>10){f.appendChild(u(c-10,"&laquo;",c<=10,true,false,"Jump left on 10 pages"))}f.appendChild(u(c-1,"&lsaquo;",c==1,true,false,"Prev Page"));f.appendChild(u(1,"1",c==1,false,c===1));if(n<=10){for(let t=2;t<n;t++){f.appendChild(u(t,`${t}`,c===t,false,c===t))}}else{if(c<r){for(let t=2;t<=r;t++){f.appendChild(u(t,`${t}`,false,false,c===t))}if(n>r){f.appendChild(u(-1,`...`,true,true,false))}}else if(c<=n&&c>n-r+1){if(n>r){f.appendChild(u(-1,`...`,true,true,false))}for(let t=n-r+1;t<n;t++){f.appendChild(u(t,`${t}`,c===t,false,c===t))}}else{f.appendChild(u(-1,`...`,true,true,false));for(let t=h;t>0;t--){f.appendChild(u(c-t,`${c-t}`,false,false,false))}f.appendChild(u(c,`${c}`,false,false,true));for(let t=1;t<=h;t++){f.appendChild(u(c+t,`${c+t}`,false,false,false))}f.appendChild(u(-1,`...`,true,true,false))}}if(n>1||c<n){f.appendChild(u(n,`${n}`,c===n,false,c===n))}f.appendChild(u(c+1,"&rsaquo;",c==n,true,false,"Next Page"));if(n>10){f.appendChild(u(c+10,"&raquo;",c>=n-10,true,false,"Jump right on 10 pages"))}}if(this.options.paging.allowPageSizeChange){const e=t=>{const e=parseInt(t.target.value);this.pagination.pageSize=e;this.pagination.page=1;this.refresh()};const s=document.createElement("div");s.className=`${this.cssPrefix}-page-sizes`;const i=document.createElement("div");i.className=`kfrm-select ${this.cssPrefix}-page-sizes-select`;s.appendChild(i);const n=document.createElement("select");const r=this.options.paging.pageSizeItems||[];const h=new Set(r);h.add(this.options.paging.pageSize||20);Array.from(h).forEach((t=>{const e=document.createElement("option");e.value=t.toString();e.text=t.toString();n.appendChild(e)}));n.value=(this.pagination.pageSize||20).toString();i.appendChild(n);n.addEventListener("change",e);const o=document.createElement("div");o.className=`${this.cssPrefix}-page-sizes-label`;s.appendChild(o);const l=document.createElement("span");l.innerText=a.getText("GridItemsPerPage");o.appendChild(l);t.appendChild(s)}return t}addEventListener(t,e){return this.eventEmitter.subscribe(t,(t=>e(t.data)))}removeEventListener(t,e){this.eventEmitter.unsubscribe(t,e)}renderHeaderButtons(){if(this.options.showPlusButton){return Pt("div").addClass(`${this.cssPrefix}-header-btn-plus`).title(this.options.plusButtonTitle||"Add").addChild("a",(t=>t.attr("href","javascript:void(0)").on("click",(t=>{t.preventDefault();this.fireEvent({type:"plusButtonClick",sourceEvent:t})})))).toDOM()}return Pt("span").addText("#").toDOM()}showLandingSlot(t,e){const s=this.headerRowDiv.querySelectorAll(`[class*=${this.cssPrefix}-table-col]`);const i=[];for(let t=1;t<s.length;t++){const e=s[t];if(e.style.display==="none")continue;i.push(e)}if(i.length===0){this.landingIndex=0;this.headerRowDiv.appendChild(this.landingSlot);return}const n=St(this.landingSlot);if(t>=n.x&&t<=n.x+this.landingSlot.offsetWidth){return}let r=this.landingIndex;for(let e of i){const s=St(e);const i=e.offsetWidth;if(t>s.x&&t<s.x+i){r=parseInt(e.getAttribute("data-col-idx"))-1}}if(r!=this.landingIndex){this.landingIndex=r;if(this.landingIndex<i.length){this.headerRowDiv.insertBefore(this.landingSlot,i[this.landingIndex])}else{this.headerRowDiv.appendChild(this.landingSlot)}}}hideLandingSlot(){this.landingIndex=-1;setTimeout((()=>{if(this.landingSlot.parentElement){this.landingSlot.parentElement.removeChild(this.landingSlot)}}),10)}get activeRowIndex(){return this._activeRowIndex}set activeRowIndex(t){if(t!==this._activeRowIndex){const e=this._activeRowIndex;this._activeRowIndex=t;this.updateActiveRow();this.fireEvent({type:"activeRowChanged",oldValue:e,newValue:this.activeRowIndex,rowIndex:this.getGlobalIndexByLocal(this.activeRowIndex)})}}updateActiveRow(){if(this.options.showActiveRow){const t=this.bodyCellContainerDiv.querySelectorAll(`[class*=${this.cssPrefix}-row-active]`);t.forEach((t=>{t.classList.remove(`${this.cssPrefix}-row-active`)}));const e=this.getActiveRow();if(e){e.classList.add(`${this.cssPrefix}-row-active`);this.ensureRowVisibility(this.activeRowIndex)}}}getActiveRow(){return this.getDataRow(this.activeRowIndex)}getDataRow(t){const e=Array.from(this.bodyCellContainerDiv.querySelectorAll(`.${this.cssPrefix}-row:not(.${this.cssPrefix}-row-totals)`));if(t>=0&&t<e.length)return e[t];return null}focus(){this.bodyViewportDiv.focus()}resizeColumns(){if(this.options.columnWidths.autoResize===Ht.Never)return;const t=this.bodyCellContainerDiv.style.width;this.bodyCellContainerDiv.style.visibility="hidden";this.bodyCellContainerDiv.style.width="1px";this.headerRowDiv.style.width="1px";let e=0;const s=this.columns.getItems();const i=this.headerCellContainerDiv.querySelectorAll(`.${this.cssPrefix}-header-cell`);let n=0;for(let t=0;t<this.columns.count;t++){const h=s[t];if(!h.isVisible)continue;const o=this.options.columnWidths.autoResize!==Ht.Always&&h.dataColumn?h.dataColumn.calculatedWidth:0;const l=this.bodyCellContainerDiv.querySelectorAll(`.${this.cssPrefix}-cell[data-col-idx="${t}"] > .${this.cssPrefix}-cell-value`);let a=0;if(o>0){e+=o;h.width=o;l.forEach((t=>{t.parentElement.style.width=`${o}px`}));i[n].style.width=`${o}px`}else{if(l.length==0){i[n].style.width=null;i[n].style.whiteSpace="nowrap"}a=i[n].offsetWidth;if(l.length>0){l.forEach((t=>{t.parentElement.style.width=null;const e=t.parentElement.offsetWidth;if(e>a){a=e}}));a+=3;const t=h.isRowNum?this.options.columnWidths.rowNumColumn.max||500:this.options.columnWidths[h.dataColumn.type].max||2e3;const s=h.isRowNum?this.options.columnWidths.rowNumColumn.min||0:this.options.columnWidths[h.dataColumn.type].min||20;if(a>t){a=t}if(a<s){a=s}if(r.isNumericType(h.type)){a=Math.round(a*1.3)}e+=a;h.width=a;l.forEach((t=>{t.parentElement.style.width=`${a}px`}));i[n].style.width=`${a}px`;if(h.dataColumn){h.dataColumn.calculatedWidth=a}}else{e+=a}}n++}if(e>0){this.bodyCellContainerDiv.style.width=`${e}px`;this.headerCellContainerDiv.style.width=`${e}px`}else{this.bodyCellContainerDiv.style.width=t;this.headerCellContainerDiv.style.width=t}this.bodyCellContainerDiv.style.visibility=null;this.headerRowDiv.removeAttribute("style")}}class oe{get cssPrefix(){return"kdtp-cal"}constructor(t,e){this.slot=t;this.options=e||{};if(!this.options.yearRange){this.options.yearRange="c-10:c+10"}}setDate(t){this.currentDate=new Date(t)}getDate(){return new Date(this.currentDate)}dateChanged(t){if(this.options.onDateChanged){this.options.onDateChanged(this.currentDate,t)}}}class le{get cssPrefix(){return"kdtp"}constructor(t){this.calendar=null;this.timePicker=null;this.options=t;this.render()}setDateTime(t){this.currentDateTime=new Date(t);if(this.calendar){this.calendar.setDate(this.currentDateTime)}if(this.timePicker){this.timePicker.setTime(this.currentDateTime)}}getDateTime(){return new Date(this.currentDateTime)}render(){if(this.options.showCalendar){this.calendar=this.createCalendar({yearRange:this.options.yearRange,showDateTimeInput:this.options.showDateTimeInput,timePickerIsUsed:this.options.showTimePicker,oneClickDateSelection:this.options.oneClickDateSelection,onDateChanged:(t,e)=>{this.currentDateTime=t;if(this.timePicker){this.timePicker.setTime(this.currentDateTime)}if(this.options.showTimePicker){this.dateTimeChanged()}if(e){this.apply(this.currentDateTime)}}});if(this.calendar)this.calendar.render()}if(this.options.showTimePicker){this.timePicker=this.createTimePicker({onTimeChanged:t=>{this.currentDateTime.setHours(t.getHours());this.currentDateTime.setMinutes(t.getMinutes());if(this.calendar){this.calendar.setDate(this.currentDateTime)}this.dateTimeChanged()}});if(this.timePicker)this.timePicker.render()}this.setDateTime(new Date)}createCalendar(t){return null}createTimePicker(t){return null}show(t){if(this.options.beforeShow){this.options.beforeShow()}const e=St(t||document.body);this.slot.style.top=e.y+t.clientHeight+"px";this.slot.style.left=e.x+"px"}apply(t){if(this.options.onApply){this.options.onApply(t)}this.destroy()}cancel(){if(this.options.onCancel){this.options.onCancel()}this.destroy()}destroy(){if(this.slot&&this.slot.parentElement){this.slot.parentElement.removeChild(this.slot)}}dateTimeChanged(){if(this.options.onDateTimeChanged){this.options.onDateTimeChanged(this.currentDateTime)}}}class ae extends oe{constructor(t,e){super(t,e);this.daysOfWeek=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];this.months=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];this.calendarBody=null;this.isManualInputChanging=false;for(let t=0;t<this.daysOfWeek.length;t++){this.daysOfWeek[t]=a.getShortWeekDayName(t+1)}for(let t=0;t<this.months.length;t++){this.months[t]=a.getLongMonthName(t+1)}}setDate(t){super.setDate(t);this.selectedMonth=this.currentDate.getMonth();this.selectedYear=this.currentDate.getFullYear();this.rerenderMonth()}render(){const t=Pt("div",this.slot).addClass(`${this.cssPrefix}-header`);if(this.options.showDateTimeInput){t.addChildElement(this.renderManualDateInput())}else{t.addChild("span",(t=>this.headerTextElem=t.toDOM()))}Pt(this.slot).addChildElement(this.renderCalendarButtons());this.calendarBody=Pt("div",this.slot).addClass(`${this.cssPrefix}-body`).toDOM()}getInputDateFormat(){const t=a.getLocaleSettings();return this.options.timePickerIsUsed?`${t.editDateFormat} ${t.editTimeFormat}`:t.editDateFormat}renderManualDateInput(){const t=this.getInputDateFormat();const e=Pt("input").attr("placeholder",t).addClass(`${this.cssPrefix}-header-input`);e.mask(t.replace("yyyy","9999").replace("MM","99").replace("dd","99").replace("HH","99").replace("mm","99").replace("ss","99")).on("input",(s=>{e.removeClass("error");try{this.isManualInputChanging=true;const e=r.strToDateTime(this.manualInputElem.value,t);this.currentDate=e;this.jump(this.currentDate.getFullYear(),this.currentDate.getMonth());this.dateChanged(false)}catch(t){e.addClass("error")}finally{this.isManualInputChanging=false}})).on("keydown",(t=>{if(t.keyCode===13){t.preventDefault();t.stopPropagation();if(this.manualInputElem.className.indexOf("error")<0&&!this.isManualInputChanging)this.dateChanged(true)}})).on("focus",(()=>{setTimeout((()=>{this.manualInputElem.selectionStart=0;this.manualInputElem.selectionEnd=0}),50)}));this.manualInputElem=e.toDOM();return this.manualInputElem}updateDisplayedDateValue(){if(this.manualInputElem){if(!this.isManualInputChanging){const t=this.getInputDateFormat();this.manualInputElem.value=a.dateTimeToStr(this.currentDate,t);this.manualInputElem.focus()}}else if(this.headerTextElem){const t=a.getCurrentLocale();this.headerTextElem.innerText=this.currentDate.toLocaleString(t=="en"?undefined:t,{year:"numeric",month:"long",day:"numeric"})}}renderCalendarButtons(){const t=Pt("nav").addClass(`${this.cssPrefix}-nav`).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-prev`).on("click",(()=>{this.prev()})).addChild("span",(t=>t.html("&lsaquo;"))))).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-selectors`).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-month`).addChild("select",(t=>{t.on("change",(()=>{this.jump(this.selectedYear,parseInt(this.selectMonthElem.value))}));for(let e=0;e<this.months.length;e++){t.addChild("option",(t=>t.attr("value",e.toString()).text(this.months[e])))}this.selectMonthElem=t.toDOM()})))).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-year`).addChild("select",(t=>this.selectYearElem=t.on("change",(()=>{this.jump(parseInt(this.selectYearElem.value),this.selectedMonth)})).toDOM())))))).addChild("div",(t=>t.addClass(`${this.cssPrefix}-nav-next`).on("click",(()=>{this.next()})).addChild("span",(t=>t.html("&rsaquo;")))));return t.toDOM()}prev(){this.selectedYear=this.selectedMonth===0?this.selectedYear-1:this.selectedYear;this.selectedMonth=this.selectedMonth===0?11:this.selectedMonth-1;this.rerenderMonth()}next(){this.selectedYear=this.selectedMonth===11?this.selectedYear+1:this.selectedYear;this.selectedMonth=(this.selectedMonth+1)%12;this.rerenderMonth()}rerenderSelectYear(){const t=/c-(\d*):c\+(\d*)/g.exec(this.options.yearRange);let e=0;let s=1;if(t!==null){e=parseInt(t[1]);s=parseInt(t[2])}this.selectYearElem.innerHTML="";for(let t=0;t<=e+s;t++){let s=document.createElement("option");let i=this.selectedYear-e+t;s.value=i.toString();s.innerText=i.toString();this.selectYearElem.appendChild(s)}}jump(t,e){this.selectedYear=t;this.selectedMonth=e;this.rerenderMonth()}rerenderMonth(){this.updateDisplayedDateValue();this.rerenderSelectYear();let t=new Date(this.selectedYear,this.selectedMonth).getDay();let e=new Date(this.selectedYear,this.selectedMonth+1,0).getDate();this.calendarBody.innerHTML="";this.selectYearElem.value=this.selectedYear.toString();this.selectMonthElem.value=this.selectedMonth.toString();this.daysOfWeek.forEach(((t,e)=>{Pt("div",this.calendarBody).addClass(`${this.cssPrefix}-weekday`).addClass(e==0||e==6?`${this.cssPrefix}-weekend`:"").text(t)}));for(let e=0;e<t;e++){Pt("div",this.calendarBody).addClass(`${this.cssPrefix}-day-empty`)}const s=new Date;for(let i=1;i<=e;i++){const e=Pt("div",this.calendarBody).addClass(`${this.cssPrefix}-day`).attr("data-date",i.toString()).text(i.toString()).on("click",(t=>{this.currentDate.setFullYear(this.selectedYear);this.currentDate.setMonth(this.selectedMonth);this.currentDate.setDate(parseInt(t.target.getAttribute("data-date")));this.dateChanged(this.options.oneClickDateSelection)}));if(i===s.getDate()&&this.selectedYear===s.getFullYear()&&this.selectedMonth===s.getMonth()){e.addClass(`${this.cssPrefix}-day-current`)}if(i===this.currentDate.getDate()&&this.selectedYear===this.currentDate.getFullYear()&&this.selectedMonth===this.currentDate.getMonth()){e.addClass(`${this.cssPrefix}-day-selected`)}const n=(t+i-1)%7;if(n==0||n==6){e.addClass(`${this.cssPrefix}-weekend`)}if(typeof this.options.onDrawDay==="function"){this.options.onDrawDay.apply(e.toDOM(),[e.toDOM(),new Date(this.selectedYear,this.selectedMonth,i)])}}const i=(t+e)%7;const n=i==0?0:7-i;for(let t=0;t<n;t++){Pt("div",this.calendarBody).addClass(`${this.cssPrefix}-day-empty`)}}dateChanged(t){super.dateChanged(t);this.rerenderMonth()}}class ue{get cssPrefix(){return"kdtp-tp"}constructor(t,e){this.slot=t;this.options=e||{}}setTime(t){this.currentTime=new Date(t)}getTime(){return new Date(this.currentTime)}timeChanged(){if(this.options.onTimeChanged){this.options.onTimeChanged(this.currentTime)}}}class ce extends ue{setTime(t){super.setTime(t);this.updateDisplayedTime();this.hoursInput.valueAsNumber=t.getHours();this.minutesInput.valueAsNumber=t.getMinutes()}render(){Pt("div",this.slot).addClass(`${this.cssPrefix}-time`).addChild("span",(t=>this.timeText=t.toDOM())).toDOM();const t=Pt("div",this.slot).addClass(`${this.cssPrefix}-sliders`);t.addChild("div",(t=>t.addClass(`${this.cssPrefix}-time-row`).title("Hours").addChild("input",(t=>this.hoursInput=t.addClass(`${this.cssPrefix}-input-hours`).type("range").attr("min","0").attr("max","23").attr("step","1").on("input",(t=>{this.currentTime.setHours(this.hoursInput.valueAsNumber);this.updateDisplayedTime();this.timeChanged()})).toDOM()))));t.addChild("div",(t=>t.addClass(`${this.cssPrefix}-time-row`).title("Minutes").addChild("input",(t=>this.minutesInput=t.addClass(`${this.cssPrefix}-input-minutes`).type("range").attr("min","0").attr("max","59").attr("step","1").on("input",(t=>{this.currentTime.setMinutes(this.minutesInput.valueAsNumber);this.updateDisplayedTime();this.timeChanged()})).toDOM()))));return this.slot}updateDisplayedTime(){const t=a.getCurrentLocale();const e=this.currentTime.toLocaleString(t=="en"?undefined:t,{hour:"numeric",minute:"numeric"});this.timeText.innerText=e}}class fe extends le{render(){const t=Pt("div",document.body).addClass(`${this.cssPrefix}`).attr("tabIndex","0").setStyle("position","absolute").setStyle("top","-1000px").setStyle("left","-1000px").on("keydown",(t=>{if(t.keyCode===27){this.cancel()}else if(t.keyCode===13){this.apply(this.getDateTime())}return false}));if(this.options.zIndex){t.setStyle("z-index",`${this.options.zIndex}`)}this.slot=t.toDOM();super.render();this.renderButtons();this.globalMouseDownHandler=t=>{let e=window.event||t;let s=!this.slot.contains(e.target);if(s){document.removeEventListener("mousedown",this.globalMouseDownHandler,true);this.cancel()}return true}}renderButtons(){const t=Pt("div",this.slot).addClass(`${this.cssPrefix}-buttons`).addChild("button",(t=>this.nowButton=t.addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-now`).text(a.getText("ButtonNow")).on("click",(()=>{this.setDateTime(new Date);this.dateTimeChanged();return false})).toDOM()));if(this.options.showTimePicker||!this.options.oneClickDateSelection){t.addChild("button",(t=>this.submitButton=t.addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-apply`).text(a.getText("ButtonApply")).on("click",(()=>{this.apply(this.getDateTime());return false})).toDOM()))}t.addChild("button",(t=>this.submitButton=t.addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-cancel`).text(a.getText("ButtonCancel")).on("click",(()=>{this.cancel();return false})).toDOM()))}createCalendar(t){this.calendarSlot=Pt("div",this.slot).addClass(`${this.cssPrefix}-cal`).toDOM();return new ae(this.calendarSlot,t)}createTimePicker(t){this.timePickerSlot=Pt("div",this.slot).addClass(`${this.cssPrefix}-tp`).toDOM();return new ce(this.timePickerSlot,t)}show(t){if(this.options.showDateTimeInput){if(this.options.beforeShow){this.options.beforeShow()}const e=St(t||document.body);const s=St(t?t.parentElement||t:document.body);this.slot.style.top=s.y+"px";this.slot.style.left=e.x+"px"}else{super.show(t);this.slot.focus()}setTimeout((()=>{document.addEventListener("mousedown",this.globalMouseDownHandler,true)}),1)}}var de;(function(t){t[t["Left"]=1]="Left";t[t["Center"]=2]="Center";t[t["Right"]=3]="Right"})(de||(de={}));const me="kdlg";class pe{openConfirm(t,e,s){const i=`<div id="${me}-dialog-confirm">${e}</div>`;const n={title:t,closable:false,submitable:true,cancelable:true,body:i};if(s){n.onSubmit=()=>{s(true)};n.onCancel=()=>{s(false)};this.open(n);return}return new Promise((t=>{n.onSubmit=()=>{t(true)};n.onCancel=()=>{t(false)};this.open(n)}))}openPrompt(t,e,s,i){const n=`<div id="${me}-dialog-form" class="kfrm-form">\n            <div class="kfrm-fields label-above">\n                <label for="${me}-dialog-form-input" id="${me}-dialog-form-content">${e}</label>\n                <input type="text" name="${me}-dialog-form-input" id="${me}-dialog-form-input" />\n            </div>\n        </div>`;const r={title:t,submitable:true,closable:true,cancelable:true,submitOnEnter:true,body:n,arrangeParents:false,beforeOpen:()=>{const t=document.getElementById(`${me}-dialog-form-input`);if(s){t.value=s}t.focus()}};const h=t=>{const e=document.getElementById(`${me}-dialog-form-input`);const s=e.value;if(s&&s.replace(/\s/g,"").length>0){t(s);return true}e.classList.add("eqjs-invalid");return false};if(i){r.onSubmit=()=>h(i);r.onCancel=()=>{i("")};this.open(r);return}return new Promise((t=>{r.onSubmit=()=>h(t);r.onCancel=()=>{t("")};this.open(r)}))}open(t,e){const s=new ge(t,e);const i=t.onDestroy;t.onDestroy=t=>{this.untrack(t);i&&i(t)};s.open();this.track(s);return s}createSet(t){return new be(t,this)}untrack(t){const e=pe.openDialogs.indexOf(t);if(e>=0){pe.openDialogs.splice(e,1)}}track(t){pe.openDialogs.push(t)}openProgress(t){const e=new ye(t);const s=t.onDestroy;t.onDestroy=t=>{this.untrack(t);s&&s(t)};e.open();this.track(e);return e}getAllDialogs(){return Array.from(pe.openDialogs)}closeAllDialogs(){for(const t of Array.from(pe.openDialogs)){t.close()}}}pe.openDialogs=[];class ge{constructor(t,e){this.options=t;this.submitHandler=t=>{if(this.options.onSubmit&&this.options.onSubmit(this,t)===false){return false}this.destroy();return true};this.cancelHandler=()=>{if(this.options.onCancel){this.options.onCancel(this)}this.destroy()};this.keydownHandler=t=>{if(t.keyCode==13&&this.isActiveDialog()){t.preventDefault();t.stopPropagation();if(this.submitHandler()){window.removeEventListener("keydown",this.keydownHandler,false);return false}}return true};this.dialogId=r.generateId("dlg");this.data=e;this.slot=Pt("div",document.body).attr("tab-index","-1").data("dialog-id",this.dialogId).addClass(`${me}-modal`,"is-active").focus().addChild("div",(t=>t.addClass("kdlg-modal-background"))).addChild("div",(s=>this.windowElement=s.addClass(`${me}-modal-window`).addChild("header",(e=>{this.headerElement=e.addClass(`${me}-header`).addChild("p",(e=>e.addClass(`${me}-header-title`).addText(t.title))).toDOM();if(t.closable!==false)e.addChild("button",(t=>t.addClass(`${me}-modal-close`).on("click",(()=>{this.cancelHandler()})).focus()))})).addChild("div",(t=>{t.addClass(`${me}-alert-container`);this.alertElement=t.toDOM()})).addChild("section",(s=>{this.bodyElement=s.addClass(`${me}-body`).toDOM();if(typeof t.body==="string"){const i=x.renderLiquidTemplate(t.body,e);s.addHtml(i)}else{s.addChildElement(t.body)}})).addChild("footer",(e=>{let s=null;if(t.footerAlignment&&t.footerAlignment==de.Center){s="align-center"}else{s="align-right"}this.footerElement=e.addClass(`${me}-footer`).toDOM();e.addClass(s);if(t.submitable===false)return;e.addChild("button",(e=>{e.id(this.dialogId+"-btn-submit").addClass("kfrm-button","is-info").addText(t.submitButtonText||a.getText("ButtonOK"));if(t.recaptchaSiteKey){e.data("sitekey",t.recaptchaSiteKey);e.addClass("g-recaptcha");e.on("click",(e=>{if(grecaptcha){grecaptcha.ready((()=>{grecaptcha.execute(t.recaptchaSiteKey,{action:"submit"}).then((t=>{this.submitHandler(t)}))}))}else{this.submitHandler()}}))}else{e.on("click",(t=>{this.submitHandler()}))}e.focus()}));if(t.cancelable!==false)e.addChild("button",(e=>e.id(this.dialogId+"-btn-cancel").addClass("kfrm-button").addText(t.cancelButtonText||a.getText("ButtonCancel")).on("click",(t=>{this.cancelHandler()}))))})).toDOM())).toDOM()}getData(){return this.data}getRootElement(){return this.slot}getSubmitButtonElement(){return document.getElementById(this.dialogId+"-btn-submit")}getCancelButtonElement(){return document.getElementById(this.dialogId+"-btn-cancel")}open(){if(this.options.beforeOpen){this.options.beforeOpen(this)}Pt(this.slot).show();if(this.options.arrangeParents){this.arrangeParents(true)}const t=this.slot.querySelector(`.${me}-modal-window`);if(this.options.height){t.style.height=typeof this.options.height==="string"?this.options.height:`${this.options.height}px`}if(this.options.width){t.style.width=typeof this.options.width==="string"?this.options.width:`${this.options.width}px`}if(this.options.submitOnEnter){window.addEventListener("keydown",this.keydownHandler,false)}this.slot.querySelectorAll("input").forEach((t=>t.addEventListener("input",(()=>{this.clearAlert();if(this.options.onInput){this.options.onInput(this)}}))));if(this.options.onShow){this.options.onShow(this)}}submit(){this.submitHandler()}cancel(){this.cancelHandler()}close(){this.destroy()}disableButtons(){const t=this.slot.querySelectorAll("button");t.forEach((t=>t.disabled=true))}enableButtons(){const t=this.slot.querySelectorAll("button");t.forEach((t=>t.disabled=false))}showAlert(t,e,s){let i=Pt("div").addClass(`${me}-alert ${e||""}`).addChild("span",(t=>t.addClass(`${me}-alert-closebtn`).text("").on("click",(t=>{const e=t.target.parentElement;e.parentElement.removeChild(e)})))).addText(t).toDOM();if(s===true){this.clearAlert()}this.alertElement.appendChild(i)}clearAlert(){this.alertElement.innerHTML=""}destroy(){const t=document.querySelectorAll(`[data-dialog-id="${this.dialogId}"]`);if(t.length<=0)return;if(this.options.arrangeParents){this.arrangeParents(false)}document.body.removeChild(this.slot);if(this.options.submitOnEnter){window.removeEventListener("keydown",this.keydownHandler,false)}if(this.options.onDestroy){this.options.onDestroy(this)}}isActiveDialog(){const t=document.documentElement.querySelectorAll(".kdlg-modal");return t[t.length-1]===this.slot}arrangeParents(t){const e=document.documentElement.querySelectorAll(".kdlg-modal-window");for(let s=0;s<e.length-1;s++){if(t){const t=s==0?20:s*40+20;Pt(e[s]).setStyle("margin-top",`${t}px`).setStyle("margin-left",`${t}px`)}else{Pt(e[s]).removeStyle("margin-top").removeStyle("margin-left")}}}}class ye extends ge{constructor(t,e){let s;let i;const n=Pt("div").addChild("div",(e=>s=e.text(t.content||"").toDOM())).addChild("div",(e=>{e.addClass(`${me}-progress-line`).addChild("div",(e=>{i=e.addClass("fill").toDOM();if(t.determinated){e.setStyle("width","0%")}else{e.addClass("indeterminate")}}))})).toDOM();super({title:t.title,body:n,beforeOpen:t.beforeOpen,onSubmit:t.onSubmit,width:t.width,height:t.height,submitable:false,cancelable:false,closable:false,onDestroy:t.onDestroy},e);this.contentElement=s;this.progressElement=i}updateContent(t){this.contentElement.innerText=t}updateProgress(t){t=this.in01(t);this.progressElement.style.width=`${t*100}%`;if(t===1){setTimeout((()=>{this.submit()}),500)}}in01(t){if(t>1)return 1;if(t<0)return 0;return t}}class be{constructor(t,e){this.options=t;this.dialogService=e;this.currentDialog=null;this.currentIndex=0;this.options=t;this.dialogService=e}getCurrent(){return this.currentDialog}openNext(t){return this.open(this.currentIndex+1,t)}openPrev(t){return this.open(this.currentIndex-1,t)}open(t,e){if(t<0){this.currentIndex=0}else if(t>=this.options.length){this.currentIndex=this.options.length-1}else{this.currentIndex=t}if(this.currentDialog){try{this.currentDialog.close()}catch(t){}}const s=this.options[this.currentIndex];this.currentDialog=this.dialogService.open(s,e);return this.currentDialog}close(){if(this.currentDialog){this.currentDialog.close();this.currentDialog=null}}}function ve(){a.updateDefaultTexts({GridPageInfo:"{FirstPageRecordNum} - {LastPageRecordNum} of {Total} records",GridItemsPerPage:"items per page",ButtonOK:"OK",ButtonCancel:"Cancel",ButtonApply:"Apply",ButtonNow:"Now",LblTotal:"Total"})}ve();var we;(function(t){t[t["THIS_WEEK"]=0]="THIS_WEEK";t[t["LAST_WEEK"]=1]="LAST_WEEK";t[t["THIS_MONTH"]=2]="THIS_MONTH";t[t["FIRST_MONTH"]=3]="FIRST_MONTH";t[t["LAST_MONTH"]=4]="LAST_MONTH";t[t["THIS_YEAR"]=5]="THIS_YEAR";t[t["QUARTER_1"]=6]="QUARTER_1";t[t["QUARTER_2"]=7]="QUARTER_2";t[t["QUARTER_3"]=8]="QUARTER_3";t[t["QUARTER_4"]=9]="QUARTER_4"})(we||(we={}));var Ce;(function(t){t["UNDEF"]="-1";t["TODAY"]="1";t["YESTERDAY"]="2";t["TOMORROW"]="3";t["WEEK_START"]="4";t["WEEK_END"]="5";t["MONTH_START"]="6";t["MONTH_END"]="7";t["YEAR_START"]="8";t["YEAR_END"]="9"})(Ce||(Ce={}));function xe(t){let e=0;while(t!==null){const s=document.defaultView.getComputedStyle(t,null).getPropertyValue("z-index");if(s!="auto"){const t=parseInt(s);if(t>e){e=t}}t=t.parentElement}return e}function ke(t){setTimeout((t=>{if(t&&t.focus){t.focus()}}),100,t)}const $e="eqjs";const Te="eqjs-mobile";function Se(){return gt.isMobileMode()?Te:null}class Ee extends mt{get cssPrefix(){return"eqjs-ep"}constructor(t){super(t);this.queryChangedCallbackId=null;this.group=it.Model|it.Query;this.panel=t}getWidgetType(){return"entitiesPanel"}init(t,e){super.init(t,e);this.setOptions(e);this.renderProgressBlock()}refreshCore(){this.render();if(this.options.syncWithColumns){this.refreshCheckedStateByColumns()}}onProcessStartCore(){if(this.options.showIndicatorOnLoad){if(!this.progressBlock.parentNode)this.panel.appendChild(this.progressBlock)}}onProcessEndCore(){if(this.options.showIndicatorOnLoad){if(this.progressBlock.parentNode)this.panel.removeChild(this.progressBlock)}}destroyCore(){this.slot.innerHTML=""}setOptions(t){this.options={showToolbar:true,syncWithColumns:false,showSelectAllButton:false,showClearSelectionButton:true,showAddColumnButton:true,showAddConditionButton:true,showCheckboxes:true,showTooltips:true,draggableAttributes:true,showAttributes:{useInConditions:true,useInResult:true,useInSorting:false},showFilterBox:false,filterBoxMode:0,showIndicatorOnLoad:true,attrPlacement:0,sortEntities:false,autoClearSelection:true,entityRenderedCallback:null,attributeRenderedCallback:null};if(t){r.assignDeep(this.options,t)}if(this.queryChangedCallbackId){const t=this.context.getQuery();t.removeChangedCallback(this.queryChangedCallbackId)}if(this.options.syncWithColumns){const t=this.context.getQuery();this.queryChangedCallbackId=t.addChangedCallback((t=>{const e=t.data;if(!e||e.part!=P.Columns&&e.part!=P.All){return}this.refreshCheckedStateByColumns()}))}}render(){let t=this.context.getModel();this.clear();this.panel.classList.add(`${this.cssPrefix}-panel`);this.panel.classList.add(Se());this.rootEntityBlock=document.createElement("div");if(t!=null&&!t.isEmpty()){let e=t.getEntitiesTree({addUIC:this.options.showAttributes.useInConditions&&!this.options.syncWithColumns,addUIR:this.options.showAttributes.useInResult,addUIS:this.options.showAttributes.useInSorting&&!this.options.syncWithColumns,attrPlacement:this.options.attrPlacement,sortEntities:this.options.sortEntities,includeRootData:true});this.entityTreeBlock=this.renderEntity(e,this.rootEntityBlock,0);this.panel.appendChild(this.entityTreeBlock)}if(this.options.showFilterBox){this.createFilterBox()}else{this.rootEntityBlock.style.top="0"}if(this.options.showToolbar&&!this.options.syncWithColumns){this.createToolPanel()}else{this.rootEntityBlock.style.bottom="0"}}renderEntity(t,e,s){let i;let n=document.createElement("div");n.classList.add(`${this.cssPrefix}-entity-node`);n.classList.add(Se());let r=document.createElement("div");r.classList.add(`${this.cssPrefix}-entity-children`);r.classList.add(Se());let h=document.createElement("label");h.classList.add(`${this.cssPrefix}-entity-node-label`);let o=document.createElement("input");o.type="checkbox";o.title=t.text;let l=document.createElement("a");l.href="javascript:void(0)";l.title=`${a.getText("EntityToggle")} ${t.text}`;l.classList.add(`${this.cssPrefix}-entity-node-button`);let u,c,f;let d=s;let m=(t,e)=>{let s=e.querySelectorAll(`.${this.cssPrefix}-entity-attr[data-id="${t}"]`);return s.length>0};if(e){i=e;i.innerHTML=""}else{i=document.createElement("div")}i.classList.add(`${this.cssPrefix}-entity`);i.classList.add(Se());if(t.id&&t.id!=""){h.innerText=t.text;n.appendChild(h);if(this.options.showCheckboxes){h.insertBefore(o,h.firstChild)}n.insertBefore(l,n.firstChild);if(this.options.showTooltips&&t.description){h.setAttribute("title",t.description)}for(let t=0;t<d;t++){let t=document.createElement("div");t.classList.add(`${this.cssPrefix}-entity-offset`);n.insertBefore(t,n.firstChild)}i.appendChild(n);r.hidden=true;d++}let p=t.items?t.items.length:0;for(let e=0;e<p;e++){let s=t.items[e];if(s.isEntity){r.appendChild(this.renderEntity(s,null,d))}else{if(!s.lookupAttr||!m(s.lookupAttr,r)){c=document.createElement("label");c.innerText=s.text;c.classList.add(`${this.cssPrefix}-entity-attr-label`);if(this.options.showCheckboxes){f=document.createElement("input");f.type="checkbox";f.title=s.text;c.insertBefore(f,c.firstChild);if(this.options.syncWithColumns){f.addEventListener("change",(t=>{const e=this.context.getModel();const s=this.context.getQuery();const i=t.currentTarget;const n=i.parentElement.parentElement.getAttribute("data-id");if(e.checkAttrProperty(n,"useInResult")){if(i.checked){const t=e.getAttributeById(n);const i=s.addColumn({attribute:t},true);s.fireColumnsChangedEvent(O.Add,i)}else{const t=s.getColumns().filter((t=>t.expr.tag===L.EntityAttribute&&t.expr.value===n));if(t.length>0){s.removeColumn(t[0]);s.fireColumnsChangedEvent(O.Delete,t[0])}}}}))}}if(this.options.showTooltips&&s.description){c.setAttribute("title",s.description)}for(let t=0;t<d+1;t++){let t=document.createElement("div");t.classList.add(`${this.cssPrefix}-entity-offset`);c.insertBefore(t,c.firstChild)}u=document.createElement("div");u.classList.add(`${this.cssPrefix}-entity-attr`);if(n.innerHTML.length==0){u.classList.add(`${this.cssPrefix}-entity-attr-root`)}u.innerHTML="";u.appendChild(c);u.setAttribute("data-id",s.id);if(this.options.draggableAttributes&&!this.options.syncWithColumns){Gt.registerDraggableItem({element:u,scope:"entityAttr",data:{attrId:s.id},renderer:t=>{t.innerHTML="";const e=document.createElement("span");e.innerText=s.text;t.appendChild(e)}})}if(this.options.attributeRenderedCallback){this.options.attributeRenderedCallback(u)}r.appendChild(u)}}}if(r.innerHTML.length){i.appendChild(r);l.addEventListener("click",(t=>{r.hidden=!r.hidden;let e=t.target;let s=`${this.cssPrefix}-entity-node-button-open`;if(e.classList.contains(s)){e.classList.remove(s)}else{e.classList.add(s)}t.preventDefault()}))}if(r){const t=r.querySelectorAll(`.${this.cssPrefix}-entity-attr > label > input`);for(let e=0;e<t.length;e++){const s=t[e];s.addEventListener("click",(t=>{let e=t.target;if(e.checked&&!o.checked){o.checked=true}else if(r.querySelectorAll("input:checked").length===0){o.checked=false}t.stopPropagation()}))}}o.addEventListener("click",(t=>{let e=t.target;const s=r.querySelectorAll("label input");for(let t=0;t<s.length;t++){const i=s[t];i.checked=e.checked}if(this.options.syncWithColumns){const t=this.context.getQuery();const s=this.context.getModel();const i=[];const n=Array.from(r.querySelectorAll(`.${this.cssPrefix}-entity-attr`));for(const t of n){const e=t.getAttribute("data-id");if(s.checkAttrProperty(e,"useInResult")){i.push(e)}}if(e.checked){for(const e of i){t.addColumn({attributeId:e},true)}}else{const e=t.getColumns().filter((t=>t.expr.tag===L.EntityAttribute&&i.indexOf(t.expr.value)>=0));t.removeColumns(e,null)}t.fireColumnsChangedEvent()}t.stopPropagation()}));if(e!=this.rootEntityBlock&&this.options.entityRenderedCallback){this.options.entityRenderedCallback(i)}return i}createFilterBox(){this.filterBoxBlock=document.createElement("div");this.filterBoxBlock.classList.add(`${this.cssPrefix}-filter-box`);this.filterBoxBlock.classList.add(Se());this.filterBoxInput=document.createElement("input");this.filterBoxInput.classList.add(`${this.cssPrefix}-filter-box-input`);this.filterBoxInput.addEventListener("input",(t=>{const e=this.panel.querySelectorAll(`.${this.cssPrefix}-entity-attr`);for(let t=0;t<e.length;t++){const s=e[t];s.hidden=!this.checkFilterAttribute(s)}const s=this.panel.querySelectorAll(`:scope > .${this.cssPrefix}-entity`);for(let t=0;t<s.length;t++){const e=s[t];let i=e.querySelectorAll(`.${this.cssPrefix}-entity-attr`);let n=0;for(let t=0;t<i.length;t++){if(i[t].style.display!=="None"){n++}}e.hidden=n===0}if(this.filterBoxInput.value==="")this.collapseAll();else this.expandAll()}));this.filterBoxBlock.appendChild(this.filterBoxInput);this.panel.insertBefore(this.filterBoxBlock,this.panel.firstChild)}createToolPanel(){let t=`${this.cssPrefix}-tool-panel`;let e=document.createElement("div");e.classList.add(t);e.classList.add(Se());let s=document.createElement("div");s.classList.add(`${t}-select-all`);s.title="Select all";let i=document.createElement("div");i.classList.add(`${t}-deselect-all`);i.title="Clear selection";let n=document.createElement("div");n.classList.add(`${t}-add-columns`);n.title="Add column";let r=document.createElement("div");r.classList.add(`${t}-add-cond`);r.title="Add condition";let h=document.createElement("div");h.classList.add(`${t}-left-side`);let o=document.createElement("div");o.classList.add(`${t}-right-side`);let l=this.context.getModel();if(this.options.showSelectAllButton){s.title=a.getText("ButtonSelectAll");h.appendChild(s);s.addEventListener("click",(()=>{this.selectAll()}))}if(this.options.showClearSelectionButton){i.title=a.getText("ButtonDeselectAll");h.appendChild(i);i.addEventListener("click",(()=>{this.deselectAll()}))}if(this.options.showAddColumnButton){n.title=a.getText("ButtonAddColumns");o.appendChild(n);n.addEventListener("click",(()=>{const t=this.panel.querySelectorAll(`.${this.cssPrefix}-entity-attr`);let e=[];let s;const i=this.context.getQuery();i.fireProcessEvent({source:self,status:"start"});for(let i=0;i<t.length;i++){const n=t[i];let r=n.getElementsByTagName("input")[0];if(r.checked){s=n.getAttribute("data-id");if(l.checkAttrProperty(s,"useInResult")){e.push(s)}}}for(let t of e){const e=l.getAttributeById(t);i.addColumn({attribute:e},true)}i.fireChangedEvent();if(this.options.autoClearSelection){this.deselectAll()}i.fireProcessEvent({source:self,status:"finish"})}))}if(this.options.showAddConditionButton){r.title=a.getText("ButtonAddConditions");o.appendChild(r);r.addEventListener("click",(()=>{let t=this.panel.querySelectorAll(`.${this.cssPrefix}-entity-attr`);let e=[];let s;let i=this.context.getQuery();i.fireProcessEvent({source:self,status:"start"});for(let i=0;i<t.length;i++){const n=t[i];let r=n.getElementsByTagName("input")[0];if(r.checked){s=n.getAttribute("data-id");if(l.checkAttrProperty(s,"useInConditions")){e.push(s)}}}for(let t of e){i.addSimpleCondition({attributeId:t})}i.fireChangedEvent();if(this.options.autoClearSelection){this.deselectAll()}i.fireProcessEvent({source:self,status:"finish"})}))}e.appendChild(h);e.appendChild(o);this.panel.appendChild(e)}checkFilterAttribute(t){const e=t.querySelector("label input");if(e.checked){return true}const s=t.querySelector("label");const i=s.textContent;if(this.checkFilterText(i)){return true}const n=t.parentElement.parentElement.querySelector(`.${this.cssPrefix}-entity-node`);const r=n.querySelector("label").textContent;if(this.checkFilterText(r)){return true}return false}checkFilterText(t){let e=this.filterBoxInput.value;if(e=="")return true;if(this.options.filterBoxMode==0&&t.toLowerCase().indexOf(e.toLowerCase())>=0)return true;if(this.options.filterBoxMode==1&&t.toLowerCase().indexOf(e.toLowerCase())==0)return true;return false}refreshCheckedStateByColumns(){this.deselectAll();const t=this.context.getQuery();const e=t.getColumns().filter((t=>t.expr.tag===L.EntityAttribute));for(const t of e){const e=this.rootEntityBlock.querySelector(`.${this.cssPrefix}-entity-attr[data-id="${t.expr.value}"]`);let s=e.querySelector(`label > input`);s.checked=true;let i=e.parentElement;while(i&&i.classList.contains(`${this.cssPrefix}-entity-children`)){i.hidden=false;const t=i.parentElement;if(t&&i!==t.firstElementChild){s=t.firstElementChild.querySelector(`label > input`);s.checked=true;i=t.parentElement}else{break}}}}expandAll(){for(let t=0;t<this.rootEntityBlock.childNodes.length;t++){const t=this.rootEntityBlock.childNodes[0];const e=t.querySelectorAll(`.${this.cssPrefix}-entity-children`);for(let t=0;t<e.length;t++){const s=e[t];s.hidden=false}}const t=this.rootEntityBlock.querySelectorAll(`.${this.cssPrefix}-entity-node-button`);for(let e=0;e<t.length;e++){const s=t[e];s.classList.add(`${this.cssPrefix}-entity-node-button-open`)}}collapseAll(){for(let t=0;t<this.rootEntityBlock.childNodes.length;t++){const t=this.rootEntityBlock.childNodes[0];const e=t.querySelectorAll(`.${this.cssPrefix}-entity-children`);for(let t=0;t<e.length;t++){const s=e[t];s.hidden=true}}const t=this.rootEntityBlock.querySelectorAll(`.${this.cssPrefix}-entity-node-button`);for(let e=0;e<t.length;e++){const s=t[e];s.classList.remove(`${this.cssPrefix}-entity-node-button-open`)}}selectAll(){const t=this.entityTreeBlock.querySelectorAll("input");for(let e=0;e<t.length;e++){const s=t[e];s.checked=true}}deselectAll(){const t=this.entityTreeBlock.querySelectorAll("input");for(let e=0;e<t.length;e++){const s=t[e];s.checked=false}}renderProgressBlock(){this.progressBlock=document.createElement("div");this.progressBlock.classList.add(`${$e}-progress-win8`);this.progressBlock.classList.add(Se());this.progressBlock.innerHTML='<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>'}clear(){this.panel.innerHTML=""}}var De;(function(t){t[t["ReadOnly"]=0]="ReadOnly";t[t["FixedList"]=16]="FixedList";t[t["Full"]=255]="Full"})(De||(De={}));var Ae;(function(t){t[t["Default"]=0]="Default";t[t["ReadOnly"]=1]="ReadOnly";t[t["FixedList"]=16]="FixedList";t[t["Full"]=255]="Full"})(Ae||(Ae={}));class Ie{get applyItem(){return this._applyItem}get cssPrefix(){return"eqjs-menu"}constructor(t){this.isFilteringMode=false;this.showSelected=false;this.parentMenu=t.menu||null;this.parentLevel=t.parent||null;this.parentElement=t.container||document.body;this.levelIndex=t.levelIndex||0;this.levelDiv=null;this.domWriteItemsId=t.domWriteItemsId||false;this.menuId=t.menuId||"";this.itemRenderedCallback=t.itemRenderedCallback||null;this._applyItem={id:null,text:null,itemDiv:null};this.items=t.items||[];this.activeItem=null;this.selectedItem=null;this.initialized=false;this.showSelected=t.showSelected;this.updated=0;this.renderContent()}getItems(){return this.items}setItems(t){this.items=t}renderContent(){if(!this.items){return}const t=this.parentMenu.style.colors.bgON||"white";const e=this.parentMenu.style.colors.fgON||"black";const s=this.parentMenu.style.itemStyle.fontFamily||"";const i=this.parentMenu.style.itemStyle.fontSize||"14px";const n=this.parentMenu.options.multiselect;const r=this.parentMenu.options.isSubQuery;const h=Pt("div").addClass(Se());if(this.parentMenu.options.useDefaultStyles){h.setStyle("backgroundColor",t).setStyle("border","1px solid").setStyle("borderColor",t).setStyle("backgroundColor",this.parentMenu.style.colors.border).setStyle("margin","-2px 2px 2px -2px").setStyle("width","auto").setStyle("height","auto")}h.setStyle("z-index",this.parentMenu.zIndex).setStyle("position","absolute").setStyle("display","none");let o=h.toDOM();o["menuLevel"]=this;const l=this._applyItem;if(n&&this.levelIndex===0&&this.parentMenu.options.hideButtons!==true){this.applyDiv=document.createElement("div");this.applyDiv.classList.add(`${this.cssPrefix}-applyDiv`);this.applyDiv["menuItem"]=l;this.applyBtn=document.createElement("button");if(this.parentMenu.options.useDefaultStyles){this.applyDiv.style.borderBottom="1px solid";this.applyDiv.style.padding="5px";this.applyDiv.style.marginBottom="5px";this.applyBtn.style.padding="0 5px";this.applyBtn.style.cursor="pointer"}const t=document.createTextNode(this.parentMenu.options.buttons.submit);this.applyBtn.appendChild(t);this.applyDiv.appendChild(this.applyBtn);const e=document.createElement("button");e.classList.add(`${this.cssPrefix}-cancel`);if(this.parentMenu.options.useDefaultStyles){e.style.padding="0 5px";e.style.cursor="pointer";e.style.marginLeft="15px"}const s=document.createTextNode(this.parentMenu.options.buttons.cancel);e.appendChild(s);this.applyDiv.appendChild(e);o.appendChild(this.applyDiv);l.itemDiv=this.applyDiv;this.applyBtn.addEventListener("click",(()=>{this.submit(this._applyItem)}));e.addEventListener("click",(()=>{this.parentMenu.hideMenu()}))}if(this.parentLevel==null&&(this.parentMenu.options.searchBoxAlwaysShown||this.items.length>=this.parentMenu.options.showSearchBoxAfter)){const n=Pt("div").addClass(`${this.cssPrefix}-searchDiv`);if(this.parentMenu.options.useDefaultStyles){n.setStyle("border-bottom","1px solid #666").setStyle("background-color",t).setStyle("border-color",this.parentMenu.style.colors.border);if(s!=""){n.setStyle("font-family",s)}n.setStyle("font-size",i).setStyle("color",e).setStyle("cursor","pointer").setStyle("text-align","left").setStyle("padding","5px")}const h=Pt("input").id("searchBox").name("searchBox").type("text").size(16).addClass(`${this.cssPrefix}-searchBox`).on("input",(t=>{this.deactivateItem(this.activeItem);this.renderItems(this.searchBox.value)})).on("keydown",(t=>{let e=t.keyCode;switch(e){case 13:if(this.activeItem){this.activeItem.itemDiv.click()}break;case 38:this.moveActiveItemUp();break;case 40:this.moveActiveItemDown();break;case 39:if(!this.searchBox.value){this.openSubLevel(this.activeItem)}break}}));if(this.parentMenu.options.useDefaultStyles){h.setStyle("font-family","monospace").setStyle("font-size","8pt").setStyle("width","100%")}if(r){h.addClass("eqjs-dialog")}this.searchBox=h.toDOM();this.searchDiv=n.toDOM();this.searchDiv.appendChild(this.searchBox);o.appendChild(this.searchDiv)}const u=document.createElement("div");u.tabIndex=1;Pt(u).addClass(`${this.cssPrefix}-scrollDiv`).addClass(Se());u.style.overflowX="hidden";u.style.overflowY="auto";u.style.position="relative";o.appendChild(u);this.levelDiv=o;this.scrollDiv=u;if(this.menuId){this.levelDiv.id=this.menuId}if(this.parentLevel){this.levelDiv.style.zIndex=this.parentLevel.levelDiv.style.zIndex}this.renderItems();const c=t=>{switch(t.which){case 13:if(this.parentMenu.options.multiselect){this.parentMenu.getRootLevel().applyBtn.click()}else{if(this.activeItem){this.activeItem.itemDiv.click()}}break;case 32:if(this.activeItem){this.activeItem.itemDiv.click()}break;case 37:if(this.parentLevel&&!this.isFilteringMode){this.deactivateItem(this.activeItem);this.parentLevel.focus()}break;case 39:this.openSubLevel(this.activeItem);break;case 38:this.moveActiveItemUp();break;case 40:this.moveActiveItemDown();break;default:return}t.preventDefault()};u.addEventListener("keydown",c);if(gt.isMobileMode()){this.closeDiv=Pt("div",o).addClass("eqjs-menu-close-btn").addText(a.getText("ButtonClose")).on("click",(()=>{this.parentMenu.hideMenu()})).toDOM()}}moveActiveItemDown(){const t=this.isFilteringMode?this.filteredItems:this.items;if(this.activeItem){const e=t.indexOf(this.activeItem);if(e<t.length-1){this.activateItem(t[e+1],false)}}else{this.activateItem(t[0],false)}}moveActiveItemUp(){const t=this.isFilteringMode?this.filteredItems:this.items;if(this.activeItem){const e=t.indexOf(this.activeItem);if(e>0){this.activateItem(t[e-1],false)}}else{this.activateItem(t[t.length-1],false)}}openSubLevel(t){if(t&&t.items&&!this.isFilteringMode){this.showSubLevel(t);t.subLevel.activateItem(t.subLevel.items[0])}}focusScrollDiv(){this.scrollDiv.focus()}turnCheckboxes(t){for(let e=0;e<t.length;e++){const s=t[e];if(s.itemCheckbox)s.itemCheckbox.checked=this.isItemSelected(s);if(s.items){this.turnCheckboxes(s.items)}}}isItemSelected(t){if(t.items){for(var e=0;e<t.items.length;e++){if(this.isItemSelected(t.items[e])){return true}}return false}else{return t.selected}}setItemSelected(t,e){if(t.items){for(let s=0;s<t.items.length;s++){this.setItemSelected(t.items[s],e)}}else{t.selected=e}}submitItems(t,e){for(let s=0;s<t.length;s++){if(t[s].items){this.submitItems(t[s].items,e)}else{if(t[s].selected){e.push(t[s])}}}}allSubitemsAreFiltered(t,e){for(let s=0;s<t.length;s++){if(e(t[s]))return false}return true}isItemDiv(t){return t["menuItem"]?true:false}isLevelDiv(t){return t["menuLevel"]?true:false}getMenuItem(t){let e=t;while(!this.isItemDiv(e)){if(this.isLevelDiv(e)){throw"Can't get menu item"}e=e.parentElement}return e["menuItem"]}renderItemsWithoutFilter(){this.isFilteringMode=false;const t=this.scrollDiv;const e=this.parentMenu.options.multiselect;const s=this.parentMenu.options.activateOnMouseOver;const i=this.parentMenu.style.colors.fgON||"black";const n=this.parentMenu.style.itemStyle.fontSize||"14px";const r=this.parentMenu.getItemFilterCallback();t.innerHTML="";for(let o=0;o<this.items.length;o++){const l=this.items[o];if(!l||!l.text)continue;if(r){if(!r(l))continue;if(l.items&&this.allSubitemsAreFiltered(l.items,r))continue}l.data=t=>this[t];if(typeof l.selected=="undefined"){l.selected=false}if(l.selected&&this.selectedItem==null){this.selectedItem=l}const a=document.createElement("div");Pt(a).addClass(`${this.cssPrefix}-itemDiv`).addClass(Se());if(l.selected&&this.showSelected&&!e){a.classList.add(`${this.cssPrefix}-selected`)}if(this.domWriteItemsId&&this.menuId){a.id="item-"+this.menuId+"-"+l.id}t.appendChild(a);a["menuItem"]=l;a["menuLevel"]=this;l.itemDiv=a;if(this.parentMenu.options.useDefaultStyles){a.style.fontSize=n;a.style.color=i;a.style.paddingLeft="15px";a.style.paddingRight="6px";a.style.cursor="pointer"}if(l.text=="---"){a.appendChild(document.createElement("hr"))}else{if(e){var h=document.createElement("input");h.type="checkbox";h.id="cb"+l.id;h.checked=this.isItemSelected(l);h.defaultChecked=this.isItemSelected(l);a.appendChild(h);l.itemCheckbox=h;if(this.parentMenu.options.useDefaultStyles){h.style.margin="4px 10px 0 0";h.style.verticalAlign="top"}}let t=l.text;if(this.parentMenu.options.showItemIds){t=l.id+":"+t}const i=document.createTextNode(t);a.appendChild(i);if(l.items&&l.items.length>0){a.classList.add(`${this.cssPrefix}-itemDiv-hasChildren`);const t=document.createElement("span");t.classList.add(`${this.cssPrefix}-itemDiv-arrow`);a.appendChild(t);const e=document.createTextNode(">");t.appendChild(e)}const n=t=>{const s=this.getMenuItem(t.target);if(e){if(!s.items||t.target==s.itemCheckbox){const t=this.isItemSelected(s);this.setItemSelected(s,!t);s.itemCheckbox.checked=!t;this.parentMenu.refreshCheckboxes()}else{this.activateItem(s)}}else{this.activateItem(s);this.submit(s)}return false};a.removeEventListener("click",n);a.addEventListener("click",n);a.addEventListener("mouseenter",(t=>{const e=this.getMenuItem(t.target);this.parentMenu.isCursorInside=true;if(s){this.activateItem(e)}}));a.addEventListener("mouseleave",(t=>{const e=this.getMenuItem(t.target);this.parentMenu.isCursorInside=false;setTimeout((()=>{if(!this.parentMenu.isCursorInside){if(s&&e==this.activeItem&&!e.subLevel){this.deactivateItem(e)}}}),200)}))}if(this.itemRenderedCallback){this.itemRenderedCallback(this.menuId,a)}}}renderItemsWithFilter(t){this.isFilteringMode=true;const e=this.scrollDiv;e.innerHTML="";const s=t.split(">");const i=s.map((t=>t.replace(/\*/g,"")));const n=this.filterItems(this.items,s);this.filteredItems=[];for(let t=0;t<n.length;t++){this.renderItemWithFilter(n[t],i,0)}}matchesFilter(t,e){if(t&&e){return e.test(t)}else{return true}}filterItems(t,e){const s=[];const i=e.length>0?e[0]:"";const n=e.length>1?e.slice(1):e;const h=i?new RegExp(i.replace(/\*/g,".+?"),"i"):null;for(let i=0;i<t.length;i++){const o=t[i];if(o.items){const t=r.assign({},o);const i=this.matchesFilter(o.text,h);if(e.length<2){if(i&&e.length<2){t.items=r.createArrayFrom(o.items)}else{t.items=this.filterItems(o.items,n)}}else if(i){t.items=this.filterItems(o.items,n)}else{t.items=[]}if(t.items.length>0){s.push(t)}}else{if(this.matchesFilter(o.text,h)){s.push(o)}}}return s}renderItemWithFilter(t,e,s){const i=this.scrollDiv;const n=s<e.length?e[s]:e[e.length-1];const r=this.parentMenu.options.multiselect;const h=this.parentMenu.options.activateOnMouseOver;const o=this.parentMenu.style.colors.fgON||"black";const l=this.parentMenu.style.itemStyle.fontSize||"14px";const a=this.parentMenu.getItemFilterCallback();if(!t||!t.text)return;if(a){if(!a(t))return;if(t.items&&this.allSubitemsAreFiltered(t.items,a))return}t.data=function(t){return this[t]};if(typeof t.selected=="undefined"){t.selected=false}if(t.selected&&this.selectedItem==null){this.selectedItem=t}const u=document.createElement("div");Pt(u).addClass(`${this.cssPrefix}-itemDiv`).addClass(Se());u.style.marginLeft=`${s*10}px`;if(t.selected&&!r){u.classList.add(`${this.cssPrefix}-selected`)}if(this.domWriteItemsId&&this.menuId){u.id="item-"+this.menuId+"-"+t.id}i.appendChild(u);u["menuItem"]=t;u["menuLevel"]=this;t.itemDiv=u;if(this.parentMenu.options.useDefaultStyles){u.style.fontSize=l;u.style.color=o;u.style.paddingLeft="15px";u.style.paddingRight="6px";u.style.cursor="pointer"}if(t.text=="---"){u.appendChild(document.createElement("hr"))}else{if(r){var c=document.createElement("input");c.type="checkbox";c.id="cb"+t.id;c.checked=this.isItemSelected(t);c.defaultChecked=this.isItemSelected(t);u.appendChild(c);t.itemCheckbox=c;if(this.parentMenu.options.useDefaultStyles){c.style.margin="4px 10px 0 0";c.style.verticalAlign="top"}}const e=document.createElement("span");e.innerHTML=this.highlightText(t.text,n);u.appendChild(e);if(t.items&&t.items.length>0){u.classList.add(`${this.cssPrefix}-itemDiv-filter-hasChildren`)}else{this.filteredItems.push(t);const e=e=>{if(r){if(!t.items||e.target==t.itemCheckbox){const e=this.isItemSelected(t);this.setItemSelected(t,!e);t.itemCheckbox.checked=!e;this.parentMenu.refreshCheckboxes()}else{this.activateItem(t)}}else{this.activateItem(t);this.submit(t)}return false};u.removeEventListener("click",e);u.addEventListener("click",e);u.addEventListener("mouseenter",(e=>{this.parentMenu.isCursorInside=true;if(h){this.activateItem(t)}}));u.addEventListener("mouseleave",(e=>{this.parentMenu.isCursorInside=false;setTimeout((()=>{if(!this.parentMenu.isCursorInside){if(h&&t==this.activeItem&&!t.subLevel){this.deactivateItem(t)}}}),200)}))}}if(t.items){for(let i=0;i<t.items.length;i++){this.renderItemWithFilter(t.items[i],e,s+1)}}if(this.itemRenderedCallback){this.itemRenderedCallback(this.menuId,u)}}highlightText(t,e){if(e&&e.length>0){const s=e.toLowerCase();const i=t.toLowerCase();const n=`<span class='eqjs-menu-itemDiv-highlight'>`;const r=`</span>`;const h=i.indexOf(s);if(h>=0){let h=0;const o=t;const l=[];while(true){const t=i.indexOf(s,h);if(t>=0){l.push(t);h=t+e.length}else{h++}if(h>=o.length-1){break}}if(l.length>0){t="";for(let s=0;s<l.length;s++){if(s===0){t+=o.substring(0,l[s])}t+=n+o.substring(l[s],l[s]+e.length)+r;if(s<l.length-1){t+=o.substring(l[s]+e.length,l[s+1])}else{t+=o.substring(l[s]+e.length)}}}}}return t}renderItems(t){if(!t&&!gt.isMobileMode()){this.renderItemsWithoutFilter()}else{t=t||"";this.renderItemsWithFilter(t.toLowerCase())}}activateItem(t,e=true){if(this.activeItem!=null){this.deactivateItem(this.activeItem)}this.activeItem=t;const s=t.itemDiv;s.classList.add("active");if(this.parentMenu.options.useDefaultStyles){const t=this.parentMenu.style.colors.bgOVER;const e=this.parentMenu.style.colors.fgOVER||"";const i=this.parentMenu.style.itemClassOver||"";if(i!=""){s.style.backgroundColor="";s.style.color=""}else{s.style.backgroundColor=t;s.style.color=e}}if(t.items&&!this.isFilteringMode&&e){this.showSubLevel(t)}}deactivateItem(t){if(!t)return;const e=t.itemDiv;e.classList.remove("active");if(this.parentMenu.options.useDefaultStyles){const t=this.parentMenu.style.colors.bgON;const s=this.parentMenu.style.colors.fgON;const i=this.parentMenu.style.itemClass||"";if(i!=""){e.style.backgroundColor="";e.style.color=""}else{e.style.backgroundColor=t;e.style.color=s}}if(t.subLevel){t.subLevel.hide()}this.activeItem=null}showSubLevel(t){if(!t.subLevel){let e="";if(this.menuId){e=this.menuId+"-"+t.id}t.subLevel=new Ie({showSelected:this.showSelected,menu:this.parentMenu,parent:this,container:this.parentElement,items:t.items,levelIndex:this.levelIndex+1,domWriteItemsId:this.domWriteItemsId,menuId:e,itemRenderedCallback:this.itemRenderedCallback})}const e=St(t.itemDiv);t.itemDiv.getBoundingClientRect();const s=Tt();const i=Dt();const n=e.x-s.left;const r=i.width-n-t.itemDiv.offsetWidth;e.x+=t.itemDiv.offsetParent.offsetWidth;e.y-=5;t.subLevel.showAt(e.x,e.y,true,true);t.subLevel.levelDiv.style.width="";t.subLevel.levelDiv.style.right="";if(r>=t.subLevel.levelDiv.offsetWidth||r>=n){if(r<t.subLevel.levelDiv.offsetWidth){t.subLevel.levelDiv.style.right=-s.left+"px"}}else{if(n<t.subLevel.levelDiv.offsetWidth){t.subLevel.levelDiv.style.left=s.left+4+"px"}else{t.subLevel.levelDiv.style.left=""}t.subLevel.levelDiv.style.right=$t().width-e.x+t.itemDiv.offsetWidth-6+"px"}t.subLevel.levelDiv.style.visibility="visible";t.subLevel.focus()}adjustTopPos(t){const e=Dt();const s=t-Tt().top+this.levelDiv.offsetHeight;let i=t;if(s>e.height-5){i-=s-e.height+5;if(i<Tt().top){i=Tt().top+10}}return i}showAt(t,e,s,i,n){if(!this.items){return}this.initLevelDiv();this.turnCheckboxes(this.items);this.renderItems();const r=this.levelDiv.style;if(i){this.levelDiv.style.visibility="hidden"}r.display="block";r.left=t+"px";r.top=e+"px";this.scrollDiv.style.width="auto";this.scrollDiv.style.height="auto";this.scrollDiv.style.maxHeight=null;const h=this.parentMenu.options.useMaxSpace;const o=$t().height;const l=n?n.getBoundingClientRect():null;const a=l?l.height:0;const u=e-scrollY;const c=o-u-a;const f=15;let d=this.levelDiv.getBoundingClientRect();if(this.levelIndex==0&&d.height<c-f){r.top=e+a+"px"}else if(this.levelIndex==0&&d.height<u-f){r.top=e-d.height+"px"}else if(h||this.levelIndex>0){const t=d.bottom+f-scrollY-o;if(t>0){r.top=d.top-t+"px"}d=this.levelDiv.getBoundingClientRect();const e=scrollY+f-d.top;if(e>0){const t=this.scrollDiv.getBoundingClientRect();this.scrollDiv.style.maxHeight=t.height-e+"px";r.top=d.top+e+"px"}}else if(u<=c){r.top=e+a+"px";const t=d.height+f-c;if(t>0){const e=this.scrollDiv.getBoundingClientRect();this.scrollDiv.style.maxHeight=e.height-t+"px"}}else{e-=d.height;const t=scrollY+f-e;if(t>0){const s=this.scrollDiv.getBoundingClientRect();this.scrollDiv.style.maxHeight=s.height-t+"px";e+=t}r.top=e+"px"}let m=this.parentMenu.minItemWidth;if(m>0&&this.scrollDiv.offsetWidth<m){for(let t=0;t<this.items.length;t++){this.items[t].itemDiv.style.width=m+"px"}}let p=this.parentMenu.maxItemWidth;if(p>0&&this.scrollDiv.offsetWidth>p){for(let t=0;t<this.items.length;t++){this.items[t].itemDiv.style.width=p+"px";this.items[t].itemDiv.style.overflowX="hidden"}}this.activeItem=null}focus(){window.setTimeout((()=>{this.scrollDiv.focus();if(this.searchBox!=null){if(this.parentMenu.options.searchBoxAutoFocus){this.searchBox.focus()}this.searchBox.value=""}}),100)}hide(){if(this.activeItem!==null){if(this.activeItem.subLevel){this.activeItem.subLevel.hide()}}if(this.levelDiv){var t=this.levelDiv.style;t.display="none";if(this.initialized){this.parentElement.removeChild(this.levelDiv);this.initialized=false}}}initLevelDiv(){if(!this.initialized){this.parentElement.appendChild(this.levelDiv);Pt(this.levelDiv).addClass(`${this.cssPrefix}-levelDiv`).addClass(Se());this.initialized=true}}submit(t){if(t!=null){if(!t.items){this.parentMenu.hideMenu();let e=[];if(t==this._applyItem){this.submitItems(this.items,e)}this.parentMenu.submitMenu(t,e)}}}remove(){for(let t=0;t<this.items.length;t++){let e=this.items[t];if(e.subLevel){e.subLevel.remove()}}if(this.levelDiv){this.levelDiv.innerHTML="";const t=this.levelDiv.parentNode;if(t!=null){t.removeChild(this.levelDiv)}}this.levelDiv=null}update(t){this.remove();this.items=t;this.activeItem=null;this.selectedItem=null;this._applyItem.itemDiv=null;this.initialized=false;this.updated++;this.renderContent()}refreshCheckboxes(){for(var t=0;t<this.items.length;t++){var e=this.items[t];if(e.itemCheckbox){e.itemCheckbox.checked=this.isItemSelected(e)}if(e.subLevel){e.subLevel.refreshCheckboxes()}}}refreshItems(){for(let t=0;t<this.items.length;t++){const e=this.items[t];if(e.itemDiv){if(e.hidden){e.itemDiv.style.display="none"}else{e.itemDiv.style.display="block"}}if(e.subLevel){e.subLevel.refreshItems()}}}findItem(t){const e=t.toLowerCase();for(let t=0;t<this.items.length;t++){const s=this.items[t];if(s.text.toLowerCase().indexOf(e)==0){return s}}return null}}class Me{get cssPrefix(){return"eqjs-menu"}constructor(t){this.isCursorInside=false;this.mouseIsOverBlock=false;this.mouseIsOverLink=false;this.toId=null;this.active=false;this.ancorFocused=null;this.options={items:[],buttons:{submit:a.getText("ButtonApply"),cancel:a.getText("ButtonCancel")},itemFilterCallback:null,useDefaultStyles:false,multiselect:false,adjustHeight:true,showSearchBoxAfter:30,activateOnMouseOver:true,container:document.body,domWriteItemsId:false,itemRenderedCallback:null,showItemIds:false,useMaxSpace:true};if(t){r.assign(this.options,t);r.assign(this.options.buttons,t.buttons)}if(this.options.hideButtons){this.options.submitOnBlur=true}this.menuId=Me.lastMenuID++;this.updateProps();this.rootLevel=new Ie({menu:this,items:this.options.items,levelIndex:0,container:this.options.container,domWriteItemsId:this.options.domWriteItemsId,menuId:this.options.id,itemRenderedCallback:this.options.itemRenderedCallback,showSelected:this.options.showSelected});this.rootLevel.levelDiv.classList.add(`${this.cssPrefix}-rootLevel`);if(this.options.zIndex)this.rootLevel.levelDiv.style.zIndex=`${this.options.zIndex}`;this.menuKeyUpHandler=t=>{if(t.which==27){this.hideMenu();t.stopImmediatePropagation()}};this.globalMouseDownHandler=t=>{if(!this.active)return true;let e=window.event||t;let s=e.srcElement||e.target;let i=true;while(s){if(s.tagName&&s.tagName.toLowerCase()=="div"){if(s.menuLevel){if(s.menuLevel.parentMenu==this){i=false;break}}}s=s.parentNode||s.parentElement}if(i){if(this.options.submitOnBlur){this.rootLevel.submit(this.rootLevel.applyItem)}this.hideMenu()}return true};this.render()}getItems(){return this.rootLevel.getItems()}updateProps(){this.style={};this.style.colors={border:"#666666",shadow:"#888888",bgON:"white",fgON:"black",bgOVER:"#B6BDD2",fgOVER:"black"};this.style.itemStyle={fontSize:"14px"};this.minItemWidth=0;this.maxItemWidth=0;this.maxHeight=0;this.zIndex=`${this.options.zIndex}`;this.commandTemplate="";this.args=[];this.active=false}render(){}clearItemsMenuProps(t){if(!t)return;for(var e=0;e<t.length;e++){this.clearItemMenuProps(t[e])}}clearItemMenuProps(t){if(t.subLevel&&t.subLevel.parentMenu==this)return;if(t.subLevel){t.subLevel.remove();t.subLevel=null}if(t.itemDiv){t.itemDiv=null}if(t.items){this.clearItemsMenuProps(t.items)}}setSelectedItems(t,e){const s=t?t.length:0;for(let i=0;i<s;i++){const s=t[i];if(s.items){this.setSelectedItems(s.items,e)}else{s.selected=e.indexOf(s.id)>=0}}}getRootLevel(){return this.rootLevel}getItemFilterCallback(){return this.itemFilterCallback}showMenu(t){this.ancorFocused=t.anchor==document.activeElement?t.anchor:null;this.clearItemsMenuProps(this.options.items);this.itemSelectedCallback=t.itemSelectedCallback||null;this.menuClosedCallback=t.menuClosedCallback||null;this.itemFilterCallback=t.itemFilterCallback||null;if(t.items){this.options.items=t.items;this.rootLevel.setItems(t.items)}if(t.onMenuItemSelected){this.options.onMenuItemSelected=t.onMenuItemSelected}let e=t.selectedIds||null;if(e){if(typeof e==="string"){e=e.split(",")}}else{e=[]}this.active=true;this.setSelectedItems(this.options.items,e);if(gt.isMobileMode()){this.rootLevel.initLevelDiv();this.rootLevel.levelDiv.style.top="0px";this.rootLevel.levelDiv.style.bottom="0px";this.rootLevel.levelDiv.style.right="0px";this.rootLevel.levelDiv.style.position="fixed";this.rootLevel.levelDiv.style.fontSize="20px";this.rootLevel.showAt(0,0,true,true)}else{const e=t.anchor||document.documentElement;const s=St(e);const i=e.offsetWidth;const n={x:s.x,y:s.y};const r=Tt();const h=Dt();const o=n.x+i-r.left;const l=h.width-o+i;n.x+=2;this.rootLevel.initLevelDiv();this.rootLevel.levelDiv.style.width="";this.rootLevel.levelDiv.style.right="";this.rootLevel.levelDiv.style.bottom="";this.rootLevel.levelDiv.style.position="absolute";this.rootLevel.levelDiv.style.fontSize="14px";this.rootLevel.showAt(n.x,n.y,true,true,e);if(!this.rootLevel.levelDiv.style.zIndex){this.rootLevel.levelDiv.style.zIndex=`${Math.max(1e4,xe(e)+1)}`}if(l>=this.rootLevel.levelDiv.offsetWidth||l>=o){if(l<this.rootLevel.levelDiv.offsetWidth){this.rootLevel.levelDiv.style.right=-r.left+"px"}}else{if(o<this.rootLevel.levelDiv.offsetWidth){this.rootLevel.levelDiv.style.left=r.left+4+"px"}else{this.rootLevel.levelDiv.style.left=""}this.rootLevel.levelDiv.style.right=$t().width-n.x-i+"px"}}this.rootLevel.levelDiv.style.visibility="visible";this.rootLevel.focus();document.addEventListener("keyup",this.menuKeyUpHandler);document.addEventListener("mousedown",this.globalMouseDownHandler,true)}hideMenu(){document.removeEventListener("mousedown",this.globalMouseDownHandler,true);document.removeEventListener("keyup",this.menuKeyUpHandler);this.rootLevel.hide();if(this.ancorFocused){this.ancorFocused.focus()}if(this.menuClosedCallback){this.menuClosedCallback()}}submitMenu(t,e){if(this.itemSelectedCallback){this.itemSelectedCallback(t,e)}}knockMenuStyle(t){t.removeAttribute("style");const e=t.querySelectorAll("ul").item(0);var s=e&&e.style?true:false;if(s!==false){e.setAttribute("style","")}}refreshItems(){this.rootLevel.refreshItems()}refreshCheckboxes(){this.rootLevel.refreshCheckboxes()}}Me.lastMenuID=0;class Be{constructor(){this.formatStr="";this.pos=0;this.token="text";this.tokenText=""}start(t){this.formatStr=t;this.pos=0;this.tokenText=""}skipSpaces(){while(this.pos<this.formatStr.length&&this.formatStr.charAt(this.pos)===" ")this.pos++}getToken(){return this.token}getTokenText(){return this.tokenText}next(){this.skipSpaces();if(this.pos>=this.formatStr.length)return false;let t=0;if(this.formatStr.charAt(this.pos)==="{"){t=this.formatStr.indexOf("}",this.pos);if(t<0)return false;this.tokenText=this.formatStr.substring(this.pos,t+1);if(this.tokenText.indexOf("{expr")===0||this.tokenText.indexOf("{attr")===0){this.token="expression"}this.pos=t+1}else if(this.formatStr.charAt(this.pos)==="["&&this.pos<this.formatStr.length-1&&this.formatStr.charAt(this.pos+1)==="["){this.pos+=2;t=this.formatStr.indexOf("]]",this.pos);this.token="function";this.tokenText=this.formatStr.substring(this.pos,t);this.pos=t+2}else{this.token="text";let e=this.formatStr.indexOf("{",this.pos);if(e<0)e=this.formatStr.length;let s=this.formatStr.indexOf("[[",this.pos);if(s<0)s=this.formatStr.length;t=Math.min(e,s);this.tokenText=this.formatStr.substring(this.pos,t).trim();this.pos=t}return true}}var Fe;(function(t){t[t["Enable"]=0]="Enable";t[t["Delete"]=1]="Delete";t[t["Hidden"]=2]="Hidden";t[t["SortingNone"]=3]="SortingNone";t[t["SortingAsc"]=4]="SortingAsc";t[t["SortingDesc"]=5]="SortingDesc";t[t["MoveTop"]=6]="MoveTop";t[t["MoveUp"]=7]="MoveUp";t[t["MoveDown"]=8]="MoveDown";t[t["MoveBottom"]=9]="MoveBottom";t[t["Menu"]=10]="Menu";t[t["Type"]=11]="Type";t[t["Format"]=12]="Format"})(Fe||(Fe={}));class Ne{constructor(t,e,s){this.functionMenu=null;this.formatsMenu=null;this.buttonMenu=null;this.isMouseOverBlock=false;this.keepShowingButtons=false;this.panel=t;this.column=e;this.element=s}get cssPrefix(){return"eqjs-qc"}get columnEnabled(){return this.column.enabled}set columnEnabled(t){this.column.enabled=t}render(){if(this.getButtonsToShow().indexOf("sorting")>=0&&this.columnEnabled){this.sortingButton=this.renderSoringButton(this.column.sorting);if(this.column.sorting!==Q.None){this.sortingButton.style.display="block"}}const t=Pt("div");t.data("id",this.column.id);if(this.element){this.element.parentNode.replaceChild(t.toDOM(),this.element)}this.element=t.toDOM();if(this.panel.options.allowDragDrop&&!gt.isMobileMode()){Gt.registerDraggableItem({element:this.element,scope:"entityAttrSort",data:{column:this.column},beforeDragStart:()=>{this.hideButtons()},renderer:t=>{t.innerHTML="";const e=document.createElement("span");e.innerText=this.column.caption;t.classList.add("eqjs-sortable-helper");t.appendChild(e)},onDragStart:t=>{this.element.style.display="none";t.dropEffect=Qt.Allow},onDragEnd:t=>{if(!t.data.finishedSuccessfully){this.element.style.removeProperty("display")}}})}if(this.isEditable()){this.createFunctionMenu();this.createFormatsMenu()}this.createButtonMenu();const e=this.panel.options.editMode===De.Full;const s=this.panel.options.editMode===De.ReadOnly;const i=this.panel.options.showCheckboxes!==false;t.addClass(this.getClassesToAdd()).addClass(Se());if(i&&!s&&!this.column.isReadOnly()){t.addChildElement(this.renderCheckbox())}if(!s){t.addChild("div",(t=>t.addClass(`${$e}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-colelement`,`${this.cssPrefix}-sortbutton-placeholder`).addChildElement(this.sortingButton)))}t.addChildElement(this.renderExpressionBlock());if(this.panel.options.showColumnTitles!==false&&!gt.isMobileMode()){t.addChildElement(this.renderCaptionBlock())}let n=0;let r="";t.addChild("div",(t=>{t.addClass(`${$e}-column-buttonsBlock`,`${this.cssPrefix}-buttonsBlock`).addClass(Se());const h=this.getButtonsToShow();if(h.indexOf("enable")>=0&&e&&!i&&!this.column.isReadOnly()){t.addChildElement(this.renderEnabledButton());n++;r+="Enable"}if(h.indexOf("type")>=0&&this.columnEnabled&&e){t.addChildElement(this.renderColumnTypeButton());n++;r+="Type"}if(h.indexOf("format")>=0&&this.columnEnabled&&!s){t.addChildElement(this.renderColumnFormatButton());n++;r+="Format"}if(h.indexOf("delete")>=0&&e&&!this.column.isReadOnly()){t.addChildElement(this.renderDeleteButton());n++;r+="Delete"}if(h.indexOf("menu")>=0&&!(this.column.isReadOnly()||s)){t.addChildElement(this.renderMenuButton());n++;r+="Menu"}}));t.addClass(`eqjs-buttons-in-block-${n}`);t.addClass(`eqjs-buttons-in-block-${r}`);if(!gt.isMobileMode()){t.on("mouseenter",this.onMouseEnter.bind(this)).on("mouseleave",this.onMouseLeave.bind(this))}if(this.panel.options.accentActiveColumn||gt.isMobileMode()){t.on("click",this.onMouseClick.bind(this))}if(this.panel.options.alwaysShowButtons){this.showButtons()}if(!i){t.addClass("eqjs-no-checkbox")}return this.element}onMouseClick(t){t.stopPropagation();this.activate();return false}activate(){this.panel.toggleColumnPicked(this.column);this.adjustButtonsVisibility();if(!gt.isMobileMode()){this.element.dispatchEvent(kt("mouseenter"))}}fireColumnChanged(){this.column.fireChangedEvent()}refresh(){this.render()}renderCaptionBlock(){const t=Pt("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-captionelement`).addClass(Se());if(this.isEditable()){t.addChild("a",(t=>t.attr("href","javascript:void(0)").title(this.column.caption).text(this.column.caption).on("click",(t=>{t.stopPropagation();this.activate();const e=t.target;const s=e.parentElement.querySelector("input");if(s){e.style.display="none";s.style.removeProperty("display");s.style.minWidth=`${e.clientWidth}`;s.focus();this.element.setAttribute(Gt.DRAG_DISABLED_ATTR,"")}return false})))).addChild("input",(t=>t.hide().value(this.column.caption).on("blur keydown",(t=>{let e=false;let s=true;if(t instanceof KeyboardEvent){if(t.keyCode===13){e=true}else if(t.keyCode===27){e=true;s=false}}else if(t instanceof FocusEvent){e=true}if(e){const e=t.target;const i=e.parentElement.querySelector("a");if(i){i.style.removeProperty("display");e.style.display="none"}if(s&&this.column.caption!==e.value){this.column.caption=e.value;this.fireColumnChanged()}else{e.value=this.column.caption;ke(i)}this.element.removeAttribute(Gt.DRAG_DISABLED_ATTR)}return true}))))}else{t.addChild("span",(t=>{t.text(this.column.caption).title(this.column.caption)}))}return t.toDOM()}renderSoringButton(t){const e=`${$e}-column-sortbutton`;let s;switch(t){case Q.Ascending:s=`${e}-asc`;break;case Q.Descending:s=`${e}-desc`;break;default:s=`${e}-none`;break}if(!this.isEditable()||gt.isMobileMode()){if(t===Q.Ascending||t===Q.Descending)return Pt("div").addClass(e,`${$e}-button`,s).title(a.getText("ButtonSorting")).toDOM();return null}return Pt("div").addClass(e,`${$e}-button`,s).data("btnplaceholder","").title(a.getText("ButtonSorting")).attr("tabIndex","0").on("click",(t=>{t.stopPropagation();this.activate();this.keepShowingButtons=true;const e=this.getUIS()?this.panel.sortMenu||this.panel.moveMenu:this.panel.moveMenu;e.showMenu({anchor:this.sortingButton,selectedIds:this.getButtonMenuSelectedItems(),itemSelectedCallback:(t,e)=>{let s;switch(t.id){case"IsHidden":s=Fe.Hidden;break;case"MoveTop":s=Fe.MoveTop;break;case"MoveDown":s=Fe.MoveDown;break;case"MoveUp":s=Fe.MoveUp;break;case"MoveBottom":s=Fe.MoveBottom;break;case"None":s=Fe.SortingNone;break;case"Ascending":s=Fe.SortingAsc;break;case"Descending":s=Fe.SortingDesc;break}this.buttonMenuHandler(s,null)},menuClosedCallback:()=>{this.keepShowingButtons=false;if(!this.isMouseOverBlock){this.leaveButtonBlock()}}})})).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).toDOM()}renderCheckbox(){return Pt("div").title(a.getText("CmdToggleEnable")).attr("tabIndex","0").addClass(`${this.cssPrefix}-colelement ${this.cssPrefix}-column-checkbox`).addClass(`${this.columnEnabled?"enabled":""}`).on("click",(()=>{this.columnEnabled=!this.columnEnabled;this.column.fireChangedEvent();return false})).on("keypress",(t=>{if([13,32].includes(t.keyCode)){t.target.click()}})).toDOM()}renderDeleteButton(){return Pt("div").addClass(`${$e}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-deletebutton-placeholder`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${$e}-button`,`${$e}-column-button`,`${$e}-column-button-delete`).title(a.getText("CmdDelete")).attr("tabIndex","0").on("click",(t=>this.buttonMenuHandler(Fe.Delete,t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})))).toDOM()}renderMenuButton(){return Pt("div").addClass(`${$e}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-menubutton-placeholder`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${$e}-button`,`${$e}-column-button`,`${$e}-column-button-menu`).title(a.getText("ButtonMenu")).attr("tabIndex","0").on("click",(t=>this.buttonMenuHandler(Fe.Menu,t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})))).toDOM()}getClassesToAdd(){let t="";t+=this.columnEnabled?"":` ${this.cssPrefix}-disabled`;if(this.columnEnabled){t+=this.column.isReadOnly()?` ${this.cssPrefix}-readonly`:""}t+=this.column.isHidden()?` ${this.cssPrefix}-hidden`:"";return t}renderColumnTypeButton(){return this.isEditable()&&this.panel.options.allowAggrColumns!==false?Pt("div").addClass(`${$e}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-typebutton-placeholder`,`${this.cssPrefix}-button-active`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${$e}-button`,`${$e}-column-button`,`${$e}-column-button-type`).title(a.getText("ButtonToAggr")).attr("tabIndex","0").on("click",(t=>{t.stopPropagation();this.activate();this.keepShowingButtons=true;this.changeTypeHandler(t)})).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})))).toDOM():null}renderColumnFormatButton(){const t=this.getFormatsMenuItems();return this.isEditable()&&this.panel.options.allowDisplayFormatChange!==false&&t.length>1?Pt("div").addClass(`${$e}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-formatbutton-placeholder`,`${this.cssPrefix}-button-active`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${$e}-button`,`${$e}-column-button`,`${$e}-column-button-format`).title(a.getText("ButtonFormat")).attr("tabIndex","0").on("click",(t=>{t.stopPropagation();this.keepShowingButtons=true;this.changeFormatHandler(t)})).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})))).toDOM():null}renderEnabledButton(){return Pt("div").addClass(`${$e}-button-placeholder`,`${this.cssPrefix}-button-placeholder`,`${this.cssPrefix}-enablebutton-placeholder`,`${this.cssPrefix}-button-active`).data("btnplaceholder","").addChild("div",(t=>t.addClass(`${$e}-button`,`${$e}-column-button`,`${$e}-column-button-enable`).title(a.getText("CmdToggleEnable")).addClass(this.columnEnabled?"enabled":"").attr("tabIndex","0").on("click",(t=>this.buttonMenuHandler(Fe.Enable,t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})))).toDOM()}isEditable(){switch(this.panel.options.editMode){case De.ReadOnly:return false;default:return this.column.enabled&&!this.column.isReadOnly()}}changeFormatHandler(t){const e=this.panel.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());let s="{0:__default}";if(e.filter((t=>t.format==this.column.displayFormat)).length>0){s=this.column.displayFormat}this.formatsMenu.showMenu({anchor:t.target,selectedIds:s,itemSelectedCallback:(t,e)=>{if(t.id!=s){if(t.id=="{0:__default}"){this.column.displayFormat=""}else{this.column.displayFormat=t.id}this.column.fireChangedEvent()}return false},menuClosedCallback:()=>{this.keepShowingButtons=false;if(!this.isMouseOverBlock){this.element.dispatchEvent(kt("mouseleave"))}}})}getUIS(){return this.panel.getContext().getModel().checkAttrProperty(this.column.expr.value,"useInSorting")}onMouseEnter(t){this.isMouseOverBlock=true;this.enterButtonBlock();t.stopPropagation();return false}onMouseLeave(t){this.isMouseOverBlock=false;this.leaveButtonBlock();t.stopPropagation();return false}isColumnActive(){return this.element.classList.contains("active")}hideButtons(){Pt(this.element).data("show-buttons",null)}showButtons(){Pt(this.element).data("show-buttons","")}adjustButtonsVisibility(){if(this.panel.options.alwaysShowButtons||(this.panel.options.accentActiveColumn||gt.isMobileMode())&&this.isColumnActive()){this.showButtons()}}enterButtonBlock(){this.showButtons()}leaveButtonBlock(){if(!this.keepShowingButtons&&this.panel.options.alwaysShowButtons!==true&&(!this.isColumnActive()||this.panel.options.accentActiveColumn!=true)){this.hideButtons()}}createFunctionMenu(){const t=[];const e=this.panel.getContext().getModel().getAggrFunctions();let s=true;let i=null;const n=this.column.getDataType();let r;for(const h of e){if(!h)continue;const e=h.getAppliedTypesOrDefault().indexOf(n)>=0;if(this.column.expr.func===h.id&&!e){s=false}if(e){r=this.panel.getContext().getModel().getAggrFunctionCaption(h.id);i={id:h.id,text:r};t.push(i)}}if(!s&&t.length>0){this.column.expr.func=t[0].id}const h=this.panel;if(h.areCustomExpressionsAllowed()){i={id:"CustomSqlDivider",text:"---"};t.push(i);r=a.getText("CustomExpression");i={id:"CUSTOMSQL",text:r};t.push(i)}let o=this.column.id;if(o){o+="-FunctionsMenu"}const l={items:t,id:o,searchBoxAlwaysShown:false,domWriteItemsId:true};this.functionMenu=new Me(l)}createFormatsMenu(){if(this.panel.options.allowDisplayFormatChange==false)return;let t=this.column.id;if(t){t+="-FormatsMenu"}const e=this.getFormatsMenuItems();const s={items:e,id:t,searchBoxAlwaysShown:false,showSelected:true,domWriteItemsId:true};this.formatsMenu=new Me(s)}getFormatsMenuItems(){const t=this.panel.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());return[{id:"{0:__default}",text:"Default"}].concat(t.map((t=>({id:t.format,text:a.getText("DisplayFormats",t.name)||t.name}))))}getButtonsToShow(){if(this.panel.options.editMode===De.ReadOnly){return[]}if(this.panel.options.editMode===De.FixedList){return["sorting","format"]}return this.panel.options.buttons&&Array.isArray(this.panel.options.buttons)?this.panel.options.buttons:["enable","delete","type","sorting","format"]}buttonMenuHandler(t,e){switch(t){case Fe.Delete:const s=this.column.getQuery();s.removeColumn(this.column);s.fireColumnsChangedEvent(O.Delete,this.column);break;case Fe.Enable:this.activate();this.columnEnabled=!this.columnEnabled;this.fireColumnChanged();break;case Fe.Hidden:this.column.setHidden(!this.column.isHidden());this.fireColumnChanged();break;case Fe.MoveTop:this.panel.moveColumn(this.column,"MoveTop");break;case Fe.MoveBottom:this.panel.moveColumn(this.column,"MoveBottom");break;case Fe.MoveUp:this.panel.moveColumn(this.column,"MoveUp");break;case Fe.MoveDown:this.panel.moveColumn(this.column,"MoveDown");break;case Fe.SortingAsc:this.column.sorting=Q.Ascending;this.column.fireChangedEvent();break;case Fe.SortingDesc:this.column.sorting=Q.Descending;this.column.fireChangedEvent();break;case Fe.SortingNone:this.column.sorting=Q.None;this.column.fireChangedEvent();break;case Fe.Menu:const i=this.buttonMenu;this.keepShowingButtons=true;this.activate();i.showMenu({anchor:e?e.target:null,selectedIds:this.getButtonMenuSelectedItems(),itemSelectedCallback:t=>{let s=t.id;switch(t.id){case"enable":s=Fe.Enable;break;case"delete":s=Fe.Delete;break;case"hidden":s=Fe.Hidden;break;case"MoveTop":s=Fe.MoveTop;break;case"MoveBottom":s=Fe.MoveBottom;break;case"MoveUp":s=Fe.MoveUp;break;case"MoveDown":s=Fe.MoveDown;break;case"None":s=Fe.SortingNone;break;case"Ascending":s=Fe.SortingAsc;break;case"Descending":s=Fe.SortingDesc;break}this.buttonMenuHandler(s,e)},itemFilterCallback:t=>{let e=this.columnEnabled||t.id==="__group"||t.id==="enable"||t.id==="delete";return e},menuClosedCallback:()=>{this.keepShowingButtons=false;if(!this.isMouseOverBlock)this.leaveButtonBlock()}});break;default:if(!this.processFormatsButtonMenuItems(t,e))this.processExtraButtonMenuItems(t,e);break}e&&e.stopPropagation();return false}createButtonMenu(){if(!this.buttonMenu){let t=this.column.id;if(t){t+="-ButtonMenu"}const e=[];e.push({id:"enable",text:a.getText("MenuEnable")});if(this.panel.options.allowHiddenColumns){e.push({id:"hidden",text:a.getText("CmdHiddenColumn")})}e.push({id:"delete",text:a.getText("CmdDelete")});let s=[];s.push({id:"__group",text:a.getText("CmdGroupAppearance"),items:e});const i=this.panel.options.allowSorting?[...this.panel.getSortMenuList(),...this.panel.getMoveMenuList()]:this.panel.getMoveMenuList();s.push({id:"__group",text:a.getText("CmdGroupSort"),items:i});const n=this.getExtraButtonMenuItems();if(n&&Array.isArray(n)){s=[...s,...n]}const r=this.getFormatsMenuItems();if(r.length>1){s.push({id:"__group",text:a.getText("CmdGroupFormat"),items:r})}const h={items:s,id:t,searchBoxAlwaysShown:false,domWriteItemsId:true,showSelected:true};this.buttonMenu=new Me(h)}}processFormatsButtonMenuItems(t,e){const s=this.panel.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());if(t=="{0:__default}"){this.column.displayFormat=""}else if(s.filter((e=>e.format==t)).length>0){this.column.displayFormat=t}else{return false}this.column.fireChangedEvent();return true}getButtonMenuSelectedItems(){let t=[];if(this.columnEnabled){t.push("enable")}if(this.column.isHidden()){t.push("hidden")}switch(this.column.sorting){case Q.None:t.push("None");break;case Q.Ascending:t.push("Ascending");break;case Q.Descending:t.push("Descending");break}const e=this.panel.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());let s="{0:__default}";if(e.filter((t=>t.format==this.column.displayFormat)).length>0){s=this.column.displayFormat}t.push(s);return t}}class Le extends Ne{getClassesToAdd(){return`${super.getClassesToAdd()} ${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`}renderExpressionBlock(){return Pt("div").addClass(`${this.cssPrefix}-expr-block`).addClass(Se()).addChild("div",(t=>t.addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-attrelement`).addClass(Se()).addChildElement(this.renderBaseExpression()))).toDOM()}getAttribute(){const t=this.panel.getContext().getModel();return t.getAttributeByIdSafe(this.column.expr.value)}renderBaseExpression(){const t=this.getAttribute();const e=this.panel.getContext().getAttributeTitle(t);if(this.isEditable()&&this.panel.options.editMode===De.Full){return Pt("a").attr("href","javascript:void(0)").title(e).text(e).on("click",(t=>{console.log("columns expression click");t.stopPropagation();this.activate();this.panel.showEntitiesMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:this.baseExpressionItemSelectedCallback.bind(this),itemFilterCallback:t=>t.id!=="__AddAll__"});return false})).toDOM()}else{return Pt("span").text(e).title(e).toDOM()}}baseExpressionItemSelectedCallback(t,e){const s=t.id;const i=this.panel.getContext();var n=i.getModel().getAttributeById(s);this.updateBaseAttr(n);this.column.caption=i.getDefaultColumnCaption(this.column);this.fireColumnChanged();return false}updateBaseAttr(t){this.column.expr.setValue(t.id,true);this.column.expr.baseAttrId=t.id;this.column.expr.dataType=t.dataType}getUIS(){const t=this.column.expr.args[0];if(t){const e=this.panel.getContext().getModel();return e.checkAttrProperty(t.value,"useInSorting")}else{return true}}changeTypeHandler(t){this.keepShowingButtons=true;this.functionMenu.showMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>{this.processExtraButtonMenuItems(t.id,null);return false},menuClosedCallback:()=>{this.keepShowingButtons=false;if(!this.isMouseOverBlock){this.element.dispatchEvent(kt("mouseleave"))}}})}changeTypeToCustomSql(){const t=this.column.getQuery();t.changeColumnType(this.column,L.CustomSql);const e=this.element.parentElement;setTimeout((()=>{const t=e.querySelector(`div[data-id='${this.column.id}']  div[class*='${this.cssPrefix}-expr-block']  div[class*='${this.cssPrefix}-colelement']  a`);if(t)t.click()}),500);this.fireColumnChanged()}changeTypeToAggr(t){const e=this.column.getQuery();e.changeColumnType(this.column,L.AggregateFunction,{funcId:t});this.fireColumnChanged()}processExtraButtonMenuItems(t,e){if(t==="CUSTOMSQL"){this.changeTypeToCustomSql()}else{this.changeTypeToAggr(t)}return true}getExtraButtonMenuItems(){const t=[];const e=this.panel.getContext().getModel().getAggrFunctions();let s=true;let i=true;var n=null;const r=this.getAttribute();let h;for(const o of e){s=o.getAppliedTypesOrDefault().indexOf(r.dataType)>=0;if(this.column.expr.func===o.id&&!s){i=false}if(s){h=this.panel.getContext().getModel().getAggrFunctionCaption(o.id);n={id:o.id,text:h};t.push(n)}}if(!i&&t.length>0){this.column.expr.func=t[0].id}const o=this.panel;if(o.areCustomExpressionsAllowed()){n={id:"CustomSqlDivider",text:"---"};t.push(n);h=a.getText("CustomExpression");n={id:"CUSTOMSQL",text:h};t.push(n)}return[{id:"__group",text:a.getText("ColTypeGroup"),items:t}]}}class Re extends Le{constructor(){super(...arguments);this.displayFormatParser=new Be}getClassesToAdd(){return`${super.getClassesToAdd()} ${this.cssPrefix}-row ${this.cssPrefix}-row-column-aggr`}getAttribute(){return this.panel.getContext().getModel().getAttributeByIdSafe(this.column.expr.args[0].value)}renderExpressionBlock(){const t=this.panel.getContext().getModel();const e=Pt("div").addClass(`${this.cssPrefix}-expr-block`,`${this.cssPrefix}-expr-block-aggr`).addClass(Se());const s=t.getAggrFunctionFormat(this.column.expr.func);if(!s||s==="")return;const i=this.parseDisplayFormat(s);if(i.length===0)return;let n=null;const r=i.length;for(let t=0;t<r;t++){n=i[t];if(n.type===1){if(this.panel.options.editMode===De.Full&&this.isEditable()){const t=Pt("a").attr("href","javascript:void(0)").text(n.text).on("click",(e=>{e.stopPropagation();this.activate();this.functionMenu.showMenu({anchor:t.toDOM(),selectedIds:null,itemSelectedCallback:(t,e)=>{if(t.id==="CUSTOMSQL"){this.changeTypeToCustomSql()}else{this.column.expr.func=t.id;this.column.caption="";this.fireColumnChanged()}}})}));e.addChild("div",(e=>e.addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-aggrfuncelement`).addClass(Se()).addChildElement(t.toDOM())))}else{e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-aggrfuncelement`).addClass(Se()).addChild("span",(t=>t.text(n.text).title(n.text)))))}}else if(n.type===2){e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-attrelement`).addClass(Se()).addChildElement(this.renderBaseExpression())))}else if(n.type===3){e.addChild("span",(t=>t.addClass(`${this.cssPrefix}-colelement`).addClass(Se()).text(n.text).title(n.text)))}}return e.toDOM()}renderColumnTypeButton(){const t=super.renderColumnTypeButton();if(t){t.firstElementChild.classList.add("aggregated");t.firstElementChild.setAttribute("title",a.getText("ButtonToSimple"))}return t}changeTypeToSimple(){const t=this.column.getQuery();t.changeColumnType(this.column,L.EntityAttribute);this.fireColumnChanged()}parseDisplayFormat(t){if(!t)return[];let e=[];const s=this.displayFormatParser;s.start(t);while(s.next()){const t=s.getToken();const i=s.getTokenText();if(t==="function"){e.push({type:1,text:i})}else if(t==="expression"){e.push({type:2})}else if(t==="text"){e.push({type:3,text:i})}}return e}updateBaseAttr(t){this.column.expr.args[0].setValue(t.id,true);this.column.expr.baseAttrId=t.id}changeTypeHandler(t){this.changeTypeToSimple()}processExtraButtonMenuItems(t,e){this.changeTypeToSimple();return true}getExtraButtonMenuItems(){return[{id:"__group",text:a.getText("ColTypeGroup"),items:[{id:"type",text:a.getText("ColTypeSimple")}]}]}}class Pe extends Le{constructor(){super(...arguments);this.dataTypeMenu=null}renderEnabledButton(){const t=super.renderEnabledButton();const e=t.children[0];e.title=a.getText("CmdToggleEnableCustom");return t}getClassesToAdd(){return`${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`+super.getClassesToAdd()}renderExpressionBlock(){const e=Pt("div").addClass(`${this.cssPrefix}-expr-block`).addClass(Se()).toDOM();let s=Pt("div",e).addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-attrelement`).addClass(Se());if(this.isEditable()&&this.panel.options.editMode===De.Full){s.addChild("a",(t=>t.attr("href","javascript:void(0)").title(this.column.caption).text(this.column.caption).on("touchstart click",(t=>{t.stopPropagation();const e=t.target;const s=e.parentElement.querySelector("input");if(s){e.style.display="none";s.style.removeProperty("display");s.style.width=`100%`;s.focus();this.element.setAttribute(Gt.DRAG_DISABLED_ATTR,"")}})))).addChild("input",(t=>t.hide().value(this.getColumnValue()).on("blur keydown",(t=>{let e=false;let s=true;if(t instanceof KeyboardEvent){if(t.keyCode===13){e=true}else if(t.keyCode===27){e=true;s=false}}else if(t instanceof FocusEvent){e=true}if(e){const e=t.target;const i=e.parentElement.querySelector("a");if(i){i.style.removeProperty("display");e.style.display="none"}const n=this.getColumnValue();if(s&&n!==e.value){this.setColumnValue(e.value);this.fireColumnChanged()}else{e.value=n}this.element.removeAttribute(Gt.DRAG_DISABLED_ATTR)}}))))}else{s.addChild("span",(t=>{t.text(this.column.caption).title(this.column.caption)}))}s=Pt("div",e).addClass(`${this.cssPrefix}-colelement`).addChild("span",(t=>{t.text(":").title(":")}));s=Pt("div",e).addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-attrelement`).addClass(Se());if(this.panel.options.editMode===De.Full&&this.isEditable()){this.createDataTypeMenu();s.addChild("a",(e=>e.attr("href","javascript:void(0)").title(t[this.column.expr.dataType]).text(t[this.column.expr.dataType]).on("touchstart click",(t=>{t.stopPropagation();this.dataTypeMenu.showMenu({anchor:e.toDOM(),selectedIds:null,itemSelectedCallback:(t,e)=>{this.column.expr.dataType=t.id;this.fireColumnChanged()}})}))))}else{s.addChild("span",(e=>{e.text(t[this.column.expr.dataType]).title(t[this.column.expr.dataType])}))}return e}changeTypeToSimple(){const t=this.column.getQuery();t.changeColumnType(this.column,L.EntityAttribute);this.fireColumnChanged()}getColumnValue(){return""}setColumnValue(t){}getUIS(){return true}changeTypeHandler(t){this.changeTypeToSimple()}processExtraButtonMenuItems(t,e){this.changeTypeToSimple();return true}createFunctionMenu(){}getExtraButtonMenuItems(){return[{id:"__group",text:a.getText("ColTypeGroup"),items:[{id:"type",text:a.getText("ColTypeSimple")}]}]}createDataTypeMenu(){const e=[];for(let s in t){if(!isNaN(Number(s))){const i={id:s,text:t[s]};e.push(i)}}let s=this.column.id;if(s){s+="-DataTypeMenu"}const i={items:e,id:s,searchBoxAlwaysShown:false,domWriteItemsId:true};this.dataTypeMenu=new Me(i)}}class Oe extends Pe{get columnEnabled(){return this.panel.areCustomExpressionsAllowed()?this.column.enabled:false}set columnEnabled(t){if(this.panel.areCustomExpressionsAllowed()){this.column.enabled=t}else{this.column.enabled=false}}renderColumnTypeButton(){const t=super.renderColumnTypeButton();if(t){t.firstElementChild.classList.add("aggregated");t.firstElementChild.setAttribute("title",a.getText("ButtonToSimple"))}return t}getColumnValue(){return this.column.expr.sql}setColumnValue(t){this.column.expr.sql=t}getDefaultValue(){return this.column.expr.sql}}class Qe extends Pe{renderColumnTypeButton(){const t=super.renderColumnTypeButton();if(t){t.firstElementChild.classList.add("aggregated");t.firstElementChild.setAttribute("title",a.getText("ButtonToSimple"))}return t}getColumnValue(){return this.column.expr.value}setColumnValue(t){this.column.expr.setValue(t)}getDefaultValue(){return this.column.expr.value}}class qe extends mt{get cssPrefix(){return"eqjs-qc"}constructor(t){super(t);this.options={isSubQuery:false,activeColumn:null,showAddRow:true,showHeader:true,showColumnTitles:true,allowAggrColumns:true,allowDuplicates:true,allowCustomExpressions:false,allowSorting:true,attrElementFormat:"{entity} {attr}",titleElementFormat:null,buttons:null,alwaysShowButtons:false,accentActiveColumn:true,allowDragDrop:true,menuOptions:{showSearchBoxAfter:30,searchBoxAutoFocus:true,activateOnMouseOver:true,adjustHeight:true,itemRenderedCallback:null},attrPlacement:0,sortEntities:false,columnRenderedCallback:null,customExpressionText:0,allowHiddenColumns:false,showAddAllForEntity:false,showIndicatorOnLoad:true,editMode:De.Full};this.landingSlot=Pt("div").addClass(`${this.cssPrefix}-col-landing-slot`).addChildElement(Pt("div").toDOM()).toDOM();this.landingIndex=-1;this.slot.classList.add(`${this.cssPrefix}-panel`);this.group=it.Query}getWidgetType(){return"columnsPanel"}get editMode(){return this.options.editMode||De.Full}set editMode(t){if(this.options.editMode!==t){this.options.editMode=t;this.refresh()}}init(t,e){super.init(t,e);this.setOptions(e);this.renderProgressBlock();const s=t.getModel();this.detachQueryObserver();this.attachQueryObserver();Gt.removeDropContainer(this.slot);if(this.options.allowDragDrop){Gt.registerDropContainer({element:this.slot,scopes:["entityAttr","entityAttrSort"],onDragEnter:(t,e)=>{this.slot.classList.add(`${$e}-drophover`);if(e.item.scope==="entityAttrSort"){this.showLandingSlot(e.pageX,e.pageY)}else{const t=e.data.attrId;if(!s.checkAttrProperty(t,"useInResult")){e.dropEffect=Qt.Forbid}e.dragImage.classList.add("eqjs-sortable-helper")}},onDragOver:(t,e)=>{const i=e.data.attrId;if(e.item.scope==="entityAttrSort"||s.checkAttrProperty(i,"useInResult")){this.showLandingSlot(e.pageX,e.pageY)}},onDragLeave:(t,e)=>{if(e.item.scope==="entityAttrSort"){e.dropEffect=Qt.Forbid}else{e.dragImage.classList.remove("eqjs-sortable-helper");e.dragImage.style.removeProperty("width")}this.slot.classList.remove(`${$e}-drophover`);this.hideLandingSlot()},onDrop:(t,e)=>{if(e.item.scope=="entityAttrSort"){const t=this.getQuery();const s=t.getColumns();const i=s.indexOf(e.data.column);this.moveColumnCore(i,this.landingIndex)}else{const t=e.data.attrId;this.addNewColumn(t,this.landingIndex)}}})}}renderBaseElements(){let t=0;if(this.options.showHeader){const e=Pt("div",this.slot).hide().addClass(`${this.cssPrefix}-header`).addClass(Se());if(!this.options.alwaysShowButtons){e.addClass("eqjs-no-buttons")}if(this.options.showCheckboxes){e.addChild("div",(t=>t.setStyle("margin-left","30px")))}else{e.addClass("eqjs-no-checkbox")}e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-header-expression`).text(a.getText("HeaderExpression"))));if(this.options.showColumnTitles!==false){e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-header-title`).text(a.getText("HeaderTitle"))))}this.headerElement=e.toDOM();t+=this.headerElement.offsetHeight}this.columnsBlock=Pt("div",this.slot).addClass(`${this.cssPrefix}-columns`).addClass(Se()).toDOM();if(this.options.showAddRow&&this.options.editMode===De.Full){this.addRowElement=Pt("div",this.slot).addClass(`${$e}-addrow`,`${this.cssPrefix}-addrow`,`${$e}-addrow-empty`).addClass(Se()).addChild("a",(t=>t.attr("href","javascript:void(0)").text(a.getText("CmdClickToAddColumn")).on("click",(t=>{console.log("Add new column");t.preventDefault();this.showEntitiesMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>{if(t.id==="__AddAll__"&&t.extra&&Array.isArray(t.extra.ids)){t.extra.ids.forEach((t=>this.addNewColumn(t)))}else{const e=t.id;this.addNewColumn(e)}return false}})})))).toDOM();t+=this.addRowElement.offsetHeight}this.columnsBlock.style.maxHeight=`${this.slot.offsetHeight-t-25}px`}destroyCore(){Gt.removeDropContainer(this.slot);this.detachQueryObserver();this.slot.innerHTML=""}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((e=>{const s=e.data;if(!s||s.part!=P.Columns&&s.part!=P.Aggregation&&s.part!=P.All){return}const i=document.activeElement;const n=this.slot.contains(i)||i==document.body;switch(s.action){case O.Modify:{const t=s.changee;const e=t=>{const e=this.columnsBlock.querySelector(`div[data-id='${t.id}']`);if(e){const s=this.getColumnRenderer(t,e);if(s){const t=s.render();if(n){const e=t.querySelector("a")||t.querySelector(".eqjs-column-button");if(e){e.focus()}}}}};if(Array.isArray(t)){t.forEach((t=>e(t)))}else{e(t)}this.agjustHeaderVisibility();break}case O.Add:{const e=s.changee;const i=e=>{const s=t.getColumns().indexOf(e);const i=this.addColumnElement(e,s);if(n){const t=i.querySelector("a");if(t){try{t.focus()}catch(t){}}}};if(Array.isArray(e)){e.forEach((t=>i(t)))}else{i(e)}this.agjustHeaderVisibility();break}case O.Delete:{const t=s.changee;const e=t=>{const e=this.columnsBlock.querySelector(`div[data-id='${t.id}']`);if(e){const t=e.nextSibling;const s=e.previousSibling;this.columnsBlock.removeChild(e);if(n){const e=t||s||this.addRowElement;const i=e.querySelector("a")||e.querySelector(".eqjs-column-button");if(i){i.focus()}}}};this.agjustHeaderVisibility();if(Array.isArray(t)){t.forEach((t=>e(t)))}else{e(t)}break}default:this.refresh();break}}))}detachQueryObserver(){if(this.queryEventCallbackId){const t=this.getQuery();t.removeChangedCallback(this.queryEventCallbackId)}}getQuery(){return this.getContext().getQuery()}showLandingSlot(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`);const i=[];for(let t=0;t<s.length;t++){const e=s[t];if(e.style.display==="none")continue;i.push(e)}if(i.length===0){this.landingIndex=0;this.columnsBlock.appendChild(this.landingSlot);return}const n=St(this.landingSlot);if(e>=n.y&&e<=n.y+this.landingSlot.offsetHeight){return}const r=i[0];const h=r.offsetHeight;const o=St(r);let l=e>o.y+h/2?Math.round((e-o.y+h/2)/h):0;if(l>i.length){l=i.length}if(l!=this.landingIndex){this.landingIndex=l;if(this.landingIndex<i.length){this.columnsBlock.insertBefore(this.landingSlot,i[this.landingIndex])}else{this.columnsBlock.appendChild(this.landingSlot)}this.landingSlot.scrollIntoView({block:"center",behavior:"smooth"})}}hideLandingSlot(){this.landingIndex=-1;setTimeout((()=>{if(this.landingSlot.parentElement){this.landingSlot.parentElement.removeChild(this.landingSlot)}}),10)}setOptions(t){r.assignDeep(this.options,t);if(typeof t.allowCustomExpressions!=="undefined"){this.context.options.allowCustomExpressions=t.allowCustomExpressions}if(t.attrElementFormat){this.context.options.attributeFormat=t.attrElementFormat}if(t.titleElementFormat){this.context.options.columnTitleFormat=t.titleElementFormat}if(gt.isMobileMode()){this.options.buttons=["menu","sorting"];this.options.showHeader=false}}onProcessStartCore(){if(this.options.showIndicatorOnLoad){if(!this.progressBlock.parentNode)this.slot.appendChild(this.progressBlock)}}onProcessEndCore(){if(this.options.showIndicatorOnLoad){if(this.progressBlock.parentNode)this.slot.removeChild(this.progressBlock)}}refreshCore(){this.clear();this.render()}clear(){this.slot.innerHTML=""}render(){try{this.renderBaseElements();this.createEntitiesMenu();this.createColumnMenus();this.agjustHeaderVisibility();Pt(this.slot).removeClass(Te).addClass(Se());const t=this.context.getQuery();const e=t.getColumns();for(let t of e){this.columnsBlock.appendChild(this.renderColumn(t))}}catch(t){let e=t;this.context.throwError({action:"ColumnsPanel rendering",text:e.message,sourceError:e})}}agjustHeaderVisibility(){if(this.headerElement){const t=this.context.getQuery();const e=t.getColumns();this.headerElement.style.display=e.length?"":"none"}}renderColumn(t){const e=this.getColumnRenderer(t);if(e)return e.render();return null}toggleColumnPicked(t){let e;let s;if(t){e=this.columnsBlock.querySelector(`div[data-id=${t.id}]`);if(e){s=e.classList.contains("active")}}const i=this.columnsBlock.querySelectorAll(`.${this.cssPrefix}-row`);for(let t=0;t<i.length;t++){const e=i[t];Pt(e).removeClass("active");if(!this.options.alwaysShowButtons){Pt(e).data("show-buttons",null)}}if(e&&!s){Pt(e).addClass("active").data("show-buttons","")}}addNewColumn(t,e){if(this.options.editMode!==De.Full){return null}this.getContext().getModel();const s=this.getQuery();if(Array.isArray(t)){let i=null;let n=[];for(let r=0;r<t.length;r++){i=s.addColumn({attributeId:t[r],index:e},true);if(i){n.push(i)}}s.fireChangedEvent({part:P.Columns,action:O.Add,changee:n,source:this});return n}else{const i=s.addColumn({attributeId:t,index:e});return i}}addColumnElement(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`);const i=this.renderColumn(t);if(s.length>0){if(e<s.length){this.columnsBlock.insertBefore(i,s[e])}else{this.columnsBlock.appendChild(i);this.scrollToBottom()}}else{this.columnsBlock.appendChild(i);this.scrollToBottom()}if(this.options.columnRenderedCallback){this.options.columnRenderedCallback(i)}return i}scrollToBottom(){this.columnsBlock.scrollTop=this.columnsBlock.scrollHeight-this.columnsBlock.clientHeight}checkColumnsArray(t){let e=t.length;const s=[];for(let i=0;i<e;i++){if(this.checkColumn(t[i]))s.push(t[i])}return s}checkColumn(t){if(!this.options.allowDuplicates){const e=this.getQuery();const s=e.getColumns();for(let e=0;e<s.length;e++){if((t.expr.tag===L.EntityAttribute&&s[e].expr.tag===L.EntityAttribute||t.expr.tag===L.ParentEntityAttribute&&s[e].expr.tag===L.ParentEntityAttribute)&&t.expr.value===s[e].expr.value){return null}}}return t}getColumnsBlock(){return this.columnsBlock}getColumnRenderer(t,e){switch(t.expr.tag){case L.Constant:return new Qe(this,t,e);case L.AggregateFunction:return new Re(this,t,e);case L.CustomSql:return new Oe(this,t,e);default:return new Le(this,t,e)}}areCustomExpressionsAllowed(){const t=this.getQuery();return t.isEx()&&this.getContext().options.allowCustomExpressions}addAllColumnsToEntitiesList(t){const e=t.filter((t=>!t.isEntity)).map((t=>t.id));if(e.length>0){t.unshift({id:"__AddAll__",text:a.getText("AddAllForEntityText"),extra:{ids:e}})}t.forEach((t=>{if(t.items){this.addAllColumnsToEntitiesList(t.items)}}))}createEntitiesMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;if(e){e+="-EntitiesMenu"}const s=t.getEntitiesTree({addUIC:false,addUIR:true,addUIS:false,attrPlacement:this.options.attrPlacement,sortEntities:this.options.sortEntities});if(this.options.showAddAllForEntity){this.addAllColumnsToEntitiesList(s)}const i={id:e,items:s,adjustHeight:this.options.adjustEntitiesMenuHeight,domWriteItemsId:this.options.domWriteItemsId};r.assign(i,this.options.menuOptions);this.entitiesMenu=new Me(i)}getSortMenuList(){return[{id:"None",text:a.getText("CmdNotSorted")},{id:"Ascending",text:a.getText("CmdAscending")},{id:"Descending",text:a.getText("CmdDescending")},{id:"---",text:"---"}]}getMoveMenuList(){return[{id:"MoveTop",text:a.getText("CmdMoveToFirst")},{id:"MoveUp",text:a.getText("CmdMoveToPrev")},{id:"MoveDown",text:a.getText("CmdMoveToNext")},{id:"MoveBottom",text:a.getText("CmdMoveToLast")}]}createSortMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;if(e){e+="-SortMenu"}const s=this.getSortMenuList().concat(this.moveMenu.getItems());const i={id:e,items:s,domWriteItemsId:this.options.domWriteItemsId,showSelected:true};r.assign(i,this.options.menuOptions);i.searchBoxAlwaysShown=false;this.sortMenu=new Me(i)}createMoveMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;if(e){e+="-MoveMenu"}const s=r.createArrayFrom(this.getMoveMenuList());if(this.options.allowHiddenColumns){s.push({id:"---",text:"---"});s.push({id:"IsHidden",text:a.getText("CmdHiddenColumn")})}const i={items:s,id:e,domWriteItemsId:this.options.domWriteItemsId,showSelected:true};r.assign(i,this.options.menuOptions);this.moveMenu=new Me(i);i.searchBoxAlwaysShown=false}showEntitiesMenu(t){this.entitiesMenu.showMenu(t)}moveColumn(t,e){if(this.options.editMode!==De.Full&&this.options.editMode!==De.FixedList){return}const s=this.getQuery();const i=s.getColumns();const n=i.indexOf(t);if(n>=0){switch(e){case"MoveTop":if(n==0){return}this.moveColumnCore(n,0);break;case"MoveUp":if(n==0){return}this.moveColumnCore(n,n-1);break;case"MoveDown":if(n==i.length-1){return}this.moveColumnCore(n,n+1);break;case"MoveBottom":if(n==i.length-1){return}this.moveColumnCore(n,i.length-1);break}}}moveColumnCore(t,e){const s=this.getQuery();if(!s)return;const i=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`);const n=i[t];if(e==0){this.columnsBlock.insertBefore(n,this.columnsBlock[0])}else if(e>0&&e<i.length-1){if(t<e){this.columnsBlock.insertBefore(n,i[e+1])}else{this.columnsBlock.insertBefore(n,i[e])}}else{this.columnsBlock.appendChild(n)}s.moveColumn(t,e);s.fireColumnsChangedEvent()}createColumnMenus(){this.createMoveMenu();if(this.options.allowSorting){this.createSortMenu()}}renderProgressBlock(){this.progressBlock=document.createElement("div");this.progressBlock.classList.add(`${$e}-progress-win8`);this.progressBlock.classList.add(Se());this.progressBlock.innerHTML='<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>'}}class je{constructor(t,e,s){this.functionMenu=null;this.formatsMenu=null;this.isMouseOverBlock=false;this.keepShowingButtons=false;this.tapedTwice=false;this.bar=t;this.column=e;this.element=s}get cssPrefix(){return"eqjs-cb"}render(){const t=Pt("div");t.data("id",this.column.id);if(this.element){this.element.parentNode.replaceChild(t.toDOM(),this.element)}this.element=t.toDOM();if(this.bar.isDraggable()){Gt.registerDraggableItem({element:this.element,scope:"entityAttrSort",beforeDragStart:()=>this.element.dispatchEvent(kt("mouseleave")),onDragStart:t=>{this.hideButtons();this.element.style.display="none";t.dropEffect=Qt.Allow},onDragEnd:t=>{this.element.removeAttribute("style")},data:{column:this.column}})}if(!this.column.isReadOnly()){this.createFunctionMenu();this.createFormatsMenu()}t.addClass(this.getClassesToAdd()).addClass(Se()).addChildElement(this.renderCaptionBlock()).addChildElement(this.renderSortingImage());if(!gt.isMobileMode()){t.addChildElement(this.renderButtonsBlock())}t.on("mouseenter",this.onMouseEnter.bind(this)).on("mouseleave",this.onMouseLeave.bind(this));if(this.bar.options.accentActiveColumn||gt.isMobileMode()){t.on("touchstart click",this.onMouseClick.bind(this))}return this.element}fireColumnChanged(){this.column.fireChangedEvent()}refresh(){this.render()}isEditable(){return this.column.enabled&&!this.column.isReadOnly()&&(this.bar.options.editMode===De.Full||this.bar.options.editMode===De.FixedList)}renderButtonsBlock(){const t=this.bar.options.editMode===De.Full;const e=this.bar.options.editMode===De.Full;return Pt("div",this.element).addClass(`${$e}-column-buttonsBlock`,`${this.cssPrefix}-buttonsBlock`).addChildElement(this.renderSortingButton()).addChildElement(e?this.renderColumnTypeButton():null).addChildElement(this.renderColumnFormatButton()).addChildElement(t?this.renderDeleteButton():null).toDOM()}renderCaptionBlock(){const t=this.column.caption;if(!this.isEditable()){return Pt("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-captionelement`).addClass(Se()).addChild("div",(e=>e.title(t).text(t).attr("tabIndex","0"))).toDOM()}const e=t=>{if(!this.tapedTwice){this.tapedTwice=true;setTimeout((()=>{this.tapedTwice=false}),300)}};let s=false;Pt(this.element).on("touchstart dblclick",(t=>{if(t instanceof TouchEvent&&!this.tapedTwice){e();return true}t.stopPropagation();s=this.element.querySelector("a")==document.activeElement;const i=this.element.querySelector(`.${this.cssPrefix}-captionelement input`);const n=this.element.querySelector(`.${this.cssPrefix}-captionelement a`);if(i){i.style.width=`${this.element.clientWidth}px`;n.style.display="none";i.style.removeProperty("display");i.focus();this.element.setAttribute(Gt.DRAG_DISABLED_ATTR,"")}return false}));return Pt("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-captionelement`).addClass(Se()).addChild("a",(e=>e.attr("href","javascript:void(0)").title(this.column.caption).text(t).on("keydown",(t=>{const e=t;const s=(e.ctrlKey||e.metaKey)&&(e.keyCode==13||e.keyCode==10);if(s&&this.isColumnActive()){const t=document.createEvent("MouseEvents");t.initEvent("dblclick",true,true);this.element.dispatchEvent(t);e.stopPropagation();return false}return true})))).addChild("input",(t=>t.hide().value(this.column.caption).on("blur keydown",(t=>{let e=false;let i=true;if(t instanceof KeyboardEvent){if(t.keyCode===13){e=true}else if(t.keyCode===27){e=true;i=false}}else if(t instanceof FocusEvent){e=true}if(e){const e=t.target;const n=e.parentElement.querySelector("a");if(n){n.style.removeProperty("display");e.style.display="none"}if(i&&this.column.caption!==e.value){this.column.caption=e.value;this.fireColumnChanged()}else{e.value=this.column.caption}this.element.removeAttribute(Gt.DRAG_DISABLED_ATTR);if(s){this.element.querySelector("a").focus()}}})))).toDOM()}renderSortingImage(){const t=`${$e}-column-sortbutton`;let e=t;switch(this.column.sorting){case Q.Ascending:e=`${t}-asc`;break;case Q.Descending:e=`${t}-desc`;break}if(this.column.sorting==Q.None){return null}else{return Pt("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-sortimage-placeholder`).addClass(Se()).addChild("div",(t=>t.addClass(`${this.cssPrefix}-img-sorting`,e).title(a.getText("ButtonSorting")))).toDOM()}}buttonSortingClickHandler(t,e){t.stopPropagation();this.keepShowingButtons=true;const s=this.getUIS()?this.bar.sortMenu||this.bar.moveMenu:this.bar.moveMenu;s.showMenu({anchor:e,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t=>{if(t=="None"){return Q.None}else if(t=="Ascending"){return Q.Ascending}else if(t=="Descending"){return Q.Descending}};if(t.id=="None"||t.id=="Ascending"||t.id=="Descending"){const e=this.bar.getQuery();this.column.sorting=s(t.id);this.column._sortIndex=e.getColumnSortIndex(this.column);this.fireColumnChanged()}else{this.bar.moveColumn(this.column,t.id)}},menuClosedCallback:()=>{this.keepShowingButtons=false;if(!this.isMouseOverBlock){this.leaveButtonBlock()}}});return false}renderSortingButton(){if(!this.isEditable()){return null}const t=Pt("div").addClass(`${$e}-column-button`,`${$e}-column-sortbutton`,`${$e}-column-sortbutton-none`).title(a.getText("ButtonSorting")).attr("tabIndex","0").on("touchstart click",(e=>this.buttonSortingClickHandler(e,t.toDOM()))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}}));return t.toDOM()}buttonDeleteClickHandler(t){t.stopPropagation();const e=this.bar.getQuery();e.removeColumn(this.column);e.fireColumnsChangedEvent(O.Delete,this.column);return false}renderDeleteButton(){if(this.column.isReadOnly()||this.bar.options.editMode!==De.Full){return null}return Pt("div").addClass(`${$e}-column-button`,`${$e}-column-button-delete`).title(a.getText("CmdDelete")).attr("tabIndex","0").on("touchstart click",(t=>this.buttonDeleteClickHandler(t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).toDOM()}getClassesToAdd(){let t="";t+=this.column.enabled?"":` ${this.cssPrefix}-disabled`;if(this.column.enabled){t+=this.column.isReadOnly()?` ${this.cssPrefix}-readonly`:""}return t}buttonTypeClickHandler(t){t.stopPropagation();this.keepShowingButtons=true;this.changeColumnTypeHandler(t);return false}buttonFormatClickHandler(t){t.stopPropagation();this.keepShowingButtons=true;this.changeFormatHandler(t);return false}formatButtonIsShown(){return this.bar.options.allowDisplayFormatChange!==false&&this.bar.getContext().getModel().getDisplayFormatsForType(this.column.getDataType()).length>0}changeFormatHandler(t){const e=this.bar.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());let s="{0:__default}";if(e.filter((t=>t.format==this.column.displayFormat)).length>0){s=this.column.displayFormat}this.formatsMenu.showMenu({anchor:t.target,selectedIds:s,itemSelectedCallback:(t,e)=>{if(t.id!=s){if(t.id=="{0:__default}"){this.column.displayFormat=""}else{this.column.displayFormat=t.id}this.column.fireChangedEvent()}return false},menuClosedCallback:()=>{this.keepShowingButtons=false;if(!this.isMouseOverBlock){this.element.dispatchEvent(kt("mouseleave"))}}})}renderColumnTypeButton(){if(!this.isEditable()||this.bar.options.allowAggrColumns===false||this.bar.options.editMode!==De.Full){return null}return Pt("div").addClass(`${$e}-column-button`,`${$e}-column-button-type`).title(a.getText("ButtonToAggr")).attr("tabIndex","0").on("touchstart click",(t=>this.buttonTypeClickHandler(t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).toDOM()}renderColumnFormatButton(){if(!this.isEditable()||!this.formatButtonIsShown()){return null}return Pt("div").addClass(`${$e}-column-button`,`${$e}-column-button-format`).title(a.getText("ButtonFormat")).attr("tabIndex","0").on("touchstart click",(t=>this.buttonFormatClickHandler(t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).toDOM()}getUIS(){return this.bar.getContext().getModel().checkAttrProperty(this.column.expr.value,"useInSorting")}onMouseClick(t){this.bar.toggleColumnPicked(this.column);this.adjustButtonsVisibility()}onMouseEnter(t){if(gt.isMobileMode())return;this.isMouseOverBlock=true;this.enterButtonBlock();t.stopPropagation();return false}onMouseLeave(t){if(gt.isMobileMode())return;this.isMouseOverBlock=false;this.leaveButtonBlock();t.stopPropagation();return false}isColumnActive(){return this.element.classList.contains("active")}hideButtons(){if(gt.isMobileMode()){if(this.onHideButtonsMobile){this.onHideButtonsMobile()}}else{Pt(this.element).data("show-buttons",null)}}showButtons(){if(gt.isMobileMode()){if(this.onShowButtonsMobile){this.onShowButtonsMobile()}}else{Pt(this.element).data("show-buttons","")}}adjustButtonsVisibility(){if(this.bar.options.alwaysShowButtons||(this.bar.options.accentActiveColumn||gt.isMobileMode())&&this.isColumnActive()){this.showButtons()}else{this.hideButtons()}}enterButtonBlock(){this.showButtons()}leaveButtonBlock(){if(this.bar.options.alwaysShowButtons!=true&&(!this.isColumnActive()||this.bar.options.accentActiveColumn!=true)){this.hideButtons()}}createFunctionMenu(){const t=[];const e=this.bar.getContext().getModel().getAggrFunctions();let s=true;let i=null;const n=this.column.getDataType();let r;for(const h of e){if(!h)continue;const e=h.getAppliedTypesOrDefault().indexOf(n)>=0;if(this.column.expr.func===h.id&&!e){s=false}if(e){r=this.bar.getContext().getModel().getAggrFunctionCaption(h.id);i={id:h.id,text:r};t.push(i)}}if(!s&&t.length>0){this.column.expr.func=t[0].id}const h=this.bar;if(h.areCustomExpressionsAllowed()){i={id:"CustomSqlDivider",text:"---"};t.push(i);r=a.getText("CustomExpression");i={id:"CUSTOMSQL",text:r};t.push(i)}let o=this.element.id;if(o){o+="-FunctionsMenu"}const l={items:t,id:o,searchBoxAlwaysShown:false,domWriteItemsId:true};this.functionMenu=new Me(l)}createFormatsMenu(){if(this.bar.options.allowDisplayFormatChange==false)return;let t=this.column.id;if(t){t+="-FormatsMenu"}const e=this.getFormatsMenuItems();const s={items:e,id:t,searchBoxAlwaysShown:false,showSelected:true,domWriteItemsId:true};this.formatsMenu=new Me(s)}getFormatsMenuItems(){const t=this.bar.getContext().getModel().getDisplayFormatsForType(this.column.getDataType());return[{id:"{0:__default}",text:"Default"}].concat(t.map((t=>({id:t.format,text:a.getText("DisplayFormats",t.name)||t.name}))))}}class _e extends je{getClassesToAdd(){return`${super.getClassesToAdd()} ${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`}baseExpressionItemSelectedCallback(t,e){const s=t.id;const i=this.bar.getContext();var n=i.getModel().getAttributeById(s);this.updateBaseAttr(n);this.column.caption=i.getDefaultColumnCaption(this.column);this.fireColumnChanged();return false}updateBaseAttr(t){this.column.expr.setValue(t.id,true);this.column.expr.baseAttrId=t.id;this.column.expr.dataType=t.dataType}getUIS(){const t=this.column.expr.args[0];if(t){const e=this.bar.getContext().getModel();return e.checkAttrProperty(t.value,"useInSorting")}else{return true}}changeTypeToCustomSql(){const t=this.column.getQuery();t.changeColumnType(this.column,L.CustomSql);this.fireColumnChanged()}changeTypeToAggr(t){const e=this.column.getQuery();e.changeColumnType(this.column,L.AggregateFunction,{funcId:t});this.fireColumnChanged()}changeColumnTypeHandler(t){if(this.bar.options.editMode!==De.Full)return;this.functionMenu.showMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>{if(t.id=="CUSTOMSQL"){this.changeTypeToCustomSql()}else{this.changeTypeToAggr(t.id)}return false},menuClosedCallback:()=>{this.keepShowingButtons=false;if(!this.isMouseOverBlock){this.element.dispatchEvent(kt("mouseleave"))}}})}}class Ge extends _e{getClassesToAdd(){return`${super.getClassesToAdd()} ${this.cssPrefix}-row ${this.cssPrefix}-row-column-aggr`}renderColumnTypeButton(){const t=super.renderColumnTypeButton();if(t){t.classList.add("aggregated");t.title=a.getText("ButtonToSimple")}return t}updateBaseAttr(t){this.column.expr.args[0].setValue(t.id,true);this.column.expr.baseAttrId=t.id}changeTypeToSimple(){const t=this.column.getQuery();t.changeColumnType(this.column,L.EntityAttribute);this.fireColumnChanged()}changeColumnTypeHandler(t){if(this.bar.options.editMode!==De.Full)return;this.changeTypeToSimple()}}class He extends je{getClassesToAdd(){return`${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`+super.getClassesToAdd()}renderColumnTypeButton(){const t=super.renderColumnTypeButton();if(t){t.classList.add("aggregated");t.title=a.getText("ButtonToSimple")}return t}changeTypeToSimple(){const t=this.column.getQuery();t.changeColumnType(this.column,L.EntityAttribute);this.fireColumnChanged()}getColumnValue(){return""}setColumnValue(t){}getUIS(){return true}changeColumnTypeHandler(t){if(this.bar.options.editMode!==De.Full)return;this.changeTypeToSimple()}}class We extends He{get columnEnabled(){return this.bar.areCustomExpressionsAllowed()?this.column.enabled:false}set columnEnabled(t){if(this.bar.areCustomExpressionsAllowed()){this.column.enabled=t}else{this.column.enabled=false}}getColumnValue(){return this.column.expr.sql}setColumnValue(t){this.column.expr.sql=t}getDefaultValue(){return this.column.expr.sql}}class Ue extends He{getColumnValue(){return this.column.expr.value}setColumnValue(t){this.column.expr.setValue(t)}getDefaultValue(){return this.column.expr.value}}class ze extends mt{get cssPrefix(){return"eqjs-cb"}constructor(t,e){super(t);this.options={isSubQuery:false,activeColumn:null,showAddRow:true,showHeader:true,showColumnTitles:true,allowAggrColumns:true,allowDuplicates:true,allowCustomExpressions:false,allowSorting:true,alwaysShowButtons:false,accentActiveColumn:true,allowDragDrop:true,menuOptions:{showSearchBoxAfter:30,searchBoxAutoFocus:true,activateOnMouseOver:true,adjustHeight:true,itemRenderedCallback:null},attrPlacement:0,sortEntities:false,columnRenderedCallback:null,customExpressionText:0,showAddAllForEntity:false,editMode:De.Full};this.landingSlot=Pt("div").addClass(`${$e}-highlight`).toDOM();this.landingIndex=-1;this.sortMenuList=[{id:"None",text:a.getText("CmdNotSorted")},{id:"Ascending",text:a.getText("CmdAscending")},{id:"Descending",text:a.getText("CmdDescending")},{id:"---",text:"---"}];this.moveMenuList=[{id:"MoveTop",text:a.getText("CmdMoveToFirst")},{id:"MoveUp",text:a.getText("CmdMoveToPrev")},{id:"MoveDown",text:a.getText("CmdMoveToNext")},{id:"MoveBottom",text:a.getText("CmdMoveToLast")}];Pt(this.slot).addClass(`${this.cssPrefix}-panel`).addClass(Se());this.group=it.Query;this.customQuery=e}getWidgetType(){return"columnsBar"}isDraggable(){return this.options.allowDragDrop&&this.options.editMode>De.ReadOnly}get editMode(){return this.options.editMode||De.Full}set editMode(t){if(this.options.editMode!==t){this.options.editMode=t;this.refresh()}}init(t,e){super.init(t,e);this.setOptions(e);if(e.attrElementFormat){this.context.options.attributeFormat=e.attrElementFormat}if(e.titleElementFormat){this.context.options.columnTitleFormat=e.titleElementFormat}this.detachQueryObserver();this.attachQueryObserver();Gt.removeDropContainer(this.slot);if(this.isDraggable()){Gt.registerDropContainer({element:this.slot,scopes:["entityAttrSort"],onDragEnter:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragOver:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragLeave:(t,e)=>{e.dropEffect=Qt.Forbid;this.hideLandingSlot()},onDrop:(t,e)=>{if(this.landingIndex>=0){const t=this.getQuery();const s=t.getColumns();const i=s.indexOf(e.data.column);this.moveColumnCore(i,this.landingIndex)}else{e.item.element.removeAttribute("style")}}})}}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((e=>{const s=e.data;if(!s||s.part!=P.Columns&&s.part!=P.Aggregation&&s.part!=P.All){return}const i=document.activeElement;const n=this.slot.contains(i)||i==document.body;switch(s.action){case O.Modify:{const t=s.changee;const e=t=>{const e=this.columnsBlock.querySelector(`div[data-id='${t.id}']`);if(e){const s=this.renderColumn(t,e);if(n){const t=s.querySelector("a");if(t){t.focus()}}}};if(Array.isArray(t)){t.forEach((t=>e(t)))}else{e(t)}break}case O.Add:{const e=s.changee;const i=e=>{const s=t.getColumns().indexOf(e);this.addColumnElement(e,s)};if(Array.isArray(e)){e.forEach((t=>i(t)))}else{i(e)}break}case O.Delete:{const t=s.changee;const e=t=>{const e=this.columnsBlock.querySelector(`div[data-id='${t.id}']`);if(e){const t=e.nextSibling;const s=e.previousSibling;this.columnsBlock.removeChild(e);if(n){const e=t||s||this.addRowButton;const i=e.querySelector("a");if(i){i.focus()}}}};if(Array.isArray(t)){t.forEach((t=>e(t)))}else{e(t)}break}default:this.refresh();break}}))}getQuery(){return this.customQuery?this.customQuery:this.getContext().getQuery()}destroyCore(){Gt.removeDropContainer(this.slot);this.detachQueryObserver();this.slot.innerHTML=""}detachQueryObserver(){if(this.queryEventCallbackId){const t=this.getQuery();t.removeChangedCallback(this.queryEventCallbackId)}}setOptions(t){this.options=r.assignDeep(this.options,t);if(typeof t.allowCustomExpressions!=="undefined"){this.context.options.allowCustomExpressions=t.allowCustomExpressions}}showLandingSlot(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`);const i=[];for(let t=0;t<s.length;t++){if(s[t].style.display!=="none"){i.push(s[t])}}if(i.length===0){this.landingIndex=0;return}const n=St(this.landingSlot);if(t>=n.x&&t<=n.x+this.landingSlot.offsetWidth&&e>=n.y&&e<=n.y+this.landingSlot.offsetHeight){return}let r=this.landingIndex;for(let s=0;s<i.length;s++){const h=i[s];const o=St(h);const l=h.offsetWidth;const a=h.offsetHeight;const u=.2*l;const c=2;if(t>=o.x+u&&t<=o.x+l-u&&e>=o.y+c&&e<=o.y+a-c){if(t>n.x)r=s+1;else r=s;break}}if(r!=this.landingIndex||this.landingSlot.parentElement){this.landingIndex=r;if(this.landingIndex<=0){this.columnsBlock.insertBefore(this.landingSlot,i[0])}if(this.landingIndex<i.length){this.columnsBlock.insertBefore(this.landingSlot,i[this.landingIndex])}else{this.columnsBlock.appendChild(this.landingSlot)}}}hideLandingSlot(){this.landingIndex=-1;if(this.landingSlot.parentElement){this.landingSlot.parentElement.removeChild(this.landingSlot)}}onProcessStartCore(){}onProcessEndCore(){}refreshCore(){this.clear();this.render()}clear(){this.slot.innerHTML=""}renderAddRowButton(){Pt(this.addRowButton).addClass(`${$e}-addrow`,`${this.cssPrefix}-addrow`,`${$e}-addrow-empty`).addClass(Se()).title(a.getText("CmdClickToAddColumn")).addChild("a",(t=>t.attr("href","javascript:void(0)").on("click",(t=>{t.preventDefault();this.showEntitiesMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>{if(t.id==="__AddAll__"&&t.extra&&Array.isArray(t.extra.ids)){t.extra.ids.forEach((t=>this.addNewColumn(t)))}else{const e=t.id;this.addNewColumn(e)}return false}})}))));if(gt.isMobileMode()){Pt(this.columnsBlock).addChildElement(this.addRowButton)}}render(){this.createEntitiesMenu();if(this.options.allowSorting){this.createSortMenu()}this.createMoveMenu();this.columnsBlock=Pt("div").addClass(`${this.cssPrefix}-columns`).addClass(Se()).toDOM();if(this.options.showAddRow&&this.options.editMode===De.Full){this.addRowButton=Pt("div").toDOM();if(gt.isMobileMode()){Pt(this.columnsBlock).addChildElement(this.addRowButton)}else{Pt(this.slot).addChildElement(this.addRowButton)}this.renderAddRowButton()}Pt(this.slot).addChildElement(this.columnsBlock).addChildElement(this.renderColumnButtonsBlockMobile());const t=this.getQuery();const e=t.getColumns();e.forEach(((t,e)=>{const s=this.renderColumn(t);this.columnsBlock.appendChild(s)}))}renderColumnButtonsBlockMobile(){this.columnButtonsBlockMobileArrow=Pt("i").toDOM();this.columnButtonsBlockMobile=Pt("div").addClass(`${this.cssPrefix}-column-buttonsBlock`).addClass(Se()).addChildElement(this.columnButtonsBlockMobileArrow).hide().toDOM();this.buttonsBlockSortingButton=Pt("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button`,`${this.cssPrefix}-column-sortbutton-none`).toDOM();Pt(this.buttonsBlockSortingButton).on("touchstart click",(t=>{t.stopPropagation();this.currentColumnRenderer.buttonSortingClickHandler.call(this.currentColumnRenderer,t,this.buttonsBlockSortingButton);this.toggleColumnPicked(null);this.hideColumnButtonsMobile();return false}));this.buttonsBlockTypeButton=Pt("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button`,`${this.cssPrefix}-column-button-type`).on("touchstart click",(t=>{t.stopPropagation();this.currentColumnRenderer.buttonTypeClickHandler.call(this.currentColumnRenderer,t);this.toggleColumnPicked(null);this.hideColumnButtonsMobile();return false})).toDOM();this.buttonsBlockFormatButton=Pt("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button`,`${this.cssPrefix}-column-button-format`).on("touchstart click",(t=>{t.stopPropagation();this.currentColumnRenderer.buttonFormatClickHandler.call(this.currentColumnRenderer,t);this.toggleColumnPicked(null);this.hideColumnButtonsMobile();return false})).toDOM();if(this.options.editMode==De.Full){this.buttonsBlockDeleteButton=Pt("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button`,`${this.cssPrefix}-column-button-delete`).on("touchstart click",(t=>{t.stopPropagation();this.currentColumnRenderer.buttonDeleteClickHandler.call(this.currentColumnRenderer,t);this.toggleColumnPicked(null);this.hideColumnButtonsMobile();return false})).toDOM()}Pt("div",this.columnButtonsBlockMobile).addClass(`${this.cssPrefix}-column-button-close-block`).on("touchstart click",(()=>{this.toggleColumnPicked(null);this.hideColumnButtonsMobile()}));return this.columnButtonsBlockMobile}showColumnButtonsMobile(t,e,s){this.currentActiveColumn=t;this.currentColumnRenderer=e;const i=s.getBoundingClientRect();const n=s.offsetTop;const r=s.offsetLeft;Pt(this.columnButtonsBlockMobileArrow).setStyle("left",(r+i.width/2).toString()+"px");if(i.top>100){Pt(this.columnButtonsBlockMobile).removeClass("show-below").setStyle("top",(n-i.height).toString()+"px")}else{Pt(this.columnButtonsBlockMobile).addClass("show-below").setStyle("top",(n+i.height).toString()+"px")}if(t.enabled&&!t.isReadOnly()&&this.options.editMode>De.ReadOnly){Pt(this.buttonsBlockSortingButton).show();Pt(this.buttonsBlockTypeButton).show();if(e.formatButtonIsShown()){Pt(this.buttonsBlockFormatButton).show()}else{Pt(this.buttonsBlockFormatButton).hide()}}else{Pt(this.buttonsBlockSortingButton).hide();Pt(this.buttonsBlockTypeButton).hide()}if(t.isReadOnly()||this.options.editMode==De.ReadOnly){Pt(this.columnButtonsBlockMobile).hide()}else{Pt(this.columnButtonsBlockMobile).show()}}hideColumnButtonsMobile(){Pt(this.columnButtonsBlockMobile).hide()}renderColumn(t,e){const s=this.getColumnRenderer(t,e);if(s){const e=s.render();s.onShowButtonsMobile=()=>{this.showColumnButtonsMobile(t,s,e)};s.onHideButtonsMobile=()=>{this.hideColumnButtonsMobile()};return e}return null}getColumnRenderer(t,e){switch(t.expr.tag){case L.Constant:return new Ue(this,t,e);case L.AggregateFunction:return new Ge(this,t,e);case L.CustomSql:return new We(this,t,e);default:return new _e(this,t,e)}}addNewColumn(t,e){this.getContext().getModel();const s=this.getQuery();if(Array.isArray(t)){let i=null;let n=[];for(let r=0;r<t.length;r++){i=s.addColumn({attributeId:t[r],index:e},true);if(i){n.push(i)}}return n}else{const i=s.addColumn({attributeId:t,index:e});return i}}toggleColumnPicked(t){let e;let s;if(t){e=this.columnsBlock.querySelector(`div[data-id=${t.id}]`);if(e){s=e.classList.contains("active")}}const i=this.columnsBlock.querySelectorAll(`.${this.cssPrefix}-row`);for(let t=0;t<i.length;t++){const e=i[t];Pt(e).removeClass("active").data("show-buttons",null)}if(e&&!s){Pt(e).addClass("active").data("show-buttons","")}}addColumnElement(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`);const i=this.renderColumn(t);if(s.length>0){if(e<s.length-1){this.columnsBlock.insertBefore(i,s[e])}else{this.columnsBlock.appendChild(i)}}else{this.columnsBlock.appendChild(i)}if(this.options.columnRenderedCallback){this.options.columnRenderedCallback(i)}}checkColumnsArray(t){let e=t.length;const s=[];for(let i=0;i<e;i++){if(this.checkColumn(t[i]))s.push(t[i])}return s}checkColumn(t){if(!this.options.allowDuplicates){const e=this.getQuery();const s=e.getColumns();const i=JSON.stringify(t.expr);for(let t=0;t<s.length;t++){const e=JSON.stringify(s[t].expr);if(e===i){return null}}}return t}getColumnsBlock(){return this.columnsBlock}showEntitiesMenu(t){this.entitiesMenu&&this.entitiesMenu.showMenu(t)}addAllColumnsToEntitiesList(t){const e=t.filter((t=>!t.isEntity)).map((t=>t.id));if(e.length>0){t.unshift({id:"__AddAll__",text:a.getText("AddAllForEntityText"),extra:{ids:e}})}t.forEach((t=>{if(t.items){this.addAllColumnsToEntitiesList(t.items)}}))}createEntitiesMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;if(e){e+="-EntitiesMenu"}const s=t.getEntitiesTree({addUIC:false,addUIR:true,addUIS:false,attrPlacement:this.options.attrPlacement,sortEntities:this.options.sortEntities});if(this.options.showAddAllForEntity){this.addAllColumnsToEntitiesList(s)}const i={items:s,adjustHeight:this.options.adjustEntitiesMenuHeight,id:e,domWriteItemsId:this.options.domWriteItemsId};r.assign(i,this.options.menuOptions);this.entitiesMenu=new Me(i)}createSortMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;if(e){e+="-SortMenu"}const s=this.sortMenuList.concat(this.moveMenuList);const i={items:s,id:e,domWriteItemsId:this.options.domWriteItemsId};r.assign(i,this.options.menuOptions);i.searchBoxAlwaysShown=false;this.sortMenu=new Me(i)}createMoveMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;if(e){e+="-MoveMenu"}const s=this.moveMenuList;const i={items:s,id:e,domWriteItemsId:this.options.domWriteItemsId};r.assign(i,this.options.menuOptions);this.moveMenu=new Me(i);i.searchBoxAlwaysShown=false}moveColumn(t,e){const s=this.getQuery();const i=s.getColumns();const n=i.indexOf(t);if(n>=0){switch(e){case"MoveTop":if(n==0){return}this.moveColumnCore(n,0);break;case"MoveUp":if(n==0){return}this.moveColumnCore(n,n-1);break;case"MoveDown":if(n==i.length-1){return}this.moveColumnCore(n,n+1);break;case"MoveBottom":if(n==i.length-1){return}this.moveColumnCore(n,i.length-1);break}}}moveColumnCore(t,e){const s=this.getQuery();if(!s)return;const i=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`);const n=i[t];if(e<=0){this.columnsBlock.insertBefore(n,this.columnsBlock[0])}else if(e<i.length){this.columnsBlock.insertBefore(n,i[e])}else{this.columnsBlock.appendChild(n)}s.moveColumn(t,e);s.fireColumnsChangedEvent(O.All)}areCustomExpressionsAllowed(){const t=this.getQuery();return t.isEx()&&this.getContext().options.allowCustomExpressions}}ze.globalCounter=0;class Ve{constructor(t,e,s){this.functionMenu=null;this.isMouseOverBlock=false;this.keepShowingButtons=false;this.bar=t;this.column=e;this.element=s}get cssPrefix(){return"eqjs-sb"}render(){const t=Pt("div");t.data("id",this.column.id);if(this.element){this.element.parentNode.replaceChild(t.toDOM(),this.element)}this.element=t.toDOM();if(this.bar.options.allowDragDrop){Gt.registerDraggableItem({element:this.element,scope:"entityAttrSortSB",beforeDragStart:()=>this.element.dispatchEvent(kt("mouseleave")),onDragStart:t=>{this.element.style.display="none";t.dropEffect=Qt.Allow},onDragEnd:t=>{this.element.removeAttribute("style")},data:{column:this.column}})}t.addClass(this.getClassesToAdd()).addClass(Se()).addChildElement(this.renderCaptionBlock());if(this.isEditable()){t.addChildElement(this.renderSortingButton())}return this.element}fireColumnChanged(){this.column.fireChangedEvent()}refresh(){this.render()}getAttribute(){const t=this.bar.getContext().getModel();return t.getAttributeById(this.column.expr.value)}isEditable(){return this.column.enabled&&!this.column.isReadOnly()}renderCaptionBlock(){function t(t){switch(t){case Q.Ascending:return" ";case Q.Descending:return" ";default:return""}}let e=this.column.caption;if(!this.isEditable()){e+=t(this.column.sorting)}return Pt("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-captionelement`).addClass(Se()).addChild("div",(t=>t.title(this.column.caption).text(e))).toDOM()}renderSortingButton(){const t=`${$e}-column-sortbutton`;let e=t;switch(this.column.sorting){case Q.None:e=`${t}-none`;break;case Q.Ascending:e=`${t}-asc`;break;case Q.Descending:e=`${t}-desc`;break}const s=Pt("div").addClass(`${this.cssPrefix}-colelement`,`${this.cssPrefix}-sortimage-placeholder`).addClass(Se()).addChild("div",(t=>t.addClass(`${this.cssPrefix}-img-sorting`,e).title(a.getText("ButtonSorting")))).on("touchstart click",(t=>this.buttonSortingClickHandler(t,s.toDOM())));return s.toDOM()}buttonSortingClickHandler(t,e){t.stopPropagation();this.keepShowingButtons=true;const s=this.bar.sortMenu;s.showMenu({anchor:e,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t=>{if(t=="None"){return Q.None}else if(t=="Ascending"){return Q.Ascending}else if(t=="Descending"){return Q.Descending}};if(t.id=="None"||t.id=="Ascending"||t.id=="Descending"){const e=this.bar.getContext().getQuery();if(this.column.isJustSorted()&&t.id=="None"){e.removeColumn(this.column);e.fireColumnsChangedEvent(O.Delete,this.column,true)}else{this.column.sorting=s(t.id);this.column._sortIndex=e.getColumnSortIndex(this.column);this.fireColumnChanged()}}else{this.bar.moveColumn(this.column,t.id)}},menuClosedCallback:()=>{this.keepShowingButtons=false}});return false}getClassesToAdd(){return`${this.cssPrefix}-row ${this.cssPrefix}-row-column-entattr`}getUIS(){return this.bar.getContext().getModel().checkAttrProperty(this.column.expr.value,"useInSorting")}}class Je extends mt{get cssPrefix(){return"eqjs-sb"}constructor(t){super(t);this.options={showAddRow:true,allowDragDrop:true,menuOptions:{showSearchBoxAfter:30,searchBoxAutoFocus:true,activateOnMouseOver:true,adjustHeight:true,itemRenderedCallback:null}};this.sortMenuList=[{id:"None",text:a.getText("CmdNotSorted")},{id:"Ascending",text:a.getText("CmdAscending")},{id:"Descending",text:a.getText("CmdDescending")},{id:"---",text:"---"},{id:"MoveTop",text:a.getText("CmdMoveToFirst")},{id:"MoveUp",text:a.getText("CmdMoveToPrev")},{id:"MoveDown",text:a.getText("CmdMoveToNext")},{id:"MoveBottom",text:a.getText("CmdMoveToLast")}];this.landingSlot=Pt("div").addClass(`${$e}-highlight`).toDOM();this.landingIndex=-1;Pt(this.slot).addClass(`${this.cssPrefix}-panel`).addClass(Se());this.group=it.Query}getWidgetType(){return"sortingBar"}init(t,e){super.init(t,e);this.setOptions(e);if(e.attrElementFormat){this.context.options.attributeFormat=e.attrElementFormat}if(e.titleElementFormat){this.context.options.columnTitleFormat=e.titleElementFormat}this.destroyCore();this.attachQueryObserver();Gt.removeDropContainer(this.slot);if(this.options.allowDragDrop){Gt.registerDropContainer({element:this.slot,scopes:["entityAttrSortSB"],onDragEnter:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragOver:(t,e)=>{this.showLandingSlot(e.pageX,e.pageY)},onDragLeave:(t,e)=>{e.dropEffect=Qt.Forbid;this.hideLandingSlot()},onDrop:(t,e)=>{if(this.landingIndex>=0){const t=this.getQuery();t.setColumnSortIndex(e.data.column,this.landingIndex);t.fireColumnsChangedEvent(O.All)}else{e.item.element.removeAttribute("style")}}})}}setOptions(t){r.assignDeep(this.options,t)}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{const e=t.data;if(!e||e.part!=P.SortingColumns&&e.part!=P.Columns&&e.part!=P.All){return}this.refresh()}))}detachQueryObserver(){if(this.queryEventCallbackId){const t=this.getQuery();t.removeChangedCallback(this.queryEventCallbackId)}}getQuery(){return this.getContext().getQuery()}getModel(){return this.getContext().getModel()}destroyCore(){this.detachQueryObserver();this.clear()}refreshCore(){this.clear();this.render()}renderAddRowButton(){Pt(this.addRowButton).addClass(`${$e}-addrow`,`${this.cssPrefix}-addrow`,`${$e}-addrow-empty`).addClass(Se()).title(a.getText("CmdClickToAddColumn")).addChild("a",(t=>t.attr("href","javascript:void(0)").on("click",(t=>{t.preventDefault();this.showEntitiesMenu({anchor:t.target,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t.id;this.addNewColumn(s);return false}})}))));if(gt.isMobileMode()){Pt(this.columnsBlock).addChildElement(this.addRowButton)}}showEntitiesMenu(t){this.entitiesMenu.showMenu(t)}createEntitiesMenu(){const t=this.getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;if(e){e+="-EntitiesMenu"}const s=t.getEntitiesTree({addUIC:false,addUIR:false,addUIS:true});const i={items:s,adjustHeight:this.options.adjustEntitiesMenuHeight,id:e,domWriteItemsId:this.options.domWriteItemsId};this.entitiesMenu=new Me(i)}createSortMenu(){const t=this.getModel();if(!t||t.isEmpty())return null;let e=this.slot.id;if(e){e+="-SortMenu"}const s=this.sortMenuList;const i={items:s,id:e};i.searchBoxAlwaysShown=false;this.sortMenu=new Me(i)}render(){this.createEntitiesMenu();this.createSortMenu();this.columnsBlock=Pt("div").addClass(`${this.cssPrefix}-columns`).addClass(Se()).toDOM();if(this.options.showAddRow){this.addRowButton=Pt("div").toDOM();if(gt.isMobileMode()){Pt(this.columnsBlock).addChildElement(this.addRowButton)}else{Pt(this.slot).addChildElement(this.addRowButton)}this.renderAddRowButton()}Pt(this.slot).addChildElement(this.columnsBlock);const t=this.getQuery();const e=t.getSortedColumns();e.forEach(((t,e)=>{const s=this.renderColumn(t);this.columnsBlock.appendChild(s)}))}addNewColumn(t){this.getModel();const e=this.getQuery();const s=e.addColumn({attributeId:t,justsorted:true,sorting:Q.Ascending},true);e.fireChangedEvent({part:P.SortingColumns,action:O.Add,changee:s,source:this});return s}renderColumn(t,e){const s=new Ve(this,t,e);if(s){const t=s.render();return t}return null}clear(){this.slot.innerHTML=""}moveColumn(t,e){const s=this.getQuery();const i=s.getSortedColumns();const n=s.getColumnSortIndex(t);if(n>=0){switch(e){case"MoveTop":s.setColumnSortIndex(t,0);s.fireChangedEvent({part:P.SortingColumns,action:O.Modify,source:this});break;case"MoveUp":s.setColumnSortIndex(t,n>0?n-1:0);s.fireChangedEvent({part:P.SortingColumns,action:O.Modify,source:this});break;case"MoveDown":s.setColumnSortIndex(t,n<i.length-1?n+1:i.length-1);s.fireChangedEvent({part:P.SortingColumns,action:O.Modify,source:this});break;case"MoveBottom":s.setColumnSortIndex(t,i.length-1);s.fireChangedEvent({part:P.SortingColumns,action:O.Modify,source:this});break}}}showLandingSlot(t,e){const s=this.columnsBlock.querySelectorAll(`[class*=${this.cssPrefix}-row]`);const i=[];for(let t=0;t<s.length;t++){if(s[t].style.display!=="none"){i.push(s[t])}}if(i.length===0){this.landingIndex=0;return}const n=St(this.landingSlot);if(t>=n.x&&t<=n.x+this.landingSlot.offsetWidth&&e>=n.y&&e<=n.y+this.landingSlot.offsetHeight){return}let r=this.landingIndex;for(let s=0;s<i.length;s++){const h=i[s];const o=St(h);const l=h.offsetWidth;const a=h.offsetHeight;const u=.2*l;const c=2;if(t>=o.x+u&&t<=o.x+l-u&&e>=o.y+c&&e<=o.y+a-c){if(t>n.x)r=s+1;else r=s;break}}if(r!=this.landingIndex||this.landingSlot.parentElement){this.landingIndex=r;if(this.landingIndex<=0){this.columnsBlock.insertBefore(this.landingSlot,i[0])}if(this.landingIndex<i.length){this.columnsBlock.insertBefore(this.landingSlot,i[this.landingIndex])}else{this.columnsBlock.appendChild(this.landingSlot)}}}hideLandingSlot(){this.landingIndex=-1;if(this.landingSlot.parentElement){this.landingSlot.parentElement.removeChild(this.landingSlot)}}}var Ye;(function(t){t[t["None"]=0]="None";t[t["Value"]=1]="Value";t[t["Operator"]=2]="Operator";t[t["Attribute"]=4]="Attribute";t[t["Addition"]=8]="Addition";t[t["Removal"]=16]="Removal";t[t["All"]=255]="All";t[t["NoAddition"]=-9]="NoAddition";t[t["NoRemoval"]=-17]="NoRemoval";t[t["FixedConditionList"]=3]="FixedConditionList"})(Ye||(Ye={}));class Ke{get cssPrefix(){return"eqjs-qp"}constructor(t,e,s){this.panel=t;this.text=e;this.element=s||Pt("div").toDOM()}refresh(){this.render()}render(){Pt(this.element).html("").addClass(this.getClassesToAdd()).addClass(Se()).addChild("span",(t=>t.text(this.text).title(this.text))).toDOM();return this.element}getClassesToAdd(){return`${this.cssPrefix}-condelement`}}var Xe;(function(t){t[t["AddCondition"]=0]="AddCondition";t[t["AddGroup"]=1]="AddGroup";t[t["Enable"]=2]="Enable";t[t["Delete"]=4]="Delete";t[t["Menu"]=5]="Menu";t[t["Parameterized"]=6]="Parameterized";t[t["InJoin"]=7]="InJoin"})(Xe||(Xe={}));class Ze{constructor(t,e,s){this.panel=t;this.condition=e;this.element=s||Pt("div").toDOM()}get cssPrefix(){return"eqjs-qp"}refresh(){this.render()}clear(){if(this.element){this.element.className="";this.element.removeAttribute("data-id");this.element.removeAttribute("style");Pt(this.element).html("")}}render(t){this.clear();this.coreRender(t);if(this.panel.options.onConditionRendered){this.panel.options.onConditionRendered(this.condition,this.element)}return this.element}isEditable(){return this.condition.enabled&&!this.condition.isReadOnly()&&!(this.condition.isGroup()&&this.panel.isFixed())}}class ts extends Ze{getClassesToAdd(){let t=`${this.cssPrefix}-row ${this.cssPrefix}-row-condition`;t+=this.condition.isInJoin()?` ${this.cssPrefix}-condition-injoin`:"";t+=this.condition.isParameterized()?` ${this.cssPrefix}-condition-parameterized`:"";if(!gt.isMobileMode()){const e=this.condition.getLevel();if(e>0)t+=` ${this.cssPrefix}-level-${e}`}t+=this.condition.enabled?"":` ${this.cssPrefix}-disabled`;if(this.condition.enabled){t+=this.condition.isReadOnly()?` ${this.cssPrefix}-readonly`:""}return t}coreRender(t){const e=this.panel.getContext().getModel();const s=e.getOperatorById(this.condition.getOperatorId());const i=T.parseOperatorFormat(s);let n=null;const r=i.length;const h=Pt("div");if(this.element&&this.element.parentNode){this.element.parentNode.replaceChild(h.toDOM(),this.element)}this.element=h.toDOM();h.addClass(this.getClassesToAdd()).addClass(Se()).data("id",this.condition.id).data("condrow","").addChildElement(this.renderCheckbox()).addChildElement(this.renderConjunction());let o=t;const l=s==e.nullOperator?Math.min(r,this.condition.expressions.length+1):r;for(let t=0;t<l;t++){n=i[t];if(n.type==="operator"){const t=this.panel.getOperatorRenderer(this.condition,n.text);if(t){h.addChildElement(t.render())}}else if(n.type==="expression"){const t=o&&n.index>0;const e=this.panel.getExpressionRenderer(this.condition.expressions[n.index]);if(e){const s=e.render(t);h.addChildElement(s);setTimeout((()=>{e.adjustWidth()}),100)}o=o&&!t}else if(n.type==="text"){h.addChildElement(new Ke(this.panel,n.text).render())}}if(this.panel.options.accentActiveCondition||gt.isMobileMode()){h.on("click",(t=>{t.stopPropagation();this.panel.toggleConditionPicked(this.condition);this.adjustButtonsVisibility();if(!gt.isMobileMode()){this.element.dispatchEvent(kt("mouseenter"))}return false}))}h.addChildElement(this.renderButtonsBlock());if(!gt.isMobileMode()){h.on("mouseenter",(t=>{this.isMouseOverBlock=true;this.enterButtonBlock();t.stopPropagation();return false})).on("mouseleave",(t=>{this.isMouseOverBlock=false;if(!this.keepShowingButtons&&Pt(this.buttonsBlock).isVisible()){this.leaveButtonBlock()}t.stopPropagation();return false}))}}setConditionParameterized(t){this.condition.setParameterized(t);this.condition.fireChangedEvent()}setConditionInJoin(t){this.condition.setInJoin(t);this.condition.fireChangedEvent()}getConditionMenu(){return this.panel.getConditionMenu()}renderConjunction(){const t=this.condition.getParent();if(!t)return null;const e=r.findItemIndexById(t.getConditions(),this.condition.id)==0;if(this.panel.options.showConjunctions&&!e){const t=T.linkTypeToStr(this.condition.getParent().linkType);const e=a.getText("Conj"+t);return Pt("span").text(e).title(e).addClass(`${this.cssPrefix}-condelement ${this.cssPrefix}-condition-conjuction`).toDOM()}return null}renderCheckbox(){if(this.panel.options.showCheckboxes&&!this.condition.isReadOnly()&&!this.panel.isFixed()){return Pt("div").title(a.getText("CmdToggleEnable")).attr("tabIndex","0").addClass(`${this.cssPrefix}-condelement ${this.cssPrefix}-condition-checkbox`).addClass(`${this.condition.enabled?"enabled":""}`).on("click",(()=>{this.condition.enabled=!this.condition.enabled;this.condition.fireChangedEvent();return false})).on("keypress",(t=>{if([13,32].includes(t.keyCode)){t.target.click()}})).toDOM()}else{return null}}isConditionActive(){return this.element.classList.contains("active")}hideButtons(){Pt(this.element).data("show-buttons",null)}showButtons(){Pt(this.element).data("show-buttons","")}adjustButtonsVisibility(){if(this.panel.options.alwaysShowButtonsInConditions||this.panel.options.accentActiveCondition&&this.isConditionActive()){this.showButtons()}}enterButtonBlock(){this.showButtons()}leaveButtonBlock(){if(!this.panel.options.alwaysShowButtonsInConditions&&(!this.isConditionActive()||!this.panel.options.accentActiveCondition)){this.hideButtons()}}conditionMenuHandler(t,e){switch(t){case Xe.AddCondition:if(!this.condition.isGroup())return;const t=this.panel.getEntitiesMenu();if(t){t.showMenu({anchor:e.target,itemSelectedCallback:t=>{const e=this.panel.getQuery();const s={parent:this.condition,attributeId:t.id};const i=e.addSimpleCondition(s);if(i){e.fireConditionsChangedEvent(O.Add,i)}return false}})}break;case Xe.AddGroup:if(!this.condition.isGroup())return;const s=this.panel.getQuery();const i={parent:this.condition};const n=this.panel.getQuery().addConditionGroup(i);if(n){s.fireConditionsChangedEvent(O.Add,n)}break;case Xe.Enable:this.condition.enabled=!this.condition.enabled;this.condition.fireChangedEvent();break;case Xe.Delete:const r=this.condition.getParent();if(!r)return;const h=r.getConditions();const o=h.indexOf(this.condition);if(o>=0){h.splice(o,1);this.condition.getQuery().fireConditionsChangedEvent(O.Delete,this.condition)}break;case Xe.Menu:const l=this.getConditionMenu();this.keepShowingButtons=true;l.showMenu({anchor:e.target,selectedIds:this.getConditionMenuSelectedItems(),itemSelectedCallback:t=>{let s;switch(t.id){case"enable":s=Xe.Enable;break;case"delete":s=Xe.Delete;break;case"param":s=Xe.Parameterized;break;case"inJoin":s=Xe.InJoin;break;case"addCondition":s=Xe.AddCondition;break;case"addGroup":s=Xe.AddGroup;break}this.conditionMenuHandler(s,e)},itemFilterCallback:t=>{let e=this.condition.enabled||t.id==="enable"||t.id==="delete";if(t.id==="enable"){const t=this.condition.getParent();e=e&&t&&t.enabled}else if(t.id==="delete"){e=e&&(this.panel.options.editableParts&Ye.Removal)===Ye.Removal}else if(t.id==="addGroup"||t.id==="addCondition"){e=e&&(this.panel.options.editableParts&Ye.Addition)===Ye.Addition}return e},menuClosedCallback:()=>{this.keepShowingButtons=false;if(!this.isMouseOverBlock)this.leaveButtonBlock()}});break;case Xe.Parameterized:this.condition.setParameterized(!this.condition.isParameterized());this.condition.fireChangedEvent();break;case Xe.InJoin:this.condition.setInJoin(!this.condition.isInJoin());this.condition.fireChangedEvent();break}e.stopPropagation();return false}getConditionMenuSelectedItems(){let t=[];if(this.condition.enabled){t.push("enable")}if(this.condition.isParameterized()){t.push("param")}if(this.condition.isInJoin()){t.push("inJoin")}return t}renderButtonsBlock(){const t=t=>{Pt(t.target).addClass(`${this.cssPrefix}-condition-button-active`)};const e=t=>{Pt(t.target).removeClass(`${this.cssPrefix}-condition-button-active`)};const s=Pt("div").addClass(`${this.cssPrefix}-condition-buttonsBlock`).addClass(Se());this.buttonsBlock=s.toDOM();if(this.condition.isReadOnly()){return this.buttonsBlock}const i=this.getButtonsToShow();if(i.indexOf("addCondition")>=0&&this.condition.enabled&&(this.panel.options.editableParts&Ye.Addition)==Ye.Addition){s.addChild("div",(s=>{s.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(s=>{s.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-addCondition`).attr("tabIndex","0").data("button","").title(a.getText("CmdAddCondition")).on("click",(t=>this.conditionMenuHandler(Xe.AddCondition,t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).on("mouseenter",t).on("mouseleave",e)}))}))}const n=i.indexOf("addGroup")>=0||i.indexOf("addPredicate")>=0;if(n&&this.condition.enabled&&(this.panel.options.editableParts&Ye.Addition)==Ye.Addition){s.addChild("div",(s=>{s.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(s=>{s.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-addPredicate`).attr("tabIndex","0").data("button","").title(a.getText("CmdAddCondGroup")).on("click",(t=>this.conditionMenuHandler(Xe.AddGroup,t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).on("mouseenter",t).on("mouseleave",e)}))}))}if(this.getButtonsToShow().indexOf("enable")>=0&&this.condition.getParent()&&this.condition.getParent().enabled&&!this.panel.options.showCheckboxes&&!this.panel.isFixed()){s.addChild("div",(s=>{s.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(s=>{s.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-enable`).attr("tabIndex","0").data("button","").title(a.getText("CmdToggleEnable")).addClass(this.condition.enabled?"enabled":"").on("click",(t=>this.conditionMenuHandler(Xe.Enable,t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).on("mouseenter",t).on("mouseleave",e)}))}))}if(this.getButtonsToShow().indexOf("delete")>=0&&this.condition.getParent()&&(this.panel.options.editableParts&Ye.Removal)==Ye.Removal){s.addChild("div",(s=>{s.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(s=>{s.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-delete`).attr("tabIndex","0").data("button","").title(a.getText("CmdDelete")).on("click",(t=>this.conditionMenuHandler(Xe.Delete,t))).on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).on("mouseenter",t).on("mouseleave",e)}))}))}if(this.getButtonsToShow().indexOf("menu")>=0&&!this.panel.isFixed()){s.addChild("div",(s=>{s.addClass(`${this.cssPrefix}-button-placeholder`).data("btnplaceholder","").addChild("div",(s=>{s.addClass(`${this.cssPrefix}-condition-button ${this.cssPrefix}-condition-button-menu`).attr("tabIndex","0").data("button","").title(a.getText("ButtonMenu")).on("click",(t=>this.conditionMenuHandler(Xe.Menu,t)));if(!gt.isMobileMode()){s.on("keypress",(t=>{if(t.keyCode==13){t.target.click()}})).on("mouseenter",t).on("mouseleave",e)}}))}))}this.adjustButtonsVisibility();return this.buttonsBlock}getButtonsToShow(){return this.panel.options.buttons&&this.panel.options.buttons.condition&&Array.isArray(this.panel.options.buttons.condition)?this.panel.options.buttons.condition:["enable","delete"]}}class es extends Ft{constructor(t){super("a",t);this.attr("href","javascript:void(0)");this.on("click",(t=>{t.preventDefault();this.appear();return false}))}onGetMenu(t){this._onGetMenu=t;return this}onItemSelected(t){this._onItemSelected=t;return this}appear(){const t=this._onGetMenu?this._onGetMenu():null;if(t){t.showMenu({anchor:this.element,itemSelectedCallback:t=>{if(this._onItemSelected){this._onItemSelected(t.id)}return false}})}}}function ss(t){return new es(t)}class is extends Ze{constructor(t,e,s){super(t,e,s);this.isRoot=!e.getParent()}getClassesToAdd(){let t=`${this.cssPrefix}-group`;if(this.isRoot){t+=` ${this.cssPrefix}-group-root`}return t}coreRender(t){Pt(this.element).addClass(this.getClassesToAdd()).addClass(Se()).addChildElement(this.renderGroupRow()).addChildElement(this.renderConditions(t)).data("id",this.condition.id).data("group","")}renderGroupRow(){if(this.isRoot&&!this.panel.options.showRootRow){return null}else{return new ns(this.panel,this.condition).render()}}renderConditions(t){const e=Pt("div");e.addClass(`${this.cssPrefix}-conditions`).addClass(`${Se()}`).data("conditions","");if(this.isRoot){e.addClass(`${this.cssPrefix}-conditions-root`)}this.condition.getConditions().forEach(((s,i,n)=>{const r=this.panel.getConditionRenderer(s);if(r){e.addChildElement(r.render(t&&i==n.length-1))}}));return e.toDOM()}}class ns extends ts{constructor(t,e,s){super(t,e,s);this.isRoot=!this.condition.getParent()}getButtonsToShow(){return this.panel.options.buttons&&this.panel.options.buttons.group&&Array.isArray(this.panel.options.buttons.group)?this.panel.options.buttons.group:["addCondition","addGroup","enable","delete"]}getClassesToAdd(){let t;if(this.isRoot){t=`${this.cssPrefix}-row ${this.cssPrefix}-row-group ${this.cssPrefix}-row-group-root`}else{t=`${this.cssPrefix}-row ${this.cssPrefix}-row-group`;const e=this.condition.getLevel();if(e>0)t+=` ${this.cssPrefix}-level-${e}`;t+=this.condition.enabled?"":` ${this.cssPrefix}-disabled`;if(this.condition.enabled){t+=this.condition.isReadOnly()?` ${this.cssPrefix}-readonly`:""}}return t}coreRender(t){const e=Pt(this.element).addClass(this.getClassesToAdd()).addClass(Se()).data("group-row","").addChildElement(this.renderCheckbox()).addChildElement(this.renderConjunction());const s=this.condition.getLevel();if(s>0)e.addClass(`${this.cssPrefix}-level-${s}`);this.buildGroupElements(e,this.getGroupTitle());if(this.panel.options.accentActiveCondition){e.on("click",(t=>{this.panel.toggleConditionPicked(this.condition);this.adjustButtonsVisibility();if(!gt.isMobileMode()){e.toDOM().dispatchEvent(kt("mouseenter"))}}))}e.addChildElement(this.renderButtonsBlock());if(!gt.isMobileMode()){e.on("mouseenter",(t=>{this.isMouseOverBlock=true;this.enterButtonBlock();t.stopPropagation();return false})).on("mouseleave",(t=>{this.isMouseOverBlock=false;if(!this.keepShowingButtons&&Pt(this.buttonsBlock).isVisible()){this.leaveButtonBlock()}t.stopPropagation();return false}))}}getGroupTitle(){let t;if(this.isRoot&&!gt.isMobileMode()){t=a.getText("RootConditionGroupTitle");if(!t){t=a.getText("RootPredicateTitle")}}else{t=a.getText("ConditionGroupTitle");if(!t){t=a.getText("PredicateTitle")}}return t}buildGroupElements(t,e){const s=e.indexOf("{lt}");if(s<0){t.addText(a.getText("ErrIncorrectGroupTitleFormat"));t.addClass(`${this.cssPrefix}-error`)}else{if(s>0){t.addChild("span",(t=>{t.addClass(`${this.cssPrefix}-grelement`).addText(e.substring(0,s))}))}const i=T.linkTypeToStr(this.condition.linkType);let n=r.findItemById(dt.predicateLinkTypeList,i);if(!n){n=dt.predicateLinkTypeList[0]}if(this.isEditable()){ss(t.toDOM()).onGetMenu((()=>this.getLinkTypeMenu())).onItemSelected((t=>{this.condition.linkType=T.strToLinkType(t);this.condition.fireChangedEvent()})).addText(a.getText(n.key)).title(a.getText(n.key)).addClass(`${this.cssPrefix}-grelement`)}else{t.addChild("span",(t=>{t.text(a.getText(n.key)).title(a.getText(n.key)).addClass(`${this.cssPrefix}-grelement`)}))}t.addChild("span",(t=>{t.addClass(`${this.cssPrefix}-grelement`).addText(e.substring(s+4))}))}}getConditionMenu(){return this.panel.getConditionGroupMenu(this.condition.getParent()==null)}getLinkTypeMenu(){return this.panel.getLinkTypeMenu()}renderConjunction(){return this.isRoot?null:super.renderConjunction()}renderCheckbox(){return this.isRoot?null:super.renderCheckbox()}leaveButtonBlock(){if(!this.panel.options.alwaysShowButtonsInGroups&&(!this.isConditionActive()||!this.panel.options.accentActiveCondition)){this.hideButtons()}}adjustButtonsVisibility(){if(this.panel.options.alwaysShowButtonsInGroups||this.panel.options.accentActiveCondition&&this.isConditionActive()){this.showButtons()}}}class rs{constructor(t){this.element=t||Pt("div").toDOM()}refresh(){this.render()}render(t=false){this.labelElement=this.renderLabelElement();Pt(this.element).html("").addClass(this.getClassesToAdd()).addClass(Se()).addChildElement(this.labelElement);if(this.isEditable()){this.renderEditor();if(t){setTimeout((()=>this.showEditor()),50)}}return this.element}isEditable(){return true}renderLabelElement(){const t=this.getLabelText();if(this.isEditable()){return Pt("a").attr("href","javascript:void(0)").title(t).text(t).on("click",(t=>{t.preventDefault();this.showEditor();return false})).toDOM()}else{return Pt("span").title(t).text(t).toDOM()}}getClassesToAdd(){return""}getLabelText(){return this.getEmptyText()}getEmptyText(){return"<empty>"}}class hs extends rs{get cssPrefix(){return"eqjs-qp"}constructor(t,e,s,i){super(i);this.panel=t;this.expression=e;this.valueEditor=s}render(t=false){super.render(t);if(this.panel.options.onExpressionRendered){this.panel.options.onExpressionRendered(this.expression,this.element)}return this.element}getContext(){return this.panel.getContext()}isReadOnly(){const t=this.expression.getParent();return!t.enabled||t.isReadOnly()}isEditable(){return!this.isReadOnly()}getClassesToAdd(){return`${this.cssPrefix}-condelement ${this.cssPrefix}-valueelement`}getLabelText(){let t=!this.expression.isEmpty()?this.expression.value:this.getEmptyText();return t}getEmptyText(){return this.panel.options.emptyTextValue||a.getText("MsgEmptyScalarValue")}setValue(t,e){this.expression.setValue(t);if(!e){this.expression.getParent().fireChangedEvent(_.Value)}}getValue(){return this.expression.value}validateInput(t){return{success:true,value:t}}showValidationError(t,e){this.getContext().throwError({action:"ui.validation",text:t})}isEmptyValue(){let t=this.getValue();return typeof t==="undefined"||t===null||!t}adjustWidth(){}}class os extends hs{renderEditor(){this.inputBuilder=Pt("input").hide().addClass(`${this.cssPrefix}-ve-editbox`).type("text").on("blur",(t=>{if(this.inputBuilder.isVisible()&&!this.dontProcessBlur){const e=this.validateInput(this.inputElement.value);if(e.success){this.setValue(this.inputElement.value);this.closeEditor()}else{this.dontProcessBlur=true;this.inputElement.focus();setTimeout((()=>{this.dontProcessBlur=false}),200);this.showValidationError(e.message,t.target)}t.stopPropagation();return false}})).on("keydown",(t=>{if(t.keyCode===27){this.closeEditor();t.stopPropagation();return false}else if(t.keyCode===13){if(this.inputBuilder.isVisible()){this.dontProcessBlur=true;const e=this.validateInput(this.inputElement.value);if(e.success){this.setValue(this.inputElement.value);this.closeEditor();this.dontProcessBlur=false}else{this.inputElement.focus();this.showValidationError(e.message,t.target);setTimeout((()=>{this.dontProcessBlur=false}),200)}t.stopPropagation();return false}}}));this.inputElement=this.inputBuilder.toDOM();Pt(this.element).addChildElement(this.inputElement)}showEditor(){const t=200;if(!gt.isMobileMode()){let e=this.element.offsetLeft;let s=this.element.offsetWidth>t?this.element.offsetWidth:t;let i=this.element.parentElement.clientWidth-e-55;this.inputBuilder.removeStyle("left").removeStyle("right");if(i<t){this.inputBuilder.setStyle("right","55px").setStyle("width",`${t}px`)}else if(i<s){this.inputBuilder.setStyle("left",`${e}px`).setStyle("width",`${i}px`)}else{this.inputBuilder.setStyle("left",`${e}px`).setStyle("width",`${s}px`)}}Pt(this.labelElement).hide();this.inputBuilder.value(this.getValue()).show();this.inputElement.focus()}closeEditor(){this.inputBuilder.hide();Pt(this.labelElement).show();this.labelElement.focus()}validateInput(t){this.inputBuilder.removeClass("eqjs-invalid");const e={success:true,value:t};if(this.expression.kind==D.List){this.validateListInput(t,e)}else{this.validateScalarInput(t,e)}return e}validateListInput(t,e){let s=t.split(/\s*,\s*/);for(let t of s){this.validateScalarInput(t,e);if(!e.success){return}}}validateScalarInput(t,e){if(!t)return;if(r.isNumericType(this.expression.dataType)){let s=+t;if(isNaN(s)){e.success=false;e.message='"'+t+'" '+a.getText("ErrNotNumber")}if(r.isIntType(this.expression.dataType)&&s!=parseInt(t,10)){e.success=false;e.message='"'+t+'" '+a.getText("ErrIncorrectInteger")}}}showValidationError(t,e){super.showValidationError(t,e);this.inputBuilder.addClass("eqjs-invalid")}isEditable(){return super.isEditable()&&(this.panel.options.editableParts&Ye.Value)===Ye.Value}}class ls extends hs{constructor(){super(...arguments);this.menuItemsList=[];this.showWhenReady=false}isEditable(){return!this.isReadOnly()&&(this.panel.options.editableParts&Ye.Value)===Ye.Value}setValue(t,e=false){const s=this.adjustNewValue(t);if(t!==this.expression.value){const i=this.getValueText(t);this.expression.setContent(s,i);if(!e){this.expression.getParent().fireChangedEvent(_.Value)}}return true}getValueText(t){let e="";if(Array.isArray(t)){for(let s of this.menuItemsList){if(t.indexOf(s.id)>=0){e+=s.text+","}}}else{for(let s of this.menuItemsList){if(s.id===t){e+=s.text+","}}}if(e){e=e.substring(0,e.length-1)}return e}getEmptyText(){return this.panel.options.emptyTextList||a.getText("MsgEmptyListValue")}getListName(){return this.valueEditor.name}renderEditor(){this.fillMenuItemsList((()=>{this.renderMenuBlock()}))}getLabelText(){if(!this.expression.isEmpty()){return this.expression.getText()}else{return this.getEmptyText()}}showLoader(){}hideLoader(){}showEditor(){if(this.menu){this.menu.showMenu({anchor:this.labelElement,selectedIds:this.getValuesAsArray(),itemSelectedCallback:(t,e)=>{if(!this.menu.options.multiselect){this.setValue(t.id)}else if(e){let t=[];let s=e.length;for(let i=0;i<s;i++)t.push(e[i].id);this.setValue(t)}return false}})}else{this.showWhenReady=true;this.showLoader()}}closeEditor(){this.menu.hideMenu()}renderMenuBlock(){let t=false;if(this.expression){t=this.expression.kind===D.List}const e=this.panel;const s={items:this.menuItemsList,multiselect:t,container:e?e.options.menuContainer:null,showSelected:true,showItemIds:e?e.options.showIdsForListItems:false};if(e){r.assignDeep(s,e.options.menuOptions)}let i=this.element.id;if(i){s.id=i+"-EditorMenu"}if(e){s.domWriteItemsId=e.options.domWriteItemsId}s.buttons={submit:a.getText("ButtonApply"),cancel:a.getText("ButtonCancel")};this.menu=new Me(s)}getValuesAsArray(){if(this.expression.kind!==D.List){return[this.expression.value]}else{if(this.expression.value){const t=this.expression.value.match(/"[^"\\]*(?:\\.[^"\\]*)*"|[^,]+/g);return t?t.map((t=>{if(t.charAt(0)=='"'&&t.charAt(t.length-1)=='"'){t=t.substring(1,t.length-1);return t.replace(/\"/g,'"')}else{return t}})):[]}else return[]}}adjustNewValue(t){if(Array.isArray(t)){return t.map((t=>{if(t.indexOf(",")>=0){t=t.replace(/"/g,'"');return'"'+t+'"'}else{return t}})).join(",")}else{return t}}fillMenuItemsList(t){this.menuItemsList=this.valueEditor.values;if(t){t()}}takeDefaultValue(){if(!this.menuItemsList)return;let t=this.menuItemsList.length;let e=this.valueEditor.defValue;for(let s=0;s<t;s++){let t=this.menuItemsList[s];if(t.isDefault||e==t.id){this.setValue(t.id,true);break}}}}class as extends ls{constructor(){super(...arguments);this.isLoading=false;this.onClickTemp=null}renderEditor(){if(this.isLoading)return;this.isLoading=true;this.fillMenuItemsList((()=>{this.isLoading=false;if(this.isEmptyValue()){this.takeDefaultValue()}if(!this.expression.isEmpty()&&this.expression._isDefaultValue){const t=this.getValueText(this.expression.value);this.expression.setContent(this.expression.value,t);this.expression.getParent().fireChangedEvent()}this.renderMenuBlock();if(this.showWhenReady){this.showWhenReady=false;this.hideLoader();this.showEditor()}}))}showLoader(){this.labelElement.style.display="none";if(!this.loaderElement){this.loaderElement=Pt("div",this.element).addClass(`${this.cssPrefix}-ve-loader`).toDOM()}this.loaderElement.style.display="block"}hideLoader(){this.loaderElement.style.display="none";this.labelElement.removeAttribute("style")}fillMenuItemsList(t){const e=this.getListName();const s=this.panel.getContext().getListRequestHandler();if(dt.constLists[e]){this.menuItemsList=dt.constLists[e];if(t){t()}}else if(s){s({listName:e,editorId:this.valueEditor.id,editorParams:this.valueEditor.extraParams,value:this.getValue()},(e=>{this.menuItemsList=e;if(t){t()}}))}}}class us extends as{fillMenuItemsList(t){const e=this.panel.getContext();const s=e.getListRequestHandler();if(s){let e={listName:"SQL",editorId:this.valueEditor.id,editorParams:this.valueEditor.extraParams,value:this.getValue()};s(e,(e=>{this.menuItemsList=e;if(t){t()}}))}}}class cs extends ls{constructor(t,e,s,i){super(t,e,null,i);this.menu=s}renderEditor(){}getLabelText(){const t=this.panel.getContext().getModel();const e=this.expression.value;const s=e?t.getAttributeByIdSafe(e):null;const i=this.panel.options.attrElementFormat;return s?t.getAttributeText(s,i):this.getEmptyText()}setValue(t,e=false){e=e&&t!==this.expression.value;const s=super.setValue(t,true);if(!e){this.expression.getParent().fireChangedEvent(_.EntityAttr|_.Operator)}return s}isEditable(){return!this.isReadOnly()&&(this.panel.options.editableParts&Ye.Attribute)===Ye.Attribute}getEmptyText(){return this.panel.options.emptyTextAttribute||a.getText("MsgEmptyAttrValue")}getClassesToAdd(){return`${this.cssPrefix}-condelement ${this.cssPrefix}-attrelement`}adjustWidth(){if(gt.isMobileMode()){return}const t=this.element.clientWidth;const e=this.element.parentElement.clientWidth;if(t>e/2){Pt(this.element).addClass(`${this.cssPrefix}-attrelement-wide`)}}}class fs extends rs{constructor(t){super(t)}showEditor(){const t=this.getMenu();if(t){t.showMenu({anchor:this.labelElement,itemSelectedCallback:t=>{this.itemSelected(t.id);return false}})}}closeEditor(){const t=this.getMenu();if(t)t.hideMenu()}}class ds extends fs{constructor(t,e,s){super(s);this.panel=t;this.menu=e}get cssPrefix(){return"eqjs-qp"}getLabelText(){return a.getText("CmdClickToAddCondition")}getClassesToAdd(){return`${$e}-addrow ${this.cssPrefix}-addrow`}isEditable(){return super.isEditable()&&(this.panel.options.editableParts&Ye.Addition)===Ye.Addition}renderLabelElement(){const t=this.getLabelText();if(this.isEditable()){this.labelElement=Pt("a").attr("href","javascript:void(0)").title(t).text(t).on("click",(t=>{t.preventDefault();this.showEditor();return false})).toDOM()}else{this.labelElement=Pt("div").toDOM()}return this.labelElement}renderEditor(){}itemSelected(t){const e=this.panel.getQuery();const s={parent:e.getRootCondition(),attributeId:t};const i=e.addSimpleCondition(s);if(i){e.fireConditionsChangedEvent(O.Add,i)}}getMenu(){return this.menu}}class ms extends fs{get cssPrefix(){return"eqjs-qp"}constructor(t,e,s,i){super(i);this.panel=t;this.condition=e;this.displayedText=s}renderEditor(){const t=this.panel.getContext().getModel();const e=this.panel.getQuery();const s=[];const i=t=>t.defaultOperand.kind==D.Query;const n=this.condition&&this.condition.expressions&&this.condition.expressions[0]?this.condition.expressions[0].value:null;const h=n?t.getAttributeById(this.condition.expressions[0].value):null;if(h&&h.operators){h.operators.forEach((n=>{const r=t.getOperatorById(n);const h=i(r);if(!e.isEx()&&h){return}if(r&&!(this.panel.options.isSubQuery&&h)){s.push({id:n,text:a.getText("Operators",n,"caption")||r.caption})}}))}const o={items:s,adjustHeight:this.panel.options.adjustEntitiesMenuHeight,id:r.generateId("opmn"),domWriteItemsId:this.panel.options.domWriteItemsId};r.assign(o,this.panel.options.menuOptions);this.menu=new Me(o)}getLabelText(){return this.displayedText}getEmptyText(){return this.panel.options.emptyTextOperator||a.getText("MsgEmptyOperator")}getClassesToAdd(){return`${this.cssPrefix}-condelement ${this.cssPrefix}-operelement`}isEditable(){return this.condition.enabled&&!this.condition.isReadOnly()&&(this.panel.options.editableParts&Ye.Operator)===Ye.Operator}itemSelected(t){this.condition.setOperatorId(t);this.condition.fireChangedEvent(_.Operator)}getMenu(){return this.menu}}class ps extends hs{constructor(){super(...arguments);this.dtp=null;this.internalDateFormat="yyyy-MM-dd";this.internalTimeFormat="HH:mm"}renderEditor(){}showEditor(){if(this.dtp)return;const e={yearRange:this.panel.options.yearRange,showCalendar:this.expression.dataType!==t.Time,showTimePicker:this.expression.dataType!==t.Date,oneClickDateSelection:this.panel.options.oneClickDateSelection,showDateTimeInput:this.panel.options.showDateTimeInput,onApply:t=>{const e=this.convertToInternalFormat(t);this.setValue(e);this.dtp=null;setTimeout((()=>this.labelElement.focus()),100)},onCancel:()=>{this.labelElement.innerText=this.getLabelText();this.dtp=null;setTimeout((()=>this.labelElement.focus()),100)},onDateTimeChanged:t=>{const e=a.dateTimeToStrEx(t,this.expression.dataType);this.labelElement.innerText=e}};this.dtp=this.panel.options.dateTimePickerResolver?this.panel.options.dateTimePickerResolver(e):new fe(e);const s=this.expression.getModel();const i=this.expression.value;let n=new Date;if(this.expression.dataType!=t.Time&&s.isDateMacro(i)){n=s.getDateMacroValue(i)}else if(this.expression.dataType==t.Time&&s.isTimeMacro(i)){n=s.getTimeMacroValue(i)}else{n=this.convertFromInternalFormat(i,new Date)}this.dtp.setDateTime(n);this.dtp.show(this.element)}closeEditor(){this.dtp.cancel();this.dtp=null}getLabelText(){if(!this.expression.value)return this.getEmptyText();const t="${{Today}}";const e=this.expression.value;const s=this.expression.getModel();if(!s){throw new Error("DataModel is not defined for "+this.expression.value)}if(s.isDateMacro(e)||s.isTimeMacro(e)){let s=e.substring(3,e.length-2);let i=a.getText(s);return i?i:t}const i=a.dateTimeToStrEx(this.convertFromInternalFormat(e),this.expression.dataType);return i}isEditable(){return super.isEditable()&&(this.panel.options.editableParts&Ye.Value)===Ye.Value}convertFromInternalFormat(t,e){try{return r.strToDateTime(t,this.internalDateFormat+" "+this.internalTimeFormat)}catch(t){return e||new Date}}convertToInternalFormat(t){return a.dateTimeToStr(t,this.internalDateFormat+" "+this.internalTimeFormat)}}class gs extends hs{renderEditor(){this.dialogBlockBody=Pt("div").addClass(`kfrm-form`).toDOM();this.createEntitiesMenu();this.renderColumnBlock();this.renderQueryPanelBlock()}isEditable(){return super.isEditable()&&(this.panel.options.editableParts&Ye.Value)===Ye.Value}setValue(t,e){if(t instanceof U){this.expression.subQuery=t;if(!e){this.expression.getParent().fireChangedEvent(_.Value)}}}createEntitiesMenu(){const t=this.getContext().getModel();const e=this.expression.dataType;this.colEntitiesList=t.getEntitiesTreeWithFilter(((t,s)=>{if(s){return s.useInConditions&&s.dataType===e}else{return t.attributes&&t.useInConditions}}));if(!t||t.isEmpty())return null;let s=this.element.getAttribute("data-id");if(s){s+="-SubColumnMenu"}const i={items:this.colEntitiesList,adjustHeight:this.panel.options.adjustEntitiesMenuHeight,id:s,isSubQuery:true,domWriteItemsId:this.panel.options.domWriteItemsId};r.assign(i,this.panel.options.menuOptions);this.colEntitiesMenu=new Me(i)}renderColumnBlock(){this.columnBlock=Pt("div",this.dialogBlockBody).addClass(`kfrm-field`).addChild("label",(t=>t.addText(a.getText("SubQueryColumnTitle")))).addChild("a",(t=>this.columnElement=t.attr("href","javascript:void(0)").on("click",(t=>{this.colEntitiesMenu.showMenu({anchor:this.columnElement,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t.id;this.setResultAttributeId(s);return false}})})).toDOM())).toDOM()}getEmptyText(){return this.panel.options.emptyTextValue||a.getText("MsgSubQueryValue")}renderQueryPanelBlock(){const t=Pt("div",this.dialogBlockBody).addClass(`kfrm-field`).addChild("label",(t=>t.addText(a.getText("SubQueryQueryPanelCaption")))).toDOM();this.subQueryPanelBlock=Pt("div",t).toDOM();let e=this.element.getAttribute("data-id");if(e){this.subQueryPanelBlock.id=e+"-SubQueryPanel"}}setResultAttributeId(t){let e=this.getContext().getModel().getAttributeById(t);if(e&&this.subQuery){let s=this.subQuery.getColumns();let i;if(s.length>0){i=s[0];i.expr.setValue(t);i.expr.dataType=e.dataType;i.fireChangedEvent()}else{i=this.subQuery.createColumn();i.sorting=Q.None;i.sortIndex=-1;let n=new R(i);n.setValue(t);n.tag=L.EntityAttribute;n.kind=D.Attribute;n.dataType=e.dataType;i.expr=n;s.push(i);this.subQuery.fireColumnsChangedEvent(O.Add,i)}this.columnElement.innerText=this.getAttributeText(e)}}getAttributeText(t){if(!t)return a.getText("SubQueryEmptyColumn");let e=a.getText("Attributes",t.id);if(!e)e=t.caption;let s=this.panel.options.attrElementFormat;if(!s)return e;let i=s.replace(new RegExp("{attr}","g"),e);let n=this.getContext().getModel().getFullEntityPathByAttr(t.id,".");return i.replace(new RegExp("{entity}","g"),n)}showEditor(){const t=this.panel;const e=this.getContext();this.subQueryPanelBlock.innerHTML="";this.subQuery=e.createQuery();if(this.expression.subQuery){this.subQuery.loadFromData(this.expression.subQuery.toJSONData())}let s=r.assign({},t.options);s.isSubQuery=true;s.showAddRow=true;s.menuContainer=document.body;s.menuOptions.isSubQuery=true;s.entitiesListFilter=(e,s)=>{if(t.options.entitiesListFilter){let i=s||{};i.isSubQuery=true;t.options.entitiesListFilter(e,i)}};let i=this.panel.clonePanel(this.subQueryPanelBlock,this.subQuery);i.init(this.panel.getContext(),s);let n=null;let h=this.subQuery.getColumns();if(h.length==0){let t=this.expression.getParent();if(t.expressions.length>0){let e=t.expressions[0];n=e.tag==L.EntityAttribute||e.kind==D.Attribute?e.value:null}}else{n=h[0].expr.value}if(n){this.setResultAttributeId(n)}else{this.columnElement.innerText=a.getText("SubQueryEmptyColumn")}i.refresh();const o=this.subQueryPanelBlock.querySelector(".eqjs-qp-conditions-root");if(o){o.style.minHeight="100px"}const l=this.panel.getContext().getServices().getService("DialogService");l.open({title:a.getText("SubQueryDialogTitle"),body:this.dialogBlockBody,width:this.panel.options.subQueryDialogWidth,closable:true,cancelable:true,onSubmit:()=>{const t=this.subQuery;if(t.tryValidate({checkExpressions:true})){this.setValue(t);return true}return false}})}closeEditor(){}}class ys extends as{constructor(t,e,s,i){super(t,e,s,i);this.expression.tag=L.ParentColumn}fillMenuItemsList(t){const e=this.panel.getQuery().getParentQuery();const s=this.expression.getParent();const i=s.expressions[0].dataType;this.menuItemsList=e.getColumns().filter((t=>t.expr.dataType==i)).map((t=>({id:t.id,text:t.caption})));if(t){t()}}}class bs extends mt{get cssPrefix(){return"eqjs-qp"}constructor(t,e){super(t);this.options={editableParts:Ye.All,isSubQuery:false,activeCondition:null,entitiesPopupHandler:null,entitiesListFilter:null,menuContainer:document.body,showRootRow:true,showAddRow:true,showCheckboxes:false,allowParameterization:false,allowInJoinConditions:false,showPoweredBy:false,buttons:{condition:null,group:null},alwaysShowButtonsInGroups:false,alwaysShowButtonsInConditions:false,showConjunctions:true,accentActiveCondition:true,activateRootOnStart:true,yearRange:"c-10:c+10",oneClickDateSelection:true,showDateTimeInput:false,attrElementFormat:"{entity} {attr}",menuOptions:{showSearchBoxAfter:30,searchBoxAutoFocus:true,activateOnMouseOver:true,itemRenderedCallback:null},allowDragDrop:true,attrPlacement:0,sortEntities:false,subQueryDialogWidth:600,subQueryDialogHeight:300,dialogZIndex:1e5,numberListSeparators:[",",";"],autoEditNewCondition:false,onConditionRendered:null,onGetConditionRenderer:null,onGetExpressionRenderer:null,onGetOperatorRenderer:null,onOperatorRendered:null,onGetAddRowRenderer:null,defaultQuery:null,showIndicatorOnLoad:true,editMode:Ae.Default};this.customQuery=null;this.landingSlot=Pt("div").addClass(`${this.cssPrefix}-cond-landing-slot`).addChildElement(Pt("div").toDOM()).toDOM();if(!this.slot.classList.contains(`${this.cssPrefix}-panel`)){this.slot.classList.add(`${this.cssPrefix}-panel`)}this.group=it.Query;if(e){this.customQuery=e}}getWidgetType(){return"queryPanel"}init(t,e){super.init(t,e);this.setOptions(e);this.renderProgressBlock();this.detachQueryObserver();this.attachQueryObserver();this.convertEditModelToEditableParts();Gt.removeDropContainer(this.slot);if(this.options.allowDragDrop&&(this.options.editableParts&Ye.Addition)==Ye.Addition){const t=this.getContext().getModel();Gt.registerDropContainer({element:this.slot,scopes:["entityAttr"],onDragEnter:(e,s)=>{this.slot.classList.add(`${$e}-drophover`);s.dragImage.classList.add("eqjs-sortable-helper");this.showLandingSlot();const i=s.data.attrId;if(!t.checkAttrProperty(i,"useInConditions")){s.dropEffect=Qt.Forbid}},onDragOver:(t,e)=>{},onDragLeave:(t,e)=>{e.dragImage.classList.remove("eqjs-sortable-helper");e.dragImage.style.removeProperty("width");this.slot.classList.remove(`${$e}-drophover`);this.hideLangindSlot()},onDrop:(t,e)=>{const s=this.getQuery();const i={parent:s.getRootCondition(),attributeId:e.data.attrId};const n=s.addSimpleCondition(i);if(n){s.fireConditionsChangedEvent(O.Add,n)}}})}}convertEditModelToEditableParts(){if(this.options.editMode!==Ae.Default){switch(this.options.editMode){case Ae.ReadOnly:this.options.editableParts=Ye.None;break;case Ae.FixedList:this.options.editableParts=Ye.FixedConditionList;break;default:this.options.editableParts=Ye.All;break}}}destroyCore(){Gt.removeDropContainer(this.slot);this.detachQueryObserver();this.slot.innerHTML=""}getEntitiesMenu(){return this.entitiesMenu}getConditionMenu(){return this.conditionMenu}getLinkTypeMenu(){return this.linkTypeMenu}getConditionGroupMenu(t=false){return t?this.rootGroupMenu:this.groupMenu}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{const e=t.data;if(!e||e.part!=P.Conditions&&e.part!=P.All){return}const s=document.activeElement;const i=this.slot.contains(s)||s==document.body;switch(e.action){case O.Modify:{const t=e.changee;const s=(t,s)=>{const n=this.slot.querySelector(`div[data-id=${t.id}]`);if(n){s=s&&(e.condPart&_.Operator)===_.Operator&&t.expressions.length>1&&(t.expressions[1]._isDefaultValue||t.expressions[1].value==""||t.expressions[1].value==null);const r=n.classList.contains("active");const h=this.getConditionRenderer(t,n);if(h){const e=h.render(s);if(r){this.toggleConditionPicked(t)}if(i&&!s){const t=e.querySelector("a")||e.querySelector(".eqjs-qp-condition-button");if(t){ke(t)}}}}};let n=this.options.autoEditNewCondition&&!gt.isMobileMode();if(Array.isArray(t)){t.forEach((t=>s(t,n)));n=false}else{s(t,n)}break}case O.Add:{const t=e.changee;const s=t=>{const e=this.getConditionRenderer(t);if(e){const s=t.getParent();const n=this.slot.querySelector(`div[data-id=${s.id}]`);if(n){const t=n.lastChild;if(t){const s=e.render(this.options.autoEditNewCondition&&!gt.isMobileMode());t.appendChild(s);s.scrollIntoView(false);if(i&&(!this.options.autoEditNewCondition||gt.isMobileMode())){s.querySelector(`a`).focus()}}}}};if(Array.isArray(t)){t.forEach((t=>s(t)))}else{s(t)}break}case O.Delete:{const t=e.changee;const s=t=>{const e=this.slot.querySelector(`div[data-id=${t.id}]`);if(e){const s=this.slot.querySelector(`div[data-id=${t.getParent().id}] > .eqjs-qp-row-group`);const n=e.nextSibling;const r=e.previousSibling;e.parentElement.removeChild(e);if(i){const t=n||r||s;const e=t.querySelector("a")||t.querySelector(".eqjs-qp-condition-button");if(e){e.focus()}}}};if(Array.isArray(t)){t.forEach((t=>s(t)))}else{s(t)}break}default:this.refresh();break}}))}detachQueryObserver(){if(this.queryEventCallbackId){const t=this.getQuery();t.removeChangedCallback(this.queryEventCallbackId)}}getQuery(){if(this.customQuery){return this.customQuery}return this.context.getQuery()}isReadOnly(){return this.options.editableParts==Ye.None}isFixed(){return this.options.editableParts<Ye.Attribute}get editMode(){return this.options.editMode||Ae.Default}set editMode(t){if(this.options.editMode!==t){this.options.editMode=t;this.convertEditModelToEditableParts();this.refresh()}}refreshCore(){this.clear();this.render()}setOptions(t){r.assignDeep(this.options,t);if(this.options.dateFormatValue){a.updateLocaleSettings({editDateFormat:this.options.dateFormatValue})}if(this.options.dateFormatDisplay){a.updateLocaleSettings({shortDateFormat:this.options.dateFormatDisplay})}if(typeof this.options.editableParts==="undefined"){this.options.editableParts=Ye.All}if(gt.isMobileMode()){this.options.buttons=this.options.buttons||{};this.options.buttons.condition=["menu"];this.options.buttons.group=["menu"]}}clear(){this.slot.innerHTML=""}render(){try{this.entitiesMenu=this.createEntitiesMenu();this.createConditionMenus();this.createLinkTypeMenu();this.rootContainer=Pt("div",this.slot).toDOM();Pt(this.slot).removeClass(Te).addClass(Se());const t=this.getQuery();const e=t.getRootCondition();const s=this.getConditionRenderer(e,this.rootContainer);if(s){s.render()}if(this.options.showAddRow&&(this.options.editableParts&Ye.Addition)==Ye.Addition){this.addRowElement=Pt("div",this.slot).toDOM();const t=this.getAddRowRenderer(this.addRowElement);if(t)t.render()}}catch(t){const e=t;this.context.throwError({action:"QueryPanel rendering",text:e.message,sourceError:e})}}getConditionRenderer(t,e){let s;if(this.options.onGetConditionRenderer){s=this.options.onGetConditionRenderer(t,e);if(s){return s}}switch(t.tag){case j.Simple:return new ts(this,t,e);case j.Group:return new is(this,t,e)}return null}getExpressionRenderer(e,s){if(!e){throw"Expression is not defined in the condition"}const i=this.getContext().getModel();const n=e.getParent();const r=i.getOperatorById(n.getOperatorId());const h=i.getAttributeByIdSafe(n.expressions[0].value);const o=i.getOperand(h,r,e.getIndex());let l;let a;if(o&&o.editor&&o.editor.tag!==F.Unknown){l=o.editor}else if(h&&h.defaultEditor){l=h.defaultEditor}else{l=new E}a=l.tag;let u=e.dataType;if(u==t.Unknown){u=h.dataType}if(e.kind===D.Attribute){if(e.getIndex()===0){return new cs(this,e,this.entitiesMenu,s)}else{let t=this.createEntitiesMenu(((t,e)=>{if(e){return e.useInConditions&&e.dataType===u}return true}));return new cs(this,e,t,s)}}else if(e.kind===D.Query){a=F.SubQuery}else if(e.kind===D.Scalar){if(a==F.Unknown&&(e.dataType===t.Date||e.dataType===t.DateTime||e.dataType===t.Time)){a=F.DateTime}}else if(e.kind==D.ParentColumn){a=F.BindToParentColumn}if(this.options.onGetExpressionRenderer){let t=this.options.onGetExpressionRenderer(this,e,l,s);if(t){return t}}switch(a){case F.List:return new ls(this,e,l,s);case F.SqlList:return new us(this,e,l,s);case F.CustomList:return new as(this,e,l,s);case F.DateTime:return new ps(this,e,l,s);case F.SubQuery:return new gs(this,e,l,s);case F.BindToParentColumn:return new ys(this,e,l,s);default:return new os(this,e,l,s)}}getOperatorRenderer(t,e,s){let i;if(this.options.onGetOperatorRenderer)i=this.options.onGetOperatorRenderer(t,e,s);if(i)return i;return new ms(this,t,e,s)}getAddRowRenderer(t){let e;if(this.options.onGetAddRowRenderer)e=this.options.onGetAddRowRenderer(t);if(e)return e;return new ds(this,this.entitiesMenu,t)}createEntitiesMenu(t){const e=this.getContext().getModel();if(!e||e.isEmpty())return null;let s=this.slot.id||"eq-querypanel";s+="-EntitiesMenu";const i=e.getEntitiesTree({addUIC:true,addUIR:false,addUIS:false,attrPlacement:this.options.attrPlacement,sortEntities:this.options.sortEntities},t);const n={items:i,adjustHeight:this.options.adjustEntitiesMenuHeight,id:s,domWriteItemsId:this.options.domWriteItemsId};r.assign(n,this.options.menuOptions);return new Me(n)}showEntitiesMenu(t){this.entitiesMenu.showMenu(Object.assign({},this.options.menuOptions,t))}createConditionMenus(){{const t=this.getQuery();let e=this.slot.id||"eq-querypanel";e+="-ConditionMenu";const s=[{id:"enable",text:a.getText("MenuEnable")},{id:"delete",text:a.getText("CmdDelete")}];if(t.isEx()){if(this.options.allowParameterization||this.options.allowInJoinConditions){s.push({id:"delimiter",text:"---"})}if(this.options.allowParameterization){s.push({id:"param",text:a.getText("MenuParameterization")})}if(this.options.allowInJoinConditions){s.push({id:"inJoin",text:a.getText("MenuJoinCond")})}}const i={items:s,adjustHeight:this.options.adjustEntitiesMenuHeight,id:e,domWriteItemsId:this.options.domWriteItemsId,showSearchBoxAfter:100,showSelected:true};r.assign(i,this.options.menuOptions);this.conditionMenu=new Me(i)}{let t=this.slot.id||"eq-querypanel";t+="-GroupMenu";const e=[{id:"enable",text:a.getText("MenuEnable")},{id:"delete",text:a.getText("CmdDelete")},{id:"delimiter",text:"---"},{id:"addCondition",text:a.getText("CmdAddCondition")},{id:"addGroup",text:a.getText("CmdAddCondGroup")}];const s={items:e,adjustHeight:this.options.adjustEntitiesMenuHeight,id:t,domWriteItemsId:this.options.domWriteItemsId,showSearchBoxAfter:100,showSelected:true};r.assign(s,this.options.menuOptions);this.groupMenu=new Me(s)}{let t=this.slot.id||"eq-querypanel";t+="-RootGroupMenu";const e=[{id:"addCondition",text:a.getText("CmdAddCondition")},{id:"addGroup",text:a.getText("CmdAddCondGroup")}];const s={items:e,adjustHeight:this.options.adjustEntitiesMenuHeight,id:t,domWriteItemsId:this.options.domWriteItemsId,showSearchBoxAfter:100,showSelected:true};r.assign(s,this.options.menuOptions);this.rootGroupMenu=new Me(s)}}createLinkTypeMenu(){let t=this.slot.id;if(t){t+="-LinkTypeMenu"}const e=dt.predicateLinkTypeList;const s=e.map((t=>({id:t.id,text:a.getText(t.key)})));const i={items:s,adjustHeight:this.options.adjustEntitiesMenuHeight,id:t,domWriteItemsId:this.options.domWriteItemsId};r.assign(i,this.options.menuOptions);this.linkTypeMenu=new Me(i)}toggleConditionPicked(t,e=undefined){let s;let i;if(t){s=this.slot.querySelector(`div[data-id=${t.id}][data-condrow], div[data-id=${t.id}] > div[data-group-row]`);if(s){i=s.classList.contains("active")}}const n=this.slot.querySelectorAll(`.${this.cssPrefix}-row`);for(let t=0;t<n.length;t++){const e=n[t];if(e.hasAttribute("data-group-row")){if(!this.options.alwaysShowButtonsInGroups){Pt(e).data("show-buttons",null)}}else{if(!this.options.alwaysShowButtonsInConditions){Pt(e).data("show-buttons",null)}}Pt(e).removeClass("active")}if(s&&!i){Pt(s).addClass("active").data("show-buttons","")}}showLandingSlot(){const t=this.slot.querySelector(".eqjs-qp-conditions-root");if(t){t.appendChild(this.landingSlot);this.landingSlot.scrollIntoView({block:"center",behavior:"smooth"})}}hideLangindSlot(){if(this.landingSlot.parentElement){this.landingSlot.parentElement.removeChild(this.landingSlot)}}onProcessStartCore(){if(this.options.showIndicatorOnLoad){if(!this.progressBlock.parentNode)this.slot.appendChild(this.progressBlock)}}onProcessEndCore(){if(this.options.showIndicatorOnLoad){if(this.progressBlock.parentNode)this.slot.removeChild(this.progressBlock)}}renderProgressBlock(){this.progressBlock=document.createElement("div");this.progressBlock.classList.add(`${$e}-progress-win8`);this.progressBlock.classList.add(Se());this.progressBlock.innerHTML='<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>'}clonePanel(t,e){return new bs(t,e)}}class vs extends mt{constructor(t){super(t);this.options={applyOnClose:true,showApplyButton:true,showClearButton:true,queryPanel:{showAddRow:true,showCheckboxes:true,alwaysShowButtonsInGroups:true}};this.headerClickListener=this.headerClickHandler.bind(this);this.group=it.Query}getWidgetType(){return"filterBar"}get cssPrefix(){return"eqjs-fb"}init(t,e){super.init(t,e);this.setOptions(e);this.destroyCore();this.qpElement=Pt("div").addClass(`${this.cssPrefix}-querypanel`).toDOM();this.queryPanel=new bs(this.qpElement);this.queryPanel.init(t,this.options.queryPanel||{});this.attachQueryObserver()}setOptions(t){this.options=r.assignDeep(this.options,t)}applyBtnClick(t){this.applyFilter()}clearBtnClick(t){this.clearFilter()}showQueryPanel(t){At(this.qpBlock,200,(()=>{this.updateHeader();if(t)t()}))}hideQueryPanel(){It(this.qpBlock,200,(()=>{this.updateHeader();if(this.options.applyOnClose){this.applyFilter()}}))}headerClickHandler(t){t.preventDefault();if(Pt(this.qpBlock).isVisible()){this.hideQueryPanel()}else{this.showQueryPanel()}}updateHeader(){if(!this.headerTextElement)return;let t="";const e=this.getContext().getQuery();if(e){t=e.getConditionsText()}if(t==""){t=a.getText("StrNoFilterDefined")}Pt(this.headerTextElement).text(t).attr("title",t);if(!e||e.isEmptyConditions()){Pt(this.headerTextElement).hide();Pt(this.headerLinkElement).show();if(!Pt(this.qpBlock).isVisible()){Pt(this.headerArrowBlock).hide();this.headerElement.style.cursor="";this.headerElement.removeEventListener("click",this.headerClickListener)}}else{this.headerElement.style.cursor="pointer";this.headerElement.removeEventListener("click",this.headerClickListener);this.headerElement.addEventListener("click",this.headerClickListener);Pt(this.headerTextElement).show();Pt(this.headerLinkElement).hide();Pt(this.headerArrowBlock).show()}if(Pt(this.qpBlock).isVisible()){this.headerArrowElement.classList.add(`${this.cssPrefix}-header-arrowUp`)}else{this.headerArrowElement.classList.remove(`${this.cssPrefix}-header-arrowUp`)}this.textResize()}render(){Pt(this.slot).addClass(`${this.cssPrefix}-container`).addClass(Se()).addChild("div",(t=>this.headerElement=t.addClass(`${this.cssPrefix}-header`).addChild("div",(t=>this.headerIconElement=t.addClass(`${this.cssPrefix}-header-icon`).toDOM())).addChild("div",(t=>this.headerTextBlock=t.addClass(`${this.cssPrefix}-header-textblock`).addChild("div",(t=>this.headerTextElement=t.addClass(`${this.cssPrefix}-header-text`).toDOM())).addChild("div",(t=>this.headerLinkElement=t.addClass(`${this.cssPrefix}-header-text ${this.cssPrefix}-header-link`).text(a.getText("StrNoFilterClickToAdd")).hide().on("click",(()=>{console.log("condition filter click");this.queryPanel.showEntitiesMenu({anchor:this.headerLinkElement,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t.id;this.showQueryPanel((()=>{const t=this.getContext().getQuery();const e={parent:t.getRootCondition(),attributeId:s};const i=t.addSimpleCondition(e);if(i){t.fireConditionsChangedEvent(O.Add,i)}}))}})})).toDOM())).toDOM())).addChild("div",(t=>this.headerArrowBlock=t.addClass(`${this.cssPrefix}-header-arrowblock`).addChild("div",(t=>this.headerArrowElement=t.addClass(`${this.cssPrefix}-header-arrow`).toDOM())).toDOM())).toDOM())).addChild("div",(t=>this.qpBlock=t.addClass(`${this.cssPrefix}-querypanelblock`).addClass(Se()).hide().addChildElement(this.qpElement).toDOM()));if(this.options.showApplyButton||this.options.showClearButton){this.buttonsBlock=Pt("div",this.qpBlock).addClass(`${this.cssPrefix}-buttonsblock`).addClass(Se()).toDOM()}if(this.options.showApplyButton){Pt("a",this.buttonsBlock).attr("href","javascript:void(0)").addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-apply`).text(a.getText("ButtonApply")).on("click",this.applyBtnClick.bind(this))}if(this.options.showClearButton){Pt("a",this.buttonsBlock).attr("href","javascript:void(0)").addClass(`${this.cssPrefix}-button ${this.cssPrefix}-button-clear`).text(a.getText("CmdClear")).on("click",this.clearBtnClick.bind(this))}window.addEventListener("resize",(()=>{this.textResize()}));this.updateHeader();this.queryPanel.refresh();setTimeout((()=>this.textResize()),500)}refreshCore(){this.clear();this.render()}clear(){this.slot.innerHTML=""}applyFilter(){if(this.options.applyFilterCallback){this.options.applyFilterCallback()}}clearFilter(){const t=this.getContext().getQuery();if(t){t.clearConditions();t.fireConditionsChangedEvent(O.All)}}textResize(){this.headerTextBlock.style.width=this.slot.clientWidth-this.headerIconElement.offsetWidth-(Pt(this.headerArrowBlock).isVisible()?this.headerArrowBlock.offsetWidth:0)+"px"}destroyCore(){if(this.queryPanel)this.queryPanel.destroy();this.detachQueryObserver();this.slot.innerHTML=""}attachQueryObserver(){const t=this.getContext().getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{this.updateHeader()}))}detachQueryObserver(){const t=this.getContext().getQuery();if(t)t.removeChangedCallback(this.queryEventCallbackId)}}class ws extends mt{constructor(t){super(t);this.options={useCustomLocaleSettings:false};this.slot=t;this.group=it.Result}getWidgetType(){return"grid"}init(t,e){super.init(t,e);if(e){r.assignDeep(this.options,e)}}refreshCore(){this.clear();if(!this.context.resultTable){return}this.render()}render(){if(this.options.beforeTableRendering){this.options.beforeTableRendering(this.context.resultTable)}this.applyDisplayFormats()}applyDisplayFormats(){}clear(){this.slot.innerHTML=""}}class Cs extends ws{constructor(t){super(t);this.hasCustomTotalsSettings=false;
//!!!! DO NOT forget to add types for options
this.options={autoRefresh:true};this.group=it.Result}getWidgetType(){return"easyGrid"}init(t,e){var s,i;super.init(t,e);const n=Object.assign(Object.assign(Object.assign(Object.assign({},(s=t.options.widgets)===null||s===void 0?void 0:s.resultGrid),(i=t.options.widgets)===null||i===void 0?void 0:i.easyGrid),e),{slot:this.slot,dataTable:t.resultTable});this.options=r.assign(this.options,n);n.onPlusButtonClick=t=>this.addColumnClickHandler(t);n.onColumnMoved=t=>this.columnMovedHandler(t);if(n.aggregates){this.hasCustomTotalsSettings=true}else{n.aggregates={settings:t.getQuery().getAggregationSettings(),calculatorRef:null}}n.aggregates.calculatorRef=this.context.getAggregatesCalculator();this.destroy();this.grid=new he(n);if(this.options.autoRefresh){this.attachQueryObserver()}}refreshCore(){this.clear();this.updateTotalsSettings();this.render()}render(){this.createEntitiesMenu();this.grid.refresh()}attachQueryObserver(){}destroyCore(){this.detachQueryObserver();if(this.grid)this.grid.destroy();this.slot.innerHTML=""}detachQueryObserver(){if(this.queryEventCallbackId){const t=this.getContext().getQuery();t.removeChangedCallback(this.queryEventCallbackId)}}updateTotalsSettings(){const t=this.getContext();if(!this.hasCustomTotalsSettings){const e=t.getQuery().getAggregationSettings();this.grid.options.aggregates.settings=e}}createEntitiesMenu(){const t=this.getContext().getModel();if(!t||t.isEmpty())return;let e=this.slot.id;if(e){e+="-EntitiesMenu"}const s=t.getEntitiesTree({addUIC:false,addUIR:true,addUIS:false});const i={items:s,id:e};r.assign(i,this.options.menuOptions);this.entitiesMenu=new Me(i)}getModel(){return this.context.getModel()}getQuery(){return this.context.getQuery()}clear(){if(this.grid)this.grid.clear()}addColumnClickHandler(t){this.entitiesMenu.showMenu({anchor:t.sourceEvent.target,selectedIds:null,itemSelectedCallback:(t,e)=>{const s=t.id;this.addNewColumn(s);return false}})}columnMovedHandler(t){const e=this.getQuery();const s=r.findItemIndexById(e.getColumns(),t.columnId);if(s>=0){e.moveColumn(s,t.newIndex);e.fireChangedEvent({part:P.Columns,action:O.All,source:this})}}addNewColumn(t){this.getContext().getModel();const e=this.getContext().getQuery();const s=e.addColumn({attributeId:t},true);e.fireChangedEvent({part:P.Columns,action:O.Add,changee:s,source:this});return s}}class xs extends mt{constructor(t){super(t);this.panel=t;this.group=it.Statement;if(this.panel.tagName!=="TEXTAREA"){this.panel.innerHTML='<div class="eqv-sql-panel-result"></div>';this.panel=this.panel.querySelector("div")}}getWidgetType(){return"statementPanel"}refreshCore(){this.clear();this.render()}render(){this.panel.textContent=this.context.resultStatement?this.context.resultStatement:"";var t=this.panel.innerHTML.replace(/\r\n/g,"<br />").replace(/  /g,"&nbsp;&nbsp;");this.panel.innerHTML=t}destroyCore(){this.clear()}clear(){this.panel.innerHTML=""}}class ks extends mt{constructor(t){super(t);this.element=t;this.element.style.display="none";this.group=it.All}getWidgetType(){return"processIndicator"}onProcessStartCore(){this.element.style.display=""}onProcessEndCore(){this.element.style.display="none"}}var $s;(function(t){t["DataGrid"]="DATA_GRID";t["Chart"]="CHART";t["PivotTable"]="PIVOT_TABLE"})($s||($s={}));function Ts(t,e,s,i){function n(t){return t instanceof s?t:new s((function(e){e(t)}))}return new(s||(s=Promise))((function(e,s){function r(t){try{o(i.next(t))}catch(t){s(t)}}function h(t){try{o(i["throw"](t))}catch(t){s(t)}}function o(t){t.done?e(t.value):n(t.value).then(r,h)}o((i=i.apply(t,[])).next())}))}typeof SuppressedError==="function"?SuppressedError:function(t,e,s){var i=new Error(s);return i.name="SuppressedError",i.error=t,i.suppressed=e,i};class Ss{constructor(t,e){this.container=t;this.title=a.getText("Facets","DefaultFacetTitle");this.cssPrefix="eqjs-facet";this.dialogTitle=a.getText("Facets","DefaultDlgTitle");this.options={};this.canDisplayFlag=true;this.downloadAllClickHandler=()=>{const t=this.getContext().resultTable;if(!t.elasticChunks){const e=t.getCachedRows().length;const s=t.getTotal()-t.getCachedCount();const i=this.getDialogService();const n=i.openProgress({title:a.getText("Facets","LoadDataDlgTitle"),content:a.getText("Facets","LoadDataDlgContent").replace("{loadedRecs}","0").replace("{totalRecs}",`${s}`),onSubmit:()=>this.refresh(),determinated:true});let r=0;setTimeout((()=>{t.getRows({offset:e,limit:s}).then((t=>{r+=t.length;const e=r/s;n.updateContent(a.getText("Facets","LoadDataDlgContent").replace("{loadedRecs}",`${r}`).replace("{totalRecs}",`${s}`));n.updateProgress(e)})).catch((t=>{n.submit();this.getContext().throwError(t)}))}),10)}else{const t=this.getDialogService();const e=t.openProgress({title:a.getText("Facets","LoadDataDlgTitle"),onSubmit:()=>this.refresh(),determinated:false});this.loadElasticChunk().then((t=>{e.submit()})).catch((t=>{e.submit();this.getContext().throwError(t)}))}};r.assignDeep(this.options,e)}init(t){this.slot=t;this.contentDiv=Pt("div",this.slot).addClass(`${this.cssPrefix}-content`).toDOM();this.displayMessageDiv=Pt("div",this.slot).hide().toDOM()}showSettingsDialog(){return new Promise((t=>{const e=this.getDialogService();const s=this.renderDialogContent();const i=e.open({title:this.dialogTitle,body:s,cancelable:true,closable:false,onSubmit:()=>{const e=this.submitSettingsDialog();if(e){t(true)}return e},onCancel:()=>{t(false)}});this.afterDialogOpened(i)}))}afterDialogOpened(t){}renderDialogContent(){let t;let e=Pt("div").addClass("kfrm-form").addChild("div",(e=>t=e.addClass(`${gt.isIE()?"kfrm-fields-ie col-ie-1-4 label-align-right":"kfrm-fields col-a-1 label-align-right"}`).toDOM()));this.renderFormFields(e.toDOM(),t);return e.toDOM()}renderFormFields(t,e){let s=e;if(gt.isIE()){s=Pt("div",e).addClass("kfrm-field-ie").toDOM()}Pt(s).addChild("label",(t=>t.attr("for","tab_name").addText(a.getText("Facets","TabNameLabel")))).addChild("input",(t=>t.id("facetTabName").name("tab_name").type("text").attr("value",this.title)))}submitSettingsDialog(){const t=document.querySelector("#facetTabName");if(t.value.length==0)return false;this.title=t.value;return true}getDialogService(){return this.getContext().getServices().getService("DialogService")}canDisplay(){const t=this.getContext();const e=t.resultTable;return e.getCachedCount()==e.getTotal()}showErrorMessage(t){this.displayMessageDiv.innerHTML=t;this.displayMessageDiv.classList.add(`${this.cssPrefix}-error-message`);Pt(this.displayMessageDiv).show()}showUnableDisplayMessage(t){const e=this.getContext();const s=e.resultTable;this.displayMessageDiv.innerHTML=t||a.getText("Facets","ErrNotEnoughData").replace("{totalRecs}",`${s.getTotal()}`).replace("{cachedRecs}",`${s.getCachedCount()}`).replace(/\[(.*)\]/g,`<a href='javascript:void(0)' class="${this.cssPrefix}-download-all-link">$1</a>`);const i=this.displayMessageDiv.querySelector(`a.${this.cssPrefix}-download-all-link`);if(i){i.addEventListener("click",this.downloadAllClickHandler)}Pt(this.contentDiv).hide();Pt(this.displayMessageDiv).show()}hideUnableDisplayMessage(){Pt(this.displayMessageDiv).hide();Pt(this.contentDiv).show()}getContext(){return this.container.getContext()}getQuery(){return this.getContext().getQuery()}saveToData(){return{title:this.title,type:this.getType()}}loadFromData(t){if(t){this.title=t.title}}refresh(){this.hideUnableDisplayMessage();if(this.canDisplay()){this.refreshCore()}else{this.showUnableDisplayMessage()}}loadElasticChunk(){return Ts(this,void 0,void 0,(function*(){const t=this.getContext().resultTable;const e=t.getCachedRows().length;return t.getRows({offset:e,limit:t.chunkSize}).then((e=>t.totalIsKnown()?Promise.resolve():this.loadElasticChunk()))}))}onResize(){}}var Es;(function(t){t[t["Column"]=3]="Column";t[t["Histogram"]=4]="Histogram";t[t["Bar"]=5]="Bar";t[t["Combo"]=6]="Combo";t[t["Area"]=7]="Area";t[t["Line"]=9]="Line";t[t["Pie"]=10]="Pie";t[t["Polar"]=11]="Polar";t[t["Doughnut"]=12]="Doughnut";t[t["Radar"]=13]="Radar";t[t["SteppedLine"]=14]="SteppedLine"})(Es||(Es={}));class Ds extends mt{get cssPrefix(){return"eqjs-chart"}constructor(t){super(t);this.chartType=Es.Pie;this.supportedChartTypes=[];this.dataTable=null;this.potentialLabelColumns=[];this.potentialDataColumns=[];this.labelColumn=-1;this.dataColumns=[];this.options={chartType:Es.Pie,showOnPaging:false,hideSettings:false,legend:{show:false,position:"right"}};this.element=t;this.group=it.Result}init(t,e){super.init(t,e);this.dataTable=t.resultTable;this.setOptions(e)}hasData(){let t=this.dataTable!=null;if(t){t=this.dataTable.getCachedCount()>0}return t}hasColumnsForChart(){return this.potentialLabelColumns.length>0&&this.potentialDataColumns.length>0}refreshCore(){this.prepareChartData();this.render()}setOptions(t){r.assignDeep(this.options,t);this.supportedChartTypes=this.getSupportedChartTypes();if(this.supportedChartTypes.length==0){throw Error("Chart widget should support at least one chart type")}if(t.chartType&&this.supportedChartTypes.indexOf(t.chartType)>=0){this.chartType=t.chartType}else{this.chartType=this.supportedChartTypes[0]}}getOptions(){return this.options}getChartTypeName(t){switch(t){case Es.Area:return a.getText("ChartType","Area");case Es.Bar:return a.getText("ChartType","Bar");case Es.Column:return a.getText("ChartType","Column");case Es.Combo:return a.getText("ChartType","Combo");case Es.Doughnut:return a.getText("ChartType","Doughnut");case Es.Polar:return a.getText("ChartType","Polar");case Es.Radar:return a.getText("ChartType","Radar");case Es.Histogram:return a.getText("ChartType","Histogram");case Es.Line:return a.getText("ChartType","Line");case Es.SteppedLine:return a.getText("ChartType","SteppedLine");default:return a.getText("ChartType","Pie")}}updateSettings(t,e=true){if(typeof t.showLegend!=="undefined"){this.options.legend=this.options.legend||{};this.options.legend.show=t.showLegend}this.chartType=t.type;this.labelColumn=t.labelColumn;this.dataColumns[0]=t.dataColumn;if(e)this.updateChartColumns()}prepareChartData(){if(this.dataTable){this.potentialLabelColumns=[];this.potentialDataColumns=[];let t=this.dataTable.columns.count;for(let e=0;e<t;e++){const t=this.dataTable.columns.get(e);let s=t.type;let i=t.label;this.potentialLabelColumns.push({idx:e,label:i});if(r.isNumericType(s)){this.potentialDataColumns.push({idx:e,label:i})}}if(this.labelColumn!=-1){if(!this.potentialLabelColumns.filter((t=>t.idx==this.labelColumn)).length){this.labelColumn=-1}}else{this.labelColumn=this.potentialLabelColumns.length>0?this.potentialLabelColumns[0].idx:-1}if(this.dataColumns.length){const t=this.potentialDataColumns.map((t=>t.idx));this.dataColumns=this.dataColumns.filter((e=>t.indexOf(e)>=0));if(!this.dataColumns.length){this.dataColumns=this.potentialDataColumns.length>0?[].concat(this.potentialDataColumns[0].idx):[]}}else{this.dataColumns=this.potentialDataColumns.length>0?[].concat(this.potentialDataColumns[0].idx):[]}this.initChart()}}getSupportedChartTypes(){const t=this.options.supportedChartTypes?this.options.supportedChartTypes:Object.keys(Es).map((t=>Es[t]));return t.filter((t=>this.hasChartTypes.indexOf(t)>=0))}getCurrentChartType(){return this.chartType}render(){this.clear();if(this.hasData()&&this.hasColumnsForChart()&&this.context.resultTable.getTotal()==this.context.resultTable.getCachedCount()){let t=document.createElement("div");bt(t,`${this.cssPrefix}-header`);let e=document.createElement("div");bt(e,`${this.cssPrefix}-main`);if(this.canDraw()){let s=document.createElement("select");for(let t of this.supportedChartTypes){let e=document.createElement("option");e.value=t.toString();e.text=this.getChartTypeName(t);s.appendChild(e)}s.value=this.chartType.toString();t.appendChild(s);s.addEventListener("change",(t=>{let e=t.target.value;this.chartType=parseInt(e);this.refresh()}));this.settingsDiv=document.createElement("div");bt(this.settingsDiv,`${this.cssPrefix}-settings`);vt(this.settingsDiv);e.appendChild(this.settingsDiv);this.chartDiv=document.createElement("div");bt(this.chartDiv,`${this.cssPrefix}-content`);vt(this.chartDiv);e.appendChild(this.chartDiv);this.initSettingsDiv();let i=document.createElement("div");bt(i,`${this.cssPrefix}-settings-icon`);i.title="Settings";t.appendChild(i);i.addEventListener("click",(t=>{this.toggleSettings()}));this.drawChart(100)}else{this.addContentDiv(e,"Unable to render  the chart. None of the supported chart libraries (ChartJS, Google Charts, etc) is found.")}if(!this.options.hideSettings){this.element.appendChild(t)}this.element.appendChild(e);this.element.style.display=""}else{this.element.style.display="none"}}addContentDiv(t,e){let s=document.createElement("div");bt(s,`${this.cssPrefix}-no-data`);s.innerText=e;t.appendChild(s)}clear(){this.element.innerHTML=""}drawChart(t){wt(this.chartDiv);if(t>0){setTimeout((()=>this.drawCore()),t)}else{this.drawCore()}}initSettingsDiv(){let t=document.createElement("div");t.textContent="SETTINGS";bt(t,`${this.cssPrefix}-settings-header`);this.settingsDiv.appendChild(t);let e=document.createElement("div");bt(e,`${this.cssPrefix}-settings-single`);this.settingsDiv.appendChild(e);let s=document.createElement("span");wt(s);s.textContent="Label column";e.appendChild(s);let i=document.createElement("select");wt(i);e.appendChild(i);for(let t of this.potentialLabelColumns){let e=document.createElement("option");e.value=t.idx.toString();e.text=t.label;i.appendChild(e)}if(this.labelColumn>=0){i.value=this.labelColumn.toString()}i.addEventListener("change",(t=>{this.labelColumn=parseInt(t.target.value);this.updateChartColumns();this.toggleSettings((()=>{this.drawChart(100)}))}));let n=document.createElement("div");bt(n,`${this.cssPrefix}-settings-single`);this.settingsDiv.appendChild(n);let r=document.createElement("span");wt(r);r.textContent="Data column";n.appendChild(r);let h=document.createElement("select");wt(h);n.appendChild(h);for(let t of this.potentialDataColumns){let e=document.createElement("option");e.value=t.idx.toString();e.text=t.label;h.appendChild(e)}if(this.dataColumns.length>0&&this.dataColumns[0]>=0){h.value=this.dataColumns[0].toString()}h.addEventListener("change",(t=>{this.dataColumns[0]=parseInt(t.target.value);this.updateChartColumns();this.toggleSettings((()=>{this.drawChart(100)}))}))}getPotentialLabelColumns(){return this.potentialLabelColumns}getPotentialDataColumns(){return this.potentialDataColumns}getLabelColumnIndex(){return this.labelColumn}getDataColumnIndex(){return this.dataColumns[0]}toggleSettings(t){let e;let s;if(xt(this.chartDiv)){e=this.chartDiv;s=this.settingsDiv}else{e=this.settingsDiv;s=this.chartDiv}Ct(e,s,{complete:t})}}class As extends Ds{constructor(t){super(t);this.colors=["#4dc9f6","#f67019","#f53794","#537bc4","#acc236","#166a8f","#00a950","#58595b","#8549ba"];this.chartLabels=[];this.chartColumns=[];this.hasChartTypes=[Es.Column,Es.Bar,Es.Area,Es.Line,Es.SteppedLine,Es.Doughnut,Es.Polar,Es.Radar,Es.Pie];this.options.legend={show:false,position:"bottom"}}getWidgetType(){return"chartChartJs"}static hasChartJs(){return typeof Chart!=="undefined"}canDraw(){return As.hasChartJs()}initChart(){if(As.hasChartJs()&&this.labelColumn>=0&&this.dataColumns&&this.dataColumns.length>0){this.updateChartColumns()}}drawCore(){if(As.hasChartJs()&&this.dataTable&&this.dataTable.getCachedCount()>0){let t=this.generateConfig();let e=this.getChartCanvas(this.chartDiv);let s=e.getContext("2d");new Chart(s,t)}}updateChartColumns(){if(this.dataTable){this.chartLabels=[];this.chartColumns=[];const t=this.dataTable.getCachedRows();for(let e=0;e<t.length;e++){this.chartLabels.push(t[e].getValue(this.labelColumn));this.chartColumns.push(t[e].getValue(this.dataColumns[0]))}}}getChartCanvas(t){let e;let s=t.getElementsByTagName("canvas");if(s&&s.length>0){e=s[0]}else{e=yt(t,"canvas")}return e}generateConfig(){let t=[];let e=this.dataTable.columns.get(this.dataColumns[0]).label;let s=true;let i;if(this.chartType==Es.Pie||this.chartType==Es.Doughnut||this.chartType==Es.Polar||this.chartType==Es.Bar||this.chartType==Es.Column){for(let e=0;e<this.chartLabels.length;e++){t.push(this.colors[e%this.colors.length])}}else{t=[this.colors[3]]}if(this.chartType==Es.Line||this.chartType==Es.SteppedLine){s=false;i=this.colors[3]}this.options.legend=this.options.legend||{};const n={data:this.chartColumns,backgroundColor:t,borderColor:i,label:e,fill:s};if(this.chartType==Es.SteppedLine){n.stepped=this.chartType===Es.SteppedLine,n.steppedLine=this.chartType===Es.SteppedLine}const r=this.options.legend.show&&(this.chartType==Es.Pie||this.chartType==Es.Radar||this.chartType==Es.Polar||this.chartType==Es.Doughnut);return{type:this.getChartType(),data:{datasets:[n],labels:this.chartLabels},options:{legend:{display:r,position:this.options.legend.position||"bottom"},title:{display:true,text:e}}}}getChartType(){switch(this.chartType){case Es.Column:return"bar";case Es.Bar:return"horizontalBar";case Es.Area:case Es.SteppedLine:case Es.Line:return"line";case Es.Doughnut:return"doughnut";case Es.Polar:return"polarArea";case Es.Radar:return"radar";case Es.Pie:return"pie";default:return"pie"}}}class Is extends Ds{constructor(t){super(t);this.hasChartTypes=[Es.Column,Es.Bar,Es.Histogram,Es.Combo,Es.Area,Es.Line,Es.SteppedLine,Es.Pie,Es.Doughnut];this.options.legend={show:true,position:"right"}}getWidgetType(){return"chartGoogle"}canDraw(){return Is.hasGoogleCharts()}static hasGoogleCharts(){return typeof google!=="undefined"&&typeof google.charts!=="undefined"}initChart(){if(Is.hasGoogleCharts()&&this.labelColumn>=0&&this.dataColumns&&this.dataColumns.length>0){this.googleDataView=new google.visualization.DataView(this.convertToGoogleFormat());this.updateChartColumns()}}convertToGoogleType(e){switch(e){case t.Date:return"date";case t.DateTime:return"datetime";case t.Time:return"timeofday";case t.Byte:case t.Word:case t.Int32:case t.Int64:case t.Currency:case t.Float:return"number";default:return"string"}}convertToGoogleValue(e,s){switch(s){case t.Bool:return e?e.toString():null;default:return e}}convertToGoogleFormat(){const t=new google.visualization.DataTable;const e=this.dataTable.columns;for(let s=0;s<e.count;s++){const i=e.get(s);t.addColumn(this.convertToGoogleType(i.type),i.label,i.id)}const s=this.dataTable.getCachedRows();t.addRows(s.length);for(let i=0;i<s.length;i++){const n=s[i];for(let s=0;s<e.count;s++){t.setCell(i,s,this.convertToGoogleValue(n.getValue(s),e.get(s).type))}}return t}drawCore(){if(this.googleDataView!=null){this.options.legend=this.options.legend||{};let t={width:"100%",height:"100%",chartArea:{width:this.getChartAreaWidth}};if(this.chartType==Es.Doughnut){t.pieHole=.4}if(!this.options.legend.show){t.legend="none"}else{t.legend={position:this.options.legend.position}}let e=this.createChart(this.chartDiv);e.draw(this.googleDataView,t)}}getChartAreaWidth(t){if(t==Es.Pie){return"100%"}else{return"50%"}}updateChartColumns(){if(this.googleDataView){this.googleDataView.setColumns([].concat(this.labelColumn).concat(this.dataColumns))}}createChart(t){switch(this.chartType){case Es.Column:return new google.visualization.ColumnChart(t);case Es.Histogram:return new google.visualization.Histogram(t);case Es.Bar:return new google.visualization.BarChart(t);case Es.Combo:return new google.visualization.ComboChart(t);case Es.Area:return new google.visualization.AreaChart(t);case Es.Line:return new google.visualization.LineChart(t);case Es.SteppedLine:return new google.visualization.SteppedAreaChart(t);case Es.Pie:case Es.Doughnut:return new google.visualization.PieChart(t);default:return new google.visualization.PieChart(t)}}}class Ms extends Ss{constructor(){super(...arguments);this.title=a.getText("Facets","Chart","FacetTitle");this.dialogTitle=a.getText("Facets","Chart","DlgTitle")}init(t){super.init(t);if(Is.hasGoogleCharts()){this.chart=new Is(this.contentDiv)}else{this.chart=new As(this.contentDiv)}const e=this.container.options?this.container.options.supportedChartTypes:null;this.chart.init(this.getContext(),{legend:{show:false},showOnPaging:true,hideSettings:true,supportedChartTypes:e});Pt(this.slot).hide()}destroy(){if(this.chart){this.chart.destroy()}}getType(){return $s.Chart}renderFormFields(t,e){super.renderFormFields(t,e);const s=gt.isIE();const i=s?"kfrm-fields-ie is-horizontal":"kfrm-fields is-horizontal";let n=document.createElement("select");n.id="chart_type_selector";n.name="chart_type_selector";for(let t of this.chart.getSupportedChartTypes()){let e=document.createElement("option");e.value=t.toString();e.text=this.chart.getChartTypeName(t);n.appendChild(e)}n.value=this.chart.getCurrentChartType().toString();if(!this.settings){this.chart.prepareChartData();this.settings={type:this.chart.getCurrentChartType().toString(),labelColumn:`${this.chart.getLabelColumnIndex()>=0?this.chart.getLabelColumnIndex():""}`,dataColumn:`${this.chart.getDataColumnIndex()>=0?this.chart.getDataColumnIndex():""}`,showLegend:false}}const r=document.createElement("select");r.name="label_column_selector";r.id="label_column_selector";for(const t of this.chart.getPotentialLabelColumns()){const e=document.createElement("option");e.value=t.idx.toString();e.text=t.label;r.appendChild(e)}r.value=this.settings.labelColumn;const h=document.createElement("select");h.id="data_column_selector";h.name="data_column_selector";for(const t of this.chart.getPotentialDataColumns()){const e=document.createElement("option");e.value=t.idx.toString();e.text=t.label;h.appendChild(e)}h.value=this.settings.dataColumn.toString();let o=e;const l=()=>{if(s){return Pt("div",e).addClass("kfrm-field-ie").toDOM()}else{return e}};if(s){Pt(t).addChildElement(l())}else{Pt(e).addChild("div").addChild("div")}o=l();Pt(o).addChild("label",(t=>t.attr("for","chart_type_selector").text(a.getText("Facets","Chart","ChartTypeSelectorLabel")))).addChild("div",(t=>t.addClass("kfrm-select").addChildElement(n)));o=l();Pt(o).addChild("label",(t=>t.attr("for","label_column_selector").text(a.getText("Facets","Chart","LabelColumnSelectorLabel")))).addChild("div",(t=>t.addClass("kfrm-select").addChildElement(r)));o=l();Pt(o).addChild("label",(t=>t.attr("for","data_column_selector").text(a.getText("Facets","Chart","DataColumnSelectorLabel")))).addChild("div",(t=>t.addClass("kfrm-select").addChildElement(h)));o=l();Pt(o).addChild("div").addChild("div",(t=>t.addClass(i).addChild("label",(t=>t.addClass("checkbox").addChild("input",(t=>{t.id("show_legend").type("checkbox");if(this.settings.showLegend)t.attr("checked","")})).addText(" "+a.getText("Facets","Chart","ShowLegendLabel"))))))}afterDialogOpened(t){if(this.getContext().resultTable.columns.getItems().filter((t=>r.isNumericType(t.type))).length<=0){t.showAlert("The dataset should contain at least one numeric column to build a chart","error");t.getSubmitButtonElement().disabled=true}}submitSettingsDialog(){const t=super.submitSettingsDialog();const e=document.getElementById("chart_type_selector");const s=parseInt(e.value);const i=document.getElementById("label_column_selector");const n=parseInt(i.value);const r=document.getElementById("data_column_selector");const h=parseInt(r.value);const o=document.getElementById("show_legend");const l=o.checked;if(t){this.settings={type:s,labelColumn:n,dataColumn:h,showLegend:l};if(this.canDisplay()){this.refresh()}}return t}getSettings(){return this.settings}saveToData(){const t=super.saveToData();if(this.settings){t.chartType=this.settings.type;t.labelCol=this.settings.labelColumn;t.dataCol=this.settings.dataColumn;t.showLeg=this.settings.showLegend}return t}loadFromData(t){super.loadFromData(t);if(t){this.settings={type:t.chartType,dataColumn:t.dataCol,labelColumn:t.labelCol,showLegend:t.showLeg}}}refreshCore(){if(this.chart){if(this.settings){this.chart.updateSettings(this.settings)}this.chart.prepareChartData();this.chart.refresh()}}onResize(){this.refresh()}}var Bs;(function(t){t["Sum"]="SUM";t["Average"]="AVG";t["Min"]="MIN";t["Max"]="MAX";t["Count"]="COUNT"})(Bs||(Bs={}));var Fs;(function(t){t[t["ColumnField"]=0]="ColumnField";t[t["RowField"]=1]="RowField";t[t["CellData"]=2]="CellData"})(Fs||(Fs={}));const Ns=/{0:(.*?)}/g;class Ls extends Ss{constructor(){super(...arguments);this.title=a.getText("Facets","Pivot","FacetTitle");this.dialogTitle=a.getText("Facets","Pivot","DlgTitle");this.pivotTable=new v;this.settings={}}init(t){super.init(t);this.options.maxRowCount=this.options.maxRowCount||500;this.options.viewportRowsCount=this.options.viewportRowsCount||50;this.grid=new he({slot:this.contentDiv,dataTable:this.pivotTable,paging:{enabled:false,pageSize:this.options.maxRowCount},viewportRowsCount:this.options.viewportRowsCount,useRowNumeration:false,showPlusButton:false,allowDragDrop:false,onGetCellRenderer:(t,e)=>{if(t.dataColumn){if(t.dataColumn.id=="total"){return(t,s,i,n)=>{e(t,s,i,n);i.classList.add("pivot-cell-total")}}if(this.settings.totalsRow){const s=this.pivotTable.columns.getIndex(t.dataColumn.id);const i=s===0;if(i){return(t,s,i,n)=>{const r=Number.parseInt(n.getAttribute("data-row-idx"));const h=r===this.pivotTable.getCachedCount()-1;if(h){t=a.getText("Facets","Pivot","TotalGridLabel")}e(t,s,i,n)}}}}}})}getType(){return $s.PivotTable}destroy(){if(this.grid){this.grid.destroy()}}createAggrFuncSelectBuilder(t){const e=this.getContext().getModel();const s=Pt("select");const i=Object.keys(Bs).map((t=>Bs[t]));for(const t of i){s.addChild("option",(s=>{s.attr("value",t).text(e.getAggrFunctionCaption(t))}))}const n=s.toDOM().querySelectorAll("option");if(t!=undefined){n.forEach((e=>{if(e.value==t){e.selected=true}}))}else{n[0].selected=true}return s}createColumnsSelectBuilder(t,e,s){const i=this.getContextDataTable();const n=Pt("select");let h=null;let o=0;for(let e=0;e<i.columns.count;e++){const s=i.columns.get(e);const l=s.label;const a=s.type;const u=s.id;if(t&&t.indexOf(a)<0)continue;if(h===null&&r.isNumericType(a)){h=o}n.addChild("option",(t=>{t.attr("value",u).text(l)}));o++}const l=Array.from(n.toDOM().querySelectorAll("option"));if(l.length>0){if(e!=undefined){for(const t of l){if(t.value==e){n.toDOM().value=t.value;break}}}else{switch(s){case Fs.ColumnField:{n.toDOM().value=l[0].value;break}case Fs.RowField:{n.toDOM().value=l.length>1?l[1].value:l[0].value;break}case Fs.CellData:{n.toDOM().value=h===null?l[0].value:l[h].value;break}}}}return n}renderFormFields(e,s){super.renderFormFields(e,s);const i=this.settings||{totalsRow:true,totalsCol:true};const n=[t.String,t.Date,t.DateTime,t.Int32,t.Int64,t.Word,t.Byte];const r=[t.String,t.Float,t.Int32,t.Int64,t.Word,t.Byte,t.Currency];const h=gt.isIE();let o=s;const l=h?"kfrm-fields-ie is-horizontal":"kfrm-fields is-horizontal";const u=()=>{if(h){return Pt("div",s).addClass("kfrm-field-ie").toDOM()}else{return s}};if(h){Pt(s).addChildElement(u())}else{Pt(s).addChild("div").addChild("div")}o=u();Pt(o).addChild("label",(t=>t.attr("for","column_field").text(a.getText("Facets","Pivot","ColumnFieldSelectorLabel")))).addChild("div",(t=>t.addClass(l).addChild("div",(t=>t.addClass("kfrm-select").attr("name","column_field").addChildElement(this.createColumnsSelectBuilder(n,i.colName,Fs.ColumnField).id("pivotTableColFieldSelector").toDOM()))).addChild("button",(t=>t.addClass("kfrm-button").addClass("eqjs-facets-button-swap").attr("title",a.getText("Facets","Pivot","SwapBtnTitle")).on("click",(()=>{const t=document.getElementById("pivotTableColFieldSelector");const e=document.getElementById("pivotTableRowFieldSelector");const s=t.value;t.value=e.value;e.value=s}))))));o=u();Pt(o).addChild("label",(t=>t.attr("for","row_field").text(a.getText("Facets","Pivot","RowFieldSelectorLabel")))).addChild("div",(t=>t.addClass("kfrm-select").attr("name","row_field").addChildElement(this.createColumnsSelectBuilder(n,i.rowName,Fs.RowField).id("pivotTableRowFieldSelector").toDOM())));o=u();Pt(o).addChild("label",(t=>t.attr("for","data_function").text(a.getText("Facets","Pivot","CellDataSelectorLabel")))).addChild("div",(t=>t.addClass(l).addChild("div",(t=>t.addClass("kfrm-select").attr("name","data_function").addChildElement(this.createAggrFuncSelectBuilder(i.aggrFunc).id("pivotTableAggrFuncSelector").toDOM()))).addChild("label",(t=>t.addText("of  "))).addChild("div",(t=>t.addClass("kfrm-select").attr("name","data_column").addChildElement(this.createColumnsSelectBuilder(r,i.fieldName,Fs.CellData).on("change",(t=>{const e=t.target.value;this.validateSelectedField(e)})).id("pivotTableCellFieldSelector").toDOM())))));o=u();Pt(o).addChild("div").addChild("div",(t=>t.addClass(l).addChild("label",(t=>t.addClass("checkbox").addChild("input",(t=>{t.id("pivotTableHasTotalsRow").type("checkbox");if(i.totalsRow)t.attr("checked","")})).addText(" "+a.getText("Facets","Pivot","TotalsRowLabel")))).addChild("label",(t=>t.addClass("checkbox").addChild("input",(t=>{t.id("pivotTableHasTotalsCol").type("checkbox");if(i.totalsCol)t.attr("checked","")})).addText(" "+a.getText("Facets","Pivot","TotalsColLabel"))))))}afterDialogOpened(t){const e=document.getElementById("pivotTableCellFieldSelector").value;if(e){this.validateSelectedField(e)}if(this.getQuery().getColumns().length<=2){t.showAlert("The dataset should contain at least three columns to build a pivot table","error");t.getSubmitButtonElement().disabled=true}}validateSelectedField(e){const s=this.getContextDataTable();const i=s.columns.getIndex(e);const n=s.columns.get(i);const r=document.getElementById("pivotTableAggrFuncSelector");if(n.type==t.String){r.disabled=true;r.value=Bs.Count}else{r.disabled=false}}submitSettingsDialog(){const t=super.submitSettingsDialog();if(t){this.settings={colName:document.getElementById("pivotTableColFieldSelector").value,rowName:document.getElementById("pivotTableRowFieldSelector").value,aggrFunc:document.getElementById("pivotTableAggrFuncSelector").value,fieldName:document.getElementById("pivotTableCellFieldSelector").value,totalsRow:document.getElementById("pivotTableHasTotalsRow").checked,totalsCol:document.getElementById("pivotTableHasTotalsCol").checked}}return t}saveToData(){const t=super.saveToData();if(this.settings){r.assign(t,this.settings)}return t}loadFromData(t){super.loadFromData(t);if(t){this.settings=r.assign(this.settings,t);if(this.settings.aggrFunc=="AVERAGE"){this.settings.aggrFunc=Bs.Average}}}refreshCore(){this.updatePivotData();if(this.grid){const t=this.pivotTable.getTotal();const e=this.grid.options.paging.pageSize;if(t>e){this.contentDiv.classList.remove("pivot-grid-with-totals");this.showErrorMessage(a.getText("Facets","ErrTooMuchData"))}if(this.options.viewportRowsCount>t){this.grid.options.viewportRowsCount=t}else{this.grid.options.viewportRowsCount=this.options.viewportRowsCount}this.grid.refresh()}}getContextDataTable(){const t=this.getContext();return t.resultTable}updatePivotData(){this.pivotTable.clear();const e=this.getContextDataTable();if(!e||e.getTotal()==0){return}if(!this.settings){return}const s=this.settings.colName;const i=this.settings.rowName;const n=this.settings.fieldName;const h=e.columns.getIndex(s);const o=e.columns.getIndex(i);const l=e.columns.getIndex(n);if(h==undefined||o==undefined||l==undefined){this.showUnableDisplayMessage(a.getText("Facets","ErrQueryChanged"));return}const u=e.columns.get(l);const c=e.columns.get(h);const f=e.columns.get(o);const d=f.label;const m=f.type;const p=c.label;const g=[];const y=[];const b=e.getCachedRows();for(let t=0;t<b.length;t++){const e=b[t].getValue(h);if(g.indexOf(e)<0){g.push(e)}const s=b[t].getValue(o);if(y.indexOf(s)<0){y.push(s)}}this.pivotTable.columns.add({id:d+"\\"+p,label:d+"\\"+p,description:"",type:m,dfmt:f.displayFormat,style:f.style});const v=[];let w=null;if(r.isNumericType(c.type)){w=this.formatNumber}else if(r.getDateDataTypes().indexOf(c.type)>=0){w=this.formatDate}for(let e=0;e<g.length;e++){const s=g[e];if(!s){v.push(e)}else{const e=w?w(c,s):s;this.pivotTable.columns.add({id:s,label:e,description:"",dfmt:u.displayFormat,type:this.settings.aggrFunc!==Bs.Count?u.type:t.Int64,style:u.style})}}let C=[];for(let t=0;t<y.length;t++){C.push([]);C[t].push(y[t])}for(let t=0;t<y.length;t++){for(let e=0;e<g.length;e++){if(v.indexOf(e)>=0)continue;C[t].push(this.calcAggrFunc(this.settings.aggrFunc,{colName:this.settings.colName,rowName:this.settings.rowName,fieldName:this.settings.fieldName,rowValue:y[t],colValue:g[e]}))}}if(this.settings.totalsCol){this.pivotTable.columns.add({id:"total",label:a.getText("Facets","Pivot","TotalGridLabel"),description:"",dfmt:u.displayFormat,type:this.settings.aggrFunc!==Bs.Count?u.type:t.Int64});for(let t=0;t<C.length;t++){const e=C[t];let s=0;if(this.settings.aggrFunc==Bs.Min||this.settings.aggrFunc==Bs.Max){s=e[1]}for(let t=1;t<e.length;t++){const i=e[t];if(i!==null){if(this.settings.aggrFunc===Bs.Min){if(i<s)s=i}else if(this.settings.aggrFunc===Bs.Max){if(i>s)s=i}else{s+=i}}}if(this.settings.aggrFunc===Bs.Average){s/=e.length-1}e.push(s)}}for(const t of C){this.pivotTable.addRow(t)}if(this.settings.totalsRow){let t=[];t.push(null);for(let e=1;e<this.pivotTable.columns.count;e++){const s=this.pivotTable.getCachedRows();let i=0;if(this.settings.aggrFunc==Bs.Min||this.settings.aggrFunc==Bs.Max){i=s[0].getValue(e)}for(let t=0;t<s.length;t++){const n=s[t].getValue(e);if(n!==null){if(this.settings.aggrFunc===Bs.Min){if(n<i)i=n}else if(this.settings.aggrFunc===Bs.Max){if(n>i)i=n}else{i+=n}}}if(this.settings.aggrFunc===Bs.Average){i/=s.length}t.push(i)}this.pivotTable.addRow(t);this.contentDiv.classList.add("pivot-grid-with-totals")}else{this.contentDiv.classList.remove("pivot-grid-with-totals")}}calcAggrFunc(t,e){switch(t){case Bs.Sum:return this.sum(e);case Bs.Average:return this.average(e);case Bs.Min:return this.min(e);case Bs.Max:return this.max(e);case Bs.Count:return this.count(e);default:return 0}}getSettings(){return this.settings}formatDate(e,s){const i=Object.prototype.toString.call(s)==="[object Date]";let n=(s||"").toString();if(i){if(e&&e.displayFormat&&Ns.test(e.displayFormat)){n=e.displayFormat.replace(Ns,((t,i)=>a.dateTimeToStrEx(s,e.type,i)))}else{const i=a.getCurrentLocale();const r={hour:"numeric",minute:"numeric",second:"numeric"};switch(e.type){case t.Date:n=s.toLocaleDateString(i);break;case t.Time:n=s.toLocaleTimeString(i,r);break;case t.DateTime:n=`${s.toLocaleDateString(i)} ${s.toLocaleTimeString(i,r)}`;break}}}return n}formatNumber(t,e){let s=(e||"").toString();if(typeof e=="number"){if(t&&t.displayFormat&&Ns.test(t.displayFormat)){s=t.displayFormat.replace(Ns,((t,s)=>a.numberToStr(e,s)))}else{s=e.toLocaleString()}}return s}sum(t){let e=0;const s=this.getContextDataTable();const i=s.getCachedRows();for(let s=0;s<i.length;s++){const n=i[s].getValue(t.rowName);const r=i[s].getValue(t.colName);if(n!==t.rowValue||r!==t.colValue){continue}const h=i[s].getValue(t.fieldName);e+=h}return e}average(t){let e=0;let s=0;const i=this.getContextDataTable();const n=i.getCachedRows();for(let i=0;i<n.length;i++){const r=n[i].getValue(t.rowName);const h=n[i].getValue(t.colName);if(r!==t.rowValue||h!==t.colValue){continue}const o=n[i].getValue(t.fieldName);e+=o;s++}if(s!=0)e=e/s;return e}min(t){let e=Number.MAX_SAFE_INTEGER;const s=this.getContextDataTable();const i=s.getCachedRows();for(let s=0;s<i.length;s++){const n=i[s].getValue(t.rowName);const r=i[s].getValue(t.colName);if(n!==t.rowValue||r!==t.colValue){continue}const h=i[s].getValue(t.fieldName);if(h<e){e=h}}if(e==Number.MAX_SAFE_INTEGER)return null;return e}max(t){let e=Number.MIN_SAFE_INTEGER;const s=this.getContextDataTable();const i=s.getCachedRows();for(let s=0;s<i.length;s++){const n=i[s].getValue(t.rowName);const r=i[s].getValue(t.colName);if(n!==t.rowValue||r!==t.colValue){continue}const h=i[s].getValue(t.fieldName);if(h>e){e=h}}if(e==Number.MIN_SAFE_INTEGER)return null;return e}count(t){const e=this.getContextDataTable();let s=0;const i=e.getCachedRows();for(let e=0;e<i.length;e++){const n=i[e].getValue(t.rowName);const r=i[e].getValue(t.colName);if(n!==t.rowValue||r!==t.colValue){continue}s++}return s}}class Rs extends Ss{constructor(){super(...arguments);this.grid=null;this.title=a.getText("Facets","DataTable","FacetTitle");this.dialogTitle=a.getText("Facets","DataTable","DlgTitle")}init(t){super.init(t);this.reinitGrid()}getSettings(){return this.settings}reinitGrid(){if(this.grid)this.grid.destroy();const t=this.container.options||{};if(t.gridResolver){this.grid=t.gridResolver(this.contentDiv,this.getType())}if(this.grid==null){this.grid=new Cs(this.contentDiv)}t.grid=t.grid||{};t.grid.autoRefresh=false;t.grid.addColumns=false;const e=this.getContext();t.grid.totals=this.settings;this.grid.init(e,t.grid)}getType(){return $s.DataGrid}canDisplay(){return true}refreshCore(){if(!this.grid)return;this.grid.refresh()}destroy(){if(this.grid){this.grid.destroy()}}}class Ps extends mt{constructor(t){super(t);this.facets=[];this.options={};this.group=it.Result}destroyCore(){for(const t of this.facets){t.destroy()}this.clear()}createFacetTab(t){const e=this.options[t];switch(t){case $s.Chart:return new Ms(this,e);case $s.PivotTable:return new Ls(this,e);default:return new Rs(this,e)}}getQuery(){return this.getContext().getQuery()}}class Os{constructor(t){this.context=t;this.promise=null}show(t=null){if(!this.promise){const e=this.context.getExportFormats();if(e.length==0)throw Error("No exporter has been registered.");t=t||e[0];this.promise=new Promise(((e,s)=>{const i=this.context.getServices().getService("DialogService");const n=Pt("div").addClass("kdlg-form-section").addChild("div",(e=>e.addClass("kfrm-form").addChild("div",(e=>e.addClass("kfrm-fields col-a-1 label-align-right").addChild("label",(t=>t.addClass("kdlg-form-label","kflex-20").attr("for","export_format").addText(a.getText("ExportDlgFmtLabel")))).addChild("div",(e=>e.addClass("kfrm-select").addChild("select",(e=>{e.attr("name","export_format").id("exportFormat");for(const s of this.context.getExportFormats()){e.addOption({value:s,title:a.getText(s)||s,selected:t==s})}})))))))).toDOM();i.open({title:a.getText("ExportDlgTitle"),body:n,onSubmit:()=>{const t=n.querySelector("#exportFormat").value;this.context.exportResult({format:t,success:e,error:s});return true}})}))}return this.promise.finally((()=>this.promise=null))}}class Qs extends Ps{constructor(t){super(t);this.activeFacetIndex=-1;this.firstRender=true;this.options={showExportButton:true,showRefreshButton:true,showMaximizeButton:true,maximize2Window:false,showProcessIndicator:true,facetTypes:[$s.DataGrid,$s.Chart,$s.PivotTable]};this.menuItems=[{id:$s.DataGrid,text:a.getText("Facets","AddMenuItems","DataTable")},{id:$s.Chart,text:a.getText("Facets","AddMenuItems","Chart")},{id:$s.PivotTable,text:a.getText("Facets","AddMenuItems","Pivot")}];this.menuItemsFilter=t=>{if(this.options.facetTypes.indexOf(t.id)<0)return false;if(t.id===$s.DataGrid){return this.facets.filter((t=>t.getType()==$s.DataGrid)).length===0}return true};if(!this.slot.classList.contains(`${this.cssPrefix}-panel`)){this.slot.classList.add(`${this.cssPrefix}-panel`)}this.renderProcessBlock()}get cssPrefix(){return"eqjs-facets"}getWidgetType(){return"facetsPanel"}init(t,e){super.init(t,e);this.setOptions(e);this.destroyCore();this.attachQueryObserver();this.loadFacets()}attachQueryObserver(){const t=this.getQuery();if(this.queryEventCallbackId){t.removeChangedCallback(this.queryEventCallbackId)}this.queryEventCallbackId=t.addChangedCallback((t=>{const e=t.data;if(e.part!=P.All){return}if(e.source==this){return}this.reloadFacets();this.refreshCore(true)}))}refreshCore(t=false){if(this.firstRender||t){this.clear();this.createAddMenu();this.render()}this.validateAddFacetButton();this.renderActiveFacet();this.updateTotalRecords()}createAddMenu(){this.addMenu=new Me({items:this.menuItems,id:"FacetType-List"})}updateTotalRecords(){const t=this.getContext();const e=t.resultTable.getTotal();this.recordsDiv.innerHTML=a.getText("Facets","TotalRecordsLabel")+" "+e;if(e==0){Pt(this.exportDiv).hide()}else{Pt(this.exportDiv).show()}}renderProcessBlock(){const t='<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>';this._processBlock=Pt("div").addClass(`${this.cssPrefix}-spinner`).addChild("div",(e=>e.addClass(`${$e}-progress-win8`,Se()).addHtml(t))).toDOM()}onProcessStartCore(){if(this.options.showProcessIndicator){if(!this._processBlock.parentNode&&this.bodyDiv){this.bodyDiv.childNodes.forEach((t=>{Pt(t).hide()}));this.bodyDiv.appendChild(this._processBlock)}}}onProcessEndCore(){if(this.options.showProcessIndicator){if(this._processBlock.parentNode){try{this._processBlock.parentNode.removeChild(this._processBlock)}catch(t){}finally{this.renderActiveFacet(false)}}}}render(){this.firstRender=false;this.headerDiv=Pt("div",this.slot).addClass(`${this.cssPrefix}-header`).toDOM();this.tabsDiv=Pt("div",this.headerDiv).addClass(`${this.cssPrefix}-tabs`).toDOM();this.tabsUl=Pt("ul",this.tabsDiv).addClass(`${this.cssPrefix}-nav-tabs`).toDOM();this.bodyDiv=Pt("div",this.slot).addClass(`${this.cssPrefix}-body`).toDOM();for(const t of this.facets){this.renderFacet(t)}Pt(this.tabsDiv).addChild("div",(t=>this.addFacetButton=t.addClass(`${this.cssPrefix}-add-button`).title(a.getText("Facets","NewFacetTitle")).addChild("a",(t=>t.attr("href","javascript:void(0)"))).on("click",(t=>this.addClickHandler(t))).toDOM()));const t=Pt("div",this.headerDiv).addClass(`${this.cssPrefix}-manage`).toDOM();this.recordsDiv=Pt("div",t).addClass(`${this.cssPrefix}-total-recs`).toDOM();if(this.options.showRefreshButton||this.options.showExportButton||this.options.showMaximizeButton){const e=Pt("div",t).addClass(`${this.cssPrefix}-total-buttons`).toDOM();if(this.options.showExportButton){this.exportDiv=Pt("button",e).on("click",(()=>this.exportHandler())).addClass(`${this.cssPrefix}-button`).addClass(`${this.cssPrefix}-button-export`).title(a.getText("Facets","ExportBtnTitle")).toDOM()}if(this.options.showRefreshButton){Pt("button",e).on("click",(()=>this.refreshHandler())).addClass(`${this.cssPrefix}-button`).addClass(`${this.cssPrefix}-button-refresh`).title(a.getText("Facets","RefreshBtnTitle"))}if(this.options.showMaximizeButton){this.maximizeButton=Pt("button",e).on("click",(()=>this.options.maximize2Window?this.maximizeHandler(true):this.maximizeHandler())).addClass(`${this.cssPrefix}-button`).addClass(`${this.cssPrefix}-button-maximize`).title(a.getText("Facets","MaximizeBtnTitle")).toDOM()}}}refreshHandler(){const t=this.getContext();t.fetchData({success:()=>{t.refreshWidgets(it.Result)}})}exportHandler(){const t=this.getContext();new Os(t).show()}maximizeHandler(t){let e=Pt(this.slot);if(t){e.toggleClass(`${$e}-maximized-2window`);if(this.slot.classList.contains(`${$e}-maximized-2window`)){this.maximizeButton.title=a.getText("Facets","RestoreBtnTitle");this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-maximize`,false);this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-restore`,true)}else{this.maximizeButton.title=a.getText("Facets","MaximizeBtnTitle");this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-restore`,false);this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-maximize`,true)}}else{const t=!this.slot.hasAttribute("data-is-maximized");if(t){this.slot.setAttribute("data-is-maximized","");this.maximizeButton.title=a.getText("Facets","RestoreBtnTitle");this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-maximize`,false);this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-restore`,true)}else{this.slot.removeAttribute("data-is-maximized");this.maximizeButton.title=a.getText("Facets","MaximizeBtnTitle");this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-restore`,false);this.maximizeButton.classList.toggle(`${this.cssPrefix}-button-maximize`,true)}const e=document.querySelectorAll("[data-hide-on-max]");e.forEach((e=>{if(t){e.setAttribute("style","display: none;")}else{e.removeAttribute("style")}}))}this.facets.forEach((t=>t.onResize()))}renderActiveFacet(t=true){this.tabsUl.querySelectorAll("li").forEach(((t,e)=>{if(t.classList.contains("active")){t.classList.remove("active")}if(this.activeFacetIndex===e){t.classList.add("active")}}));this.bodyDiv.querySelectorAll(`.${$e}-facet`).forEach(((e,s)=>{Pt(e).hide();if(this.activeFacetIndex===s){Pt(e).show();if(t){this.facets[s].refresh()}}}))}renderFacet(t){this.renderFacetTab(t);const e=this.renderFacetSlot(t);t.init(e)}renderFacetTab(t){return Pt("li",this.tabsUl).addChild("span",(e=>e.addClass(`${$e}-facet-settings`).on("click",(e=>{e.stopPropagation();this.settingsClickHandler(t)})))).addChild("a",(e=>e.addText(t.title).attr("href","javascript:void(0)"))).addChild("span",(e=>e.addClass(`${$e}-facet-close`).on("click",(e=>{e.stopPropagation();this.closeClickHandler(t)})))).on("click",(e=>this.selectClickHandler(t))).toDOM()}renderFacetSlot(t){let e=Pt("div",this.bodyDiv).addClass(`${$e}-facet`).hide().toDOM();return e}refreshFacetTabs(){this.tabsUl.querySelectorAll("li").forEach((t=>{this.tabsUl.removeChild(t)}));for(const t of this.facets){this.renderFacetTab(t)}}removeFacet(t){const e=this.facets.indexOf(t);if(e>=0){this.facets.splice(e,1);const t=this.tabsUl.childNodes[e];this.tabsUl.removeChild(t);const s=this.bodyDiv.childNodes[e];this.bodyDiv.removeChild(s);if(this.facets.length>0){this.activeFacetIndex=e<this.facets.length?e:this.facets.length-1}else{this.activeFacetIndex=-1}this.renderActiveFacet();this.validateAddFacetButton()}}addClickHandler(t){this.addMenu.showMenu({anchor:t.target,itemFilterCallback:this.menuItemsFilter,itemSelectedCallback:t=>{const e=this.createFacetTab(t.id);const s=this.renderFacetSlot(e);e.init(s);e.showSettingsDialog().then((t=>{if(t){this.facets.push(e);this.activeFacetIndex=this.facets.length-1;this.renderFacetTab(e);this.renderActiveFacet();this.saveFacets()}else{this.bodyDiv.removeChild(s)}})).catch((t=>console.error(t)))}})}selectClickHandler(t){const e=this.facets.indexOf(t);this.setActiveFacet(e)}settingsClickHandler(t){t.showSettingsDialog().then((t=>{if(t){this.refreshFacetTabs();this.renderActiveFacet();this.saveFacets()}})).catch((t=>console.error(t)))}closeClickHandler(t){const e=this.getDialogService();e.openConfirm(a.getText("Facets","RemoveFacetDlgTitle"),a.getText("Facets","RemoveFacetDlgContent").replace("{facetTitle}",t.title)).then((e=>{if(e){this.removeFacet(t);this.saveFacets()}})).catch((t=>console.error(t)))}clear(){this.firstRender=true;this.slot.innerHTML=""}createDefaultFacetIfNotExist(){if(this.facets.length===0){const t=this.createFacetTab($s.DataGrid);this.facets.push(t);this.activeFacetIndex=0}}validateAddFacetButton(){this.addFacetButton.hidden=this.addMenu.getItems().filter(this.menuItemsFilter).length==0}setActiveFacet(t){if(this.activeFacetIndex!=t){this.activeFacetIndex=t;this.renderActiveFacet();this.saveFacets(true)}}setOptions(t){r.assignDeep(this.options,t)}getDialogService(){return this.getContext().getServices().getService("DialogService")}saveFacets(t=false){const e=this.getQuery();e.innerData=e.innerData||{};e.innerData.facets={active:this.activeFacetIndex,items:this.facets.map((t=>t.saveToData()))};e.fireChangedEvent({part:P.Facets,action:t?O.Activate:O.All,source:this})}reloadFacets(){for(const t of this.facets){t.destroy()}this.loadFacets()}loadFacets(){const t=this.getQuery();this.facets=[];if(t.innerData&&t.innerData.facets){const e=t.innerData.facets.items;for(const t of e){const e=this.createFacetTab(t.type);e.loadFromData(t);this.facets.push(e)}const s=t.innerData.facets.active;this.activeFacetIndex=s>=0?s:this.facets.length-1}else{this.createDefaultFacetIfNotExist()}}}class qs extends mt{getWidgetType(){return"exportWidget"}constructor(t){super(t);this.options={defFormat:"csv",enableExport:true};this.clickHandler=t=>{if(!this.slot.hasAttribute("disabled"))new Os(this.context).show(this.options.defFormat)};this.group=it.All}init(t,e){super.init(t,e);this.options=r.assignDeep(this.options,e);this.slot.addEventListener("click",this.clickHandler)}refreshCore(){if(this.options.enableExport&&this.context.resultTable&&this.context.resultTable.getCachedCount()>0){this.slot.removeAttribute("disabled")}else{this.slot.setAttribute("disabled","")}}destroyCore(){this.slot.removeAttribute("disabled");this.slot.removeEventListener("click",this.clickHandler)}}class js{get cssPrefix(){return"eqjs-as"}constructor(t){this.selectState={columns:[]};this.funcMap={};if(!t||!t.slot)throw new Error("slot is required");if(!t||!t.query)throw new Error("query is required");this.slot=t.slot;this.query=t.query;this.onChanged=t.onChanged;this.dropSelectState();this.dropState()}render(){this.createFunctionMenu();this.setInitialState();this.changed()}setInitialState(){const t=this.query.getAggregationSettings();const e=t.getInternalGroups();const s=t.getAggregates();for(const t of e){this.state.groups.push({columns:t.columns})}for(const t of s){this.state.aggregates.push({colId:t.colId,funcId:t.funcId})}this.state.grandTotals=t.hasGrandTotals();this.state.recordCount=t.hasRecordCount()}getAvailableColumns(){return this.query.getColumns().filter((t=>t.enabled))}renderCore(){this.slot.innerHTML="";const t=this.getAvailableColumns();const e=Pt(this.slot);let s=null;let i=null;let n=null;const r=this.state.aggregates;let h=-1;for(const o of t){if(s){if(s.columns.indexOf(o.id)>=0){this.renderColumn(i,o,true);continue}}s=this.getGroupForColumn(o.id);if(s!=null){h++;const t=Pt("div",this.slot).addClass(`${this.cssPrefix}-group`).data("gindex",`${h}`);i=Pt("div",t.toDOM()).addClass(`${this.cssPrefix}-columns`);this.renderColumn(i,o,true);continue}const t=r.filter((t=>t.colId==o.id))[0];if(t){const e=Pt("div",this.slot).addClass(`${this.cssPrefix}-aggr`);this.renderColumn(e,o,true,t.funcId);e.addChild("div",(t=>t.addClass(`${this.cssPrefix}-buttons`).addChild("button",(t=>t.addClass(`${this.cssPrefix}-unaggr-btn`).title(a.getText("AggrSettings","UnaggrBtn")).on("click",this.removeAggrBtnClickHandler.bind(this))))));continue}if(this.selectState.columns.indexOf(o.id)>=0){if(n==null){const t=Pt("div",this.slot).addClass(`${this.cssPrefix}-selected`);n=Pt("div",t.toDOM()).addClass(`${this.cssPrefix}-columns`)}this.renderColumn(n,o,false);continue}this.renderColumn(e,o,false)}if(n){const t=Pt("div",n.toDOM().parentElement).addClass(`${this.cssPrefix}-buttons`);t.addChild("button",(t=>t.addClass(`${this.cssPrefix}-group-btn`).title(a.getText("AggrSettings","GroupBtn")).on("click",this.groupBtnClickHandler.bind(this))));if(this.selectState.columns.length==1){t.addChild("button",(t=>t.addClass(`${this.cssPrefix}-aggr-btn`).title(a.getText("AggrSettings","AggrBtn")).on("click",this.aggrBtnClickHandler.bind(this))))}}Pt(this.slot).addChild("div",(t=>t.addClass(`${this.cssPrefix}-counts`).addChild("label",(t=>t.addClass("eqjs-ctrl-switch").addChild("input",(t=>{t.attr("type","checkbox");if(this.state.recordCount){t.attr("checked","")}t.on("change",this.countsCheckboxChangeHandler.bind(this))})).addChild("span",(t=>t.addClass("slider round"))).addChild("span",(t=>t.addClass("switch-text").addText(a.getText("AggrSettings","GroupCountsLabel")))))))).addChild("div",(t=>t.addClass(`${this.cssPrefix}-grandtotals`).addChild("label",(t=>t.addClass("eqjs-ctrl-switch").addChild("input",(t=>{t.attr("type","checkbox");if(this.state.grandTotals){t.attr("checked","")}t.on("change",this.grandCheckboxChangeHandler.bind(this))})).addChild("span",(t=>t.addClass("slider round"))).addChild("span",(t=>t.addClass("switch-text").addText(a.getText("AggrSettings","GrandTotalsLabel"))))))));const o=this.slot.querySelectorAll(`.${this.cssPrefix}-group`);o.forEach((t=>{Pt(t).addChild("div",(t=>t.addClass(`${this.cssPrefix}-buttons`).addChild("button",(t=>t.addClass(`${this.cssPrefix}-ungroup-btn`).title(a.getText("AggrSettings","UngroupBtn")).on("click",this.removeGroupBtnClickHandler.bind(this))))))}));this.validateCheckboxes()}validateCheckboxes(){if(this.selectState.columns.length===0)return;let t,e,s=null;for(let i=0;i<this.slot.childNodes.length;i++){const n=this.slot.childNodes[i];if(n.classList.contains(`${this.cssPrefix}-selected`)){if(t&&t.classList.contains(`${this.cssPrefix}-column`)){e=t}}else if(n.classList.contains(`${this.cssPrefix}-column`)){if(t&&t.classList.contains(`${this.cssPrefix}-selected`)){s=n}}t=n}for(let t=0;t<this.slot.childNodes.length;t++){const i=this.slot.childNodes[t];if(i.classList.contains(`${this.cssPrefix}-column`)&&i!=e&&i!=s){i.firstElementChild.firstElementChild.setAttribute("disabled","")}}const i=`.${this.cssPrefix}-selected>.${this.cssPrefix}-columns>.${this.cssPrefix}-column`;const n=this.slot.querySelectorAll(i);for(let t=1;t<n.length-1;t++){const e=n[t];e.firstElementChild.firstElementChild.setAttribute("disabled","")}}isValid(){const t=this.selectState.columns.length;const e=this.state.aggregates.length>0;const s=this.state.groups.length>0;const i=this.state.grandTotals;const n=this.state.recordCount;if(t)return false;if(s){return e||n}if(e){return s||i}return false}getValidationMessage(){const t=this.selectState.columns.length;const e=this.state.aggregates.length>0;const s=this.state.groups.length>0;const i=this.state.grandTotals;const n=this.state.recordCount;if(t)return`${a.getText("AggrSettings","SelectedError")} `;if(s&&!e&&!n)return`${a.getText("AggrSettings","NoAggrOrCountError")} `;if(e&&!s&&!i)return`${a.getText("AggrSettings","NoGroupsOrGrandError")} `;return`${a.getText("AggrSettings","NoGroupsOrAggrError")} `}getSettings(){const t=new m(this.query);for(const e of this.state.groups){t.addGroup({columns:e.columns})}for(const e of this.state.aggregates){t.addAggregateColumn(e.colId,e.funcId)}if(this.state.grandTotals){t.addGrandTotals()}if(this.state.recordCount){t.addCounts()}return t}renderColumn(t,e,s,i=null){t.addChild("div",(t=>{t.data("colid",e.id);const n=i?`${e.caption} (${this.funcMap[i].caption})`:e.caption;if(!s){t.addClass(`${this.cssPrefix}-column`).addChild("label",(t=>t.addClass("checkbox").addChild("input",(t=>{t.attr("type","checkbox");if(this.selectState.columns.indexOf(e.id)>=0){t.attr("checked","")}t.on("change",this.colCheckboxChangeHandler.bind(this))})).addText(n)))}else{t.addClass(`${this.cssPrefix}-column-used`).addText(n)}}))}getGroupForColumn(t){const e=this.getGroupIndexForColumn(t);if(e>=0)return this.state.groups[e];return null}getGroupIndexForColumn(t){for(var e=0;e<this.state.groups.length;e++){const s=this.state.groups[e];if(s.columns.indexOf(t)>=0)return e}return-1}grandCheckboxChangeHandler(t){this.state.grandTotals=!this.state.grandTotals;this.onChanged&&this.onChanged()}countsCheckboxChangeHandler(t){this.state.recordCount=!this.state.recordCount;this.onChanged&&this.onChanged()}colCheckboxChangeHandler(t){const e=t.target;const s=e.parentElement.parentElement.getAttribute("data-colid");const i=this.selectState.columns.indexOf(s);if(i>=0){this.selectState.columns.splice(i,1)}else{this.selectState.columns.push(s);const t=this.getAvailableColumns();this.selectState.columns=this.selectState.columns.sort(((e,s)=>{const i=t.findIndex((t=>t.id==e));const n=t.findIndex((t=>t.id==s));return i-n}))}this.changed()}groupBtnClickHandler(){this.state.groups.push({columns:this.selectState.columns});const t=this.getAvailableColumns();this.state.groups=this.state.groups.sort(((e,s)=>{const i=t.findIndex((t=>t.id==e.columns[0]));const n=t.findIndex((t=>t.id==s.columns[0]));return i-n}));this.dropSelectState();this.changed()}removeGroupBtnClickHandler(t){const e=t.target;const s=Number.parseInt(e.parentElement.parentElement.getAttribute("data-gindex"));this.state.groups.splice(s,1);this.changed()}removeAggrBtnClickHandler(t){const e=t.target;const s=e.parentElement.parentElement.querySelector(`.${this.cssPrefix}-column-used`).getAttribute("data-colid");const i=this.state.aggregates.findIndex((t=>t.colId==s));if(i>=0){this.state.aggregates.splice(i,1);this.changed()}}aggrBtnClickHandler(t){this.query.getModel();const e=this.selectState.columns[0];const s=this.getAvailableColumns().filter((t=>t.id==e))[0];this.functionMenu.showMenu({anchor:t.target,itemFilterCallback:t=>this.funcMap[t.id].appliedTypes.indexOf(s.expr.dataType)>=0,itemSelectedCallback:t=>{this.state.aggregates.push({colId:e,funcId:t.id});this.dropSelectState();this.changed()}})}clear(){this.dropSelectState();this.dropState();this.changed()}dropSelectState(){this.selectState={columns:[]}}dropState(){this.state={groups:[],aggregates:[],recordCount:true,grandTotals:false}}changed(){this.onChanged&&this.onChanged();this.renderCore()}createFunctionMenu(){const t=this.query.getModel();const e=this.query.getModel().getAggrFunctions();const s=[];for(const i of e){if(!i||i.id=="MIN"||i.id=="MAX"||i.id=="CNTDST")continue;this.funcMap[i.id]=i;const e=t.getAggrFunctionCaption(i.id);const n={id:i.id,text:e};s.push(n)}let i=this.slot.id;if(i){i+="-FunctionsMenu"}const n={items:s,id:i,searchBoxAlwaysShown:false,domWriteItemsId:true};this.functionMenu=new Me(n)}}class _s{constructor(t){this.context=t;this.promise=null}show(t){const e=t||this.context.getQuery();this.query=this.context.createQuery();this.query.loadFromData(e.toJSONData());if(!this.promise){this.promise=new Promise(((t,s)=>{const i=this.context.getServices().getService("DialogService");this.body=this.renderBody();var n=i.open({title:a.getText("AggrSettings","AggrDialogTitle"),body:this.body,onSubmit:()=>{if(this.query.enableAggregation&&!this.renderer.isValid())return false;e.enableAggregation=this.query.enableAggregation;if(e.enableAggregation){e.useAggregation((t=>{const e=this.renderer.getSettings();t.loadFromData(e.saveToData())}))}e.fireChangedEvent({part:P.Aggregation,wasModified:false});t();return true},onCancel:()=>{t()}});this.renderer=new js({slot:this.body.querySelector("#AggrSettingsComponent"),query:this.query,onChanged:()=>{n.clearAlert();const t=this.renderer.isValid();if(!t){const t=this.renderer.getValidationMessage();n.showAlert(t,"warning")}const e=n.getRootElement().querySelector(".kfrm-button.is-info");e.disabled=!t&&this.query.enableAggregation}});if(this.query.enableAggregation){this.renderer.render()}}))}return this.promise.catch((t=>console.error(t))).finally((()=>this.promise=null))}renderBody(){const t=Pt("div").addChild("div",(t=>t.addClass(`eqjs-as-enableaggr`).addChild("label",(t=>t.addClass("eqjs-ctrl-switch").addChild("input",(t=>{t.attr("type","checkbox");if(this.query.enableAggregation){t.attr("checked","")}t.on("change",this.enableAggrCheckBoxChangeHandler.bind(this))})).addChild("span",(t=>t.addClass("slider round"))).addChild("span",(t=>t.addClass("switch-text").addText(a.getText("AggrSettings","EnableAggrLabel")))))))).addChild("div",(t=>t.id("AggrSettingsComponent")));return t.toDOM()}enableAggrCheckBoxChangeHandler(t){this.query.enableAggregation=!this.query.enableAggregation;this.body.querySelector("#AggrSettingsComponent").innerHTML="";if(this.query.enableAggregation){this.renderer.render()}else{const t=this.body?this.body.closest(".kdlg-modal").querySelector("footer .kfrm-button.is-info"):null;if(t){t.disabled=false}}}}class Gs extends mt{constructor(t,e){super(t);this.linkClickCallback=()=>{new _s(this.context).show(this.getQuery())};this.queryEventCallbackId=null;this.customQuery=e;this.group=it.Query|it.QueryStatus}init(t,e){super.init(t,e);this.destroyCore();this.attachQueryObserver()}get cssPrefix(){return"eqjs-aggrb"}getWidgetType(){return"aggregationBar"}refreshCore(){this.render()}getLinkText(){const t=this.getQuery();if(t.enableAggregation){const e=t.getAggregationSettings();const s=e.getInternalGroups();const i=e.getAggregates();let n=[];const r=t.getColumns();for(const t of s){const e=t.columns.map((t=>{const e=r.find((e=>e.id==t));if(e){return e.caption}else{return""}}));n.push(`[${e.join(", ")}]`)}const h=n.join(", ");let o=[];const l=t.getModel().getAggrFunctions();for(const t of i){const e=r.find((e=>e.id==t.colId));const s=l.find((e=>e.id==t.funcId));if(e&&s){o.push(`${e.caption} (${s.caption})`)}}const u=o.join(", ");return`${h||a.getText("AggrSettings","NoGroupsLabel")} ::: ${u?`<${u}>`:a.getText("AggrSettings","NoAggrsLabel")}`}else{return a.getText("AggrSettings","EmptySettingsLabel")}}render(){this.slot.classList.add(`${this.cssPrefix}-panel`);const t=Se();if(t){this.slot.classList.add(t)}if(!this.dialogLink){this.dialogLink=document.createElement("a");this.dialogLink.setAttribute("href","javascript:void(0)");this.slot.appendChild(this.dialogLink)}this.dialogLink.textContent=this.getLinkText();this.dialogLink.removeEventListener("click",this.linkClickCallback);this.dialogLink.addEventListener("click",this.linkClickCallback)}clear(){this.slot.innerHTML="";this.dialogLink=null}attachQueryObserver(){const t=this.getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{this.refreshCore()}))}detachQueryObserver(){if(this.queryEventCallbackId){const t=this.getQuery();t.removeChangedCallback(this.queryEventCallbackId)}}destroyCore(){this.clear();this.detachQueryObserver()}getQuery(){return this.customQuery||this.context.getQuery()}}class Hs extends mt{constructor(t){super(t);this.changeLocale=()=>{const t=this.selectEl.value;a.setCurrentLocale(t);this.context.refreshWidgets(it.All)};this.group=it.None}init(t,e){super.init(t,e);this.clear();this.render()}getWidgetType(){return"changeLocale"}render(){const t=a.getLocales();if(t.length>1){this.selectEl=document.createElement("select");for(let e of t){let t=document.createElement("option");t.value=e.locale;t.innerHTML=this.displayLocaleName(e);this.selectEl.appendChild(t)}this.selectEl.value=a.getCurrentLocale();this.selectEl.classList.add("eqv-select");this.selectEl.addEventListener("change",this.changeLocale);this.slot.appendChild(this.selectEl)}}displayLocaleName(t){if(t.englishName&&t.displayName){return`${t.englishName} - ${t.displayName}`}else if(t.englishName){return t.englishName}else if(t.displayName){return t.displayName}return t.locale}clear(){this.slot.innerHTML=""}destroyCore(){this.clear()}}class Ws extends mt{constructor(t){super(t);this.queryEventCallbackId=null;this.group=it.Query|it.QueryStatus;this.nameTemplate="{name}"}init(t,e){super.init(t,e);if(e&&e.nameTemplate){this.nameTemplate=e.nameTemplate}this.destroyCore();this.attachQueryObserver()}get cssPrefix(){return"eqjs-query-name"}getWidgetType(){return"queryName"}refreshCore(){this.render()}render(){this.slot.classList.add(`${this.cssPrefix}`);const t=Se();if(t){this.slot.classList.add(t)}if(!this.nameSlot){this.nameSlot=document.createElement("div");this.nameSlot.classList.add(`${this.cssPrefix}-text`);this.nameSlot.classList.add(`${this.cssPrefix}-theme`);this.slot.appendChild(this.nameSlot)}if(!this.asteriskSlot){this.asteriskSlot=document.createElement("span");this.asteriskSlot.innerHTML="*";this.asteriskSlot.classList.add(`${this.cssPrefix}-asterisk`);this.slot.appendChild(this.asteriskSlot)}if(!this.tooltipSlot){this.tooltipSlot=document.createElement("span");this.tooltipSlot.classList.add(`${this.cssPrefix}-tooltip`);this.tooltipSlot.classList.add(`${this.cssPrefix}-theme`);this.slot.appendChild(this.tooltipSlot)}const e=this.context.getQuery();const s=e.getName();const i=e.getDescription()||"";const n=this.nameTemplate.replace("{name}",s).replace("{description}",i);this.nameSlot.textContent=n;this.tooltipSlot.textContent=n;this.asteriskSlot.style.visibility=e.isModified()?"visible":"hidden"}clear(){this.slot.innerHTML="";this.nameSlot=null;this.tooltipSlot=null;this.asteriskSlot=null}attachQueryObserver(){const t=this.context.getQuery();this.queryEventCallbackId=t.addChangedCallback((t=>{this.refreshCore()}))}detachQueryObserver(){if(this.queryEventCallbackId){const t=this.context.getQuery();t.removeChangedCallback(this.queryEventCallbackId)}}destroyCore(){this.clear();this.detachQueryObserver()}}class Us{constructor(){this.domRoots=[document];this.defaultViewOptions={enableExport:true,disableConfirmationOnQueryChange:false,queryFileExtensions:"text/xml,application/json",result:{clearResultOnQueryChange:true,showChart:true,showProcessIndicator:true},widgets:{resultGrid:{addColumns:false}},handlers:{}};this.viewOptions={};this.resultOptions={};this.enableExport=false;this.services=st.getInstance();this.resetContext();this.renderSpinner()}resetContext(){this.context=ft()}getDialogService(){return this.services.getService("DialogService")}init(t){try{this.context.initStart();if(t&&t.shadowRoots)this.domRoots=this.domRoots.concat(t.shadowRoots);this.viewOptions=this.initOptions(t);this.resultOptions=r.assignDeep(this.defaultViewOptions.result,this.viewOptions.result);this.initWidgets(this.viewOptions);this.context.init(this.viewOptions);this.initDone()}catch(t){this.context.throwError({action:"Init",sourceError:t})}}initOptions(t){t=r.assignDeep(this.defaultViewOptions,t);if(!t.widgets.easyGrid){t.widgets.easyGrid=t.widgets.resultGrid||{}}if(t.columnTitleFormat){this.context.options.columnTitleFormat=t.columnTitleFormat}t.widgets.easyGrid.paging=r.assignDeep({},t.result.paging,t.widgets.easyGrid.paging);this.enableExport=t.enableExport||false;if(!t.widgets.exportWidget){t.widgets.exportWidget={}}t.widgets.exportWidget.enableExport=this.enableExport;return t}initWidgets(t){let e="QueryPanel";let s="ColumnsPanel";let i="EntitiesPanel";let n="ResultPanel";let r="ColumnsBar";let h="SortingBar";let o="FilterBar";let l="ProcessBar";let a="StatementPanel";let u="ChangeLocale";let c="QueryNameLabel";let f="ResultFacetsPanel";let d="ResultCount";let m="ExportButton";let p="AggregationBar";if(t.slots){c=t.slots.queryNameLabel||c;e=t.slots.queryPanel||e;s=t.slots.columnsPanel||s;r=t.slots.columnsBar||r;i=t.slots.entitiesPanel||i;n=t.slots.resultPanel||n;a=t.slots.statementPanel||a;l=t.slots.processBar||l;u=t.slots.changeLocale||u;f=t.slots.facetsPanel||f;d=t.slots.resultCountSpan||d;o=t.slots.filterBar||o;m=t.slots.exportButtons||m;p=t.slots.aggregationBar||p}const g=this.resolveElement(i);if(g&&!this.entitiesPanelWidget){this.entitiesPanelWidget=this.createEntitiesPanelWidget(g);this.context.addWidget(this.entitiesPanelWidget)}const y=this.resolveElement(s);if(y&&!this.columnsPanelWidget){this.columnsPanelWidget=this.createColumnsPanelWidget(y);this.context.addWidget(this.columnsPanelWidget)}const b=this.resolveElement(r);if(b&&!this.columnsBarWidget){this.columnsBarWidget=this.createColumnsBarWidget(b);this.context.addWidget(this.columnsBarWidget)}const v=this.resolveElement(e);if(v&&!this.queryPanelWidget){this.queryPanelWidget=this.createQueryPanelWidget(v);this.context.addWidget(this.queryPanelWidget)}this.resultPanelSlot=this.resolveElement(n);if(this.resultPanelSlot){if(!this.resultGridWidget){let t=yt(this.resultPanelSlot,"div",{cssClass:"eqv-result-grid"});this.resultGridWidget=this.createResultGridWidget(t);this.context.addWidget(this.resultGridWidget)}if(this.resultOptions.showChart&&!this.chartWidget){let t=yt(this.resultPanelSlot,"div",{cssClass:"eqv-chart-panel"});t.style.display="none";this.chartWidget=this.createChartWidget(t);this.context.addWidget(this.chartWidget)}}const w=this.resolveElement(c);if(w&&!this.queryNameWidget){this.queryNameWidget=this.createQueryNameWidget(w);this.context.addWidget(this.queryNameWidget)}const C=this.resolveElement(o);if(C&&!this.filterBarWidget){this.filterBarWidget=this.createFilterBarWidget(C);this.context.addWidget(this.filterBarWidget)}const x=this.resolveElement(h);if(x&&!this.sortingBarWidget){this.sortingBarWidget=this.createSortingBarWidget(x);this.context.addWidget(this.sortingBarWidget)}const k=this.resolveElement(l);if(k&&!this.processWidget){this.processWidget=this.createProcessWidget(k);this.context.addWidget(this.processWidget)}const $=this.resolveElement(a);if($&&!this.statementPanelWidget){this.statementPanelWidget=this.createStatementPanelWidget($);this.context.addWidget(this.statementPanelWidget)}const T=this.resolveElement(u);if(T){const t=this.createLocaleWidget(T);this.context.addWidget(t)}const S=this.resolveElement(f);if(S&&!this.resultFacetPanelWidget){this.resultFacetPanelWidget=this.createResultFacetsPanel(S);this.context.addWidget(this.resultFacetPanelWidget)}const E=this.resolveElement(m);if(E&&!this.exportWidget){this.exportWidget=this.createExportWidget(E);this.context.addWidget(this.exportWidget)}this.resultCountSlot=this.resolveElement(d);const D=this.resolveElement(p);if(D&&!this.aggregationBarWidget){this.aggregationBarWidget=this.createAggregationBarWidget(D);this.context.addWidget(this.aggregationBarWidget)}}initDone(){}resolveElement(t){if(typeof t==="string"){for(const e of this.domRoots){const s=e.getElementById(t);if(s)return s}return null}return t}resolveElementsByClassName(t){let e=[];for(const s of this.domRoots){const i=s.querySelectorAll("."+t);for(let t=0;t<i.length;t++){e.push(i[t])}}return e}displayRecordsCount(t){if(this.resultCountSlot&&typeof t!=="undefined"){this.resultCountSlot.style.display="inline";this.resultCountSlot.innerHTML=a.getText("MsgResultCount").replace("{0}",t.toString())}}getContext(){return this.context}setDialogService(t){this.context.getServices().registerService("DialogService",(()=>t))}executeQuery(t){console.warn("`executeQuery` is deprecated. Use `fetchData` instead");this.fetchData(t)}fetchData(t){t=t||{refresh:true};this.context.clearResult();if(this.context.getQuery().isEmpty()&&!this.resultOptions.fetchEmptyQueries)return;this.showResultSpinner();this.context.fetchData(Object.assign(Object.assign({},t),{elasticPaging:t.elasticPaging,success:e=>{this.hideResultSpinner();this.toggleExportButtons();this.displayRecordsCount(this.context.resultTable.getTotal());if(t.refresh===true){this.context.refreshWidgets(it.Result)}if(t.callback){t.callback()}if(t.success){t.success(e)}},error:()=>{this.hideResultSpinner()}}))}toggleExportButtons(){if(this.enableExport&&this.context.resultTable&&this.context.resultTable.getCachedCount()>0){this.enableExportButtons()}else{this.disableExportButtons()}}enableExportButtons(){}disableExportButtons(){}renderSpinner(){const t='<div class="wBall" id="wBall_1"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_2"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_3"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_4"><div class="wInnerBall"></div></div><div class="wBall" id="wBall_5"><div class="wInnerBall"></div></div>';this._spinnerDiv=Pt("div").addClass(`eqjs-result-spinner`).addChild("div",(e=>e.addClass(`${$e}-progress-win8`,Se()).addHtml(t))).toDOM()}showResultSpinner(){if(this.resultOptions.showProcessIndicator&&this.resultPanelSlot){if(!this._spinnerDiv.parentNode){for(let t=0;t<this.resultPanelSlot.children.length;t++){const e=this.resultPanelSlot.children[t];Pt(e).hide()}this.resultPanelSlot.appendChild(this._spinnerDiv)}}}hideResultSpinner(){if(this.resultOptions.showProcessIndicator&&this.resultPanelSlot){if(this._spinnerDiv.parentNode){this._spinnerDiv.parentNode.removeChild(this._spinnerDiv);for(let t=0;t<this.resultPanelSlot.children.length;t++){const e=this.resultPanelSlot.children[t];Pt(e).show()}}}}createChartWidget(t){if(this.resultOptions.chartWidgetResolver){return this.resultOptions.chartWidgetResolver(t)}else{return new As(t)}}createResultGridWidget(t){if(this.resultOptions.resultGridResolver){return this.resultOptions.resultGridResolver(t)}else{return new Cs(t)}}createEntitiesPanelWidget(t){return new Ee(t)}createColumnsPanelWidget(t){return new qe(t)}createQueryPanelWidget(t){return new bs(t)}createLocaleWidget(t){return new Hs(t)}createProcessWidget(t){return new ks(t)}createColumnsBarWidget(t){return new ze(t)}createFilterBarWidget(t){return new vs(t)}createSortingBarWidget(t){return new Je(t)}createQueryNameWidget(t){return new Ws(t)}createStatementPanelWidget(t){return new xs(t)}createResultFacetsPanel(t){return new Qs(t)}createExportWidget(t){return new qs(t)}createAggregationBarWidget(t){return new Gs(t)}detach(){if(this.entitiesPanelWidget){this.entitiesPanelWidget.destroy();this.entitiesPanelWidget=null}if(this.columnsPanelWidget){this.columnsPanelWidget.destroy();this.columnsPanelWidget=null}if(this.queryPanelWidget){this.queryPanelWidget.destroy();this.queryPanelWidget=null}if(this.columnsBarWidget){this.columnsBarWidget.destroy();this.columnsBarWidget=null}if(this.resultGridWidget){this.resultGridWidget.destroy();this.resultGridWidget=null}if(this.chartWidget){this.chartWidget.destroy();this.chartWidget=null}if(this.queryNameWidget){this.queryNameWidget.destroy();this.queryNameWidget=null}if(this.processWidget){this.processWidget.destroy();this.processWidget=null}if(this.localeWidget){this.localeWidget.destroy();this.localeWidget=null}if(this.statementPanelWidget){this.statementPanelWidget.destroy();this.statementPanelWidget=null}if(this.filterBarWidget){this.filterBarWidget.destroy();this.filterBarWidget=null}if(this.sortingBarWidget){this.sortingBarWidget.destroy();this.sortingBarWidget=null}if(this.statementWidget){this.statementWidget.destroy();this.statementWidget=null}if(this.exportWidget){this.exportWidget.destroy();this.exportWidget=null}if(this.resultFacetPanelWidget){this.resultFacetPanelWidget.destroy();this.resultFacetPanelWidget=null}if(this.resultCountSlot){this.resultCountSlot.innerHTML="";this.resultCountSlot=null}if(this.resultPanelSlot){this.resultPanelSlot.innerHTML="";this.resultPanelSlot=null}this.domRoots=[document];this.resetContext()}refreshWidgets(t){this.context.refreshWidgets(t)}}class zs extends Us{constructor(){super();this.exportButtons=[];this.disabledClass="eqjs-disabled";this.dropdownContainerClass="eqv-dropdown-container";this.dropdownButtonClass="eqv-drop-button";this.dropdownContentClass="eqv-dropdown-content";this.dropdownShowClass="eqv-dropdown-show";this._querySaveTemplate=`<div id="kdlg-dialog-form" class="kfrm-form">\n            <div class="kfrm-fields label-above">\n                <label for="kdlg-dialog-form-input" id="kdlg-dialog-form-content"></label>\n                <input type="text" name="kdlg-dialog-form-input" id="kdlg-dialog-form-input" />\n            </div>\n        </div>`;this.queryListMenu=null;this.fetchDataButtonClickHandler=this.fetchDataButtonClick.bind(this);this.clearQueryButtonClickHandler=this.clearQueryButtonClick.bind(this);this.newQueryButtonClickHandler=this.newQueryButtonClick.bind(this);this.loadQueryButtonClickHandler=this.loadQueryButtonClick.bind(this);this.saveQueryButtonClickHandler=this.saveQueryButtonClick.bind(this);this.copyQueryButtonClickHandler=this.copyQueryButtonClick.bind(this);this.removeQueryButtonClickHandler=this.removeQueryButtonClick.bind(this);this.storageButtonClickHandler=this.storageDropButtonClick.bind(this);this.saveQueryToFileButtonClickHandler=this.saveQueryToFileButtonClick.bind(this);this.loadQueryFromFileButtonClickHandler=this.loadQueryFromFileButtonClick.bind(this);const t=this;this.exportButtonClickHandler=function(e){if(!this.classList.contains(t.disabledClass)){const e=this.getAttribute("data-format");t.getContext().exportResult({format:e})}};this.queryChangedHandler=t=>{const e=t.data;if(this.resultOptions.clearResultOnQueryChange){this.context.clearResult();this.context.refreshWidgets(it.Result)}this.disableExportButtons();if(this.resultCountSlot){this.resultCountSlot.style.display="none"}if(this.viewOptions.syncQueryOnChange){this.syncQuery()}if(this.viewOptions.fetchDataOnChange){if(!e||e.part!=P.ExtraData&&e.part!=P.Facets){this.fetchData()}}};this.outsideClickHandler=t=>{let e=null;if(t.target.matches(`.${this.dropdownButtonClass}`)){e=t.target.parentElement.querySelector(`.${this.dropdownContentClass}`)}else if(t.target.matches(`.${this.dropdownButtonClass} > span`)){e=t.target.parentElement.parentElement.querySelector(`.${this.dropdownContentClass}`)}var s=this.resolveElementsByClassName(this.dropdownContentClass);for(let t=0;t<s.length;t++){var i=s[t];if(e!=i){if(i.classList.contains(this.dropdownShowClass)){i.classList.remove(this.dropdownShowClass)}}}}}refreshQueryList(){if(this.queryListPanel){this.queryListPanel.innerHTML="";this.context.loadQueryList({success:t=>{const e=Pt("ul",this.queryListPanel).addClass("list-group list-group-flush");t.map((t=>{e.addChild("li",(e=>{e.addClass("list-group-item").setStyle("cursor","pointer").data("id",t.id).text(t.name).on("click",(()=>{this.checkIfQueryModified((()=>this.loadQuery(t.id)))}))}))}))}})}}initOptions(t){t=super.initOptions(t);if(typeof t.syncQueryOnChange=="undefined"){t.syncQueryOnChange=true}return t}initWidgets(t){super.initWidgets(t);let e="eqjs-export";let s="ClearQueryButton";let i="NewQueryButton";let n="LoadQueryButton";let r="SaveQueryButton";let h="CopyQueryButton";let o="RemoveQueryButton";let l="StorageDropButton";let a="FetchDataButton";let u="LoadQueryFromFileButton";let c="SaveQueryToFileButton";let f="QueryListPanel";if(t.slots){a=t.slots.fetchDataButton||a;s=t.slots.clearQueryButton||s;i=t.slots.newQueryButton||i;n=t.slots.loadQueryButton||n;r=t.slots.saveQueryButton||r;h=t.slots.copyQueryButton||h;o=t.slots.removeQueryButton||o;l=t.slots.storageButton||l;e=t.slots.exportClass||e;u=t.slots.loadQueryFromFileButton||u;c=t.slots.saveQueryToFileButton||c;f=t.slots.queryListPanel||f}this.exportButtons=this.domRoots.reduce(((t,s)=>t.concat(Array.from(s.querySelectorAll(`.${e}`)))),[]);if(!t.enableExport){this.hideExportButtons()}this.disableExportButtons();this.exportButtons.forEach((t=>{t.addEventListener("click",this.exportButtonClickHandler)}));if(!this.fetchDataButton){this.fetchDataButton=this.resolveElement(a);if(!this.fetchDataButton){this.fetchDataButton=this.resolveElement("ExecuteQueryButton")}if(this.fetchDataButton){this.fetchDataButton.addEventListener("click",this.fetchDataButtonClickHandler)}}if(!this.clearQueryButton){this.clearQueryButton=this.resolveElement(s);if(this.clearQueryButton){this.clearQueryButton.addEventListener("click",this.clearQueryButtonClickHandler)}}if(!this.newQueryButton){this.newQueryButton=this.resolveElement(i);if(this.newQueryButton){this.newQueryButton.addEventListener("click",this.newQueryButtonClickHandler)}}if(!this.loadQueryButton){this.loadQueryButton=this.resolveElement(n);if(this.loadQueryButton){this.loadQueryButton.addEventListener("click",this.loadQueryButtonClickHandler)}}if(!this.saveQueryButton){this.saveQueryButton=this.resolveElement(r);if(this.saveQueryButton){this.saveQueryButton.addEventListener("click",this.saveQueryButtonClickHandler)}}if(!this.copyQueryButton){this.copyQueryButton=this.resolveElement(h);if(this.copyQueryButton){this.copyQueryButton.addEventListener("click",this.copyQueryButtonClickHandler)}}if(!this.removeQueryButton){this.removeQueryButton=this.resolveElement(o);if(this.removeQueryButton){this.removeQueryButton.addEventListener("click",this.removeQueryButtonClickHandler)}}if(!this.storageDropButton){this.storageDropButton=this.resolveElement(l);if(this.storageDropButton){this.storageDropButton.addEventListener("click",this.storageButtonClickHandler)}}if(!this.saveQueryToFileButton){this.saveQueryToFileButton=this.resolveElement(c);if(this.saveQueryToFileButton){this.saveQueryToFileButton.addEventListener("click",this.saveQueryToFileButtonClickHandler)}}if(!this.queryListPanel){this.queryListPanel=this.resolveElement(f);if(!this.queryListPanel){this.queryListPanel=this.resolveElement("QueryListSlot")}if(this.queryListPanel){this.context.addEventListener("ready",(()=>{this.refreshQueryList()}))}}if(!this.loadQueryFromFileButton){this.loadQueryFromFileButton=this.resolveElement(u);if(this.loadQueryFromFileButton){this.loadQueryFromFileInput=document.createElement("input");this.loadQueryFromFileInput.type="file";this.loadQueryFromFileInput.accept=t.queryFileExtensions;this.loadQueryFromFileInput.style.display="none";document.body.appendChild(this.loadQueryFromFileInput);this.loadQueryFromFileInput.addEventListener("change",this.loadQueryFromFileInputSelect.bind(this));this.loadQueryFromFileButton.addEventListener("click",this.loadQueryFromFileButtonClickHandler)}}window.addEventListener("click",this.outsideClickHandler)}initDone(){super.initDone();const t=this.context.getQuery();t.addChangedCallback(this.queryChangedHandler)}syncQuery(){this.context.syncQuery({success:t=>{if(t.statement){this.context.refreshWidgets(it.Statement)}}})}disableExportButtons(){this.exportButtons.forEach((t=>{t.disabled=true;if(!t.classList.contains(this.disabledClass)){t.classList.add(this.disabledClass)}}))}enableExportButtons(){this.exportButtons.forEach((t=>{t.disabled=false;if(t.classList.contains(this.disabledClass)){t.classList.remove(this.disabledClass)}}))}hideExportButtons(){this.exportButtons.forEach((t=>{t.style.display="none"}))}clearQueryButtonClick(){this.showQueryClearDialog((t=>{if(t){this.context.clearQuery();this.context.refreshWidgets(it.Statement)}}))}createNewQuery(t){return this.context.newQuery(t)}loadQuery(t){if(!t)return;this.context.loadQuery({queryId:t,silent:false})}saveQuery(t,e){this.context.saveQuery({success:()=>{if(t)t();this.context.getQuery().fireChangedEvent({part:P.Properties,wasModified:false});this.refreshQueryList()},error:e})}saveCurrentQuery(t=false,e){const s=this.context.getQuery();if(s.isNewbie||t){this.showSaveQueryDialog((t=>new Promise((e=>{if(!t)return;this.checkSaveQueryName(t).then((()=>{s.regenerateId();s.setName(t);s.fireChangedEvent({part:P.Properties,wasModified:true});this.saveQuery((()=>{e({success:true})}),(t=>e({success:false,message:t})))}),(t=>e({success:false,message:t})))}))))}else{this.saveQuery(e)}}checkSaveQueryName(t){return new Promise(((e,s)=>{this.context.loadQueryList({success:i=>{const n=i.filter((e=>e.name.toLowerCase()==t.toLowerCase()));if(n.length==0){e()}else{s("Can't save the query. A query with this name already exists.")}},error:t=>{s(t)}})}))}checkIfQueryModified(t){if(this.context.getQuery().isModified()&&!this.viewOptions.disableConfirmationOnQueryChange){this.showQueryChangedDialog((e=>{if(e){this.saveCurrentQuery(false,t)}else{t()}}))}else{t()}}removeCurrentQuery(){this.context.removeQuery({success:()=>{this.createNewQuery({useStorage:false});if(this.resultCountSlot){this.resultCountSlot.style.display="none"}this.context.clearResult();this.refreshQueryList()}})}showNewQueryDialog(t){const e=this.context.getServices().getService("DialogService");const s=a.getText("NewQueryDefName");const i=e.open({title:a.getText("NewQueryTitle"),body:this._querySaveTemplate,submitable:true,closable:true,cancelable:true,submitOnEnter:true,arrangeParents:false,beforeOpen:()=>{const t=document.getElementById(`kdlg-dialog-form-input`);if(s){t.value=s}const e=document.getElementById("kdlg-dialog-form-content");e.innerHTML=a.getText("NewQueryContent");t.focus()},onSubmit:()=>{const e=document.getElementById(`kdlg-dialog-form-input`);const s=e.value;if(s&&s.replace(/\s/g,"").length>0){if(!t)return true;i.disableButtons();const e=i.getRootElement().querySelector("header");const n=Pt("div",e).addClass("eqjs-process-bar local").toDOM();t(s).then((t=>{e.removeChild(n);i.enableButtons();if(t.success){i.close()}else{i.showAlert(t.message,"error")}}))}return false}})}showQueryClearDialog(t){const e=this.getDialogService();e.openConfirm(a.getText("QueryChangedTitle"),a.getText("QueryClearContent"),t)}showQueryChangedDialog(t){const e=this.getDialogService();e.openConfirm(a.getText("QueryChangedTitle"),a.getText("QueryChangedContent"),t)}showSaveQueryDialog(t){const e=this.getDialogService();const s=this.context.getQuery();const i=s.isNewbie?s.getName():a.getText("SaveQueryDefName").replace("{queryName}",s.getName());const n=e.open({title:a.getText("SaveQueryTitle"),body:this._querySaveTemplate,submitable:true,closable:true,cancelable:true,submitOnEnter:true,arrangeParents:false,beforeOpen:()=>{const t=document.getElementById(`kdlg-dialog-form-input`);t.value=i;const e=document.getElementById("kdlg-dialog-form-content");e.innerHTML=a.getText("SaveQueryContent");t.focus()},onSubmit:()=>{const e=document.getElementById(`kdlg-dialog-form-input`);const s=e.value;if(s&&s.replace(/\s/g,"").length>0){if(!t)return true;n.disableButtons();const e=n.getRootElement().querySelector("header");const i=Pt("div",e).addClass("eqjs-process-bar local").toDOM();t(s).then((t=>{n.enableButtons();e.removeChild(i);if(t.success){n.close()}else{n.showAlert(t.message,"error")}}))}return false}})}showRemoveQueryDialog(t){const e=this.getDialogService();const s=this.context.getQuery();e.openConfirm(a.getText("RemoveQueryTitle"),a.getText("RemoveQueryContent").replace("{queryName}",s.getName()),t)}showSaveQueryToFileDialog(t){const e=this.getDialogService();const s=this.context.getQuery();const i=this.renderSaveToFileDialogBody(s.getName());const n=e.open({title:a.getText("SaveQueryToFileDlgTitle"),body:i,onSubmit:()=>{const e=i.querySelector("#kdlgFileNameInput");const s=e?e.value:"Query";const r=i.querySelector("#kdlgFileFormatSelector");const h=r?r.value:"json";if(t){n.disableButtons();const e=n.getRootElement().querySelector("header");const i=Pt("div",e).addClass("eqjs-process-bar local").toDOM();t(s,h).then((t=>{n.enableButtons();e.removeChild(i);if(t.success){n.close()}else{n.showAlert(t.message,"error")}}));return false}return true}})}renderSaveToFileDialogBody(t,e="json"){const s=gt.isIE();const i=s?"kfrm-fields-ie col-ie-1-4 label-align-right":"kfrm-fields col-a-1 label-align-right";const n=s?"kfrm-fields-ie is-horizontal":"kfrm-fields is-horizontal";return Pt("div").addClass("kfrm-form").addChild("div",(s=>{s.addClass(i).addChild("label",(t=>t.attr("for","file_name").addText(a.getText("FileNameLabel")))).addChild("div",(s=>s.addClass(n).addChild("input",(e=>e.id("kdlgFileNameInput").name("file_name").type("text").attr("value",t))).addChild("label",(t=>t.addText("."))).addChild("div",(t=>t.addClass("kfrm-select").addChild("select",(t=>t.id("kdlgFileFormatSelector").addClass("kdlg-form-control").addOption({value:"xml",selected:"xml"===e}).addOption({value:"json",selected:"json"===e})))))))})).toDOM()}newQueryButtonClick(){this.checkIfQueryModified((()=>{this.createNewQuery()}))}saveQueryToFileButtonClick(){this.showSaveQueryToFileDialog(((t,e)=>new Promise((s=>{this.context.getQueryFile({fileName:t,format:e,success:()=>s({success:true}),error:t=>s({success:false,message:t})})}))))}loadQueryFromFileButtonClick(){this.checkIfQueryModified((()=>{this.showLoadQueryFromFileDialog()}))}showLoadQueryFromFileDialog(){this.loadQueryFromFileInput.click()}loadQueryFromFileInputSelect(){const t=this.loadQueryFromFileInput.files;const e=t.item(0);const s=new FormData;s.append(e.name,e);this.loadQueryFromFileInput.value="";this.context.uploadQueryFile({data:s,success:()=>{this.syncQuery();this.refreshQueryList()}})}loadQueryButtonClick(){this.context.loadQueryList({success:t=>{this.fillLoadQueryButtonMenu(t);this.queryListMenu.showMenu({anchor:this.loadQueryButton,adjustHeight:false,itemSelectedCallback:t=>{this.checkIfQueryModified((()=>this.loadQuery(t.id)))}})}})}fillLoadQueryButtonMenu(t){const e=this.getContext().getQuery();this.queryListMenu=new Me({items:t.map((t=>({id:t.id,text:t.name}))),selectedIds:e.getId()})}saveQueryButtonClick(){this.saveCurrentQuery()}copyQueryButtonClick(){this.saveCurrentQuery(true)}removeQueryButtonClick(){this.showRemoveQueryDialog((t=>{if(t){this.removeCurrentQuery()}}))}storageDropButtonClick(){let t=this.storageDropButton.parentElement;let e=t.querySelector(`.${this.dropdownContentClass}`);if(e){window.setTimeout((()=>e.classList.toggle(this.dropdownShowClass)),100)}}fetchDataButtonClick(){this.fetchData()}detach(){this.enableExportButtons();this.exportButtons.forEach((t=>{t.removeEventListener("click",this.exportButtonClickHandler)}));this.exportButtons=[];if(this.fetchDataButton){this.fetchDataButton.removeEventListener("click",this.fetchDataButtonClickHandler);this.fetchDataButton=null}if(this.clearQueryButton){this.clearQueryButton.removeEventListener("click",this.clearQueryButtonClickHandler);this.clearQueryButton=null}if(this.newQueryButton){this.newQueryButton.removeEventListener("click",this.newQueryButtonClickHandler);this.newQueryButton=null}if(this.loadQueryButton){this.loadQueryButton.removeEventListener("click",this.loadQueryButtonClickHandler);this.loadQueryButton=null}if(this.saveQueryButton){this.saveQueryButton.removeEventListener("click",this.saveQueryButtonClickHandler);this.saveQueryButton=null}if(this.copyQueryButton){this.copyQueryButton.removeEventListener("click",this.copyQueryButtonClickHandler);this.copyQueryButton=null}if(this.removeQueryButton){this.removeQueryButton.removeEventListener("click",this.removeQueryButtonClickHandler);this.removeQueryButton=null}if(this.storageDropButton){this.storageDropButton.removeEventListener("click",this.storageButtonClickHandler);this.storageDropButton=null}if(this.saveQueryToFileButton){this.saveQueryToFileButton.removeEventListener("click",this.saveQueryToFileButtonClickHandler);this.saveQueryToFileButton=null}if(this.queryListPanel){this.queryListPanel=null}if(this.loadQueryFromFileButton){if(this.loadQueryFromFileInput){document.body.removeChild(this.loadQueryFromFileInput)}this.loadQueryFromFileButton.removeEventListener("click",this.loadQueryFromFileButtonClickHandler);this.loadQueryFromFileButton=null}super.detach()}}class Vs extends Us{constructor(){super()}initOptions(t){t=super.initOptions(t);t.result.fetchEmptyQueries=true;const e=this.context.getQuery();e.addChangedCallback((()=>{if(this.resultOptions.clearResultOnQueryChange){this.context.clearResult()}if(t.syncQueryOnChange){this.context.syncQuery()}}));this.context.addEventListener("ready",this.fetchData.bind(this));return t}initWidgets(t){super.initWidgets(t);if(this.sortingBarWidget){this.context.getQuery().addChangedCallback((t=>{const e=t.data;if(!e||e.part!=P.SortingColumns&&e.part!=P.Columns&&e.part!=P.All){return}this.fetchData()}))}if(this.filterBarWidget){const e=this.filterBarWidget.getWidgetType();t.widgets[e]=t.widgets[e]||{};if(!t.widgets[e].applyFilterCallback){t.widgets[e].applyFilterCallback=()=>{this.fetchData()}}}}applyQueryFilter(){console.warn("applyQueryFilter is obsolete. Use fetchData instead");this.fetchData()}fetchData(){super.fetchData({refresh:true})}}function Js(){a.addMapper((t=>{if(!t&&!t.texts)return;for(let e in t.texts){switch(e){case"PredicateTitle":t.texts["ConditionGroupTitle"]=t.texts[e];break;case"RootPredicateTitle":t.texts["RootConditionGroupTitle"]=t.texts[e];break;case"ErrIncorrectPredicateTitleFormat":t.texts["ErrIncorrectGroupTitleFormat"]=t.texts[e];break;case"ButtonAddPredicate":t.texts["ButtonAddGroup"]=t.texts[e];break;case"ButtonDelete":t.texts["CmdDelete"]=t.texts[e];break;case"ButtonClear":t.texts["CmdClear"]=t.texts[e];break;case"ButtonEnable":t.texts["CmdToggleEnable"]=t.texts[e];break;case"ButtonAddCondition":t.texts["CmdAddCondition"]=t.texts[e];break;case"ButtonAddGroup":t.texts["CmdAddCondGroup"]=t.texts[e];break}}}))}function Ys(){a.updateDefaultTexts({AltMenuAttribute:"Attribute",AltMenuConstantExpression:"Constant expression",ButtonApply:"Apply",ButtonCancel:"Cancel",ButtonClose:"Close",ButtonNext:"Next",ButtonPrev:"Prev",ButtonNow:"Now",ButtonOK:"OK",MenuEnable:"Enabled",MenuParameterization:"Parameterized",MenuJoinCond:"Use in JOIN",CmdClear:"Clear",CmdDelete:"Delete",CmdToggleEnable:"Toggle enable",CmdToggleEnableCustom:"Custom Expression columns are not supported",CmdAddCondition:"Add condition",CmdAddCondGroup:"Add group of conditions",ButtonSelectAll:"Select all",ButtonDeselectAll:"Clear selection",ButtonAddColumns:"Add column(s)",ButtonAddConditions:"Add condition(s)",CmdClickToAddCondition:"[Add new condition]",CmdDeleteRow:"Delete this row",ErrIncorrectGroupTitleFormat:"Incorrect condition group title format",ErrNotNumber:" is not a number",ErrIncorrectInteger:"Incorrect integer value",ErrIncorrectNumberList:"Incorrect list format",False:"False",LinkTypeAll:"all",LinkTypeAny:"any",LinkTypeNone:"none",LinkTypeNotAll:"not all",ConjAll:"and",ConjAny:"or",ConjNotAll:"and",ConjNone:"or",MsgApplySelection:"[Apply selection]",MsgAs:"as",MsgEmptyList:"(empty list)",MsgEmptyListValue:"[select value]",MsgEmptyScalarValue:"[enter value]",MsgSubQueryValue:"[edit sub-query]",MsgEmptyAttrValue:"[select attribute]",MsgEmptyOperator:"[Unrecognized operator]",MsgEmptyCustomSql:"[enter SQL expression]",MsgCustomSql:"[Custom SQL]",MsgNoResult:"No result",MsgResultCount:"{0} records found",MsgOf:"of",ConditionGroupTitle:"{lt} of the following apply",RootConditionGroupTitle:"Select records where {lt} of the following apply",StrAddConditions:"Add conditions",SubQueryDialogTitle:"Edit sub-query",SubQueryColumnTitle:"Column:",SubQueryEmptyColumn:"[select column]",SubQueryQueryPanelCaption:"Conditions",True:"True",ButtonSorting:"Sorting",ButtonToAggr:"Change to aggregate column",ButtonToSimple:"Change to simple column",ButtonFormat:"Display format",CmdAscending:"Ascending",CmdClickToAddColumn:"[Add new column]",CmdDeleteColumn:"Delete column",CmdDeleteSorting:"Delete sorting",CmdDescending:"Descending",CmdGroupAppearance:"Appearance",CmdGroupSort:"Sorting",CmdGroupFormat:"Display format",CmdNotSorted:"Not sorted",ColTypeAggrFunc:"Aggregate function",ColTypeCompound:"Calculated",ColTypeGroup:"Column type",ColTypeSimple:"Simple column",HeaderExpression:"Expression",HeaderSorting:"Sorting",HeaderTitle:"Title",SortHeaderColumn:"Column",SortHeaderSorting:"Sorting",StrAddColumns:"Add columns",CustomExpression:"Custom Expression",AddAllForEntityText:"[Add all attributes]",CmdMoveToStart:"Move to start",CmdMoveRight:"Move right",CmdMoveLeft:"Move left",CmdMoveToEnd:"Move to the end",CmdMoveUp:"Move up",CmdMoveDown:"Move down",ButtonMenu:"Show menu",CmdToSimple:"Not aggregated",CmdMoveToFirst:"Move to the first",CmdMoveToPrev:"Move to the previous",CmdMoveToNext:"Move to the next",CmdMoveToLast:"Move to the last",CmdHiddenColumn:"Hidden",RowButtonTitle:"Click to see the available options",EntityToggle:"Toggle entity",StrNoFilterDefined:"No filter defined",StrNoFilterClickToAdd:"No filter defined. Click to add a new condition",HintHours:"Hours",HintMinutes:"Minutes",RemoveQueryTitle:"Confirmation",RemoveQueryContent:"Remove query [{queryName}]?",NewQueryTitle:"New query",NewQueryContent:"New query name: ",NewQueryDefName:"New query",SaveQueryTitle:"Save query",SaveQueryContent:"Query name: ",SaveQueryDefName:"{queryName} copy",QueryChangedTitle:"Confirmation",QueryChangedContent:"The query was changed. Do you want to save it first?",QueryClearContent:"The query will cleared. Do you want to continue?",UpdateQuerySelector:"[click here to load the query]",FileNameLabel:"File name: ",SaveQueryToFileDlgTitle:"Save query to file",NewReportDefName:"New report",NewReportDlgTitle:"New report",SaveReportDlgTitle:"Save report",SaveReportDlgLabel:"Report name:",ReportDescLabel:"Description: ",RemoveReportDlgTitle:"Remove report",RemoveReportContent:"Are you sure you want to remove '{reportName}'?",Facets:{TotalRecordsLabel:"Total records:",AddMenuItems:{Chart:"Chart",Pivot:"Pivot table",DataTable:"Data table"},LoadDataDlgTitle:"Downloading data",LoadDataDlgContent:"Records loaded: {loadedRecs}/{totalRecs}",RefreshBtnTitle:"Refresh",ExportBtnTitle:"Export",MaximizeBtnTitle:"Maximize",RestoreBtnTitle:"Restore Down",RemoveFacetDlgTitle:"Remove facet",RemoveFacetDlgContent:`Are you sure, that you want to delete {facetTitle} tab?`,DefaultDlgTitle:"Setup facet",DefaultFacetTitle:"",NewFacetTitle:"New Facet",TabNameLabel:"Tab name",ErrQueryChanged:"FAILED TO DISPLAY. QUERY WAS CHANGED",ErrNotEnoughData:`We can't display the graph because not all data for this query is loaded. \n        The total number of records: {totalRecs}, currently loaded: {cachedRecs}. \n        You can [download the result]. Please note: this may take some time and consume a lot of memory.`,ErrTooMuchData:"Too much data. The grid is not able to display it",Chart:{FacetTitle:"Chart",DlgTitle:"Chart settings",DataColumnSelectorLabel:"Data column",LabelColumnSelectorLabel:"Label column",ChartTypeSelectorLabel:"Chart type",ShowLegendLabel:"Show legend (if available)"},Pivot:{FacetTitle:"Pivot table",DlgTitle:"Pivot settings",SwapBtnTitle:"Swap column and row fields",ColumnFieldSelectorLabel:"Column field",RowFieldSelectorLabel:"Row field",CellDataSelectorLabel:"Cell data",TotalsRowLabel:"Totals row",TotalsColLabel:"Totals column",TotalGridLabel:"Total"},DataTable:{FacetTitle:"Result table",DlgTitle:"Table facet settings"}},TotalsDlgLabel:"Totals",GrandTotalsLabel:"Grand totals",TotalsDlgTitle:"Select totals",ExportDlgTitle:"Export result",ExportDlgFmtLabel:"Format",csv:"CSV",excel:"Excel",pdf:"PDF","excel-html":"HTML (Excel-compatible)",AggrSettings:{GroupBtn:"Group selected column(s)",UngroupBtn:"Ungroup columns",AggrBtn:"Aggregate selected column",UnaggrBtn:"Remove column aggregation",GrandTotalsLabel:"Show grand totals",GroupCountsLabel:"Show record count for groups",AggrDialogTitle:"Aggregation/grouping",EnableAggrLabel:"Enable aggregation",SelectedError:"Complete the action with selected column(s)",NoGroupsOrAggrError:"Add at least one group or aggregation",NoGroupsOrGrandError:"Add at least one group, or enable grand totals",NoAggrOrCountError:"Add at least one aggregation, or enable records count",NoGroupsLabel:"No groups",NoAggrsLabel:"No aggregations",EmptySettingsLabel:"[ Click to setup ]"},ChartType:{Area:"Area chart",Bar:"Bar chart",Column:"Column chart",Combo:"Combo chart",Doughnut:"Doughnut chart",Polar:"Polar chart",Radar:"Radar chart",Histogram:"Histogram chart",Line:"Line chart",SteppedLine:"Stepped line chart",Pie:"Pie chart"}})}Js();Ys();const Ks=st.getInstance();Ks.registerService("DialogService",(()=>new pe));if(!Element.prototype.matches){Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector}if(window["NodeList"]&&!window["NodeList"].prototype.forEach){window["NodeList"].prototype.forEach=Array.prototype.forEach}if(!Array.prototype.findIndex){Array.prototype.findIndex=function(t){if(this==null){throw new TypeError("Array.prototype.findIndex called on null or undefined")}if(typeof t!=="function"){throw new TypeError("predicate must be a function")}var e=Object(this);var s=e.length>>>0;var i=arguments[1];var n;for(var r=0;r<s;r++){n=e[r];if(t.call(i,n,r,e)){return r}}return-1}}const Xs=7;const Zs=4;const ti=[45,128,231];Math.trunc=Math.trunc||function(t){if(isNaN(t)){return NaN}if(t>0){return Math.floor(t)}return Math.ceil(t)};const ei={__kt:0,versionNum:""+Xs+"."+Zs,ck:function(t){if(!t||!t.length){this.__kt=-3;return}try{var e=t.slice(0,t.length-12);var s=ii(e);var i=t.slice(t.length-12);let a=false;for(const t of ti){var n=hi(t);if(i[0]===n[0]&&i[2]===n[1]){a=true;break}}if(!a){ei.__kt=-1}var r=Zs%4;var h=Xs+Zs;if(i[6+r]!=si(h,19)){ei.__kt=-2;return}if(i[1]!=si(s[3])){return}ei.__kt=i[3]!=si(s[5])?2:3;if(ei.__kt===2){var o=`${oi(i.substring(4,6)+i.substring(10))}`;var l=new Date(2e3+Number.parseInt(o.substring(0,2)),Number.parseInt(o.substring(2,4))-1,Number.parseInt(o.substring(4)),0,0,0,0);if(Date.now()>l.getTime()){ei.__kt=1}}}catch(t){}}};function si(t,e=20){return String.fromCharCode(65+t%e)}function ii(t){var e=ni(t);var s=e.length;var i=new Uint8Array(s);for(var n=0;n<s;n++){i[n]=e.charCodeAt(n)}return i}function ni(t){var e=t;e=e.replace(/-/g,"+");e=e.replace(/_/g,"/");switch(e.length%4){case 0:break;case 2:e+="==";break;case 3:e+="=";break}return window.atob(e)}const ri="ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";function hi(t){var e="";while(t>0){e=ri[t%ri.length]+e;t/=ri.length}return e}function oi(t){var e=0;for(var s=0;s<t.length;++s)e+=ri.indexOf(t[s])*Math.pow(ri.length,t.length-s-1);return e}class li extends G{constructor(){super(...arguments);this.readOnly=false;this.parameterized=false;this.inJoin=false}isReadOnly(){return this.readOnly||this.getParent()&&this.getParent().isReadOnly()}setReadOnly(t){this.readOnly=t||this.getParent()&&this.getParent().isReadOnly();this.conditions&&this.conditions.forEach((e=>{e.setReadOnly(t)}))}isParameterized(){return this.parameterized}setParameterized(t){this.parameterized=t}isInJoin(){return this.inJoin}setInJoin(t){this.inJoin=t}loadFromData(t,e){super.loadFromData(t,e);if(ei.__kt<=1)return;if(typeof e.readOnly!=="undefined"){this.setReadOnly(e.readOnly)}if(typeof e.inJoin!=="undefined"){this.setInJoin(e.inJoin)}if(typeof e.parameterized!=="undefined"){this.setParameterized(e.parameterized)}if(e.conds){for(let s=0;s<e.conds.length;s++){let i=this.query.createCondition();i.loadFromData(t,e.conds[s]);this.conditions.push(i);i.setParent(this)}}}saveToData(){let t=super.saveToData();if(ei.__kt<=1)return t;if(this.isReadOnly()){t.readOnly=this.isReadOnly()}if(this.isParameterized()){t.parameterized=this.isParameterized()}if(this.isInJoin()){t.inJoin=this.isInJoin()}if(this.tag==j.Group){t.conds=[];for(let e=0;e<this.conditions.length;e++){t.conds.push(this.conditions[e].saveToData())}}return t}}class ai extends q{constructor(){super(...arguments);this.readOnly=false}isReadOnly(){return this.readOnly}setReadOnly(t){this.readOnly=t}loadFromData(t,e){super.loadFromData(t,e);if(ei.__kt<=2)return;if(e){if(typeof e.readOnly!="undefined"){this.readOnly=e.readOnly}}}saveToData(){let t=super.saveToData();if(ei.__kt<=2)return t;if(this.isReadOnly()){t.readOnly=this.isReadOnly()}return t}}class ui extends U{constructor(t,e){super(t,null,e)}isEx(){return ei.__kt>1}createSubQuery(){return new ui(this.model,{context:this.context})}createCondition(t=j.Simple){if(ei.__kt<=1)return super.createCondition(t);return new li(this,t)}createColumn(t=false){if(ei.__kt<=1)return super.createColumn(t);return new ai(this,t)}addConditionGroup(t,e=true){if(ei.__kt<=1)return super.addConditionGroup(t,e);let s=t.parent||this.getRootCondition();let i=t.linking||(s.linkType===$.All?$.Any:$.All);let n=this.createCondition(j.Group);n.linkType=i;if(e){let t=this.getModel();let e=t.getFirstUICAttr();if(e){let s=t.getDefaultOperatorForAttr(e);let i=this.createSimpleConditionObject(e,s,"");n.addCondition(i)}}s.addCondition(n);return n}addExtraConditionGroup(t,e=true){t.parent=t.parent||this.extraConditions;if(ei.__kt<=1)return super.addExtraConditionGroup(t,e);return this.addConditionGroup(t)}buildQueryPath(){const t=this.getModel();if(ei.__kt<=1)return this.buildQueryPath();if(t.getMainEntity())return this.buildQueryPath();const e=this.getEntitiesInQuery();if(e.length==0){throw Error("Cannon build path. Path is empty")}let s=new H(e[0]);for(let t=1;t<e.length;t++){const i=e[t];if(s.contains(i)){continue}let n=this.findPath(s.value,i);if(n!=null){s=this.addPathToTree(s,n[0]===s.value?n.slice(1):n)}else{throw Error("Unable to build query. Cannot build path.")}}s.setParents();return s}addPathToTree(t,e){if(e.length==0){return}let s=false;for(let i of t.childs){if(i.value===e[0]){s=true;if(e.length>1)i=this.addPathToTree(i,e.slice(1));break}}if(!s){let s=this.getModel().findLink(t.value,e[0]);if(s){let s=new H(e[0]);t.addChild(s);if(e.length>1)s=this.addPathToTree(s,e.slice(1))}else if(!t.parent){let s=new H(t);t=new H(e[0]);t.addChild(s);if(e.length>1)t=this.addPathToTree(t,e.slice(1))}else{throw Error("Unable to build query. Cannot build path.")}}return t}findPath(t,e){let s=[];let i=[];let n=[];let r=[];let h=false;s.push(t);i.push(s);r.push(t);while(!h){n=[];for(let t of i){h=this.checkPath(t,e,n,r);if(h){t.push(e);s=t;break}}i=[];if(!h){if(n.length==0)return null;for(let t of n)i.push(t)}}return s}checkPath(t,e,s,i){const n=t[t.length-1];const r=this.getModel().getLinksByEntity(n);for(let h of r){let r=null;if(h.entityFrom==n){r=h.entityTo}else{r=h.entityFrom}if(r==e){s=[];return true}if(t.indexOf(r)<0&&i.indexOf(r)<0){i.push(r);let e=new Array;e=e.concat(t);e.push(r);s.push(e)}}return false}}class ci{constructor(t){this.context=t}init(){}newQuery(t){t=t||{};const e=t.query||this.context.getQuery();const s=this.context.getModel();const i=t.modelId||(s?s.getId():"");if(t.queryId){e.setId(t.queryId)}if(t.name){e.setName(t.name)}if(t.description){e.setDescription(t.description)}let n={query:e.toJSONData()};if(t.data){n["data"]=t.data}const r=this.context.resolveEndpoint("NewQuery",{modelId:i});const h=this.context.getServices().getHttpClient();return h.post(r,n).then((t=>t.query))}getQueryList(t){t=t||{};const e=t.modelId||this.context.getModel().getId();const s=this.context.resolveEndpoint("GetQueryList",{modelId:e});const i=this.context.getServices().getHttpClient();return i.get(s).then((t=>{if(!t.queries){return Promise.reject({message:"Wrong response format"})}return t.queries}))}loadQuery(t){t=t||{};const e=this.context.getModel();const s=this.context.getQuery();const i=t.modelId||e.getId();const n=t.queryId||s.getId();const r=this.context.resolveEndpoint("GetQuery",{modelId:i,queryId:n});const h=this.context.getServices().getHttpClient();return h.get(r).then((t=>t.query))}saveQuery(t){t=t||{};const e=t.query||this.context.getQuery();const s=t.queryId||e.getId();if(t.queryId){e.setId(t.queryId)}const i=t.modelId||e.getModel().getId();if(t.queryId){e.setId(t.queryId)}let n={query:e.toJSONData()};if(t.data){n["data"]=t.data}const r=this.context.resolveEndpoint("SaveQuery",{modelId:i,queryId:s});const h=this.context.getServices().getHttpClient();return h.put(r,n).then((t=>t.query))}removeQuery(t){t=t||{};const e=this.context;const s=e.getQuery();const i=t.modelId||s.getModel().getId();const n=t.queryId||s.getId();let r={modelId:i,queryId:n};if(t.data){r["data"]=t.data}const h=this.context.resolveEndpoint("RemoveQuery",{modelId:i,queryId:n});const o=this.context.getServices().getHttpClient();return o.delete(h,r).getPromise()}}class fi extends N{}class di{constructor(t){this.context=t;this.levelsTotals=[];this.prevRow=null;this.aggrContainer=new tt(t)}getAggrContainer(){return this.aggrContainer}initObjects(){this.aggrSettings=this.context.getQuery().getAggregationSettings();this.groups=this.aggrSettings.getGroups();this.aggregates=this.aggrSettings.getAggregates();this.aggrColIds=this.aggrSettings.getAggregates().map((t=>t.colId));this.aggrCols=this.context.resultTable.columns.getItems().filter((t=>this.aggrColIds.indexOf(t.id)>=0));this.levelsTotals=[];this.prevRow=null}createColumnAggregatesObject(){return{sum:0,min:Number.MAX_VALUE,max:Number.MIN_VALUE}}calculate(t){this.initObjects();this.aggrContainer.clear();t=t||{};t.maxLevel=t.maxLevel>=0?t.maxLevel:0;var e=this.groups.length+1;for(let t=0;t<e;t++){let t={count:0,columns:{}};this.resetLevelTotals(t);this.levelsTotals.push(t)}const s=this.context.resultTable.getCachedRows();if(s.length>0){for(const t of s){this.processDataRow(t)}for(let t=1;t<e;t++){this.flushLevelTotals(t)}if(this.aggrSettings.hasGrandTotals()){this.flushLevelTotals(0)}}return Promise.resolve()}resetLevelTotals(t){for(const e of this.aggrCols){t.columns[e.id]=this.createColumnAggregatesObject()}t.count=0}processDataRow(t){const e=this.checkLevelChange(t);if(e>=0){for(let t=e;t<this.levelsTotals.length;t++){this.flushLevelTotals(t)}}if(this.aggrSettings.hasGrandTotals()){this.updateLevelTotals(0,t)}let s=1;for(const e of this.groups){this.updateLevelTotals(s,t);s++}this.prevRow=t}checkLevelChange(t){if(this.prevRow==null)return-1;for(let s=0;s<this.groups.length;s++){var e=this.groups[s];for(const i of e.columns){const e=t.getValue(i);const n=this.prevRow.getValue(i);if(!this.aggrSettings.compareValues(n,e)){return s+1}}}return-1}flushLevelTotals(t){let e=this.levelsTotals[t];const s=t>0?this.groups[t-1]:null;let i=this.aggrSettings.buildGroupKey(s,this.prevRow);var n={};for(const t of this.aggregates){const s=e.columns[t.colId];n[t.colId]=this.applyAggrFunc(t.funcId,s,e)}if(this.aggrSettings.hasRecordCount()){n[this.aggrSettings.COUNT_FIELD_NAME]=e.count}this.aggrContainer.updateAggregateData(t,i,n);this.resetLevelTotals(e)}applyAggrFunc(t,e,s){switch(t){case"SUM":return e.sum;case"AVG":return e.sum/s.count;case"COUNT":case"CNTDST":return s.count;case"MIN":return e.min;case"MAX":return e.max}}updateLevelTotals(t,e){const s=this.levelsTotals[t];s.count+=1;for(const t of this.aggregates){const i=e.getValue(t.colId);const n=s.columns[t.colId];n.sum+=i;if(i<n.min){n.min=i}if(i>n.max){n.max=i}}}needRecalculation(){return true}reset(){}}function mi(t){if(t){return t.trim()===""}else return true}const pi="https://account.korzh.com/api/license";const gi=ei.versionNum;class yi{constructor(t){this.http=new l;this.context=t}show(){const t=new pe;this.dialogSet=t.createSet([{closable:false,cancelable:false,submitOnEnter:true,title:"No license key for EasyQuery",body:this.buildStartPage(),submitButtonText:"Submit",onInput:this.validateForm.bind(this),onSubmit:this.startPageOnSubmit.bind(this)},{closable:false,cancelable:false,submitOnEnter:true,title:"Please check your inbox",body:this.buildCodePage(),submitButtonText:"Get License Key",onInput:this.validateForm.bind(this),onSubmit:this.codePageOnSubmit.bind(this)},{closable:false,cancelable:false,submitable:false,title:"Success",body:this.buildSuccessPage()},{closable:false,cancelable:false,submitable:false,title:"Failure",body:this.buildFailurePage()}]);const e=this.dialogSet.open(0);setTimeout((()=>{this.validateForm(e);const t=document.getElementById("eqAuthEmail");if(t){t.focus()}}),200)}isValidForm(t){const e=t.querySelector("#eqAuthEmail");if(e){return!mi(e.value)&&e.value.toLowerCase().match(/^(([^<>()[\]\\.,;:\s@"]+(\.[^<>()[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/)}const s=t.querySelector("#eqAuthCode");if(s){return!mi(s.value)&&!isNaN(+s.value)&&s.value==s.value.trim()&&s.value.length===6}return true}validateForm(t){const e=t.getSubmitButtonElement();e.disabled=!this.isValidForm(t.getRootElement())}addInputField(t,e){t.addChild("label",(t=>t.attr("for",e.id).addHtml(`${e.label} ${e.required?'<sup style="color: red">*</sup>':""}: `))).addChild("input",(t=>{t.id(e.id);t.name(e.name||e.id);t.type(e.type||"text");if(typeof e.value!=="undefined"){t.value(e.value)}if(e.onInput){t.on("input",e.onInput)}}))}buildStartPage(){let t;let e;const s=Pt("div");s.addChild("div",(t=>t.html('<div style="font-size:1.2em">The EasyQuery license key is either absent, invalid or was issued for a different version of the library.</div>'+'<div style="font-size:1.2em">Please fill out the form to obtain a valid trial license key.</div>')));s.addClass("kfrm-form").addChild("div",(t=>{e=t;t.addClass("kfrm-fields label-above");t.addClass("kfrm-break-20")}));this.addInputField(e,{id:"eqAuthEmail",name:"email",label:"Email",required:true});this.addInputField(e,{id:"eqAuthName",name:"contactName",label:"Name (optional)",required:false});s.addChild("div",(t=>t.html('<div style="margin-top:20px;font-size:0.9em">* By clicking Submit, you agree with Korzh.com <a href="https://korzh.com/terms-of-use">Terms of use</a>'+' and <a href="https://korzh.com/privacy">Privacy policy</a>.</div>'+'<div style="font-size:0.9em">You also agree to receive email messages from Korzh.com. This consent may be revoked at any time.</div>')));t=s.toDOM();return t}buildCodePage(){let t;let e;const s=Pt("div");s.addChild("div",(t=>t.html('<div style="font-size:1.2em">We sent a confirmation code to <strong>{{email}}</strong>.</div>'+'<div style="font-size:1.2em">Please find it in the email and enter to the text box below</div>')));s.addClass("kfrm-form").addChild("div",(t=>{e=t;t.addClass("kfrm-fields label-above");t.addClass("kfrm-break-20")}));this.addInputField(e,{id:"eqAuthCode",name:"code",label:"Confirmation code",required:true});s.addChild("div",(t=>t.html('<div style="margin-top:20px;font-size:0.9em">NB: Don\'t forget to check your SPAM folder '+'if the message does not arrive within the next 5 minutes, and mark it as "Not Spam" if it\'s found there.</div>')));t=s.toDOM();return t.outerHTML}buildSuccessPage(){let t;const e=Pt("div");e.addChild("div",(t=>t.html('<div style="font-size:1.2em">You have successfully completed the registration.</div>'+"{{message}}")));t=e.toDOM();return t.outerHTML}buildFailurePage(){let t;const e=Pt("div");e.addChild("div",(t=>t.html("{{message}}")));t=e.toDOM();return t.outerHTML}startPageOnSubmit(t){const e=document.getElementById("eqAuthEmail");const s=document.getElementById("eqAuthName");this.authEmail=e.value;this.authName=s.value;t.disableButtons();this.http.post(T.combinePath(pi,"get-code"),{email:this.authEmail,name:this.authName,data:{ptag:this.context.backendInfo.type,apptype:this.context.backendInfo.subType}},{dataType:"json"}).then((t=>{if(t.status!==0){throw new Error(t.message)}const e=this.dialogSet.openNext({email:this.authEmail});setTimeout((()=>{this.validateForm(e);const t=document.getElementById("eqAuthCode");if(t){t.focus()}}),200)})).catch((e=>{t.showAlert("Error: "+e.message,"error",true);t.enableButtons()}));return false}codePageOnSubmit(t){const e=document.getElementById("eqAuthCode");const s=e.value;t.disableButtons();this.http.post(T.combinePath(pi,"get-key"),{token:s,email:this.authEmail,ptag:this.context.backendInfo.type,version:gi},{dataType:"json"}).then((t=>{switch(t.status){case 0:const e=T.combinePath(this.context.getBaseEndpoint(),"lck");this.http.post(e,{version:gi,key:t.key},{dataType:"json"}).then((t=>this.dialogSet.open(2,{message:'<div style="font-size:1.2em">Please restart your web application to get the key applied.</div>'})),(t=>this.dialogSet.open(2,{message:'<div style="font-size:1.2em">'+'Please visit <a href="https://account.korzh.com">your account page on Korzh.com</a> to get the key '+"and then add it to the <i>appsettings.json</i> file (in the <i>EasyQuery/LicenseKey</i> option).</div>"})));break;case 2:this.dialogSet.open(3,{message:'<div style="font-size:1.2em">Your trial license for EasyQuery has expired.</div>'+'<div style="font-size:1.2em">Please <a href="https://korzh.com/support">contact us</a> if you want to extend the trial period.</div>'});break;case 3:this.dialogSet.open(3,{message:'<div style="font-size:1.2em">The maintenance subscription for your EasyQuery license has expired.</div>'+'<div style="font-size:1.2em">You need to <a href="https://account.korzh.com">renew the subscription</a> to get a valid license.</div>'});break;default:throw new Error(t.message)}})).catch((e=>{if(!e.message){e.message="Invalid or expired code. Please re-submit your request."}t.showAlert("Error: "+e.message,"error",true);t.enableButtons()}));return false}}function bi(t){if(ei.__kt==-3){const e=new yi(t);e.show()}else{let t,e,s,i;switch(ei.__kt){case 1:t="EasyQuery trial has expired";e=`Your trial period for EasyQuery has expired. \n        You can <a href="https://korzh.com/support">submit a request to extend your trial</a> or <a href="https://korzh.com/easyquery#licensing">buy a license</a> to get rid of all limitations.`;s="Buy a license";i="#licensing";break;default:t=`Invalid key for EasyQuery!`;e=`The EasyQuery product key is either invalid or was issued for a different version of the library.\n        The version you are using now is ${gi},\n        so please <a href="https://account.korzh.com">login to your account</a> to get a proper key for version ${gi}`;s="Get key";i="https://account.korzh.com";break}const n=new pe;const r=n.open({closable:false,cancelable:false,submitable:false,title:t,body:e});const h=r.getRootElement().querySelector("footer");Pt(h).removeClass("align-right").setStyle("justify-content","center").addChild("button",(t=>t.addClass("kfrm-button","is-info").addText(s).on("click",(t=>{window.location.href=i}))));if(ei.__kt==1){Pt(h).addChild("button",(t=>t.addClass("kfrm-button").addText("Extend trial").on("click",(t=>{window.location.href="https://account.korzh.com"}))))}}}class vi extends at{useEnterprise(t){const e=t=>{ei.ck(t);if(ei.__kt>1){const t=this.getServices();t.registerDataModelResolver((t=>new fi));t.registerQueryResolver((t=>new ui(t.getModel(),{context:t})));t.registerQueryStorageResolver((t=>new ci(t)));t.registerAggregatesCalculator((t=>new di(t)));if(ei.__kt===2){console.warn("EasyQuery.JS is working in the TRIAL MODE!\n"+"Please order a license (https://korzh.com/easyquery) to get a proper product key.");this.createTrialWM();setTimeout((()=>{this.showTrialWM();setTimeout((()=>{this.hideTrialWM()}),6e3)}),3e3)}}else{bi(this)}};if(typeof t==="string"){e(t)}else if(typeof t==="function"){const s=this.getServices().getHttpClient();let i=T.combinePath(this.getBaseEndpoint(),"lck2");s.get(i).then((s=>{e(s.key.split("").reverse().join(""));this.useBackend({type:s.backendType,subType:s.appType});t()})).catch((n=>{if(n.status==401){e("")}else{i=T.combinePath(this.getBaseEndpoint(),"lck");s.get(i).then((s=>{e(s.split("").reverse().join(""));t()})).catch((t=>this.throwError({action:"LCK",sourceError:t})))}}))}else{throw new Error("Wrong type of 'keyOrInitCallback' parameter. It must be a string with a license key or a callback function.")}}createTrialWM(){let t=document.createElement("div");t.style.position="fixed";t.style.bottom="0";t.style.right="-400px";t.style.width="400px";t.style.height="100px";t.style.color="grey";t.style.textAlign="center";t.style.opacity="0.7";t.style.font="bold 1em Trebuchet MS, Tahoma, Verdana, Geneva, Arial, Helvetica, sans-serif";t.style.transition="right 3s ease-out";const e=document.createElement("div");const s=document.createElement("span");s.innerText="EasyQuery";s.style.color="#3A94D4";s.style.lineHeight="50px";e.appendChild(s);const i=document.createElement("span");i.innerText="by Korzh.com";i.style.marginLeft="10px";e.appendChild(i);t.appendChild(e);const n=document.createElement("div");n.innerText="FOR TRIAL USE ONLY";n.style.fontSize="1.2em";n.style.fontWeight="1000";t.appendChild(n);document.body.appendChild(t);this.trialDivElement=t}showTrialWM(){if(this.trialDivElement){this.trialDivElement.style.right="0"}}hideTrialWM(){if(this.trialDivElement){this.trialDivElement.style.right="-400px";setTimeout((()=>{this.trialDivElement.parentNode.removeChild(this.trialDivElement)}),5e3)}}}ct((()=>new vi));export{zs as A,Vs as D};